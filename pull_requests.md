This file is a structured collection of merged GitHub Pull Requests and their associated comments and reviews. It is designed to be easily consumed by AI systems for code analysis, summarization, changelog generation, or other automated reasoning.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a serialized snapshot of merged Pull Requests from a GitHub repository,
along with relevant review feedback and inline comments on code changes.
It is intended to support AI workflows such as summarization of changes,
review analysis, contributor insights, or changelog drafting.
</purpose>

<file_format>
The content is organized as follows:

- This summary section
- Multiple Pull Request entries, each delimited by tags in the format:
  <pull*{number}*{sanitized_title}>
  Pull Request body
  > > Review de {usuario} ({estado}):
  > > Coment√°rio de review
  > > Coment√°rio de {usuario} (linha de c√≥digo):
  > > Coment√°rio inline
  > > </pull*{number}*{sanitized_title}>

Notes:

- PRs are filtered to include only those that were successfully merged.
- Titles are sanitized to remove problematic characters or line breaks.
- Inline comments refer to specific lines in code reviews.
  </file_format>

<usage_guidelines>

- This file is intended to be read-only.
- Use the tag structure to split and analyze PRs individually.
- Comments and reviews can provide rich insight into developer intentions and concerns.
- Consider combining this file with issue history for richer context.
  </usage_guidelines>

<notes>
- Pull Requests not merged were excluded.
- PR descriptions and comments are shown as returned by the GitHub API.
- Content may include technical terms, code snippets, or unfiltered user input.
- The file may include empty PRs (without description or comments) if present in the dataset.
</notes>
</file_summary>

<pull_5_feat: Adds 'class' darkmode and resizes elements>

## Fala pessoal! Tudo bem? ( ‚Äæ‚ó°‚óù)‚úå

### Objetivo da PR:

Essa PR visa adicionar dark mode √† Home e realizar um resizing dos elementos.

### Modifica√ß√µes em linhas gerais:

- [x] Altera o theme no tailwind.config;
- [x] Adiciona uma nova Home, no caso Home 09 e "componentiza";
- [x] Adiciona darkmode por "class";
- [x] Inverte a posi√ß√£o do coment√°rio destaque com as infos do post;
- [x] Centraliza card e descri√ß√£o.

### Ambiente rodando altera√ß√µes:

- https://tabnews-ollr15yoh-filipedeschamps.vercel.app/home-09

### Dificuldades:

- Ler c√≥digo com tailwind foi um desafio üòÖ, vou linkar um [v√≠deo](https://www.youtube.com/watch?v=cayXfITwxGk) que ensina a limpar as classes do tail.
- N√£o testei o `yarn build` antes de subir a PR, ent√£o de cara a PR quebrou, fica o aprendizado, o √∫ltimo commit acerta.
- O tema do Tailwind quebra em ambiente de produ√ß√£o, n√£o entendi muito bem por que, mas vou ver se acerto! (a resolu√ß√£o desse problema se encontra nos coment√°rios dessa PR)
- Que falta o TS faz!! Diversas vezes o VSCode n√£o me avisou de erros enquanto refatorava por ser JS, mas vamo que vamo üòÅ

### Expectativas:

- Nenhuma, fiz s√≥ por divers√£o mesmo! üòÑ

---

## Resultado:

> > Review de filipedeschamps (APPROVED):
> > </pull_5_feat: Adds 'class' darkmode and resizes elements>

<pull_7_Home 09 - Ideia de layout>

# Home 09 - Layout minimalista

### Intuito:

- Pensando numa melhor experiencia de usu√°rio, percebi que na maioria das homes que temos at√© agora as informa√ß√µes est√£o muito reunidas, tendo isso em vista decidi aproveitar um layout que gostei bastante `pages > post-01.js` e fazer a `home-09`
- Nele tentei ao m√°ximo trazer o que vi que tem sido o intuito at√© o momento, ou seja, reunir o maior numero de informa√ß√µes no menor espa√ßo poss√≠vel, mas trazendo tamb√©m um espa√ßamento maior entre os items do post (autor
  , titulo, descri√ß√£o, data) para uma melhor fluidez na leitura
- Adicionei um fundo cinza no componente `<Post />,` o que para mim trouxe um tom mais agrad√°vel e mais fluido na leitura
  Tentei contribuir da forma que achei mais relevante no momento do projeto, caso eu tenha fugido do prop√≥sito, apenas desconsiderem a pull request, espero poder cada vez mais contribuir para ajudar os devs e devas de alguma forma!
  > > Review de filipedeschamps (APPROVED):
  > > </pull_7_Home 09 - Ideia de layout>

<pull_18_Template luan>
Desenvolvi minha sugest√£o de design baseada na Issue #6
Nunca tinha usado tailwind, ent√£o n√£o sei se peguei bem a ess√™ncia, mas a√≠ est√°.
Para acessar
[https://tabnews-git-template-luan-filipedeschamps.vercel.app/home-12](https://tabnews-git-template-luan-filipedeschamps.vercel.app/home-12)

> > Review de filipedeschamps (APPROVED):
> > </pull_18_Template luan>

<pull_20_Update README.md>
corre√ß√£o de digita√ß√£o palavra qur => quer
</pull_20_Update README.md>

<pull_22_Adicionando a vers√£o home-10 mobile>
Adicionando a vers√£o home-10 mobile
https://tabnews-git-rodrigokulb-patch-2-filipedeschamps.vercel.app/home-10-mobile
</pull_22_Adicionando a vers√£o home-10 mobile>

<pull_24_layout: Ajustes mobile e inclus√£o da busca>

- Cabe√ßalho fixado
- Ajustes para tablet
- Ajustes espa√ßamento mobile
- Ajustes espa√ßamentos desk
- Adicionar campo busca
  Acesso:
  https://tabnews-git-rodrigokulb-patch-1-filipedeschamps.vercel.app/home-10-mobile
  </pull_24_layout: Ajustes mobile e inclus√£o da busca>

<pull_25_Criando arquivo de dados json>
Objetivo de criar um arquivo de dados √© unificar o formato da base para as op√ß√µes de layout limpando o conte√∫do dos arquivos.
Adicionei tamb√©m a coluna quantidade de coment√°rios.
</pull_25_Criando arquivo de dados json>

<pull_28_Update README.md>
Esse PR corrige alguns pequenos erros de digita√ß√£o no README.md. Aquele tipo de coisa que ocorre na empolga√ß√£o do momento.
</pull_28_Update README.md>

<pull_32_update home-10-mobile utilizando news.json>
a) Atualizando o arquivo home-10-mobile consumindo o news.json
b) Adicionando a quantidade de coment√°rios na listagem
https://tabnews-git-rodrigokulb-patch-1-filipedeschamps.vercel.app/home-10-mobile
</pull_32_update home-10-mobile utilizando news.json>

<pull_34_Reorganiza√ß√£o das POCs e nova forma de declarar p√°ginas>
Turma, esse PR √© importante, pois al√©m de mover todas as POCs pra uma nova pasta `/pages/pocs`, foi habilitado o `pageExtensions` [como sugerido nessa issue](https://github.com/filipedeschamps/tabnews.com.br/issues/12#issuecomment-855440087) pelo @pscruzzz e [documentado aqui](https://nextjs.org/docs/api-reference/next.config.js/custom-page-extensions) e isso nos dar√° a flexibilidade para conter melhor os componentes e outras responsabilidades dentro da pasta `pages`, sem tudo que estiver l√° necessariamente virar uma p√°gina.
Por√©m ao inv√©s de usar o sufixo `.page.js` eu sugiro usarmos o sufixo `.public.js` e meu racioc√≠nio foi o seguinte: uma vez habilitado o `pageExtensions`, **ele se torna necess√°rio para tudo**, tanto para rotas da API (que n√£o s√£o p√°ginas) e tamb√©m para arquivos especiais como o `_app.js`. Ent√£o eu acho muito estranho uma rota de API ter o arquivo `api/users.pages.js` e entra muito mais na minha cabe√ßa deixar claro que o arquivo vai se tornar p√∫blico, por exemplo `api/users.public.js`, porque √© realmente isso que acontece: arquivos com o sufixo `.public.js` se tornam p√∫blicos, e o resto se tornam privados por padr√£o. O conte√∫do, seja uma p√°gina ou API, s√≥ vai se tornar p√∫blico se for adicionado o sufixo em quest√£o.
Um exemplo disso foi na POC do @rodrigoKulb que usa o arquivo de dataset (com not√≠cias e coment√°rios). Antes ele precisava ficar fora da pasta `/pages` (principalmente se fosse um `.js` para n√£o virar uma p√°gina), mas agora pode viver normalmente dentro de `/pages/pocs` pois ele n√£o tem o sufixo `.public.js` e se mantem privado.
Fora isso, esse PR:

1. Remove as depend√™ncias de lorem ipsum
2. Substitui o conte√∫dos que essas depend√™ncias geravam pelo dataset criado pelo @rodrigoKulb
3. Atualiza todas as outras depend√™ncias.
   Ficou um commit/PR com muita coisa, mas para o est√°gio do projeto acho que n√£o vai dar conflito em ningu√©m.

**Vamos de `.public.js`?**
</pull_34_Reorganiza√ß√£o das POCs e nova forma de declarar p√°ginas>

<pull_36_feat: home-11 and post-02>

## Fala pessoal! Tudo bem? ( ‚Äæ‚ó°‚óù)‚úå

### Objetivo da PR:

Propor uma nova UI para home, criando a home-11! O novo visual de cards acompanha a logo, onde no canto direito superior de cada card existe uma tab.
Toda a discuss√£o dessa PR reside na [PR 10](https://github.com/filipedeschamps/tabnews.com.br/pull/10).

### Modifica√ß√µes em linhas gerais:

- [x] Altera paleta de cores
- [x] Altera organiza√ß√£o de informa√ß√µes
- [ ] Quase adiciona darkmode por "class" (falta ajustar as classes üòÖ)
- [x] Da maior destaque √† primeira not√≠cia
- [x] Se a not√≠cia possui um coment√°rio destaque, o "hot emoji" tem uma cor especial
- [ ] Pra ficar 100% precisa ajustar a parte de totalizadores, as vezes corta o nome do autor e o coment√°rio destaque n√£o √© responsivo

### Ambiente rodando altera√ß√µes:

- <a href="https://tabnews-cfnf1o2nw-filipedeschamps.vercel.app/pocs/home-11" target="_blank">Home-11</a>
- <a href="https://tabnews-cfnf1o2nw-filipedeschamps.vercel.app/pocs/post-02" target="_blank">Post-02</a>

### Ideias que surgiram:

- Adicionar smooth scrolling (ia ficar delicinha);
- Adicionar anima√ß√£o de entrada das noticias (direita pra esquerda) quando a mesma entra no campo de vis√£o com Framer Motion ou React Spring (ou qualquer outra lib);
- Implementar um design mais focado em [neumorphism](https://www.google.com/search?q=neumorphism&rlz=1C1CHBF_enBR865BR865&sxsrf=ALeKk02tU--5F8cB5Bz9szXtkMUsc7BtyQ:1622953085379&source=lnms&tbm=isch&sa=X&ved=2ahUKEwi4_I-xk4LxAhXdrpUCHWBPDK0Q_AUoAXoECAEQAw&biw=2327&bih=852#imgrc=ruMVuc8rWr8vzM);
- Talvez fosse interessante botar na noticia mais quente pelo menos o primeiro par√°grafo pra dar ainda mais destaque

### Dificuldades:

- Demanda um bom refatoramento, acabou sendo KISS demais üòÖ
- Por enquanto, n√£o est√° agregado em um arquivo (home-11.js), est√° componentizado

### Expectativas:

- Nenhuma, fiz s√≥ por divers√£o mesmo! üòÑ

---

## Resultado:

</pull_36_feat: home-11 and post-02>

<pull_37_Estrutura√ß√£o layout construction-01>
Estrutura√ß√£o da p√°gina do layout construction-01

- Faltam ajustes mobile. (construction-01.public.js)
- Atualiza√ß√£o de fonte personalizada (/css/globals.css)
- Upload de uma imagem (/pages/pocs/img/teclado.jpg)
- Instala√ß√£o do next-images (package.json e next.config)
  </pull_37_Estrutura√ß√£o layout construction-01>

<pull_38_feat: continua√ß√£o do script para baixar lista de colaboradores e seus avatares>
Dando continuidade ao [PR](https://github.com/filipedeschamps/tabnews.com.br/pull/26) do @thenriquedb e que recebeu contribui√ß√£o do @francopan, o script agora considera o detalhe de pagina√ß√£o (ao usar a lib oficial do Github), gera um `collaborators.json` com um Array contendo todos os colaboradores para usarmos na p√°gina de "Em constru√ß√£o" e continua baixando os avatares como anteriormente.
O PR tamb√©m remove algumas abstra√ß√µes e depend√™ncias com intuito de simplificar o script.
Resultado:

**[EDIT]**
A id√©ia √© usar esse resultado `est√°tico` para construir a p√°gina de "Em constru√ß√£o" e que fique eternizada. Este √© o motivo de n√£o fazer uma p√°gina que puxe dados de forma din√¢mica.
Closes https://github.com/filipedeschamps/tabnews.com.br/pull/26
</pull_38_feat: continua√ß√£o do script para baixar lista de colaboradores e seus avatares>

<pull_40_feat: add `init` folder with current collaborators>

### Contexto

Pessoal, uma ideia muito legal dada na issue #23 pelo @danwhat foi de, ao inv√©s da p√°gina "Em constru√ß√£o" sumir do mapa, ela ser movida para um outro lugar depois de cumprir o seu papel na home. Eu achei essa ideia √≥tima, pois vai sempre ser legal poder voltar e ver uma "fotografia" congelada no tempo do que a gente tinha criado no comecinho.

### E falando em comecinho

Toda vez que voc√™ quer `inicializar` um reposit√≥rio, voc√™ executa o comando `git init`, a√≠ pensei, porque n√£o movermos essa p√°gina para `tabnews.com.br/init`, pois de fato foram essas pessoas quem **inicializaram** o reposit√≥rio, estavam l√° na `Milestone 0`, no `init` do projeto.

### Ent√£o o que esse PR faz

Ele j√° prepara uma pasta `init` que tem todos os avatares baixados na pasta `avatars` (para atingir o objetivo de ter uma foto congelada no tempo) e tamb√©m a lista de todos os colaboradores no arquivo `collaborators.json` e que pode ser usado na constru√ß√£o da p√°gina para listar os avatares, para linkar com o endere√ßo final do usu√°rio no Github, ou fazer algum request contra o perfil p√∫blico dessa pessoa.
Ent√£o a ideia √© poder usar esse conte√∫do tanto em alguma POC que algu√©m esteja fazendo, como no caso dessa daqui #37 feita pelo @rodrigoKulb e que com esse PR agora vai poder usar dados reais, quanto de fato a p√°gina final na home usar tudo isso, e depois ter apenas o trabalho de mover o arquivo `.public.js` respons√°vel pela p√°gina para dentro da pasta `init` (consertando claro os endere√ßos) e ficar assim na hist√≥ria do projeto.

### Como atualizar os colaboradores

Para gerar tanto a lista final mais atualizada dos colaboradores, quanto baixar a √∫ltima foto do perfil, basta rodar o script criado pelo @thenriquedb que foi iniciado no PR #26 e que foi continuado no PR #38. Ele vai gerar os est√°ticos l√° dentro da pasta do script mesmo, e da√≠¬†√© s√≥ quest√£o de mover para pasta do `init`.

### Colaboradores sem foto no perfil

Vou listar aqui os colaboradores que est√£o com o avatar padr√£o do Github, caso queiram aproveitar essa oportunidade para colocar outra foto. Lembrando que mais para o fim dessa semana, talvez na Live de sexta para comemorar o encerramento da Milestone 0, vamos gerar uma vers√£o final e est√°tica desses conte√∫dos e fazer merge na `main` üëç

- @brunosemfio
- @Caue15
- @dantavs
- @esgama
- @fmarcolin
- @GustavoTayer
- @hiagorns
- @lucasbrando
- @MarcoSantosPBS
- @oziasmjunior
- @rscabral
- @zigante
  </pull_40_feat: add `init` folder with current collaborators>

<pull_44_fix(scripts): change functions order to first create `contents` folder>
Mudando a ordem das fun√ß√µes para ele primeiro criar a pasta `contents` e baixar os avatares, e depois criar o arquivo JSON com a lista dos colaboradores.
</pull_44_fix(scripts): change functions order to first create `contents` folder>

<pull_45_feat: add construction-02 POC>
**Turma, segue minha sugest√£o:**
**https://tabnews-git-construction-filipe-filipedeschamps.vercel.app/pocs/construction-02**
Os pontos principais s√£o:

1. Uma p√°gina comemorativa, que ficar√° **congelada** ao longo dos anos, e as pessoas que participaram v√£o poder falar: _"Oh, eu tava l√°!"_
2. Usar o espa√ßo para o que importa nessa hora: **refor√ßar nossa postura desde o Dia 0**. Se essa parte do projeto n√£o parar em p√©, n√£o vai ter tecnologia que vai construir um ambiente que seja gostoso voltar para contribuir e reencontrar os colegas da √°rea. Ent√£o **n√£o sugiro** usarmos esse espa√ßo para capturar leads, isso n√£o importa tanto quanto deixar anotado para sempre a nossa cultura. E lembra que essa p√°gina √© **para n√≥s** (quem estava no `init`) mais do que √© para qualquer outra pessoa.
3. A p√°gina √© responsiva, e em desktop coube o avatar de todo mundo at√© agora, ent√£o vai dar para tirar o print de todo mundo ao mesmo tempo.
4. Os avatares s√£o randomicamente posicionados a cada refresh para caso voc√™ queira ter a chance de tirar um print do seu avatar numa posi√ß√£o mais acima.
5. O click no avatar leva para o Github da pessoa.
6. Bastante c√≥digo inline para a p√°gina ser autossuficiente e permanecer sem altera√ß√µes ao longo do tempo. Por exemplo: escolhi n√£o estender o `grid` do Tailwind, pois n√£o sei se isso vai ser usado no resto do site, ent√£o fiz inline. O que n√£o deu para fazer inline foi o `react-confetti`, mas ele vai ser usado em outros recursos do site, como quando o usu√°rio ganha uma nova habilidade. Tava pensando tamb√©m fazer inline **todas** as classes do Tailwind. O que voc√™s acham?
7. A ideia √© primeiro publicar ela como a Home do site, e depois mover para o endere√ßo `/init` e ficar l√° pra sempre.
8. Isso n√£o substitui uma _"p√°gina viva"_ de contribuidores/stats do site, mostrando publicamente as estat√≠sticas de contribui√ß√µes, releases e volume de acessos/cadastros/moedas.
   </pull_45_feat: add construction-02 POC>

<pull_46_fix: better phrasing suggested by @rhandrade>
@rhandrade por favor confirme se eram essas as altera√ß√µes ü§ù üëç
E qualquer outra sugest√£o √© super bem vinda ü§ù üòç
</pull_46_fix: better phrasing suggested by @rhandrade>

<pull_47_feat: add new diary entries>
Qualquer erro de portugu√™s ou sugest√£o do que adicionar, √© super bem vindo ü§ù üëç
Eu basicamente fui pegando os v√≠deos publicados nos membros, fui revendo as contribui√ß√µes e relembrando o que estava passando na minha cabe√ßa em cada momento üëç
</pull_47_feat: add new diary entries>

<pull_48_update: Resize in Confetti construction-02.public.js>
Conforme solicitado na PR #45

- Adicionei um EventListener dentro do useEffect para atualizar a largura e altura quando redimensionar a tela.
- Quando o scroll lateral aparece no chrome ele reduz a √°rea aparecendo um pequeno scroll horizontal por isso adicionei um bloqueio via CSS overflow-x: hidden;
  </pull_48_update: Resize in Confetti construction-02.public.js>

<pull_49_Criei um simples ZOOM nos avatars.>
Criei em CSS um simples zoom para que ao passar o mouse em cima podermos ver melhor as imagens.

> > Review de vitoropereira (COMMENTED):
> > Ajustes nas linhas. Era isso?
> > </pull_49_Criei um simples ZOOM nos avatars.>

<pull_52_fix:Vop1234 corte da imagem no zoom>
Ajuste para n√£o cortar a imagem com o zoom.
</pull_52_fix:Vop1234 corte da imagem no zoom>

<pull_53_fix: Bug na rota√ß√£o mobile construction-02>
N√£o entendi o motivo, mas utilizando **window.innerWidth** quando rotaciona o celular e volta ele volta com BUG no tamanho. Quando altera para **window.screen.width** funciona perfeitamente.
Testei no chrome Linux se possivel testarem em todos navegadores para ver se resolver o BUG.
https://tabnews-git-rodrigokulb-patch-1-filipedeschamps.vercel.app/pocs/construction-02
</pull_53_fix: Bug na rota√ß√£o mobile construction-02>

<pull_54_Adi√ß√£o de username ao passar o mouse>
Pagina de contru√ß√£o 3 - Adi√ß√£o de username ao passar o mouse em cima. Sei que talvez n√£o d√™ para entrar no deploy de hoje, por√©m seria maravilhoso deixar registrado como uma poc :)
</pull_54_Adi√ß√£o de username ao passar o mouse>

<pull_56_feat: add official under construction home>

> > Review de Rechdan (APPROVED):
> > </pull_56_feat: add official under construction home>

<pull_58_feat: adds a new diary entry>
Sugiro sinceramente ler e relembrar os pontos mais importantes da Live üëç
</pull_58_feat: adds a new diary entry>

<pull_66_feat: change license from `mit` to `gplv3`>
Discuss√£o pode ser encontrada [nessa issue](https://github.com/filipedeschamps/tabnews.com.br/issues/64).
Closes #64
</pull_66_feat: change license from `mit` to `gplv3`>

<pull_70_fix: Changes license key in package.json to GPL-3.0-only to match SPDX ID>
Baseado na documenta√ß√£o do npm, no site de licen√ßas da SPDX e no site da Open Source Initiative, alterei a chave da licen√ßa no arquivo package.json para `GPL-3.0-only`. Mais detalhes na PR #66.
Mais sobre a chave da licen√ßa em:
https://docs.npmjs.com/cli/v7/configuring-npm/package-json#license
https://spdx.org/licenses/
https://opensource.org/licenses/GPL-3.0
</pull_70_fix: Changes license key in package.json to GPL-3.0-only to match SPDX ID>

<pull_73_Implementa container, conector e migration do Banco de Dados>
Closes #12 (por conta das pastas)
Closes #61 (por conta do container, conector e endpoint de migration)
Closes #71 (por dar continuidade no trabalho iniciado pelo @huogerac )

## Resumo

O principal desse PR √©:

1. `docker-compose` que levanta uma inst√¢ncia de Postgres e usando a maravilhosa vers√£o Alpine proposta pelo @huogerac no PR #71
2. M√≥dulo com conector para o banco Postgres
3. Model `Migrator` respons√°vel pelas migra√ß√µes
4. Endpoint `/api/migrations` para ver ou rodar as migra√ß√µes que est√£o `pending`.
5. Coloquei uma migra√ß√£o de mock na pasta `/infra/migrations` caso queiram testar, pois vou remover ela depois

## Alguns detalhes interessantes

1. Para desenvolver, voc√™ continua usando o comando `npm run dev` e que agora vai rodar em paralelo o `docker-compose up` e o `next dev`
2. O arquivo do `docker-compose` especifica que √© para ambiente de desenvolvimento, tanto que se chama `docker-compose.development.yml` e ele vai manter o `state` do banco entre suas sess√µes de desenvolvimento. Isso significa que num pr√≥ximo PR quando implementar os testes, vou criar um `docker-compose.test.yml` que n√£o manter√° o `state`, pois vai sempre ter seu volume recriado do zero com as flags `--force-recreate --renew-anon-volumes`
3. Criei um arquivo `.env.development` com as vari√°veis de ambiente padr√£o e elas s√£o injetadas no container do banco e tamb√©m no conector que est√° em `/infra/database.js `. Esses mesmos nomes de vari√°veis ir√£o ser utilizadas no ambiente de `Preview` e `Production` (que n√£o est√£o configuradas no momento).
4. O Model `Migrator` espera receber como depend√™ncia um "client de conex√£o" desse banco.
5. Esse mesmo model √© usado no Controller do endpoint da API `/api/migrations` e se ela receber um `GET` ir√° retornar as migrations pendentes (sem rodar), e se receber um `POST` ir√° rodar e retornar quais migrations foram rodadas de fato.
6. Observa√ß√£o: precisamos criar um padr√£o de retorno e erros.
7. Para facilitar a importa√ß√£o de arquivos ao longo da codebase, foi configurado um arquivo `jsconfig.json` que define a `baseUrl` do projeto e agora qualquer `import` pode caminhar a partir da pasta raiz do projeto (sem precisar se preocupar com caminhos relativos ou ficar voltando pastas tipo `'../../../../infra/database.js'`).
   > > Review de huogerac (APPROVED):

- Fiz pull da branch database
- Yarn install
- npm run dev (muito massa, ele j√° rodar o docker-compose up)
- gostei do docker pegando as variavies via .env
- fiz um get em `http://localhost:3000/api/migrations` e listou 1 item (imagino q √© a migration pendente)
- fiz um post na mesma url, retornou 200 e a migration `1599609889070_init`
- fiz novamente get na url e retornou um [] vazio
- fiz novamente um post e tambem retornou []
- acessei o banco e a tabela migrations foi criada com 1 row
  Enfim, tudo rodando! Massa!

**Pontos para pensar:**

- minha m√°quina deve ter um docker-compose mais antigo, tive que baixar a version do YML de 3.8 para 3.4 para funcionar
- talvez a url migrations poderia retornar 201 para indicar que algo foi criado e 200 ou 404 quando nao tem migration para rodar
- tem um ataque (CSRF) explorando JSON e arrays, se n√£o me engano o gmail foi atacado assim uma vez. Em resumo, uma boa pr√°tica √© n√£o retornar um array diretamente na resposta, mas sim um objeto com um atributo que tem o array, dai talvez alterar o retorno da migrations para algo como:

```
{
  migrations: []
}
```

</pull_73_Implementa container, conector e migration do Banco de Dados>

<pull_76_Adiciona Github Actions para rodar os testes>
Closes: #74 (PR anterior onde explico o ambiente de testes local)
Closes: #62 (Issue relacionada da Milestone)
Foi uma aventura perceber como o ambiente em que se roda o Github Actions √© diferente do meu ambiente local aqui :)

1. O m√≥dulo `wait-on` funciona localmente que √© uma maravilha, mas quebra no ambiente do Github Actions. Eu tava ficando quase maluco tentando isolar o problema de todas as formas e finalmente esbarrei [nessa issue](https://github.com/jeffbski/wait-on/issues/86). Removi ela das depend√™ncias.
2. At√© nosso amigo `axios` se demonstra bugado na √∫ltima vers√£o `0.21.1` conforme [essa issue](https://github.com/axios/axios/issues/3526) e tive que voltar para vers√£o `0.19.0`. Como essa vers√£o tem falha de seguran√ßa, movi ela para as depend√™ncias de desenvolvimento at√© a pr√≥xima vers√£o sair.
3. Pra testar as Actions sem precisar ficar fazendo push toda hora aqui para o reposit√≥rio, eu descobri uma ferramenta sensacional chamada [act](https://github.com/nektos/act). Ela simula o container que o Github roda nas Actions. √â muito legal e foi por ali que peguei o bug do `wait-on`, porque essa lib falava que tal url ainda n√£o estava dispon√≠vel, mas por dentro do container fazendo `curl` ela estava normalmente.
4. Tem uma √∫ltima caracter√≠stica que s√≥ acontece dentro do ambiente do Github Actions que √© a forma de fechar processos, tanto que apesar de fechar eles no c√≥digo, eu precisei rodar o `jest` com a flag `--forceExit`. Mais para frente vou investigar.

**[edit]** 5. N√£o para essa sprint, mas para pr√≥xima eu quero tentar uma outra abordagem que √© fazer o `up` e `down`dos servi√ßos por fora do script de teste. Por mais que eu gosto da ideia de eles estarem expl√≠citos ali no arquivo de teste, fazer o build o Next √© algo custoso (√© mais demorado que levantar o Postgres).

> > Review de huogerac (COMMENTED):
> > Eu devo estar fazendo algo errado, mas est√° dando timeout no Jest:

```
| > jest --runInBand --forceExit
|
|  FAIL  pages/api/v1/migrations/index.test.js
|   ‚óè [e2e] First GET to /api/v1/migrations ‚Ä∫ should list all pending migrations
|
|     thrown: "Exceeded timeout of 120000 ms for a hook.
|     Use jest.setTimeout(newTimeout) to increase the timeout value, if this is a long-running test."
|
|        5 | const allServices = allServicesFactory();
|        6 |
|     >  7 | beforeAll(async () => {
|          | ^
|        8 |   return await allServices.start();
|        9 | });
|       10 |
|
|       at Object.<anonymous> (pages/api/v1/migrations/index.test.js:7:1)
|       at TestScheduler.scheduleTests (node_modules/@jest/core/build/TestScheduler.js:333:13)
|       at runJest (node_modules/@jest/core/build/runJest.js:387:19)
```

Ap√≥s instalar o act (que √© muito massa, n√£o conhecia), rodei diretamente act e deu erro de timeout
Tentei deixar o docker do postgres rodando e rodei novamente o act, mesma coisa.
Pode ser que est√° tarde, vou tentar amanh√£, quem sabe entendo oq est√° acontecendo.
</pull_76_Adiciona Github Actions para rodar os testes>

<pull_79_Adiciona scripts para verificar linting e Github Action>
Closes #60 (issue da Milestone)
Em resumo, esse PR adiciona os scripts respons√°veis por verificar as regras de linting pelo `eslint` e tamb√©m pelo `prettier`. Por raz√µes hist√≥ricas, eu desabilitei essas verifica√ß√µes da pasta com as POCs, mas tive que consertar um detalhe de seguran√ßa no nosso index atual (o futuro `/init`) üëç
E sugiro ler os outros coment√°rios que fiz abaixo, pois tem informa√ß√µes interessantes sobre estar usando o `eslint` que vem junto com o `next@11` üëç
</pull_79_Adiciona scripts para verificar linting e Github Action>

<pull_80_Implementa Github Actions para linting de commit>
Closes #42 (issue relacionada a atual Milestone)
Usei uma [Action](https://github.com/marketplace/actions/commit-linter) feito pelo brasileiro [@wagoid](https://github.com/wagoid). Vamos ver o que vai acontecer üëç

## O que aconteceu

Leia a thread, pois mostro o desenvolvimento e os prints, tudo funcionou como esperado.

## Esse PR faz 3 coisas

1. Primeiro modifica a Action que faz o linting dos styles para especificar que ela √© sobre `styles`.
2. Adiciona a Action que faz o linting dos commits.
3. Adiciona uma ferramenta para ajudar a construir mensagens de commits no padr√£o correto. Para acessar ela, ap√≥s fazer o `staging` dos arquivos normalmente, basta rodar o comando `npm run commit` (n√£o √© obrigat√≥rio, √© s√≥ para ajudar mesmo, porque n√£o faz diferen√ßa commitar manualmente).

## O que ese PR n√£o faz

Como sugerido na issue da milestone, esse PR n√£o adiciona o `husky`, n√£o achei necess√°rio no momento, dado que a garantia est√° no check do CI, e na correria da vida acho que √© importante deixar a pessoa conseguir empurrar de qualquer forma para garantir que a c√≥pia da sua altera√ß√£o fique remota. A√≠ depois √© s√≥ a pessoa consertar a mensagem.
</pull_80_Implementa Github Actions para linting de commit>

<pull_82_Nova abordagem para testes>
Seguindo as sugest√µes do @huogerac [nessa thread](https://github.com/filipedeschamps/tabnews.com.br/pull/76#issuecomment-884374981), eu tirei a responsabilidade de levantar e derrubar os containers de dentro dos testes e passei isso para a infraestrutura. Ficou **muito** melhor e **muito** mais r√°pido, principalmente quando voc√™ est√° desenvolvendo e testando ao mesmo tempo com `npm run test:watch`.
Ent√£o agora o foco dos testes locais n√£o √© garantir a integridade, e sim acelerar o desenvolvimento junto aos testes, porque quem deve fazer a garantia final √© o CI (no nosso caso as Actions do Github). E ao rodar nas Actions, ao inv√©s de usar o ambiente de desenvolvimento do Next.js, √© feito o `build` e `start`, como em um ambiente de produ√ß√£o. N√£o √© igual ao ambiente de produ√ß√£o, pois est√° rodando nos containers do Github, mas √© um passo a mais do que s√≥ testar no ambiente de desenvolvimento.
Outra coisa que fiz √© remover das Actions o `push` e deixar somente para rodar nos `pull_requests`. Isso deve acelerar um pouco as coisas tamb√©m.
Bom, √© um grande refactor, n√£o sei o que vai acontecer aqui no Github Actions, vamos ver se vai passar üëç

**[edit]**
Passou üéâ
Ent√£o os comandos para desenvolver ou testar continuam os mesmos, e eles automaticamente se responsabilizam por levantar ou derrubar tudo o que precisa:

```
npm run dev
npm run test
npm run test:watch
```

> > Review de huogerac (COMMENTED):

- Fiz uma revis√£o r√°pida (tenho mais tempo a noite)
- Gostei das altera√ß√µes do package json (scripts)
- yarn test funciona, os tests passam, mas sai com exit 1 por algum motivo
- a aplica√ß√£o est√° funcionando
- o `act` n√£o da erro, mas n√£o executa mais (voltei o rc para original), com a imagem que voce passou, mas ainda assim nada acontece, sem erro, sem output..(preciso investigar mais)

```
‚ûú  tabnews.com.br git:(tests-new-approach) ‚úó yarn test
yarn run v1.22.10
$ npm run services:up && concurrently -s -k -n next,jest 'npm run next' 'jest --runInBand' && npm run services:stop
npm WARN lifecycle The node binary used for scripts is /tmp/yarn--1627065061622-0.835042471651541/node but npm is using /home/roger/.nvm/versions/node/v12.22.1/bin/node itself. Use the `--scripts-prepend-node-path` option to include the path for the node binary npm was executed with.
> tabnews.com.br@1.0.0 services:up /home/roger/workspace/workon/tabnews/tabnews.com.br
> docker-compose -f infra/docker-compose.development.yml up -d
postgres-dev is up-to-date
[next] npm WARN lifecycle The node binary used for scripts is /tmp/yarn--1627065061622-0.835042471651541/node but npm is using /home/roger/.nvm/versions/node/v12.22.1/bin/node itself. Use the `--scripts-prepend-node-path` option to include the path for the node binary npm was executed with.
[next]
[next] > tabnews.com.br@1.0.0 next /home/roger/workspace/workon/tabnews/tabnews.com.br
[next] > next dev
[next]
[next] ready - started server on 0.0.0.0:3000, url: http://localhost:3000
[next] info  - Loaded env from /home/roger/workspace/workon/tabnews/tabnews.com.br/.env
[next] info  - Using webpack 5. Reason: Enabled by default https://nextjs.org/docs/messages/webpack5
[next]
[next] warn - You have enabled the JIT engine which is currently in preview.
[next] warn - Preview features are not covered by semver, may introduce breaking changes, and can change at any time.
[next] event - compiled successfully
[next] event - build page: /api/v1/migrations
[next] wait  - compiling...
[next] event - compiled successfully
[next] No migrations to run!
[next] > Migrating files:
[next] > - 1599609889070_init
[next] ### MIGRATION 1599609889070_init (UP) ###
[next] > Migrating files:
[next] > - 1599609889070_init
[next] ### MIGRATION 1599609889070_init (UP) ###
[next] No migrations to run!
[next] No migrations to run!
[jest]  PASS  pages/api/v1/migrations/index.test.js
[jest]   [e2e] First GET to /api/v1/migrations
[jest]     ‚úì should list all pending migrations (34 ms)
[jest]   [e2e] First POST to /api/v1/migrations
[jest]     ‚úì should list all migrated migrations (24 ms)
[jest]   [e2e] Second POST to /api/v1/migrations
[jest]     ‚úì should list zero migrated migrations (22 ms)
[jest]   [e2e] Second GET to /api/v1/migrations
[jest]     ‚úì should list all zero pending (21 ms)
[jest]   [e2e] PUT to /api/v1/migrations
[jest]     ‚úì should return 404 (4 ms)
[jest]
[jest] Test Suites: 1 passed, 1 total
[jest] Tests:       5 passed, 5 total
[jest] Snapshots:   0 total
[jest] Time:        9.673 s
[jest] Ran all test suites.
[jest] jest --runInBand exited with code 0
--> Sending SIGTERM to other processes..
[next] npm run next exited with code SIGTERM
error Command failed with exit code 1.
```

> > Review de huogerac (COMMENTED):
> > Bom Filipe,
> > N√£o tenho conhecimento em nodejs e next para "aprovar", mas tudo que testei e vi, est√° funcionando. (tests, dev, services:up/down act, lint)
> > FYI:

- act funcionou com o par√¢metro: `act -j tests`! massa, cada vez gosto mais deste act
- o `npm run test` ou `yarn test` n√£o estavam funcionando, pq eu estava usando o node v12, fiz update para 14 e tambem n√£o funcionou, dai ao usar a √∫ltima vers√£o (v16.5.0), tudo funcionou
- onde podemos colocar no projeto a vers√£o do node do projeto? (j√° vi alguns projetos com um .node_version e outros como uma entrada no package.json. Alguem sabe?
- sabe qual node tem na vercel, dai talvez poderia ser interessante usar no projeto a mesma vers√£o da vercel (j√° vi cada erro causado por vers√£o diferente do node)
- eu estava usando um docker-compose bem antigo (2019) e achava q o problema era com ele, mas no final n√£o era nada relacionado com docker, mas de qualquer forma √© bom ter o docker e docker-compose mais novos instalado!
  [edit]
  o curioso √© depois vi que no tests.yml do gh actions, l√° tem referencia para o node-version 14. Dai fiquei na duvida pq tive que utilizar o node 16 para funcionar...
  </pull_82_Nova abordagem para testes>

<pull_86_Adiciona nova entrada no di√°rio do README resumindo a √∫ltima Live>
N√£o cheguei a revisar o texto ainda, pois queria empurrar aqui para o Github e ver o resultado final [acessando a branch](https://github.com/filipedeschamps/tabnews.com.br/tree/diary). Vou descansar a vista para depois revisar, mas se nesse meio tempo algu√©m encontrar algum erro ser√° super bem vindo ü§ù

> > Review de geovani-brito (COMMENTED):
> > At√© onde consegui perceber, s√≥ encontrei uma letra errada. De resto o texto t√° √≥timo! :+1:
> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de geovani-brito (linha de c√≥digo):
> > Tem um "a" a mais nessa frase:
> > Na aparte Code Style que voc√™ pode verificar
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Ahh muito bem notado, valeuuuu üòç
> > </pull_86_Adiciona nova entrada no di√°rio do README resumindo a √∫ltima Live>

<pull_89_chore: Diary reallocation>
Estou enviando uma pr√©via do pull request para testar a formata√ß√£o, se passa no teste do commit e outras coisas.
J√° aproveito para saber a opini√£o de voc√™s. Algumas pontos, por exemplo, est√£o me deixando em d√∫vida:
1 - Os nomes dos arquivos: √© melhor deixar o t√≠tulo do dia ou colocar um nome com formato padr√£o? Alguns arquivos podem ficar com nomes bem longos se eu colocar o t√≠tulo do dia.
2 - Algumas entradas do di√°rio s√£o bem curtas. O que acham? Agrupa ou n√£o tem problema ter cap√≠tulos pequenos?

> > Review de filipedeschamps (APPROVED):
> > </pull_89_chore: Diary reallocation>

<pull_98_feat: Convert database factory in singleton>

# Proposta para refatora√ß√£o padr√£o factory da instancia de 'database'

Pessoal, implementei inicialmente uma proposta para convers√£o do padr√£o factory para singleton do arquivo de database como foi sugerido no PR #92

## O que foi feito?

- Refatora√ß√£o das p√°ginas de database, migrations e orchestrator;
  > > Review de filipedeschamps (COMMENTED):
  > > Review de filipedeschamps (COMMENTED):
  > > Review de filipedeschamps (CHANGES_REQUESTED):
  > > Adicionei dois coment√°rios em 2 arquivos que acredito valer a pena considerar ü§ù üëç
  > > Review de brunofamiliar (COMMENTED):
  > > Review de brunofamiliar (COMMENTED):
  > > Review de filipedeschamps (COMMENTED):
  > > Review de filipedeschamps (APPROVED):
  > > Rodei aqui, e tudo certinho üòç show de bola!!!! Vou fazer o merge apenas na abertura da Milestone, que tudo indica que ser√° na sexta-feira üëç
  > > Review de brunofamiliar (COMMENTED):
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > Interessante o jeito que voc√™ implementou! Uma sugest√£o seria usar o pr√≥prio arquivo para ser a inst√¢ncia, e da√≠ voc√™ pode tirar um n√≠vel de abstra√ß√£o que √© criar a inst√¢ncia dentro da inst√¢ncia do arquivo, por exemplo:

```js
// infra/database.js
import { Pool } from "pg";
const poolConfiguration = {
  user: process.env.POSTGRES_USER,
  host: process.env.POSTGRES_HOST,
  database: process.env.POSTGRES_DB,
  password: process.env.POSTGRES_PASSWORD,
  port: process.env.POSTGRES_PORT,
  ssl: {
    rejectUnauthorized: false,
  },
};
// https://github.com/filipedeschamps/tabnews.com.br/issues/84
if (["test", "development"].includes(process.env.NODE_ENV) || process.env.CI) {
  delete poolConfiguration.ssl;
}
const pool = new Pool(poolConfiguration);
async function query(query) {
  const results = await pool.query(query);
  return results;
}
async function getNewConnectedClient() {
  // When manually creating a new connection like this,
  // you need to make sure to close it afterward
  // with the .end() method.
  return await pool.connect();
}
export default {
  query,
  getNewConnectedClient,
};
```

PS: eu j√° estava com esse arquivo pronto, porque na RFC das milestones estava anotado para eu **avaliar** a possibilidade de implementar isso, mas da√≠ para eu conseguir avaliar tive que implementar üòÇ

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Eu acho que isso n√£o ir√° funcionar, ao menos testei sua branch aqui local e n√£o rodou e o motivo disso √© que o Pool agora est√° compartilhado e √© um singleton, correto? Com isso, voc√™ cria o Pool, faz a query que dropa as tabelas, e em seguida fecha o Pool, e se ele foi manualmente fechado, n√£o existe mais e n√£o ir√° gerenciar novas conex√µes.
> > Ent√£o voc√™ n√£o pode fechar o Pool, mas tamb√©m n√£o pode s√≥ rodar a query, porque se s√≥ rodar a query, os testes v√£o passar, mas o `jest` vai reclamar que ficou aberto um `handle`, que √© justamente o Pool segurando a conex√£o ao banco. Ent√£o dentro dos testes voc√™ n√£o deve mexer com o Pool e deve usar manualmente uma inst√¢ncia do banco, porque da√≠ sim voc√™ fecha ela em seguida, por exemplo:

```js
async function dropAllTables() {
  const databaseClient = await database.getNewConnectedClient();
  await databaseClient.query(
    "drop schema public cascade; create schema public;"
  );
  await databaseClient.end();
}
```

Por isso nos testes E2E foi importante subir o servi√ßo do Next (que tamb√©m conecta ao banco usando o Pool) por fora do processo do `jest`, na parte da infraestrutura. Porque da√≠ o `jest` fica livre de Pools, e a camada de infraestrutura sobe e derruba o site nos momentos certos.

> > Coment√°rio de brunofamiliar (linha de c√≥digo):
> > Acabei de realizar a modifica√ß√£o üòÑ. Perd√£o pela demora, estava meio corrido essa semana. Ainda tem uma coisa me incomodando, quem tiver alguma sugest√£o, me avise por favor. Ainda da forma que est√°, o usu√°rio precisa sempre finalizar com o `client.end()`. Seria interessante uma forma de abstrair, para que a classe database realize automaticamente essa opera√ß√£o. Tentei pensar em uma forma, por√©m n√£o surgiu nada em mente üòïüòï
> > Coment√°rio de brunofamiliar (linha de c√≥digo):
> > Eu tinha esquecido de rodar os tests, mals ai kk
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Showww @brunofamiliar ! Ent√£o, normalmente iremos utilizar o `database.query()` para fazer as consultas, e o `Pool` ir√° se responsabilizar por gerenciar as conex√µes üëç
> > Apenas nesse caso dos testes ou em transactions que iremos ter que gerenciar o client (pois a transaction fica presa ao client). No caso da transaction, poderemos talvez criar uma abstra√ß√£o, do tipo:

```js
const transaction = await database.transaction();
await transaction.query(...);
await transaction.query(...);
await transaction.commit(); // ou .rollback()
// esse objeto transaction √© um novo client, no final das contas
```

N√£o sei, s√≥ rabisquei e no final das contas seria s√≥ um "method sugar" pra uma transaction presa a um client.

> > Coment√°rio de brunofamiliar (linha de c√≥digo):
> > Show!! Vou come√ßar pensar na implementa√ß√£o dessa abstra√ß√£o aqui ;)
> > </pull_98_feat: Convert database factory in singleton>

<pull_113_Refaz todo code style utilizando novas regras de linting>
Proposto pela issue #93
Esse PR √© uma maluquisse, pois altera e est√©tica do c√≥digo utilizando as novas regras üòÇ
E para conveni√™ncia (e mais para frente engatar isso num hook de pre-commit), foi adicionado um novo script no package.json chamado `lint:fix`. Ent√£o mesmo que voc√™ n√£o tenha as ferramentas de code stye no seu editor, basta rodar `npm run lint:fix` para consertar tudo üëç
Como eu falei na live falida pelo YouTube, meu interesse por code style vai at√© um certo limite, ent√£o n√£o adicionei muitas regras. Mas qualquer sugest√£o √© bem vinda, mesmo ap√≥s o merge desse PR. Consertar code style √© a coisa mais simples do mundo no est√°gio atual do projeto, fechado? ü§ù

> > Review de Garccosta (APPROVED):
> > Aparentemente tudo joia ;)
> > </pull_113_Refaz todo code style utilizando novas regras de linting>

<pull_114_atualiza√ß√£o do ci>
Esse PR resolve a issue #94
</pull_114_atualiza√ß√£o do ci>

<pull_117_Atualiza todas as depend√™ncias>
Vou come√ßar fazer isso de tempos em tempos, e tem um jeito muito f√°cil de fazer, s√≥ rodar o comando abaixo:

```
npx npm-check-updates -u
```

Parece que as vers√µes mais recentes do `npm` j√° fazem isso com o comando `npm update`, mas aqui n√£o funcionou por nada :(
</pull_117_Atualiza todas as depend√™ncias>

<pull_119_Proposta para padroniza√ß√£o inicial dos Controllers>
Turma, tudo bem? Segue a proposta de padroniza√ß√£o **inicial** dos Controllers, e eu destaco o "inicial" porque com certeza mais para frente iremos fazer abstra√ß√µes dos handlers de `onNoMatch` ou `onError`, no m√≠nimo. Mas por enquanto sugiro n√£o fazermos nenhuma abstra√ß√£o e repetir o c√≥digo mesmo (para decidir em qual n√≠vel iremos abstrair, se vai ser o Error, se vai ser a fun√ß√£o do handler do m√©todo, ou o handler inteiro) üëç
De qualquer forma, a espinha dorsal do controller √© esta parte:

```js
export default nextConnect({...})
  .use(authenticationHandler)
  .use(authorizationHandler)
  .get(getHandler)
  .post(postHandler);
```

O [next-connect](https://www.npmjs.com/package/next-connect) √© um m√≥dulo muito bom e bem parecido com o jeito "Express" de se fazer as coisas. Ent√£o no exemplo acima, ao chegar uma requisi√ß√£o ela ir√° passar **sempre** primeiro pelo handler de autentica√ß√£o, depois autoriza√ß√£o, e depois tentar fazer o match nos m√©todos (no caso o `get` ou `post).
Caso ele n√£o consiga fazer o match, ele ir√° chamar o callback de `onNoMatch`e caso algum handler jogue um erro, ele ir√° chamar o callback de`onError`, ambos declarados ali no **objeto de inicializa√ß√£o** do nextConnect.

```js
export default nextConnect({
  attachParams: true,
  onNoMatch: onNoMatchHandler,
  onError: onErrorHandler,
})
  .use(authenticationHandler)
  .use(authorizationHandler)
  .get(getHandler)
  .post(postHandler);
```

### B√¥nus

1. Configurei o `npm run test:watch` para sempre rodar todos os testes a cada arquivo alterado.
2. Nenhum teste foi alterado, a n√£o ser o que testa o m√©todo `put`, pois queria me certificar que o callback `onNoMatch` estava de fato sendo chamado.
3. Como √© tudo teste E2E, to pensando aqui como seria poss√≠vel (sem muita gambiarra) for√ßar um erro interno para testar o `onError`. De qualquer forma, testei aqui de forma manual e funcionou üëç
4. Como estamos sofrendo um bug no ambiente da Vercel, eu comecei a estressas o endpoint de migrations e notei que quando acontecia um erro, a conex√£o ao banco ficava presa e a transaction tamb√©m. Ent√£o coloquei um try/catch/finally dentro dos internals do migrator onde o `finally` sempre vai fechar a conex√£o com o banco ü§ù
   </pull_119_Proposta para padroniza√ß√£o inicial dos Controllers>

<pull_121_feat(package.json): update script to pg-migrate inside folder>
Deixar o script de forma padronizada, para a cria√ß√£o de migrate dentro da pasta j√° existente.
</pull_121_feat(package.json): update script to pg-migrate inside folder>

<pull_126_fix(next.config.js): fix migration error on production server>
Corre√ß√£o no erro de permiss√£o ao acesso aos arquivos da Vercel para ler as migrations
Corre√ß√£o da falha #120
</pull_126_fix(next.config.js): fix migration error on production server>

<pull_127_Adiciona migration de "uuid-ossp" e "user">
Fiz uma outra branch para dar continuidade ao PR #124 do @rodrigoKulb , pois fa√ßo algumas coisas que mexeriam nos commits da outra branch, que s√£o:

1. Fa√ßo squash dos 3 commits do @rodrigoKulb.
2. Separo a migration original em duas: primeiro a instala√ß√£o da extens√£o, depois outra criando a tabela de user. **Aten√ß√£o:** dado a isso, eu assumo que pelo atual est√°gio do projeto, a gente por enquanto sempre vai ficar resetando o banco. Qualquer coisa sugiro rodar `npm test` que faz tudo isso sozinho.
3. Renomeei os arquivos das migrations para seguir o padr√£o usado pelo Rails (mas pode ser qualquer outro padr√£o).
4. Removi a primeira migra√ß√£o de mock (aquela inicial que era s√≥ para ter algo para testar).
5. Removi o campo `avatar_file` para ele ser adicionado quando tivermos esse recurso de fato (desde layout, at√© reposit√≥rio das imagens).
6. Transformei o campo `name` em `username`.
7. Modifiquei os lengths dos campos, e o motivo est√° em formato de coment√°rio.
8. Derrubei o banco de Preview e Production para economizar dinheiro, vamos ficar testando local por enquanto, mas logo depois eu subo ele de novo üëç
   O que acham?
   Closes #124
   </pull_127_Adiciona migration de "uuid-ossp" e "user">

<pull_130_Cria Endpoint /status para lidar com Health Check das depend√™ncias do TabNews>
Esse PR √© referente √† issue: https://github.com/filipedeschamps/tabnews.com.br/issues/102 e ele cria um endpoint com rota `/status` para verificar a saude dos componentes.
Esse PR cont√©m as mudan√ßas que est√£o pendentes de merge do PR: https://github.com/filipedeschamps/tabnews.com.br/pull/131
Esse PR Contempla:

- Cria√ß√£o do endpoint `/status` que roda todos os `health-indicators` do projeto.
- Cria uma factory `health-checker`, onde o objeto criado nela √© respons√°vel por executar todos os `health-checks` dispon√≠veis no TN.
- Cria um `database-health-indicator` que √© respons√°vel por realizar uma query no banco retornando as conex√µes ativas.
- Cria um teste integrado para validar a saude do banco de dados usado nos testes.
  > > Review de filipedeschamps (CHANGES_REQUESTED):
  > > Que show! üòç ficou mais simples e isso √© √≥timo ü§ù duas coisas bem simples para fazermos o merge:

1. Uma modifica√ß√£o bem pequena nos testes, para cobrir toda interface.
2. Fazer rebase e squash de todos os commits üëç
   Parab√©ns pela implementa√ß√£o, estamos bem pr√≥ximos üòç
   > > Review de liverday (COMMENTED):
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Aqui eu faria um teste contra toda a interface p√∫blica, ent√£o isso deveria tamb√©m testar a exist√™ncia da chave `opened_connections` üëç
   > > Coment√°rio de liverday (linha de c√≥digo):
   > > Pronto, resolvido!
   > > </pull_130_Cria Endpoint /status para lidar com Health Check das depend√™ncias do TabNews>

<pull_131_Finaliza padroniza√ß√£o dos Erros>
Continuando o PR #129 criado por @liverday, segue o que foi feito:

1. Squash dos commits do PR anterior e tradu√ß√£o das mensagens para o ingl√™s.
2. Movi os arquivos de erros para a raiz do projeto (`/errors`) para o projeto ficar o mais flat poss√≠vel (principalmente quando se trata de componentes especiais). E voc√™ pode importar tudo do mesmo arquivo com destructuring, por exemplo:

```js
import { InternalServerError, NotFoundError } from "/errors";
```

3. Erro `BaseError` ficou com a responsabilidade de apenas ser o template da estrutura de erro, e n√£o deve ser usado na aplica√ß√£o.
4. Cada erro customizado j√° vem com sua mensagem de erro padronizada, e isso vai reduzir o trabalho na hora de invocar eles, e tamb√©m n√£o vazar detalhes sens√≠veis, como antes com o interno vazando a URL de conex√£o do banco caso n√£o conseguisse se conectar. Agora ele apenas avisa do erro interno, e loga o que de fato aconteceu.
5. O erro customizado `InternalServerError` loga corretamente o stacktrace do que aconteceu, e consegue capturar qualquer coisa, at√© c√≥digo chamando coisa que n√£o existe, por exemplo:

```
ReferenceError: metodoInexistente is not defined
¬† ¬† at Array.authenticationHandler (webpack-internal:///./pages/api/v1/migrations/index.public.js:29:3)
¬† ¬† at loop (/Users/filipedeschamps/local/company/tabnews.com.br/node_modules/next-connect/dist/index.cjs:69:47)
¬† ¬† at next (/Users/filipedeschamps/local/company/tabnews.com.br/node_modules/next-connect/dist/index.cjs:74:13)
¬† ¬† at Array.injectRequestId (webpack-internal:///./pages/api/v1/migrations/index.public.js:24:3
    ...
¬† name: 'InternalServerError',
¬† message: 'Um erro interno n√£o esperado aconteceu.',
¬† action: "Informe ao suporte o valor encontrado no campo 'errorId'.",
¬† statusCode: 500,
¬† errorId: 'a14c7a9e-ece0-4131-af9e-18b8b62f9ff4',
¬† requestId: 'bdbc6a4d-8ffa-4e44-b087-82284967c8d8'
```

5. Um erro pode acontecer **antes de ser injetado o id da request (`requestId`)**, por isso agora cada erro gera automaticamente¬†um c√≥digo de erro interno (`errorId`). Mas caso passe com sucesso por uma request, o que ser√° retornado √© o par `errorId` e `requestId`.
6. Quando estivermos seguros de que estamos com a implementa√ß√£o correta, poderemos abstrair o handling de tudo isso para compartilhar entre controllers.
7. Por enquanto temos dois erros customizados: `InternalServerError` e `NotFoundError`, e ao longo do caminho vamos refinando esse controle, para por exemplo incluir um `DatabaseConnectionError`, ou `ValidationError`. Mas por enquanto, vai caindo no `InternalServerError` se n√£o for tratado de nenhuma forma.
   Closes #129
   </pull_131_Finaliza padroniza√ß√£o dos Erros>

<pull_136_Cria Endpoint /status para lidar com Health Check das depend√™ncias do TabNews (2)>
Esse PR continua o PR https://github.com/filipedeschamps/tabnews.com.br/pull/130.
Esse PR foi aberto com o objetivo de realizar alguns lints que n√£o foram feitos corretamente no PR anterior.
</pull_136_Cria Endpoint /status para lidar com Health Check das depend√™ncias do TabNews (2)>

<pull_138_Implementa um filtro que isola o contexto a query do `health-check` somente para o banco do TabNews>
Implementamos um endpoint que lista as depend√™ncias dos projetos e o status deles, conforme issue: https://github.com/filipedeschamps/tabnews.com.br/issues/102
Por√©m, a query que utilizamos para saber quantas conex√µes temos no banco de dados estava incorreta, pois n√£o filtrava pelo nome do banco, que √© super importante pra n√≥s que nesse momento, utilizamos um banco compartilhado no ambiente de Preview.
Portanto, esse PR implementa esse filtro, que foi f√°cilmente resolvido com uma envvar.
Caso tenham alguma d√∫vida, ou tenham alguma sugest√£o diferente, fico a disposi√ß√£o!
</pull_138_Implementa um filtro que isola o contexto a query do `health-check` somente para o banco do TabNews>

---

<pull*144*[GitHub Actions] Improvements on npm cache, merge all workflows into single yml file.>
Ola Pessoal, conforme descrito na issue #132 essa PR tem como objetivo melhorias no github actions.
Changes na PR:

- Cache do npm foi habilitado na actions que usam o `setup-node@v2`
- Merge dos workflows (`tests.yml`, `lint-styles.yml`, `lint-commits.yml`) em um √∫nico arquivo `cy.yml`
- Adicionado `concurrency`
  Sobre o t√≥pico de [concurrency](https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#concurrency), basicamente o objectivo dele seria limitar a execu√ß√£o de multiplas actions ao mesmo tempo no mesmo PR.

**Exemplo:**
Digamos que estou trabalhando em uma branch `branch-abc` e abro uma PR e recebo feedback sobre algum mudan√ßa que requer um novo commit e na tentativa de concertar ou melhorar isso enviei v√°rios commits em um curto espa√ßo de tempo.
O que iria acontecer e que cada commit iria gerar uma `run` e esse concurrency group limita isso de forma que ele ir√° cancelar (in-progress actions) que esteja executando contra essa PR mas com commits j√° 'antigos'.
</pull*144*[GitHub Actions] Improvements on npm cache, merge all workflows into single yml file.>

---

<pull_147_chore: update all outdated dependencies>
Por enquanto n√£o est√° sendo utilizado o novo SWC do next@12 por conta do projeto ter um arquivo `.babelrc`, conforme essa mensagem ao rodar o projeto:

```
[next] info  - Disabled SWC as replacement for Babel because of custom Babel configuration ".babelrc" https://nextjs.org/docs/messages/swc-disabled
```

Mas n√£o vejo muito problema por enquanto e podemos fazer o upgrade disso a qualquer momento ü§ù
\*E como √© bom ter testes, mesmo que sejam poucos, s√≥ pra ver que o projeto roda depois de um update grande de depend√™ncias üòç
</pull_147_chore: update all outdated dependencies>

<pull_149_POST / Create do User>
Continua√ß√£o do PR https://github.com/filipedeschamps/tabnews.com.br/pull/133 feito pelo @rodrigoKulb
Ainda est√° em Work in Progress, tem refatora√ß√£o de algumas coisas, incluindo deixando alguns componentes mais robustos a erros (e tem tamb√©m coisas que n√£o estou gostando), mas os destaques s√£o:

1. Adiciona os erros `DatabaseError` and `ValidationError`
2. Continua implementa√ß√£o da cria√ß√£o do User com valida√ß√£o dos campos
3. Implementa os testes de sucesso e fracasso (n√£o todos), e √© essa parte n√£o estou gostando, pois s√£o **muitas** combina√ß√µes de testes para todos os tipos de erros que d√° para gerar na valida√ß√£o de "username" por exemplo. S√≥ de "username" d√° para escrever 6 testes de valida√ß√£o de propriedade, mais testes como por exemplo "usu√°rio j√° encontrado no sistema".
   Voc√™s acham que vale a pena fazer testes para todas as varia√ß√µes?
   Bom, vou continuar aqui, pois tem bastante trabalho a fazer üëç

### [EDIT]

Fiz teste de todas as varia√ß√µes, isso vai nos dar muito mais seguran√ßa para refatorar o c√≥digo, principalmente se precisar trocar m√≥dulos (como o de valida√ß√£o, por exemplo).
Finalizei tamb√©m as principais responsabilidades relacionadas a `POST` e `Create` do User.
Removi logs de trace desnecess√°rios e tamb√©m refatorei a organiza√ß√£o do teste do User para uma forma que fica mais leg√≠vel no modo `--verbose` do Jest (e talvez fique um pouco mais escal√°vel). Vamos ver como vai se comportar no longo prazo.
E eu sei que esse PR ta ficando um **monstro**, mas como poucas pessoas est√£o mexendo no projeto no momento, acho que vou continuar ele at√© finalizar o CRUD do User üëç
</pull_149_POST / Create do User>

<pull_150_Continua√ß√£o da implementa√ß√£o do User>
J√° fiz super cedo o push desse PR, porque quero ir anotando todas as coisas que estou fazendo ao redor da implementa√ß√£o, porque esbarrei numa coisa importante (ali do timezone), e se eu esbarrar em mais, j√° vou dando push e anotando üëç

### 1) Watch de 1 arquivo s√≥

O Mocha era mais f√°cil nesse ponto que o Jest, porque bastava colocar um `.only` num teste que, de todos os arquivos, ele lia todos primeiro para tentar achar esse `.only` e s√≥ rodar ele. No Jest n√£o, voc√™ precisa passar um nome de arquivo por flag/filtro, e somente desses arquivos filtrados que ele ir√° respeita o `.only` (de todos). Uma forma de fazer isso com uma UX ok √© o seguinte:
`npm run test:watch -- -t=v1/users`
Assim ele ir√° rodar a parte `npm run test:watch` (que roda somente o Jest) e o `--` ir√° fazer o pipe de `-t=v1/users` pro final do comando do Jest. Em paralelo, voc√™ precisa rodar em outro terminal o `npm run dev` para ter os servi√ßos de banco e site rodando (e ver os logs da aplica√ß√£o).
E se voc√™ quiser dar um watch em tudo (e rodando os servi√ßos), basta rodar `test:watch:services`.

### 2) Bagun√ßa do `timezone` no m√≥dulo do Postgres

@rodrigoKulb essa √© boa, porque voc√™ corretamente criou as migrations do user com `type: timestamp without time zone`, por√©m isso _confunde_ o m√≥dulo `pg` porque no momento que a string com a data volta, ele taca um `new Date(xxx)` em cima disso e o resultado √©: de uma string que veio do banco **sem timezone**, ao passar pelo new Date() tamb√©m sem timezone, ele converte para hor√°rio local. Olha que interessante essa thread aqui: https://stackoverflow.com/questions/20712291/use-node-postgres-to-get-postgres-timestamp-without-timezone-in-utc
Tem algumas boas solu√ß√µes, como por exemplo se injetar no meio do `pg` para evitar que ele fa√ßa essa convers√£o e retorne apenas a String. Ou colocar uma biblioteca no meio que converta levando em considera√ß√£o que √© UTC. Mas para n√£o ficar dividida a responsabilidade entre camada de persist√™ncia e camada de aplica√ß√£o, decidi fazer o seguinte:

1. Ao inv√©s de persistir a data sem timezone, coloquei para persistir com timezone em UTC.
2. Isso faz retornar do banco a string com o Timezone nela, que ao ser convertido pelo `pg` usando `new Date(), considera esse dado extra e retorna o valor de forma correta, e que tamb√©m pode ser convertida para qualquer outro timezone (timezone para timezone).
3. Eu n√£o sei at√© que ponto isso vai funcionar, ent√£o **vamos ficar monitorando as datas com mais proximidade** mas me parece certo anotar no dado qual o timezone dele üëç

### 3) Timeout do banco

Estava localmente tentando estressar os testes no modo `watch`, e sem eu entender porque, em algum momento o database pede uma nova conex√£o pro banco e ela nunca √© retornada. Por padr√£o o m√≥dulo `pg` n√£o tem timeout, e isso fazia o script aguardar para sempre. Fiquei cavucando at√© chegar na borda do m√≥dulo e n√£o consegui encontrar nenhum padr√£o. Ent√£o decidi adicionar um timeout no Pool inteiro de 5 segundos (n√∫mero arbitr√°rio), onde se ele n√£o conseguir conectar, ele d√° o throw em um erro. Isso √© uma pr√°tica boa (tudo deveria ter timeout na verdade), mas hoje n√£o fazemos nada com esse erro, como por exemplo implementar um `retry`. Sugiro s√≥ fazermos isso quando come√ßarmos a esbarrar em problemas como o n√∫mero de conex√µes do banco chegar no limite ü§ù

### 4) Cria√ß√£o duplicada

Um detalhe simples mas muito interessante √© que eu tinha feito implementa√ß√£o e testes para evitar a cria√ß√£o de usu√°rios duplicados (e emails duplicados), mas a verifica√ß√£o podia ser burlada se fosse usado letras mai√∫sculas e min√∫sculas diferentes, por exemplo: `filipedeschamps` e `FilipeDeschamps`. Agora na busca de verifica√ß√£o √© usado na query um `LOWER()`. E exclusivo para o campo `email` √© feito uma convers√£o do texto para lower case (e salvar no banco assim).

### 5) #findOneByUsername

Implementado esse m√©todo e @rodrigoKulb ao inv√©s de buscar por `id` eu optei por buscar (por enquanto), apenas por `username` e fazer essa busca case insensitive. Por exemplo:

```
POST /api/v1/users/ -> { username: 'FilipeDeschamps', ...}
GET /api/v1/users/FilipeDeschamps [OK]
GET /api/v1/users/filipedeschamps [OK]
```

### 6) Remove DELETE

Seguindo o que o @rodrigoKulb tinha comentado, n√£o vamos fazer opera√ß√£o de `DELETE` para os recursos. Devemos mudar o status ou alguma outra abordagem.

### 7) GET /v1/users

Antes estava retornando todos os dados, incluindo senha. Agora n√£o retorna a senha, mas retorna o email, o que tamb√©m √© preocupante e isso tudo devemos resolver quando implementarmos a Autoriza√ß√£o. Eu pessoalmente nunca implementei na m√£o controle assim de propriedade, ent√£o vamos trocar ideias ü§ù

### 8) PATCH /v1/users/:username

Implementei o m√©todo `PATCH` contra um username e √© importante notar a diferen√ßa entre `PATCH` e `PUT`, onde o `PATCH` deixa voc√™ enviar um JSON com dados parciais (e mant√©m inalterado propriedades que n√£o foram enviadas), enquanto o `PUT` deveria sobrescrever o objeto inteiro, ent√£o caso voc√™ n√£o envie um dado, ele deveria ser removido do banco. O que me surpreendeu na implementa√ß√£o √© pensar o qu√£o similar √© um `POST` de um `PUT`, principalmente se voc√™ fizer opera√ß√µes idempotentes.

### 9) Passwordless

N√£o fiz implementa√ß√£o de nada relacionado a isso, mas optei por n√£o fazer os testes de `PATCH` para o campo `password`, pois conversando com o @gustavodeschamps estou pensando seriamente em fazer o site _passwordless_. O que voc√™s acham? Esse pensamento veio enquanto estava revisando a edi√ß√£o da Newsletter de hoje de manh√£, sobre mais um ataque hacker. O TabNews, como qualquer outro site, pode ser alvo de hackers e talvez se fizermos um login sem senha (e usando "magic link" por email) ir√° evitar vazamento de senhas (porque elas n√£o existir√£o) e automaticamente colocar√° todas as contas sob two-factor. Vou ficar pensando a respeito üëç
</pull_150_Continua√ß√£o da implementa√ß√£o do User>

<pull_151_Pequena refatora√ß√£o no User e Health>
O User tinha um m√©todo de coer√ß√£o que n√£o estava sendo usado (porque o Joi j√° faz isso de forma autom√°tica na valida√ß√£o) e o Health foi movido para a pasta `models` (no plural).
</pull_151_Pequena refatora√ß√£o no User e Health>

<pull_154_docs(diary): remove diary itens>
Everything was moved to https://github.com/filipedeschamps/tabnews.com.br/wiki
</pull_154_docs(diary): remove diary itens>

<pull_155_feat(user): remove all `password` features>
Preparando o terreno para "passwordless" üëç
</pull_155_feat(user): remove all `password` features>

<pull_158_Revert "feat(user): remove all `password` features">
Pessoal, estou revertendo a remo√ß√£o de senha, pois o fluxo "passwordless" tem um problema grave e que eu desenvolvo l√° no di√°rio de desenvolvimento: https://github.com/filipedeschamps/tabnews.com.br/wiki/029.-Revertendo-a-ideia-de-%22passwordless%22
</pull_158_Revert "feat(user): remove all `password` features">

<pull_159_feat(email): create email module and service>
Explica√ß√µes no di√°rio de desenvolvimento: https://github.com/filipedeschamps/tabnews.com.br/wiki/030.-Infraestrutura-de-emails
</pull_159_feat(email): create email module and service>

<pull_160_test(orchestrator): add methods for delete and retrieve emails>
Buguei no √∫ltimo PR e n√£o mandei o diff do arquivo do `orchestrator` üëç
</pull_160_test(orchestrator): add methods for delete and retrieve emails>

<pull_161_build(package.json): update outdated dependencies>
Rotina normal de atualiza√ß√£o de pacotes desatualizados, s√≥ pra n√£o ficar muito para tr√°s nesse quesito üëç
</pull_161_build(package.json): update outdated dependencies>

<pull_162_feat(user): implements password hashing>
Irei escrever o di√°rio de desenvolvimento amanh√£ se os testes passarem ü§ù

**[edit]**
https://github.com/filipedeschamps/tabnews.com.br/wiki/031.-Hash-das-passwords
</pull_162_feat(user): implements password hashing>

<pull_163_Refactor User from Factory to Singleton>

## User

O diff desse PR ta p√©ssimo, mas √© super simples o principal: eu transformei o model `user` de Factory para um Singleton. O motivo √© que n√≥s n√£o est√°vamos usando ele como uma Factory de verdade. Antes a gente executava `userFactory()` que retornava um `user` sem `state` algum, era um objeto simples com m√©todos puros que quando executados retornavam um outro objeto. Por exemplo:

```js
import userFactory from 'models/user.js';
const user = userFactory();
const newUser = user.create({...});  // isso daqui √© uma fun√ß√£o pura, ela n√£o muda o state do `user`
const specificUser = user.findOneByUsername(...)
```

Agora basta somente importar o user e usar ele direto:

```js
import user from 'models/user.js';
const newUser = user.create({...});
const specificUser = user.findOneByUsername(...)
```

O que √© uma abordagem diferente de ORMs como Sequelize, onde voc√™ pode importar o model (que √© um singleton) e usar os m√©todos est√°ticos (como √© a nossa atual situa√ß√£o), ou criar uma nova inst√¢ncia com `state` e que depois voc√™ tem que dar `save()` nessa inst√¢ncia.
Vamos ficar de olho se vai dar para continuar evoluindo com a solu√ß√£o atual, se n√£o a gente refatora tudo sem pensar duas vezes ü§ù

## /status

O secund√°rio desse PR √© que agora o `/api/v1/status` retorna `503` caso o banco de dados esteja fora do ar.
</pull_163_Refactor User from Factory to Singleton>

<pull_165_ci: renaming actions>
Rename das actions descritas na task da issue #164:
</pull_165_ci: renaming actions>

<pull_170_feat(authentication): implements Authentication and Authorization>
Pull request absurdamente monstruoso que eu sinceramente nem me preocuparia com o diff agora. Sugiro fazermos o seguinte:

1. Se os testes passarem, eu vou gravar um novo v√≠deo, como eu fiz para a issue #107 explicando com mais calma em que est√°gio estamos da implementa√ß√£o.
2. Se n√£o tiver nada gritante de errado, eu vou fazer o merge desse PR aqui.
3. Isso vai liberar para que novas implementa√ß√µes sejam feitas em cima dessa nova base de c√≥digo, incluindo as refatora√ß√µes que estamos discutindo na issue apontada ali em cima.
4. Fora isso, tamb√©m nos libera implementar Autoriza√ß√£o em outros endpoints, como no caso do `/api/v1/migrations` que hoje est√° aberto.
5. E tamb√©m tem v√°rias outras refatora√ß√µes que quero fazer nos testes que existiam antes desse PR aqui (e que n√£o consideravam nada de Autoriza√ß√£o nem Autentica√ß√£o).
   > > Review de tcarreira (COMMENTED):
   > > eish, entendi zero do c√≥digo do orchestrator üòÖ
   > > Mas dei uns coment√°rios sobre algumas coisas :)
   > > Review de filipedeschamps (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de tcarreira (COMMENTED):
   > > Review de tcarreira (COMMENTED):
   > > Review de tcarreira (DISMISSED):
   > > Siga :1st_place_medal:
   > > Review de filipedeschamps (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de tcarreira (DISMISSED):
   > > Review de tcarreira (CHANGES_REQUESTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de tcarreira (DISMISSED):
   > > Review de tcarreira (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de tcarreira (DISMISSED):
   > > s√≥ vai üòÖ
   > > Coment√°rio de tcarreira (linha de c√≥digo):
   > > o `id` devia ser `type: 'uuid'`
   > > Coment√°rio de tcarreira (linha de c√≥digo):
   > > Vc pode adicionar no texto do PR a raz√£o de usar text em vez de email?
   > > Da documenta√ß√£o, eu at√© entendo que deveria ter os dois campos ü§î (https://nodemailer.com/message/)
   > > Isto √© apenas nesta fase de desenvolvimento e mais tarde vemos o resultado, ou √© alguma outra coisa?
   > > Coment√°rio de tcarreira (linha de c√≥digo):
   > > eu vou chutar que se este link for enviado como `text`, ele n√£o vai ser clic√°vel.
   > > Mas provavelmente depende do cliente de email
   > > Coment√°rio de tcarreira (linha de c√≥digo):
   > > Esta ordem faz com que os defaults se sobreponham aos validUserData.
   > > Eu esperava o contr√°rio (ent√£o talvez valha deixar um coment√°rio clarificando)
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > massa!! Isso foi uma grande d√∫vida minha, eu comecei com `uuid` mas achei muito inseguro. N√£o achei nenhum padr√£o pela internet no assunto, da√≠ pelo que lembro fui ver quantos caracteres tinha a sess√£o do Facebook e coloquei mais ou menos parecido.
   > > Olha s√≥ onde ele √© gerado: https://github.com/filipedeschamps/tabnews.com.br/blob/auth/models/session.js#L7

```
const sessionToken = crypto.randomBytes(48).toString('hex');
```

Isso gera `96` caracteres rand√¥micos e URL safe üëç
Mas novamente, **n√£o estou seguro** sobre esse dado. H√° alguma boa pr√°tica no que usar como token de sess√£o?

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Fase de desenvolvimento üòÇ
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Isso, depende do cliente üëç mas como comentado ali em cima, s√≥ tem text porque √© fase de desenvolvimento, mas n√£o ter√≠amos problema nenhum mandar s√≥ assim dado a experi√™ncias no passado ü§ù
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Eita, eu esperaria o contr√°rio tamb√©m, vou revisar ü§ù
> > Coment√°rio de tcarreira (linha de c√≥digo):
> > Acho que a tradu√ß√£o de default values significa valores por omiss√£o, ou seja, o valor se vc n√£o disser nada espec√≠fico da√≠ a minha expectativa
> > Coment√°rio de tcarreira (linha de c√≥digo):
> > Ent√£o, tenho dois coment√°rios.

- Sugeri uuid porque √© assim implementado nos outros lugares (eg: user.id). J√° n√£o toco em postgres faz alguns anos, mas eu diria que se vc n√£o usar o postgres para criar o uuid, ent√£o deve ficar varchar (ou s√≥ char, j√° que ele n√£o √© vari√°vel). Como estamos falando de um id da tabela, acho bem o uuid
- depois do seu coment√°rio, eu entendo que este id n√£o √© igual aos outros, ou seja, n√£o √© um id de tabela mas sim um id de neg√≥cio. Ser√° que dev√≠amos chamar ele de token?
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > @tcarreira voc√™ est√° 100% certo!!! Eu viajei total e quebrei o padr√£o esperado de `id` ser o identificador do objeto. Vou fazer a altera√ß√£o para `uuid` e repassar esse valor para outro campo, como voc√™ falou, `token` ü§ù
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > S√≥ pra confirmar: os defaults sobrep√µe de fato e era para garantir que esse seria o valor default do User, por√©m pensando algumas jogadas mais para frente, isso vai ser removido quando um "admin" conseguir criar usu√°rios com outras features.
  > > Eu vou fazer o seguinte: vou remover essa l√≥gica de default e deixar o default no banco de dados mesmo üëç
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > Resolvido no √∫ltimo commit üëç
  > > Coment√°rio de tcarreira (linha de c√≥digo):
  > > deveria ser `return next()`?
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > √ìtimo ponto! Programaticamente n√£o faz diferen√ßa, mas se essa pergunta surgiu √© porque o c√≥digo n√£o est√° claro, **e de fato n√£o est√°**! Muito obrigado por vir aqui cutucar isso.
  > > A fun√ß√£o `injectUserUsingSession()` est√° com a responsabilidade de chamar o `next()` (que serve para dar sequ√™ncia na execu√ß√£o dos controllers e ela deveria ter apenas a responsabilidade de injetar os dados no contexto... e n√£o chamar o next().
  > > Quem deveria ter essa responsabilidade √© a fun√ß√£o acima `injectAnonymousOrUser()` que inclusive ela chama o `next()` para o caso do usu√°rio an√¥nimo. Vou refatorar ü§ù
  > > Coment√°rio de tcarreira (linha de c√≥digo):
  > > Vc √© um comunicador fant√°stico.
  > > Obrigado pela oportunidade de "trabalhar" com vc üòâ
  > > Eu trabalho em TI h√° quase 10 anos, sou DevOps (e desenvolvedor nas horas "livres") e estou aqui para aprender com vc (e restante comunidade).
  > > Eu sei que este coment√°rio vai ficar escondido, mas eu gosto mais de ser discreto. E acho que vc vai gostar de ler :)
  > > (pena o javascript, mas n√£o podia ser tudo bom üòÇ )
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > @tcarreira sempre quando pinga um coment√°rio seu no meu email eu fico feliz, sem mesmo saber o que √©. Isso mostra o qu√£o feliz estou com a sua participa√ß√£o aqui. Muito muito obrigado ü§ù
  > > E sobre o JS, concordo 100% üòÇ üòÇ üëç
  > > </pull_170_feat(authentication): implements Authentication and Authorization>

<pull_172_feat(authorization): secures patching other users>
Protegendo a rota de update de usu√°rios para aceitar update vindo do mesmo usu√°rio, ou de um usu√°rio com a feature `update:user:others`
</pull_172_feat(authorization): secures patching other users>

<pull_174_docs(readme): adds instructions to install, run and test the project>
Dois itens da issue #91 n√£o foram inclu√≠dos:

1. **Docker**: Incluir como instalar e rodar o Docker para cada sistema operacional vai desvirtuar o escopo do README do projeto, que deveria ser primariamente sobre o TabNews.
2. **act**: Depois de todas as altera√ß√µes que fizemos no CI, o `act` n√£o est√° mais rodando. Antes de instruir como usar ele, precisamos primeiro consertar ele.
   Closes: #91
   </pull_174_docs(readme): adds instructions to install, run and test the project>

<pull_175_Linting and node version>
Ol√° pessoal,
Estou querendo iniciar minhas contribui√ß√µes ao projeto. J√° acompanho h√° algum tempo e sou muito f√£ do trabalho de voc√™s. Estou come√ßando por enquanto com algumas pequenas 'perfumarias':

- vers√£o do node: Quando fui rodar `npm install` vi que o package-lock.json foi alterado, pois eu estava numa vers√£o maior do Node (v16). Ent√£o resolvi adicionar o arquivo `.nvmrc` para quem utiliza o nvm e poder utilizar a vers√£o correta do Node e n√£o ter problemas com o package-lock. √â poss√≠vel que exista uma maneira de instalar as depend√™ncias sem tocar no package-lock.json (sei que no yarn isso √© poss√≠vel), mas com a vers√£o salva no arquivo .nvmrc j√° resolve;
- Linting: eu sou o 'chato' do linting rs e para retirar 2 warnings adicionei uma rule no .eslintrc.
  Neste final de semana vou dar uma olhada geral no projeto e nas tarefas e quem sabe se aventurar em alguma issue.
  Abra√ßo a todos!
  </pull_175_Linting and node version>

<pull_178_Renomeia todas features para o padr√£o "object:action:extras">
Ent√£o ao inv√©s de `update:user`, agora √© `user:update`.
E os extras s√£o coisas do tipo `user:update:others` para um usu√°rio ganhar a feature de atualizar outros usu√°rios.
O PR vem tamb√©m com outras melhoras, dando aos erros mais propriedades e fazendo o authorization se "auto-utilizar" (para aproveitar a valida√ß√£o da exist√™ncia de features).
</pull_178_Renomeia todas features para o padr√£o "object:action:extras">

<pull_179_docs(readme): adds instructions to use nvm>
Esta PR somente adiciona no README.md a op√ß√£o de instala√ß√£o do node pelo nvm.
</pull_179_docs(readme): adds instructions to use nvm>

<pull_195_fix(migrations): protect the GET and POST migration route>
Ol√° Filipe!!
Adorei o v√≠deo tutorial do Tabnews! Sua ideia de fazer a gente colocar a m√£o na massa, funcionou pra mim kkkkk
Eu fazia parte daquele grupo que tinha receio de mexer no c√≥digo daqui. :D
A√≠ vai meu primeiro PR! \o/
</pull_195_fix(migrations): protect the GET and POST migration route>

<pull_197_Faz o `database` ser mais robusto contra falhas ao pegar novos Clients de conex√£o>
N√£o sei at√© que ponto isso vai funcionar na vida real, mas subiu a estabilidade da aplica√ß√£o para outro n√≠vel (mas s√≥ a vida real vai dizer se isso se sustenta üòÇ ) e foi uma das coisas mais **delicinha** que eu programei at√© ent√£o.

**Contexto:** quem viu o √∫ltimo v√≠deo do TabNews, acompanhou que uma hora no meio do tutorial o banco engasgou, do nada, e isso "aparentemente" s√≥ estava acontecendo localmente e sem padr√£o algum (porque nunca aconteceu no CI). Pensei que era minha m√°quina e fiquei analisando o banco, n√∫mero de conex√µes abertas e n√£o encontrava nada... a aplica√ß√£o do Next.js simplesmente engasgava, s√≥ que em paralelo eu conseguia conectar normalmente no banco usando um Client externo. No final das contas, era eu quem estava fechando por completo o Pool de conex√µes a todo momento, achando que eu estava apenas fechando a conex√£o de um Client espec√≠fico e que foi aberta manualmente.
Ent√£o como funciona o `pg` nesse sentido (e pensando aqui toda estrat√©gia de Pool com Postgres): **sempre voc√™ est√° com um Client em m√£os para trabalhar**... mas que pode ser adquirido de duas formas: manualmente abrindo a conex√£o e com isso tendo em m√£os um Client, ou pedindo para o Pool por um Client dispon√≠vel que esteja l√° na fila parado e aguardando ser utilizado. Eu pensei que voc√™ se conectava contra um Pool, mas n√£o, ele s√≥ administra Clients que ele mesmo est√° abrindo e fechando.
E quando voc√™ precisa de um Client manual? Quando voc√™ faz uma transaction (que no Postgres deve sempre manter na mesma conex√£o) ou bibliotecas que pedem um Client conectado, como a `node-pg-migrate` que usamos, que por dentro usa uma transaction e passa pra voc√™ a responsabilidade de encerrar ela ao final.
Ent√£o antes eu pedia um Client e encerrava o Pool (porque ele estava vindo de l√°). Agora n√£o, voc√™ pode usar o `getNewClient()` para pegar um client e o `database.query()` vai continuar usando de forma transparente o Pool.

### Mas o que trouxe "robustez" foi outra coisa

Parar de fechar o Pool foi um bug que eu introduzi por me confundir com a api do `pg`, mas deixar o `database` mais robusto quando voc√™ tem poucas conex√µes dispon√≠veis foi feito atrav√©s de uma estrat√©gia de **retry**.
Tanto para pegar um Client manualmente ou do Pool, o c√≥digo fica repetidamente pedindo por um novo Client, tentando, tentando, tentando (com m√°ximo de 50 tentativas) e quando conseguir pegar um com sucesso, o c√≥digo continua. E por continuar pode ser simplesmente retornar o Client, ou rodar uma query. Importante destacar que "rodar a query" fica fora das tentativas... a √∫nica coisa que se tenta √© pegar um Client saud√°vel.

```js
import retry from 'async-retry';
...
async function tryToGetNewClientFromPool() {
  const clientFromPool = await retry(newClientFromPool, {
    retries: 50,
    minTimeout: 0,
    factor: 1.3,
  });
  return clientFromPool;
  async function newClientFromPool() {
    return await pool.connect();
  }
}
```

E isso pode ser usado no m√©todo de quey:

```js
async function query(query, params) {
  let clientFromPool;
  try {
    clientFromPool = await tryToGetNewClientFromPool(); // isso s√≥ ir√° continuar quando pegar um Client saud√°vel
    return await clientFromPool.query(query, params);
  } catch (error) {
    ...
  } finally {
    if (clientFromPool) {
      clientFromPool.release();
    }
  }
}
```

### Testes de carga em localhost

Usei o `ab` pra tentar arrebentar aqui o servi√ßo local tanto com `5` conex√µes dispon√≠veis no Postgres, quanto `1` √∫nica conex√£o e a aplica√ß√£o se comportou muito melhor do que eu esperava. A √∫nica forma que consegui estourar foi chegando no limite dos sockets do sistema operacional.
Fiquei muito feliz porque isso nos habilita a usar servi√ßos mais baratos de Postgres (e que vem com uma quantidade pequena de conex√µes), com o agravante de estarmos num ambiente serverless e que pode abrir infinitas conex√µes. Mas **novamente**, s√≥ a vida real vai nos dizer o que vai acontecer.
Em paralelo, confere essa issue #196 onde o @andrefd17 deu duas dicas **sensacionais** de ferramentas pra teste de carga.

### N√∫mero m√°ximo de conex√µes

Agora o endpoint `/api/v1/status` retorna o n√∫mero m√°ximo de conex√µes do banco no campo `max_connections`. Vai ficar mais r√°pido e f√°cil saber o que de fato nosso provider de banco de dados est√° nos entregando:

```json
{
  "updated_at": "2022-02-23T10:20:17-08:00",
  "dependencies": {
    "database": {
      "status": "healthy",
      "max_connections": 4,
      "opened_connections": 1
    }
  }
}
```

**[edit]**
N√£o pera, testando em staging est√° retornando `"max_connections": 10000` üòÇ vou tentar isolar para o nosso banco, como fizemos em `opened_connections`.

**[edit2]**
N√£o tem jeito, n√£o consigo isolar por user ou database, mas coloquei um TODO ali caso algu√©m saiba como pegar esse n√∫mero em um banco de dados compartilhado.

**[edit3]**
Consegui:

```js
const maxConnectionsResult = await database.query(
  "SELECT rolconnlimit as max_connections FROM pg_roles WHERE rolname = $1;",
  [process.env.POSTGRES_USER]
);
```

</pull_197_Faz o `database` ser mais robusto contra falhas ao pegar novos Clients de conex√£o>

<pull_200_Passa a usar email+senha para autentica√ß√£o dos usu√°rios>
Esse PR resolve a issue https://github.com/filipedeschamps/tabnews.com.br/issues/185, onde trocamos a forma como a autentica√ß√£o dos usu√°rios est√° sendo realizada.
Overview sobre as mudan√ßas realizadas:

- Foi adicionado um m√©todo `validatePostSchema` dentro de `models/sessions` para conseguirmos validar o input enviado pelos usu√°rios, com o objetivo de satisfazer esse `TODO`:

```js
// TODO: Validate the requirement of "username" and "password".
const insecureInputValues = request.body;
```

- Foi adicionado um m√©todo `findOneByEmail` dentro de `models/user` para conseguirmos buscar um usu√°rio por e-mail. Segui o mesmo crit√©rio do `findOneByUsername` de jogar tudo pra "lower" no filtro.

```sql
SELECT * FROM users WHERE LOWER(email) = LOWER($1) LIMIT 1;
```

- Foram criados 11 testes (`tests/sessions/post.js`) para validar o funcionamento da feature.
  Fico a disposi√ß√£o para maiores d√∫vidas :+1:
  </pull_200_Passa a usar email+senha para autentica√ß√£o dos usu√°rios>

<pull_201_Usa email + senha para criar sess√µes>
E parar de usar o `username` que √© um dado p√∫blico. Isso foi proposto por @tcarreira na issue #185 e implementado por @liverday no PR #200
Criei esse PR para for√ßar o CI rodar e ver a necessidade de refatorar algo ü§ù

> > Review de liverday (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de liverday (linha de c√≥digo):
> > Percebi que aqui ficou errado @filipedeschamps, d√° pra corrigir antes do merge?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > D√° sim total! Eu fa√ßo aqui rapid√£o porque to com a m√£o nessa branch ü§ù üëç
> > </pull_201_Usa email + senha para criar sess√µes>

<pull_202_build(postgres): upgrades to 14.1 and removes the uuid ossp extension>

# Aten√ß√£o

Caso voc√™ puxe esse PR, √© bastante prov√°vel que voc√™ precise deletar o container local do banco do tabnews. Ao menos, aqui do meu lado ele reclamava que j√° existia um banco de dados e n√£o subia o novo container com a nova vers√£o. Tive que apagar.

# Motivo

Estou na trilha de configurar os bancos finais de Staging e Production e por hora vamos usar a vers√£o 14.1 do Postgres e nas pesquisas notei que podemos remover uma das migrations, aquela primeira que instalava uma extens√£o para gerar `uuid`.
Ent√£o com essa vers√£o do Postgres (e acho que na 13.x tamb√©m j√° tinha isso), √© s√≥ quest√£o de chamar:

```js
default: pgm.func('gen_random_uuid()')
```

Ao inv√©s de ter que instalar a extens√£o e chamar:

```js
default: pgm.func('uuid_generate_v4()')
```

Pelos testes, todos os uuids gerados foram validados, inclusive na vers√£o 4 üëç
</pull_202_build(postgres): upgrades to 14.1 and removes the uuid ossp extension>

<pull_203_feat(status): adds `latency` measurement>
Uma pequena feature que vai ajudar a monitorar a lat√™ncia do banco de dados, principalmente quando a gente fizer os testes entre regi√µes de deploy das lambdas e inst√¢ncia do banco üëç
</pull_203_feat(status): adds `latency` measurement>

<pull_204_feat(status): adds `webserver` dependency>
Eu estou usando Terraform igual a um doido e estou preparando o ambiente de staging para realizar uns testes em breve e conseguir monitorar melhor o que est√° acontecendo. Pra isso, nesse PR eu adiciono uma depend√™ncia no `/status` para mostrar algumas informa√ß√µes adicionais do servidor web e o ambiente que est√° deployado.
</pull_204_feat(status): adds `webserver` dependency>

<pull_208_Terraform: faz infraestrutura ser gerenciada por c√≥digo>
Depois quero fazer um v√≠deo ou escrever no di√°rio de desenvolvimento sobre a abordagem de usar o Terraform para ter os ambientes de Staging e Production similares (e n√£o id√™nticos, porque ter√° diferen√ßas como tamanho do banco, reten√ß√£o de backups e v√°rias outras caracter√≠sticas dos recursos). Mas, a **topologia** se mant√©m a mesma, o que √© muito massa üëç

**[edit]** como eu altero o `.env` na parte dos dados default para cria√ß√£o do banco local, ap√≥s o merge desse PR voc√™ precisar√° deletar o container e o estado do banco no seu Docker ü§ù

> > Review de huogerac (APPROVED):
> > Hey @filipedeschamps ficou bem legal a estrutura. Divis√£o por ambiente e recursos.
> > Eu estou aprovando, eu consegui rodar o terraform init e terraform plan.
> > N√£o dei o apply, pq n√£o queria gastar umas doletas...sorry
> > </pull_208_Terraform: faz infraestrutura ser gerenciada por c√≥digo>

<pull_209_Modifica o padr√£o das features>
Esse PR faz 4 coisas importantes:

1. Modifica o padr√£o das features para `action:object:extras`. Alguns exemplos:

- `read:activation_token`
- `create:session`
- `update:user`
- `update:user:others_email`

2. Move as features padr√µes da Migration para o model User. Isso vai evitar uma nova migra√ß√£o caso a gente precise mudar os defaults (o que d√° mais flexibilidade em ir e voltar com os deploys), e tamb√©m agora ambas features padr√µes do User e Anonymous user est√£o no mesmo lugar.
3. Remove a necessidade de features das rotas p√∫blicas como `read:user` e `read:user_list`, porque sem essa l√≥gica a gente pode fazer o cache desses valores na CDN. Isso est√° conectado com o item abaixo, mas resolve outro problema futuro: se **toda rota p√∫blica** precisar de uma feature, quando criarmos uma nova rota (e por consequ√™ncia uma nova feature), a gente teria que rodar um script para injetar essa nova feature em todos os usu√°rios que se cadastraram antes desse evento para que eles tenham a habilidade de ler essa rota.
4. Remove o retorno do `email` de todas as rotas atuais. Isso para evitar que em uma rota que foi cacheada usando um usu√°rio privilegiado contenha informa√ß√µes sens√≠veis, como o email. N√£o sei como atender ao requisito desse cache e ao mesmo tempo o usu√°rio autor ou privilegiado possam ver esse dado. Talvez uma rota espec√≠fica para isso como `.../users/[username]/email` e que nunca ter√° cache.
   > > Review de tcarreira (APPROVED):
   > > Achei massa pensar na parada de caching.
   > > Ser√° que vale deixar isso comentado no c√≥digo, talvez junto dos testes com `expect(responseBody).not.toHaveProperty('email');` ?
   > > </pull_209_Modifica o padr√£o das features>

<pull_210_perf(test): just testing `us-east-1` performance>
Nada que ir√° impactar o lan√ßamento do projeto, mas algo no ambiente de produ√ß√£o est√° me deixando confuso.
Se voc√™ testar a URL de status (https://www.tabnews.com.br/api/v1/status) depois de fazer refresh algumas vezes para esquentar a lambda, a lat√™ncia m√≠nima entre a aplica√ß√£o e banco est√° atingindo pr√≥ximo de 50ms:

```json
    "database": {
      "status": "healthy",
      "max_connections": 82,
      "opened_connections": 1,
      "latency": 58.88156000012532
    },
```

Isso considerando que, nesse ambiente, tanto a Aplica√ß√£o quanto o Banco de Dados est√£o na mesma regi√£o (S√£o Paulo) e isso √© representado por `gru1` na Vercel e `sa-east-1` na AWS:

```json
      "aws_region": "sa-east-1",
      "vercel_region": "gru1",
```

S√≥ que na issue #206 quando est√°vamos fazendo os testes de performance entre as regi√µes, a lat√™ncia na regi√£o de SP come√ßava em **29ms** e conseguia depois constantemente atingir **12ms**. Num cen√°rio que uma mesma request pode fazer v√°rias queries, isso pode fazer bastante diferen√ßa.
Ent√£o estou testando nesse PR a regi√£o dos EUA com o Banco tamb√©m l√° (tudo `us-east-1`) para ter um comparativo.
PS: essa diferen√ßa na lat√™ncia entre a issue original e agora foi depois que fiz o deploy final do Terraform e eu **acho** que a maior diferen√ßa entre os testes e essa vers√£o final, √© que nos testes eu usei a vers√£o `13.x` do Postgres, e na final eu o usando a `14.1`.
</pull_210_perf(test): just testing `us-east-1` performance>

<pull_212_Revert "perf(database): changes database strategy to reuse connections">
This reverts commit a2b106e5d36bd56fe045f64e2e9c2cb0303d029a.
</pull_212_Revert "perf(database): changes database strategy to reuse connections">

<pull_215_Volta a usar Pool no Database + Parameter Group no RDS>
Esse PR faz duas coisas:

## Pool

Ele faz voltar o uso do Pool, mas com o detalhe de `idleTimeoutMillis` ser setado para apenas `1`. Isso faz com que o Pool seja aberto com uma conex√£o v√°lida, que √© reutilizada ao longo das queries dentro de uma mesma request, e depois logo em seguida ser fechada. Assim n√£o precisamos fazer o gerenciamento da conex√£o por fora (pelos controllers).
Ent√£o na estrat√©gia original (que era abrindo uma conex√£o para cada query), ao fazer uma request, o resultado era o seguinte:

```js
      "latency": {
        "first_query": 19.859559000004083,
        "second_query": 17.381792000029236,
        "third_query": 18.042578999884427
      },
```

Ou seja, para cada query uma nova conex√£o era aberta e todas duravam mais ou menos a mesma coisa.
Num teste simples de carga com **5.000** requests (sendo **100** em paralelo), o tempo total foi de **78 segundos**.

---

Nessa nova estrat√©gia (que √© reaproveitar o client a cada request), o resultado de uma request foi o seguinte:

```js
      "latency": {
        "first_query": 19.316103999968618,
        "second_query": 2.637129999930039,
        "third_query": 1.5327200000174344
      },
```

Ou seja, a primeira query √© penalizada por ter que abrir a conex√£o, mas as pr√≥ximas queries reaproveitam essa conex√£o e s√£o mais r√°pidas.
E em outro teste de carga com as mesmas **5.000** requests (e tamb√©m **100** em paralelo), o tempo total foi de **30 segundos**.
Toda pesquisa foi anotada [nessa issue](https://github.com/brianc/node-postgres/issues/2718) do reposit√≥rio oficial do m√≥dulo `pg` que usamos.

## Parameter group

Durante os testes eu fiquei usando tamb√©m o `idle_session_timeout` dispon√≠vel no Postgres `14` e funciona que √© uma maravilha... mas n√£o para as nossas condi√ß√µes üòÇ
De qualquer forma, eu implementei isso por dentro do Terraform (e fui aplicando no ambiente) e como modificar o parameter group faz com que o banco precise ser reiniciado, eu optei por j√° deixar isso feito (inclusive em produ√ß√£o) e nos dar a possibilidade de reagir melhor a eventuais problemas ou tuning com o banco nos dois ambientes.
No RDS, modificar o parameter group de um banco faz mandatoriamente que o banco seja reiniciado para que o novo parameter group seja aplicado, mas alterar valores l√° dentro n√£o necessariamente precisa. Alguns precisam, mas no caso do `idle_session_timeout` n√£o precisava e foi **muito** importante ficar modificando e aplicando por c√≥digo esse valor l√° no ambiente.
</pull_215_Volta a usar Pool no Database + Parameter Group no RDS>

<pull_216_Nova estrat√©gia para o Pool>
Para o atual est√°gio do projeto isso n√£o √© necess√°rio, mas implementei algo para testar uma teoria que eu bolei na virada do dia e ver at√© onde eu consigo entender toda a modelagem de um ambiente serverless. O projeto j√° est√° com uma √≥tima performance, fiz testes com a vers√£o que est√° na `main` junto com o @gustavodeschamps que est√° em Blumenau, e a m√©dia de tempo de requests fazendo 3 consultas ao banco ficou em torno de `70ms`. **[edit]** com a nova estrat√©gia ficou abaixo de `50ms`
Mas mais importante que isso, √© a gente conseguir entender as mec√¢nicas reais de um ambiente serverless, que s√£o **bem mais complicadas** que um ambiente tradicional e de longa vida.

### Em resumo

N√≥s n√£o temos controle do que as Lambdas v√£o fazer (quando elas v√£o ser congeladas ou reaquecidas). N√≥s de fato n√£o temos controle sobre isso e a AWS (que est√° por tr√°s da Vercel) pode congelar uma Lambda por qualquer motivo (depois de retornar a request). O que se sabe √© que n√£o h√° requests concorrentes dentro de uma Lambda... √© uma request por vez e √© por isso que a AWS ir√° abrir v√°rias Lambdas para paralelizar as requests.
Ent√£o dado a n√£o sabermos quando uma Lambda ser√° congelada, √© poss√≠vel que um Pool n√£o consiga fechar conex√µes pelo lado dele (encerrar clients que foram devolvidos ao Pool), mesmo que ultrapasse o `idleTimeoutMillis`, porque novamente, ele pode estar congelado e os timers internos (que seriam respons√°veis por perceber que o `idleTimeoutMillis` foi ultrapassado e que os clients deveriam ser fechados), estar√£o congelados. Eles s√≥ possuem uma chance de voltar a rodar, quando uma nova request entrar naquela Lambda... e quando isso acontece, eles rodam de fato e o Pool tem mais uma chance de trabalhar.
O resultado disso √© que se muitas requests em paralelo entram no sistema, a AWS ir√° rodar v√°rias inst√¢ncias da Lambda, criando v√°rios Pools, que ir√£o abrir `1` conex√£o cada e isso poder√° consumir o n√∫mero de conex√µes m√°ximas do banco de dados. O problema se agrava quando as Lambdas que foram abertas podem ser congeladas, segurando consigo essa `1` conex√£o com o banco, sem o Pool ter a chance de encerrar essa conex√£o.
E porque usar um Pool? Porque enquanto o custo de ida e volta de uma query simples fica entre `1ms` e `2ms`, abrir uma nova conex√£o com o banco varia entre `15ms` at√© em alguns casos `150ms`. Ent√£o este hit inicial pode ser custoso, ainda mais se for feito em cada query que uma request possa fazer (pegar sess√£o, renovar sess√£o, pegar usu√°rio, pegar os dados finais, etc...).
E tudo fica pior quando o sistema recebe uma carga muito grande, porque parece que quanto mais tentativas de conex√µes, mais custosas e lentas essas tentativas ficam.
Ent√£o reaproveitar uma conex√£o que j√° foi aberta √© muito legal... mas quando o sistema recebe muita carga, dado a tudo que conversamos das Lambdas congelarem os timers, se voc√™ infinitamente ficar abrindo Pools, eles ir√£o consumir todas as conex√µes do sistema e nenhuma nova request que entrar vai ser resolvida.
E esse PR n√£o resolve esse problema de descongelar Lambdas ou fechar conex√µes... mas a estrat√©gia agora √© verificar quantas conex√µes podem ser de fato utilizadas, quantas conex√µes est√£o abertas, e se as conex√µes abertas ultrapassarem um limite (que por enquanto vou testar, mas est√° em 70%), dentro do lifecycle dessa mesma request e antes dela ser retornada ao cliente e a Lambda congelada, ela resolve fechar o Pool e as conex√µes.

### Resumo do resumo

Se uma request saud√°vel, que possui um Pool com um cliente saud√°vel, notar que o sistema est√° com muitas conex√µes abertas, ele fecha o Pool dessa atual request para n√£o ficar aumentando a quantidade de clientes congelados. Ent√£o ele "auto imp√µe" uma degrada√ß√£o dos recursos do sistema para n√£o chegar nos limites e entrar num estado irrecuper√°vel porque todas as conex√µes abertas est√£o em Lambdas congeladas.

### N√£o testei ainda

N√£o sei se a minha modelagem est√° certa ou se vai ter algum efeito... ent√£o esse PR √© para isso e eu venho aqui depois editar e confirmar o que aconteceu.

**[edit]**
Os primeiros testes se sa√≠ram muito bem, ne sentido da l√≥gica pelo menos. Com uma carga que antes fazia todas as conex√µes serem consumidas malucamente, agora n√£o, ele segura e mantem o banco sau√°vel. Isso por si s√≥ √© √≥timo, porque em condi√ß√µes normais, o Pool reaproveita a conex√£o e as requests n√£o tem o primeiro hit. Em breve quero postar comparativos para ver se isso traz resultados reais nos n√∫meros totais ü§ù
</pull_216_Nova estrat√©gia para o Pool>

<pull_244_Change activate route to post method>
Este Pull Request √© relacionado a Issue https://github.com/filipedeschamps/tabnews.com.br/issues/224
Foi feita a altera√ß√£o do m√©todo do endpoint de GET para POST e esse endpoint passa a ser idempotente sempre retornando o objeto do Token sem o user_id.
Al√©m disso foi alterado tamb√©m a vari√°vel 'activate' para 'activation' para manter o padr√£o - Um questionamento: Ser√° que n√£o dev√≠amos mudar tamb√©m url de ativa√ß√£o para '/activation' e passar o id do token no body e n√£o mais na URL??
</pull_244_Change activate route to post method>

---

<pull*245*#229 - feat(user): sign up page>
E ai, pessoal! Essa √© a minha primeira contribui√ß√£o aqui no TabNews.
Este pull request √© relacionado a issue #229 - user(page): cria√ß√£o de usu√°rios.
Seguindo sugest√£o do Filipe, ficou no endere√ßo `/cadastro`.
Conforme discuss√£o na issue, foi utilizado o fetch para realiza√ß√£o da chamada √† api.
No layout, utilizei como refer√™ncia as p√°ginas de [home](https://www.tabnews.com.br/pocs/home-08) e [post](https://www.tabnews.com.br/pocs/post-01).
Para feedback do usu√°rio est√£o sendo utilizadas as mensagens retornadas pela api nos campos `message` e `action`.
Al√©m disso, existem as valida√ß√µes nos inputs (apenas as valida√ß√µes simples e puras do html) e, caso esteja faltando o preenchimento de algum campo, tamb√©m haver√° feedback na tela para o usu√°rio.
Caso a cria√ß√£o do usu√°rio seja bem sucedida, tomei a liberdade de criar uma p√°gina /cadastro/confirmar, a qual o usu√°rio ser√° redirecionado.
Essa p√°gina √© respons√°vel por prover ao usu√°rio um feedback e informar que ele deve confirmar o cadastro a partir do link enviado para o e-mail. A mensagem √© a seguinte:
"Cadastro realizado com sucesso!
Confira seu e-mail: {email}
Inclusive a Caixa de Spam, para ativar e confirmar sua inscri√ß√£o."
Pra deixar a experi√™ncia mais legal, tamb√©m coloquei para renderizar o Confetti (mesmo da tela inicial do TabNews).
</pull*245*#229 - feat(user): sign up page>

---

<pull*247*#229 - feat(user): sign up page (#245)>
Merge para deploy da Vercel e rodar os testes do PR #245 feito por @ygorthiago
</pull*247*#229 - feat(user): sign up page (#245)>

---

<pull_248_chore(scripts): remove `download-collaborators-avatar`>
O script que est√° sendo removido nesse PR teve uma participa√ß√£o hist√≥rica no projeto e foi respons√°vel por baixar todos os avatares que comp√µe a atual home. Por√©m dado a caracter√≠stica dessa home que √© n√£o mexer mais nela, esse script n√£o ser√° mais usado, por√©m por ter seu pr√≥prio `package.json` e por ficar desatualizado, a todo momento o Github aponta por pacotes desatualizados e com falhas de seguran√ßa conhecidas:
Isso n√£o afeta diretamente o projeto, mas √© uma parte que n√£o tem mais uso e hoje est√° gerando falsos alarmes (o que pode dessensibilizar alarmes verdadeiros).
Ent√£o estou removendo o script por completo e qualquer arrependimento, basta recuperarmos atrav√©s do hist√≥rico do git.
</pull_248_chore(scripts): remove `download-collaborators-avatar`>

<pull_250_build: update dependencies>
Tarefa recorrente de atualizar as depend√™ncias.
Talvez o destaque mais importante √© a atualiza√ß√£o para o React 18.
@andrefd17 ta chegando a hora de pensarmos em usar o [Playright](https://playwright.dev/) para testes E2E, principalmente l√° nos casos de uso, testando o fluxo de cadastro e login. Inclusive a falta disso j√° vai fazer o `registration-flow` ficar menos confi√°vel porque n√£o vamos usar a p√°gina de ativa√ß√£o que est√° de fato ativando o usu√°rio, vamos bater por fora na API manualmente (e n√£o √© isso que o usu√°rio vai fazer).
</pull_250_build: update dependencies>

<pull_251_Novo fluxo de ativa√ß√£o>
Vamos tentar resolver nesse PR toda altera√ß√£o no fluxo de ativa√ß√£o.
Ent√£o isso vai envolver as contribui√ß√µes dos seguintes PR (e outros commits adicionais):

- #242 @MiguelMachado-dev
- #243 @vitoropereira
- #244 @inovaprog
  **[edit]:** os commits de todos os PRs acima (mesmo os PRs que foram fechados), foram `merged` nessa nova branch `new-activation`. Agora vou fazer o restante dos ajustes, incluindo voltar a fazer os testes passarem dado que a URL mudou, e ao menos nesse PR aqui n√£o vamos fazer E2E usando o Playwright üëç
  Closes #224
  Closes #225
  Closes #227
  </pull_251_Novo fluxo de ativa√ß√£o>

<pull_254_feat: add `/museu` page>
Adiciona a p√°gina do Museu TabNews. Estamos discutindo sobre essa p√°gina na issue: #231
Resultado:
</pull_254_feat: add `/museu` page>

<pull_257_Enviar email para usu√°rios n√£o ativados que tentarem logar>
Como esqueci de reverter as altera√ß√µes no arquivo dentro de models estou enviando esse novo pull request e fechando o antigo....
...
Esse pull request tem objetivo de atender a issue #226
Envia email para usu√°rio no caso de usu√°rio que tente fazer login com a conta ainda n√£o ativada
Se o usu√°rio foi ativado (n√£o tem mais 'read:activation_token') e perdeu a feature 'create:session' (foi bloqueado ou qualquer outro motivo) ele continua apenas recebendo o 403 e n√£o recebe email.
Atualiza os testes para essas duas condi√ß√µes.
Remove a linha 1 de 'models/activation.js' : o uuid.v4 n√£o estava sendo usado nessa pagina
Estou a disposi√ß√£o para qualquer altera√ß√£o e sugest√£o.
</pull_257_Enviar email para usu√°rios n√£o ativados que tentarem logar>

<pull_258_Recupera√ß√£o de conta - Email de ativa√ß√£o>
PR intermedi√°rio para rodar os checks do PR original #257 feito por @inovaprog
</pull_258_Recupera√ß√£o de conta - Email de ativa√ß√£o>

<pull_259_P√°gina de Login>
Para completar a issue #252 e conseguir enviar o email para as pessoas que tiveram problema no passado ao receber o email de ativa√ß√£o, implementei a p√°gina de login (`/login`) que √© uma c√≥pia total da p√°gina de cadastro (`/cadastro`) criada por @ygorthiago
Ent√£o a instru√ß√£o que vou mandar por email para as pessoas com o problema de ativa√ß√£o √© acessar essa nova p√°gina e tentar fazer o login e isso vai fazer o sistema disparar um novo email com um novo token de ativa√ß√£o, conforme implementa√ß√£o feita por @inovaprog

---

Dentro desse PR tamb√©m tem uma pequena sincroniza√ß√£o de texto entre a p√°gina de login e cadastro, especificamente nos `placeholders` dos campos, e tamb√©m no destaque da mensagem de erro principal.
Closes #252
</pull_259_P√°gina de Login>

<pull_260_init.html:merging into a single file>
Conforme descrito na Inssue #231 unifiquei toda HOME em um √∫nico arquivo html. Para conseguir reduzir um pouco o tamanho do arquivo, atualizei todas imagens para WebP.
</pull_260_init.html:merging into a single file>

<pull_261_Adiciona sistema de logs>
Em rela√ß√£o a tarefa #238 por enquanto o [Logflare](https://logflare.app/) foi o servi√ßo que mais gostei, por ser **extremamente** simples e r√°pido. Ele √© realmente muito r√°pido, faz o parse dos logs de lambda da Vercel e oferece alertas. O parse que ele faz inclusive nenhum outro provider fez de forma autom√°tica, que √© sobre quanto tempo foi que durou a execu√ß√£o da Lambda. E eles pegam todo o `drain`, tudo, inclusive acesso a p√°ginas est√°ticas.
Ent√£o agora com tudo isso d√° para logar com tranquilidade a entrada de todas requests e casar com o retorno dos erros que um usu√°rio possa estar tomando. Ent√£o refatorei onde que o `requestId` fica (e agora fica dentro do `context` do objeto `request`, junto com o objeto de `user` e `session` caso o usu√°rio esteja logado).
E fazer um parse ainda melhor disso, eles sugerem usar o [PinoJS](https://github.com/pinojs/pino), ent√£o esse PR √© sobre a implementa√ß√£o de um novo m√≥dulo chamado `logger` que fica em `/infra/logger.js` e que abstrai esse PinoJS e com isso foi poss√≠vel melhorar algumas coisas nos nossos logs, como por exemplo esconder **dados sens√≠veis** e trocar eles pela string **[Redacted]**. Por exemplo:

### No ato de criar um novo usu√°rio

```js
// `POST` `/users`
      "body": {
        "username": "usuarioteste",
        "email": "[Redacted]",
        "password": "[Redacted]"
      }
```

### No ato de fazer login

```js
// `POST` `/sessions`
      "body": {
        "email": "[Redacted]",
        "password": "[Redacted]"
      }
```

### Usu√°rio autenticado fazendo requests

Note que dados sens√≠veis s√£o redacted, como `cookie` que tem o token de sess√£o, e tudo de sens√≠vel de dentro do `context`.

```js
"accept-language": "en,pt;q=0.9",
¬† ¬† ¬† ¬† "cookie": "[Redacted]"
¬† ¬† ¬† },
¬† ¬† ¬† "query": {},
¬† ¬† ¬† "context": {
¬† ¬† ¬† ¬† "requestId": "786a34f4-7315-414e-9315-533668cf25dd",
¬† ¬† ¬† ¬† "user": {
¬† ¬† ¬† ¬† ¬† "id": "f091be54-92e5-4350-ab78-d873d0b8d1b0",
¬† ¬† ¬† ¬† ¬† "username": "filipedeschamps",
¬† ¬† ¬† ¬† ¬† "email": "[Redacted]",
¬† ¬† ¬† ¬† ¬† "password": "[Redacted]",
¬† ¬† ¬† ¬† ¬† "features": [
¬† ¬† ¬† ¬† ¬† ¬† "create:session",
¬† ¬† ¬† ¬† ¬† ¬† "read:session",
¬† ¬† ¬† ¬† ¬† ¬† "create:post",
¬† ¬† ¬† ¬† ¬† ¬† "create:comment",
¬† ¬† ¬† ¬† ¬† ¬† "update:user"
¬† ¬† ¬† ¬† ¬† ],
¬† ¬† ¬† ¬† ¬† "created_at": "2022-04-08T21:03:35.453Z",
¬† ¬† ¬† ¬† ¬† "updated_at": "2022-04-08T21:04:41.769Z"
¬† ¬† ¬† ¬† },
¬† ¬† ¬† ¬† "session": {
¬† ¬† ¬† ¬† ¬† "id": "662ea8f5-23cf-4329-ac71-dd443561476a",
¬† ¬† ¬† ¬† ¬† "token": "[Redacted]",
¬† ¬† ¬† ¬† ¬† "user_id": "f091be54-92e5-4350-ab78-d873d0b8d1b0",
¬† ¬† ¬† ¬† ¬† "expires_at": "2022-05-08T21:07:02.905Z",
¬† ¬† ¬† ¬† ¬† "created_at": "2022-04-08T21:06:13.873Z",
¬† ¬† ¬† ¬† ¬† "updated_at": "2022-04-08T21:07:02.905Z"
¬† ¬† ¬† ¬† }
¬† ¬† ¬† },
```

A lista das chaves a serem redacted √© centralizada e controlada pelo pr√≥prio `logger.js` e pode ser facilmente modificada (e suporta match de objetos dentro de arrays tamb√©m):

```js
  redact: [
    'headers.cookie',
    'password',
    'email',
    'body.password',
    'body.email',
    'context.user.password',
    'context.user.email',
    'context.session.token',
  ],
```

## Princ√≠pio usado

O princ√≠pio que usei foi: mesmo que os logs vazem de alguma forma, **nenhum usu√°rio ser√° comprometido**, e ao mesmo tempo temos as informa√ß√µes necess√°rias para debuggar qualquer coisa e criar alertas.

## Modo desenvolvimento

J√° em modo desenvolvimento fiz duas coisas diferentes:

1. N√£o logar a entrada de todas as requests, porque isso polui muito o desenvolvimento. Mas caso queira ver esse log, basta iniciar o Next dessa forma:

```
LOG_LEVEL=info npm run dev
```

2. Os logs em desenvolvimento passam por uma transforma√ß√£o e s√£o logados de forma bonita, isso √© feito por um outro m√≥dulo chamado [pino-pretty](https://www.npmjs.com/package/pino-pretty). Ent√£o o resultado fica assim:

### Log interno da entrada de uma request contra o `/users`

### Mas o usu√°rio tomou um erro `503`

Esse √© o log interno, pois a resposta para o usu√°rio n√£o vem com a `stack`:

### E outro log interno mostrando de fato o que aconteceu (migrations n√£o tinham sido rodadas):

E que pode ter sido achado pelo `errorId` por exemplo:

---

Em paralelo, vou fazer alguns testes mandando estourar de prop√≥sito alguns erros.
</pull_261_Adiciona sistema de logs>

---

<pull*262_feat(contents): [Draft] creates migrations for content entity>
Esse pull request come√ßa a atender a **Issue #230** / **#233** (\_S√≥ come√ßa mesmo, falta muito!!*)
Esse √© um rascunho do rascunho de uma migra√ß√£o para a nova entidade de 'conte√∫dos'. Eu n√£o estava no come√ßo e n√£o sei se usaram algum framework para gerar os migrations. Mas fui seguindo o padr√£o do que j√° estava pronto.
Os valores para as quantidades de caracteres em cada coluna eu realmente fiquei sem refer√™ncia e coloquei valores que provavelmente vamos alterar.
A forma de fazer o 'slug' e o 'title' serem n√£o nulos **apenas quando n√£o existe um 'parent_id'** tamb√©m n√£o sei se √© a melhor forma de fazer e nem a forma mais bonita e tamb√©m n√£o sei se o correto seria um arquivo separado para essa verifica√ß√£o.
De toda forma tentei colocar uma semente e talvez a partir da√≠ a gente pode ter novas ideias e modificar tudo se achar que √© necess√°rio,

> > Review de filipedeschamps (CHANGES_REQUESTED):
> > @inovaprog estamos pr√≥ximos de fazer o merge da migration, mas pe√ßo que veja antes meus coment√°rios ü§ù
> > Review de inovaprog (COMMENTED):
> > Review de inovaprog (COMMENTED):
> > Review de inovaprog (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Usando o Github como refer√™ncia, encontrei isso: https://github.community/t/maximum-length-for-the-comment-body-in-issues-and-pr/148867/2
> > PR body/Issue comments are still stored in MySQL as a mediumblob with a maximum value length of 262,144. This equals a limit of 65,536 4-byte unicode characters.
> > Como outra refer√™ncia, peguei um artigo bem longo do Medium e ele deu ~10k caracteres. O que acha de definirmos um tamanho m√°ximo de 20 mil caracteres?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Usando Github como refer√™ncia, eles colocam 256 como tamanho m√°ximo.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Pesquisei bastante coisa sobre tamanho de URL m√°ximo e achei essa resposta: https://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers
> > Em resumo, pelo protocolo n√£o h√° limite oficial, mas pelos clients/proxy/servers cada um tem o seu.
> > Mas o que acha de deixamos em **2000**? Isso vai atender a maioria dos casos.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):

## Limite

Usando o WordPress como refer√™ncia (que ele √© o melhor nisso), o limite na tabela √© **200**.
https://wordpress.stackexchange.com/questions/53042/is-there-a-maximum-slug-length

## Constraint √∫nico

E temos que ter algum tipo de uniqueness aqui que n√£o sei muito bem como resolver, porque tem que envolver o `username` junto. Por exemplo:

1. `"filipedeschamps/artigo-js-legal"` - Ok
2. `"inovaprog/artigo-js-legal"` - Ok tamb√©m
3. `"filipedeschamps/artigo-js-legal"` - N√£o ok, o user "filipedeschamps" j√° usou o slug `artigo-js-legal` antes
   Lendo a documenta√ß√£o do Postgres sobre [unique constrains](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS) √© poss√≠vel fazer um constrain unico m√∫ltiplo, por exemplo:

```sql
CREATE TABLE example (
    a integer,
    b integer,
    c integer,
    UNIQUE (a, c)
);
```

Mas novamente, n√£o temos a coluna `username` ali. **Ah mais pera...** a gente pode usar o `author_id` correto? √â at√© melhor, porque `username` √© algo que pode ser alterado.

> > Coment√°rio de filipedeschamps (linha de c√≥digo):

## Constraint de valores aceitos

Podemos usar o [check](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-CHECK-CONSTRAINTS), por exemplo:

```sql
CREATE TABLE contents (
    ...
    status VARCHAR NOT NULL CHECK (status in ('draft', 'published', 'unpublished', 'deleted')
);
```

PS: n√£o testei, n√£o sei se funciona como eu fiz ali.

> > Coment√°rio de inovaprog (linha de c√≥digo):
> > Eu mudei para 2000, mas acho q nao tem como chegar nesse tamanho. Porque a Url √© a combina√ß√£o do dom√≠nio + username + slug (j√° adicionado acima) e acho q n√£o tem como chegar nesse tamanho.
> > Coment√°rio de inovaprog (linha de c√≥digo):
> > Coloquei um VARCHAR 20000, mas n√£o sei se √© a melhor op√ß√£o. talvez tem alguma forma melhor de colocar um campo com um tamanho grande igual esse.
> > Coment√°rio de inovaprog (linha de c√≥digo):
> > Adicionei essa restri√ß√£o tamb√©m e funcionou bem
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Massa!! Pesquisei aqui e o Postgres funciona de uma forma bem maluca e basicamente `varchar` e `text` n√£o tem diferen√ßa alguma de performance, salvo alguns cen√°rios raros, e tudo indica que essa de colocar o `varchar(xxxxx)` √© uma das formas e em s√≥ um ponto √© pior, que √© na hora de precisar modificar esse valor, pois vai precisar de um `ALTER TABLE` e se a tabela tiver muitas linhas, isso pode demorar. Ent√£o o pessoal est√° recomendando colocar uma `CONSTRAINT` de tamanho, porque alterar esse constraint √© instant√¢neo.
> > Eu vou fazer merge do seu PR numa branch aqui dentro do reposit√≥rio e fazer essa implementa√ß√£o ü§ù e tamb√©m vou tentar repassar os constraints l√° de baixo e colocar eles inline em cada coluna, pois ao bater o olho fica f√°cil de ver essas regras üëç
> > </pull_262_feat(contents): [Draft] creates migrations for content entity>

<pull_263_feat(public/museu): unifying poc pages in html only>
Essa PR tem o objetivo de resolver a solicita√ß√£o da Issue #231. Foi criada todas as p√°ginas da POC utilizando a ferramenta SingleFile do chrome.
</pull_263_feat(public/museu): unifying poc pages in html only>

<pull_264_Adiciona novo sistema de valida√ß√£o>
Adiciona novo sistema de valida√ß√£o usando o novo model `/models/validador.js` e que tampa v√°rios buracos que eu n√£o tinha visto antes, remove v√°rias duplicidades e simplifica o uso de valida√ß√£o pelo sistema. A interface p√∫blica dele ta bem simples de usar e basicamente consiste definir o nome das propriedades e se elas s√£o obrigat√≥rias ou opcionais, por exemplo:

### POST `/users`

```js
  // No caso de cria√ß√£o de um novo user, o middleware "postValidationHandler"
  // vai ser chamado antes de tudo, da Autoriza√ß√£o e do "postHandler".
  // Isso √© importante, porque sempre precisamos primeiro proteger
  // a borda do sistema.
  .post(postValidationHandler, authorization.canRequest('create:user'), postHandler);
function postValidationHandler(request, response, next) {
  // Voc√™ deve enviar o "request.body" sujo mesmo, e o
  // validator vai retornar ele limpo se estiver v√°lido.
  // Se n√£o estiver v√°lido, vai dar throw num ValidationError
  const cleanValues = validator(request.body, {
    username: 'required',
    email: 'required',
    password: 'required',
  });
  // Substituir o body sujo pelo novo e limpo.
  request.body = cleanValues;
  next();
}
```

E de gra√ßa a gente ganha prote√ß√µes que antes a gente n√£o tinha:

- Mandar um body em branco, undefined, null
- Mandar um body que n√£o seja um objeto, por exemplo uma string "tentando hackear"
- Precisa ser um JSON v√°lido e parse√°vel.
- No ato desse parser, ele limpa campos como `{ "username": undefined }`
  Se essa parte de cima n√£o estiver v√°lida, o usu√°rio recebe um `ValidationError`.

### PATCH `/users/[username]`

√â a mesma coisa, mas todos os campos s√£o **opcionais**, porque voc√™ n√£o tem a obriga√ß√£o de mandar todos eles como no caso do `POST`, por√©m voc√™ precisa pelo menos enviar na request **1 campo**, caso contr√°rio a valida√ß√£o **vai reclamar** se voc√™ mandar algo como um `{}`

```js
function patchValidationHandler(request, response, next) {
  const cleanValues = validator(request.body, {
    username: "optional",
    email: "optional",
    password: "optional",
  });
  request.body = cleanValues;
  next();
}
```

### GET `/users/[username]`

Em todos os casos de `GET` tinham um furo legal, porque os query parameters n√£o eram validados, mas o Next.js retorna eles como um objeto, ent√£o fica igual ao restante da valida√ß√£o:

```js
  .get(getValidationHandler, getHandler)
// Ent√£o nesse caso ao inv√©s de `request.body` √© `request.query`
function getValidationHandler(request, response, next) {
  const cleanValues = validator(request.query, {
    username: 'required',
  });
  request.query = cleanValues;
  next();
}
```

### Valida√ß√µes complexas

Mais para frente se necess√°rio a gente pode exportar o `schemas` de dentro do `validator` caso algu√©m precise por fora montar alguma outra valida√ß√£o complexa e customizada, e reproveitar todas as valida√ß√µes de cada campo.

### Tasks

Esse PR (ou posso fazer em outros separados), vai criar v√°rios efeitos colaterais pelo sistema inteiro, ent√£o fiz aqui uma listinha pra n√£o esquecer do que preciso fazer pra considerar a issue #236 conclu√≠da:

- [x] Criar m√≥dulo e aplicar nos primeiros casos
- [x] Mover testes para novo padr√£o
- [x] Aplica√ß√£o desse m√≥dulo em todo resto da aplica√ß√£o
- [x] Renomear par√¢metros na resposta para Snake case: "request_id", "error_id" e "error_unique_code" (vou deixar para outro PR)
- [x] Adicionar mais cobertura de testes para cobrir furos anteriores
- [x] Validar Headers (o formato e caracteres aceitos no Cookie de Sess√£o "session_id")
- [x] N√£o relacionado, mas vou deixar anotado aqui para n√£o esquecer: O novo Logger que usa PinoJS est√° sofrendo algum leak, o mesmo [reportado aqui](https://github.com/pinojs/pino/issues/1322)
- [x] Tamb√©m n√£o relacionado, mas importante para seguran√ßa atual: n√£o deixar usu√°rio atualizar email e senha, at√© que seja implementado fluxo de dupla verifica√ß√£o por email.

### Conclus√£o

Valida√ß√£o √© outro assunto que nunca termina, √© sens√≠vel e sempre precisamos ficar tentando hackear nossas pr√≥prias solu√ß√µes, mas de qualquer forma eu j√° sinto que com esse PR o assunto valida√ß√£o subiu pra outro patamar ü§ù üëç
</pull_264_Adiciona novo sistema de valida√ß√£o>

<pull_265_Faz respostas de erro retornarem todas as chaves em `snake_case`>
Isso √© um padr√£o em APIs REST e √© um cuidado que devemos ter em todas as respostas da API.
Numa primeira abordagem que eu fiz (mas deletei a branch) foi de fazer um Find & Replace grosseiro de, por exemplo, todas as refer√™ncias de `errorId` para `error_id`. Funcionou, mas isso alterou tamb√©m objetos internos (que deveriam estar em `lowerCamelCase`, que √© a conven√ß√£o usada em JavaScript).
Ent√£o eu fui nas bordas do sistema (logo antes de fazer algum **log** ou **response**) e usei o modulo [snakeize](https://www.npmjs.com/package/snakeize) para transformar todas as chaves do objeto em `snake_case`.
As p√°ginas de Cadastro e Login tamb√©m foram alteradas, mas por enquanto n√£o temos cobertura. Isso est√° sendo trabalhado na branch [e2e-playwright](https://github.com/filipedeschamps/tabnews.com.br/tree/e2e-playwright) feita por @andrefd17
</pull_265_Faz respostas de erro retornarem todas as chaves em `snake_case`>

<pull_267_Content migration>
PR originalmente criado por @inovaprog
@inovaprog veja se voc√™ concorda com as altera√ß√µes:

## Inline checks

Para correlacionar diretamente a coluna com as regras dele, coloquei uma propriedade `check` com a regra desejada. Ent√£o ao inv√©s de:

```js
    title: {
      type: 'varchar(256)',
    },
```

Que gera esse erro:

```
ERROR:  value too long for type character varying(256)
```

Fazer assim:

```js
    title: {
      type: 'varchar',
      check: 'length(title) <= 256',
    },
```

Que gera um erro por `check` e d√° um nome exclusivo a ele:

```
ERROR:  new row for relation "contents" violates check constraint "contents_title_check"
```

Basicamente igual aos constraints, mas deixando eles inline. E se fizermos tudo certo, esse erro nunca ser√° exposto para o user, pois isso j√° deveria ter sido pego por valida√ß√µes externas. Mas mesmo que fure, a camada que faz o handle disso vai retornar um `503` para o user.

## `slug` e `title` serem `required`

Tava pensando aqui, para cada `content` poder ter seu pr√≥prio link √∫nico e sua pr√≥pria p√°gina (como cada `tweet` do Twitter), n√≥s no m√≠nimo precisamos que todo `content` precise de um `slug`. E no caso de um usu√°rio escrevendo uma resposta (que √© um `content` com `parent_id`) a gente poderia assumir como `slug` o `id` desse content e o title a gente poderia pegar os primeiros `X` caracteres do corpo. Sabendo que se a pessoa quiser, ela pode editar isso (digo, o autor que est√° escrevendo essa resposta pode mudar o valor para esses campos default, assim como um `content` qualquer).

## Primary key

Essa aqui eu n√£o sei, mas √© poss√≠vel definir duas Primary Keys (no caso adicionei como PK o `owner_id`, `slug` e `parent_id`) e isso automaticamente faz o migrator adicionar isso:

```sql
  CONSTRAINT "contents_pkey" PRIMARY KEY ("owner_id", "slug", "parent_id")
```

E se voc√™ n√£o respeitar e duplicar os dados, retorna o seguinte erro:

```
ERROR:  duplicate key value violates unique constraint "contents_pkey"
DETAIL:  Key (owner_id, slug)=(f1f27a63-8a43-4e21-874d-58079ee1198c, artigo-de-nodejs-massa) already exists.
```

Mas da√≠ tirei o Primary Key do `id`. Ser√° que isso √© um problema?

## Conclus√£o do √∫ltimo commit

A ideia era ficar mais simples. Voc√™s acham que foi dado um passo para frente ou para tr√°s?
</pull_267_Content migration>

<pull_268_CRUD de `content` - Primeira vers√£o do `GET`>
Esse PR come√ßa implementando a entidade `content` no sistema, incluindo os helpers no `orchestrator` para criar conte√∫do sem precisar bater na API (assim como fazemos para criar usu√°rios). Por exemplo:

```js
const defaultUser = await orchestrator.createUser();
const content = await orchestrator.createContent({
  owner_id: defaultUser.id,
  title: "Primeiro conte√∫do criado",
});
```

Comecei por isso, porque por enquanto s√≥ implementei o `GET` e queria testar com alguns conte√∫dos de verdade, antes mesmo de implementar o `POST`. Deu para testar v√°rias regras e comportamentos do model em s√≠, o que resultou em algumas lapida√ß√µes.

## Tamanho do Slug

Acabei por mudar que o tamanho do `slug` possa chegar ao mesmo tamanho m√°ximo do `title`. N√£o vejo mais motivo para estes dois serem diferentes.

## `title` n√£o ser mais obrigat√≥rio

Enquanto eu estava cavucando aqui em cen√°rios que um `content` possui um `parent_id` (ou seja, esse conte√∫do √© uma resposta dentro de outro conte√∫do), eu fiz a gera√ß√£o autom√°tica do t√≠tulo com base no in√≠cio do `body`, mas n√£o sei, ficou for√ßado e deixei simplesmente o campo como opcional. Quando a pessoa acessar a p√°gina exclusiva desse content (o link fixo de uma resposta), a interface dever√° esconder o espa√ßo do t√≠tulo caso o objeto retorne sem esse dado... ficando virtualmente como um tweet.

## Validator

N√£o sei se vai dar para entender o que eu vou escrever aqui, mas como o objeto que possui cada pe√ßa da valida√ß√£o est√° 100% flat (`id`, `email`, `parent_id`, etc... tudo no mesmo n√≠vel), haver√° o risco de um dia existir a necessidade de dois campos terem o mesmo nome, mas com valida√ß√µes diferentes. Quando esse dia chegar, √© bem poss√≠vel que precisaremos passar algum contexto para o `validator`, como por exemplo, "estou validando um `user`". Mas deixa esse dia chegar :)

## Limpeza dos campos

Ainda n√£o est√° sendo feita a limpeza dos campos, por exemplo "html escaping" ou se certificar que o que est√° sendo enviado no `body` √© um markdown e que n√£o possui injections (que d√° pra fazer, √© muito massa). E tem que validar isso em todos os campos que fa√ßam sentido por possu√≠rem texto corrido (acho que os principais s√£o `title`, `body` e `source_url`).

## Gera√ß√£o do `slug`

A regra por enquanto √©:

1. Se o usu√°rio manda um `slug`, ele ser√° utilizado.
2. Se n√£o mandar um `slug`, mas possui um `title`, esse `title` ser√° transformado para um `slug`.
3. Se n√£o mandar nem `slug` nem `title` (por exemplo no ato de criar uma resposta), ser√° utilizado um `uuid`.
   E mais para frente caso o usu√°rio queira, ele poder√° atualizar o `slug` com um `PATCH`.

## Estrat√©gias

No model atualmente est√° implementado duas estrat√©gias: `descending` e `ascending`, mas n√£o sei qual a melhor forma de passar isso para o endpoint. Query parameters provavelmente? Eu imagino que sim, porque v√°rios filtros v√£o vir, por exemplo pagina√ß√£o por data.

> > Review de gabrielew (COMMENTED):
> > Review de gabrielew (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de gabrielew (COMMENTED):
> > Coment√°rio de gabrielew (linha de c√≥digo):
> > criar um const para receber as strings de autoriza√ß√£o n√£o seria melhor?
> > algo assim:

```
const content = {
  read: ['list', '...']
}
if(content.read.includes(feature)) {
  ....
}
```

Acredito que a longo prazo a manutenibilidade disso pode ficar complicado!

> > Coment√°rio de gabrielew (linha de c√≥digo):
> > Se o title tiver m√∫ltiplos espa√ßos no meio do texto e n√£o s√≥ in√≠cio/fim o c√≥digo
> > `const generatedSlug = slug(title, {

    trim: true,

});` ir√° resolver isso tamb√©m?

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Show meu caro, √≥tima observa√ß√£o! Esse assunto j√° foi e voltou algumas vezes em issues passadas e por enquanto nos momentos que foi preciso refatorar, pelo fato de ser uma string simples ficou bem simples fazer um "find & replace" grosseiro pelo sistema inteiro (porque a exata mesma string √© usada em controllers, models, onde precisar). Dessa forma sugerida por voc√™, tem computa√ß√£o envolvida para meio que formar a chave de valida√ß√£o final, o que na verdade talvez dificulte refatora√ß√£o quando necess√°rio.
> > Outro ponto √© que a `feature` recebida ali deveria tamb√©m ser uma string diferente, correto? Dado que, por exemplo num controller, n√£o vai ser mais poss√≠vel enviar `"read:content:list"`, e preciso enviar s√≥ `"list"` para dar match no seu exemplo, mas como conseguir fazer cair no contexto correto (que √© `read` `content`)?
> > De qualquer forma, sugiro manter o escopo desse PR para o CRUD do `content`, mas sugiro total abrir uma outra issue ou at√© PR sugerindo uma refatora√ß√£o de exemplo (que envolva o autorizador e quem utiliza ele) ü§ù
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > √ìtimo!! Testei aqui sua sugest√£o e aconteceu o seguinte:

### T√≠tulo enviado

```
Teste de muitos      espa√ßos    como ser√° que     fica o    slug??
```

### Slug gerado

```
teste-de-muitos-espacos-como-sera-que-fica-o-slug
```

> > Coment√°rio de gabrielew (linha de c√≥digo):
> > massa!
> > </pull_268_CRUD de `content` - Primeira vers√£o do `GET`>

---

<pull*269*`content`: implementa primeira vers√£o do `POST`>
Essa √© a primeira vers√£o da interface p√∫blica para criar conte√∫dos, tanto conte√∫dos "raiz" (root) quanto "coment√°rios" (child).

## Features para criar conte√∫do

Para termos um controle melhor de **quem** pode criar ou n√£o conte√∫dos, que **tipos** de conte√∫dos e tamb√©m estarmos melhor posicionados sobre outros **futuros** tipos de conte√∫dos, vamos precisar depreciar as features `create:post` e `create:comment`. Elas n√£o se encaixam mais no que entendemos por "conte√∫do" dentro do site.
Ent√£o a proposta come√ßa com uma nova feature `create:content` e ela ser√° usada na valida√ß√£o inicial do controller `POST /api/v1/contents`. Sem essa feature, o controller n√£o vai dar a chance de testar as outras valida√ß√µes mais refinadas que acontecem quando se trata de um conte√∫do "root" ou "child".
Essas valida√ß√µes refinadas √© que precisam escalar bem, ent√£o √© bom pensarmos num modelo que comporte qualquer tipo de conte√∫do daqui para frente e que possa ser usada como uma escada de evolu√ß√£o do usu√°rio dentro do sistema, come√ßando com um usu√°rio sem muitas features, at√© features mais avan√ßadas.
Por exemplo (e isso √© uma sugest√£o inicial):

- `create:content`: valida√ß√£o inicial e global.
- `create:content:text_root`: conte√∫dos do tipo **texto** e que ser√£o listados na **raiz** (Home) do site. Isso √© o que atualmente entendemos como um **post** (artigo, not√≠cia, pergunta, tutorial, etc) e tudo que possa ser representado por texto.
- `create:content:text_child`: a mesma coisa, mas para conte√∫dos como "respostas". Ent√£o conte√∫dos podem estar dentro de outros conte√∫dos, inclu√≠ndo conte√∫dos que j√° s√£o filhos de outros conte√∫dos.
  E da√≠ mais para frente isso pode nos liberar para criar permiss√µes como:

- `create:content:poll_root`:¬†criar conte√∫dos do tipo enquete.
- `create:content:image`: conseguir fazer upload de imagens para os nossos servidores.
  √â muito importante deixarmos features como de upload de imagens indispon√≠veis de in√≠cio (para um usu√°rio que acabou de criar a conta), ou at√© de criar conte√∫dos diretamente na raiz do site, para evitar abusos. Ent√£o dependendo da Fase em que o projeto estiver, a pessoa vai precisar conquistar essas features e isso deveria ir acontecendo automaticamente com o ganho de XP (ou outro modelo) que comentamos em issues passadas.

## Fase Beta (essa em que voc√™s est√£o no momento)

Todos v√£o receber por padr√£o todas as features de cria√ß√£o de conte√∫do: `create:content`, `create:content:text_root` e `create:content:text_child`.

## Fase Stable (quando estivermos "prontos" para divulgar)

Todos v√£o receber `create:content`, por√©m al√©m disso, usu√°rios criados nessa fase somente receber√£o o `create:content:text_child` para evitar abusos na Home.

## Impacto nos usu√°rios que j√° criaram a conta no passado

Vamos precisar rodar algumas queries para atualizar na m√£o os users j√° criados.

## Testes e valida√ß√µes

N√£o fiz todos os testes de valida√ß√µes dos campos (queria primeiro testar as regras de neg√≥cio), mas algo bom e estranho j√° aconteceu, que √© pelo fato da entidade `content` ser usada para "posts" (root contents) e "coment√°rios" (child contents)... ent√£o quando eu testei algumas coisas do "root", estes testes j√° valiam para o "child".
Ent√£o se notar na lista de testes abaixo para o **Default user**, eles come√ßam de forma gen√©rica (para quando vale para os dois casos) e quando √© um comportamento espec√≠fico que muda caso seja um tipo ou outro, eu anotei os testes com `"root"` ou `"child"`.
Mas √© isso, grande parte da l√≥gica est√° testada (pode estar faltando outras combina√ß√µes que n√£o percebi) e fora isso falta testar as valida√ß√µes sint√©ticas dos campos (enviando valores menores/maiores ou inv√°lidos).

## Queries mostrinhas

Nos primeiros commits as queries de `INSERT` eram t√£o simples, mas tive que usar o `WITH` para conseguir responder o `username` preenchido e que est√° em outra tabela, a tabela `users`. Se n√£o, s√≥ seria poss√≠vel responder com o `owner_id`. Ta feito, mas n√£o sei se foi a melhor abordagem e qualquer ajuda nessa parte √© bem vinda ü§ù

## P√≥s-cr√©ditos do PR üòÇ

N√£o sou o maior f√£ do nome atual da feature sobre os conte√∫dos. Qualquer sugest√£o vai ser super bem vinda!!
</pull*269*`content`: implementa primeira vers√£o do `POST`>

---

<pull*272*`content`: implementa primeira vers√£o do `PATCH`>
Esse PR implementa a possibilidade de atualizar conte√∫dos pela API. A quantidade de combina√ß√µes da interface p√∫blica desse endpoint me surpreendeu, incluindo detalhes como: n√£o deixar que um conte√∫do seja atualizado com `parent_id` que **aponte para ele mesmo**. Isso e v√°rias coisas legais eu consegui visualizar fazendo um "sparring" com os testes:
E com certeza devem ter muitas outras condi√ß√µes, uma que por exemplo impactou numa implementa√ß√£o nesse PR mas que vai ser finalizada em outro que √© sobre o `DELETE` de conte√∫dos. Eu pessoalmente n√£o estou muito feliz, mas nessa vers√£o ao deletar um conte√∫do, ao inv√©s dele ter o status alterado para `deleted`, vamos precisar de fato deletar a linha. O motivo √© que se n√£o deletarmos, o `slug` desse conte√∫do `deleted` pode come√ßar a dar conflito com outros conte√∫dos que o usu√°rio esteja tentando criar em `draft` e `published`.
Eu tinha inclusive programado tudo relacionado a isso, de n√£o poder postar conte√∫dos diretamente com status `deleted`, de uma vez em status `deleted` n√£o poder mais voltar para outro status, etc. mas depois que me dei conta do conflito de `slug` e que o nosso banco inteiro hoje est√° num modo **mut√°vel**, assumi que o `DELETE` vai ser a solu√ß√£o cab√≠vel para o atual est√°gio. E caso algum dado muito importante seja perdido, tanto por `UPDATE` ou `DELETE`, a gente pode recuperar nos backups ou logs.
E mais para frente podemos fazer um grande refactor para que o banco de dados seja apenas `INSERT ONLY`. Seria bem show estudar sobre isso üëç (mas n√£o agora).
</pull*272*`content`: implementa primeira vers√£o do `PATCH`>

---

<pull*275*`content`: Implementa quase todos os endpoints `GET`>
Esse PR finaliza a bateria de CRUD do `content` (deixando para outra hora o `D`) e traz uma refatora√ß√£o fundamental no model.

## Endpoints

Agora √© poss√≠vel listar os conte√∫dos da seguinte forma:

1. `/api/v1/contents`
2. `/api/v1/contents/[username]`
3. `/api/v1/contents/[username]/[slug]`

**[edit]**
Lembrei que precisa de algo para pegar a √°rvore dos conte√∫dos filho de um conte√∫do, como por exemplo: 4. `/api/v1/contents/[username]/[slug]/childs`

## M√©doto `findAll()`

Tanto nesse model quanto em todos os outros, para cada condicional no `WHERE` que era necess√°rio, era implementado um novo m√©todo. Usando como exemplo a vers√£o na `main` do model `content`, existem os seguintes m√©todos:

- `findAll()`: buscar todos os conte√∫dos de todos os usu√°rios, dado a uma estrat√©gia (`ascending` ou `descending`). E dentro de cada estrat√©gia, era duplicada a query, mesmo que a √∫nica diferen√ßa entre elas era o `ASC` ou `DESC`.
- `findOneById()`: query normal por `id`.
- `findOneByUserIdAndSlug()`: tamb√©m query normal, por `id` e `slug`
- `findOneByUsernameAndSlug()`: novamente, query normal, mas por `username` e `slug`
  O model mal existiu e j√° tinha **muita** query duplicada. Fora que ele estava exponto grande parte desses m√©todos na interface p√∫blica.
  Ent√£o o que eu fiz nesse PR foi:

- Antigo `findAll()` foi renomeado para `findWithStrategy()`, e dentro das estrat√©gias eu usei o novo `findAll()`.
- Novo `findAll()`: de fato faz algo que esse m√©todo representa (de encontrar tudo em `content`) e voc√™ pode passar um `where` para ele, por exemplo:

  ```js
  const contendFound = await content.findAll({
    where: {
      username: request.query.username,
      parent_id: null,
      status: "published",
    },
    order: "created_at ASC",
  });
  ```

  Interessante notar que o `username` n√£o existe na tabela `content`, mas o model d√° um jeito.

- `findOne()`: √© s√≥ uma abstra√ß√£o do `findAll()` que retorna o objeto direto, ao inv√©s de um array.

## Testes

Ter a cobertura boa de testes √© muito bom e d√° muita seguran√ßa pra alterar qualquer coisa e em qualquer lugar.¬†Ali√°s, eu acho que eu n√£o teria energia mental em fazer essa refatora√ß√£o grosseira, se n√£o fossem os testes me falando o que est√° acontecendo e se tudo est√° se comportando como antes.
E chegamos a **200** testes de integra√ß√£o ü§ù
\*Curioso pra saber quando que isso vai come√ßar a morder a nossa bunda üòÇ

> > Review de filipedeschamps (COMMENTED):
> > Preciso fazer duas altera√ß√µes simples üëç
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Preciso mudar esse `errorUniqueCode`
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Preciso mudar esse `errorUniqueCode`
> > </pull*275*`content`: Implementa quase todos os endpoints `GET`>

---

<pull_276_feat(package.json kill-port): adding a kill-port>
Conforme informado na Inssue #274 encontrei uma solu√ß√£o (**[kill-port](https://www.npmjs.com/package/kill-port)**) para garantir que antes de iniciar os servi√ßos a porta 3000 fique liberada para utiliza√ß√£o.
@filipedeschamps no exemplo da #274 tinha utilizando o npx, aqui na PR estou colocando como padr√£o no npm do projeto para n√£o depender de instala√ß√£o global na maquina do usu√°rio, veja o que acha melhor e me avise.
https://www.freecodecamp.org/portuguese/news/npm-x-npx-qual-e-a-diferenca/

> > Review de jaovictorlima (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de rodrigoKulb (COMMENTED):
> > Coment√°rio de jaovictorlima (linha de c√≥digo):
> > @rodrigoKulb n√£o seria melhor colocar kill-port em devDependencies?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > @jaovictorlima excelente ponto! E tamb√©m sugiro tirar o `^` para reduzir a quantidade de surpresas com as depend√™ncias üëç
> > Coment√°rio de rodrigoKulb (linha de c√≥digo):
> > Perfeito ponto @jaovictorlima, vou atualizar aqui!
> > </pull_276_feat(package.json kill-port): adding a kill-port>

---

<pull*277*`content`: m√©todo e endpoint para listar conte√∫dos filho>
Essa implementa√ß√£o foi **muito massa** fazer e agora acredito ter finalizado todos os m√©todos e endpoint para conseguirmos nos focar apenas no Frontend daqui pra frente üëç
Em resumo, o fluxo do que acontece para pegar conte√∫dos filho √© o seguinte:

1. `GET` em `/api/v1/contents/[username]/[slug]/children`
2. Faz as valida√ß√µes tradicionais de entrada.
3. Tenta encontrar o `username` e um conte√∫do com `slug` enviado na URL.
4. Se encontrou, chama o **novo m√©todo** `findChildren()` do model `content` passando como `parent_id` o `id` do conte√∫do raiz que foi encontrado anteriormente, por exemplo:

```js
const childrenFound = await content.findChildren({
  where: {
    parent_id: contentFound.id,
  },
});
```

5. Esse m√©todo faz uma query recursiva no Postgres e retorna todos os conte√∫dos filho desse `parent_id`, inclusive os conte√∫dos filhos desses conte√∫dos filhos... recursivamente at√© n√£o ter mais filhos a serem encontrados.
6. Essa query retorna uma lista flat, que √© transformada numa √°rvore pela fun√ß√£o `flatListToTree()` (isso ainda dentro do model `content`).
7. Isso √© retornado para o controller em quest√£o, e antes de retornar o resultado ao usu√°rio, os dados passam pelo filtro de output.
8. Como a profundidade da √°rvore de filhos pode ser vari√°vel, n√£o d√° para fazer um filtro flat como estava sendo feito para as outras situa√ß√µes, ent√£o √© feita uma valida√ß√£o recursiva (administrada pelo pr√≥prio Joi) onde eu defino o que √© um `content` e se ele possui `children` que √© um array de outros `content`s, a valida√ß√£o √© continuamente aplicada. Tudo isso abstra√≠do no `validator` e na interface p√∫blica basta passar `content` como chave.
   Com isso, nos podemos usar o `validator` (a gente j√° podia antes na verdade), para n√£o somente filtrar os dados de sa√≠da, mas tamb√©m para **validar** que eles est√£o no formato correto. Isso √© interessante, pois as vezes algu√©m pode dar um jeito de corromper a query e conseguir retornar dados malucos do banco de dados dentro de uma propriedade que j√° existe, como `username` (por exemplo conseguir retornar todos os campos do user, incluindo password, dentro do `username`), mas se isso passar pelo `validator` ele vai parar o retorno e estourar um `400`, porque nesse caso o `username` possui um formato mais travado e n√£o vai aceitar qualquer coisa).
   Isso n√£o foi implementado (de usar o `validator` no filtro de sa√≠da), mas deveria para garantir que, se estiver saindo algo, est√° no formato correto.

## Resultado

`GET /api/v1/contents/filipedeschamps/artigo-nodejs/children`

```json
[
  {
    "id": "32de7d8f-d5df-4059-9d71-8aa17dcc0a26",
    "owner_id": "7e8d7d4d-a8b9-4c07-b3b4-db5db2116885",
    "parent_id": "f076c331-92c6-47f3-be23-6f5d962d7eef",
    "slug": "child-branch-a-level-1",
    "title": "Child branch A [Level 1]",
    "body": "Ea voluptas qui quaerat temporibus rerum. Animi et et. Impedit et aut deleniti eaque soluta ad fuga fugiat et. Iusto et repellat nesciunt porro doloribus. Optio neque qui odio impedit. Est et voluptas ipsa blanditiis voluptate quas voluptas.\n \rSit voluptatem quaerat at. Nobis reprehenderit perferendis odit voluptas est aut repudiandae maxime. Suscipit eum ut earum dolores. Omnis dolor ut deleniti eum temporibus mollitia. Enim aut excepturi debitis nisi. Dolorum et pariatur voluptatem molestiae et.\n \rOdit et minima in aut. Nobis exercitationem consequatur. Ipsa quia deleniti in repellat perspiciatis. Molestiae ullam quo esse vel quae maiores voluptas quaerat est. Aspernatur non blanditiis libero.\n \rQui pariatur distinctio. Quo itaque nobis sed rerum. Laudantium quam pariatur quia at.\n \rHic earum est. Magnam officia nobis labore commodi. Deserunt dolor expedita nihil dignissimos corrupti velit non. Blanditiis sint assumenda est consequatur eius et et excepturi cumque. Quis est rerum mollitia earum accusamus rerum maxime et modi. Non officiis velit omnis aut est a.",
    "status": "published",
    "source_url": null,
    "created_at": "2022-04-25T18:19:40.302Z",
    "updated_at": "2022-04-25T18:19:40.302Z",
    "published_at": "2022-04-25T18:19:40.297Z",
    "username": "Jarred84",
    "children": [
      {
        "id": "f27e7b2e-6544-43c8-b4a2-574983996248",
        "owner_id": "7e8d7d4d-a8b9-4c07-b3b4-db5db2116885",
        "parent_id": "32de7d8f-d5df-4059-9d71-8aa17dcc0a26",
        "slug": "child-branch-a-level-2",
        "title": "Child branch A [Level 2]",
        "body": "Voluptates quia nulla eos rerum enim. Sapiente et ratione minus vero ipsam ipsa facere. Eligendi dolor sunt beatae ut qui.\n \rQuas id qui maxime consequuntur officiis incidunt. Eos quia necessitatibus nobis. Est mollitia perferendis rem aut placeat minus. Corrupti dolorem est cum sit rem laudantium. Dolorum sequi ut est. Nesciunt omnis dolor omnis et quis quibusdam nam.\n \rVoluptatem voluptas et. Ipsum et laboriosam dolores sed dolor. Numquam quis eum dolorum sit. Quia veniam dicta id minus sed eos voluptatem. Ex aliquam autem ea sed et ipsum voluptatum. Fugiat eveniet veniam error.\n \rAnimi maxime earum vitae ut fuga dolores magni. Amet voluptates quam sint odio. Consequatur et dolor alias sapiente nobis voluptatem dolorem consequatur. Ullam eos voluptate iure. Ratione repellat est et tempora eum delectus. Delectus odio in odio.\n \rTemporibus sit quis cum quia quo. Iste deleniti totam doloremque eligendi explicabo excepturi molestiae qui. Sit excepturi illum pariatur rerum necessitatibus totam.",
        "status": "published",
        "source_url": null,
        "created_at": "2022-04-25T18:19:40.334Z",
        "updated_at": "2022-04-25T18:19:40.334Z",
        "published_at": "2022-04-25T18:19:40.329Z",
        "username": "Jarred84",
        "children": [
          {
            "id": "044e2d85-3bc5-48b2-afcd-7214cbbb9561",
            "owner_id": "7e8d7d4d-a8b9-4c07-b3b4-db5db2116885",
            "parent_id": "f27e7b2e-6544-43c8-b4a2-574983996248",
            "slug": "child-branch-a-level-3",
            "title": "Child branch A [Level 3]",
            "body": "Quod enim et aut quia eius nihil rem totam labore. Dolorum occaecati quos impedit unde. Et a ipsam hic expedita aut. Dignissimos ea aspernatur est dolores repellat voluptas quisquam reprehenderit veritatis.\n \rHarum rerum quam eius qui ullam. In ad quo similique suscipit non facilis quidem ratione. Consequatur rem veritatis molestias itaque aut beatae ratione sapiente. Ducimus sit similique dicta expedita totam laboriosam recusandae mollitia quas. Et qui rerum. Ipsa exercitationem dolore voluptatibus.\n \rNihil eaque commodi harum dolor. Incidunt neque necessitatibus. Eveniet placeat id excepturi pariatur sapiente a. Saepe occaecati pariatur eum magni est rerum odit libero aut. Et dignissimos enim modi error nihil culpa aut recusandae.\n \rEligendi hic dolorem ullam in repellat voluptatum perferendis quos necessitatibus. Ea quod quod. Quisquam rerum voluptas cupiditate. Repudiandae accusamus deserunt reiciendis et aut dolores veniam. Animi quia sit dignissimos eos sint porro. Nobis fuga quis at cupiditate.\n \rFugiat impedit in quaerat sapiente autem saepe. Et et nesciunt laudantium sunt. Ipsam voluptas ducimus at vitae exercitationem. Eos eum corrupti corporis. Commodi voluptatum rerum repellat sed adipisci rem.",
            "status": "published",
            "source_url": null,
            "created_at": "2022-04-25T18:19:40.361Z",
            "updated_at": "2022-04-25T18:19:40.361Z",
            "published_at": "2022-04-25T18:19:40.356Z",
            "username": "Jarred84",
            "children": []
          }
        ]
      }
    ]
  },
  {
    "id": "0714c439-c8de-4d50-bdca-d8a064c54c27",
    "owner_id": "7e8d7d4d-a8b9-4c07-b3b4-db5db2116885",
    "parent_id": "f076c331-92c6-47f3-be23-6f5d962d7eef",
    "slug": "child-branch-b-level-1",
    "title": "Child branch B [Level 1]",
    "body": "Fuga corporis vel. Reiciendis ut suscipit id earum aut perspiciatis et expedita quia. Et adipisci voluptatem et consectetur. Ut quia voluptas quo.\n \rNemo dolores eos consequuntur. Sit non voluptatem. Blanditiis dolorum in consectetur dolore. Voluptatem iste reiciendis adipisci fugit saepe natus eum maxime.\n \rRatione assumenda velit nesciunt. Sit qui iusto quibusdam placeat aut. Quasi sapiente sed molestiae aliquid et sequi qui maiores et. Recusandae beatae doloremque minus tenetur eius cumque.\n \rEius quae omnis optio ducimus voluptatum explicabo corrupti. Quia voluptatem rerum. Quisquam reprehenderit quam qui. Est suscipit autem sequi sunt a illo.\n \rRepudiandae quos sunt ea tenetur eum ut numquam ut. Ex sunt natus natus beatae dolorem. Et reprehenderit voluptas dolores id qui tempora esse ut occaecati. Odio accusamus et voluptatem sed in mollitia nostrum libero.",
    "status": "published",
    "source_url": null,
    "created_at": "2022-04-25T18:19:40.391Z",
    "updated_at": "2022-04-25T18:19:40.391Z",
    "published_at": "2022-04-25T18:19:40.386Z",
    "username": "Jarred84",
    "children": [
      {
        "id": "c3ed0964-bc4a-44f8-a6fb-cf09a78b68d2",
        "owner_id": "7e8d7d4d-a8b9-4c07-b3b4-db5db2116885",
        "parent_id": "0714c439-c8de-4d50-bdca-d8a064c54c27",
        "slug": "child-branch-b-level-2-1",
        "title": "Child branch B [Level 2] #1",
        "body": "Voluptatem quis consequatur. Quia fuga in et voluptatem et modi eum aut minus. Vel neque praesentium quos. Minus dolorum sit.\n \rConsequuntur incidunt dolor voluptatem in nostrum odio recusandae aut ad. Et illo id consequatur nobis. Incidunt ullam modi eos omnis. Quia quisquam qui impedit aspernatur at earum incidunt vero nostrum. Assumenda non qui praesentium eveniet fuga est nihil est.\n \rAdipisci consequatur quis. Ut sunt molestiae nisi earum dolor tempore error. Ut ea magni aut a consectetur omnis.\n \rVoluptatibus et excepturi odit quia. Necessitatibus ab earum sequi non autem ut rerum et rerum. Quibusdam voluptate est sed consequatur beatae rerum cumque blanditiis. Autem perferendis corporis modi ipsum. Dolores ea reiciendis omnis accusamus sit. Omnis atque alias repudiandae aliquid possimus itaque.\n \rSed qui error aut ea magnam ut. Sed vitae totam sed iure aliquam. Libero omnis voluptates. Qui nostrum et explicabo possimus rerum.",
        "status": "published",
        "source_url": null,
        "created_at": "2022-04-25T18:19:40.417Z",
        "updated_at": "2022-04-25T18:19:40.417Z",
        "published_at": "2022-04-25T18:19:40.412Z",
        "username": "Jarred84",
        "children": []
      },
      {
        "id": "e79affd7-8a87-4f01-a7cc-d75ff7be8bf7",
        "owner_id": "ab5e71b0-889c-4160-978d-34d85f68737a",
        "parent_id": "0714c439-c8de-4d50-bdca-d8a064c54c27",
        "slug": "child-branch-b-level-2-2",
        "title": "Child branch B [Level 2] #2",
        "body": "Rerum quos quaerat ad natus voluptatem qui sint id. Molestiae qui voluptates iure molestiae aut qui illo vel voluptatem. Quia voluptatem inventore qui modi aut dolorem. Quis nulla dicta modi aliquid eaque. Reprehenderit magnam quisquam saepe est hic. Quod inventore cumque beatae.\n \rAdipisci nihil ducimus eaque. Dolores in assumenda illo sint repudiandae aut commodi sed. Corporis debitis laudantium culpa expedita aut.\n \rNon eligendi quo rerum delectus labore nisi. Cum deserunt velit quo soluta et nostrum consequuntur adipisci. Quo nihil iste et eos fuga natus unde voluptate. Accusantium dolorem molestiae debitis animi autem praesentium sint quae quo.\n \rAut aut autem quia in necessitatibus voluptatum alias harum. Quis aut animi necessitatibus eos voluptatem magni quia. Temporibus repellat autem nobis a dolores quia corporis qui.\n \rRem cupiditate cupiditate voluptatum qui aut adipisci odio debitis a. Quo velit et corrupti quasi delectus. Corrupti dignissimos repellat quia rerum aut illum aut. Praesentium modi officia consequatur qui ipsam consequatur. Molestias ducimus qui et et. Exercitationem minima doloribus saepe et corporis qui.",
        "status": "published",
        "source_url": null,
        "created_at": "2022-04-25T18:19:40.445Z",
        "updated_at": "2022-04-25T18:19:40.445Z",
        "published_at": "2022-04-25T18:19:40.440Z",
        "username": "Nia28",
        "children": []
      }
    ]
  }
]
```

</pull*277*`content`: m√©todo e endpoint para listar conte√∫dos filho>

---

<pull_278_Implementa Design System do Github (Primer)>
Turma, estou maravilhado com o [Primer](https://primer.style/) do Github. Isso foi uma recomenda√ß√£o do @andrefd17 e resolvi testar. Ele fornece componentes em React, quase todos est√£o em `Alpha`, mas nos testes que fiz aqui gostei muito de usar. Os componentes ficaram id√™nticos ao do Github e deu uma bela de uma profissionalizada, o que me assustou porque sou zero profissional em frontend! Olha o resultado nos **dois v√≠deos** abaixo:

## Novos detalhes no cadastro

https://user-images.githubusercontent.com/4248081/165394203-29196b38-4a1b-4630-a9be-4ee706f2c14f.mov

## Mensagem de erro global

https://user-images.githubusercontent.com/4248081/165394718-e65a95b4-ccb7-4bec-852f-2ed0b1979f5f.mov

## Interface com o cabe√ßalho

## O que foi feito nesse PR

1. Instala√ß√£o e configura√ß√£o do `@primer/react` (e seu `linter`) e `styled-components`
2. Atualiza√ß√£o de todas as depend√™ncias.
3. Error `400` exp√µe uma nova chave `type` usada para identificar exatamente qual o tipo de erro (e n√£o s√≥ o campo) e com isso deu para fazer a mensagem customizada de erro sobre alfanum√©ricos.
4. `<html>` agora vem com `lang="pt-br"` por padr√£o.

## O que n√£o foi feito

Agora deu para notar como que a propriedade `message` no objeto de erro est√£o com uma cara de "API" e n√£o de "Usu√°rio final". Ent√£o ao inv√©s de retornar da API um erro como:
`"username" n√£o pode estar em branco.`
N√≥s dever√≠amos retornar algo como:
`Nome de usu√°rio n√£o pode estar em branco.` (ou algo assim)

---

Tamb√©m n√£o foi feita a abstra√ß√£o do cabe√ßalho, nem layout. Por enquanto vamos copiando e colando mesmo, s√≥ pra ver o que vamos precisar.
</pull_278_Implementa Design System do Github (Primer)>

<pull_279_Normaliza todos os layouts e adiciona endpoint `/user`>
O que foi feito nesse PR pode ser visto aqui: https://tabnews-hokeouars-tabnews.vercel.app/cadastro

## Normaliza todas as p√°ginas para usar o Github Primer.

Ta MUITO massa usar ele. Minha primeira experi√™ncia com esse tipo de coisa e estou gostando bastante. Eu n√£o estava com planos de fazer essa parte do layout nessa Milestone, mas eu queria experimentar mais se o Primer era utiliz√°vel, ainda mais por v√°rios dos componentes dele do React estarem em Alpha e Beta. Mas como escrevi, ta muito massa, n√£o tive nenhum problema at√© ent√£o e a interface ta em **outro patamar**.
O que mais est√° me incomodando √© que algumas coisinhas est√£o causando um layout shift, mas √© mais culpa de como implementei do que qualquer outra coisa. E isso vai ser refinado quando chegarmos na vers√µes finais.

## Layout padr√£o

Essa parte est√° bem crua ainda, principalmente a estrutura de pastas e como o componente de layout est√° sendo usado. N√£o est√° sendo feito o "static layout", nem se preocupando com SEO. Essas coisas v√£o vir ainda. S√≥ precisava de algo m√≠nimo para colocar a m√£o na massa.

## Hook de user e SWR: `useUser()`

Nunca tinha feito um hook que usa o m√≥dulo [swr](https://www.npmjs.com/package/swr) e achei uma delicinha! N√£o sei se fiz certo tamb√©m. E para conseguir ter esse hook, eu precisei de um novo endpoint. Aproveitei para atualizar todas as depend√™ncias de novo.

## Novo endpoint: `GET /api/v1/user`

Ele apenas retorna o usu√°rio que est√° autenticado e isso √© usado no hook `useUser()` para decidir mostrar no menu o bot√£o de cadastro e login, ou o menu do usu√°rio.
E como medida de seguran√ßa, o `token` do endpoint `/sessions` s√≥ √© retornado no primeiro ato do `POST`.
</pull_279_Normaliza todos os layouts e adiciona endpoint `/user`>

<pull_280_Finaliza vers√£o `Beta` do Novo Layout>
Esse PR √© uma baga, n√£o tenho orgulho disso üòÇ mas estou ficando com muito orgulhoso do resultado final, simplesmente por eu n√£o fazer a m√≠nima ideia do que eu estou fazendo no frontend e mesmo assim consegui fazer tudo o que eu queria. Ent√£o vamos aos pontos mais importantes desse PR:

# Vamos jogar essa interface fora?

Queria come√ßar dessa forma, porque eu n√£o tenho nenhum apego no trabalho que foi feito at√© agora. Queria realmente deixar isso claro para dar espa√ßo a um especialista em Frontend, Design, UX, porque essa pessoa conseguir√° fazer algo muito melhor.

# Remo√ß√£o do `tailwindcss`

Ele foi completamente substitu√≠do pelo [@primer/react](https://primer.style/react/). Isso significa que a nossa atual Home vai ficar meio mal formatada, porque eu mantive ela e a nova Home est√° em `/beta`. Assim que finalizar toda migra√ß√£o de dados e features (tem um item sobre isso mais abaixo), eu fa√ßo a substitui√ß√£o.

# Padroniza√ß√£o das p√°ginas com o Primer

Todas as p√°ginas est√£o usando ele, vejam nos pr√≥ximos t√≥picos as principais.

# `/cadastro`

# `/cadastro` com erro

# `/publicar` com conte√∫do preenchido

# `/[username]/[slug]`

Como estou logado, eu consigo ver os `[...]` para editar meu conte√∫do.

# Escrevendo uma resposta

# Depois de publicar a resposta

# P√°gina exclusiva da resposta

Nota na imagem de cima (Depois de publicar a resposta) que cada coment√°rio tem uma hora que foi publicada. Isso √© interessante porque ele mostra a quanto tempo foi postado, mas se eu **passar o mouse em cima** mostra o hor√°rio sem formata√ß√£o de dist√¢ncia de tempo:
Mas mais importante que isso, √© que se voc√™ clicar nessa data, voc√™ vai acessar a p√°gina exclusiva dessa resposta (e que aponta para o conte√∫do pai que est√° acima dela):

# Respondendo a resposta de uma resposta

# Integra√ß√£o com Mermaid

Assim como aqui no Github, voc√™ pode criar fluxogramas usando a sintaxe do [Mermaid](https://mermaid-js.github.io/) e eu to sedento pra criar conte√∫dos dentro do TabNews explicando sobre os fluxos internos do TabNews üòÇ

**Aten√ß√£o:** tem algum bug que eu n√£o consegui identificar que impede ver o mermaid no modo `Preview`... s√≥ d√° para ver depois que publica. Mas vou investigar (ou n√£o, se trocarmos de editor).

# `/[username]`

Cada usu√°rio vai ter um endere√ßo na raiz do site:

# Tudo cess√≠vel pela API por padr√£o: `/api/v1/contents/`

Ent√£o por exemplo a URL daquele primeiro conte√∫do que foi criado era:

```
/filipedeschamps/isso-daqui-e-o-titulo-de-um-novo-conteudo-raiz
```

Essa √© a vers√£o da **P√°gina Web**, correto? Ent√£o se na frente desse endere√ßo eu digitar `/api/v1/contents/` resultando em:

```
/api/v1/contents/filipedeschamps/isso-daqui-e-o-titulo-de-um-novo-conteudo-raiz
```

A API retorna o exato mesmo conte√∫do e isso possibilita a integra√ß√£o e cria√ß√£o de **qualquer client, script ou automa√ß√£o** que as pessoas queiram criar:

# `checkBlockedUsernames()`

Ao criar uma conta, o model `user` verifica se o nome de usu√°rio est√° contido numa lista de palavras bloqueadas. Isso serve tanto para reduzir tentativas de phishing, como por exemplo criar um usu√°rio chamado `admin` como reservar caminhos na raiz do site, como `/contato`. Como todos os usu√°rios v√£o ter uma URL na raiz do site, o username pode conflitar com alguma p√°gina que a gente queira criar no futuro.

# Refatora√ß√£o das mensagens de erro

Isso n√£o foi feito, mas √© importante: todas as mensagens de erro na propriedade `message` precisam serem refatoradas considerando o usu√°rio que est√° vendo a interface web, e n√£o a API.

# Editor Markdown

Optei por usar o https://bytemd.js.org/ e em quest√£o de `DX` ele √© fant√°stico, por√©m o editor √© muito lento. Na verdade, s√≥ fica lento depois da thread possuir m√∫ltiplas respostas, ent√£o pode ter sido algo que eu fiz errado ao montar a interface. De qualquer forma, eu reaproveitaria o componente de `<View>` dele que √© √≥timo, e s√≥ colocaria no lugar um editor mais leve e que suporte algumas facilidades relacionadas a Markdown que d√° pra encontrar aqui no Github como automaticamente criar o pr√≥ximo item de uma lista ao apertar o Enter.

# Componente `<Content>`

Esse componente abstrai toda visualiza√ß√£o, edi√ß√£o ou atualiza√ß√£o de um `content` e tudo isso √© controlado pelo `mode` dele:

```js
if (componentMode === "view") {
  return <ViewMode />;
}
if (componentMode === "edit") {
  return <EditMode />;
}
if (componentMode === "compact") {
  return <CompactMode />;
}
```

# Conte√∫dos filho mostram dados do conte√∫do pai

Agora na API todo conte√∫do filho conta com:

- `parent_title`
- `parent_slug`
- `parent_username`
  E com isso, quando voc√™ est√° na p√°gina √∫nica de um conte√∫do filho, √© poss√≠vel navegar para o conte√∫do pai dele, como mostrado nas imagens anteriores.

# Migra√ß√£o das features

Depois do merge desse PR, vou migrar as features antigas para as novas relacionadas a cria√ß√£o de conte√∫do.

# Tem mais coisas

Da√≠ deixo a crit√©rio de voc√™ analisar o diff desse PR maluco, mas o mais importante √© que com o merge dele n√≥s fechamos a √∫ltima issue complexa, que envolve as issues abaixo:
Closes #230
Closes #233
Closes #235
</pull_280_Finaliza vers√£o `Beta` do Novo Layout>

<pull_282_Disponibiliza nova p√°gina com Estat√≠sticas e Status do Site>
Voc√™ j√° pode acessar a p√°gina por essa url (dados do Ambiente de **Homologa√ß√£o**): https://tabnews-git-status-tabnews.vercel.app/status

### Resultado

**Observa√ß√£o:** a lat√™ncia do Banco de Dados no ambiente de Homologa√ß√£o √© alta, porque a camada da Aplica√ß√£o est√° em S√£o Paulo, mas a inst√¢ncia do Banco est√° nos EUA. No ambiente de Produ√ß√£o ambas partes est√£o em SP üëç
Closes #237
</pull_282_Disponibiliza nova p√°gina com Estat√≠sticas e Status do Site>

<pull_284_fix(editor): fix `height` property>
Eu fiz alguma besteira no CSS do editor e s√≥ notei agora: a propriedade `height` estava 100% quebrada.
Agora quando voc√™ est√° criando um post novo, tem praticamente toda a altura da tela para escrever. E quando est√° respondendo a algum outro conte√∫do, a altura reage de acordo com o ambiente (o espa√ßo do corpo fica um pouco menor).
</pull_284_fix(editor): fix `height` property>

<pull_285_feat(content): revalidate root and child content using `swr`>
Como estamos usando um cache agressivo na p√°gina de um conte√∫do, muitas vezes voc√™ pode entrar na p√°gina e ver o conte√∫do principal ou os coment√°rios desatualizados. Com esse PR, ao entrar numa p√°gina que est√° com o cache desatualizado, automaticamente o `swr` se responsabiliza por atualizar.
</pull_285_feat(content): revalidate root and child content using `swr`>

<pull_286_Pequenos ajustes de interface>

1. Altera o t√≠tulo da Home
2. Move o bot√£o verde de publicar pra dentro do dropdown menu (estava quebrando o layout em mobile)
3. Na p√°gina /status aumenta a altura dos gr√°ficos e d√° um truncate em valores que s√£o largos (mensagem de commit, sha e username)
   </pull_286_Pequenos ajustes de interface>

<pull_287_Coloca a Home Beta na Raiz do Site üòç>
Est√° se tornando realidade turma!!!
E todo conte√∫do que antes estava na home pode ser acessado na nossa p√°gina de Museu: https://www.tabnews.com.br/museu
</pull_287_Coloca a Home Beta na Raiz do Site üòç>

<pull_289_feat(pages/cadastro): adicionado campo de confirma√ß√£o de senha>
O usuario deve repetir a senha digitada anteriormente para garantir que a senha n√£o tenha erros

#288

> > Review de filipedeschamps (CHANGES_REQUESTED):
> > Que masssaaaaa essa contribui√ß√£o üòç coloquei algumas sugest√µes e d√∫vidas ü§ù
> > Review de arthurbotelho (COMMENTED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Pensando que essa √© uma chave que viria do backend, sugiro nomear como `password_confirm` üëç
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Sugiro utilizar o padr√£o de todas as mensagens de erro terminarem com um ponto final.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Eu n√£o consegui compreender muito bem essa condicional aqui. To tentando entender ela sem executar o c√≥digo na minha m√°quina mas n√£o estou conseguindo, se puder me ajudar seria show ü§ù
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > √â necess√°rio remover esse console.log
> > Coment√°rio de arthurbotelho (linha de c√≥digo):
> > Esse if na verdade √© para bloquear de enviar a requisi√ß√£o se algum erro de valida√ß√£o estiver acontecendo: email invalido, senha muito curta, etc. Ent√£o se todas as condi√ßoes estiverem ok ela passa da condicional e faz a requisi√ß√£o. Ent√£o respondendo a primeira sugest√£o, o erro "key: 'passwordConfirm'" n√£o viria do back porque √© uma valida√ß√£o de front.
> > </pull_289_feat(pages/cadastro): adicionado campo de confirma√ß√£o de senha>

<pull_290_fix(content): remove `grid` property of child content tree>
Esse bug foi encontrado pelo Programador BR que me mandou os seguintes prints:
Quando um conte√∫do filho continha um bloco de c√≥digo muito longo, o layout quebrava, e era a propriedade `grid` que estava sendo aplicada somente aos conte√∫dos filho üëç
</pull_290_fix(content): remove `grid` property of child content tree>

<pull_291_fix(head): remove canonical url>
Estou por hora removendo o `canonical url` do layout base, pois est√° fazendo mais ruim do que bom no momento. Isso porque do jeito que eu fiz, a base da URL √© constru√≠da de forma din√¢mica, mas de um jeito que pega a "url do build" l√° na Vercel. Isso √© √≥timo para ambiente de Preview, mas em produ√ß√£o n√£o, olha com que estava:

**Url de refer√™ncia:**

```
https://www.tabnews.com.br/filipedeschamps/tentando-construir-um-pedaco-de-internet-mais-massa
```

**Tag gerada:**

```
<link rel="canonical" href="https://tabnews-3ri8e23d7-tabnews.vercel.app/filipedeschamps/tentando-construir-um-pedaco-de-internet-mais-massa"/>
```

</pull_291_fix(head): remove canonical url>

<pull_292_fix(status): fix chart y axis error>
Encontrei o problema na p√°gina `/status` dos gr√°ficos n√£o representarem corretamente a altura dos valores... eles estavam vindo como `String` e agora vem como `Number`.
De qualquer forma, essa query tem que ser jogada fora e refeita do zero, tem formas muito mais simples.
</pull_292_fix(status): fix chart y axis error>

<pull_295_fix(errors): handle validation error on `getStaticProp()`>
Eu estava analisando os logs para ver se tudo estava ok, e comecei a notar uns erros `500` para URLs como essa:
https://www.tabnews.com.br/nao-existe.jpg
E lembrei que nas p√°ginas est√°ticas, antes delas serem geradas, √© feita a valida√ß√£o **tamb√©m**, por√©m n√£o estava sendo feito o handling caso a valida√ß√£o n√£o passasse.
Ent√£o no caso da URL acima, ela estava caindo na valida√ß√£o de username:
`https://www.tabnews.com.br/[username]`
E o `username` s√≥ aceita caracteres alfanum√©ricos.
A mesma coisa para o slug:
`https://www.tabnews.com.br/[username]/[slug]`
E isso era ativado quando algu√©m tentou acessar a url:
`https://www.tabnews.com.br/.well-known/traffic-advice`
Esse PR pretende consertar isso e retornar `404` (n√£o encontrei como ser poss√≠vel retornar outro status code de dentro de um `getStaticProp`)
</pull_295_fix(errors): handle validation error on `getStaticProp()`>

<pull_296_feat(publish): add warning message if user has zero contents>
Adiciona um aviso caso a pessoa n√£o tenha conte√∫dos publicados. Isso para tentar reduzir testes ou conte√∫dos sem valor concreto em ambiente de produ√ß√£o.
E o link redireciona para: https://www.tabnews.com.br/filipedeschamps/tentando-construir-um-pedaco-de-internet-mais-massa
</pull_296_feat(publish): add warning message if user has zero contents>

<pull_298_feat(registration link on the login page): registration link>
Criando apenas uma redund√¢ncia de navega√ß√£o para facilitar UX Design
</pull_298_feat(registration link on the login page): registration link>

<pull_303_fix(migrations problem in npm run dev): migrations problem>
Recriando a PR com a base atualizada e enviado o arquivo package-lock.json
Seguindo com a corre√ß√£o da https://github.com/filipedeschamps/tabnews.com.br/issues/297 junto ao @filipedeschamps fiz um script para ler os logs at√© que o banco fique pronto para conex√µes.
Sugest√£o: Testar em maquinas lentas e todos os OS's antes de aprovar.
</pull_303_fix(migrations problem in npm run dev): migrations problem>

<pull_304_feat: update readme>
Adicionando um detalhe no README sobre as migrations ap√≥s o PR #303 do @rodrigoKulb, e ajustando o n√≠vel dos √∫ltimos dois itens.
</pull_304_feat: update readme>

<pull_305_fix(content): stops re-rendering `/publicar` page on re-focus>
Se algum especialista em React puder me ajudar seria show.
O uso dos hooks ali em baixo estavam causando a p√°gina `/publicar` a ser "re-renderizada" ao ser "re-focada" e com isso resetar todo o estado do formul√°rio. O problema estava exatamente no `useUser()`, mas ele era usado somente para a url/chave do `swr`. E isso era usado para entender se a mensagem sobre a primeira postagem deveria aparecer ou n√£o.
Mas mesmo que os valores dos hooks acima mudem, n√£o entendo porque todos os componentes estavam sendo renderizados novamente, incluindo o `<Content mode="edit" />`, o que causava perder todos os dados.
Eu j√° vou fazer o merge desse PR para consertar isso em produ√ß√£o, mas se algu√©m estiver dispon√≠vel para me explicar essa mec√¢nica seria show!
</pull_305_fix(content): stops re-rendering `/publicar` page on re-focus>

<pull_306_build: update dependencies>
Atualiza√ß√£o geral de todas as depend√™ncias utilizando o comando `npx npm-check-updates -u`.
Depend√™ncias usadas pelo backend temos a seguran√ßa dos testes de integra√ß√£o, mas enquanto n√£o conseguirmos resolver os testes e2e, vamos ter aten√ß√£o redobrada nos comportamentos do frontend ü§ù
</pull_306_build: update dependencies>

<pull_307_fix(migrations): use `retry-cli` to run the migration script on `npm run dev`>
Sobre o problema [reportado aqui](https://github.com/filipedeschamps/tabnews.com.br/pull/306#issuecomment-1123916585) e relacionado a issue #297
Vou ficar rodando os testes v√°rias vezes aqui no CI para ver o comportamento.
E diferente da primeira implementa√ß√£o que enviava os logs de erro para o `/dev/null` agora eles s√£o enviados para `migrations.log` e isso faz ficar compat√≠vel com todos os sistemas operacionais.
</pull_307_fix(migrations): use `retry-cli` to run the migration script on `npm run dev`>

<pull_309_feat(applying caps lock validation): applying caps lock validation>
Seguindo a Issue #288 apliquei o aviso de caps lock, sou novo no mundo do node / react espero ter acertado na forma!
</pull_309_feat(applying caps lock validation): applying caps lock validation>

<pull_312_fix(content): word-wrap on content box>
Hoje estava lendo um post do tabnews no celular, acabei reparando em um bug de quebra do conte√∫do conforme imagem abaixo:
Resolvi adicionando o style wordWrap: 'break-word',
</pull_312_fix(content): word-wrap on content box>

<pull_315_feat(eslint-a11y): adicionado plugin eslint para verificar a11y em jsx>
H√° uma semana atr√°s fiz este post no tabnews: [Dicas de como melhorar a acessibilidade de seu site](https://www.tabnews.com.br/Miguel/dicas-de-como-melhorar-a-acessibilidade-de-seu-site) e recebi um feedback bem bacana!
O plugin √© bem completo e nos ajuda em v√°rias regras durante o desenvolvimento!
Aqui est√° [todas as regras](https://github.com/jsx-eslint/eslint-plugin-jsx-a11y#supported-rules) do plugin. Podemos configurar conforme nossa necessidade, por agora, est√° configurado o recomendado!

> > Review de filipedeschamps (CHANGES_REQUESTED):
> > Sensacional meu caro üòç e voc√™ sabe dizer se falhar com essas regras far√° com que os testes n√£o passem? Pois deveria ser assim.
> > Em paralelo, pedi uma altera√ß√£o na declara√ß√£o da depend√™ncia ü§ù
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Remover `^` para evitarmos surpresas.
> > </pull_315_feat(eslint-a11y): adicionado plugin eslint para verificar a11y em jsx>

<pull_331_sistema de notifica√ß√£o>
Como descrito na issue #321 o objetivo dessa PR √© um modelo de notifica√ß√£o simples que deve apenas enviar um e-mail, obviamente respeitando as regras citadas na issue.
</pull_331_sistema de notifica√ß√£o>

<pull_342_fix(migrations): script de health check do postgres antes de executar as migra√ß√µes>
Foi criado um script que verifica se o postgres est√° aceitando conex√£o e executado ele antes de aplicar as migra√ß√µes.
Discuss√£o realizada no [PR](https://github.com/filipedeschamps/tabnews.com.br/pull/329)
Refiz o processo de instala√ß√£o do tabnews e obtive o seguinte output no terminal:
Agora o migration.log n√£o possui mais os erros de tentativa de conex√£o:

> > Review de tembra (COMMENTED):
> > Review de tembra (COMMENTED):
> > Review de gabrieldev525 (COMMENTED):
> > Review de tembra (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de gabrieldev525 (COMMENTED):
> > Coment√°rio de tembra (linha de c√≥digo):
> > Essa nova implementa√ß√£o (ap√≥s remo√ß√£o do util `sleep`), volta ao problema anterior.
> > Temos 50 tentativas com esperas de 3seg. Ou seja, se demorar mais do que 150seg para baixar a imagem e subir a m√°quina, teremos o erro novamente.
> > Para resolver isso sem ter que criar uma fun√ß√£o `sleep`, podemos usar a op√ß√£o `forever` do `retry` como `true`. O `async-retry` utiliza por tr√°s dos panos o `retry` como pode ser [visto aqui](https://github.com/vercel/async-retry/blob/9505be1f829ea297e7aff6c731ca3d5bd7052ed7/package.json#L21) e informa na documenta√ß√£o que as `options` s√£o passadas ao `retry` como pode ser [constatado aqui](https://github.com/vercel/async-retry/blob/9505be1f829ea297e7aff6c731ca3d5bd7052ed7/lib/index.js#L14).
> > Coment√°rio de tembra (linha de c√≥digo):
> > @filipedeschamps Li agora que a quantidade de retries foi uma sugest√£o sua. Voc√™ n√£o acha melhor usar o `forever` como `true` ? Mas claro, utilizando o contador de retries para exibir a mensagem de log ap√≥s X tentativas, pois ela √© muito bem vinda.
> > Coment√°rio de gabrieldev525 (linha de c√≥digo):
> > Boa observa√ß√£o. Por√©m, o script √© executado ap√≥s o `npm run services:up` finalizar. Ent√£o o tempo de baixar a imagem e subir n√£o conta nesse processo do script.
> > O que acontece √© que ap√≥s subir o container, o postgres demora um tempo at√© passar a aceitar conex√µes no banco.
> > Eu concordo com voc√™ que o param√™tro `forever` do `retry` √© v√°lido. O que voc√™ acha @filipedeschamps?
> > Coment√°rio de tembra (linha de c√≥digo):
> > @gabrieldev525 na primeira execu√ß√£o do container (`docker-compose up`) ele √© automaticamente constru√≠do se n√£o existir (`docker-compose build`). Se na hora da constru√ß√£o a imagem nunca tiver sido baixada, ela tamb√©m ser√° baixada.
> > Na minha m√°quina aqui, por exemplo, nem docker tenho instalado. Se eu baixar o docker, clonar o projeto e rodar, esse tempo longo para a primeira inicializa√ß√£o ocorrer√°, pois n√£o tenho se quer a imagem do postgres baixada.
> > √â por este problema que estou defendendo o uso do `forever` hehehe.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Opa, acho que teve algum problema na comunica√ß√£o üòÇ n√£o sou contra ao `forever`, se der para passar isso para o `async-retry` seria sensacional!!! Minha √∫nica sugest√£o foi usar o `async-retry` para ganhar o `sleep` de gra√ßa ü§ù e novamente, se der pra passar o `forever`, sensacional, e se n√£o der, bora pro `9999999999` üëç
> > Coment√°rio de gabrieldev525 (linha de c√≥digo):
> > Pronto, adicionei o param√™tro forever :+1: hehehe
> > </pull_342_fix(migrations): script de health check do postgres antes de executar as migra√ß√µes>

<pull_344_feat(content component): added the functionality to store the input v‚Ä¶>
‚Ä¶alues in localstorage
Added the functionality to store the input values in localstorage to retrieve when the page is
reloaded accidentally.
fix #335

> > Review de filipedeschamps (COMMENTED):
> > Simplesmente sensacionaaaaal ter isso implementado, quase que surreal ter feito t√£o r√°pido num componente que eu deixei completamente monstruoso üòÇ
> > Coloquei algumas d√∫vidas e sugest√µes ü§ù
> > Review de andreghisleni (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de tembra (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de tembra (COMMENTED):
> > Review de tembra (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de gabrielew (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Review de andreghisleni (COMMENTED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Uma d√∫vida: porque essa `key` cont√©m o `user.id` por√©m as outras n√£o?
> > Estava pensando aqui, se a pessoa come√ßa a digitar uma resposta e se esqueceu de logar, seria legal poder logar e o conte√∫do voltar para ela üëç
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Acho que escapou essas linhas comentadas
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Aqui seria `parsedData` ao inv√©s de `parcedData`
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > O que acha de primeiro remover do localStorage?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Mesma coisa aqui, sugiro primeiro remover do localStorage antes de redirecionar o usu√°rio.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Sugiro a mesma coisa aqui.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > `parsedData`
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > `parsedData`
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Fiquei na d√∫vida porque da exist√™ncia dessa verifica√ß√£o, √© para ele automaticamente abrir a caixa de edi√ß√£o em caso de encontrar algo em localStorage sobre aquele item? Se for, genial üòç
> > Em paralelo, √∫nico detalhe seria a mesma d√∫vida l√° de cima sobre o user.id ü§ù
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > na verdade parando para analizar a quest√£o do user id pode fazer muito sentido mas tambem pode n√£o fazer sentido nem um nesse caso, se a ideia futura √© que a pessoa possa logar com 2 user diferentes daria para armazenar separados, mas do jeito que est√° n√£o faz diferen√ßa, prefere que eu padronize tudo com o user id ou sem??
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > eu acredito que para aparecer o bot√£o para fazer um comentario deveria estar logada, n√£o?
> > Coment√°rio de tembra (linha de c√≥digo):
> > O que voc√™s acham de utilizar debounce pattern nesta fun√ß√£o?
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > Olha √© uma op√ß√£o, eu implementei sem o debounce pelo fato de n√£o ter comunica√ß√£o alguma com API e por n√£o depender de servi√ßos externos, principalmente pelo fato de o objetivo ser manter uma c√≥pia caso venha ocorrer algum problema como recarregamento do site
> > Coment√°rio de tembra (linha de c√≥digo):
> > Entendo perfeitamente sua coloca√ß√£o e a princ√≠pio tamb√©m faria o mesmo.
> > Entretanto acredito ser uma boa pr√°tica para economizar recursos computacionais desnecess√°rios dos nossos visitantes, afinal a maioria n√£o tem um dispositivo de √∫ltima gera√ß√£o. As vezes muito pelo contr√°rio, pessoas que gostam e est√£o querendo ~entrar~ trabalhar no mundo da tecnologia n√£o tem o m√≠nimo acesso a ela.
> > Apenas uma sugest√£o üòÉ
> > Coment√°rio de tembra (linha de c√≥digo):
> > Eu escolheria uma das duas op√ß√µes abaixo:

1. Limparia o `localStorage` no momento do logout.
2. Faria o `localStorageKey` sempre contar com o `user.id` e salvaria o JSON encriptado com um secret que utilizasse o pr√≥prio `user.id` para um usu√°rio n√£o ter acesso ao conte√∫do do outro atrav√©s do local storage. Assim um usu√°rio poderia deslogar e logar novamente, sem perder o conte√∫do por nossa causa.
   Se n√£o usarmos nenhuma, em computadores p√∫blicos, como quando o TabNews estiver sendo utilizado para consultas nas bibliotecas das universidades de todo o pa√≠s (üéâ), uma pessoa teria acesso ao draft da outra e poderia se apropriar do conte√∫do indevidamente.
   Mas talvez seja algo pra ser implementado mais l√° na frente, talvez?
   > > Coment√°rio de andreghisleni (linha de c√≥digo):
   > > sim sim, principalmente quando for implementado a fun√ßao de logout
   > > Coment√°rio de andreghisleni (linha de c√≥digo):
   > > Concerteza a quest√£o dos recursos computacionais √© muito importante mas acredito que no primeiro momento √© desnecessario
   > > Coment√°rio de gabrielew (linha de c√≥digo):
   > > Uma d√∫vida, quando √© salvo algo no localStorage √© gerado algum consumo de internet? Caso sim, seria legal ter o debounce para poupar o 3G do pessoal que est√° no celular!
   > > Caso queira implementar, geralmente eu uso esse hook de debounce que criei.
   > > Ex. Aguardar `500ms` antes de executar uma a√ß√£o e caso o `value` seja alterado o `delay` √© resetado.

```js
import React from "react";
export const useDebounceValue = (value, delay = 500) => {
  const [debounceValue, setDebounceValue] = React.useState(value);
  React.useEffect(() => {
    const handler = setTimeout(() => setDebounceValue(value), delay);
    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);
};
```

> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > achei interessante esse hook, acredito que n√£o dependa de nem uma comunica√ßao com a internet para a utiliza√ßao do localstorage, mas se o @filipedeschamps acreditar que √© melhor utilizar esse m√©todo para armazenar, assim eu farei
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > @andreghisleni n√£o precisa na verdade, meio que virou um est√≠mulo visual. E quando a pessoa clica, se ela n√£o estiver logada, aparece uma mensagem:
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > @tembra muito bem pensado! E de fato deixaria a encripta√ß√£o mais para frente.
> > No mais, eu n√£o consideraria m√∫ltiplos usu√°rios agora, ainda mais com a vinda o /logout e a limpeza do localStorage üëç
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Isso, o localStorage √© 100% local, n√£o usa nada de internet. E eu n√£o sei qual a performance de salvar em algo no localStorage, mas sei que √© um processo s√≠ncrono. Ent√£o se houver um artigo muito grande, ficar salvando isso a cada KeyUp possa penalizar a experi√™ncia de escrever o pr√≥prio artigo... se esse for o caso, eu colocaria um debounce üëç
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > E em paralelo, parab√©ns pela postura e todo carinho que voc√™s est√£o colocando aqui no projeto ü§ù
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Acho que isso ficou estranho. Ou eu deixaria como est√° (dado que n√£o gerou nenhuma reclama√ß√£o) ou eu colocaria com a varia√ß√£o de desabilitado üëç
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Ah, agora entendi o que voc√™ fez... eu deixaria a implementa√ß√£o, mas n√£o mexeria no Texto do bot√£o.
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > eu acabei fazendo a altera√ß√£o no botao
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > Obrigado, eu acho que daria para deixar em aberto e em teste para decidir na pratica, pois eu acho que se n√£o afetar a experiencia do usuario fica melhor, pq se a pessoa escrever muito e muito rapido n√£o vai salvar, outra coisa que daria √© para colocar um contador que a cada 5 segundos digitando ele altera no localStorage
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > Outra coisa que eu acho que daria pra fazer √© colocar um cadeado na frente e um colocar um texto que quando passa o mouse por cima aparece, n√£o sei se da pra entender
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > √â que o debounce √© meio que um contador, por exemplo depois de X tempo sem digitar nada, ele salva no localStorage. Mas concordo com voc√™, vamos com a implementa√ß√£o mais simples e ir iterando em cima no futuro ü§ù
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > @andreghisleni acho que n√£o precisa, sugiro apenas que mude o texto para o "Responder", pois quando houver muitas respostas na p√°gina, como consequ√™ncia ter√£o muitos bot√µes tamb√©m e a segunda frase ali vai roubar muito a aten√ß√£o.
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > sim sim o problema como eu fai √© que se a pessoa est√° digitando rapido e sem querer clica no F5 √© um problema, mas d√° para adicionar o monitoramento dos eventos do teclado, acredito eu, e dai dependendo do evento exibir uma pergunta se a pessoa quer continuar ou cancelar
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > e manter a fun√ß√£o que manda para o login?
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > eu posso implementar isso, mas gostaria da autoriza√ß√£o para refatorar esse arquivo e dividir ele em sub arquivos, poderia ser na mesma pasta??
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Sim! Foi uma sacada **muito boa** sua!!! Por coincid√™ncia, a gente estava testando a [feature de ser notificado por email](https://tabnews-git-feat-sistema-de-notificacao-tabnews.vercel.app/filipedeschamps/estou-criando-esse-post-para-ser-notificado-por-email-de-qualquer-resposta) e a Renata passou **exatamente** por essa dificuldade de n√£o ser levada de volta para a p√°gina ap√≥s login üòÇ foi sensacional ver isso em tempo-real.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > @andreghisleni como essa feature est√° super na cara do gol e vai trazer duas melhorias absurdas pro TabNews (salvar conte√∫do e redirect no login), sugiro a gente fazer o deploy assim como est√°, se certificar que est√° se comportando corretamente para todos, e depois fazer um PR s√≥ de refatora√ß√£o (sem mudar comportamento). O que acha?
> > E eu ainda estou impressionado como que voc√™ conseguiu se entender dentro desse componente, ele est√° muito maluco üòÇ
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > @filipedeschamps Se quiser ver c√≥digo maluco tem que ver um componente de tabela que eu estou aprimorando, na verdade eu criei uma primeira vers√£o bem primitiva e estou constantemente atualizando.
> > A unica coisa que eu senti falta foi o typescript, eu sei que atrapalharia quem quer colaborar e nunca utilizou, mas pra mim que at√© um projeto de teste como um Hello Word eu uso, pra mim foi mais complicado üòÅüòÅüòÇ
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > pois √© eu percebi esse problema e resolvi fazer uma implementa√ß√£o simples
> > </pull_344_feat(content component): added the functionality to store the input v‚Ä¶>

<pull_353_feat(content): implementado a√ß√£o do bot√£o de deletar conte√∫do>
Implementa a a√ß√£o do bot√£o de deletar conte√∫do.
Feedback exibido quando algu√©m acessa um conte√∫do que foi deletado:
Al√©m disso, conforme especificado na [issue](https://github.com/filipedeschamps/tabnews.com.br/issues/349), foi comentado temporariamente o bot√£o de `Despublicar`

### Depend√™ncia

Esse pull request tem depend√™ncia da issue #348 que implementa o backend da atividade
feat #349
</pull_353_feat(content): implementado a√ß√£o do bot√£o de deletar conte√∫do>

<pull_355_chore: force a new deploy on Vercel>
Acabei de fazer o merge de um PR feito por @gabrieldev525 e no processo fiz um squash dos commits, mas a Vercel n√£o quis fazer o deploy porque ele n√£o est√° na lista das pessoas que podem fazer o deploy. N√£o encontrei na interface da Vercel como for√ßar um deploy, ent√£o estou fazendo esse PR para for√ßar um.
</pull_355_chore: force a new deploy on Vercel>

<pull_356_Salva rascunho dos conte√∫dos no localStorage em tempo-real>
Branch intermedi√°ria para a Vercel fazer o deploy. O PR com a implementa√ß√£o original foi feita por @andreghisleni est√° aqui: #344
</pull_356_Salva rascunho dos conte√∫dos no localStorage em tempo-real>

<pull_361_fix(LocalStorage): conflict in stored post content>
Solu√ß√£o de dois problemas relatados aqui https://www.tabnews.com.br/Pryds/c3376f31-85eb-4b2d-92fa-f8c5d2fdcf94

1. Ao clicar em responder e desistir da postagem as caixas de resposta ficam abertas por tempo indeterminado mesmo fechando o navegador. Isso ocorre porque ao verificar a exist√™ncia da Key daquele post em LocalStorage, mesmo que vazia, √© renderizado o modo de edi√ß√£o.
   **Corre√ß√£o:** Ao ler os dados armazenados em LocalStorage para a Key especificada √© verificada, al√©m da validade, tamb√©m a nulidade do do par√¢metro body, ent√£o a Key √© deletada se n√£o for √∫til.
2. Abrir mais de uma aba pode deixar os dados de LocalStorage com inconsist√™ncias como o t√≠tulo de uma aba e o corpo de outra.
   **Corre√ß√£o:** Os dados s√£o atualizados de LocalStorage sempre que a aba do navegador fica em foco. Assim a nova postagem fica consistente mesmo em caso de abertura de abas simult√¢neas.
   </pull_361_fix(LocalStorage): conflict in stored post content>

<pull_362_Bug fixed da feature de localStorage>
Esse PR faz o deploy da branch #361 de @aprendendofelipe para testarmos no ambiente de Preview üëç
</pull_362_Bug fixed da feature de localStorage>

<pull_363_fix(content): error in localStorage>
Error in localStorage
Corre√ß√£o dos erros tanto de n√£o mostrar os dadoes e a parte de mostrar em locais errados
fix #335

> > Review de aprendendofelipe (COMMENTED):
> > Tem mais alguns alguns detalhes que precisam de mais altera√ß√µes para resolver os bugs, como fazer aparecer o bot√£o de cancelar tamb√©m nas novas postagens para permitir apagar o item do storage n√£o s√≥ quando editar conte√∫do j√° postado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Est√° fixando o value para um default e n√£o permitindo altera√ß√µes. Mesma coisa para o URL da fonte.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se os ids s√£o √∫nicos, n√£o h√° necessidade de concatenar os dois ids.
> > </pull_363_fix(content): error in localStorage>

<pull_365_Nova tentativa para consertar bug do localStorage>
Isso √© a continua√ß√£o do PR #363 do @andreghisleni para for√ßar o deploy da Vercel numa nova URL.
</pull_365_Nova tentativa para consertar bug do localStorage>

<pull_366_feat(content): adjust validator function and create findChildrenCount function>
Created the function that counts how many children a content has recursively. tests have been
adjusted to test this new functionality.

#333
OBS: Ao adicionar a nova funcionalidade e rodar os testes, apenas os do children falharam. Ou seja, os testes de conte√∫dos raiz n√£o est√£o testando caso tenha um dado a mais no JSON, apenas se tem a menos.

> > Review de filipedeschamps (CHANGES_REQUESTED):
> > Excelente implementa√ß√£o e o ponto sobre os testes reclamarem quando h√° um campo novo eu concordo 100%! Daqui para frente toda refatora√ß√£o de testes deveria ter isso como boa pr√°tica ü§ù
> > Em paralelo, fiz algumas sugest√µes para tentar manter o `children_count` igual entre os tipos de visualiza√ß√µes que um objeto `content` possa ter üëç
> > Review de tembra (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de tembra (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de tembra (COMMENTED):
> > Review de EmanoelCristhian (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Tava pensando aqui, talvez isso devesse ficar dentro do `content.findAll()`, uma vez que est√° sendo mesclado ao objeto um dado muito importante e que vai precisar existir em v√°rios pontos da aplica√ß√£o e n√£o somente dentro desse controller. Por exemplo:

```
/api/v1/contents/[username]/[slug]  - est√° retornando o `children_count`
/api/v1/contents/ - n√£o est√° retornando o `children_count`
```

Isso vai pesar entre a aplica√ß√£o e o banco, pois para cada linha do `findAll()` vamos precisar bater de novo no Banco, mas para agora n√£o vamos nos preocupar com otimiza√ß√£o.

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Nossa, excelente altera√ß√£o!
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Muito delicinha as duas linhas adicionadas nessa implementa√ß√£o, por√©m o comportamento n√£o vai ficar igual ao resultado obtido pelo `findChildrenCount()`, uma vez que ele s√≥ ir√° somar os filhos diretos (e n√£o ir√° considerar o n√∫mero de sub-filhos numa √°rvore profunda).
> > Tanto que isso √© revelado pelos testes, que em resumo hoje est√£o fazendo o assertion considerando isso como resultado:

```js
[
  {
    "id": "fdbcbe30-c6bb-4e1f-b5a2-402b7f096236",
    "children_count": 1
    "children": [
      {
        "id": "3fb91d2e-0049-4845-8dd6-4e13e58f3655",
        "children_count": 1
        "children": [
          {
            "id": "8662cc5e-da61-4468-aa4d-c86289920e2c",
            "children_count": 0
            "children": [
            ],
          }
        ],
      }
    ],
  }
]
```

Quando deveria ser:

```js
[
  {
    "id": "fdbcbe30-c6bb-4e1f-b5a2-402b7f096236",
    "children_count": 2   // Esse conte√∫do tem 2 children
    "children": [
      {
        "id": "3fb91d2e-0049-4845-8dd6-4e13e58f3655",
        "children_count": 1
        "children": [
          {
            "id": "8662cc5e-da61-4468-aa4d-c86289920e2c",
            "children_count": 0
            "children": [
            ],
          }
        ],
      }
    ],
  }
]
```

Isso fariam os resultados de `children_count` ficarem diferentes entre voc√™ consultar a √°rvore pelo n√≥ do `root` ou diretamente o objeto de um `content`.

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Dado as outras considera√ß√µes, talvez a gente n√£o deveria exportar essa fun√ß√£o por enquanto.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Esse foi o detalhe que apontei no review no arquivo do model sobre a gera√ß√£o da √°rvore ter que considerar os `children` de forma `deep`.
> > Coment√°rio de tembra (linha de c√≥digo):
> > @filipedeschamps acredito que podemos melhorar essa sem√¢ntica.
> > O que voc√™ acha de renomearmos o `children_count` para algo como `children_deep_count` ou `children_recursive_count` ou ainda cham√°-lo de `interactions` ?
> > Do jeito que est√° causa esse tipo de confus√£o, principalmente para quem for consumir a API no futuro, tendo em vista que temos o `children` com `length` (que em algumas linguagens √© chamado de `count`) igual a `1` e o `children_count` ser√° igual a `2`.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Tembra, interessant√≠ssimo. Essa diferen√ßa poderia at√© ser usada na interface para quando quisermos esconder os coment√°rios ap√≥s um certo n√≠vel e mostrar quantos coment√°rios diretos existem.
> > O que estou me perguntando √© se a propriedade deveria respeitar a modelagem no banco, dado que todo `child`, independente do n√≠vel, faz parte do grupo `children`. Ent√£o talvez deveria ser o contr√°rio e os `children` diretos deveriam ser `children_shallow_count`, mas isso confunde a sem√¢ntica como voc√™ apontou (a diferen√ßa entre filhos diretos e o valor encontrado no count que pode ser maior).
> > Dos nomes que voc√™ sugeriu, o que me fez entender sem pensar muito foi o `children_deep_count` ü§ù
> > O que acha @EmanoelCristhian ? De deixarmos o `children_count` com o valor de filhos diretos, e o `children_deep_count` que soma toda a √°rvore embaixo de um n√≥. Lembrando que toda vez que um objeto `content` estiver presente, essas propriedades tamb√©m precisar√£o estar presentes.
> > Coment√°rio de tembra (linha de c√≥digo):
> > De deixarmos o `children_count` com o valor de filhos diretos
> > Realmente ele precisaria existir? Tendo em vista que (no JavaScript) um `children.length` obt√©m o mesmo resultado.
> > Por outro lado o `children_deep_count` j√° exige um certo processamento devido a intera√ß√£o recursiva, a qual estaria sendo executada direto no banco de dados.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Eu me perguntei a mesma coisa, mas da√≠ comecei a perguntar duas coisas:

1. Qualquer tipo de client (em qualquer tecnologia) pode ser constru√≠do e cima da API, e talvez ter esse n√∫mero computado seja uma m√£o na roda.
2. Na lista de contents `/api/v1/contents` a propriedade `children` n√£o √© retornada (inclusive tava pensando at√© que o `body` nesse caso n√£o deveria ser retornado, mas isso fica pra outra thread) e da√≠ nesse caso o client pode decidir o que achar mais justo mostrar (shallow ou deep).
   Mas posso estar over engineering ü§ù
   > > Coment√°rio de tembra (linha de c√≥digo):
   > > 2\. Na lista de contents `/api/v1/contents` a propriedade `children` n√£o √© retornada
   > > Parei de ler aqui üòÖ Voc√™ me convenceu hehe.
   > > Por mim fechado. Devemos ter o `children_count` e o `children_deep_count`.
   > > inclusive tava pensando at√© que o `body` nesse caso n√£o deveria ser retornado
   > > Concordo total. Tr√°fego de dados desnecess√°rio. Acredito que o objetivo deste endpoint seja apenas listar. Na outra thread poder√≠amos abrir para discuss√£o o fato de torn√°-lo opcional, trazendo a informa√ß√£o apenas mediante o preenchimento de um par√¢metro via query string, como `with=body` ou `body=true`.
   > > Coment√°rio de EmanoelCristhian (linha de c√≥digo):
   > > @filipedeschamps @tembra, eu concordo totalmente com voc√™s.
   > > Essa task me fez bugar um pouco quando eu pensei se era para eu retornar os filhos diretos ou todos os filhos de tal content.
   > > Irei ajustar os c√≥digos de acordo com o que foi acordado aqui!
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Show de bola @EmanoelCristhian ! A gente vai se bugando juntos at√© chegar numa conclus√£o ü§ù e fico muito feliz com sua contribui√ß√£o, pois isso me possibilita nesse exato momento estar trabalhando no PR sobre o reset de senha üëç
   > > </pull_366_feat(content): adjust validator function and create findChildrenCount function>

<pull_367_refactor(Content): and minor fixes in localStorage>
Considerando qua ainda haviam alguns problemas menores relacionados com o localStorage, aproveitei para fazer uma refatora√ß√£o no componente Content.
Lembrando que esse componente √© renderizado para cada post na tela, portanto, qualquer problema de performance nele √© multiplicado pelo n√∫mero de mensagens na p√°gina. Com isso em mente, foram eliminadas as leituras excessivas ao localStorage.
Tamb√©m foi resolvido um bug que ocorria ao fazer edi√ß√£o de um post root em diferentes abas deixando o dado em localStorage inconsistente.
Dessa forma, estou publicando a PR para que seja **avaliada com calma**, pois realmente n√£o cont√©m nada urgente.
As mudan√ßas est√£o relatadas abaixo:

### Refatora√ß√£o

#### 1) Remo√ß√£o de c√≥digo duplicado e mudan√ßa de escopo:

- `useUser` (agora est√° s√≥ no componente pai Content)
- `localStorageKey` (agora est√° s√≥ no componente `EditMode`)

#### 2) Troca de `useRef` por `useState` e reformula√ß√£o dos que j√° usavam `useState` dentro do componente `EditMode`.

**Saem**:

- `titleDefaultValue` e `setTitleDefaultValue`,
- `sourceUrlDefaultValue` e `setSourceUrlDefaultValue`,
- `body` e `setBody`,
- `titleRef`
- `sourceUrlRef`
  **Entram**:

- `newData` e `setNewData`

#### 3) `handleChange`:

- N√£o estava muito clara a maneira como eram atualizadas as vari√°veis e o localStorage no modo de edi√ß√£o. Isso estava dificultando entender os BUGs que apareceram anteriormente.
- Agora ocorre tudo dentro da nova fun√ß√£o `handleChange`, que at√© ficou mais simples que a antiga.
- Tamb√©m n√£o h√° mais necessidade do `useEffect` monitorando altera√ß√µes em `handleChange` e `body`.

#### 4) `handleSubmit`:

- Alteradas vari√°veis `title`, `boby` e `sourceUrl` que agora puxam os dados de `newData` ao inv√©s de `useRef`.
- Mudan√ßa na ordem em que o item postado com sucesso √© removido de `localStorage`.

#### 5) `handleCancel` - Centralizada em uma fun√ß√£o as a√ß√µes necess√°rias ao cancelar uma edi√ß√£o de conte√∫do:

- Mensagem de confirma√ß√£o avisando sobre a perda de dados n√£o salvos.
- Limpeza dos erros
- Limpeza do `localStorage`
- Mudan√ßa do modo do componente para `'view'` ou `'compact'` de acordo com o caso.

#### 6) O autofoco do t√≠tulo ao abrir edi√ß√£o em conte√∫do root:

- Era feito atrav√©s de `useRef` e foi mudado para a propriedade `autoFocus={true}` no input.
- Executa exatamente a mesma fun√ß√£o, mas agora de maneira mais simples e transparente.
- Obriga a deixar o aviso do lint lembrando que em alguns casos isso pode atrapalhar a acessibilidade. Informa√ß√£o importante que ficava mascarada da outra forma.

#### 7) `onChange={handleChange}`:

- Altera√ß√µes em quaisquer inputs chamam essa √∫nica fun√ß√£o, facilitando a an√°lise do c√≥digo.

### Mudan√ßas na l√≥gica do localStorage

#### 1) `localStorageKey` - Defini√ß√£o da vari√°vel

- Foi invertida a ordem dos condicionais para priorizar usar o id antes de parent_id (se a postagem j√° existir, ir√° utilizar o pr√≥prio id e n√£o o do pai). Da forma como estava, iria gerar a mesma Key para a edi√ß√£o de dois filhos diferentes, pois usaria o id do pai.
- Al√©m disso, da maneira como estava, nunca entraria na condi√ß√£o abaixo que era mais restrita que a primeira. Na verdade essa condi√ß√£o nem √© necess√°ria:
  `` else if (contentObject?.parent_id && contentObject?.id) {
       return `content-edit-child-${contentObject.parent_id}-${[contentObject.id](http://contentobject.id/)}`;
} ``
- Se a Key √© baseada no id √© porque √© uma edi√ß√£o de conte√∫do j√° existente, seja pai ou filho n√£o faz diferen√ßa, ent√£o faz sentido o padr√£o `content-edit-${contentObject.id}`
- Se a Key for baseada no `parent_id` √© porque √© um novo conte√∫do filho, ent√£o faz mais sentido usar "content-new" e n√£o "content-edit": `content-new-parent-${contentObject.parent_id}`
- E por fim ser√° usada a Key `content-new` se for um novo conte√∫do root.

#### 2) localStorage - Leituras e grava√ß√µes

- Agora s√≥ √© lido na fun√ß√£o `loadLocalStorage` que s√≥ executa uma vez quando o conte√∫do √© renderizado no modo de edi√ß√£o e, se estiver nesse modo, a cada vez que a aba do navegador entrar em foco (para atualizar caso ocorra edi√ß√£o em mais de uma aba ao mesmo tempo). Antes era acessado tamb√©m em cada conte√∫do no modo compacto, ou seja, em cada conte√∫do renderizado. Era lido tamb√©m em algumas outras situa√ß√µes ao inv√©s de ler diretamente das vari√°veis de estado.
- N√£o √© lido mais no modo compacto, ent√£o n√£o ir√° abrir o modo de edi√ß√£o automaticamente caso tenha sido fechado o navegador sem submeter o conte√∫do, mas caso se tente fazer nova postagem, o rascunho ser√° recuperado. Obs. Acho interessante o conte√∫do salvo em localStorage, e pendente de submiss√£o, ser renderizado j√° no modo de edi√ß√£o caso seja aberta nova aba ou reinicializado o navegador, mas essa verifica√ß√£o do localStorage pode ser feita uma √∫nica vez em um componente superior ao inv√©s de a cada conte√∫do renderizado. Ent√£o o componente superior j√° aciona o Content com o modo edit selecionado, ou seja, √© uma altera√ß√£o para ser feita em outro escopo.
- Para sincronizar as altera√ß√µes em diferentes abas √© utilizado um EventListener('focus') dentro de apenas conte√∫dos que est√£o sendo editados. O listener sempre √© descartado ao desmontar o componente de edi√ß√£o. Esse listener evita que o conte√∫do em localStorage fique inconsistente em caso de altera√ß√µes parciais em cada aba (pode ficar com o t√≠tulo de uma e o corpo de outra aba, por exemplo).
- A grava√ß√£o em localStorage agora ocorre dentro da fun√ß√£o `handleChange` e sem necessitar de uma leitura antes de gravar.
  </pull_367_refactor(Content): and minor fixes in localStorage>

<pull_368_Refatora√ß√£o do componente `Content`>
PR para for√ßar deploy em Preview do PR #367 feito por @aprendendofelipe

> > Review de filipedeschamps (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > N√£o precisa alterar nesse PR, mas dado o comportamento do `null` na API, acredito que daqui para frente a gente deveria usar o `null` como valor n√£o definido.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Isso, nas edi√ß√µes de conte√∫dos j√° postados e que continham um source_url n√£o nulo antes da edi√ß√£o, caso o campo passe a ficar vazio, agora √© enviado `null` para for√ßar a exclus√£o. Para title e body, que s√£o obrigat√≥rios, √© preciso enviar `''` para obter as respostas de erro corretamente.
> > `''` -> `"campo" n√£o pode estar em branco.` > > `null` -> `"campo" possui o valor inv√°lido "null".`
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > @aprendendofelipe voc√™ est√° mais s√™nior do que eu na API do TabNews üòÇ sensacional, matou a pau ü§ù
> > </pull_368_Refatora√ß√£o do componente `Content`>

<pull_370_Refatora√ß√£o do componente `Content`>
PR para for√ßar deploy em Preview do PR #368 feito por @aprendendofelipe
</pull_370_Refatora√ß√£o do componente `Content`>

<pull_373_build(dependencies): update all `bytemd` dependencies>
Depois de [abrir essa issue](https://github.com/bytedance/bytemd/issues/183) no reposit√≥tio do ByteMD, foi implementado o plugin **Continue List** e agora temos o mesmo comportamento do GitHub quando estamos criando listas, que √© o editor automaticamente adicionar o pr√≥ximo item da lista:
</pull_373_build(dependencies): update all `bytemd` dependencies>

<pull_374_Recupera√ß√£o de Senha>
Dando continuidade ao PR #358 de @gabrielew onde iniciei fazendo o squash dos commits e agora vou levar a feature at√© ao final e seguindo as sugest√µes que apareceram na issue de controle #324

> > Review de gabrnunes (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de gabrnunes (COMMENTED):
> > Coment√°rio de gabrnunes (linha de c√≥digo):
> > ser√° que n√£o √© legal colocar esse endere√ßo em uma constant global? ou at√© o texto inteido do e-mail
> > Coment√°rio de gabrnunes (linha de c√≥digo):
> > Pq foi decidido criar o component aqui dentro da p√°gina? n√£o fica mais organizado abstrair isso em uma pasta de Components?
> > Coment√°rio de gabrnunes (linha de c√≥digo):
> > o Google provavelmente vai indexar essa p√°gina /recuperar/confirmar, seria interessante ter um `no-index` aqui
> > Coment√°rio de gabrnunes (linha de c√≥digo):
> > mesma coisa aqui sobre a indexa√ß√£o do Google
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > √ìtimo ponto, mas s√≥ faria essa abstra√ß√£o quando ela fosse necess√°ria e quando esse componente se comportasse de uma forma que possa ser reutilizado em outros locais. Precisamos organizar uma forma melhor e integrada de lan√ßar mensagens globais.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > N√£o sei se o Github engoliu minha mensagem, mas ela n√£o aparece mais aqui para mim. Mas pelo que lembro, escrevi que concordo, mas que n√£o farei isso nesse PR e que √© f√°cil de fazer esse tipo de substitui√ß√£o de string, basta encontrarmos o lugar certo para colocar essa abstra√ß√£o ü§ù
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Excelente! Voc√™ sabe se √© poss√≠vel fazer isso pela p√°gina, ou s√≥ pelo `robots.txt`?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Repito aqui a d√∫vida sobre fazer isso pela p√°gina ou `robots.txt` üëç
> > Coment√°rio de gabrnunes (linha de c√≥digo):
> > D√° sim, √© s√≥ colocar a metatag `<meta name="robots" content="noindex">`
> > </pull_374_Recupera√ß√£o de Senha>

<pull_378_Refatora√ß√£o do componente `Content`>
PR para for√ßar deploy em Preview do PR #370 feito por @aprendendofelipe

> > Review de aprendendofelipe (COMMENTED):
> > Oi @andreghisleni, n√£o estava mais abrindo automaticamente o editor por quest√£o de performance e tamb√©m sugest√£o do @filipedeschamps aqui: https://github.com/filipedeschamps/tabnews.com.br/pull/364#issuecomment-1133787257
> > Talvez seja interessante removermos o recurso de automaticamente abrir o modo de edi√ß√£o se for encontrado algo no localStorage e s√≥ se focar em carregar essas informa√ß√µes quando entrar nesse modo de fato, seja pelo clique no bot√£o, ou seja por esse ser o modo padr√£o de um conte√∫do `root`. O que acham?
> > Acho que a sugest√£o foi mais por causa do bug que estava ocorrendo naquele momento, mas pensei na quest√£o de performance eu achei v√°lida.
> > Por isso o acesso ao localStorage tinha sido movido para dentro do componente EditMode, para s√≥ ocorrer um acesso nos componentes j√° renderizados em modo de edi√ß√£o (ao clicar em "editar", "responder" ou Publicar novo conte√∫do") ao inv√©s de ocorrer um acesso a cada "conte√∫do" ou "bot√£o de responder" que for renderizado.
> > Pela experi√™ncia do usu√°rio eu acho super v√°lida a funcionalidade de abrir o modo de edi√ß√£o automaticamente sempre que carregar um conte√∫do que contenha rascunho no loacalStorage, mas acredito que seja melhor essa decis√£o de iniciar o componente em modo de edi√ß√£o ser tomada por quem chama o componente Content, n√£o dentro dele, pelo custo que a leitura do localStorage traz.
> > No caso de conte√∫do root novo, ele sempre √© carregado em modo de edi√ß√£o, ent√£o j√° vai ser carregado o rascunho.
> > No restante das altera√ß√µes eu n√£o percebi nenhum impacto positivo em utilizar useCallback nessas fun√ß√µes, j√° que elas n√£o s√£o passadas para outros componentes. Se tem algo que eu n√£o estou enxergando, me d√™ uma clareada, por favor.
> > Por enquanto acredito que a vers√£o do link abaixo est√° legal:
> > https://tabnews-git-refactor-content-preview3-tabnews.vercel.app/
> > Review de aprendendofelipe (COMMENTED):
> > Edit: Tinha colocado resultados incorretos nos testes.
> > Agora a quest√£o de utilizar o useCallback √© principalmente quest√£o de boas praticas, alem de evitar o recarregamento desnecess√°rio
> > @andreghisleni, o useCallback evita a redefini√ß√£o da fun√ß√£o a cada renderiza√ß√£o do componente onde ela √© definida. Isso √© mais √∫til para n√£o causar o recarregamento de outros componentes que dependem da fun√ß√£o. Mas em EditMode n√£o temos outros componentes que dependem dessas fun√ß√µes, ent√£o a redefini√ß√£o n√£o causa nenhuma renderiza√ß√£o extra.
> > Se quando diz recarregamento voc√™ est√° falando da redefini√ß√£o das fun√ß√µes, ent√£o sim, isso pode ser reduzido mesmo no nosso caso. Fiz um teste para ter n√∫meros para comparar os casos com e sem useCallback.
> > Utilizei esse c√≥digo:

```
...
var funcCount = new Set()
export default function Content({ content, mode = 'view', viewFrame = false }) {
...
...
  function EditMode() {
...
...
    funcCount.add(loadLocalStorage);
    funcCount.add(clearErrors);
    funcCount.add(handleSubmit);
    funcCount.add(handleChange);
    funcCount.add(handleCancel);
    console.log("Count: ", funcCount.size);
...
```

#### N√∫mero de redefini√ß√µes de fun√ß√µes em cada caso

| Commit                                 | https://github.com/filipedeschamps/tabnews.com.br/pull/378/commits/ee49e9e04518412e6a896b3130e916f4cab5b2c6 | https://github.com/filipedeschamps/tabnews.com.br/pull/378/commits/0245a731706726bf3a776cdc9d47c9b0595a1027 | \_                                  |
| -------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ----------------------------------- |
| A√ß√£o \ useCallback                     | Sem                                                                                                         | Com                                                                                                         | Fun√ß√µes redefinidas com useCallback |
| Ao clicar em responder                 | 5                                                                                                           | 5                                                                                                           | Defini√ß√£o inicial de todas as 5     |
| Ao navegar para publicar novo conte√∫do | 15                                                                                                          | 15                                                                                                          | Cada uma 3 vezes                    |
| No primeiro d√≠gito escrito             | 10                                                                                                          | 2                                                                                                           | handleSubmit e hancleCancel         |
| A cada d√≠gito extra                    | 5                                                                                                           | 2                                                                                                           | handleSubmit e hancleCancel         |
| Ao voltar o foco para a aba            | 5                                                                                                           | 2                                                                                                           | handleSubmit e hancleCancel         |

Imagino que cada redefini√ß√£o seja menos custosa sem o useCallback, ent√£o para as renderiza√ß√µes iniciais o caso sem useCallback deve ser um pouco mais r√°pido. Mas, ap√≥s o carregamento, durante a digita√ß√£o do conte√∫do, ocorrem menos redefini√ß√µes das fun√ß√µes com o useCallback. Ent√£o isso me convence de que √© melhor utiliz√°-lo.
S√≥ vou dar uma analisada melhor depois se n√£o podemos diminuir as vari√°veis no array de depend√™ncias de alguma delas. Acho que consigo fazer isso amanh√£ e dou um retorno aqui.
Agora se est√° lhe incomodando muito o fato de n√£o estar entrando automaticamente no modo de edi√ß√£o, acho mais interessante fazer essa mudan√ßa em outro componente. Vamos conversar mais sobre isso.ü§ù

> > Review de andreghisleni (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > @filipedeschamps considerando a revis√£o dos testes, pode fazer o merge na main com todos os commits dessa PR.
> > O @andreghisleni colocou de volta a funcionalidade de abrir a edi√ß√£o automaticamente quando encontrar rascunho no localStorage para o caso de edi√ß√£o de conte√∫do j√° postado. S√≥ n√£o abre automaticamente para novas respostas deixadas em rascunho, mas se clicar em responder, o rascunho estar√° l√°.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Pronto agora adicionei a verifica√ß√£o de que se a publica√ß√£o √© do pr√≥prio usu√°rio antes de buscar no localstorage.
> > Opa @andreghisleni, isso n√£o funciona para todos os casos! S√≥ vai abrir o modo de edi√ß√£o para as altera√ß√µes de conte√∫dos j√° postados. N√£o vai funcionar para rascunhos de novas postagens em resposta de outro conte√∫do.
> > Coment√°rio de andreghisleni (linha de c√≥digo):
> > Pois √© eu percebi que n√£o funciona para todos os casos, mas pelo menos na edi√ß√£o ele funciona
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ent√£o vamos deixar assim, funcionando parcialmente e futuramente podemos corrigir.
> > </pull_378_Refatora√ß√£o do componente `Content`>

<pull_383_Melhorias de tags para SEO e redes sociais>
Melhorar forma como a tag `metadata` funciona, agora ela aceita os par√¢metros:

```js
{
  title, // para modificar o t√≠tulo da p√°gina, caso necess√°rio.
    description, // para modificar a descri√ß√£o da p√°gina, caso necess√°rio (ainda n√£o √© usado)
    image, // para modificar a imagem de compartilhamento, por padr√£o carrega uma que eu criei
    noIndex; // para definir se a p√°gina n√£o deve ser indexada
}
```

CLOSES https://github.com/filipedeschamps/tabnews.com.br/issues/337

> > Review de filipedeschamps (CHANGES_REQUESTED):
> > Contribui√ß√£o sensacional meu caro, muito obrigado!
> > Coloquei alguns coment√°rios nas linhas, e adicional a isso, dois pontos:

1. Sugiro fazer os commits em ingl√™s
2. Uma das ideias que tive √© deixar o `BaseLayout` como um layout "t√©cnico", vamos dizer assim. Por isso de remover inclusive o `content` dele e outras regras. Talvez quanto mais t√©cnico ele ficar em pegar as informa√ß√µes e renderizar nas tags, melhor. E o `DefaultLayout` serviria para massagear as informa√ß√µes antes de enviar para o `BaseLayout`, como por exemplo, formar os t√≠tulos, sempre concatenar o `¬∑ TabNews`, ou at√© talvez os `defaultMetadata` deveriam ser passados para l√°. Outro exemplo, talvez o `title` e `description` da Home n√£o deveriam ficar em nenhum dos dois Layouts, e sim na p√°gina `pages/index.public.js` Na verdade o `title` j√° est√° l√°, faltaria a `description`.
   O que acha?
   > > Review de gabrnunes (COMMENTED):
   > > Review de gabrnunes (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de gabrnunes (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Review de gabrnunes (COMMENTED):
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Dois detalhes:
3. O endere√ßo base do TabNews √© com `www`
4. Um dos problemas de hardcode o endere√ßo, √© que ele muda conforme o ambiente que estiver acessando (principalmente Homologa√ß√£o vs Produ√ß√£o). Talvez seja melhor usar o m√©todo `getHost()` do `webserver.js`:
   https://github.com/filipedeschamps/tabnews.com.br/blob/76e613fee1aba6183b391b6873a2f8c3ec8098f2/infra/webserver.js#L1
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Delicinha
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Meu medo de assumir um `default` para esse valor √© ter v√°rias p√°ginas com a mesma descri√ß√£o. Talvez remover o valor padr√£o e s√≥ renderizar a tag se algu√©m manualmente definir ela.
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Aqui tamb√©m sobre o default üëç
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > O que acha de ao inv√©s de compor o endere√ßo da URL da imagem padr√£o (`${siteUrl}${image}`) dentro da tag, definir ela como default j√° l√° em cima e usar o valor composto nas tags sobre imagem?
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Faltou concatenar `¬∑ TabNews`
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Faltou concatenar `¬∑ TabNews`
   > > Coment√°rio de gabrnunes (linha de c√≥digo):
   > > Boa! At√© procurei se tinha isso definido em algum lugar mas n√£o achei. Vou substituir.
   > > Coment√°rio de gabrnunes (linha de c√≥digo):
   > > Na verdade, na linha 16 eu concateno o ` ¬∑ TabNews` para qualquer t√≠tulo, faz sentido?
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Ahhh perfeito!! Faz total sentido ü§ù
   > > Coment√°rio de gabrnunes (linha de c√≥digo):
   > > @filipedeschamps tava relendo esse coment√°rio aqui e fiquei com uma d√∫vida. Sua sugest√£o √© que a pessoa sempre envie dentro do `metatag` a url completa da imagem, sem que seja preciso verificar se ela tem ou n√£o a url completa, √© isso?
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Desculpa n√£o ter sido claro, eu lendo a minha resposta ali em cima n√£o entendi nada do que escrevi e acho que tenho uma sugest√£o melhor:
   > > A id√©ia seria resolver o valor final da imagem l√° no topo da fun√ß√£o e apenas descer para a tag o valor em `image`. Assim n√£o vai ser preciso repetir essa condicional em toda tag respons√°vel por imagem. Faz sentido?
   > > Coment√°rio de gabrnunes (linha de c√≥digo):
   > > Boa, foi isso que eu fiz ali na altera√ß√£o. Valeu @filipedeschamps t√° contigo agora re-revisar hahaha
   > > </pull_383_Melhorias de tags para SEO e redes sociais>

<pull_385_Refatora√ß√£o do componente `Content`>
PR para for√ßar deploy em Preview do PR #378 feito por @aprendendofelipe e @andreghisleni
</pull_385_Refatora√ß√£o do componente `Content`>

<pull_386_Atualiza README com vers√£o m√≠nima do Node.js>
Close #380
</pull_386_Atualiza README com vers√£o m√≠nima do Node.js>

<pull_389_fix: gap between number and item in ContentList>

## ü§î Por que voc√™ est√° abrindo esse Pull Request?

- Eu estou resolvendo um problema visual do gap entre o numero e o titulo do conte√∫do na ContentList que fica na home.

## üßê Descreva sua solu√ß√£o:

- Eu aumentei o gap, mas acredito que poder√≠amos ter uma solu√ß√£o melhor para isso no futuro, em breve vamos ter mais posts e essa solu√ß√£o n√£o vai escalar.
  | Before | After |
  | ------ | ----- |
  | | |
  </pull_389_fix: gap between number and item in ContentList>

<pull_391_Melhorias de tags para SEO e redes sociais #383>
Este √© um PR intermedi√°rio do PR #383 feito por @gabrnunes para for√ßar o deploy ü§ù
</pull_391_Melhorias de tags para SEO e redes sociais #383>

<pull_392_fix: css of ContentList in home scan and semantic tags>

## ü§î Por que voc√™ est√° abrindo esse Pull Request?

- Arrumando o scan e o alinhamento da listagem da home

## üßê Descreva sua solu√ß√£o:

- S√≥ troquei pra Grid \o/
  | Before | After |
  | ------ | ----- |

  > > Review de omariosouto (COMMENTED):
  > > Review de filipedeschamps (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de filipedeschamps (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de filipedeschamps (COMMENTED):
  > > Review de gabrnunes (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de filipedeschamps (COMMENTED):
  > > Coment√°rio de omariosouto (linha de c√≥digo):
  > > Aqui seria legal ter um reset CSS no projeto, pra poder usar tags semanticas e n√£o s√≥ div pra tudo
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > Ahh que interessante a abordagem do `as` nesse caso üëç o que me fez pensar se o `content="website"` est√° certo ou deveria ser algo como `article`. O que acha @gabrnunes ?
  > > https://github.com/filipedeschamps/tabnews.com.br/blob/d4d8717c8973df1786ec4a3329065ba1601ce72d/pages/interface/components/BaseLayout/index.js#L15
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > Em paralelo, ser√° que faz sentido ter tantos `h1` numa p√°gina?
  > > Coment√°rio de omariosouto (linha de c√≥digo):
  > > Pro tab news acho que o article √© o melhor aproach pq ai os coment√°rios ficam articles dentro do article e eu lembro de ter lido em algum canto que √© o que "imaginaram" quando saiu a tag
  > > Coment√°rio de omariosouto (linha de c√≥digo):
  > > @filipedeschamps como a gente ta usando article, tudo bem ter multiplos h1s pq ele conta como um escopo por si s√≥:
  > > "Quando um elemento `<article>` est√° aninhado, o elemento interior representa um artigo relacionado com o elemento exterior. Por exemplo, os coment√°rios do post de um blog podem ser elementos `<article>` aninhados em `<article>` representando o post do blog."
  > > Fonte: https://developer.mozilla.org/pt-BR/docs/Web/HTML/Element/article
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > Show! Na cita√ß√£o que voc√™ colocou eu n√£o entendi como que isso faz fazer sentido ter m√∫ltiplos t√≠tulos principais numa p√°gina, mas tamb√©m n√£o invalida üòÇ o que acho muito interessante da descri√ß√£o √© como isso pode ser usado dentro de uma p√°gina de conte√∫do mesmo para envolver os coment√°rios üëç
  > > Coment√°rio de omariosouto (linha de c√≥digo):
  > > @filipedeschamps opa, perd√£o! da uma olhada aqui nesse exemplo da spec do HTML:

- https://html.spec.whatwg.org/#the-article-element
  > > Coment√°rio de omariosouto (linha de c√≥digo):
  > > A estrutura pra mim √© total o tabnews \o/
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > 100% total!!! √â que o `ContentList` renderiza a lista que est√° na Home por exemplo. Acho que o que voc√™ est√° propondo √© fazer esse ajuste no componente `Content` ou na verdade na p√°gina: https://github.com/filipedeschamps/tabnews.com.br/blob/main/pages/%5Busername%5D/%5Bslug%5D/index.public.js
  > > Coment√°rio de gabrnunes (linha de c√≥digo):
  > > Boa! Depois vou ajustar l√° ent√£o.
  > > Coment√°rio de omariosouto (linha de c√≥digo):
  > > @filipedeschamps vou ver o que seria o melhor cen√°rio aqui e trago num pr√≥ximo PR ü§ù
  > > Coment√°rio de omariosouto (linha de c√≥digo):

```suggestion
            <Box as="h1">
```

> > Coment√°rio de omariosouto (linha de c√≥digo):

```suggestion
            <Box>
```

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > @omariosouto vou fazer o merge, e depois vamos avaliar se um item da lista √© um `article` tamb√©m ou se s√≥ vale para o artigo de fato ü§ù
> > </pull_392_fix: css of ContentList in home scan and semantic tags>

<pull_397_build(node.js): changes Node.js version to v16 LTS>
Change Node.js version to v16 LTS due to issues with import Node.js modules with `node:` prefix that
wasn't supported in some v14 versions and below. Discussed in #380.
</pull_397_build(node.js): changes Node.js version to v16 LTS>

<pull_398_Implementa Pagina√ß√£o>
Aten√ß√£o: Este PR √© um Work In Progress.

---

Destaques do primeiro commit com foco no backend d86c421a4eec687fb6065969e74f38382341b090

1. Foco no endpoint `/api/v1/contents`
2. Novos query strings dispon√≠veis: `page` e `per_page`
3. Se voc√™ chamar o endpoint sem nada, os defaults ser√£o utilizados: `page=1` e `per_page=30`
4. Exemplo com outros valores: `/api/v1/contents?page=2&per_page=15`
5. Refiz a valida√ß√£o do `content.findAll()` para validar o `options` somente usando o `validator.js`
   Como os valores padr√£o s√£o aplicados no model `content`, isso automaticamente filtrou os √∫ltimos `30` conte√∫dos publicados no ambiente de Homologa√ß√£o: https://tabnews-git-pagination-tabnews.vercel.app/
   E se algu√©m quiser testar a API: https://tabnews-git-pagination-tabnews.vercel.app/api/v1/contents?page=1&per_page=2

---

Closes #339
Closes #341
Closes #343

> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Como a revalida√ß√£o ainda est√° em beta e tamb√©m por ter sido mantida a revalida√ß√£o das p√°ginas a cada 1 segundo, talvez seja bom envolver essa parte com um try catch.
> > </pull_398_Implementa Pagina√ß√£o>

<pull_402_fix(contentlist): fixing rerender on published since>

## Por que?

@filipedeschamps citou nesse coment√°rio que estava acontecendo um flickering: https://github.com/filipedeschamps/tabnews.com.br/pull/398#issuecomment-1140134049
| Antes | Depois |
| ----- | ------ |
| | |

## Solu√ß√£o

- Eu extrai a l√≥gica de montar o valor do tempo que passou para uma fun√ß√£o e fiz com que a p√°gina renderizasse baseado no initalState dela
- Nesse PR tamb√©m foi mergeado o PR #403
  > > Review de omariosouto (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de omariosouto (COMMENTED):
  > > Review de aprendendofelipe (DISMISSED):
  > > Perfect!
  > > Coment√°rio de omariosouto (linha de c√≥digo):

```suggestion
import React, { useState, useEffect } from 'react';
```

> > Coment√°rio de omariosouto (linha de c√≥digo):

```suggestion
import { useState, useEffect } from 'react';
```

> > Coment√°rio de omariosouto (linha de c√≥digo):
> > Removi aqui pq ningu√©m tava usando \o
> > </pull_402_fix(contentlist): fixing rerender on published since>

<pull_403_fix: add a scalable solution for ContentList items>

## Por que esse PR existe?

Meu primeiro PR aqui foi tentando ajustar isso, mas a solu√ß√£o que propus n√£o seria definitiva e ainda acabou faltando um gap depois de um outro pr üò¢
| Antes | Depois |
| ----- | ------ |

## Coment√°rio da solu√ß√£o

- Dado o cen√°rio de termos numeros vari√°veis o display table parece antiquado, mas √© exatamente o comportamento que parece que queremos aqui, o que acha @filipedeschamps?
  > > Review de aprendendofelipe (DISMISSED):
  > > itemCount üòç
  > > </pull_403_fix: add a scalable solution for ContentList items>

<pull_405_Conserta o "flicker" da data e posi√ß√£o do n√∫mero no ContentList>
Isso √© um PR intermedi√°rio do PR #402 de @omariosouto (que junta tamb√©m o PR #403) e serve para for√ßar o deploy na Vercel üëç

> > Review de aprendendofelipe (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        width: '100%',
        borderSpacing: '0 1rem',
```

</pull_405_Conserta o "flicker" da data e posi√ß√£o do n√∫mero no ContentList>

<pull_406_Conserta o "flicker" da data e posi√ß√£o do n√∫mero no ContentList>
Isso √© um PR intermedi√°rio do PR #405 de @omariosouto (que junta tamb√©m o PR #403), que teve a ajuda de @aprendendofelipe e serve para for√ßar o deploy na Vercel üëç
</pull_406_Conserta o "flicker" da data e posi√ß√£o do n√∫mero no ContentList>

<pull_407_Atualiza vers√£o do Node.js para 16 LTS>
PR intermedi√°rio do PR #397 criado por @tembra para atualizar a vers√£o do Node.js do projeto para 16 LTS.
</pull_407_Atualiza vers√£o do Node.js para 16 LTS>

<pull_413_fix(favicon): detect browser mode and use a different favicon>

## Por que? ü§îÔ∏è

O favicon do projeto estava utilizando uma imagem PNG com fundo branco. Tamb√©m n√£o era alterada conforme o tema do browser.
| Antes | Depois |
| ----- | ------ |
| | |

## Solu√ß√£o ü§óÔ∏è

- Alterei o PNG para transparente.
- Adicionei a l√≥gica para reconhecer o tema do browser e alterar o √≠cone conforme modo utilizado.
  </pull_413_fix(favicon): detect browser mode and use a different favicon>

<pull_415_Aceitar URL com TLDs maiores>
Hoje s√≥ √© considerada uma URL v√°lida se o TLD tiver entre 2 e 6 caracteres.
Proponho aceitar at√© 18 caracteres para n√£o barrar, por exemplo:
https://nic.northwesternmutual/
ou como citado em https://github.com/filipedeschamps/tabnews.com.br/issues/409#issue-1251934882
https://www.portaldev.digital/posts/o-que-e-html
</pull_415_Aceitar URL com TLDs maiores>

<pull_421_Nova proposta para Links da Pagina√ß√£o>
Ap√≥s feedback da comunidade, ficou evidente que eu tinha implementado os links da pagina√ß√£o ao contr√°rio. Ent√£o iniciei a implementa√ß√£o usando o componente oficial de pagina√ß√£o do Primer, mas ele n√£o possui tradu√ß√£o, ent√£o os links ficariam algo como `< Previous | Next >`. Mas sem problemas, refiz uma implementa√ß√£o do modo mais simples da navega√ß√£o deles (e usando as flechas do pacote oficial de √≠cones deles) e que reage a exist√™ncia ou n√£o de uma p√°gina:
E dado que agora n√£o possui somente mais um link para a pr√≥xima p√°gina, refatorei o par√¢metro `nextPageBasePath` para `paginationBasePath`.
</pull_421_Nova proposta para Links da Pagina√ß√£o>

<pull_422_feat(contents): only `unstable_revalidate` Home if it's a `root` content>
Somente atualiza a Home usando o `unstable_revalidate` se for um conte√∫do sem `parent_id`, ou seja, n√£o √© uma resposta e √© um conte√∫do que ir√° de fato aparecer na Home.
</pull_422_feat(contents): only `unstable_revalidate` Home if it's a `root` content>

<pull_424_Adiciona feature `update:content:others`>
Esse √© um PR intermedi√°rio do PR #412 feito por @LucasManto e que implementa a feature `update:content:others` que habilita um usu√°rio poder editar o conte√∫do de outros usu√°rios.
Closes #350
Closes #412
</pull_424_Adiciona feature `update:content:others`>

<pull_425_Problemas de overflow>
Corrige alguns problemas de responsividade, entre eles os relatados abaixo:
Responsividade em mobile. https://github.com/filipedeschamps/tabnews.com.br/issues/379
Falha no layout ao usar textos zalgo https://github.com/filipedeschamps/tabnews.com.br/issues/400
Bug ao dar hover nas labels da p√°gina "Status" https://github.com/filipedeschamps/tabnews.com.br/issues/417
Para as solu√ß√µes adotadas houve alguma altera√ß√£o de layout, como no encadeamento de respostas com menos espa√ßamento, ent√£o j√° aproveitei para propor a fixa√ß√£o do Header (altera√ß√£o facilmente revers√≠vel).
@omariosouto tive que retirar a `table` do ContentList, pois limitava algumas corre√ß√µes necess√°rias para impedir o estouro de textos grandes sem espa√ßo ou zalgo.
@filipedeschamps vi o PR #418, mas fiz uma mudan√ßa que n√£o desconfigura a p√°gina se surgir algum novo commit com texto muito longo. No m√°ximo o texto vai ficar cortado, mas vai aparecer completo pelo atributo `title` se mantiver o mouse sobre o texto. Em mobile simplesmente ir√° cortar o que sair da tela. Fiz o mesmo para o Autor e SHA, pois dependendo da tela tamb√©m poderia dar problema.
Vejam se est√£o de acordo. ü§ù

> > Review de omariosouto (DISMISSED):
> > Mas de todo caso a solu√ß√£o parece show segue meu approve, s√≥ ver o da galera \o
> > Review de aprendendofelipe (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > @filipedeschamps, olha essa linha 165
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Curiodisade: porque est√° sendo retornado um array aqui?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Isso continua precisando?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Excelente! Ent√£o pelo que eu entendi, tudo que tem `overflow: 'auto'` conserta o problema do texto zalgo?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Pra eu continuar entendendo a implementa√ß√£o para evitar textos zalgo: isso tem rela√ß√£o com o overflow do zalgo, ou √© s√≥ pra ficar menos estranho que usar um `display: 'table'` üòÇ ?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Para cada conte√∫do estamos retornando dois `Box` no `map` (`itemCount` e `contentObject`). Cada `Box` ocupa uma das duas colunas do `grid`. Ent√£o precisamos do `<React.Fragment key={itemCount + contentObject.id}>` para poder retornar mais de um filho.
> > Consequentemente:

1. N√£o podemos usar apenas `<>... ...</>`, pois precisamos da `key`;
2. Ent√£o precisamos adicionar o `import React from 'react'`;
3. A key precisa ser uma combina√ß√£o tanto do `itemCount` como `contentObject` para garantir sempre a atualiza√ß√£o de toda lista de conte√∫dos se um novo surgir no topo (sen√£o os antigos podem ficar com o n√∫mero errado);
   Como eu acho estranho todos esses 3 itens, me pareceu uma √≥tima oportunidade de seguir a dica que j√° vi o grande @diego3g usar mais de uma vez, que √© retornar um `array` no lugar do `Fragment`.
   O resultado √© exatamente o mesmo, mas achei mais elegante.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Sim:
   > > `overflow: 'auto'`: em telas com resolu√ß√µes muito pequenas, √© um quebra galho que d√° a op√ß√£o de rolar lateralmente o `Header` para ter acesso a todas as op√ß√µes. Logo precisaremos de uma `Sidebar` para esses casos.
   > > `width: '100%'`: para que, em qualquer situa√ß√£o que expanda a largura do `Box` principal, tamb√©m expandir o `Header`. A maioria dos casos que fariam isso ocorrer j√° s√£o resolvidos nesse PR, mas ainda ocorre, por exemplo, na p√°gina `status` ao girar o celular.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > N√£o somente o texto zalgo... Olhe o que a publica√ß√£o ["TesteTextoLongoSemEspa√ßos"](https://tabnews-git-remove-user-thumbnail-tabnews.vercel.app/fe1ipe/mais-um-teste) faz com a lista de conte√∫dos:
   > > https://tabnews-git-remove-user-thumbnail-tabnews.vercel.app/pagina/3
   > > Editei um teste antigo para n√£o quebrar a p√°gina 1.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Nesse caso n√£o √© por ficar estranho usar `display: 'table'` üòÇ, mas apenas para conseguir resolver os problemas de overflow.
   > > Resolvi manter somente os problemas de overflow nesse PR, pois foi justamente o que foi debatido com o mestre @omariosouto
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > A base original dessa branch era bem antiga. Ap√≥s o rebase o `width: '100%'` realmente n√£o √© mais necess√°rio. J√° fiz um novo rebase.
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Cara que AULA!!!!!! üòç üòç üòç üòç üòç üòç
   > > </pull_425_Problemas de overflow>

<pull_427_fix(content): check if `user` object have `feature` property>
No PR #424 eu adicionei um commit c761a04de084c2e448f6e27858d733fbc76b69b5 que fazia uma verifica√ß√£o se o objeto `user` possu√≠a a feature `update:content:others` e assumindo que o `user` sempre possui dentro dele um objeto de **usu√°rio** mesmo... mas infelizmente esse n√£o √© o caso.
Quando eu criei o hook `useUser` que √© o respons√°vel por preencher esse objeto, ao receber um `403` do `/user` ele preenche esse objeto com um objeto de **erro**. Ent√£o na verifica√ß√£o acima eu estava cegamente esperando que haveria uma propriedade `.features`, o que n√£o existe no objeto de erro.
Ent√£o isso estava fazendo qualquer p√°gina de conte√∫do quebrar caso o usu√°rio n√£o estivesse logado.
Eu adicionei um `?` para falhar a verifica√ß√£o, mas o `useUser` precisa ser mais sem√¢ntico nesse caso, principalmente no de verificar se o usu√°rio est√° logado ou n√£o, pois hoje estamos verificando as propriedades como `id` ou `username` e isso √© fr√°gil.
</pull_427_fix(content): check if `user` object have `feature` property>

<pull_429_feat(migrations): seed initial users>
Estou trabalhando na migration para a issue #348 e estou sofrendo alguns comportamentos estranhos do m√≥dulo de migra√ß√£o que usamos, tanto que no reposit√≥rio dele encontrei [essa issue sobre problemas ao usar o Node.js `16`](https://github.com/salsita/node-pg-migrate/issues/887). E notei que estava perdendo **muito tempo** criando usu√°rios em desenvolvimento, principalmente para testar a diferen√ßa entre rodar as migra√ß√µes pelo `cli` ou pelo endpoint da API.
Ent√£o para facilitar esse debug e seguir uma sugest√£o do @tembra (se eu n√£o me engano, foi ele ou outra pessoa), criei um script intermedi√°rio dentro do `npm run dev` para injetar dois usu√°rios, um com features padr√µes, e outro com features de admin.
Deve existir formas melhores de fazer o que foi feito, principalmente na parte que ignora o erro do insert se j√° existir esses usu√°rios na base ü§ù
</pull_429_feat(migrations): seed initial users>

<pull_430_style(components/content): altera fonte do tooltip do icone "FullScreen">
Foi alterada a fonte do tooltip FullScreen para as mesmas utilizadas no projeto.
Assim √© como estava:
Assim √© como ficou:
Foi feita essa mudan√ßa pra manter o padr√£o de est√©tica do projeto e mostrar o cuidado com os detalhes, at√© pra n√£o ficar algo gen√©rico ali tamb√©m.
</pull_430_style(components/content): altera fonte do tooltip do icone "FullScreen">

<pull_431_Remover ou Editar conte√∫dos de outros usu√°rios>
O plano inicial era ir parcialmente colocando a issue #348 em Produ√ß√£o, mas estou um pouco inseguro com a migration dado os motivos conversados [a partir desse coment√°rio](https://github.com/filipedeschamps/tabnews.com.br/issues/348#issuecomment-1144189645). Ent√£o mais do que nunca vou deixar ela pendurada aqui e ir fazendo os commits contra essa branch.
71e005c4ef047f5d00b129be3479c5a2ddfbfd77

- Habilitei novamente os logs do `migrator`.
- Fiz isso, pois agora temos um sistema de logs melhor para pesquisar/investigar.
  db0b0d4d394138be7bfb3457c1c5eb96972e115c

- Notei que na migration passada eu escolhi um nome de arquivo ruim, ent√£o nessa procurei melhorar.
- O padr√£o que pensei para esse caso foi `[create|alter]-table-[tablename]-[description]` o que resultou em `alter-table-contents-add-deleted-at-checks`
- Essa migration adiciona a coluna `deleted_at, altera a constraint dos valores que aceita e substitui a constraint de valores √∫nicos por um √≠ndice √∫nico.
  </pull_431_Remover ou Editar conte√∫dos de outros usu√°rios>

<pull_438_SEO(adding the article type)>

## ü§î Por que voc√™ est√° abrindo esse Pull Request?

- Adicionando o tipo article nos metadata's conforme Issue #393 conforme sugest√£o do @filipedeschamps e @gabrnunes

## üßê Descreva sua solu√ß√£o:

Primeiro verifico se a p√°gina √© um content, caso positivo retorno os par√¢metros necess√°rios para o novo tipo.
Segundo adicionei o prefixo `Em resposta a` se o content for uma resposta de um outro content.
| Antes | Depois |
| ----- | ------ |
| | |

> > Review de gabrnunes (COMMENTED):
> > Review de rodrigoKulb (COMMENTED):
> > Review de gabrnunes (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de gabrnunes (DISMISSED):
> > Coment√°rio de gabrnunes (linha de c√≥digo):
> > n√£o acha mais organizado essa fun√ß√£o ficar fora do componente em si?
> > Coment√°rio de rodrigoKulb (linha de c√≥digo):
> > Ou nem utilizar a function

```JS
updatedMetadata.title = `${content.body.replace(/\s+/g, ' ').substring(0, 80)} ¬∑ ${content.username}`;
```

> > Coment√°rio de gabrnunes (linha de c√≥digo):
> > "A fun√ß√£o nunca dar√° erro se voc√™ n√£o a usar" - Mestre Yoda
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Showw!!! Feito üòç
> > </pull_438_SEO(adding the article type)>

<pull_440_feat(use-user): use localStorage cached user>
Usando `localStorage` no lugar de `cookie`, atende ao [#336 `useUser()`: somente bater no endpoint se existir cookie indicando sess√£o ](https://github.com/filipedeschamps/tabnews.com.br/issues/336)
Fornece um `UserProvider`, onde o `useUser` somente verifica a sess√£o do usu√°rio se encontrar `user` no `localStorage`. Diminuindo as chamadas para a API quando √© certo que o usu√°rio n√£o est√° autenticado.
Provisoriamente (ou n√£o) foi inclu√≠da a verifica√ß√£o da sess√£o na tela de login, mesmo sem encontrar `user` no `localStorage`. Assim os usu√°rios que ainda n√£o acessaram a vers√£o nova n√£o precisar√£o realizar novo login.

> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > S√≥ aproveitando a edi√ß√£o do arquivo... Nem `next/router` e nem `Button` estavam sendo utilizados
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Assim renderiza o Menu com o `username` em `cache` sem esperar o t√©rmino do `fetch`.
> > `isLoading` permanece `true` enquanto `user` n√£o √© revalidado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Na tela de login o `user` √© revalidado independentemente de existir `cache`
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Usu√°rios com sess√£o ativa, mas que ainda n√£o tem cache da sess√£o no `localStorage` (primeiro acesso ap√≥s esse c√≥digo ir para produ√ß√£o), ser√£o direcionados para o login ao tentar publicar qualquer conte√∫do, mas n√£o precisar√£o digitar usu√°rio e senha, pois ser√£o redirecionados de volta ao revalidar o `user`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > `UserProvider` no lugar de `swr` para lidar com sess√£o dos usu√°rios
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > `isLoading = true` desde o in√≠cio at√© revalidar ou descartar o cache.
> > `isValidating = true` s√≥ enquanto realmente revalida (inicia como `false`)
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O primeiro render √© o conte√∫do est√°tico (sem `user` para n√£o dar incompatibilidade client/server). No segundo j√° vai usar o `localStorage` e s√≥ ent√£o vai entrar nesse condicional para revalidar
> > </pull_440_feat(use-user): use localStorage cached user>

<pull_442_test(content): add `await` to one of the `orchestrator` update method>
Havia uma intermit√™ncia nos testes de integra√ß√£o causada pela falta de um `await` na frente de um comando de atualiza√ß√£o do `orchestrator`.
Isso foi revelado no PR #440 do @aprendendofelipe , um PR que n√£o mexia em nada no backend.
E eu vou fazer os testes desse PR rodarem v√°rias vezes para entender se o comportamento deixou de ser intermitente ü§ù
</pull_442_test(content): add `await` to one of the `orchestrator` update method>

<pull_443_feat(use-user): cache user state to `localStorage`>
Este PR faz par com o PR #440 do @aprendendofelipe e a tentativa aqui foi fazer a mesma coisa proposta por ele, mas usando o `swr`. N√£o trouxe para c√° todas as implementa√ß√µes do PR dele, queria apenas rabiscar algo para ele ver.
Ent√£o as caracter√≠sticas s√£o:

1. Componente come√ßa com o `loginStatus` como `"loading"` e que pode resolver para `"logged-in"` ou `"logged-out"`.
2. Com isso, na interface posso escolher n√£o renderizar nenhum item no menu enquanto n√£o resolver para algum dos dois status acima.
3. Se resolver para `"logged-out"` aparece o menu de `Login / Cadastrar`.
4. Se resolver para `"logged-in"` aparece o dropdown menu com o `username`.
5. Decidir estar logado ou n√£o √© resolvido atrav√©s da exist√™ncia ou n√£o do item `user` no `localStorage`.
6. Se existir esse item, ele √© injetado como `fallbackData` no `swr` para que independente da revalida√ß√£o que ele esteja fazendo contra o endpoint real, o `user` ser√° retornado instantaneamente.
7. Se o `swr` conseguir revalidar, o `user` √© atualizado.
8. Se n√£o conseguir revalidar pelo fato do endpoint `/user` retornar `401` ou `403`, o item `user` √© deletado do `localStorage` e o `loginStatus` √© setado como `"logged-out"`.
9. A vari√°vel `shouldRevalidate` controla se o `swr` deve fazer uma tentativa de bater no endpoint `/user` e essa vari√°vel √© apenas `true` se `loginStatus` estiver setado como `"logged-in"`. Se estiver como `false`, o `swr` n√£o tenta bater na rota.
10. Na atual implementa√ß√£o, usu√°rios precisar√£o se logar novamente, mas a ideia seria fazer um deploy intermedi√°rio que vai populando por um tempo o `localStorage` do pessoal, at√© que decidirmos virar a chave.
11. Url de teste: https://tabnews-ffuzi3g7w-tabnews.vercel.app/
    > > Review de aprendendofelipe (DISMISSED):
    > > Conditional Fetching... ü§Ø Mas que implementa√ß√£o delicinha! üòç Muito mais elegante que a minha!
    > > E, se eu n√£o perdi nada, a √∫nica coisa que a minha faz a mais √© n√£o pedir um novo login para os usu√°rios com sess√£o ativa que ainda n√£o tenham o `user` salvo no `storage`.
    > > Proposital, imagino, pois seria s√≥ um detalhezinho a mais para implementar. Se n√£o foi proposital, eu posso sugerir algo... üöÄ
    > > </pull_443_feat(use-user): cache user state to `localStorage`>

<pull_444_Sistema de Eventos + Firewall>
Dando os primeiros passos na issue #351, este PR implementa um novo model `event` que registra eventos de neg√≥cio, junto com o ip originador e alguns metadados.
Por hora h√° dois tipos de eventos: `create:user` e `create:content`.
A interface para criar um evento √© a seguinte:

```js
await event.create({
  type: "create:content",
  originatorId: request.context.user.id,
  originatorIp: request.context.clientIp,
  metadata: {
    id: secureOutputValues.id,
  },
});
```

Resulta em:

```js
{
  id: 'd423993c-bb8d-412c-b3d0-a0a34dd0e9f1',
  type: 'create:content',
  originator_id: 'aa25f04e-747f-45cb-bcf2-04a06a5aa88b',
  originator_ip: '127.0.0.1',
  metadata: {
    id: '1b8f6ef8-04e4-484f-9056-ad9a8c085521'
  },
  created_at: 2022-06-08T22:27:13.428Z
}
```

Todos os campos s√£o validados usando o `validator` e a estrutura a ser validada do `metadata` depender√° do `type` fornecido. Por hora, para ambos eu coloquei o `id` do objeto gerado. Quando existir outros eventos como os de transfer√™ncia de `tabcoins`, o `metadata` poder√° conter coisas como `amount`, `from`, `to` e coisas assim. E agora revisando, talvez o campo `originator_id` fique melhor como `originator_user_id`.
De qualquer forma, com esses dados (principalmente o `ip`), conseguimos dar in√≠cio a issue #338 sobre comportamentos abusivos (mesmo ip criando v√°rias contas, ou v√°rias publica√ß√µes), e logo depois tamb√©m a issue #352 sobre as tabcoins.
Em paralelo, refatorei o `controller.js` e os controllers para ter um m√©todo de nome mais gen√©rico e que sirva para injetar na request outras coisas al√©m do `requestId`. Ent√£o agora √© injetado no `request.context` o `clientIp`.

> > Review de aprendendofelipe (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Eu n√£o daria tanta informa√ß√£o sobre a regra infringida, principalmente por esses motivos:

1. Caso seja algu√©m tentando burlar o sistema, ele receber√° muitas dicas de como obter sucesso.
2. Caso seja um grupo de pessoas com o mesmo IP p√∫blico que, por qualquer motivo, tenham se cadastrado ao mesmo tempo, por exemplo ao assistirem a live de algum famoso por a√≠, pode ser considerado uma quebra de privacidade se algu√©m desse grupo de pessoas receber essa mensagem.
   </pull_444_Sistema de Eventos + Firewall>

<pull_448_Fazer o cache do `user` no `localStorage`>
Branch intermedi√°ria da branch #443 que eu e @aprendendofelipe estamos fazendo para melhorar a experi√™ncia da interface decidir se o usu√°rio est√° logado ou n√£o.
Este √© o deploy do **Stage 1** da implementa√ß√£o, onde ir√° servir apenas para preencher o localStorage de quem j√° est√° logado. Mais detalhes da estrat√©gia pode ser lido no PR original.
</pull_448_Fazer o cache do `user` no `localStorage`>

<pull_453_feat(metadata): clean body markdown - SEO>

## ü§î Por que voc√™ est√° abrindo esse Pull Request?

- Conforme solicitado na Issue #393 pelo @filipedeschamps limpar o markdown do body no title e description.

## üßê Descreva sua solu√ß√£o:

Acabei encontrando o [remove-markdown ](https://www.npmjs.com/package/remove-markdown) mais popular que as sugest√µes e n√£o possui nenhuma depend√™ncia adicional, ele tamb√©m remove as tags HTML, conforme exemplo abaixo:
| Antes | Depois |
| ----- | ------ |
| | |

> > Review de filipedeschamps (CHANGES_REQUESTED):
> > Muuuito massa @rodrigoKulb isso vai dar uma ajuda sensacional no SEO üòç v√°rios posts estavam ficando sujos no `title`. E acredito que com o merge desse PR n√≥s finalizamos a parte de texto dessa Milestone sobre SEO.
> > Pedi um ajuste ali no `package.json` e aproveito para perguntar, voc√™ gerou o `package-lock.json` com a vers√£o `16.15.0` do Node.js?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Por favor, usar vers√£o pinnada (sem o `^`) nas depend√™ncias üëç
> > </pull_453_feat(metadata): clean body markdown - SEO>

<pull_455_fix(husky): Windows compatibility>
Com a importante adi√ß√£o do husky ao projeto, n√£o √© mais poss√≠vel fazer git commit utilizando o Microsoft Windows sem incluir no commit vers√µes compat√≠veis dos arquivos `package.json` e `commit-msg`.
Esse PR prop√µe uma vers√£o que seja compat√≠vel com qualquer sistema operacional.
</pull_455_fix(husky): Windows compatibility>

<pull_460_feat(use-user): stage 2 - cache user state>

> @aprendendofelipe vamos partir para o estagio 2?
> @filipedeschamps, boraaaaa!!!
> Esse √© o est√°gio 2 do PR #440
> </pull_460_feat(use-user): stage 2 - cache user state>

<pull_462_Implementa TabCoins e TabCash>
Neste PR estou implementando o que conversamos na issue #352 e irei fazer em doses homeop√°ticas. Vou destacando o que foi feito commit a commit e comecei ajustando algumas coisinhas:
00cadab689aa560d7e4ce12ca258e574efd15d12

- Agora o comando `npm run create:migration` cria a migration na pasta certa, pois antes criava em `/migrations` e n√£o em `/infra/migrations`
- Inseri no README instru√ß√µes de como criar novas migrations.
  3f8e928f66087658afa8986e41e300a08a869b6e

- Um pequeno ajuste de usabilidade para quem est√° desenvolvendo com `npm run dev` e rodando testes com `watch` que acabam deletando e recriando o banco (sem recriar as fun√ß√µes do `firewall`).
- Ent√£o em ambientes que n√£o s√£o `Production` ou `Preview` (Homologa√ß√£o), o c√≥digo de erro `42883` do Postgres que significa `undefined_function` n√£o √© mais logado.
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de filipedeschamps (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        <Box sx={{ overflow: 'auto' }}>
```

Eu n√£o testei, ent√£o tenta aqui tamb√©m se no `Content` n√£o for suficiente, mas acredito que seja

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Sensacional!!! No content n√£o funcionou, mas colocando no container fora funcionou 100%, inclusive mobile üòç
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Maravilha!
> > No Content vai acabar precisando colocar por causa de texto Zalgo, mas tem isso na PR #425, ent√£o n√£o tem como esquecer.
> > </pull_462_Implementa TabCoins e TabCash>

<pull*463_Imagem personalizada para compartilhamento de links em redes sociais>
Implementa a sugest√£o da issue #395.
Resultado final utilizando o [ngrok](https://ngrok.com/) como host e https://www.opengraph.xyz/ para visualiza√ß√£o:
| | |
| --- | --- |
| | |
| | |
\_Obs 1: Essa √© minha primeira vez contribuindo para um projeto aberto.*
_Obs 2: N√£o tenho muita experi√™ncia com o Nextjs._
_Obs 3: Vou deixar mais informa√ß√µes l√° na issue sobre alguns detalhes dessa implementa√ß√£o._
</pull_463_Imagem personalizada para compartilhamento de links em redes sociais>

<pull_465_fix(validator): source_url with short host and required protocol>

1. Resolve o problema de n√£o aceitar URL curta como `https://t.me`. Problema relatado em #457
2. O novo limite do tamanho do TLD passou de 18 para 24 caracteres e tamb√©m s√£o aceitos n√∫meros e h√≠fens, conforme a [lista de TLDs.](http://data.iana.org/TLD/tlds-alpha-by-domain.txt)
3. Torna obrigat√≥ria a inser√ß√£o do protocolo (`http` ou `https`), pois sem isso o componente `Content` considera como URL relativa e cria um link inv√°lido:
   Cadastrando `www.google.com` o link ficava como `https://www.tabnews.com.br/user/www.google.com`
4. Agora n√£o √© permitido letras mai√∫sculas no host, apenas ap√≥s o TLD (path, query e fragment). Antes era poss√≠vel cadastrar algo como `https://www.gOoGlE.com`. Ainda √© poss√≠vel algo como `https://www.tabnews.com.br/#:~:text=TabNews,-Status`
   Obs.: Optei por manter o regex e n√£o utilizar o Joi, pois √© mais f√°cil de entender quais regras est√£o sendo aplicadas.
   Obs. 2: Me baseei na [RFC 3986](https://www.rfc-editor.org/rfc/rfc3986.html).
   </pull_465_fix(validator): source_url with short host and required protocol>

<pull_468_Configurar gitpod>
Esse PR adiciona um .gitpod.yml para ser mais facil de subir um ambiente de desenvolvimento
</pull_468_Configurar gitpod>

<pull_474_fix(tabcoins): consider outdated `localStorage` without `tabcoins` and `tabcash` properties>
Relacionado a issue #473
</pull_474_fix(tabcoins): consider outdated `localStorage` without `tabcoins` and `tabcash` properties>

<pull_484_feat(login/logout): adicionando a possibilidade de deslogar>
Incluindo m√©todo (bem simples) para deslogar o usu√°rio

> > Review de coffeeispower (COMMENTED):
> > Coment√°rio de coffeeispower (linha de c√≥digo):

```suggestion
    localStorage.removeItem('user');
    document.cookie = 'session_id=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
```

Talvez seria uma boa ideia remover o cookie de "session_id" tambem?
</pull_484_feat(login/logout): adicionando a possibilidade de deslogar>

<pull_487_Revert "build(deps): bump mermaid from 9.1.1 to 9.1.3">
Reverts filipedeschamps/tabnews.com.br#481
</pull_487_Revert "build(deps): bump mermaid from 9.1.1 to 9.1.3">

<pull_490_feat(submit-hotkey): submit post with `Ctrl` (or `Command`) + `Enter`>
Como sugerido em #382.
O editor do bytemd n√£o exp√µe um `onKeyDown` nem nada parecido, ent√£o vamos de `addEventListener("keydown", onKeyDown)` para poder submeter um conte√∫do ou coment√°rio com os atalhos `Ctrl` + `Enter` ou `Command` + `Enter`.
Preciso que algu√©m teste no Mac.
</pull_490_feat(submit-hotkey): submit post with `Ctrl` (or `Command`) + `Enter`>

<pull_491_fix(notfound-page): revalidate cached 404 pages>
Corrige problema relatado em #478 for√ßando a revalida√ß√£o do cache de p√°ginas 404.
</pull_491_fix(notfound-page): revalidate cached 404 pages>

<pull_494_fix(api-users): users endpoint expect `read:user:list` feature>
Corrige o problema de seguran√ßa no endpoint `api/v1/users` que estava listando todos os usu√°rios e suas propriedades sem exigir a feature `read:user:list` e nem mesmo estava exigindo sess√£o de usu√°rio ativa.
Problema relacionado com https://github.com/filipedeschamps/tabnews.com.br/issues/186#issuecomment-1185033575

> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Zero impacto nesse caso, mas uma coisa que eu me peguei pensando no passado que queria compartilhar foi o tradeoff entre **performance** (de criar esses usu√°rios mesmo em testes onde eles n√£o s√£o usados), **legibilidade** (h√° uma dist√¢ncia maior entre a declara√ß√£o e uso das vari√°veis, mas talvez o maior problema seja quando houver dois `privilegedUser` com features diferentes, e da√≠ a cria√ß√£o deles vai estar num contexto longe do uso) e que est√° casado com **refatora√ß√£o** (ta tudo num s√≥ lugar, delicinha).
> > N√£o mudaria nada, mas s√≥ queria compartilhar esse pensamento ü§ù
> > </pull_494_fix(api-users): users endpoint expect `read:user:list` feature>

<pull_495_fix(favicon): favicons added>
20 . Adicionado `favicon.png` `apple-touch-icon.png` e `apple-touch-icon-precomposed.png` para limpar erros 404
</pull_495_fix(favicon): favicons added>

<pull_503_Favicon SVG>
Resolvi adicionar alguns SVG Icons derivados da logo oficial
</pull_503_Favicon SVG>

<pull_506_fix(breaking change): rename `error_unique_code` to something like `error_location_code`> 25. Breaking change da API: renomear `error_unique_code` para algo como `error_location_code`.
</pull_506_fix(breaking change): rename `error_unique_code` to something like `error_location_code`>

<pull_508_fix(arial label): changed search to credit and debit tabcoins>
Como sinalizado em #485.
Alterei as `arial-label`para algo mais acessivel, segue:
Creditar TabCoin;
Debitar TabCoin.
</pull_508_fix(arial label): changed search to credit and debit tabcoins>

<pull_509_fix(slug): childrendeepcount to children-deep-count>
Corrigi a slug, agora est√° sendo gerado os underlins com hifen: #439
</pull_509_fix(slug): childrendeepcount to children-deep-count>

---

<pull*510*`ContentList`: adiciona divisor padr√£o em `published_at`> 32. mover o autor para o √∫ltimo lugar.
</pull*510*`ContentList`: adiciona divisor padr√£o em `published_at`>

---

<pull_513_fix(onKeyDown): eventlistener bug>
Fix #512
</pull_513_fix(onKeyDown): eventlistener bug>

<pull_514_fix(onKeyDown): eventlistener bug>
Continua√ß√£o do PR #513 - for√ßar deploy na Vercel.
</pull_514_fix(onKeyDown): eventlistener bug>

---

<pull*515*[Bug Fix] Girar a tela do celular (vertical <-> horizontal) logo ap√≥s publicar uma resposta gera mensagem de erro>
Buscando entender comportamentos que ocorrem de maneiras diferentes no computador e no celular, encontrei mais esse bug.
Pelo que vi nos deploys antigos, o bug j√° est√° presente h√° bastante tempo, mas como ocorre em uma situa√ß√£o bem espec√≠fica, n√£o deve ser considerado urgente. Se bem que a solu√ß√£o √© bem simples.

### Como ocorre o problema

Ao clicar em responder, o componente `Content` que inicialmente estava renderizado em `CompactMode` passa para `EditMode`.
Inicialmente o `contentObject` s√≥ tem o id do conte√∫do pai.
Ap√≥s submeter a resposta, o `contentObject` √© atualizado com os dados da resposta e o componente muda para `ViewMode`.
Acontece que ao mudar a disposi√ß√£o da tela, quase tudo √© renderizado novamente e alguns estados s√£o mantidos, mas outros s√£o perdidos.
O componente recebe novamente o `content`, o que acaba zerando o `contentObject`, ficando novamente apenas com o id do conte√∫do pai, mas continua renderizado em `ViewMode`, o que causa o erro.

### Solu√ß√£o proposta

Usar a sintaxe de espalhamento no `setContentObject` para n√£o perder os dados atuais no `contentObject` e apenas atualizar o que vier diferente no `content`.
</pull*515*[Bug Fix] Girar a tela do celular (vertical <->

---

<pull_516_feat(header contentlist): using `next/link` and `next/router`>
Neste [PR](https://github.com/filipedeschamps/tabnews.com.br/pull/377#issuecomment-1146057536) o @filipedeschamps e o @aprendendofelipe comentaram sobre o uso `next/link`, eu decidi dar uma olhada e gostei muito do resultado. Queria saber se posso com seguir essa implementa√ß√£o nos outros componentes ou se n√£o √© algo necess√°rio.

> > Review de aprendendofelipe (APPROVED):
> > </pull_516_feat(header contentlist): using `next/link` and `next/router`>

<pull_535_Thumbnails din√¢micas dos conte√∫dos>
Esta implementa√ß√£o foi iniciada por @ErickCReis atrav√©s do PR #463 e estou trazendo do fork para c√° para continuar com os √∫ltimos ajustes, estamos quase l√° üòç
</pull_535_Thumbnails din√¢micas dos conte√∫dos>

<pull_541_feat(contentlist): add default divider to `published_at`>
Branch intermedi√°ria para squash dos commits do PR #510
</pull_541_feat(contentlist): add default divider to `published_at`>

<pull_545_fix(thumbnail): remove cache>
Remove o cache na gera√ß√£o das thumbnails para tentar isolar o problema reportado na issue #544
</pull_545_fix(thumbnail): remove cache>

<pull_547_fix(thumbnail): stop injecting session>
Este PR √© um reflexo da pesquisa feita pela issue #544 e faz com que o endpoint `/thumbnail` pare de injetar a sess√£o do usu√°rio e pare de retornar o `Set-Cookie` nos cabe√ßalhos do response.
</pull_547_fix(thumbnail): stop injecting session>

<pull_549_feat(404.public.js): adds a custom 404 page>
Basic 404 page with tabnews bot logo, a simple text saying "P√°gina n√£o encontrada" and a link to
homepage (./). Also, it includes all the Default layout (with header and everything).
</pull_549_feat(404.public.js): adds a custom 404 page>

<pull_553_feat: add to home screen>
Neste PR estou implementando a melhoria sugerida pelo **@gabrielsozinho** na issue #548.
| ANTES | DEPOIS |
| ----- | ------ |
| | |
| | |
</pull_553_feat: add to home screen>

<pull_562_Previnir problemas de "overflow", incluindo para textos Zalgo>
Esta √© uma branch intermedi√°ria para deploy da branch #425 de @aprendendofelipe ü§ù
</pull_562_Previnir problemas de "overflow", incluindo para textos Zalgo>

<pull_563_fix(ContentList): lineHeight changed from `'1.25rem'` to `1.5`>
No PR #425 deixei o `lineHeight` com unidade `rem`, por√©m isso est√° causando problemas quando se usa o zoom do navegador com alguns valores diferentes de 100%. E nessas condi√ß√µes aparece a barra de rolagem.
Para corrigir isso, deixei o `lineHeight` para ser sempre relativo ao tamanho da fonte real e n√£o levar em considera√ß√£o o tamanho da fonte padr√£o do navegador.
Edit: 1.5 j√° √© o padr√£o utilizado no `BaseStyles` do Primer React, ent√£o s√≥ removi os `lineHeight`
</pull_563_fix(ContentList): lineHeight changed from `'1.25rem'` to `1.5`>

<pull_564_fix(ContentList): lineHeight changed from `'1.25rem'` to `1.5`>
PR intermedi√°rio para deploy do PR #563 de @aprendendofelipe
</pull_564_fix(ContentList): lineHeight changed from `'1.25rem'` to `1.5`>

<pull_566_fix(header): return header overflow to visible>
Infelizmente encontrei outro bug do PR dos overflows... Na √©poca que comecei esse PR, ainda n√£o existiam as TabCoins, ent√£o n√£o tinha esse problema onde o `Tooltip` extrapola o tamanho do `Header`.
Para o Header em telas pequenas vamos direto para a ado√ß√£o de um Menu Sidebar mesmo. Ou outra solu√ß√£o.
Sorry! üò≥
</pull_566_fix(header): return header overflow to visible>

<pull_567_fix(header): return header overflow to visible>
PR intermedi√°rio para deploy do PR #566 do @aprendendofelipe
</pull_567_fix(header): return header overflow to visible>

<pull_581_Ajuste ao girar a tela do celular (vertical <-> horizontal)>
PR intermedi√°rio para deploy do PR #515 do @aprendendofelipe
</pull_581_Ajuste ao girar a tela do celular (vertical <->

<pull_583_Adiciona p√°gina `404` customizada>
PR intermedi√°rio para for√ßar deploy, CI e squash do PR #549 de @nottja1mmm
</pull_583_Adiciona p√°gina `404` customizada>

<pull_588_Adiciona p√°gina `500` customizada>
Isso √© um PR intermedi√°rio do PR #585 do @nottja1mmm
</pull_588_Adiciona p√°gina `500` customizada>

<pull_590_build(dependency): downgrade `react` and `react-dom` from `18.1.0` to `17.0.2`>
Motivo: https://github.com/filipedeschamps/tabnews.com.br/issues/445#issuecomment-1167450147
</pull_590_build(dependency): downgrade `react` and `react-dom` from `18.1.0` to `17.0.2`>

<pull_592_Fazer o comando `npm test` funcionar em todos os sistemas operacionais>
Testando a especula√ß√£o feita por @aprendendofelipe [nesse coment√°rio](https://github.com/filipedeschamps/tabnews.com.br/pull/559#issuecomment-1196148180)
</pull_592_Fazer o comando `npm test` funcionar em todos os sistemas operacionais>

<pull_593_fix(content-slug): creating a title with / slug became ->
Transforma slug com "/" em "-", avisem caso algo esteja fora dos padroes, acabei nao encontrando a melhor forma de se fazer um PR.
Adicionei tambem no teste de special characters na criacao do Post o caractere /, esta tudo passando tranquilo.
fix #580
</pull_593_fix(content-slug): creating a title with / slug became ->

<pull_594_Ajusta m√©todo que cria o `slug` para considerar `/` como `-`>
PR intermedi√°rio do PR #593 do @leotorresds
</pull_594_Ajusta m√©todo que cria o `slug` para considerar `/` como `-`>

<pull_595_fix(manifest.json): dark icon bug on mobile>

## ü§î Por que voc√™ est√° abrindo esse Pull Request?

Conforme solicitado na Issue #587 pelo @filipedeschamps quando salve um atalho no mobile aparece o √≠cone todo branco todo preto.

## üßê Descreva sua solu√ß√£o:

Existe a op√ß√£o de criar o arquivo chamado **manifest.json** para direcionar os favicons conforme o tipo.
| Antes | Depois |
| ----- | ------ |
| | |
</pull_595_fix(manifest.json): dark icon bug on mobile>

<pull_601_Atualiza todas as depend√™ncias do Backend>
Este PR re√∫ne a atualiza√ß√£o de todas as depend√™ncias (m√≥dulos) do Backend, incluindo voltar a vers√£o do Node.js para `LTS v16`.
Num outro PR irei trazer as depend√™ncias do Frontend üëç

## Depend√™ncias desinstaladas

- `@babel/preset-env` porque n√≥s estamos usando o `next` no modo `swc`.

## Depend√™ncias n√£o atualizadas do backend

- `kill-port` por conta [deste bug](https://github.com/tiaanduplessis/kill-port/issues/61)

## Efeitos colaterais

Com a atualiza√ß√£o do `next` para √∫ltima vers√£o, ele come√ßou a reclamar disto:

```
[
    {
      "instancePath": "/experimental",
      "schemaPath": "#/properties/experimental/additionalProperties",
      "keyword": "additionalProperties",
      "params": {
        "additionalProperty": "nftTracing"
      },
      "message": "must NOT have additional properties"
    }
  ]
```

N√≥s usamos o `nftTracing` para conseguir ler dentro da `lambda` os arquivos das `migrations` e as fontes usadas nas thumbnails customizadas. Mas apesar desse erro, tanto a thumbnail quanto as migrations est√£o sendo lidas corretamente.
</pull_601_Atualiza todas as depend√™ncias do Backend>

<pull_602_Atualiza todas as depend√™ncias do Frontend>
Este PR re√∫ne a atualiza√ß√£o de todas as depend√™ncias (m√≥dulos) do Frontend.

## Depend√™ncias n√£o "totalmente" atualizadas do frontend

- `recharts` fiz o upgrade de `2.1.9` para `2.1.12` pois a `2.1.13` quebra por [conta disso](https://github.com/recharts/recharts/issues/2918)

## Efeitos colaterais

N√£o h√° testes automatizados no frontend ent√£o foi tudo teste manual mesmo e a √∫nica coisa que quebrou aparentemente na quest√£o visual foi a atualiza√ß√£o do `@primer/react` de `35.2.1` para `35.5.0` por conta [desse release](https://github.com/primer/react/releases#:~:text=Compare-,v35.2.2,-Patch%20Changes) que agora faz o `TextInput` (e outros Inputs pel queo testei) n√£o preencher por padr√£o a largura do container, voc√™ precisa controlar isso pela propriedade `block`.
Em paralelo, o componente `Button` deles tamb√©m tomou esse hit, mas ele n√£o aceita a propriedade `block` ainda. Tanto que na [documenta√ß√£o](https://primer.style/react/Button#styling-a-button) eles est√£o recomendando estilizar com o `sx`.
O Textarea do Bytemd tamb√©m foi afetado.
</pull_602_Atualiza todas as depend√™ncias do Frontend>

<pull_603_feat(recoveryPassword): Invalidando as sess√µes do usu√°rio ao resetar a senha>
Foi adicionado uma fun√ß√£o `expireAllFromUser` no `model Session` que recebe um id de usu√°rio e invalida todas as sess√µes relacionadas a esse id.
Paralelamente foi adicionado a importa√ß√£o do `model session` dentro do `model recovery` e, na fun√ß√£o `resetUserPassword` foi adicionada a chamada para essa fun√ß√£o passando o `tokenObject.user_id`
Issue: [384](https://github.com/filipedeschamps/tabnews.com.br/issues/384)

> > Review de filipedeschamps (CHANGES_REQUESTED):
> > Implementa√ß√£o sensacional @eletroswing muito obrigado pela contribui√ß√£o! Fiz poucas sugest√µes no c√≥digo ü§ù
> > Mas o mais importante √©: como iremos provar que essa implementa√ß√£o funciona e como garantir que n√£o iremos ter regress√£o caso novas implementa√ß√µes sejam feitas? Vejo uma √∫nica resposta que s√£o **testes automatizados**.
> > Se voc√™ nunca mexeu com testes automatizados, me avise para eu continuar com esta implementa√ß√£o ü§ù üëç
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Aqui foi adicionado um espa√ßo em branco, e para resolver isso de forma global, voc√™ pode rodar o comando `npm run lint:fix`
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Como est√° sendo passado um `userId` ao inv√©s do objeto `user`, sugiro que o nome do m√©todo seja `expireAllFromUserId`
> > </pull_603_feat(recoveryPassword): Invalidando as sess√µes do usu√°rio ao resetar a senha>

<pull_604_fix(scrolling): bug on iOS Safari>
Tentativa de resolver o problema reportado em #572
Digo tentativa, pois n√£o consegui reproduzir, ent√£o preciso que algu√©m que esteja enfrentando o problema realize os testes.
Imagino que seja algo espec√≠fico do iOS (ou iOS+Safari) em conjunto com o ByteMD. O que pode estar ocorrendo √© o ByteMD n√£o est√° ocupando toda a altura que deveria para renderizar todo o conte√∫do, o que, pelo overflow estar setado como auto, autoriza o navegador a rolar somente o box que est√° sendo tocado.
Se for isso, provavelmente essa altera√ß√£o ir√° resolver, pois toda a tela ser√° rolada e o viewMode do ByteMD deve ir aumentando sua altura antes de entrar no campo de vis√£o.
Pe√ßo aten√ß√£o para quem for testar, se n√£o est√° sendo cortado algo no final do conte√∫do.
`overflow: hidden` era a nossa primeira op√ß√£o mesmo, mas como o `overflow: auto` estava funcionando bem, optamos por ele, j√° que poderia surgir alguma situa√ß√£o em que fosse necess√°ria a rolagem, mas no caso do body √© melhor deixarmos esse controle com o ByteMD.
</pull_604_fix(scrolling): bug on iOS Safari>

<pull_609_feat(contentlist): differentiate visited and unvisited link>
Primeira etapa do que est√° sendo discutido em [#518 - Diferenciar publica√ß√£o visitada/nova](https://github.com/filipedeschamps/tabnews.com.br/issues/518)
Por enquanto est√° apenas mudando a cor do t√≠tulo de conte√∫dos j√° visitados.
[Edit]
<s>Foi utilizado `<style jsx>` para estilizar o componente `Link` do Primer React com a pseudo-classe `:visited`.</s>
O @filipedeschamps conseguiu estilizar o `Link` atrav√©s do componente `Box` pai.
A cor escolhida foi o mesmo cinza utilizado na linha abaixo do t√≠tulo (tabcoins, coment√°rios...), para n√£o poluir a tela.
</pull_609_feat(contentlist): differentiate visited and unvisited link>

<pull_615_Expirar todas as sess√µes v√°lidas ao resetar a senha do usu√°rio>
Continua√ß√£o do PR #603 feito por @eletroswing
Antes de tudo, fiz o commit b388a20ade1b070311a777802d13f516ffa76ca1 com o seguinte:

- Aumentei um pouco a cobertura do teste quando √© invalidada a sess√£o com o `DELETE`. Isto n√£o est√° relacionado ao PR original mas aproveitei o embalo no assunto `sessions`.
- Ent√£o agora √© testado que antes a sess√£o funciona ao usar ela para buscar por `/user`, e depois de invalidar a sess√£o, garante que a mesma busca por `/user` com a mesma sess√£o retorna um `401`.
- Esse tipo de estrat√©gia vai ser aproveitada no pr√≥ximo commit.
  Ent√£o depois disso, no commit cfdde6dba496166d28cf31444f1ca0e59882a131 trabalhei de fato no que o PR #603 prop√µe, que √© garantir que ao resetar a senha de um usu√°rio, todas as sess√µes s√£o invalidadas.

- Ent√£o criei um teste que cria duas sess√µes ativas, e ao resetar a senha, me certifico que as duas sess√µes s√£o expiradas.
- E na query do m√©todo que expira todas as sess√µes, adicionei uma condicional `AND expires_at >= now()` para s√≥ mexer nas sess√µes que est√£o para vencer, e n√£o em todas as sess√µes hist√≥ricas do usu√°rio.
- Fora isso removi um potencial de SQL Injection [dessa linha](https://github.com/filipedeschamps/tabnews.com.br/pull/603/files#diff-0bbdf4f340d53a73fe1ea2d8168a00e3bc8b14ef684e140570ec0af974456ffcR60), mas sem preocupa√ß√µes, pois essa linha era do PR que estava em Work In Progress.
  </pull_615_Expirar todas as sess√µes v√°lidas ao resetar a senha do usu√°rio>

---

<pull*616*`ContentList`: utiliza `Link` do Next.js junto com uma barra de carregamento>
Isso √© uma continua√ß√£o do PR #516 de @ErickCReis onde agora utilizamos o `Link` do Next.js para transformar as p√°ginas em SPA e assim evitar o `boot` inicial de carregamento de uma p√°gina toda vez que algu√©m clicar num link na lista de conte√∫dos. Fora isso, √© adicionado uma barra de carregamento.

## HTML gerado

Analisando o HTML que √© gerado, al√©m da barra de carregamento inserir um `style` inline n√£o minificado (o que n√£o √© muito problema), a abstra√ß√£o continua devolvendo basicamente o mesmo HTML que constr√≥i as tags `<a>` e essa √© a parte que mais precisamos tomar cuidado para n√£o confundir o SEO.

## Compatibilidade com React 18

Em paralelo, eu ficaria de olho nessa issue do `nextjs-progressbar` sobre o React 18: https://github.com/apal21/nextjs-progressbar/issues/76
</pull*616*`ContentList`: utiliza `Link` do Next.js junto com uma barra de carregamento>

---

<pull*618_Adiciona a propriedade `owner_username` no conte√∫do>
Este PR adiciona a propriedade `owner_username` no objeto `content` para fazer par com o `owner_id`. Por compatibilidade, esse PR ainda mant√©m o `username`, mas que ap√≥s notifica√ß√£o p√∫blica, iremos remover e fazer uma breaking change na interface p√∫blica. Estamos nos dando o luxo de fazer isso dessa forma pela API estar em beta.
O motivo desta implementa√ß√£o √© sem√¢ntico, uma vez que um conte√∫do n√£o possui `username`, ele possui no m√°ximo um \_dono* e esse dono √© quem possui o `username`.
Este PR tamb√©m altera os componentes em `interface` como `ContentList` e `Content`. Muito cuidado nessa parte, principalmente nas horas que √© feito a edi√ß√£o do conte√∫do (e √© enviado um `PATCH` para `.../contents/[owner_username]/[slug]`)
_PS: Esse PR foi feito inteiramente dentro do Codespaces._
</pull_618_Adiciona a propriedade `owner_username` no conte√∫do>

<pull_621_feat: add rss feed>
Esse pull request adiciona suporte a rss feed
fix #620

> > Review de filipedeschamps (CHANGES_REQUESTED):
> > Muito obrigado pela contribui√ß√£o @coffee-is-power fiz algumas sugest√µes para ir moldando a sua contribui√ß√£o nos padr√µes do projeto ü§ù
> > Review de coffeeispower (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Review de coffeeispower (COMMENTED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Ao inv√©s de fazer um `redirect`, voc√™ precisa fazer um [`rewrite`](https://nextjs.org/docs/api-reference/next.config.js/rewrites) para que n√£o seja substitu√≠da a URL.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Somente utilize vers√µes "pinadas" nos m√≥dulos, ent√£o √© necess√°rio remover o `^`.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Sugiro transformar o endpoint em algo gen√©rico e remover `.use(authentication.injectAnonymousOrUser)`.
> > Como efeito colateral, voc√™ n√£o vai mais ter dispon√≠vel o `req.context.user` e voc√™ deve substituir por `user.createAnonymous();`
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Esta valida√ß√£o est√° fora do padr√£o. Qualquer valida√ß√£o precisa passar pelo `validator`. Veja um exemplo aqui:
> > https://github.com/filipedeschamps/tabnews.com.br/blob/f62a60bb0bbf93035ac913975e3c88616765c6b6/pages/api/v1/users/index.public.js#L38-L48
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Porque existe o formato `json` num rss feed? A pr√≥pria API do TabNews j√° n√£o √© um fornecedor dos dados em `json`? Sugiro manter apenas o formato `xml` como padr√£o, pois isso vai simplificar a rota, os rewrites e vai remover a necessidade de criar valida√ß√£o de entrada.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Sugiro transformar isso num model chamado `rss`.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > N√≥s n√£o fizemos testes unit√°rios at√© ent√£o e para esse caso em espec√≠fico sugiro n√£o fazer tamb√©m. Sugiro fazer testes de integra√ß√£o seguindo o mesmo padr√£o dos outros que √© imitar o `path` da api e separar cada arquivo de teste pelo verbo http (por exemplo nesse caso seria a rota do rss + `get.test.js`)
> > Coment√°rio de coffeeispower (linha de c√≥digo):

```suggestion
    "feed": "4.2.2",
```

> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > Mas tambem n√£o faz muito sentido, at√© porque ele n√£o √© um objeto que precisa ser guardado no banco de dados, √© simplesmente um formato de dados. O que essa rota faz √© pegar os posts do tabnews e cuspir XML.
> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > Removi o formato json agora no commit 9fb193b33ba52b4b60f9eaabb03b0395e12fdf5d
> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > Agora n√£o tem mais valida√ß√£o, por tanto vou resolver essa review tambem.
> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > Resolvido no commit 7afd2b847634bb16cc1340cc3a377db6a8f0328f
> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > resolvido no commit 7a6ddae60f90a16ae3ef71cb94366e314f242f59
> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > Resolvido no commit a048b07
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Show! Acredito que o que voc√™ est√° se referindo √© um `Active Record ` ou `ORM`, onde as propriedades do objeto precisam da sua representa√ß√£o em tabelas no banco de dados.
> > Na minha vis√£o um model encapsula uma regra de neg√≥cio, uma ou v√°rias l√≥gicas sobre um assunto, que no caso ali √© transformar uma s√©rie de posts em um XML. Provavelmente um nome melhor para isso, talvez `service`? Mas de qualquer forma, voc√™ n√£o acha que √© melhor que essa l√≥gica esteja na pasta model para que ela possa ser importada e reaproveitada em outros lugares, do que um arquivo solto dentro da pasta da api? Se manter esse arquivo l√°, o que √© ele?
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Todas as depend√™ncias precisam ser pinadas, mas estou pensando se conseguimos usar o ByteMD para renderizar o HTML e evitar de adicionar mais essa depend√™ncia, mas acho que n√£o vai dar. Vou continuar pensando aqui ü§ù
> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > O rss suporta html tranquilamente, ele so n√£o suporta javascript pelo que eu sei. Mas eu tambem so preciso transpilar o md para html entao acho que vale apena ter essa dependencia, o byte md √© muito complexo.
> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > Ja pinei a dependencia no commit 1af2d17
> > Coment√°rio de coffeeispower (linha de c√≥digo):
> > Resolvido no commit 4b41e52
> > </pull_621_feat: add rss feed>

<pull_623_Fazer o `controller` parar de devolver um `500` quando um m√©todo HTTP n√£o √© encontrado>
Hoje, caso voc√™ realize um `POST` contra `/api/v1/user` ser√° retornado um erro `500` por conta disso:

```
error - (api)/models/controller.js (47:69) @ onNoMatchHandler
error - unhandledRejection: TypeError: Cannot read properties of undefined (reading 'requestId')
    at onNoMatchHandler (webpack-internal:///(api)/./models/controller.js:44:36)
    at file:///workspaces/tabnews.com.br/node_modules/next-connect/dist/index.js:34:32
    at AsyncFunction.handle (file:///workspaces/tabnews.com.br/node_modules/next-connect/dist/index.js:94:14)
    at nc (file:///workspaces/tabnews.com.br/node_modules/next-connect/dist/index.js:28:8)
    at Object.apiResolver (/workspaces/tabnews.com.br/node_modules/next/dist/server/api-utils/node.js:179:15)
    at processTicksAndRejections (node:internal/process/task_queues:96:5)
    at async DevServer.runApi (/workspaces/tabnews.com.br/node_modules/next/dist/server/next-server.js:381:9)
    at async Object.fn (/workspaces/tabnews.com.br/node_modules/next/dist/server/base-server.js:500:37)
    at async Router.execute (/workspaces/tabnews.com.br/node_modules/next/dist/server/router.js:213:36)
    at async DevServer.run (/workspaces/tabnews.com.br/node_modules/next/dist/server/base-server.js:619:29)
  45 |
  46 | async function onNoMatchHandler(request, response) {
> 47 |   const errorObject = new NotFoundError({ requestId: request.context.requestId });
     |                                                                     ^
  48 |   logger.info(snakeize(errorObject));
  49 |   return response.status(errorObject.statusCode).json(snakeize(errorObject));
  50 | }
```

Neste caso em espec√≠fico, o erro estoura em `request.context.requestId` porque n√£o deu tempo do `.use(controller.injectRequestMetadata)` injetar o contexto e o id da request, e n√£o via ter como, pois o `next-connect` diretamente pula para o callback de erro.
Eu decidi consertar isso agora, pois tem uma pessoa nesse exato momento tentando fazer uma integra√ß√£o em Node.js e batendo com um `POST` na rota `/api/v1/user` e disparando alertas aqui do meu lado sobre erros `500`.
</pull_623_Fazer o `controller` parar de devolver um `500` quando um m√©todo HTTP n√£o √© encontrado>

<pull_625_Implementa p√°gina de Recentes>
Este PR implementa a p√°gina de `/recentes` que √© uma c√≥pia da Home, mas que utiliza a estrat√©gia de `new` para listar as publica√ß√µes mais recentes (independente das tabcoins). O link para acessar esta p√°gina foi inclu√≠da no menu superior.
Em paralelo, fiz um ajuste no `DefaultLayout` para sempre incluir o prefixo `¬∑ TabNews` caso o t√≠tulo da p√°gina n√£o seja o t√≠tulo padr√£o usado na Home. Fiz isso, pois as √∫nicas p√°ginas que estavam com o prefixo `¬∑ TabNews` eram as que abriam algum `content`. Agora, todas p√°ginas possuem esse prefixo, menos a Home.
</pull_625_Implementa p√°gina de Recentes>

<pull_627_perf(remove-markdown): fix performance with lots of whitespace>
Conforme discutido em #622, substitu√≠ a biblioteca `remove-markdown` por um arquivo que cont√©m o mesmo c√≥digo proposto em https://github.com/stiang/remove-markdown/pull/57.
Com isso, s√£o esperados:

- uma redu√ß√£o no tempo gasto pelas lambdas da Vercel para gerar cada p√°gina est√°tica;
- elimina√ß√£o do bug causado por conte√∫dos que contenham grandes sequ√™ncias de espa√ßos em branco;
- diminui√ß√£o do tempo at√© as p√°ginas de conte√∫dos ficarem interativas;
  </pull_627_perf(remove-markdown): fix performance with lots of whitespace>

<pull_630_Editor: adiciona √≠cone de Ajuda e utiliza tradu√ß√£o para Portugu√™s>
</pull_630_Editor: adiciona √≠cone de Ajuda e utiliza tradu√ß√£o para Portugu√™s>

<pull_632_Conserta valida√ß√£o do `rss` sobre `guid` e `charset`>
Este PR faz a tag `<guid>` conter a URL absoluta da publica√ß√£o ao inv√©s do `id` do `content`, isso por conta de n√£o estar passando [nesta valida√ß√£o](https://www.rssboard.org/rss-validator/check.cgi?url=https%3A%2F%2Fwww.tabnews.com.br%2Frecentes%2Frss):
Ele tamb√©m conserta o erro de `charset`:
</pull_632_Conserta valida√ß√£o do `rss` sobre `guid` e `charset`>

<pull_634_feat(content): redirect home when cancel new root content>
Resolvendo a situa√ß√£o relatada em #633...
Ao cancelar a publica√ß√£o de um novo conte√∫do `root`, ap√≥s limpar o rascunho do `localStorage`, agora ocorre a navega√ß√£o para a `home`.
</pull_634_feat(content): redirect home when cancel new root content>

<pull_635_Implementa Rate Limit na API: `/api/v1/sessions`>
Este PR faz basicamente duas coisas:
4ab4b6a994061cdb48d21eb8145493c80039d039

- Faz o database encerrar o pool de conex√µes de forma mais agressiva, reservando `30%` de respiro (antes estava `10%`).
- Faz o database aguardar `1 segundo` para iniciar uma nova tentativa.
- Em condi√ß√µes normais, isto ter√° zero impacto de performance e somente ser√° √∫til em situa√ß√µes de alto stress contra o banco de dados.
  6f82ceb274dcf17dad03eba7446c23d0f8d012ca

- Implementa de fato o `rate-limit` em todos os endpoints a partir de `/api` utilizando o [Upstash](https://upstash.com/) que √© um Redis na nuvem e que pode ser distribu√≠do globalmente.
- Toda implementa√ß√£o inicia na utiliza√ß√£o do [Edge Middleware](https://nextjs.org/docs/advanced-features/middleware) que √© controlado pelo arquivo `middleware.public.js` na raiz do projeto.
- Este arquivo de middleware √© como se fosse o `controller` e a implementa√ß√£o do "rate limiter" est√° em `infra/rate-limit.js`.
- Ent√£o o middleware/controller faz o seguinte:
  1. Se por algum motivo acontecer algum erro, como por exemplo o Upstash estar indispon√≠vel, a request √© liberada para que o servi√ßo do TabNews n√£o seja interrompido. Se isso acontecer, eu vou receber uma mensagem no monitoramento aqui sobre `ServiceError`. Mas novamente, nada disso ser√° exposto ao usu√°rio.
  2. Se voc√™ estiver em algum ambiente de desenvolvimento (ou teste automatizado) e n√£o configurou as vari√°veis de ambiente que se conectam com o Upstash, o rate limiter n√£o ser√° utilizado e a request ir√° passar normalmente.
  3. Se est√° tudo configurado como esperado, o rate limiter ser√° utilizado.
- Por enquanto, h√° dois tipos de estrat√©gias para a quantidade de requests que podem ser feitas:
  1. Um limite geral por `ip` que √© aplicado para todas as rotas da API.
  2. Um limite espec√≠fico por `ip`, `method` e `path` que pode pode ser utilizado em rotas espec√≠ficas.
  3. Uma dessas rotas espec√≠ficas √© um `POST /api/v1/sessions` que possui limites **muito** mais baixos e janelas muito maiores de cooldown.
- Caso um atacante esbarre no limite de requisi√ß√µes de rotas convencionais, ele ser√° avisado com um `429 TooManyRequests`.
- Caso um atacante esbarre no limite de requisi√ß√µes do `POST /api/v1/sessions`, **ele n√£o ser√° avisado** e de forma "invis√≠vel" ser√° retornado um erro comum e **falso** de `401 Unauthorized` e que nunca estar√° de fato batendo contra a real implementa√ß√£o de criar sess√µes. Inclusive, esse erro falso simula uma **lat√™ncia falsa** para o atacante n√£o perceber que foi pego caso ele analise e note uma mudan√ßa no padr√£o de velocidade das respostas. Eu fiquei estressando a implementa√ß√£o em produ√ß√£o e depois a implementa√ß√£o falsa at√© que as varia√ß√µes de lat√™ncia entre as duas ficasse igual e n√£o desse para perceber quando voc√™ parou de bater contra o endpoint de verdade e come√ßou a bater no endpoint de mentira.
- A quantidade m√°xima de requisi√ß√µes e a janela de an√°lise possui valores padr√µes no c√≥digo, mas que podem ser sobrescritos utilizando vari√°veis de ambiente. Assim o c√≥digo fonte ir√° mostrar valores `X`, por√©m no ambiente de homologa√ß√£o e produ√ß√£o iremos utilizar valores `Y`.
- Um tradeoff de fazer a request passar pelo middleware, √© que n√£o √© mais poss√≠vel receber um `body` contendo `20.000` caracteres como √© poss√≠vel hoje em produ√ß√£o. O middleware [possui limites muito mais restritos](https://vercel.com/docs/concepts/functions/edge-functions/limitations#limits-on-requests) que as lambdas. Esse erro foi pego pelos testes de integra√ß√£o e eu reduzi esse limite m√°ximo de caracteres para `16.000`. Antes de fazer alguma altera√ß√£o por migration no `check` do banco de dados para a coluna `body`, sugiro maturar a implementa√ß√£o para ver se esse valor se sustenta.
- Em algum momento, a Equipe do Next.js inseriu uma regress√£o no Framework que impossibilita o Middleware fazer um `fetch` utilizando `POST` e um `body`. Isso foi reportado em v√°rias issues, [como essa aqui](https://github.com/vercel/next.js/issues/39060) essa a√ß√£o √© utilizada pelo m√≥dulo do Upstash. Felizmente essa regress√£o foi consertada na vers√£o canary `12.2.4-canary.11`, que √© o que estou utilizando nesse PR, e imagino que n√£o ir√° demorar muito para entrar num release oficial.
  </pull_635_Implementa Rate Limit na API: `/api/v1/sessions`>

<pull_637_Corrige a palavra 'anucios' para 'anuncios' na lista de usernames bloqueados>
Fala turma!
Eu estava cavucando o c√≥digo e encontrei um array bem indiscreto :joy: e **importante**
No model `user` existe uma lista de `usernames` que n√£o podem ser utilizados e que est√£o em um array chamado `blockedUsernames` dentro da fun√ß√£o `checkBlockedUsernames`.
Nesse array a palavra `'anuncios'` estava escrita como `'anucios'`, dessa forma algu√©m poderia criar uma conta com o username `anuncios`.
Esse PR corrige isso :thumbsup:

> > Review de aprendendofelipe (APPROVED):
> > </pull_637_Corrige a palavra 'anucios' para 'anuncios' na lista de usernames bloqueados>

<pull_640_Habilita `CORS` e inicia a implementa√ß√£o de `Security Headers`>
Este PR habilita `CORS` para todos os endpoints dentro de `/api` e inicia a implementa√ß√£o dos `Security Headers` em todas as p√°ginas e que ajudam a prevenir certos ataques como `XSS` e tamb√©m instrui o navegador a bloquear recursos como **c√¢mera**, **microfone** e a **geolocaliza√ß√£o**.

## Endpoint em Homologa√ß√£o sem `CORS`

## Endpoint em Homologa√ß√£o com `CORS`

</pull_640_Habilita `CORS` e inicia a implementa√ß√£o de `Security Headers`>

<pull_642_A configura√ß√£o experimental nftTracing n√£o √© mais necess√°ria>
N√£o necessitamos mais do par√¢metro experimental `nftTracing`, pois em 28 de julho migramos o TabNews do Next.js v12.1.6 para v12.2.3, o que engloba as altera√ß√µes abaixo:

- 21/09/21 - o par√¢metro experimental `nftTracing` foi renomeado para `outputFileTracing` (https://github.com/vercel/next.js/commit/9c86953745039738fb8890a4aeebdbceab984989);
- 23/10/21 - o `outputFileTracing` passa a ser `true` por padr√£o (https://github.com/vercel/next.js/pull/30202/commits/1c78e612639cd8be881510fcb49bed1e9aca5bf9);
- 26/10/21 - o `outputFileTracing` deixa de ser experimental (https://github.com/vercel/next.js/pull/30295/commits/20898f786a838bde5bb089ce3d6235190db184a5).
  </pull_642_A configura√ß√£o experimental nftTracing n√£o √© mais necess√°ria>

<pull_643_Cobre de testes todo `header` da requisi√ß√£o>
O @aprendendofelipe pegou um detalhe importante que faltou no PR #640 que foi a falta de testes para evitar essa regress√£o, e a id√©ia inicial era s√≥ testar os headers sobre o `CORS`, mas eu acabei fazendo um `assertion` com `toStrictEqual()` para pegar nos testes qualquer novo cabe√ßalho que possa ser adicionado sem a gente notar, e com isso tamb√©m cobrir os cabe√ßalhos sobre `Security Header`.
</pull_643_Cobre de testes todo `header` da requisi√ß√£o>

<pull_646_Altera ganho de `tabcoins` de `5` para `1` a cada publica√ß√£o>
Este PR faz duas coisas:
64f2be698f9d8cc0f755a2115c626ec46fc58c41

1. Como conversamos no passado, este PR altera o ganho de `5` `tabcoins` para `1` a cada publica√ß√£o.
   1a33792b514f1089b9261f1c6a1dcda28c130d13
1. Agora se um usu√°rio deleta um conte√∫do que possui `tabcoins` positivas, estas `tabcoins` s√£o debitadas do saldo do usu√°rio.
1. Isto √© uma medida de prote√ß√£o contra abusos usando m√∫ltiplas contas e tentando esconder publica√ß√µes ocas.
1. E tamb√©m j√° acompanhei no passado pessoas criando publica√ß√µes com valor concreto (eram perguntas), recebendo novas `tabcoins`, e depois que tinham a resposta, deletavam publica√ß√£o. Ent√£o se a pessoa escolher deletar o conte√∫do e levando consigo o valor concreto, tudo bem, mas acredito ser justo pelo menos debitar as `tabcoins` que foram adicionadas nessa publica√ß√£o.
1. Se o conte√∫do j√° est√° com valor negativo de `tabcoins`, ao deletar ele n√£o s√£o creditadas de volta as `tabcoins` e ainda √© debitado a `tabcoin` original que o autor ganhou ao criar a publica√ß√£o.
   </pull_646_Altera ganho de `tabcoins` de `5` para `1` a cada publica√ß√£o>

<pull_649_Altera ganho de `tabcoins` de `1` para `2` a cada publica√ß√£o>
65f2f53fad3b6010fd2e09b27403520b2d530df1

1. Faz o Gitpod parar de levantar as mensagens sobre as portas `1080`, `1025`, e na porta `3000`, ao inv√©s de abrir o navegador, apenas notifica que a porta est√° aberta.
2. Tamb√©m faz parar de rodar o `npm run dev` quando inicializa o workspace, mas mant√©m a instala√ß√£o do `nvm` e do `npm install`.
3. @coffee-is-power veja se concorda com essas altera√ß√µes, pois foi voc√™ quem criou o `.gitpod.yml`. Fiz essa altera√ß√£o porque comecei a usar o Gitpod ao inv√©s do Codespaces e o comportamento anterior estava atrapalhando muito na hora de desenvolver usando testes automatizados. Era muita notifica√ß√£o e abertura de p√°gina desnecess√°ria.
   b5b1fb883b9a960b261a7da3e458df3991d74803
4. O @aprendendofelipe especulou algo importante e interessante ap√≥s o merge do PR #647 que falava sobre a economia do TabNews n√£o ter tabcoins suficientes ap√≥s a altera√ß√£o de `5` para `1` tabcoins ganhos por publica√ß√£o.
5. Em paralelo, hoje o meu usu√°rio `filipedeschamps` tem mais tabcoins que publica√ß√µes para qualificar, isso que eu qualifico muitas vezes a mesma publica√ß√£o mais de uma vez.
6. Ent√£o natural tentarmos descobrir um meio termo na tentativa e erro, e para isso esse commit faz a altera√ß√£o de `1` para `2` tabcoins a cada publica√ß√£o. Isso faz a pessoa j√° conseguir fazer uma qualifica√ß√£o logo ap√≥s criar uma publica√ß√£o.
7. Tamb√©m tentei expandir um pouco mais a regra e a explica√ß√£o dentro do c√≥digo sobre o que acontece quando um conte√∫do √© deletado. Agora a quantidade a ser debitada num `delete` leva em considera√ß√£o o ganho padr√£o do conte√∫do. Isso significa que a nova regra √©:
   1. Primeiro pega a quantidade atual de `tabcoins` do conte√∫do.
   2. Debita desse valor a quantidade padr√£o de `tabcoins` que o conte√∫do ganha, que hoje √© `1`.
   3. Depois, soma nesse valor a quantidade padr√£o que o usu√°rio ganhou de `tabcoins`, que agora com esse PR √© `2`.
   4. Com o valor final, muda o sinal para negativo.
8. Mas, se o valor atual de `tabcoins` do conte√∫do √© negativo, fica a mesma coisa que antes e s√≥ debita a quantidade padr√£o de tabcoins que o usu√°rio ganhou ao criar o conte√∫do, que √© `2`.
   </pull_649_Altera ganho de `tabcoins` de `1` para `2` a cada publica√ß√£o>

<pull_651_refactor(content): refactor `amountToDebit` to use absolute value>
No model de `content`, o valor `amountToDebit` estava negativo, e ap√≥s [esse coment√°rio](https://github.com/filipedeschamps/tabnews.com.br/pull/649#issuecomment-1214967434) do @aprendendofelipe fez total sentido trabalhar com ele de forma positiva e s√≥ ap√≥s no final deixar ele negativo.
Bom, ao menos eu espero que era isso que o @aprendendofelipe sugeriu ü§ù üëç
</pull_651_refactor(content): refactor `amountToDebit` to use absolute value>

<pull_657_Implementa Rate Limit na API: Rotas com `POST`, `PATCH` e `DELETE`>
Neste PR vou continuar a inser√ß√£o de rate-limit nas rotas da API, dando prefer√™ncia para rotas com `POST`, `PATCH` e `DELETE`.
65fe7602aa7749a2268ad09e2f93540b45339a77

- **Mas antes de adicionar as outras rotas**, notei que ficaria um saco gerenciar a estrutura de dados que configura os limites, tanto no c√≥digo quanto nas vari√°veis de ambiente, ent√£o refatorei tudo.
- Agora as configura√ß√µes que est√£o registradas no c√≥digo e nas vari√°veis de ambiente n√£o se substituem, elas se **mesclam**.
- Fora isso, cada configura√ß√£o de rota n√£o possui mais um nome pr√≥prio, como `postSessions` e agora isso √© deduzido pela request para automaticamente formar a chave de configura√ß√£o, como `"POST /api/v1/sessions"`.
- Isso significa que **n√£o √© mais necess√°rio alterar o c√≥digo** para criar limites espec√≠ficos para as rotas, basta alterar a vari√°vel de ambiente. Ent√£o n√£o precisamos mais declarar algo como `if (method === 'POST' && path === '/api/v1/sessions')` para cada rota que quisermos controlar um limite espec√≠fico.
- Por √∫ltimo, estou me incomodando muito com o `snakeize` e tive que fazer uma gambiarra no log do middleware para ele logar o `message` quando √© um erro padr√£o do JavaScript. Um exemplo √© logar um erro jogado pelo `JSON.parse()`. Sem essa gambiarra, o que aparecia no log era o seguinte: `{}`.
  Mais para frente vou incluir no `defaultLimits` outras rotas.
  </pull_657_Implementa Rate Limit na API: Rotas com `POST`, `PATCH` e `DELETE`>

<pull_660_Remove a propriedade `username` do `content`>
Eu estava com uma expectativa que seria **super f√°cil** remover a propriedade `username` do objeto de `content`, assim como foi super f√°cil adicionar a propriedade `owner_username` no PR #618, mas foi **extremamente trabalhoso**.
Os testes de integra√ß√£o ajudaram bastante, ent√£o estou bem seguro que est√° tudo ok na API, por√©m o que n√£o estou t√£o seguro √© o que as p√°ginas usam, principalmente as que precisam de `getStaticProps()`, pois n√£o h√° nenhum teste E2E para o frontend, ent√£o precisei revisar tudo, desde o que aparece no t√≠tulo da p√°gina at√© o que o componente de `thumbnail` usa do objeto de `content`.
E a busca pelo termo puro `username` traz muito resultado que n√£o tem nada a ver, pois √© um campo v√°lido desde o que se recebe no `path`, por exemplo `/contents/[username]` (que no final das contas √© tunelado para uma busca por conte√∫dos com o `owner_username`), quanto tudo que √© relacionado ao objeto `user`.
Estou abrindo o PR, mas pe√ßo que se poss√≠vel revisem. Vou continuar revisando ele e testando em Homologa√ß√£o. Como falei, infelizmente toda parte do frontend precisa de cobertura manual.
</pull_660_Remove a propriedade `username` do `content`>

<pull_661_Remove markdown do `body` do conte√∫do por dentro do `getStaticProps`>
Este PR tem como objetivo resolver a issue #650
Com esse PR n√≥s passamos a utilizar o model `removeMarkdown` por dentro do `getStaticProps` nos lugares em que o componente `DefaultLayout` recebe o conte√∫do pela propriedade `content`, passando a limpar o `body` do conteudo pelo server-side.
A implementa√ß√£o em si me parece simples, no entando, uma dificuldade que tive foi comprovar que a modifica√ß√£o que eu fiz, de fato, ocorreu em todos os lugares que devia. E esse √© um ponto que pe√ßo a ajuda de voc√™s, se realmente o √∫nico lugar em que o `DefaultLayout` recebe a propriedade `content` √© no arquivo `pages/[username]/[slug]/index.public.js` :+1:

> > Review de filipedeschamps (COMMENTED):
> > @kaique-soares muito obrigado pela contribui√ß√£o!!!!!! Eu n√£o rodei o c√≥digo, mas fiz umas sugest√µes, veja se faz sentido ü§ù
> > Review de filipedeschamps (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > @filipedeschamps, deixei os dois commits separados para ser f√°cil de reverter para a vers√£o que voc√™ achar melhor. Mas agora que entendi sua inten√ß√£o com o `BaseLayout`, ou seja, que voc√™ queria garantir a presen√ßa das tags em qualquer p√°gina que seja criada futuramente, ent√£o a √∫ltima vers√£o √© a que garante isso. Se aprovar eu fa√ßo squash dos dois √∫ltimos commits.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Se voc√™ sobrescrever o `body` com o valor do `cleanBody`, ser√° que isso n√£o vai remover o markdown dos conte√∫dos da p√°gina? Eu n√£o rodei aqui e estou dando esse palpite s√≥ pela leitura do c√≥digo, posso estar bastante enganado ü§ù
> > De qualquer forma, estou pensando aqui, talvez podemos criar uma terceira vari√°vel que √© retornada no `props` l√° em baixo, por exemplo:

```js
      contentFound: JSON.parse(JSON.stringify(secureContentValues)),
      childrenFound: JSON.parse(JSON.stringify(secureChildrenList)),
      sanitizedMetadata: ...
```

E al√≠ voc√™ j√° colocaria todo o metadado sanitizado, incluindo com o `.substring(0, 190)` por exemplo no caso do `body`, ou o do `title` e todas as informa√ß√µes que s√£o enviadas aqui:

```js
<DefaultLayout content={contentFound}>
```

Ent√£o ao inv√©s de enviar o `contentFound`, enviar o `sanitizedMetadata`, que √© um objeto muito similar ao `contentFound`, mas s√≥ com os dados que o `DefaultLayout` precisa e todos j√° sanitizados/trabalhados.

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Outro detalhe √© fazer o rebase e resolver o conflito ü§ù
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Se voc√™ sobrescrever o `body` com o valor do `cleanBody`, ser√° que isso n√£o vai remover o markdown dos conte√∫dos da p√°gina? Eu n√£o rodei aqui e estou dando esse palpite s√≥ pela leitura do c√≥digo, posso estar bastante enganado :handshake:
> > Nos testes em `localhost` n√£o houve perda da formata√ß√£o mas especulo que tenha sido um falso positivo, justamente por eu ter testado apenas em `localhost`, por causa do `getStaticProps`. Vou investigar e **testar em `homologa√ß√£o`** :handshake:
> > De qualquer forma, estou pensando aqui, talvez podemos criar uma terceira vari√°vel que √© retornada no `props`...
> > Aaah **sensacional** :heart_eyes: Vou implementar, e pelo √¢ngulo que eu tava olhando nunca teria pensado nisso, apesar de ter visto essa abordagem no passado, na playlist dos rob√¥s! :exploding_head:
> > Outro detalhe √© fazer o rebase e resolver o conflito :handshake:
> > :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > `rebase` feito e conflito resolvido :+1:
> > E com isso, destaco alguns pontos:

1. Para resolver o conflito e n√£o quebrar nada, voltamos a utilizar o model `removeMarkdown` como antes, por dentro do `DefaultLayout`, ent√£o, no fim das contas a din√¢mica de limpar o `body` do conte√∫do pelo client-side continua e √© isso que vou atacar agora, trabalhando na quest√£o do `sanitizedMetadata` que tu sugeriu :+1:
2. Sobre o `rebase`, nunca havia utilizado o comando antes, conhecia mas n√£o havia aplicado ainda, ent√£o, n√£o sei se foi a estrat√©gia mais adequada, come√ßar por ele ou ter continuado a implementa√ß√£o e feito o `rebase` depois.
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Sobre o item `2`, eu sempre prefiro fazer o rebase antes para deixar a branch limpa de `merge commits` o m√°ximo que der üëç mas n√£o existe o certo ou errado, s√£o estrat√©gias com trade-offs diferentes ü§ù
   > > Coment√°rio de kaique-soares (linha de c√≥digo):
   > > @filipedeschamps ap√≥s o [commit](https://github.com/filipedeschamps/tabnews.com.br/pull/661/commits/be9c29f03afe7088cd52893d8bfe6d13abe3296f), em que trabalhei na implementa√ß√£o do `sanitizedMetadata`, fui investigar o ponto que tu levantou:
   > > Se voc√™ sobrescrever o `body` com o valor do `cleanBody`, ser√° que isso n√£o vai remover o markdown dos conte√∫dos da p√°gina?...
   > > E **sim**, foi um falso positivo:
   > > Nos testes em `localhost` n√£o houve perda da formata√ß√£o mas especulo que tenha sido um falso positivo, justamente por eu ter testado apenas em `localhost`, por causa do `getStaticProps`. Vou investigar...
   > > E comprovei isso for√ßando o SWR usar o `fallbackData: contentFoundFallback`, quebrando a url da mesma postagem que antes "n√£o havia perdido a formata√ß√£o", porque ela perdia mas eu que n√£o percebi, foi um detalhe sutil que me deu uma rasteira sensacional :sweat_smile: e vou compartilhar isso no TabNews :handshake:
   > > </pull_661_Remove markdown do `body` do conte√∫do por dentro do `getStaticProps`>

<pull_662_Adiciona estrat√©gia `relevant`>
Seguindo o que foi explicado nessa issue #658 estou fazendo uma c√≥pia da `strategy` `best` e colocando como nome `relevant`. Por enquanto elas ir√£o rodar juntas, mas depois iremos fazer uma breaking change para por enquanto s√≥ manter a `relevant`.
</pull_662_Adiciona estrat√©gia `relevant`>

<pull_665_feat: componente de empty state>
Inspirado pela issue #663 que indica a n√£o centraliza√ß√£o da mensagem de "Nenhum conte√∫do encontrado" decidi trazer essa contribui√ß√£o. Trata-se principalmente de um componente respons√°vel por exibir uma mensagem indicando a n√£o presen√ßa de conte√∫do com op√ß√µes de t√≠tulo, descri√ß√£o √≠cone e a√ß√£o.
O fato da mensagem n√£o estar sendo centralizada √© por estar sendo renderizada dentro de um grid que s√≥ tem utilidade em caso de existir conte√∫do, ent√£o apenas modifiquei para que somente renderize esse grid se a lista possuir conte√∫do, caso n√£o possuir exibe o componente criado com uma mensagem padr√£o.
E para finalizar programei a possibilidade de passar ao componente de lista propriedades para serem "spredadas" no componente EmptyState, com isso coloquei uma mensagem personalizada na p√°gina inicial e na p√°gina de usu√°rio, inclusive nesse √∫ltimo caso mostrando o bot√£o de publicar conte√∫do caso o perfil fosse o do usu√°rio logado seguindo a sugest√£o da issue.

> > Review de aprendendofelipe (COMMENTED):
> > @luantoningalvan, muito bom!!! ü§©
> > A √∫nica coisa que √© s√≥ um detalhe, mas eu tentaria arrumar, √© um pequeno _layout shift_ que ocorre quando muda do `username` para `Voc√™` e tamb√©m ao renderizar o bot√£o de a√ß√£o. No meu computador √© impercept√≠vel por causa do cache de usu√°rio, mas usando a ferramenta de performance d√° pra pegar, ent√£o isso pode ser ruim para algu√©m com um dispositivo mais fraco.
> > Uma op√ß√£o √© aguardar o `isLoading` do `useUser` antes de mostrar a mensagem e enquanto isso renderizar algo invis√≠vel que ocupe o mesmo espa√ßo, incluindo o bot√£o.
> > √ìtimo trabalho! üëç
> > </pull_665_feat: componente de empty state>

<pull_667_Traz o contexto do conte√∫do `root` para Notifica√ß√µes, Respostas e API>
Este PR implementa o m√©todo `findRootContent()` dentro do model `content` que em resumo recebe um `id` de algum conte√∫do **filho** e navega na √°rvore de conte√∫dos at√© localizar o conte√∫do **raiz** (o primeiro conte√∫do). Por exemplo:

```js
const rootContent = await content.findRootContent({
  where: {
    id: childContent.id,
  },
});
```

O que devolve o objeto do conte√∫do raiz:

```json
{
  "id": "7f534133-c78c-4128-9e6c-6a05b91f7d1b",
  "parent_id": null,
  "owner_id": "4f80c6c4-52c4-4b3f-bee0-452af5c8bfb9",
  "slug": "testando-o-novo-metodo-findrootcontent-que-vai-poder-trazer-muito-mais-contexto",
  "title": "Testando o novo m√©todo findRootContent() que vai poder trazer muito mais contexto",
  "body": "Estou criando essa publica√ß√£o para tirar alguns print-screens ü§ù",
  "status": "published",
  "source_url": null,
  "published_at": "2022-08-21T20:47:53.772Z",
  "created_at": "2022-08-21T20:47:53.571Z",
  "updated_at": "2022-08-21T20:47:53.571Z",
  "deleted_at": null,
  "owner_username": "filipedeschamps",
  "tabcoins": 1,
  "children_deep_count": 2,
  "parent_title": null,
  "parent_slug": null,
  "parent_username": null
}
```

A partir deste m√©todo, foi poss√≠vel:

## Expor novo endpoint

Nos endpoints de conte√∫do agora √© poss√≠vel adicionar o p√≥s-fixo `/root` (assim como o `/children`) que devolve o conte√∫do `root`.

- **Conte√∫do filho**
  https://tabnews-git-root-content-tabnews.vercel.app/api/v1/contents/filipedeschamps/d926fc84-47d3-4fcd-a6a6-b88ed8df9f86
- **Conte√∫do root a partir do conte√∫do filho acima**
  https://tabnews-git-root-content-tabnews.vercel.app/api/v1/contents/filipedeschamps/d926fc84-47d3-4fcd-a6a6-b88ed8df9f86/root

## Contextualizar notifica√ß√µes por email

Agora todos os emails vem com um peda√ßo do t√≠tulo do conte√∫do raiz, independente da profundidade no n√≠vel hier√°rquico das respostas:

## Contextualizar p√°ginas das respostas

Se voc√™ estiver dentro da p√°gina que response **diretamente** uma publica√ß√£o raiz, nada muda, a n√£o ser um pequeno √≠cone de "conversa":
Mas se voc√™ estiver dentro da p√°gina onde uma resposta est√° respondendo outra resposta, agora voc√™ consegue ver qual o contexto desta discuss√£o:
</pull_667_Traz o contexto do conte√∫do `root` para Notifica√ß√µes, Respostas e API>

<pull_668_fix(localstorage): change user on the same device see draft of anothe‚Ä¶>

## ü§î Por que voc√™ est√° abrindo esse Pull Request?

Conforme conversado na Issue #653 estou aplicando a sugest√£o escrita pelo @aprendendofelipe quando um usu√°rio faz o logoff mantem algumas informa√ß√µes de preferencia como rascunho e tema armazenados na maquina, possibilitando que outro usu√°rio consiga ter acesso fazendo o login.

## üßê Descreva sua solu√ß√£o:

A solu√ß√£o foi simplesmente alterar o `localStorage.removeItem('user')` por `localStorage.clear()` na fun√ß√£o `logout`.

> > Review de aprendendofelipe (APPROVED):
> > Boaaa!!! üöÄ
> > </pull_668_fix(localstorage): change user on the same device see draft of anothe‚Ä¶>

<pull_672_perf(content): embed findChildrenCount() query inside findAll() method>
Usando a mesma estrat√©gia de subquery aplicada no PR #667 para o m√©todo `findRootContent()`, o m√©todo `findAll()` agora tamb√©m busca a quantidade de conte√∫dos filho em uma ida ao banco de dados. Antes, uma busca ao banco de dados por uma lista de conte√∫dos sempre fazia o dobro de buscas do valor encontrado na pagina√ß√£o para pegar todos os filhos dos conte√∫dos.
Em alguns minutos envio aqui os testes de performance para entender o que aconteceu no ambiente de homologa√ß√£o.
</pull_672_perf(content): embed findChildrenCount() query inside findAll() method>

<pull_675_feat(header): set header link to active>

## objetivo

Indicar em qual p√°gina estamos

## o que mudou?

- [x] estiliza√ß√£o padr√£o para quando o `header link` estiver ativo
- [x] verifica√ß√£o em cada link para saber se ele deve ser ativo ou n√£o
- [x] Trocar `TabNews` por `Relevantes`
- [x] esconder `Status` quando estiver no Mobile

## evidencias

<div>
</div>
</pull_675_feat(header): set header link to active>

<pull_676_Mudan√ßa de comportamento no `/root` e exposi√ß√£o do `/parent`>
e9521bb85918667dc17b835534f66532bbb88edc

- Apenas uma leve otimiza√ß√£o, que quando o campo `parent_id` n√£o est√° preenchido, n√£o tem o que pesquisar, o conte√∫do j√° √© o `root`.
  24823f547fd259f0282b91770403be34a94c298a

- Primeira tentativa de retornar dados mascarados quando um conte√∫do `root` n√£o est√° com o status `published`.
- Ent√£o por exemplo, se um conte√∫do `root` foi deletado e voc√™ acessar ele atrav√©s de um `child`, ser√° retornado o seguinte:

```json
{
  "id": "7cabce07-9966-44cd-8048-afd96507cfc1",
  "parent_id": null,
  "owner_id": "35fe088d-c11f-4c6c-868d-9ba55086b4c0",
  "slug": "nao-disponivel",
  "title": "[N√£o dispon√≠vel]",
  "body": "[N√£o dispon√≠vel]",
  "status": "deleted",
  "source_url": null,
  "published_at": "2022-08-23T21:03:37.683Z",
  "created_at": "2022-08-23T21:03:37.690Z",
  "updated_at": "2022-08-23T21:03:37.773Z",
  "deleted_at": "2022-08-23T21:03:37.767Z",
  "owner_username": "NicklausWilkinson",
  "tabcoins": 1,
  "children_deep_count": 0,
  "parent_title": null,
  "parent_slug": null,
  "parent_username": null
}
```

- Com um por√©m, os campos `parent_title`, `parent_slug`, `parent_username` ser√£o removidos mais para frente em outros commits nesse PR.
- Isto revelou um furo na implementa√ß√£o, onde o endpoint retorna os dados mascarados, mas a p√°gina est√°tica continua revelando eles:
  - Endpoint: https://tabnews-a5v5h4s99-tabnews.vercel.app/api/v1/contents/filipedeschamps/843d95c8-f31e-47c3-aa67-b7098a1a1c3b/root
  - P√°gina est√°tica: https://tabnews-a5v5h4s99-tabnews.vercel.app/filipedeschamps/843d95c8-f31e-47c3-aa67-b7098a1a1c3b
    </pull_676_Mudan√ßa de comportamento no `/root` e exposi√ß√£o do `/parent`>

<pull_677_Remove do `content` as propriedades `parent_title`, `parent_slug` e `parent_username`>
Este PR traz a **breaking change** comentada [nesta publica√ß√£o](https://www.tabnews.com.br/filipedeschamps/breaking-change-na-api-remocao-da-estrategia-best-e-informacoes-adicionais-de-parent-no-objeto-content) e tamb√©m remove o ru√≠do das queries causado por `as` redundantes.
E foi delicinha de fazer s√≥ por conta do `watch` nos testes automatizados. Eu **nunca** dormiria tranquilo com uma refatora√ß√£o dessas se n√£o tiv√©ssemos os atuais testes ü§ù
</pull_677_Remove do `content` as propriedades `parent_title`, `parent_slug` e `parent_username`>

<pull_678_feat(header): set header link to active (#675)>
PR intermedi√°rio do PR #675 do @gpaiva00 para for√ßar deploy em Homologa√ß√£o ü§ù

> > Review de gpaiva00 (APPROVED):
> > üòç
> > </pull_678_feat(header): set header link to active (#675)>

<pull_683_feat(content): decrease overall padding on mobile>
Uma das tarefas desta Milestone era melhorar o espa√ßamento quando a p√°gina era aberta em aparelhos com telas pequenas, uma vez que o mesmo espa√ßamento para Desktop estava sendo usado para Mobile em algumas situa√ß√µes.
A tentativa desse PR √© manter o layout agrad√°vel de ler, mas contrair o m√°ximo que der o espa√ßamento entre algumas √°reas importantes como, por exemplo, o espa√ßamento global nas bordas da p√°gina e o espa√ßamento entre os bot√µes das TabCoins e o Conte√∫do que, a cada n√≠vel de resposta, este espa√ßamento √© adicionado. Ent√£o por exemplo, o espa√ßamento padr√£o nesta √°rea estava em `2` pixels, e numa √°rvore de `5` respostas, era ocupado `10` pixels. Isso numa tela pequena pode representar bastante coisa.
E @aprendendofelipe esse PR tamb√©m remove aquela regra de `calc` do CSS com a sua t√©cnica do `overflow`, isso foi fundamental para conseguir fazer os espa√ßamentos responsivos ü§ù

## Testes

Os prints abaixo foram feitos simulando um `iPhone SE` que √© um dos menores que existem e com estas duas branches:

- Antes: https://tabnews-git-remove-best-strategy-tabnews.vercel.app
- Depois: https://tabnews-git-compact-tabcoins-space-tabnews.vercel.app

## Home

Mesmos conte√∫dos, coube at√© mais `1,5` itens na tela.
| Antes | Depois |
| :---: | :----: |

## Conte√∫do (topo)

Aqui apesar do modelo novo n√£o parecer ter muito impacto, eu sinto que a leitura come√ßa mais perto da esquerda da tela e isso fica mais confort√°vel.
| Antes | Depois |
| :---: | :----: |

## Conte√∫do (fundo)

O objetivo aqui n√£o √© trazer uma solu√ß√£o para o problema de respostas infinitas, isso tem que ser feito com outra abordagem (por exemplo, a partir do n√≠vel X aparecer um link para abrir o restante das mensagens em outra p√°gina), mas a ideia √© tentar n√£o desperdi√ßar tanto espa√ßo e tamb√©m n√£o ter uma quebra de linha na data da publica√ß√£o.
Ent√£o note que na vers√£o nova couberam **2 respostas completas nesse caso** (incluindo o bot√£o logo acima ainda).
| Antes | Depois |
| :---: | :----: |
</pull_683_feat(content): decrease overall padding on mobile>

<pull_685_fix(transactions): serializable isolation level>
Mudan√ßa do n√≠vel de isolamento das transa√ß√µes com Tabcoins para que ocorram de forma serializada.
A motiva√ß√£o foi a issue #670 que demonstrou que transa√ß√µes simult√¢neas poderiam permitir votar nos conte√∫dos mesmo sem ter Tabcoins suficientes.

### Para isso, as altera√ß√µes diretas s√£o:

1. Mudan√ßa no n√≠vel de isolamento da transa√ß√£o
2. Cria√ß√£o de um loop que faz cinco tentativas de processar a transa√ß√£o em caso de erro na serializa√ß√£o
3. Retorno de mensagem de erro para o caso de falharem as 5 tentativas
4. Adicionado o erro 40001 (serialization_failure) nas exce√ß√µes do logger
   J√° as mudan√ßas indiretas s√£o necess√°rias para permitir executar os testes em condi√ß√µes parecidas com as encontradas no ambiente da Vercel. Isso porque em ambiente de desenvolvimento e de testes n√≥s n√£o utilizamos as lambdas, ent√£o todas as requisi√ß√µes s√£o atendidas pela mesma inst√¢ncia do servidor.
   Na Vercel, requisi√ß√µes simult√¢neas s√£o sempre atendidas por inst√¢ncias diferentes, portanto o pool de conex√µes √© configurado para o limite de uma conex√£o. J√° em outros ambientes n√≥s precisamos liberar mais conex√µes para conseguir fazer testes que s√≥ dariam problemas em condi√ß√£o de concorr√™ncia. Pois se mantivermos o limite de 1 conex√£o, o pool j√° vai isolar as transa√ß√µes serialmente, mas isso n√£o vai representar o que ocorre em produ√ß√£o.

### Mudan√ßas s√≥ em ambiente de desenvolvimento/testes/ci:

1. Aumento do limite do pool para 3 conex√µes. Poder√≠amos deixar um valor bem maior, mas optei por um valor baixo para rodar de maneira parecida em qualquer n√≠vel de hardware.
2. O pool n√£o √© mais encerrado em nenhuma condi√ß√£o.
3. Os testes verificam as consist√™ncias das transa√ß√µes concorrentes.
4. Os testes verificam se s√£o retornados os erros corretos quando uma transa√ß√£o falha 5 vezes por motivo de serializa√ß√£o.
   Inclusive o √∫ltimo teste √© importante, pois ele falha se deixarmos o limite do pool com o valor padr√£o (1), j√° que n√£o ser√° gerado nenhum erro de serializa√ß√£o.

### D√≠vidas:

1. Essa altera√ß√£o vai barrar n√£o somente um usu√°rio que esteja rodando algum script para dar votos (por causa da `user_current_tabcoin_balance`), mas tamb√©m vai dar um aviso de "excesso de votos simult√¢neos" caso uma publica√ß√£o receba muitos votos ao mesmo tempo, mesmo que de diferentes usu√°rios. Acredito que isso ir√° demorar para virar um problema. E a solu√ß√£o √© retirar a consulta do saldo final de Tabcoins da publica√ß√£o (`content_current_tabcoin_balance`) de dentro da transa√ß√£o, j√° que essa informa√ß√£o n√£o √© condicional para nenhum passo da transa√ß√£o.
2. Uma maneira melhor de capturar o erro `error.stack?.startsWith('error: could not serialize access due to read/write dependencies among transaction'`
   > > Review de filipedeschamps (COMMENTED):
   > > Review de aprendendofelipe (COMMENTED):
   > > Review de filipedeschamps (COMMENTED):
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Eu deixei esse campo por vest√≠gios de testes no passado, infelizmente precisa ser `0` para desativar ele. De todos os testes que fiz, em nenhuma situa√ß√£o o backend do postgres pode encerrar a conex√£o pelo lado dele que 100% das vezes a pr√≥xima request na lambda dava um erro interno.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Exato! Quero ver esse erro e tratar, pois suspeito que o comportamento ser√° bem melhor se o banco desconectar as lambadas congeladas. E caso a lambda suba novamente e encontre o erro, basta ela se conectar novamente.
   > > Mas acho que isso n√£o vai ser poss√≠vel reproduzir em ambiente de desenvolvimento, n√©? Ou voc√™ conseguiu?
   > > Coment√°rio de filipedeschamps (linha de c√≥digo):
   > > Pelo que lembro, acho que s√≥ nas lambdas mesmo :(
   > > Posso estar errado, mas o problema √© que o erro n√£o acontecia em c√≥digo, e sim em alguma camada antes da Lambda, ela por completo dava erro, era bizarro.
   > > Das coisas que anotei a respeito, a √∫nica que encontrei foi essa (no t√≥pico **Parameter group**): https://github.com/filipedeschamps/tabnews.com.br/pull/215
   > > Mas ser√° que vale a pena investir nisso agora, dado que vamos colocar rate limit na frente das rotas?
   > > </pull_685_fix(transactions): serializable isolation level>

<pull_688_feat(analytics): return only last `2 months`>
Uma tarefa pequena fora da Milestone, mas que vai ajudar a acompanhar melhor o gr√°fico na p√°gina `/status`. Antes a query pegava os dados desde o primeiro dia e isto acabava dando uma vis√£o ruim dado ao pico de registros do lan√ßamento da API. Fora que o gr√°fico entre cadastros de usu√°rios e cria√ß√£o de conte√∫dos estavam dessincronizados, pois havia mais dias de cadastros de usu√°rios do que de conte√∫dos (dado que essa feature veio depois).
Agora para todos os gr√°ficos estamos mostrando os √∫ltimos 2 meses.
</pull_688_feat(analytics): return only last `2 months`>

<pull_690_feat(next-link): added custom Link to Header>
Baseado em #682, s√≥ que utilizando o componente Link customizado
</pull_690_feat(next-link): added custom Link to Header>

<pull_692_fix(next-link): change Link component import/export>
Como observado pelo @luantoningalvan aqui https://github.com/filipedeschamps/tabnews.com.br/pull/690#issuecomment-1228933834, o next/link n√£o estava sendo aplicado no menu de usu√°rio.
A importa√ß√£o do `Link` estava retornando `undefined`.
Por isso foi realizada a mudan√ßa na forma como est√° sendo exportado o componente Link customizado para tamb√©m permitir ser importado do caminho `pages/interface/components/Link` e n√£o somente de `pages/interface`.
Assim √© poss√≠vel importar os dois componentes customizados da seguinte maneira:
`import { HeaderLink, Link } from 'pages/interface/components/Link';`
</pull_692_fix(next-link): change Link component import/export>

<pull*694_feat(footer): created footer component>
A proposta √© criar um **footer** para adicionar os links padr√µes para cada p√°gina, tais como: Termos de uso, lista de contribuidores e outras p√°ginas est√°ticas.
Estou criando este \_component* junto com o @aprendendofelipe, estamos realizando uma tarefa de pair programing para nosso MBA

> > Review de aprendendofelipe (DISMISSED):
> > </pull_694_feat(footer): created footer component>

<pull_698_refactor(register): remove password confirmation input>
Este PR traz duas altera√ß√µes no formul√°rio da p√°gina de **cadastro**:

---

1. Remove o campo de confirma√ß√£o de senha - `"Repita a senha"`
   | Antes | Depois |
   | ----- | ------ |
   | | |

---

2. Padroniza o comportamento do formul√°rio quando h√° um campo inv√°lido, **exibindo sempre o erro enquanto ele existir**, conforme os formul√°rios de outras p√°ginas, como `login` e `recupera√ß√£o de senha`

### Comportamento do formul√°rio de login

https://user-images.githubusercontent.com/57193392/187326411-3407d5c6-1fbc-4ee6-bee0-73bdcfae6d00.mp4

### Comportamento do formul√°rio de cadastro (antes)

https://user-images.githubusercontent.com/57193392/187328808-287fee7f-e747-4904-98d3-57a992aee4ab.mp4

### Comportamento do formul√°rio de cadastro (depois)

https://user-images.githubusercontent.com/57193392/187330802-c48fbc90-6ebf-4843-99e1-f78b2b3b7d81.mp4
</pull_698_refactor(register): remove password confirmation input>

<pull_699_Conseguir fazer o "nuke" de um usu√°rio e desfazer suas opera√ß√µes>

## Objetivos principais desta feature

1. Banir de forma permanente um usu√°rio.
2. Desfazer tudo o que ele fez no TabNews.

## Motivo

Quanto mais o TabNews crescer, maior ser√° a probabilidade de pessoas criarem **contas descart√°veis** para fazer alguma esp√©cie de ataque, coment√°rio agressivo direcionado ou alguma bagun√ßa qualquer e depois sumir. Hoje n√£o temos forma de banir um usu√°rio e desfazer o que ele fez no site, a n√£o ser rodar manualmente queries no banco de dados.

## Execu√ß√£o

fd2e36bd70e3d0bef8f03f11e39919aa6eeb8ac2

1. Adicionado nova feature `ban:user`
2. Adicionado `method` `DELETE` em `/api/v1/users/[username]`
3. Neste m√©todo √© poss√≠vel especificar o tipo de banimento, que por hora temos apenas um: `"ban_type": "nuke"`
4. Quem lida com isso √© um novo model `ban` que por enquanto exp√µe um m√©todo chamado `nuke`.
5. O m√©todo `nuke` faz coisas envolvendo v√°rios outros models e dados:
   1. Remove todas as features do usu√°rio.
   2. Expira todas as sess√µes dele.
   3. Despublica todos os conte√∫dos publicados.
   4. Desfaz todas as opera√ß√µes financeiras.
   5. Adiciona uma feature `nuked` para marcar que a conta tomou um nuke.
6. A estrat√©gia para reverter todas as opera√ß√µes financeiras foi:
   1. Criar um `event` do tipo `ban:user`.
   2. Encontrar todos os eventos criados pelo usu√°rio que est√° sendo banido.
   3. Se este evento gerou algum `balance_operation`, pegar o valor dele, inverter e registrar um novo `balance_operation`.
   4. Neste `balance_operation` invertido, marcar a origem dele como a do evento de `ban:user` criado l√° em cima. Assim poderemos desfazer um evento de banimento deste tipo.
7. Tudo isso acima significa que, se este usu√°rio negativou uma publica√ß√£o sua e com isso tanto a publica√ß√£o quanto o seu usu√°rio receberam `-1` TabCoins cada, no momento que este usu√°rio for **nuked**, estes valores s√£o devolvidos para o conte√∫do e para o seu usu√°rio. N√£o importa quantas vezes ele debitou o creditou, tudo isso ser√° desfeito.
8. Grande parte do trablho foi criar uma bateria de testes que fizesse todas as movimenta√ß√µes, conferisse o que aconteceu, e depois de banir o usu√°rio, verificar que tudo foi desfeito. Este teste em espec√≠fico tem `16` passos.
9. N√£o √© poss√≠vel fazer um nuke em um usu√°rio que j√° est√° com a feature `nuked`.
10. Tudo est√° dentro de uma transaction.
11. Em paralelo, o `patchValidationHandler` do controler `/users/[username]` n√£o estava fazendo os query parameters passarem pelo filtro do `validator`.
12. E mais um ponto para o TypeScript, pois eu estava usando de forma errada o m√©todo `balance.getTotal` dentro do model `user` e por sorte n√£o estava fazendo diferen√ßa para o atual est√°gio do TabNews. J√° foram `2` pontos para o TypeScript desde a cria√ß√£o do projeto.
13. E tamb√©m foi adicionado o tipo de evento `system:update:tabcoins`, que n√£o tem nada a ver com esse PR, mas √© o nome que foi usado quando marretamos o hist√≥rico de TabCoins e √© bom deixar isso mapeado no `validator`.
    6e0f65b426e13b923194542f5caa606d97bac194
14. Na p√°gina do usu√°rio (`/[username]`) adiciona o seu `username` como `h1`
15. Adiciona um menu de op√ß√µes, que por enquanto s√≥ serve para dar `nuke` no usu√°rio, ent√£o este menu s√≥ ir√° aparecer se o usu√°rio logado tiver a feature `ban:user`.
16. Ao escolher essa op√ß√£o, usu√°rio logado precisa confirmar duas vezes a opera√ß√£o.
17. Ainda nessa Milestone esse menu de op√ß√µes ir√° aparecer tamb√©m para o usu√°rio conseguir editar o seu perfil.
    </pull_699_Conseguir fazer o "nuke" de um usu√°rio e desfazer suas opera√ß√µes>

<pull_700_refactor(register): remove password confirmation input>
PR intermedi√°rio do PR #698 de @kaique-soares para for√ßar o deploy em ambiente de Homologa√ß√£o üëç
</pull_700_refactor(register): remove password confirmation input>

<pull_704_fix(syntax): remove duplicate 'await'>
Apenas a remo√ß√£o da express√£o `await` que est√° duplicada.

> > Review de aprendendofelipe (APPROVED):
> > Review de angeloreis (APPROVED):
> > </pull_704_fix(syntax): remove duplicate 'await'>

<pull_712_Cadastro: confer√™ncia de typo no campo `email`>
Roubei uma implementa√ß√£o que fiz pra [Newsletter](https://filipedeschamps.com.br/newsletter) que sugere o email correto caso a pessoa tenha digitado o dom√≠nio com algum **typo**. A pessoa pode tanto clicar na sugest√£o, quanto navegar com o teclado (`TAB` + `Enter`), que automaticamente o email vai ser ajustado e o foco vai ser colocado no campo da senha.

## Como eu constru√≠ a lista de typos?

A Newsletter recebia **muitos** cadastros com typos tipo `gmil`, `gmail.coom`, `hotmil`, `hotmali.com` e eu comecei a pesquisar m√≥dulos que faziam a sugest√£o de forma autom√°tica. Tem v√°rios, mas os resultados n√£o eram precisos... era uma automatiza√ß√£o que falhava em casos comuns que estavam aparecendo nos logs da Newsletter.
Ent√£o por um bom tempo fiquei monitorando a lista de `bounce` da Newsletter e preenchendo o array com as varia√ß√µes at√© que por v√°rios dias ela n√£o recebesse nenhum bounce por typo de dom√≠nio. Ent√£o aquela lista ali foi constru√≠da com **dados de produ√ß√£o**.
</pull_712_Cadastro: confer√™ncia de typo no campo `email`>

<pull_715_Habilita rate-limit em todas as rotas da API>
Ap√≥s o maravilhoso PR #685 do @aprendendofelipe sugiro passarmos todas as rotas da API por dentro do rate-limit. Ent√£o atualizei os coment√°rios para explicar a situa√ß√£o e fiz `skip` nos dois testes que quebram enquanto o Next.js n√£o conserta esse bug: https://github.com/vercel/next.js/issues/39262
Meu racional foi otimizar para prote√ß√£o dos endpoints em troca da "garantia" de que conseguimos criar e atualizar conte√∫dos com 20k caracteres. Coloquei "garantia" entre aspas, porque infelizmente n√£o h√° garantia alguma nesse caso, uma vez que o Middleware est√° se comportando de uma forma em `development` e outra forma em `preview` e `production`.
Em paralelo, caso seja necess√°rio desproteger o ambiente de homologa√ß√£o para testes de carga, basta alterar o middleware em um commit tempor√°rio ü§ù
</pull_715_Habilita rate-limit em todas as rotas da API>

<pull_718_Adiciona p√°gina `/perfil` e habilita fluxo de atualiza√ß√£o de email>
Este PR implementa a primeira vers√£o da p√°gina de Editar Perfil. Tem muito o que evoluir ainda, mas j√° fornece de uma forma f√°cil a altera√ß√£o do `username` e `email`. Ainda nessa Milestone irei incluir uma op√ß√£o de desabilitar as notifica√ß√µes por email, e numa pr√≥xima Milestone (ou se algu√©m quiser fazer nessa), integrar na p√°gina a altera√ß√£o de senha.
O v√≠deo abaixo mostra:

1. Op√ß√£o **Editar perfil** habilitada.
2. Editando o nome de usu√°rio.
3. Editando email e passando pelo fluxo de Confirma√ß√£o de email.
4. N√£o foi implementado por enquanto Altera√ß√£o de senha, mas h√° um link que redireciona para o fluxo de Recupera√ß√£o de Senha e que auto preenche o `username` por conveni√™ncia.
   https://user-images.githubusercontent.com/4248081/188969868-00920564-7163-44a3-8a4b-3494b76eb26c.mov

## Testes em Ambiente de Homologa√ß√£o

Voc√™ pode testar em ambiente de homologa√ß√£o pela URL https://tabnews-git-user-profile-tabnews.vercel.app/perfil por√©m **n√£o ir√° conseguir alterar o email** enquanto a migration deste PR n√£o for rodada ü§ù

> > Review de aprendendofelipe (DISMISSED):
> > Show!!!
> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Ahhh belo achado üòç
> > </pull_718_Adiciona p√°gina `/perfil` e habilita fluxo de atualiza√ß√£o de email>

<pull_720_Op√ß√£o de habilitar/desabilitar notifica√ß√µes por email>
Este PR adiciona a propriedade `notifications` ao objeto `user` e que pode conter o valor `true` (padr√£o) ou `false`. Esta propriedade √© usada para o usu√°rio decidir receber ou n√£o a notifica√ß√£o por email de respostas em suas publica√ß√µes. Junto deste PR tamb√©m foi atualizada a p√°gina `/perfil` para o usu√°rio conseguir controlar isso pelo client web.
E por hora, `notifications` √© uma propriedade **privada**, ou seja, n√£o ser√° retornada no endpoint p√∫blico do usu√°rio que fica em `/api/v1/users/[username]` e s√≥ pode ser acessada pelo endpoint `/api/v1/user` que requer autentica√ß√£o.
Em paralelo, eu fiquei aqui pensando em como j√° aproveitar essa migration para considerar planos futuros, por exemplo, outros tipos de notifica√ß√£o como `SMS` ou `Push`, mas vi que virou uma otimiza√ß√£o prematura e melhor deixar para quando o sistema final de notifica√ß√£o for constru√≠do, onde eu imagino que o controle disso n√£o ficar√° no objeto `user` e sim num outro objeto que conseguir√° controlar a notifica√ß√£o de uma forma mais fragmentada, incluindo assinar por notifica√ß√µes de conte√∫dos de outras pessoas ou at√© qualquer tipo de publica√ß√£o de qualquer outra pessoa.

---

Esta op√ß√£o j√° pode ser vista na p√°gina [`/perfil`](https://tabnews-git-user-notifications-tabnews.vercel.app/perfil) em Homologa√ß√£o, mas n√£o poder√° ser utilizada enquanto n√£o rodarmos a **migration** que est√° nesse PR.

> > Review de aprendendofelipe (APPROVED):
> > </pull_720_Op√ß√£o de habilitar/desabilitar notifica√ß√µes por email>

<pull_726_fix(content): date tooltip overflow, and added next/link>
Resolve o problema reportado em #722
O componente `tooltip` do Primer deveria lidar com o overflow sem problemas, mas ele ainda est√° em vers√£o `alpha`. Ent√£o o `tooltip` foi configurado com `position: 'absolute'` para contornar o problema.
Mas isso implica em n√£o funcionar mais o `textOverflow: 'ellipsis'`. Por isso foi configurado para a data ir para a segunda linha quando faltar espa√ßo (sem quebrar no meio do texto), mas devido ao `position: 'absolute'`, o tamanho exato da data n√£o est√° sendo considerado, mas sim um tamanho fixo de `90px`.
Como foi mexido nos links, j√° aproveitei e adicionei o componente `Link` personalizado. Mas achei que para esse caso era melhor deixar o prefetch desativado para os links que levam para a p√°gina das respostas.
E tamb√©m por mexer nos links, foi alterado o componente `Cancelar` que era um `Link` do Primer, mas agora √© um bot√£o.

> > Review de MiguelMachado-dev (COMMENTED):
> > Bom, o c√≥digo em si est√° bom, mas n√£o entendi o motivo deste ponto
> > Mas achei que para esse caso era melhor deixar o prefetch desativado para os links que levam para a p√°gina das respostas.
> > Algum motivo espec√≠fico para optarmos em deixar o prefetch desativado nesse caso?
> > Outro ponto que n√£o entendi foi o coment√°rio relacionado a quebra em telas menores, esse PR alterou esse comportamento ou algo do tipo? N√£o vi c√≥digo referente a responsivo
> > Review de MiguelMachado-dev (DISMISSED):
> > </pull_726_fix(content): date tooltip overflow, and added next/link>

<pull_729_Adiciona lista de contribuidores no `README` e p√°gina `/status`>
**Aten√ß√£o:** isto s√≥ ir√° funcionar quando o reposit√≥rio estiver **p√∫blico**. E quando estiver, todo novo contribuidor do projeto ter√° sua imagem de perfil do GitHub automaticamente inserida na lista.
Em paralelo, fiz uma simula√ß√£o usando o https://github.com/filipedeschamps/doom-fire-algorithm e ficar√° mais ou menos assim:
</pull_729_Adiciona lista de contribuidores no `README` e p√°gina `/status`>

<pull_734_Adiciona p√°gina `Termos de Uso` em `/termos-de-uso`>
Conforme conversado [nessa publica√ß√£o](https://www.tabnews.com.br/filipedeschamps/rfc-termos-de-uso-do-tabnews-preciso-de-ajuda-da-comunidade), este PR adiciona a p√°gina **Termos de Uso**.

> > Review de aprendendofelipe (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > A palavra conta ficou repetida "conta conta"
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Show! Belo achado üòç Uma pessoa sugeriu incluirmos algo sobre a API, da√≠ j√° aproveito para consertar isso ü§ù
> > </pull_734_Adiciona p√°gina `Termos de Uso` em `/termos-de-uso`>

<pull_736_Adiciona p√°gina `Contato` em `/contato`>
Este PR adiciona a p√°gina de contato que j√° pode ser vista aqui: https://tabnews-git-contato-tabnews.vercel.app/contato
Tamb√©m adiciona o arquivo `public/.well-known/security.txt` que √© uma esp√©cie de `robots.txt`, mas para falhas de seguranca.
</pull_736_Adiciona p√°gina `Contato` em `/contato`>

<pull_747_Solicitar conte√∫dos root e child de um usu√°rio separadamente>
Com esse PR √© poss√≠vel solicitar os conte√∫dos `root` e conte√∫dos `child` de um usu√°rio separadamente. (Ou obter todos os conte√∫dos do usu√°rio)

- `GET /api/v1/contents/[username]/root`: retorna os conte√∫dos root do usu√°rio
- `GET /api/v1/contents/[username]/`: retorna todos os conte√∫dos do usu√°rio
- `GET /api/v1/contents/[username]/children`: retorna os conte√∫dos child do usu√°rio
  > > Review de filipedeschamps (COMMENTED):
  > > Muito obrigado pela contribui√ß√£o @33gustavo33 e vou seguir com ela fazendo alguns pequenos ajustes e tamb√©m implementando a parte do frontend ü§ù
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > To pensando aqui, se com o que est√° no `validator` fica poss√≠vel fazer um injection aqui caso algum dia esse valor seja exposto na interface p√∫blica. Vou colocar outro coment√°rio no `validator`.
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > Esta √© a parte que eu vejo ser poss√≠vel fazer um injection no banco caso algum dia esse par√¢metro for exposto na interface p√∫blica (o que n√£o est√° hoje). Mas destaco isso dado que ele aceita uma string com qualquer valor e pelo que entendi, isso √© concatenado na linha 176 do `content`. O que talvez temos que fazer aqui √© limitar com um `.valid()` o que pode ser de fato enviado.
  > > O model `content` √© o que mais me faz querer voltar a usar um ORM, seria tudo muito mais f√°cil em alguns casos üòÇ
  > > Coment√°rio de filipedeschamps (linha de c√≥digo):
  > > Aqui vou alterar para `256` para ficar igual ao tamanho da propriedade `title` ü§ù
  > > </pull_747_Solicitar conte√∫dos root e child de um usu√°rio separadamente>

<pull_748_Nova estrat√©gia de relevantes (ainda pelo saldo de TabCoins)>
Esse PR altera a estrat√©gia de ranqueamento por relev√¢ncia dos conte√∫dos.
Agora os conte√∫dos com at√© uma semana de idade s√£o divididos em faixas de tempo de publica√ß√£o e, dentro das faixas, s√£o organizados pelo saldo de TabCoins (em breve iremos considerar uma outra estrat√©gia de Score que se baseia nos votos, mas n√£o somente o saldo de TabCoins).
Com isso podemos classificar um n√∫mero maior de conte√∫dos ao mesmo tempo, diferente do que ocorre atualmente onde a classifica√ß√£o ocorre somente nos 30 conte√∫dos de cada p√°gina.
Para compensar um pouco a diminui√ß√£o de performance pela query de ranqueamento mais pesada, foi eliminada a consulta que era feita apenas para buscar o `total_rows`. Agora esse valor √© obtido na mesma consulta.
Tamb√©m foi inserido os `paths` dentro de `getStaticPaths` para que os conte√∫dos relevantes tenham suas p√°ginas est√°ticas geradas durante o deploy.

> > Review de filipedeschamps (DISMISSED):
> > @aprendendofelipe por mim est√° √≥timo e est√° pronto para o merge üëç
> > O √∫nico detalhe que eu talvez alteraria √© na cor dos links gerados pelo `EndOfRelevant`. Ficou um pouco invis√≠vel, mas eu posso estar sendo um "usu√°rio falso" nesse ponto, porque eu fui atr√°s da feature, coisa que poder√° n√£o acontecer com um usu√°rio normal. Um usu√°rio normal poder√° ler os itens da lista at√© esbarrar com esse item especial. De qualquer forma, se achar que faz sentido ter um impacto visual maior, eu deixaria os links com a cor padr√£o de links, sem estilizar a parte de estarem visitados inclusive.
> > </pull_748_Nova estrat√©gia de relevantes (ainda pelo saldo de TabCoins)>

<pull_750_Corrigir o ranqueamento TOP3>
No PR #748 o ranqueamento acabou ficando invertido ap√≥s o `UNION` com a segunda janela (melhores conte√∫dos de 3 dias) e ent√£o o conte√∫do da primeira janela (melhor da semana) acaba sendo substitu√≠do pelo da segunda janela.
Esse PR corrige isso e aproveita para mudar `UNION` por `UNION ALL` que √© suficiente e deve performar um pouco melhor.
</pull_750_Corrigir o ranqueamento TOP3>

<pull_751_perf(database): change `retries` to be more forgiving and `maxConnectionsTolerance` more strict>
Conforme o que foi levantado por @aprendendofelipe no final [desse coment√°rio](https://github.com/filipedeschamps/tabnews.com.br/issues/735#issuecomment-1243063258) da issue #735.
</pull_751_perf(database): change `retries` to be more forgiving and `maxConnectionsTolerance` more strict>

<pull_754_Torna somente leitura as implanta√ß√µes realizadas com base na branch `beta` e implementa as vers√µes beta 1 e 2>
Implementa vers√µes betas de queries de ranqueamento para efetuarmos testes. Al√©m disso, para melhorar a seguran√ßa dos testes, tamb√©m estamos:

1. Excluindo a pasta API (o que vai causar erros nos testes).
2. For√ßando o encerramento de conex√µes com o banco de dados mais agressivamente.
   A beta1 √© uma nova proposta que limita os conte√∫dos que aparecem no topo a 36 horas e na segunda faixa em at√© 3 dias.
   A beta2 √© a proposta do @filipedeschamps aqui nesse coment√°rio https://github.com/filipedeschamps/tabnews.com.br/pull/748#issuecomment-1261099563
   </pull_754_Torna somente leitura as implanta√ß√µes realizadas com base na branch `beta` e implementa as vers√µes beta 1 e 2>

<pull_755_Corrige as rotas `beta` para utilizarem as queries corretas>
Al√©m de corrigir as rotas para utilizarem as queries corretas, agora est√° mais f√°cil criar novas varia√ß√µes de query, pois basta inclu√≠-las no arquivo `queries_beta.js` que ela j√° ser√° inclu√≠da no menu `Beta` do `Header`.
</pull_755_Corrige as rotas `beta` para utilizarem as queries corretas>

<pull_756_Query de ranqueamento Beta3>
Mais uma proposta de query de ranqueamento baseada nas considera√ß√µes a seguir.
Utilizando [intervalo de confian√ßa](https://en.wikipedia.org/wiki/Binomial_proportion_confidence_interval), foram estimadas as quantidades de votos positivos e negativos para podermos afirmar com 95% de certeza qual √© a relev√¢ncia do conte√∫do:
Obs.: Os votos positivos come√ßam em 1 na tabela, pois os conte√∫dos sempre come√ßam com 1 TabCoin, mas o c√°lculo foi efetuado com a quantidade real de votos, ou seja, de 0 a 19 positivos e de 0 a 10 negativos.
Por enquanto n√£o estamos computando separadamente os votos positivos e negativos, portanto foi feita a seguinte aproxima√ß√£o em que s√≥ temos acesso √† faixa em L de -10 a +20:
Obs.: S√≥ temos acesso ao saldo, mas n√£o podemos ignorar o fato de que um mesmo conte√∫do pode ter recebido votos positivos e negativos. Isso √© s√≥ uma aproxima√ß√£o inicial para a pr√≥xima vers√£o de ranqueamento, mas a vers√£o correta ir√° utilizar os valores reais de votos positivos e negativos (n√£o apenas o saldo).
Como podemos ver, com poucos votos n√£o d√° pra afirmar com muita certeza se um conte√∫do √© relevante ou n√£o. Ent√£o seria interessante os conte√∫dos novos surgirem no meio do ranking e subirem ou descerem conforme o passar do tempo e das qualifica√ß√µes. Com isso em mente, montamos a tabela abaixo com seis grupos divididos de acordo com a idade dos conte√∫dos e com a sua pontua√ß√£o.
Ent√£o deixamos a faixa 3 para os 5 conte√∫dos rec√©m postados, ou seja, que ainda n√£o temos como classificar, e a faixa 5 para os demais conte√∫dos que excederem aos 5 da faixa 3. Essa faixa 5 s√≥ ser√° ocupada quando muitos conte√∫dos novos forem postados e permanecerem sem qualifica√ß√£o.
| Grupo | Saldo m√≠n. | Tempo m√°x. | Qtd. reservada | Qtd. m√°x. | Excedente para para o grupo |
| ----- | ---------- | ---------- | -------------- | --------- | --------------------------- |
| 1 | 12 | 36 horas | 10 mais novos | 10 | 4 |
| 2 | 7 | 1 dia | 10 mais novos | 20 | 4 |
| 3 | 0 | 12 horas | 5 mais novos | 5 | 5 |
| 4 | 12 | 3 dias | 10 mais novos | 10 | 6 |
| 5 | 0 | 12 horas | 10 mais novos | 10 | 6 |
| 6 | 0 | 1 semana | - | - | - |
Outra forma de enxergar os dados da tabela acima:
Assim podemos imaginar alguns percursos diferentes que conte√∫dos postados ao mesmo tempo poderiam percorrer no ranking de acordo com as qualifica√ß√µes:
Notem que todos iniciam no grupo 3 e sobem ou descem de acordo com os votos e o passar do tempo. \* Esse tempo limite do Grupo 3 √© dinamicamente determinado de acordo com o volume de conte√∫dos, mas nunca ser√° maior do que 12h.
Todos esses par√¢metros podem ser ajustados, mas o mais indicado √© ajustar somente os tempos, caso n√£o estejam se comportando de acordo.
</pull_756_Query de ranqueamento Beta3>

<pull_757_feat(local-build): adds possibility to do local build>
Configura√ß√£o para permitir build local e possibilitar efetuar testes de problemas que n√£o ocorrem em modo de desenvolvimento.
</pull_757_feat(local-build): adds possibility to do local build>

<pull_758_fix(rank_beta3): group_4 where tabcoins > 11>
Configura o grupo 4 do ranqueamento Beta3 para ser ocupado somente por conte√∫dos com mais de 11 TabCoins, de acordo com o planejado em #756.
</pull_758_fix(rank_beta3): group_4 where tabcoins >

<pull_759_Remove caracteres inv√°lidos `\u200e`, `\u200f` e `\u0000` do `title`, `body` e `source_url`>
Elimina caracteres inv√°lidos do `title`, `body` e `source_url`:

- `\u0000` em qualquer parte da string.
- `\u200e` e `\u200f` no in√≠cio ou no fim da string (similar ao `trim`).
  Resolve o problema relatado em #731 e tamb√©m o apontado pelo @33gustavo33 [neste post](https://tabnews-git-contato-tabnews.vercel.app/Gustavo33/teste) no ambiente de homologa√ß√£o
  </pull_759_Remove caracteres inv√°lidos `\u200e`, `\u200f` e `\u0000` do `title`, `body` e `source_url`>

<pull_760_fix(content): reset state on route change>
Corrige o bug de respostas rec√©m criadas que acabam aparecendo em diferentes conte√∫dos (reportado em #745).
Agora o componente `Content`, que renderiza a resposta, recebe o `id` do conte√∫do pai como `key`. Dessa forma o componente sempre tem seu estado reiniciado quando navegamos para diferentes conte√∫dos.
</pull_760_fix(content): reset state on route change>

<pull_761_Envia o ranqueamento Beta3 para produ√ß√£o>
Envia para a `main` a vers√£o de ranqueamento testada como `Beta3` no PR #758 :
https://tabnews-git-beta-tabnews.vercel.app/relevantes_beta/Beta3

> > Review de fabriciolak (APPROVED):
> > </pull_761_Envia o ranqueamento Beta3 para produ√ß√£o>

<pull_765_fix(controller): change `request.connection` to `request.socket`>
Argumentos sobre essa altera√ß√£o est√£o [nessa issue](https://github.com/filipedeschamps/tabnews.com.br/issues/764).
Closes #764

> > Review de aprendendofelipe (APPROVED):
> > </pull_765_fix(controller): change `request.connection` to `request.socket`>

<pull_766_Enlarge header tooltips roll-over area>
Quando se est√° logado no site, notei que a √°rea que ativa as tooltips no canto superior direito (para explicar qual √© TabCoins e qual √© TabCash) era muito pequena, e passei um tempo achando at√© que n√£o tinha explica√ß√£o. Passei a tooltip para cobrir os quadrados coloridos tamb√©m.
Antes:
Depois:

> > Review de aprendendofelipe (DISMISSED):
> > Review de filipedeschamps (CHANGES_REQUESTED):
> > De fato a √°rea de `hover` aumentou, por√©m o layout ficou desalinhado. Coloquei prints na thread principal.
> > </pull_766_Enlarge header tooltips roll-over area>

<pull_767_Ranqueamento Beta4>
Adiciona a alternativa Beta4 de ranqueamento, que √© praticamente igual √† Beta3, mas com duas mudan√ßas no grupo5:

1. O limite de tempo passa de 12h para 72h (3 dias).
2. O saldo m√≠nimo de TabCoins passa de 0 para 2.
   Motiva√ß√£o: Melhorar o comportamento em per√≠odos de menos postagens, como nos finais de semana.
   </pull_767_Ranqueamento Beta4>

<pull_769_Envia o ranqueamento Beta4 para produ√ß√£o>
Envia para a `main` a vers√£o de ranqueamento testada como `Beta4` no PR #767:
https://tabnews-git-beta-tabnews.vercel.app/relevantes_beta/Beta4
Aproveita e j√°...
Resolves #768
</pull_769_Envia o ranqueamento Beta4 para produ√ß√£o>

<pull_773_Atualiza todas as depend√™ncias poss√≠veis>
Este PR √© uma manuten√ß√£o de todas as depend√™ncias, elevando elas para a √∫ltima vers√£o. Mas novamente como da √∫ltima vez que isto foi feito, nem todas as depend√™ncias foram atualizadas, seja por incompatibilidade com outras depend√™ncias, seja por bugs na novas vers√µes.
As depend√™ncias abaixo s√£o as que continuam desatualizadas:
A que mais me machucou de n√£o conseguir fazer o update foi a `@primer/react` (com reflexo no `react` e `react-dom`) por conta desse bug: https://github.com/primer/react/issues/2346
</pull_773_Atualiza todas as depend√™ncias poss√≠veis>

<pull_776_Aumenta a √°rea de `hover` das TabCoins e TabCash>
Este √© um PR intermedi√°rio do PR #766 do @tom-rb para for√ßar deploy em homologa√ß√£o.
</pull_776_Aumenta a √°rea de `hover` das TabCoins e TabCash>

---

<pull*780*`/publicar`: faz aparecer novamente a mensagem para usu√°rios com `0` publica√ß√µes>
Este PR conserta a primeira parte do que foi reportado em #779 e faz voltar aparecer a mensagem abaixo para usu√°rios com zero publica√ß√µes:
Em paralelo, carrega consigo o `package-lock.json` atualizado. Fiz besteira no √∫ltimo PR no meio dos testes e n√£o tinha gerado um arquivo com a exata √∫ltima vers√£o do teste ü§ù

> > Review de 33gustavo33 (APPROVED):
> > </pull*780*`/publicar`: faz aparecer novamente a mensagem para usu√°rios com `0` publica√ß√µes>

---

<pull_783_Altera o endpoint `api/v1/contents/[username]` para utilizar a antiga estrat√©gia de relevantes>
Fixes #779
Altera o endpoint `api/v1/contents/[username]` para utilizar a antiga estrat√©gia de relevantes, pois a nova estrat√©gia √© focada na lista de conte√∫dos sem filtro por usu√°rio.
Cria novos testes e corrige os existentes para validar o filtro de conte√∫dos por usu√°rio.

> > Review de 33gustavo33 (DISMISSED):
> > </pull_783_Altera o endpoint `api/v1/contents/[username]` para utilizar a antiga estrat√©gia de relevantes>

<pull_792_Atualiza para Next.js 13, al√©m de atualizar outras depend√™ncias e habilitar o Analytics>
J√° que o Next.js 13 cont√©m minha primeira e pequena contribui√ß√£o para o framework, nada mais justo do que eu trazer essa atualiza√ß√£o para c√°.
E junto trago as atualiza√ß√µes poss√≠veis das demais depend√™ncias.
Al√©m de habilitar novamente os testes de conte√∫dos com mais de 20.000 caracteres, que foi a origem da minha contribui√ß√£o para o Next.js
[Edit] Tamb√©m foi configurado [Analytics](https://vercel.com/docs/concepts/analytics/audiences/quickstart)
</pull_792_Atualiza para Next.js 13, al√©m de atualizar outras depend√™ncias e habilitar o Analytics>

<pull_794_Habilita Analytics>
O [Analytics](https://vercel.com/docs/concepts/analytics/audiences/quickstart) ainda est√° em beta, ent√£o deve possuir alguns bugs.
Um deles, que estava impedindo o funcionamento na primeira implementa√ß√£o #792, √© que a rota `/va/scripts.js` retornava um erro `404` por alguma incompatibilidade da configura√ß√£o de `i18n` no `next.config.js`.
Ent√£o removi essa configura√ß√£o e, como s√≥ temos `pt-br`, deixei fixo no `_document`.
</pull_794_Habilita Analytics>

<pull*804_Adiciona um intervalo de atualiza√ß√£o e a sincroniza√ß√£o do useUser entre diferentes abas>
Baseado na sugest√£o dada em #801, esse PR mant√©m mais atualizados os dados do usu√°rio no Header.
Primeiro ele mant√©m a sincroniza√ß√£o dos dados entre as abas em foco no mesmo dispositivo, ent√£o qualquer intera√ß√£o em uma aba (login, logout, tabcoins etc.) ir√° fazer os dados de qualquer outra aba que entrar em foco mostrar os dados mais atuais que j√° estar√£o no cache local (`localStorage`).
Al√©m disso, ao entrar em foco, se for verificado que o √∫ltimo \_fetch* ocorreu a mais de 10 minutos, um novo _fetch_ para `/api/v1/user` ir√° ocorrer para atualizar poss√≠veis mudan√ßas ocorridas em outros dispositivos (por exemplo o recebimento de tabcoins de outros usu√°rios).
Nada muda no primeiro carregamento da p√°gina (ou ao dar _refresh_), ou seja, continuamos fazendo o _fetch_ dos dados do usu√°rio se algum cache local for encontrado, independentemente da idade desse cache.

> > Review de ottomicheletti (DISMISSED):
> > Review de filipedeschamps (APPROVED):
> > </pull_804_Adiciona um intervalo de atualiza√ß√£o e a sincroniza√ß√£o do useUser entre diferentes abas>

<pull_805_Mostra conte√∫dos `child` na p√°gina do usu√°rio>
Este PR √© uma continua√ß√£o do PR #747 do @33gustavo33 e finaliza a feature de mostrar as respostas de um usu√°rio em sua p√°gina exclusiva.
Os √∫ltimos commits foram para limpar do backend o markdown que possa vir do `body` das respostas e por fim mostrar isso no client. A fun√ß√£o de encurtar o `body` e limpar ele ficou repetida, e preferi manter assim at√© o c√≥digo nos mostrar onde dever√° ficar melhor abstra√≠do.
Voc√™ pode ver o resultado final por essa URL do ambiente de homologa√ß√£o:
https://tabnews-git-users-route-tabnews.vercel.app/filipedeschamps
Em paralelo, eu especulo que isso possa contribuir com o SEO das respostas ü§ù

> > Review de 33gustavo33 (DISMISSED):
> > </pull_805_Mostra conte√∫dos `child` na p√°gina do usu√°rio>

<pull_809_Resolve o bug da mensagem "Conte√∫do apagado com sucesso">
Adiciona uma `key` ao conte√∫do `root` e `children` (fix #808).
No `children` foi mais pensando em performance do React, mas n√£o tem influ√™ncia no bug.
Ah, mas utilizou a mesma chave para os dois e para o componente `compact`. Pode isso?
Excelente pergunta! E pode sim!
A chave precisa ser √∫nica apenas entre seus elementos irm√£os. Elas n√£o precisam ser √∫nicas globalmente.

> > Review de cafesao (DISMISSED):
> > Review de matheuslipk (DISMISSED):
> > Review de JonathanArgentao (DISMISSED):
> > Review de filipedeschamps (DISMISSED):
> > Review de filipedeschamps (APPROVED):
> > </pull_809_Resolve o bug da mensagem "Conte√∫do apagado com sucesso">

<pull*811_feat(rate-limit): added 4s upstash service timeout>
Devido ao limite de tempo de 5 segundos do middleware, esse PR cria um \_timeout* e ignora o _rate-limit_ se n√£o houver uma resposta do Upstash dentro de 4 segundos.
Isso evita que a API do TabNews saia do ar em caso de problemas com o servi√ßo Upstash, conforme conversado [aqui](https://github.com/filipedeschamps/tabnews.com.br/issues/744#issuecomment-1252939012).
Eu criei uma conta no Upstash para fazer os testes desse PR, mas fica como tarefa futura a cria√ß√£o de testes para o _rate-limit_.
Bora aumentar a resili√™ncia do TabNews que o lan√ßamento est√° quase a√≠ üöÄ
</pull_811_feat(rate-limit): added 4s upstash service timeout>

<pull_819_fix(recovery): recovery email message>
Quando recebi o email de recupera√ß√£o de senha, notei um errinho gramatical na mensagem quando √© mencionado "uma solicita√ß√£o foi solicitada". Esse PR visa corrigir esse erro, propondo uma pequena altera√ß√£o na mensagem.

> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > Boa @f-francine! Ser√° que o correto n√£o √© a palavra "solicitada" no feminino? E a palavra "esta" n√£o deveria ser substitu√≠da por "essa" ou "a"?
> > Review de f-francine (COMMENTED):
> > Review de filipedeschamps (APPROVED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    text: `${user.username}, foi solicitada uma recupera√ß√£o de senha. Caso voc√™ n√£o tenha feito a solicita√ß√£o, ignore esse email.
```

> > Coment√°rio de f-francine (linha de c√≥digo):
> > boa!
> > </pull_819_fix(recovery): recovery email message>

<pull*823_fix(query): performance with large offset>
Ajuste na query de conte√∫dos para melhorar a performance quando navegamos por p√°ginas distantes da inicial, ou seja, quando \_offset* √© grande.
Com essa mudan√ßa n√£o deveremos mais obter tantos erros de timeout das lambdas e os erros 504 para os usu√°rios.
</pull_823_fix(query): performance with large offset>

<pull_839_fix: serve `HomeOffline` and remove SWR fetch>
Turma, como medida para tentar conter um pouco do volume de requisi√ß√µes, estou colocando uma vers√£o "offline" da Home e removendo a request extra feita pelo SWR para atualizar os conte√∫dos.
</pull_839_fix: serve `HomeOffline` and remove SWR fetch>

<pull_848_fix: temporary: return `[]` to all contents>
O objetivo desse PR √© eu conseguir fazer um build na Vercel e retomar o controle do load da API.
Com isso feito, vou come√ßar a fazer algumas otimiza√ß√µes para retomar o servi√ßo ü§ù
</pull_848_fix: temporary: return `[]` to all contents>

<pull_849_Retoma os conte√∫dos e atualiza tamanho da inst√¢ncia do RDS>
O terraform j√° foi aplicado ü§ù
</pull_849_Retoma os conte√∫dos e atualiza tamanho da inst√¢ncia do RDS>

<pull_853_Otimiza√ß√µes gerais em: /publicar, retentativas do banco e revalida√ß√µes das p√°ginas>
493ea542364ea1368add8ffe33123e1326052ff0

- Ao acessar o `/publicar`, limitar a busca por conte√∫dos existentes para apenas `1` conte√∫do do usu√°rio
  70c630f3e1785551aedf33061e04313b802ef170

- Reduz a retentativa de conex√£o ao banco apenas para `1` vez.
  69abf85509e4f10aa1970ffbbbe6cdac2c45d2bc

- Reduz o `revalidate` das p√°ginas para `10` segundos.
  > > Review de aprendendofelipe (DISMISSED):
  > > Review de augustresende (DISMISSED):
  > > </pull_853_Otimiza√ß√µes gerais em: /publicar, retentativas do banco e revalida√ß√µes das p√°ginas>

<pull_857_Faz retornar os conte√∫dos novamente.>
Agora que consegui fazer o merge do PR #855, √© poss√≠vel retornar os conte√∫dos, mas ainda sem API.
</pull_857_Faz retornar os conte√∫dos novamente.>

<pull_867_Remove temporariamente a quantidade de coment√°rios>
Conforme sugerido por @aprendendofelipe aqui: https://github.com/filipedeschamps/tabnews.com.br/issues/826#issuecomment-1322604252
</pull_867_Remove temporariamente a quantidade de coment√°rios>

<pull_881_perf(migration): add indexes for findChildrenTree>
Add indexes for the most frequent query in the product environment.
We're trying to aviod seq scans and hit indexes every time if possible.
WARNING: This migration may lock the target tables. We should create the index concurrently but there is an implementation detail in the node-pg-migrate that forces a transaction for each pgm.dropIndex call and postgresql does not allow it. At the current time, the database is not huge and we do not expect a heavy system load at this time.
Links:

- https://github.com/filipedeschamps/tabnews.com.br/issues/879
- https://explain.depesz.com/s/OIKV
- https://github.com/salsita/node-pg-migrate/issues/709
  </pull_881_perf(migration): add indexes for findChildrenTree>

<pull_882_Adiciona √≠ndices na query do `findChildrenTree` e `balance_operation`>
Isto √© uma continua√ß√£o do PR #881 do @lemuelroberto
</pull_882_Adiciona √≠ndices na query do `findChildrenTree` e `balance_operation`>

<pull_889_fix(confetti): adjust the window width of the confetti effect>
Ajusta largura da tela para o efeito de confetti na ativa√ß√£o do usu√°rio. O bugfix corrige uma pequena quest√£o de overflow que estava ocorrendo no navegador.

> > Review de aprendendofelipe (COMMENTED):
> > Review de alanmatiasdev (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de alanmatiasdev (COMMENTED):
> > Review de aprendendofelipe (DISMISSED):
> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Agora definindo as dimens√µes j√° dentro do componente, talvez n√£o precise mais de useEffect e useState.
> > Chegou a testar algo assim?

```js
<ReactConfetti
  width={width || window.innerWidth}
  height={height || window.innerHeight}
```

> > Coment√°rio de alanmatiasdev (linha de c√≥digo):
> > Acho que pode ser um caminho. Posso fazer essa altera√ß√£o.
> > Um ponto para observarmos √© que, dessa forma, perdemos o listener do resize do browser e, consequentemente, em uma eventual altera√ß√£o no tamanho da tela o confetti n√£o ir√° se adaptar para o novo tamanho. Nesse caso, ter√≠amos que passar essa l√≥gica para os componentes que implementem essa feature do confetti... o que acha?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Tinha pensado em eliminar o listener, pois ele s√≥ teria efeito se a janela fosse redimensionada enquanto os confetes estivessem caindo. Mas √© melhor manter ele como voc√™ implementou, mesmo que esse caso seja uma exce√ß√£o üëç
> > Coment√°rio de alanmatiasdev (linha de c√≥digo):
> > Eu pensei a mesma coisa. Imagino, no contexto da aplica√ß√£o, s√£o raras as exce√ß√µes que as janelas v√£o ser redimensionadas. Mas pensei no uso de celulares e tablets, em que isso pode ser mais comum
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      setConfettiWidth(document.body.clientWidth);
```

</pull_889_fix(confetti): adjust the window width of the confetti effect>

<pull_894_feat(status): increase `danger` threshold on `opened_connections`>
O "Conex√µes abertas" estava com o threshold da inst√¢ncia anterior do banco de dados. Agora ela considera um valor din√¢mico (70% das conex√µes m√°ximas, antes de ficar vermelho)
</pull_894_feat(status): increase `danger` threshold on `opened_connections`>

<pull_896_feat(build-env): different db config for build time>
Com isso o banco ir√° fazer mais tentativas de conex√µes durante o build do que em produ√ß√£o.
Al√©m disso, ap√≥s estabelecida a conex√£o, ela ser√° mantida no pool at√© o t√©rmino do build.
</pull_896_feat(build-env): different db config for build time>

<pull_900_Mostra os coment√°rios apenas na Home (lista dos relevantes)>
Isso √© um teste, no sentido de que n√£o fizemos nenhuma otimiza√ß√£o por enquanto, mas mostrar os coment√°rios ajuda muito na UX da Home, ent√£o sugiro nos arriscarmos.
E hoje ainda vou trabalhar no restante das otimiza√ß√µes para voltar a mostrar todos os coment√°rios ü§ù
</pull_900_Mostra os coment√°rios apenas na Home (lista dos relevantes)>

<pull_905_Volta a mostrar os coment√°rios nas p√°ginas (menos API)>
Continuando o PR #900 agora ser√° mostrado os coment√°rios em todas as p√°ginas com listas. Isto dever√° pressurizar um pouco mais o backend e vai ser √≥timo para conseguir identificar e notar o que est√° mais pesando.
Em paralelo, esse PR tamb√©m prop√µe um pequeno ajuste de estiliza√ß√£o na lista, onde deixa os coment√°rios com uma fonte normal, ao inv√©s de bold.
</pull_905_Volta a mostrar os coment√°rios nas p√°ginas (menos API)>

<pull_910_Volta 100% dos coment√°rios e fetch adicional do `swr` nas p√°ginas de conte√∫do>
Esse PR pode voltar a pesar de verdade o backend.
</pull_910_Volta 100% dos coment√°rios e fetch adicional do `swr` nas p√°ginas de conte√∫do>

<pull_933_fix(termos de uso): remove duplicate word>
remove the word "conta" which was duplicated in the terms of use

> > Review de dittrichlucas (APPROVED):
> > Review de aprendendofelipe (APPROVED):
> > </pull_933_fix(termos de uso): remove duplicate word>

<pull_962_feat(user): allow patch username to the same with case insensitive>
Permite com que possa alterar o username pelo mesmo, mudando apenas a caixa das letras.
Ex: luisfilipe agora pode ser alterado para LuisFilipe sem erro de usu√°rio j√° existente

> > Review de aprendendofelipe (DISMISSED):
> > Review de 33gustavo33 (DISMISSED):
> > Review de aprendendofelipe (APPROVED):
> > </pull_962_feat(user): allow patch username to the same with case insensitive>

<pull_976_Considera utilizar `cf-connecting-ip` para pegar o IP do cliente que vem pela Cloudflare>
N√£o tem como testar isso a n√£o ser em produ√ß√£o, e isto est√° relacionado a esse problema: https://github.com/filipedeschamps/tabnews.com.br/issues/826#issuecomment-1327968557
</pull_976_Considera utilizar `cf-connecting-ip` para pegar o IP do cliente que vem pela Cloudflare>

<pull_977_Adiciona logs para investigar comportamento dos IPs indo do Proxy da Cloudflare>
Mais informa√ß√µes: https://github.com/filipedeschamps/tabnews.com.br/issues/826#issuecomment-1327971748
</pull_977_Adiciona logs para investigar comportamento dos IPs indo do Proxy da Cloudflare>

<pull_985_Adiciona suporte ao `IPv6` e extrai IP real da Cloudflare>
Continuando a investiga√ß√£o do PR #977, agora a aplica√ß√£o e o firewall que implementamos lida com `IPv6` e extrai o valor correto do ip real do usu√°rio vindo da Cloudflare.
Como infelizmente isto s√≥ d√° para testar em produ√ß√£o ao fazer o TabNews passar pelo Proxy da Cloudflare, este PR √© um risco, mas estou colado aqui nos logs ü§ù
</pull_985_Adiciona suporte ao `IPv6` e extrai IP real da Cloudflare>

<pull_988_Adiciona suporte ao `IPv6` no Rate Limit>
Lutando contra os efeitos colaterais de colocar a Cloudflare na frente do TabNews, esta implementa√ß√£o √© a continua√ß√£o espiritual do PR #985 e faz o nosso sistema de rate limit conseguir extrair do cabe√ßalho o ip real.
E para n√£o haver mais disparidade sobre como extrair o ip real, eu centralizei isso num novo model chamado `ip`.
</pull_988_Adiciona suporte ao `IPv6` no Rate Limit>

<pull_1001_Utiliza ip completo para reduzir quantidade de falsos positivos no Firewall>
Com a entrada da Cloudflare e do `IPv6`, eu notei que houve um aumento grande de pedidos que est√£o sendo pegos pelo Firewall e que acredito serem falsos positivos. Isto significa que o Firewall est√° aplicando os seus side-effects contra pessoas que n√£o tem nada a ver com a hist√≥ria. Isto n√£o estava acontecendo antes, nem com o volume do lan√ßamento, e eu especulo √© que a m√°scara do `IPv6` possa ter algo de errado. Ent√£o como experimento, estou removendo temporariamente a m√°scara para avaliar os resultados, e depois disso voltar com ela quando dominarmos a situa√ß√£o ü§ù
</pull_1001_Utiliza ip completo para reduzir quantidade de falsos positivos no Firewall>

<pull_1012_Habilita novamente o `prefetch` dos links para UX mais r√°pida>
Turma, acredito que este seja o √∫ltimo PR da bateria de implementa√ß√µes que eu queria fazer antes de abrir uma nova milestone e avaliar as issues e PRs da comunidade. Estou voltando o comportamento anterior do `prefetch` dos links ü§ù
A √∫ltima coisa que tinha no passado e falta voltar √© o `preload` usando o `swr` das listas de conte√∫do, mas isso s√≥ me sinto seguro fazer depois de abrir a nova milestone sugerindo novas otimiza√ß√µes üëç

> > Review de aprendendofelipe (APPROVED):
> > </pull_1012_Habilita novamente o `prefetch` dos links para UX mais r√°pida>

<pull_1031_feat(ranking beta): beta5>
Testando mais uma varia√ß√£o do ranqueamento.
Apenas no grupo 6 a classifica√ß√£o final ocorre por saldo de tabcoins. Nos demais a classifica√ß√£o ocorre por tempo de publica√ß√£o, para sempre dar mais destaque aos conte√∫dos mais novos
</pull_1031_feat(ranking beta): beta5>

<pull_1039_Feature/go to top button>
Adiciona um simples bot√£o ao scrollar para baixo no tabnews, para retornar ao topo. Senti falta de um ao navegar em conte√∫dos com muitas repostas pricipalmente.

> > Review de aprendendofelipe (COMMENTED):
> > Review de montoyaaa (COMMENTED):
> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > Show @montoyaaa, mas quebrou porque voc√™ est√° buscando um elemento que n√£o est√° presente no documento.
> > E como est√° praticamente pronto, ap√≥s essa corre√ß√£o, voc√™ consegue unificar todos commits e seguir o padr√£o de mensagens em ingl√™s?
> > Obrigado! ü§ù
> > Review de montoyaaa (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
import { Footer, GoToTopButton, Head, Header } from 'pages/interface/index.js';
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > @montoyaaa, chegou a avaliar a possibilidade de usar `IntersectionObserver`?
> > Talvez seja melhor para n√£o ficar chamando a fun√ß√£o sempre que fizer o scroll da p√°gina.
> > Com `IntersectionObserver` poderia chamar a fun√ß√£o CB somente quando o `Header` ficar vis√≠vel ou n√£o.
> > O que acha?
> > Coment√°rio de montoyaaa (linha de c√≥digo):
> > Na verdade eu n√£o conhecia o IntersectionObserver, muito obrigado por me apresentar. Implementei ele, se tiver algum pontinho sobre, s√≥ dar um grito. :)
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Precisa buscar algo que voc√™ possa garantir que exista no documento.
> > Algo que voc√™ mesmo tenha adicionado no Header (ID ou class).
> > Tamb√©m √© bom usar um nome de vari√°vel que deixe mais claro qual √© o elemento alvo.
> > Coment√°rio de montoyaaa (linha de c√≥digo):
> > Pois √©, ia falar isso. Acabei esquecendo de deixar o seletor daquele jeito haha. Se tiver mais algum pontinho ou observa√ß√£o que eu poderia melhor, s√≥ dar um toque. Abs
> > </pull_1039_Feature/go to top button>

<pull_1053_style(footer/index.js): align the tabnews icon with the footer text>

## ü§î Por que voc√™ est√° abrindo esse Pull Request?

Um simples ajuste no alinhamento do √≠cone do rodap√© com o texto, algo que estava me incomodando faz tempo üòÖÔ∏è

## üßê Descreva sua solu√ß√£o:

Basicamente foi adicionado display: 'flex justifyContent: 'center'. Conforme imagem abaixo:

> > Review de Diegiwg (DISMISSED):
> > Est√° √≥timo, e que bela observa√ß√£o
> > Review de JonathanArgentao (DISMISSED):
> > Review de aprendendofelipe (APPROVED):
> > Review de Jphn (DISMISSED):
> > Review de gabrielsozinho (DISMISSED):
> > Review de silvaezequias (APPROVED):
> > Review de aprendendofelipe (APPROVED):
> > Review de aprendendofelipe (APPROVED):
> > Review de gabrielsozinho (APPROVED):
> > </pull_1053_style(footer/index.js): align the tabnews icon with the footer text>

<pull_1060_perf(contents): add `stale-while-revalidate` to GET on `/api/v1/contents`>
Para quem participou da √∫ltima Live, ainda n√£o abrimos a pr√≥xima Milestone, mas estamos fazendo a manuten√ß√£o dos pontos mais emergenciais antes de qualquer coisa, combinado? ü§ù

> > Review de aprendendofelipe (APPROVED):
> > </pull_1060_perf(contents): add `stale-while-revalidate` to GET on `/api/v1/contents`>

<pull_1061_refactor(markdown editor and viewer): prepared for future package change>
Continuando a refatora√ß√£o dos componentes de markdown
</pull_1061_refactor(markdown editor and viewer): prepared for future package change>

<pull_1063_Diminuir tamanho do JavaScript inicial da p√°gina>
Com o PR #1061 o first load passou de 450 kB para 728 kB apenas por utilizar algumas fun√ß√µes da biblioteca `highlight.js` (`listLanguages()` e `getLanguage()`).
Como o retorno dessas fun√ß√µes √© est√°tico (poder√° mudar apenas com a atualiza√ß√£o da biblioteca), foi criada uma constante com o valor retornado (lista de linguagens compat√≠veis com o `highlight`) e o c√≥digo que chama as fun√ß√µes foi mantido de maneira comentada para permitir a gera√ß√£o automatizada de nova constante em caso de necessidade futura.
E com isso o first load voltou para o patamar anterior, ficando um pouco menor que antes, com 443 kB.
No segundo commit foi adicionado um ordenamento final na consulta da lista de conte√∫dos para garantir sempre o mesmo retorno e parar de gerar alguns erros aleat√≥rios nos testes (como ocorrido aqui https://github.com/filipedeschamps/tabnews.com.br/pull/910#issuecomment-1324096466 e aqui https://github.com/filipedeschamps/tabnews.com.br/pull/1012#issuecomment-1329307261).

> > Review de filipedeschamps (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de Diegiwg (APPROVED):
> > Review de filipedeschamps (APPROVED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Me ajuda, estou tentando entender o que isso faz e n√£o consigo ü§ù
> > Se tem `count`, a janela de conte√∫dos n√£o √© ordenada, mas se tem, ela √© ordenada pelo `orderByClause`. N√£o consigo entender a sem√¢ntica disso.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Analisando pela linha 47, se tem `values.count`, apenas um elemento √© retornado (`LIMIT 1`), ent√£o n√£o tem necessidade de ordenar.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > √â verdade que com o `LIMIT 1` n√£o h√° necessidade de ordenar, mas n√£o √© por isso que eu adicionei esse condicional.
> > Quando tem `count`, a `selectClause` n√£o faz `JOIN` (porque n√£o precisamos de nada al√©m do `total_rows`), ent√£o gera erro se tentarmos ordenar por colunas que n√£o est√£o dispon√≠veis.
> > Mas o fato que voc√™s bem lembraram, de que n√£o precisamos ordenar quando tem o `count`, √© legal, pois a gente pode tirar o ordenamento tamb√©m da linha 45.
> > E da√≠ pode ficar melhor j√° verificar isso dentro de `buildOrderByClause`, ent√£o vou mudar üëç
> > </pull_1063_Diminuir tamanho do JavaScript inicial da p√°gina>

<pull_1064_Logs de erros melhores>
Continuando a s√©rie apagando fogo p√≥s-lan√ßamento, estou fazendo esta altera√ß√£o para melhorar a nossa visualiza√ß√£o pelos logs sobre o que est√° acontecendo, principalmente ap√≥s colocar a Cloudflare na frente do TabNews.
E tamb√©m √© separado o que √© `publicErrorObject` (que ser√° retornado ao usu√°rio) e `privateErrorObject` (que cont√©m cont√©m informa√ß√µes do contexto).
Pr√≥ximo passo √© montar uma dashboard no Axiom que agrupe os ips que est√£o gerando mais erros para rapidamente isolar quem est√° atacando a API.
</pull_1064_Logs de erros melhores>

<pull_1067_Logs de erros melhores (Parte 2)>
O resultado do PR #1064 ficou muito bom e este PR cobre de logs no novo formato quando o `next-connect` n√£o encontra uma rota dispon√≠vel e chama o `onNoMatchHandler`.
</pull_1067_Logs de erros melhores (Parte 2)>

<pull_1068_refactor(database): replace magic numbers with constants>
replacement of the literal database error code numbers with constants that represents more meaningful value.

> > Review de Rafatcb (DISMISSED):
> > Review de aprendendofelipe (DISMISSED):
> > Review de Diegiwg (DISMISSED):
> > Realmente, sempre √© melhor ter 'tais n√∫meros m√°gicos' em constantes com significado em seus nomes, parab√©ns pela aten√ß√£o ao detalhe.
> > Review de aprendendofelipe (APPROVED):
> > </pull_1068_refactor(database): replace magic numbers with constants>

<pull_1069_feat(middleware): log host and other variables for debug>
Este PR faz parte de algo que infelizmente s√≥ √© poss√≠vel debugar na infraestrutura da Vercel, e nesse caso especialmente em produ√ß√£o.
E essa pesquisa faz parte de uma implementa√ß√£o que irei dar detalhes um pouco mais para frente ü§ù
</pull_1069_feat(middleware): log host and other variables for debug>

<pull_1081_fix(login redirect): prevent redirect to external url>
Esta implementa√ß√£o foi realizada por @aprendendofelipe e resolve a issue de seguran√ßa #1078
Eu estou abrindo o PR em nome do @aprendendofelipe para conseguir fazer o merge no exato momento que o PR foi aberto.
</pull_1081_fix(login redirect): prevent redirect to external url>

<pull*1101_feat(rate limit env): use rate limit only for paths in env var>
Com esse PR os endpoints afetados pelo rate-limit do Upstash s√£o definidos pelo par√¢metro `rateLimitPaths` na vari√°vel de ambiente `RATE_LIMITS`.
Os caminhos informados em `rateLimitPaths` ser√£o comparados com o come√ßo de cada `path` acessado para decidir se a requisi√ß√£o deve usar o Upstash ou n√£o.
Com isso podemos configurar os caminhos afetados pelo rate-limit de maneira diferente no ambiente de produ√ß√£o e homologa√ß√£o, assim como podemos ter uma configura√ß√£o espec√≠fica para uma \_branch* qualquer.

> > Review de rodrigoKulb (DISMISSED):
> > Review de filipedeschamps (APPROVED):
> > Show! Tem um detalhe num dos `revalidates` que deixei um coment√°rio ü§ù
> > Review de aprendendofelipe (COMMENTED):
> > Review de filipedeschamps (COMMENTED):
> > Review de filipedeschamps (APPROVED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Isso infelizmente vai gerar aquele bug onde uma pessoa cria um conte√∫do com o slug `x`, apaga a publica√ß√£o (ao inv√©s de editar), e cria uma nova publica√ß√£o com o mesmo slug `x`. Inclusive esse `revalidate` foi adicionado ap√≥s usu√°rios reportarem este comportamento/problema.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Quando eu adicionei o `revalidate: 1` nesse trecho eu ainda n√£o estava totalmente familiarizado com o `validator`, ent√£o achei prudente colocar aqui tamb√©m, mas o que resolve esse bug √© o que foi inserido na linha 328.
> > Aqui n√£o √© necess√°rio revalidar, pois apenas um novo deploy pode alterar o `validator`, ent√£o se uma combina√ß√£o `username/slug` retornou erro uma vez, ou seja, n√£o est√£o em formato v√°lido, √© melhor j√° deixar o 404 em cache at√© o pr√≥ximo deploy.
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Ahhhh perfeito, √© verdade!! ü§ù
> > </pull_1101_feat(rate limit env): use rate limit only for paths in env var>

<pull_1110_fix(head): add a meta tag to upgrade insecure requests>
#1090

> > Review de rodrigoKulb (APPROVED):
> > Perfeito e URGENTE, hoje qualquer um pode adicionar uma imagem sem http em um coment√°rio deixando o post com alerta de falha de seguran√ßa dos browsers.
> > Review de Diegiwg (APPROVED):
> > Review de aprendendofelipe (APPROVED):
> > Boa @gabrielsozinho e @rodrigoKulb! Esse comportamento j√° √© o padr√£o no Chromium, mas ser√° legal para os outros navegadores üëç
> > Review de Rafatcb (APPROVED):
> > </pull_1110_fix(head): add a meta tag to upgrade insecure requests>

<pull_1133_fix(validator): invalidate blank characters and empty markdown>

## Ajustes no validador em situa√ß√µes de caracteres em branco

### Trim

J√° n√£o era permitido iniciar uma publica√ß√£o com espa√ßos em branco, pois tinha o `trim` no `validator`, mas isso n√£o era informado ao usu√°rio e poderia alterar a publica√ß√£o, pois remover a tabula√ß√£o inicial pode fazer um bloco de c√≥digo virar markdown v√°lido e mudar a maneira de ser renderizado. E isso n√£o seria visto no modo preview, mas apenas ap√≥s publicar.
Ent√£o foi removido o `trim` do come√ßo do `body` e agora existe o erro `"body" deve come√ßar com caracteres vis√≠veis.`
No final do `body` nada mudou, ou seja, os espa√ßos ainda s√£o removidos sem erros ou avisos.

### Tipos de caracteres em branco

Agora o validador abrange uma maior variedade de caracteres vazios.

### Markdown vazio

Tamb√©m informa erro ao criar publica√ß√£o em que o body ficar vazio ap√≥s a remo√ß√£o do markdown:
`Markdown deve conter algum texto`

### Limite de caracteres/bytes

O t√≠tulo agora est√° limitado a 255 caracteres ao inv√©s de 256.
E o slug est√° limitado a 255 bytes.

> > Review de filipedeschamps (DISMISSED):
> > Sensacional! Eu tinha pensado numa abordagem de n√£o filtrar a entrada e s√≥ filtrar a sa√≠da (colocando um placeholder de texto padr√£o como `"(Conte√∫do sem texto)"`, ou dando throw dentro do model de `content` se o `body` renderizar algo em branco, mas voc√™ conseguiu centralizar no `validator` essa valida√ß√£o e isso √© √≥timo üòç
> > Review de aprendendofelipe (COMMENTED):
> > Review de filipedeschamps (APPROVED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Bem melhor üòç
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Que massa essa implementa√ß√£o, n√£o sabia que era t√£o f√°cil criar algo custom e tamb√©m com uma mensagem de erro custom. Eu n√£o gosto muito do Joi, mas ele √© t√£o flex√≠vel que d√° raiva üòÇ
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Esse novo `params` vai fazer cair o valor de entrada l√° no `value` do `withoutMarkdown`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Opa, belo achado! Eu comecei a implementa√ß√£o pensando que ia usar uma abordagem diferente, mas logo mudei de rumo e acebei esquecendo isso a√≠. N√£o √© necess√°rio para o `withoutMarkdown`. Vou retirar, pois n√£o est√° fazendo nada.
> > </pull_1133_fix(validator): invalidate blank characters and empty markdown>

<pull_1173_Corrige o espa√ßamento e alinhamento entre label e checkbox de notifica√ß√µes por email>
J√° existiam 3 PRs relacionados: #817, #1059 e #1080, mas cada vers√£o deixava desalinhada a checkbox com o texto em pelo menos um navegador.
A solu√ß√£o proposta √© a que ficou com melhor alinhamento na maioria dos navegadores (n√£o testei no Safari):

> > Review de filipedeschamps (APPROVED):
> > </pull_1173_Corrige o espa√ßamento e alinhamento entre label e checkbox de notifica√ß√µes por email>

<pull_1174_feat(footer): add link to RSS in footer>
Minha ideia inicial era adicionar um √≠cone para o RSS, ainda mais por causa deste coment√°rio: https://github.com/filipedeschamps/tabnews.com.br/issues/1052#issuecomment-1333835572. No entanto, acredito que isso sairia do padr√£o do projeto, que √© inspirado aqui no GitHub.
Ent√£o optei pelo simples mesmo, s√≥ adicionei o link para `/recentes/rss`.
Resolve #1175

> > Review de aprendendofelipe (APPROVED):
> > </pull_1174_feat(footer): add link to RSS in footer>

<pull_1176_Melhoras de UX - Habilita zoom na vers√£o mobile e restaura scroll da p√°gina ao voltar>

## Melhorias de UX

### Scroll

Restaura o scroll ao voltar a p√°gina pelo navegador ou ao clicar no link `Anterior`.
Assim o usu√°rio n√£o precisa procurar novamente em qual posi√ß√£o estava na lista antes de clicar em um conte√∫do. (Closes #1138).

### Zoom mobile

Habilita a possibilidade de mudar a escala da p√°gina em dispositivos m√≥veis.
Isso facilita visualizar detalhes de imagens que contenham muita informa√ß√£o.

### Responsividade dos gr√°ficos

Corrige a responsividade dos gr√°ficos da p√°gina de status que n√£o funcionava bem com `display: grid`

> > Review de filipedeschamps (APPROVED):
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Que del√≠cia
> > </pull_1176_Melhoras de UX - Habilita zoom na vers√£o mobile e restaura scroll da p√°gina ao voltar>

<pull_1178_feat(socket ip): log for debug>

> > Review de filipedeschamps (APPROVED):
> > </pull_1178_feat(socket ip): log for debug>

<pull_1184_feat(socket ip): log for debug v2>

> > Review de filipedeschamps (DISMISSED):
> > Review de filipedeschamps (APPROVED):
> > </pull_1184_feat(socket ip): log for debug v2>

<pull_1185_feat(middleware): refuse connections from outside Cloudflare's IP range in production>

> > Review de filipedeschamps (APPROVED):
> > </pull_1185_feat(middleware): refuse connections from outside Cloudflare's IP range in production>

<pull_1188_Feature (API) - Adiciona query params para filtrar lista de conte√∫dos do usu√°rio>

#### Atualiza√ß√£o

Deixei apenas os ajustes de api nesse pr

---

|     |     |
| --- | --- |

Temos algumas issues sobre essa feature, ent√£o resolvi fazer uns testes aqui.
https://github.com/filipedeschamps/tabnews.com.br/issues/807
https://github.com/filipedeschamps/tabnews.com.br/issues/891
https://github.com/filipedeschamps/tabnews.com.br/issues/1046
https://github.com/filipedeschamps/tabnews.com.br/issues/1093

> > Review de ErickCReis (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Erick, isso √© uma √≥tima adi√ß√£o ao projeto! Dei uma olhada no c√≥digo e deixei algumas observa√ß√µes, a principal √© sobre a mudan√ßa do nome `showComments`. Me diga o que acha :+1:
> > Sobre as sugest√µes para remover as vari√°veis n√£o usadas: agora temos uma regra ativa do ESLint para isso, ap√≥s atualizar sua branch com o `main` voc√™ ver√° os erros.
> > Review de aprendendofelipe (COMMENTED):
> > Realmente a funcionalidade desse PR √© muito esperada üéâ. Infelizmente eu n√£o dei conta de revisar no momento que ele foi aberto (nem na segunda vers√£o), pois a demanda estava muito alta naquele per√≠odo.
> > Mas vamos tentar levar ele para produ√ß√£o (ou abrir um novo, se for mais f√°cil). ü§ùüöÄ

## Front

Eu gostei muito do design! Talvez para adaptar ao que temos hoje, adicionaria a aba "Perfil", que seria a padr√£o se o usu√°rio tiver cadastrado algo, e ao clicar nas outras abas navegaria para as respectivas p√°ginas (`root` ou `child`), cada uma com sua pagina√ß√£o.
Provavelmente ser√° melhor s√≥ mostrar a aba "Perfil" se o usu√°rio cadastrou algo.

### Endere√ßos

Na `/[username]` abrir a aba "Perfil" se o usu√°rio tiver algo cadastrado, caso contr√°rio, redirecionar para a "Conte√∫dos".
E para os "Conte√∫dos" e "Respostas", que tal:

#### Op√ß√£o 1 - Mais pr√≥ximo do atual

Talvez manter o padr√£o atual para os `root`, onde apenas mudaria que para ver a primeira p√°gina raiz, obrigatoriamente precisaria ir para `/[username]/pagina/1`, pois a `/[username]` abriria s√≥ o perfil.
Para os coment√°rios, talvez criar a `/[username]/respostas/pagina/[page]`, ou algo melhor.

- `/[username]/pagina/[page]`
- `/[username]/respostas/pagina/[page]`

#### Op√ß√£o 2 - Remover `/pagina`

Eu n√£o vejo necessidade da `/pagina`, e n√£o lembro se houve alguma discuss√£o sobre essa necessidade, ent√£o gostaria de saber a opini√£o sobre usar:

- `/[username]/conteudos/[page]`
- `/[username]/respostas/[page]`
  Acredito que o plural seja suficiente para informar que `/[username]/conteudos/3` n√£o vai abrir o conte√∫do 3, mas sim o bloco 3 de conte√∫dos.

## Back

Para auxiliar nas ideias sobre o backend, recomendo darem uma olhada em alguns pontos do PR #1413 (especificamente o https://github.com/filipedeschamps/tabnews.com.br/pull/1413/commits/5d06a21b7fc055a4db2531bcb38cc8117aca9fff).
Pode ser que algo de l√° seja aproveitado. S√≥ n√£o se assustem, pois aquele PR faz muito mais coisas, como otimiza√ß√µes e deixa o endpoint `contents` flex√≠vel (d√° at√© para buscar o conte√∫do por ID). Inclusive alguns pontos dele j√° est√£o em produ√ß√£o. Acho que algumas coisas de l√° podem ser aplicadas ao `/api/v1/contents/[username]`.
Por exemplo, l√° eu usei os par√¢metros `with_root` e `with_children`. Ent√£o √© poss√≠vel pedir os dois tipos ou apenas um deles em uma mesma requisi√ß√£o.
Tamb√©m recomendo dar uma olhada como eu fiz para poder fazer a consulta usando `$not_null`, e n√£o foi necess√°rio adicionar o `$null`.

> > Review de Rafatcb (COMMENTED):
> > Tamb√©m acho melhor um PR separado para o front, isso facilitar√° a discuss√£o tamb√©m.
> > Deixei um coment√°rio no PR s√≥, que √© uma d√∫vida minha.
> > Review de ErickCReis (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Este validador estava duplicado nesse arquivo:
> > https://github.com/filipedeschamps/tabnews.com.br/blob/4b134297d6e26b4125b7d08a1562dd68460a4101/models/validator.js#L216-L229 > > https://github.com/filipedeschamps/tabnews.com.br/blob/4b134297d6e26b4125b7d08a1562dd68460a4101/models/validator.js#L335-L349
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vari√°vel n√£o usada.

```suggestion
      await orchestrator.createContent({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vari√°vel n√£o usada.

```suggestion
      await orchestrator.createContent({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vari√°vel n√£o usada.

```suggestion
      await orchestrator.createContent({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vari√°vel n√£o usada.

```suggestion
      await orchestrator.createContent({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vari√°vel n√£o usada.

```suggestion
      await orchestrator.createContent({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vari√°vel n√£o usada.

```suggestion
      await orchestrator.createContent({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que precisamos de um nome melhor do que `showComments`, porque ao ler esse nome eu pensava que o `showComments = true` traria `root` e `child`, mas vendo essa condi√ß√£o, percebi que traria **apenas** `child`.
> > N√£o me parece que uma vari√°vel booleana consiga descrever esse tipo de situa√ß√£o, ent√£o sugiro renomearmos para `content` (ou algum nome melhor), aceitando uma string `root` ou `child`. Faz sentido?

- Se `content` n√£o estiver definido, busca tudo.
- Se `content === 'root'`, busca apenas conte√∫dos raiz.
- Se `content === 'child'`, busca apenas conte√∫dos filhos (coment√°rios).
- Se outro valor, erro.
  Optei tamb√©m pela nomenclatura `child` porque √© mais usada do que `comments` no c√≥digo.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Sei que esse n√£o √© o √∫nico lugar que tem a valida√ß√£o `string.empty` em um campo boolean, mas quando ela √© acionada? Nos testes que eu havia feito (antes das altera√ß√µes do PR de hoje) n√£o consegui simular um cen√°rio em que ela fosse necess√°ria.
  > > Coment√°rio de ErickCReis (linha de c√≥digo):
  > > Acabei apenas copiando de outros schemas, lendo a documenta√ß√£o n√£o encontrei nada a respeito, acredito que podemos remover.
  > > Posso remover apenas desses dois schemas ou aproveito para remover dos outros tbm?
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Creio que poderia remover de todos campos booleanos, mas prefiro aguardar uma confirma√ß√£o do @aprendendofelipe.
  > > N√£o cheguei a testar se essa valida√ß√£o influencia em algo caso o par√¢metro esteja no `body`, testei apenas como par√¢metro da query.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Podemos remover sim a mensagem de `string.empty` dos campos booleanos üëç
  > > Mas acho que vamos fazer isso em outro PR, pois pra mim esse aqui est√° pronto üöÄ
  > > </pull_1188_Feature (API) - Adiciona query params para filtrar lista de conte√∫dos do usu√°rio>

<pull_1193_Combina dados do usu√°rio do localStorage com os dados em mem√≥ria>
Em #804 foi adicionada a sincroniza√ß√£o dos dados do usu√°rio entre diferentes abas do navegador utilizando o localStorage. Por exemplo, caso ocorra uma transa√ß√£o com TabCoins em uma aba, o saldo ser√° atualizado em todas as outras abas que entrarem em foco.
S√≥ que dados sens√≠veis do usu√°rio n√£o s√£o salvos no localStorage. Ent√£o agora ao sincronizar os dados do usu√°rio atrav√©s das abas os dados do usu√°rio que existem somente em mem√≥ria ser√£o mantidos e apenas os dados presentes no localStorage ser√£o substitu√≠dos.
Problema notado por @cybernerd007 em #1192, onde o campo email ficava com valor `undefined` ap√≥s voltar para uma aba que tinha sido deixada na tela de Editar Perfil.

> > Review de filipedeschamps (APPROVED):
> > </pull_1193_Combina dados do usu√°rio do localStorage com os dados em mem√≥ria>

<pull_1200_fix(use-user): set `user` to `null` instead of `{}`>
Em diversos pontos do sistema estamos verificando se um usu√°rio est√° logado apenas olhando se `user` √© truthy.
Por isso n√£o podemos fazer `setUser({})` quando o usu√°rio n√£o estiver logado, j√° que isso implicaria:

```js
{} && "logado"
// returns "logado"
```

Ent√£o fazendo `setUser(null)`, teremos o esperado:

```js
null && "logado";
// returns null
```

Esse PR corrige o relatado em #1196
Uma melhoria futura seria fazer `useUser` retornar separadamente cada propriedade do objeto `user` e tamb√©m uma propriedade como `isLogged`. Assim ter√≠amos uma pequena melhora de performance ao reduzir renderiza√ß√µes causadas por mudan√ßas em propriedades do `user` que n√£o implicam mudan√ßas visuais.

> > Review de filipedeschamps (APPROVED):
> > </pull_1200_fix(use-user): set `user` to `null` instead of `{}`>

<pull*1227_Refatora√ß√£o do `models/ip` para deixar mais claro como o IP √© obtido em cada caso>
O IP do \_client* √© obtido de diferentes maneiras dependendo se o c√≥digo est√° sendo executado no runtime node ou na edge e tamb√©m muda se estamos em produ√ß√£o, preview ou desenvolvimento (local ou remoto - gitpod, codespaces etc.).
A refatora√ß√£o tenta deixar mais claro qual √© o m√©todo utilizado em cada caso.
A biblioteca `ip` foi substitu√≠da pela `is-in-subnet`, pois havia um bug que poderia afetar o TabNews em algumas situa√ß√µes.
Rodei `npm audit fix`.
Por fim foi feito um pequeno ajuste no `models/controller` para n√£o causar um erro interno que impedia a cria√ß√£o do `publicErrorObject` em caso de erros que impe√ßam a cria√ß√£o do `context`.

> > Review de filipedeschamps (APPROVED):
> > Genial!! E muito estranho que come√ßou a pegar os IPs da Cloudflare, porque no passado pegava corretamente os IPs do `client`, mesmo quando ca√≠a em erro `400` tradicional do `node runtime`. Se for no Axiom e pegar aquele gr√°fico de agrupamento de erros com `30` dias (que demora para carregar), mostra os IPs reais que foram registrados no passado... mas de fato, agora no curto prazo s√≥ mostra da Cloudflare. Tem algum chute do que aconteceu?
> > </pull_1227_Refatora√ß√£o do `models/ip` para deixar mais claro como o IP √© obtido em cada caso>

<pull_1228_Permitir `getHost()` funcionar corretamente no browser>
O `infra/webserver` foi alterado para permitir a fun√ß√£o `getHost()` utilizar vari√°veis de ambiente que tamb√©m est√£o dispon√≠veis no navegador.
Isso resolve os problemas relatados em #1206 que fazem com que algumas meta tags fiquem com o host incorreto apenas no client ap√≥s a hidrata√ß√£o do React. Por exemplo `undefined:undefined` em:
`<meta property="og:image" content="http://undefined:undefined/default-image-share.png">`
Com essa refatora√ß√£o tamb√©m √© poss√≠vel usar a vari√°vel `NEXT_PUBLIC_WEBSERVER_HOST` para definir qualquer valor que ser√° usado no lugar do padr√£o `https://www.tabnews.com.br`. Antes essa vari√°vel s√≥ seria lida em modo de desenvolvimento.

### Edit

- Agora o `infra/webserver` fornece constantes ao inv√©s de fun√ß√µes;
- Acrescido `NEXT_PUBLIC` √†s vari√°veis de ambiente que precisam de acesso pelo browser;
- `isLambdaServer` virou `isServerlessRuntime` para representar corretamente seu retorno, j√° que era `true` tamb√©m para a edge;
- `NEXT_PUBLIC_WEBSERVER_HOST` deve ser definido nas vari√°veis da Vercel para produ√ß√£o, ou ser√° utilizado o valor do arquivo `.env`;
- Utilizada a vari√°vel de ambiente `CI` da Vercel para identificar o momento de build;
- Resolvido o bug de nunca executar a `checkForTooManyConnections`;
- Alterado `maxConnectionsTolerance` de `0.7` para `0.8`;
- Substitu√≠do `!cache.openedConnections === null` por `cache.openedConnections === null`, pois sempre retornava `false`;
- Exclu√≠do `!cache.openedConnectionsLastUpdate === null`, pois n√£o tinha nenhum efeito pr√°tico.
  > > Review de filipedeschamps (DISMISSED):
  > > Massa üòç üòç üòç
  > > </pull_1228_Permitir `getHost()` funcionar corretamente no browser>

<pull_1235_Unifica vari√°veis de ambiente do banco de dados no arquivo `.env`>
Mudan√ßa para facilitar testes com diferentes inst√¢ncias do banco de dados em modo de desenvolvimento.
Agora basta alterar as primeiras vari√°veis no `.env` e n√£o ser√° mais necess√°rio mudar a vari√°vel `DATABASE_URL` e nem alterar o arquivo `seed-database.js`.
Nada muda com rela√ß√£o aos bancos de homologa√ß√£o e produ√ß√£o.
Exemplo usando um banco remoto do Supabase com Pool habilitado:

```
POSTGRES_USER=postgres
POSTGRES_PASSWORD=database_password
POSTGRES_DB=postgres
POSTGRES_HOST=db.supabase_project_id.supabase.co
POSTGRES_PORT=6543
```

</pull_1235_Unifica vari√°veis de ambiente do banco de dados no arquivo `.env`>

<pull_1243_refactor(validator.js): remove duplicated owner_id schema from validator>
O schema j√° est√° definido aqui:
https://github.com/filipedeschamps/tabnews.com.br/blob/5a2fb1228f7cbfdfa751c4e1514f10f639c309dc/models/validator.js#L320-L334

> > Review de aprendendofelipe (APPROVED):
> > </pull_1243_refactor(validator.js): remove duplicated owner_id schema from validator>

<pull_1246_fix(#1186): misspelling on status page>
Corrigindo erro de ortografia

> > Review de zLucasBiasi (DISMISSED):
> > Review de aprendendofelipe (APPROVED):
> > </pull_1246_fix(#1186): misspelling on status page>

<pull_1247_Substituindo o caractere de copyright pelo HTML entity>
Substitui√ß√£o do s√≠mbolo `¬©` pelo HTML entity `&copy;` para garantir a exibi√ß√£o correta em todos os sistemas e navegadores. Isso √© √∫til em situa√ß√µes em que o s√≠mbolo n√£o est√° dispon√≠vel ou n√£o √© exibido corretamente, como em algumas fontes ou sistemas operacionais.

> > Review de centygo (DISMISSED):
> > Review de zLucasBiasi (DISMISSED):
> > Review de aprendendofelipe (DISMISSED):
> > Review de aprendendofelipe (APPROVED):
> > </pull_1247_Substituindo o caractere de copyright pelo HTML entity>

<pull_1249_Alterando os textos padr√£o dos bot√µes do useConfirm>

### Antes

Os bot√µes, por padr√£o, eram em ingl√™s.

### Depois

Agora eu alterei para o portugu√™s.

> > Review de zLucasBiasi (DISMISSED):
> > Review de aprendendofelipe (APPROVED):
> > </pull_1249_Alterando os textos padr√£o dos bot√µes do useConfirm>

<pull_1250_refactor(GoToTopButton): creating separate function to do the button action>

> > Review de aprendendofelipe (APPROVED):
> > </pull_1250_refactor(GoToTopButton): creating separate function to do the button action>

<pull_1254_Arrumando utiliza√ß√£o de componente no React>
No React, o ideal √© nunca criar um componente dentro de outro componente, isso pode levar √† problemas de performance. [Existe at√© uma regra de ESLint sobre isso](https://github.com/jsx-eslint/eslint-plugin-react/blob/master/docs/rules/no-unstable-nested-components.md)!
Outro ponto atacado nesse PR, √© a quest√£o de chamar um componente como uma fun√ß√£o "normal", assim: `Component()`. Isso confunde o React em algumas formas, ele pode acabar interpretando esse componente como um custom hook. V√≠deo de refer√™ncia: https://www.youtube.com/watch?v=QuLfCUh-iwI
Obs: n√£o consegui rodar os testes na minha m√°quina, estou investigando isso.
</pull_1254_Arrumando utiliza√ß√£o de componente no React>

<pull_1255_Removendo logica duplicada>
Ol√°!
Este pull request prop√µe refatorar o c√≥digo para melhorar a performance e manuten√ß√£o. Em primeiro lugar, foi removida a l√≥gica duplicada e adicionada como constante para evitar erros de digita√ß√£o e facilitar a manuten√ß√£o. Al√©m disso, o corpo da fun√ß√£o que n√£o era necess√°rio foi removido, tornando o c√≥digo mais enxuto e leg√≠vel.
Este refactor ajudar√° a garantir que o c√≥digo continue funcionando corretamente e seja f√°cil de manter no futuro. Por favor, d√™ uma olhada e deixe suas opini√µes ou sugest√µes.
Obrigado!

> > Review de Rafatcb (APPROVED):
> > Review de aprendendofelipe (APPROVED):
> > </pull_1255_Removendo logica duplicada>

<pull_1260_Melhoria da acessibilidade dos links>
Este Pull Request tem como objetivo melhorar a acessibilidade dos links, resolvendo parcialmente a issue #1259. Para alcan√ßar esse objetivo, foram adicionados "aria-labels" nos links que eram reportados pelo PageSpeed. Embora n√£o resolva todos os problemas relacionados √† issue, √© uma importante contribui√ß√£o para a melhoria do site.
Como estava no computador antes do aria-label:
Depois:
Como estava o mobile antes do aria-label:
Depois:

> > Review de aprendendofelipe (APPROVED):
> > </pull_1260_Melhoria da acessibilidade dos links>

<pull_1265_Limitar `1` TabCoin por `Conte√∫do` Por `IP` por `72 horas`>
Turma, este √© um PR implementando uma vers√£o prec√°ria de um limite de TabCoins que dever√° ficar muito mais robusto no futuro, principalmente com as altera√ß√µes de comportamento que est√£o sendo propostas pelo @aprendendofelipe .
Mas por hora e para atender uma demanda emergencial da comunidade do TabNews, optei por tomar alguns atalhos na implementa√ß√£o para colocar isso em produ√ß√£o o mais r√°pido poss√≠vel. Os atalhos foram:

- N√£o refatorar o `firewall.js` para receber o `content.id` e conseguir considerar ele.
- Implementar a regra de forma "hard coded" no controller usado no endpoint `/api/v1/contents/tabcoins`
- Dado que a regra est√° "hard coded" no controller, n√£o √© poss√≠vel desativar ela para os testes, o que faz quebrar os testes implementados pelo @aprendendofelipe sobre estressar o cr√©dito/d√©bito. √â uma pena, mas √© tempor√°rio e o comportamento disto n√£o mudou, apenas os testes estar√£o com .`skip` a partir deste PR.
  Os atalhos n√£o foram agressivos e o mais importante, n√£o deixam nenhuma mancha permanente no sistema. Tudo isto pode ser desfeito ou melhorado a qualquer momento.
  Por √∫ltimo, apesar deste PR estar diretamente relacionado ao proposto pela issue #1166 ela n√£o pode ser considerada conclu√≠da, dado a forma que foi implementado.

**[edit]**

1. Como j√° observado em discuss√µes passadas aqui no reposit√≥rio, esta medida serve apenas para dificultar o abuso das qualifica√ß√µes. Outras medidas ser√£o implementadas.
2. Saudades de fazer PR e participar aqui do reposit√≥rio do TabNews üòç
   </pull_1265_Limitar `1` TabCoin por `Conte√∫do` Por `IP` por `72 horas`>

<pull_1270_feat: added tooltip to show full date in post list>
Percebi que tem um componente de Tooltip bem legal quando passamos o mouse em cima da data quando estamos lendo o post, pensei em colocar o mesmo nas listas de posts.

## antes

## depois

> > Review de Caixetadev (APPROVED):
> > Review de fabriciolak (APPROVED):
> > Review de aprendendofelipe (APPROVED):
> > </pull_1270_feat: added tooltip to show full date in post list>

<pull_1274_feat(header-menu): add new link to user contents>
Adiciona novo item ao `header` para facilitar, agilizar e estimular o acesso aos conte√∫dos criados pelo pr√≥prio usu√°rio. O acesso aos conte√∫dos diretamente no `header` torna mais **acess√≠vel** a visualiza√ß√£o da cria√ß√£o do seu conte√∫do no site, **facilitando**, agilizando e **estimulando** o acompanhamento de suas intera√ß√µes e recebimento de `tabcoins`, assim como tamb√©m pode estimular a produ√ß√£o de mais conte√∫dos de valor ao site, ao visualizar com recorr√™ncia suas contribui√ß√µes ao `tabnews`.

> > Review de Caixetadev (DISMISSED):
> > Review de Caixetadev (APPROVED):
> > Review de aprendendofelipe (APPROVED):
> > </pull_1274_feat(header-menu): add new link to user contents>

<pull_1277_feat(tab-coin-buttons): add hover to improve user experience>
Ol√°!
Motiva√ß√£o da PR: Recentemente comecei a usar o tabnews. Como sou pregui√ßoso, n√£o li muito sobre o funcionamento das tabcoins e etc. Quando vi os bot√µes de arrow-up e arrow-down pra adicionar ou debitar tab-coins, eu realmente n√£o entendi pra que serviam esses bot√µes... de imediato eu nem achei que eram bot√µes, achei que eram s√≥ uma quest√£o de estiliza√ß√£o. Depois que passei o mouse em cima sem querer, achei que seria algo relacionado √† minimizar ou maximizar os coment√°rios. Da√≠ s√≥ depois que fui ler certinho essa [postagem](https://www.tabnews.com.br/filipedeschamps/tentando-construir-um-pedaco-de-internet-mais-massa) do Filipe √© que fui entender do que se tratava.
Acredito que adicionando um simples tooltip j√° melhore muito a experi√™ncia do usu√°rio. E foi isso que eu fiz nessa PR. Seguem prints de como ficou:

> > Review de Ryannnkl (DISMISSED):
> > Review de Caixetadev (DISMISSED):
> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > Boa @PauloIVM, falta resolver os conflitos de merge, e para isso eu anotei no c√≥digo o que deve ser corrigido, mas tamb√©m precisa adicionar `const isInAction = isPosting || isAnimatingCredit || isAnimatingDebit;` conforme est√° no PR #1255
> > Fora isso, s√≥ adicionei a sugest√£o de remover o `noDelay` para o `Tooltip` n√£o se tornar incoveniente.
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      <Tooltip aria-label="Achei relevante" direction="ne">
        <IconButton
          variant="invisible"
          aria-label="Creditar TabCoin"
          icon={ChevronUpIcon}
          size="small"
          sx={{ color: 'fg.subtle', lineHeight: '18px' }}
          onClick={() => transactTabCoin('credit')}
          disabled={isInAction}
        />
      </Tooltip>
```

1. Remover o `<Box>` desnecess√°rio;
2. Atualizar para as novas vers√µes de `onClick` e `disable`;
3. Sugiro a remo√ß√£o do `noDelay={true}`;
4. Fazer o mesmo com o bot√£o de d√©bito.
   </pull_1277_feat(tab-coin-buttons): add hover to improve user experience>

<pull_1290_Inicia o fluxo de recupera√ß√£o de senha apenas por `email`>
Este PR traz uma implementa√ß√£o para **iniciar o fluxo** de [recupera√ß√£o de senha apenas por `email`](https://github.com/filipedeschamps/tabnews.com.br/issues/1180) por√©m com a possibilidade de pessoas com uma feature de modera√ß√£o conseguirem inici√°-lo utilizando o `username` como fallback.
Importante destacar que com esta implementa√ß√£o uma pessoa com a feature `update:content:others` s√≥ pode iniciar o fluxo utilizando o `username` se estiver logada na aplica√ß√£o.

## Usu√°rio deslogado

https://user-images.githubusercontent.com/57193392/222304018-3a678451-ed3f-4b48-9ec9-7c7391703648.mp4

## Usu√°rio logado mas que n√£o tem feature de modera√ß√£o

https://user-images.githubusercontent.com/57193392/222304342-017dcee9-32b5-4199-b6b1-29281660c188.mp4

## Usu√°rio logado e que tem feature de modera√ß√£o

https://user-images.githubusercontent.com/57193392/222304532-ca09009b-3047-4c83-9eec-d20ceb5b5b4a.mp4

> > Review de aprendendofelipe (COMMENTED):
> > Boa @kaique-soares, obrigado pelo PR! üí™
> > Fiz alguns coment√°rios no c√≥digo üëç
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Muito bom @kaique-soares! üëèüëèüëè
> > S√≥ fiz um coment√°rio no c√≥digo üëç
> > Review de aprendendofelipe (COMMENTED):
> > @kaique-soares, adicionei mais coment√°rios üòâ
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que n√£o √© melhor deixar essa parte dentro de `models/authorization`?
> > Talvez criar uma feature espec√≠fica para isso, pois acho que o @filipedeschamps pode ter citado a `update:content:others` apenas como exemplo de feature de moderadores
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Como temos acesso √†s features do usu√°rio em `user.features`, ser√° que n√£o √© interessante criar uma mensagem espec√≠fica para moderadores, diferente da padr√£o?
> > Ou talvez criar um novo campo que aceita `username` e s√≥ aparece para moderadores?
> > Acho isso importante para os moderadores saberem que existe a possibilidade de ajudar outros usu√°rios a recuperarem a senha.
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Ser√° que n√£o √© melhor deixar essa parte dentro de `models/authorization`?
> > Show @aprendendofelipe! Vou fazer esta altera√ß√£o :handshake:
> > Talvez criar uma feature espec√≠fica para isso...
> > Pensei nisso antes de come√ßar implement√ß√£o e logo fui olhar as features dispon√≠veis dentro do model `authorization` e pensei que a feature mais adequada seria a `create:recovery_token` pois j√° existe a feature `read:recovery_token` e at√© a√≠ tudo bem.
> > https://github.com/filipedeschamps/tabnews.com.br/blob/29caea3f422ebae8120651181ab07484beee3500/models/authorization.js#L20-L22
> > Mas me veio o seguinte questionamento: Em que momento um usu√°rio recebe a feature `read:recovery_token`?
> > Dei uma vasculhada nos arquivos que compo·∫Ωm o fluxo de recupera√ß√£o de senha n√£o achei nada conclusivo, ent√£o, a partir da√≠ decidi implementar com a `update:content:others` mesmo. :+1:
> > Depois de ler seus coment√°rios hoje, vasculhei novamente com mais calma e me pareceu que a feature `read:recovery_token`, de fato, **n√£o** √© atribu√≠da a um usu√°rio e neste caso est√° sendo apenas utilizada para filtrar os dados que ser√£o retornados pela API baseado na feature, correto?
> > Vou refatorar para utilizar a nova feature `create:recovery_token` :+1: :handshake:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Excelentes sugest√µes :heart_eyes:! Vou trabalhar nisso :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > @aprendendofelipe eu adicionei a feature `create:recovery_token` mas implementar a verifica√ß√£o de permiss√£o dentro do `model/authorization` eu at√© consegui e os testes relacionados ao fluxo de recupera√ß√£o passaram mas quebraram v√°rios outros testes.
> > Fui investigar o porqu√™ dos testes quebrarem mas sinceramente n√£o consegui identificar a raz√£o. Ap√≥s algumas horas tentando eu resolvi voltar como estava antes mas j√° alterando o c√≥digo para usar a nova feature.
> > E no meio dessa situa√ß√£o me vieram 2 questionamentos:

1. Ser√° que o @aprendendofelipe e/ou quem estiver acompanhando tem alguma susgest√£o de como implementar a verifica√ß√£o dentro do `model/authorization`?
2. Considerando que para um usu√°rio que n√£o tem a feature `create:recovery_token` a recupera√ß√£o de senha s√≥ pode ser solicitada fornecendo um `email`, ent√£o, n√£o seria interessante deixar o `email` como obrigat√≥rio? E para quem tiver a feature `create:recovery_token` passaria al√©m do seu `email`, o `username` de quem precisa recuperar sua senha.
   > > Coment√°rio de kaique-soares (linha de c√≥digo):
   > > Ou talvez criar um novo campo que aceita username e s√≥ aparece para moderadores?

## Testando possibilidades, o que acha?

1. Com o campo `username` e com a mensagem explicativa acima
2. Com o campo `username` e com a mensagem explicativa acima entre os campos
3. Com um √∫nico campo que aceita `email` ou `username`.

## Em rela√ß√£o √† mensagem explicativa

N√£o estou satisfeito com a mensagem mas essa √© uma vers√£o ap√≥s v√°rias reescritas :smile: , ent√£o, caso tenha alguma sugest√£o para melhorar a mensagem explicativa ou at√© modific√°-la por completo, s√≥ falar :handshake:

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > @kaique-soares acho que podemos deixar algo menos t√©cnico aqui. N√£o sei como est√° em outras partes do TabNews, mas uma mensagem simples, mais ou menos na linha de _"Voc√™ pode recuperar a sua senha ou de outra pessoa informando o nome de usu√°rio desejado"_, me parece melhor.
> > Dentre as tr√™s op√ß√µes de UI, a terceira me parece melhor porque eu, como moderador, n√£o preciso me perguntar se devo preencher os dois campos (da imagem 1 e 2).
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

O banco local √© descart√°vel, ent√£o s√≥ de rodar os testes j√° vai limpar as tabelas e permitir adicionar o `admin` com a nova feature na pr√≥xima vez que rodar em desenvolvimento.
Ent√£o √© s√≥ adicionar a feature no array passado para a fun√ß√£o `insertUser('admin', 'admin@admin.com', ...`

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
              <FormControl.Validation variant="error">"email" deve conter um endere√ßo v√°lido.</FormControl.Validation>
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            {['userInput', 'email', 'username'].includes(errorObject?.key) && (
```

Precisa aqui tamb√©m, pois se o usu√°rio digitar um `username` reservado (admin, user etc.) ele tem que ver a mensagem de erro.

> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Caramba, √© verdade! Como eu tava rodando o teste `tests/.../recovery/post.test.js` em modo watch n√£o tava atualizando da√≠ eu criei essa fun√ß√£o mas a solu√ß√£o era bem mais simples :smile:
> > Vou alterar :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Tamb√©m achei a mensagem estranha mas apenas repliquei a que j√° √© retornada da api. Se n√£o estou enganado, no passado foi levantado a quest√£o de refatorar as mensagens de erro.
> > Vou alterar :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Show! Muito bem lembrado, havia me esquecido do array de `reservedUsernames`.
> > Vou alterar :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Feito :handshake:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Feito :handshake:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Feito :handshake:
> > </pull_1290_Inicia o fluxo de recupera√ß√£o de senha apenas por `email`>

<pull_1294_Corrige erro de hydration no tooltip da data do post>
A formata√ß√£o de datas utilizando `Date.toLocaleString` t√™m implementa√ß√µes diferentes entre browser e nodejs.
N√£o vi muitos detalhes mas aparentemente esse j√° √© um erro conhecido (https://github.com/nodejs/node/issues/45945). Fiz uns testes na vers√£o 19.7.0 e acho que isso j√° foi resolvido, mas de qualquer forma isso s√≥ deve ser usado aqui no TabNews quando lan√ßarem o nodejs 20 LTS.
Para contornar esse erro fiz uma pequena refatora√ß√£o no componente `PublishSince` para utilizar o date-fns na forma√ß√£o de datas do tooltip. Isso deve resolver esse problema tanto na p√°gina inicial quanto na `[username]/[slug]`.

- **Erro em dev**
- **Erro em prod** \*_em uma guia an√¥nima n√£o recebo nenhum erro no console_

- **Depois da corre√ß√£o**
  > > Review de aprendendofelipe (COMMENTED):
  > > Ol√° @ErickCReis, obrigado pelo PR! üí™
  > > Achei boa ideia a centraliza√ß√£o no componente `PublishedSince`, mas vai ter que fazer algum outro ajuste para ficar correto o alinhamento tanto no `Content` quanto no `ContentList`. Veja o coment√°rio no c√≥digo. ü§ù
  > > Mas com rela√ß√£o ao erro de hidrata√ß√£o, ele s√≥ √© disparado no console em desenvolvimento, correto? Ou em produ√ß√£o est√° apresentando algum problema al√©m de mostrar um hor√°rio diferente no DevTools?
  > > Isso n√£o deve mudar com essa implementa√ß√£o. Pelo menos em preview ou em dev (gitpod) a hora continua diferente.
  > > Parece que tem mesmo uma diferen√ßa entre o node e o browser (com ou sem "√†s"), mas de qualquer maneira vai existir a diferen√ßa do fuso dos servidores onde s√£o geradas as p√°ginas est√°ticas (ou onde roda o gitpod) e o equipamento local.
  > > Para n√£o ter essa diferen√ßa, poder√≠amos tentar fixar um fuso, mas como o _client_ pode estar em diferentes fusos, mesmo dentro do Brasil, n√£o acho interessante fazer isso, a n√£o ser que esteja causando algum impacto real.
  > > Ent√£o a minha d√∫vida √©: Esse PR √© para lidar com as mensagens que ocorrem em modo de desenvolvimento ou tem algo a mais que eu ainda n√£o captei?
  > > Se for s√≥ para as mensagens em desenvolvimento, ent√£o s√≥ vai resolver o desenvolvimento local, mas te que ver tamb√©m esses pontos que comentei no c√≥digo! üëç
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > J√° estava presente antes desse PR, mas na revis√£o eu percebi um Bug no hor√°rio mostrado na p√°gina de conte√∫dos (no contentList n√£o ocorre). O hor√°rio fica 3 horas adiantado, mas s√≥ ocorre quando acessamos um conte√∫do diretamente pelo seu endere√ßo e n√£o atrav√©s do next/link.
  > > Ent√£o vou adicionar um commit que contorna esse Bug, mas outras opini√µes s√£o bem vindas quanto a forma que resolvi.
  > > O que ocorre √© que o Tooltip n√£o √© atualizado com a mudan√ßa somente do fuso. Nem mesmo usando `useState` e `useEffect`. E eu n√£o consegui entender a raz√£o disso, pois s√£o duas strings diferentes.
  > > Como alternativa para for√ßar a atualiza√ß√£o, no lado do server (`useState`), eu inseri um caractere invis√≠vel antes do texto do hor√°rio. E no client (`useEffect`) o estado √© atualizado sem esse caractere, o que faz o hor√°rio no Tooltip ser atualizado corretamente.
  > > Review de aprendendofelipe (APPROVED):
  > > @ErickCReis, como eu n√£o tenho permiss√£o de escrita no seu Fork, vou aprovar esse PR e criar outro corrigindo o problema que relatei.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      <span suppressHydrationWarning={true}>{formatPublishedSince(date)}</span>
```

Precisa disso para n√£o explodir `Unhandled Runtime Error` com publica√ß√£o de, por exemplo, poucos segundos atr√°s.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    <Tooltip sx={{ position: 'absolute', ml: 1, mt: '1px' }} aria-label={formatTooltipLabel(date)}>
```

Aqui complicou unificar o `Tooltip` no `PublishedSince`, pois sem `mt: '1px'` vai ficar desalinhado no `Content` e com `mt: '1px'` vai ficar desalinhado no `ContentList`.

> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Resolvi esse problema adicionando um padding no `Content`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    <Tooltip suppressHydrationWarning sx={{ position: 'absolute', ml: 1 }} aria-label={formatTooltipLabel(date)}>
```

Para n√£o dar mais o erro no console mesmo usando o Gitpod

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
export default function PublishedSince({ date }) {
  // added invisible character to force rendering the correct time on the client
  const [tooltipLabel, setTooltipLabel] = useState('\u034f' + formatTooltipLabel(date));
  useEffect(() => {
    setTooltipLabel(formatTooltipLabel(date));
  }, [date]);
  return (
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
import { Tooltip } from '@primer/react';
import { useEffect, useState } from 'react';
```

</pull_1294_Corrige erro de hydration no tooltip da data do post>

<pull_1296_fix(date tooltip): fix client time zone>
Durante a revis√£o do PR #1294 foi identificado um bug que j√° estava presente anteriormente.
O hor√°rio mostrado na p√°gina de conte√∫dos (no contentList n√£o ocorre) fica 3 horas adiantado, mas s√≥ ocorre quando acessamos um conte√∫do diretamente pelo seu endere√ßo e n√£o atrav√©s do next/link.
O que ocorre √© que o Tooltip n√£o √© atualizado com a mudan√ßa somente do fuso. Nem mesmo usando `useState` e `useEffect`. E eu n√£o consegui entender a raz√£o disso, pois s√£o duas strings diferentes.
Como alternativa para for√ßar a atualiza√ß√£o, no lado do server (`useState`), eu inseri um caractere invis√≠vel antes do texto do hor√°rio. E no client (`useEffect`) o estado √© atualizado sem esse caractere, o que faz o hor√°rio no Tooltip ser atualizado corretamente.
Tamb√©m estou adicionando um `suppressHydrationWarning` no `Tooltip` para eliminar erros do console que ocorrem em modo de desenvolvimento remoto, como no Gitpod.

> > Review de Caixetadev (DISMISSED):
> > </pull_1296_fix(date tooltip): fix client time zone>

<pull_1297_feat(component): creates the password input component with the option to see the password>
**Motiva√ß√£o:**
Durante o processo de cadastro no site, enquanto digitava minha senha, percebi que n√£o havia um bot√£o que permitisse visualizar a senha que estava sendo digitada. Essa funcionalidade √© bastante comum em muitos sites e aplicativos e pode ser extremamente √∫til para evitar erros de digita√ß√£o e garantir que a senha cadastrada esteja correta.

**Nesta PR:**
Criei um componente de input de senha com um bot√£o para o usu√°rio conseguir ver a senha que est√° digitando e atualizei as paginas de login, registro e recupera√ß√£o de senha para come√ßarem a usar esse componente.

**Resultado:**
https://user-images.githubusercontent.com/27015559/222832211-8d1a3b1f-593c-430d-adff-7dad46f194fe.mp4

> > Review de aprendendofelipe (COMMENTED):
> > @edersonlucas, est√° show! üí™
> > S√≥ fiz algumas perguntas no c√≥digo ü§ù
> > Review de edersonlucas (COMMENTED):
> > Review de edersonlucas (COMMENTED):
> > Review de edersonlucas (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de edersonlucas (COMMENTED):
> > Review de edersonlucas (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de edersonlucas (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
export default function PasswordInput({ inputRef, id, name, label, errorObject, setErrorObject, ...props }) {
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Precisa mesmo desse `setTimeout`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Precisa do `detectCapsLock` aqui?
> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > Precisa, porque o comportamento padr√£o do `primer` √© focar no in√≠cio do texto. Eu n√£o consegui remover esse comportamento. Ent√£o a solu√ß√£o que encontrei foi colocar esse `SetTimeout` s√≥ para ter um `delay` e focar no final do texto, mas √© impercept√≠vel para o usu√°rio.
> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > Esse s√≥ coloquei para conseguir validar se o `Caps Lock` est√° ativo quando clicar no bot√£o de ver a senha. Porque quando a pagina renderiza n√£o tem um feedback instant√¢neo sobre o `Caps Lock` estar ou n√£o ativado. Como tenho essa mania de clicar para ver a senha rsrs. Ent√£o √© bem opcional.
> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > A parte `ref.current.focus();` essa, sim, da para remover. Porque o bot√£o j√° estar√° focado, mas eu quis deixar mais pelo fato de ficar explicito mesmo.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O que acha de deixar o background transparente e retirar tamb√©m a sombra?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        aria-label={label}
        {...props}
```

> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > Curti demais, subirei a altera√ß√£o aqui.
> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > Essa quest√£o das `props` seria algo mais pensando no futuro, para caso queira passar mais alguma propriedade al√©m das que j√° foram passadas, sem ter que alterar o `componente` novamente. Isso?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Isso, √© s√≥ para facilitar caso algu√©m precise usar o componente com alguma estiliza√ß√£o diferente.
> > S√≥ se voc√™ achasse interessante. üëç
> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > Pensando por esse lado realmente √© interessante. Subirei a altera√ß√£o aqui.
> > </pull_1297_feat(component): creates the password input component with the option to see the password>

<pull_1298_fix(date tooltip): fix horizontal scrolling caused by tooltip position>
**Motiva√ß√£o:**
Estava acessando o TabNews pelo celular quando cliquei na hora da postagem o tooltip n√£o apareceu por completo e criou uma rolagem horizontal na pagina. Acredito que seja um bug.

**Nesta PR:**
Adicionei uma propriedade direction no component PublishedSince e atualizei os componentes Content e ContentList que utilizavam este componente. Utilizei como base a documenta√ß√£o do primer.

**Antes**

**Depois**

> > Review de aprendendofelipe (COMMENTED):
> > Boa @edersonlucas, obrigado pelo PR! üí™
> > No Tooltip do Primer/React faltou uma op√ß√£o `direction: 'auto'` que deveria ser a padr√£o, n√©? E falando em padr√£o, a documenta√ß√£o do Tooltip nem fala qual √© o `default`, mas pelo jeito √© `n`.
> > E o que ser√° que acontece se passar `wrap: true` para o Tooltip? Ser√° que ele quebraria a linha ao inv√©s de mostrar a barra de rolagem?
> > E falando em wrap, adicionar o Tooltip no `ContentList` criou mais um bug, pois faltou o `whiteSpace: 'nowrap'` para n√£o quebrar o `PublishedSince ` em duas linhas como abaixo:
> > Me diga o que acha sobre o que comentei no c√≥digo e fica a seu crit√©rio verificar essas quest√µes do `wrap`. ü§ù
> > Review de edersonlucas (COMMENTED):
> > Review de edersonlucas (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Show @edersonlucas, muito obrigado! üí™
> > E bem vindo √† Turma de contribuidores do TabNews! üëèüëèüëè
> > Logo mais estar√° em produ√ß√£o üöÄüöÄüöÄ
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Considerando que `n` parace ser o padr√£o, acho que n√£o precisa passar nada aqui.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
export default function PublishedSince({ date, ...props }) {
```

Assim o componente fica mais flex√≠vel

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    <Tooltip sx={{ position: 'absolute', ml: 1 }} aria-label={formatTooltipLabel(date)} {...props}>
```

E qualquer propriedade extra que for passada para `PublishedSince` ser√° repassada para o `Tooltip`.

> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > Show! Isso eu havia percebido, mas considerei deixar assim mais pela quest√£o de ficar explicita a posi√ß√£o no c√≥digo.
> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > Perfeito!
> > </pull_1298_fix(date tooltip): fix horizontal scrolling caused by tooltip position>

<pull_1300_Possibilidade de exibir e ocultar parte das respostas dos conte√∫dos (manualmente e automaticamente)>
Turma, por favor me digam o que ainda pode ou deve ser alterado antes de ir para produ√ß√£o.

## UX

A proposta inicial era usar o Timeline do Primer, mas ele n√£o ajudou muito, ent√£o n√£o utilizei.
O visual est√° bem simples, e bastante similar ao reddit, mas acredito que est√° legal como primeira vers√£o da funcionalidade.
Fiquei com medo de fazer algo mirabolante, mas como o @filipedeschamps falou em deixar um pouco mais compreens√≠vel, coloquei os √≠cones que podem ser vistos na imagem mais abaixo, onde uma das barras est√° com hover:
Deem suas opini√µes, pois mudar a estiliza√ß√£o √© a parte f√°cil dessa implementa√ß√£o, e √© a mais importante.

## Mais UX nesse PR

Coisas relacionadas que j√° implementei, onde o primeiro √© algo com um impacto real em telas pequenas, ent√£o analisem bem:

### Achatar √°rvore de respostas

Agora os ramos de respostas n√£o ficam na diagonal se n√£o for necess√°rio. Por exemplo, dois usu√°rios respondendo um ao outro em sequ√™ncia vai fazer aparecer uma resposta abaixo da outra, em ordem cronol√≥gica. S√≥ quando uma mesma resposta for a m√£e de mais de um filho, a√≠ sim a √°rvore ir√° bifurcar. Obs. isso s√≥ ocorre no client, n√£o muda nada na estrutura real dos dados.
Compare [essa publica√ß√£o](https://tabnews-gbs3n8z1r-tabnews.vercel.app/Gustavo33/teste4593832181797422292334945798549354624941348715825899669) como √© atualmente e [como fica com esse PR](https://tabnews-3oy3e5vac-tabnews.vercel.app/Gustavo33/teste4593832181797422292334945798549354624941348715825899669). Essa publica√ß√£o tamb√©m √© interessante, pois mostra uma bifurca√ß√£o:
| [link para a vers√£o atual](https://tabnews-gbs3n8z1r-tabnews.vercel.app/filipedeschamps/testando-o-novo-metodo-findrootcontent-que-vai-poder-trazer-muito-mais-contexto) | [link para a vers√£o achatada](https://tabnews-9og3kpb67-tabnews.vercel.app/filipedeschamps/testando-o-novo-metodo-findrootcontent-que-vai-poder-trazer-muito-mais-contexto) |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| | |

### Collapsar automaticamente as mensagens de conte√∫dos com muitas respostas

Esse PR n√£o abre somente a possibilidade de omitir e exibir as respostas de acordo com a inten√ß√£o do usu√°rio, mas tamb√©m j√° condensa mensagens a partir de um limiar. Esse limiar est√° definido como a altura da tela em pixels dividido por 50, o que d√° cerca de 21 respostas em uma tela full hd, mas qualquer sugest√£o de altera√ß√£o nesse valor √© bem vinda. Fora isso, para expandir a quantidade de respostas vis√≠veis tamb√©m existe um limite por clique, que √© a metade do valor anterior.
Apenas para facilitar os testes e visualiza√ß√£o desse comportamento, existe um deploy que est√° com um limiar bem inferior. Ele renderiza no m√°ximo 7 respostas iniciais e no m√°ximo 4 a cada nova expans√£o. Eles podem ser vistos nos links abaixo:

- [Conte√∫do para teste](https://tabnews-9og3kpb67-tabnews.vercel.app/filipedeschamps/tentando-consertar-o-oveflow-do-body).
- [Outro conte√∫do para teste](https://tabnews-9og3kpb67-tabnews.vercel.app/Gustavo33/teste4593832181797422292334945798549354624941348715825899669)
  Obs. S√≥ lembrando que a vers√£o para revis√£o tem limites maiores: [link 1](https://tabnews-git-collapse-answers-tabnews.vercel.app/filipedeschamps/tentando-consertar-o-oveflow-do-body) e [link 2](https://tabnews-git-collapse-answers-tabnews.vercel.app/Gustavo33/teste4593832181797422292334945798549354624941348715825899669)

### Margem entre cada n√≠vel de resposta

Alterei o limiar que diminui a margem que faz o espa√ßamento entre cada n√≠vel de respostas.
Isso tamb√©m muda o espa√ßamento entre as barras que agora s√£o clic√°veis.
Antes ele s√≥ alargava em telas maiores que 1000px, mas agora o limiar √© 800px. O padding geral do site continua como antes, mudando em 1000px.

## Regras de neg√≥cio

Parecia algo simples, mas foi bem chato de lidar com todas as possibilidades. Principalmente para n√£o quebrar a interface quando a √°rvore de conte√∫dos √© atualizada via API e tamb√©m a quest√£o de mostrar as quantidades corretas de conte√∫dos quando eles est√£o agrupados (n√£o √© apenas o `children_deep_count`).
No final eu at√© que consegui simplificar o c√≥digo que criei inicialmente, mas ainda assim sobrou tanta coisa que achei melhor criar o hook `useCollapse`.

## B√¥nus

Para conseguir desenvolver e realizar os testes necess√°rios para esse PR, tive que mexer em algumas coisas a mais, o que pode j√° ter vindo nesse ou ir√° vir em novos PRs:

1. Acho que todos que usam mais o TabNews j√° chegaram a acessar algum conte√∫do que tinha sido apagado recentemente. Nesses casos, ao carregar a p√°gina via cache, a interface quebrava ap√≥s a revalida√ß√£o via API retornando 404.
   O erro n√£o tratado ocorria por causa do componente `PublishedSince` recebendo uma data como `undefined`. Daria para fazer uma valida√ß√£o desse dado, mas seria algo que iria retornar sucesso em 99,99% dos casos, ent√£o √© s√≥ processamento desnecess√°rio, ent√£o s√≥ coloquei um try catch no estilo "pedir perd√£o e n√£o permiss√£o".
   Agora quando ocorrer essa situa√ß√£o de conte√∫do apagado recentemente, apenas vai sumir o conte√∫do, mas sem gerar erros. S√≥ fiz isso para poder isolar os erros espec√≠ficos desse PR, que foram muitos durante o desenvolvimento. üòÖ
   Mas para um pr√≥ximo momento pode ser legal renderizar o modo "conte√∫do deletado" enquanto faz um redirecionamento via client para a p√°gina 404.
2. Enquanto estava tentando utilizar a Timeline do Primer eu acabei fazendo uma refatora√ß√£o no c√≥digo da p√°gina de conte√∫do. Eu gostei do resultado, mas removi as altera√ß√µes quando desisti do Primer nesse PR. Assim isso pode ser analisado separadamente. Mas acho que vale a pena aguardar a conclus√£o do PR atual antes de mexer com esse outro.
   > > Review de Rafatcb (COMMENTED):
   > > Acho que o resultado final ficou legal. √â preciso ter um pouco de calma para entender lendo o c√≥digo porque n√£o ficou algo simples, e estou n√£o clonei o reposit√≥rio para ir "debugando", mas acho que est√° bom para entrar e ser refatorado com o tempo, conforme precise de modifica√ß√µes.
   > > Marquei alguns n√∫meros m√°gicos pra criar constantes pra ficar mais claro e f√°cil de encontrar posteriormente.
   > > Review de aprendendofelipe (COMMENTED):
   > > Review de aprendendofelipe (COMMENTED):
   > > Review de aprendendofelipe (COMMENTED):
   > > Coment√°rio de Rafatcb (linha de c√≥digo):
   > > Isso seria a quantidade inicial de coment√°rios vis√≠veis? No caso, j√° √© "desconsiderado" logo cedo por causa do `useEffect` abaixo, n√©?
   > > Coment√°rio de Rafatcb (linha de c√≥digo):
   > > N√£o ficou claro para mim o porqu√™ do 50. Talvez dando um nome para essa constante j√° fique claro.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Isso mesmo, √© o que vai vir na p√°gina est√°tica, depois no client √© alterado... Em telas full hd vai virar 21
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > O @filipedeschamps sugeriu da quantidade de coment√°rios variar de acordo com o tamanho da janela. Como ele n√£o estipulou valor, comecei por esse
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Alterei para 21, assim n√£o sofre nenhuma altera√ß√£o pelo menos em algum tamanho de tela.
   > > </pull_1300_Possibilidade de exibir e ocultar parte das respostas dos conte√∫dos (manualmente e automaticamente)>

<pull_1303_N√£o mostrar a senha ao pressionar a tecla `Enter`>
O PR #1297 que implementou a op√ß√£o de mostrar a senha veio com um pequeno bug:

- Ao pressionar a tecla `Enter` no campo de senha, o modo de mostrar a senha era alterado. E com isso a senha era exibida ao inv√©s de submeter os dados.
  Ent√£o eu substitu√≠ o `trailingVisual` + `Tooltip` pelo `trailingAction` + `TextInput.Action` que j√° tem o comportamento e estiliza√ß√£o adequados.
  Obs.: Precisei trocar o `className` do `TextInput.Action` dentro de um `useEffect` para mudar o `Tooltip` embutido de `n` para `nw`, pois ele n√£o permite passar essa propriedade. E sem essa mudan√ßa o `Tooltip` faria aparecer a barra de rolagem em telas pequenas.
  </pull_1303_N√£o mostrar a senha ao pressionar a tecla `Enter`>

<pull_1304_refactor(password input): updating component style>
Nesta PR estou apenas fazendo uma sugest√£o de refatora√ß√£o no `componente` para usar recursos do `primer`.

> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > Review de aprendendofelipe (DISMISSED):
> > Review de edersonlucas (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            sx={{ color: 'fg.subtle' }}
```

N√£o podemos deixar o padding zerado por quest√£o de acessibilidade, pois a √°rea clic√°vel fica muito pequena.

> > Coment√°rio de edersonlucas (linha de c√≥digo):
> > Entendi, realmente n√£o pensei nesse detalhe. Show! ü§ù
> > </pull_1304_refactor(password input): updating component style>

<pull_1312_refactor(authorization): simplify "can" function>
Seguindo a [issue #1307](https://github.com/filipedeschamps/tabnews.com.br/issues/1307) de @aprendendofelipe, este PR traz a simplifica√ß√£o do c√≥digo na fun√ß√£o can, trazendo o teste da feature `user.features.includes('update:user')` e removendo as chamadas recursivas!

> > Review de aprendendofelipe (APPROVED):
> > </pull_1312_refactor(authorization): simplify "can" function>

<pull_1315_fix(docker setup): support the new `docker compose` command>
Uma pequena adi√ß√£o no `package.json`, para suportar o novo comando `docker compose`, que substitui o antigo `docker-compose`, a partir da vers√£o 20.10 (19-01-2023).
A adi√ß√£o suporta ambas vers√µes do comando.

> > Review de aprendendofelipe (APPROVED):
> > </pull_1315_fix(docker setup): support the new `docker compose` command>

<pull_1316_chore(postgres): enable slow query log>
Consultas que levam mais de 2s ser√£o logadas no `slow query log`. Com essa configura√ß√£o teremos visibilidade de quais queries est√£o demorando, e podemos diminuir esse tempo at√© 1s, ap√≥s uma primeira itera√ß√£o.

> > Review de aprendendofelipe (DISMISSED):
> > </pull_1316_chore(postgres): enable slow query log>

<pull_1318_fix: remove duplicated reveal password button in microsoft edge>
O navegador Microsoft Edge, exibe nos campos de senha um bot√£o para mostrar a senha e ap√≥s a implementa√ß√£o do [`PasswordInput`](#1297) com op√ß√£o de exibir a senha esse comportamento ficou duplicado. De acordo com meus testes s√≥ ocorre no Microsoft Edge.
| Antes | Depois |
| ----- | ------ |
| |
</pull_1318_fix: remove duplicated reveal password button in microsoft edge>

<pull_1319_Update de todas as depend√™ncias>
Atualiza todas as depend√™ncias e faz a adequa√ß√£o do `next.config.js`
</pull_1319_Update de todas as depend√™ncias>

<pull_1321_Exclus√£o da p√°gina de sucesso de login>
Bem no come√ßo do TabNews foi utilizada a p√°gina de sucesso de login, mas logo ela foi substitu√≠da pela p√°gina de publicar e, em seguida, foi adicionado o redirecionamento de volta para a p√°gina que levou o usu√°rio para o login.
Por isso a p√°gina `login/sucesso` n√£o √© mais necess√°ria.
Relacionado a isso, j√° resolve #1256, que sugere remover a p√°gina de login do hist√≥rico de navega√ß√£o, para o usu√°rio conseguir navegar mais facilmente de volta para p√°ginas visitadas antes de efetuar o login.

> > Review de github-advanced-security[bot] (COMMENTED):
> > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Client-side URL redirect

Untrusted URL redirection depends on a [user-provided value](1).
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/33)
</pull_1321_Exclus√£o da p√°gina de sucesso de login>

<pull_1322_fix(bytemd mermaid): render diagrams correctly>
Faz a renderiza√ß√£o correta dos diagramas mermaid.

````
```mermaid
graph TD;
  A-->B;
  A-->C;
  B-->D;
  C-->D;
```
````

Ap√≥s aprova√ß√£o de PRs meus em duas bibliotecas (uma diretamente no ByteMD e outra em uma biblioteca da qual ele depende, a [hast-util-sanitize](https://github.com/syntax-tree/hast-util-sanitize)), podemos renderizar corretamente esses diagramas com seguran√ßa.
Obs. Agora j√° poder√≠amos aceitar corretamente f√≥rmulas matem√°ticas, mas vou criar um PR separado para avalia√ß√£o, pois isso aumenta em quase 20% o first load.
</pull_1322_fix(bytemd mermaid): render diagrams correctly>

<pull_1323_Adiciona capacidade de renderizar equa√ß√µes matem√°ticas>
Adiciona a capacidade de renderizar f√≥rmulas matem√°ticas, como solicitado nas issues:

- #901
- #936
- #989

```
$$
\displaystyle \left( \sum_{k=1}^n a_k b_k \right)^2 \leq \left( \sum_{k=1}^n a_k^2 \right) \left( \sum_{k=1}^n b_k^2 \right)
$$
```

$$
\displaystyle \left( \sum_{k=1}^n a_k b_k \right)^2 \leq \left( \sum_{k=1}^n a_k^2 \right) \left( \sum_{k=1}^n b_k^2 \right)
$$

Um ponto interessante nesse PR √© que usando a biblioteca `@bytemd/plugin-math-ssr` adicionar√≠amos 83kB ao first load do site, ou seja, 18% a mais, mas com a `@bytemd/plugin-math` s√≥ adicionamos 5kB.
Com qualquer das duas bibliotecas o usu√°rio ir√° ver as f√≥rmulas renderizadas corretamente como aqui no GitHub (equa√ß√£o acima). O que muda entre as bibliotecas √© o que vem no est√°tico, que em nenhuma das duas op√ß√£o √© algo muito interessante:

### Com SSR (+ 83kB)

### Sem SSR (+ 5kB)

Pelo custo benef√≠cio, entre as duas op√ß√µes, eu escolhi a mais leve.
Agora o que deve ser analisado nesse PR √© o custo benef√≠cio desses 5kB, ou seja, se vale a pena adicionar a capacidade de renderizar equa√ß√µes matem√°ticas.
Eu acho que vale a pena! üëç

> > Review de ermesonqueiroz (APPROVED):
> > </pull_1323_Adiciona capacidade de renderizar equa√ß√µes matem√°ticas>

<pull_1327_chore(terraform): bump database `engine_version` in `staging` to `14.3`>
Ap√≥s o PR #1315 do @FabricioFFC notei que, ao executar o `terraform plan` no ambiente de **homologa√ß√£o** ele apontou um `downgrade` na **vers√£o** da inst√¢ncia do RDS de `14.3` para `14.1` (que √© o que estava no arquivo). A AWS fez o upgrade dessa vers√£o de forma autom√°tica, e em produ√ß√£o o arquivo do Terraform j√° tinha sido feita a atualiza√ß√£o para ficar em sincronia, mas faltou o de homologa√ß√£o.

> > Review de aprendendofelipe (APPROVED):
> > </pull_1327_chore(terraform): bump database `engine_version` in `staging` to `14.3`>

<pull_1329_Desativa o achatamento da √°rvore de respostas e renderiza inicialmente um n√∫mero maior de respostas>
Desativei o achatamento e aumentei o n√∫mero de respostas iniciais para:
altura da tela em pixels / 10
</pull_1329_Desativa o achatamento da √°rvore de respostas e renderiza inicialmente um n√∫mero maior de respostas>

<pull_1340_Redirecionar sempre para a p√°gina anterior ap√≥s efetuar login>
Seguindo a proposta 1 do @rafatcb na issue #956, e continuando a modifica√ß√£o iniciada por @jgbispo no PR #966, esse PR faz com que o redirecionamento ap√≥s o login sempre ocorra para a p√°gina em que o usu√°rio estava antes de clicar no link para o login.
Antes isso s√≥ ocorria quando o redirecionamento para a p√°gina de login era iniciado automaticamente na tentativa de postar uma resposta ou qualificar uma publica√ß√£o.
Caso a p√°gina de login seja acessada diretamente, ent√£o o redirecionamento ser√° para a p√°gina inicial.
</pull_1340_Redirecionar sempre para a p√°gina anterior ap√≥s efetuar login>

<pull_1348_Dark mode sem flash e nova vers√£o do editor de markdown>
Implementa o modo escuro com a mitaga√ß√£o do problema das vers√µes anteriores, que era a piscada do tema diferente antes da exibi√ß√£o do tema correto. Ainda est√° como rascunho porque falta configurar `highlights`, mas j√° estou disponibilizando para a turma dar uma navegada e ver se encontra alguma cor incoerente ou qualquer necessidade de ajuste:
https://tabnews-156o2ppuy-tabnews.vercel.app
Foi criado o componente `Theme Provider` para isolar a solu√ß√£o do flash. Foi inserido um script que muda a p√°gina inteira para `visibility: hidden` antes da renderiza√ß√£o e volta para `visible` assim que o tema correto √© aplicado. O ponto de diferen√ßa de uma das solu√ß√µes anteriores √© que a p√°gina est√°tica vem carregada normalmente (pode ser conferido desabilitando o JS).
Essa solu√ß√£o n√£o resolve definitivamente o problema, pois se em alguma altera√ß√£o futura for adicionado algum componente setado com `visibility: visible`, ent√£o esse componente pode aparecer sozinho na tela com o tema indevido. Isso caso esse componente esteja presente na primeira p√°gina acessada.
Pra quem for analisar o c√≥digo, recomendo olhar cada commit separadamente:

- 1fb96d9a67d20b170bcbaf23fc76cca3c61f1ee6 Foram reorganizadas boa parte das importa√ß√µes dos componentes de UI.
- 3abd1a9f58301c8bc2efedf41398ea6229d5ebc8 Cria o `Theme Provider` e adiciona o script que permite alterar o esquema de cores sem piscar a tela.
- 54d77fc1db38574687e0eb60ac6997e403cf62e0 Adiciona ao menu um seletor de tema com op√ß√µes de claro, escuro ou autom√°tico. Para usu√°rios n√£o logados o bot√£o aparece no header, mas somente d√° a op√ß√£o de inverter o tema, n√£o tendo a alternativa autom√°tica.
- 6e859894c9284a8a84e0994ffada823bf73e3777 Inicia as adequa√ß√µes de todo o sistema para funcionar bem em qualquer dos temas (claro ou escuro):
- Muitas mudan√ßas de vari√°veis de cores ocorreram para que a mesma vari√°vel fa√ßa sentido em diferentes temas, mas na maioria dos casos a cor permanece a mesma.

- A maior exce√ß√£o s√£o os campos de entrada de texto em que mudei para a vers√£o de contraste, seguindo o padr√£o aqui do GitHub;
- Fixa√ß√£o das cores de tabcash e tabcoins para n√£o mudarem ao selecionar outro tema;

- Adicionados espa√ßamentos que permitem √†s bordas dos componentes aparecerem sem sobreposi√ß√µes;
- Cria um componente apenas de estiliza√ß√£o do editor de markdown (trabalho em andamento);

- Ao mexes nas estiliza√ß√£o do ByteMD, aproveitei para corrigir alguns problemas que ocorriam em telas pequenas, ou em respostas muito profundas na √°rvore, em que havia sobreposi√ß√£o do campo de texto com os bot√µes;
- Habilitei a a possibilidade de redimensionar o campo de texto.
  </pull_1348_Dark mode sem flash e nova vers√£o do editor de markdown>

<pull_1349_feat(header): add a publish new content button in the header>
#1238
Vi essa issue aberta h√° um certo tempo e achei interessante tentar implementar algo nesse sentido.
Obs.: Ainda estou aprendendo como ajudar por aqui no projeto ent√£o pe√ßo desculpas se tiver feito algo errado.

> > Review de devajmeireles (DISMISSED):
> > Review de Caixetadev (DISMISSED):
> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > Show @victorhcb! üí™
> > Sobre remover o √≠cone quando estiver na p√°gina de publica√ß√£o, eu n√£o acho necess√°rio. üëç
> > Sobre o restante, por favor, veja meus coment√°rios no c√≥digo ü§ù
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            sx={{
              display: ['none', 'flex'],
              mr: 2,
```

Conforme conversas que eu mencionei, √© melhor n√£o adicionar esse bot√£o na vers√£o mobile. E n√£o vai ser legal adicionar e depois remover, ent√£o √© melhor j√° n√£o adicionar.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
              <HeaderLink href="/publicar">
```

Estou em d√∫vida, ser√° que precisamos mesmo duplicar o `aria-label` que j√° est√° presente no `Tooltip`?

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
                <PlusIcon size={16} />
```

Motivo: √â o √≠cone oficial da biblioteca de UI do TabNews, ent√£o a estiliza√ß√£o est√° mais coerente com o restante do header, por exemplo o alinhamento e o hover.
</pull_1349_feat(header): add a publish new content button in the header>

<pull_1353_Ajustes de cores e responsividade do editor e visualizador de Markdown>

### Responsividade

- Ajusta melhor o tamanho inicial do campo de texto de acordo com o tamanho da janela.
- Ajusta o tamanho do campo de texto para ocupar o m√°ximo do tamanho da janela quando selecionado o modo fullscreen.
- Mostra barras de rolagem em f√≥rmulas matem√°ticas quando elas forem maiores que a largura da janela.

### Cores

- Corrige as cores resolvendo o relatado em #1350.
- Adiciona a mudan√ßa de tema nos gr√°ficos mermaid para corrigir o que o @Rafatcb [relatou no ambiente de homologa√ß√£o](https://tabnews-git-markdown-responsivity-tabnews.vercel.app/rafael/e380ee30-55f7-4a28-a8d9-07c65b502e61).
  Obs. Sobre os gr√°ficos mermaid, como a estiliza√ß√£o dele n√£o se d√° por vari√°veis css, o visualizador do ByteMD precisa ser renderizado novamente quando ocorrer a troca do tema. A maneira que usei para for√ßar uma nova renderiza√ß√£o foi mudar o valor do texto e voltar ao valor correto dentro do mesmo `useEffect`. Utilizando um par√¢metro ID ou atualizando a lista de plugins n√£o causava a nova renderiza√ß√£o.
  </pull_1353_Ajustes de cores e responsividade do editor e visualizador de Markdown>

<pull_1354_Renderiza os primeiros sub coment√°rios abaixo dos coment√°rios>
Altera o algoritmo que seleciona quais coment√°rios ficar√£o ocultos nas p√°ginas com muitos coment√°rios.
Antes a prioridade era renderizar o m√°ximo poss√≠vel do primeiro n√≠vel e ent√£o come√ßar a renderizar o segundo n√≠vel para os conte√∫dos mais relevantes e assim por diante.
Agora foi invertido e alguns sub coment√°rios dos coment√°rios mais relevantes ter√£o prioridade sobre os conte√∫dos de primeiro n√≠vel que estejam classificados mais abaixo.
Obs. N√£o muda nada para conte√∫dos com quantidade rotineira de coment√°rios, onde todos continuam sendo renderizados.
</pull_1354_Renderiza os primeiros sub coment√°rios abaixo dos coment√°rios>

<pull_1355_Corrige o algoritmo de expandir e ocultar coment√°rios do PR #1354>
Corrige o bug trazido no PR #1354 onde mais de um condicional da fun√ß√£o `computeStates` estava sendo executado para o mesmo coment√°rio, o que causava erro no valor apresentado em "ver mais", e algumas outras inconsist√™ncias.
Aproveitei para refatorar retirando a `computeStates` de dentro da `useCollapse`.
</pull_1355_Corrige o algoritmo de expandir e ocultar coment√°rios do PR #1354>

<pull_1356_feat(proxy response): reload login page if is proxy response>
Aplica uma solu√ß√£o apenas tempor√°ria para a issue #1344
</pull_1356_feat(proxy response): reload login page if is proxy response>

<pull_1357_feat(proxy response): fetch user before redirect>
Movi o c√≥digo que faz o redirecionamento autom√°tico ap√≥s o login para ser chamado dentro do `useUser`.
Dessa forma temos mais controle sobre o momento que ocorre o redirecionamento, pois isso afetou a mudan√ßa feita no PR #1356, que acabou n√£o tendo o efeito desejado, j√° que o redirecionamento acabava ocorrendo antes da atualiza√ß√£o da p√°gina, o que fazia o refresh acontecer em uma rota diferente de `\login`.
Ao navegarmos para a p√°gina de login existe uma chamada ao endpoint `\user` mesmo se n√£o houver cache do usu√°rio. Essa chamada serve para tamb√©m para verificar se existe algum bloqueio do proxy e dispara o refresh da p√°gina se for necess√°rio.
Durante os testes eu notei que havia uma chamada duplicada ao endpoint `\user`, ent√£o j√° removi a duplicidade. Como essa chamada n√£o ocorria somente na p√°gina de login, o resultado desse PR deve ser uma redu√ß√£o nas chamadas ao endpoint.

> > Review de github-advanced-security[bot] (COMMENTED):
> > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Client-side URL redirect

Untrusted URL redirection depends on a [user-provided value](1).
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/35)
</pull_1357_feat(proxy response): fetch user before redirect>

<pull_1358_fix(proxy response): catch network errors>
Provavelmente a Cloudflare est√° retornando erro de rede e por isso o fluxo dentro de `fetchUser` est√° sendo direcionado do `fetch` diretamente para o `catch` quando √© bloqueado pelo proxy.
Como s√≥ d√° pra ter certeza em produ√ß√£o, essa √© uma tentativa de confirmar a hip√≥tese.
</pull_1358_fix(proxy response): catch network errors>

<pull_1359_Replica para `/cadastro` e `/recuperar` a revalida√ß√£o da sess√£o com o proxy>
Quando a prote√ß√£o extra estiver ativa, ao navegar para qualquer endpoint protegido o navegador ser√° revalidado e, caso n√£o esteja com acesso √† API, a p√°gina ser√° recarregada para fornecer o acesso atrav√©s do desafio.
</pull_1359_Replica para `/cadastro` e `/recuperar` a revalida√ß√£o da sess√£o com o proxy>

<pull_1366_Analisa publica√ß√µes anteriores do mesmo usu√°rio ao publicar novo conte√∫do ou coment√°rio>
Al√©m do ganho de TabCoins ser baseado nas avalia√ß√µes dos conte√∫dos j√° publicados, a permiss√£o para publicar tamb√©m considera os conte√∫dos j√° publicados. Com isso o usu√°rio que, em m√©dia, tenha mais de 40% das √∫ltimas publica√ß√µes classificadas como n√£o relevantes ser√° avisado para excluir seus conte√∫dos recentes mal avaliados antes de prosseguir com a publica√ß√£o.
O valor considerado √© a m√©dia, ent√£o conte√∫dos bem avaliados ou um mal avaliados podem compensar os com qualifica√ß√µes opostas.
Por exemplo, para um usu√°rio que j√° possua mais de 10 publica√ß√µes, se o saldo das √∫ltimas 10, somando todas as qualifica√ß√µes, der um n√∫mero menor do que quatro negativo (-5 ou mais negativo ainda), ent√£o o usu√°rio ter√° que excluir as que estiverem levando essa m√©dia para baixo.
J√° se a soma estiver acima de cinco positivo (6 em diante), ent√£o o usu√°rio j√° come√ßa a ganhar TabCoins no momento da publica√ß√£o.
Se a m√©dia estiver entre os dois valores, ent√£o o usu√°rio s√≥ ganha ou perde os TabCoins das qualifica√ß√µes recebidas.
Os valores s√£o computados separadamente para conte√∫dos "root" ou "child", ent√£o o usu√°rio pode ter um prest√≠gios diferentes para cada tipo de publica√ß√£o.
31225e1f8529aa180aad50a6ff853a8d0a1b62c2

- Corrige a √°rvore de testes de 'TabCoins' que estava dentro do n√≥ 'User with "update:content:others" feature', quando o correto era o n√≥ 'Default user'.
  8fd204afa3e9fd7a980c1ca2cb7e00d95cd6bd4e

- No momento da publica√ß√£o, computa a m√©dia das qualifica√ß√µes dos √∫ltimos 10 conte√∫dos ("child" ou "root" de acordo com a publica√ß√£o atual).
- A m√©dia considera apenas os votos positivos e negativos, ou seja, n√£o considera o TabCoin que o conte√∫do j√° ganha no momento da cria√ß√£o.
- O saldo √© dividido pela quantidade de publica√ß√µes (no m√°ximo 10).
- Apenas publica√ß√µes com mais de 2 dias s√£o consideradas. Com isso um usu√°rio recente n√£o ganhar√° TabCoins nas suas primeiras publica√ß√µes (ganhar√° apenas os de qualifica√ß√£o). E tamb√©m o saldo sempre ir√° considerar um valor j√° consolidado, pois publica√ß√µes recentes ainda podem estar recebendo qualifica√ß√µes.
- No momento da exclus√£o do conte√∫do √© consultada a tabela com o balan√ßo de opera√ß√µes para saber qual foi o valor ganho no momento dessa publica√ß√£o espec√≠fica e calcular o valor a ser debitado devido √† exclus√£o.
- Cria a fun√ß√£o `orchestrator.createPrestige` para auxiliar nos testes da funcionalidade.
- Adequa os testes existentes e cria os novos testes necess√°rios.
  772622f20868c13b6c6c60890f515422fc5d9cab

- Apenas corrige um nome de teste que estava duplicado
  d0b8d00ba34af1bdba40e542f88eff08c8f3874b

- Bloqueia a possibilidade de altera√ß√£o do `parent_id` e adequa os testes.
  d66a049d7ab48c459056161c473beca9af90c58c

- Bloqueia a possibilidade de altera√ß√£o do status de conte√∫do de `published` para `draft` e adequa os testes.
  9e13135c097dccca0d564ba07cc3560b75b05152

- Faz a consulta do hist√≥rico das publica√ß√µes do usu√°rio ocorrer dentro da mesma transa√ß√£o de publica√ß√£o do conte√∫do.

### Issues relacionadas

- #1169
- #1339
- #1364
  </pull_1366_Analisa publica√ß√µes anteriores do mesmo usu√°rio ao publicar novo conte√∫do ou coment√°rio>

<pull_1372_fix(x-vercel-id): get the header correctly>
resolve #1369
</pull_1372_fix(x-vercel-id): get the header correctly>

<pull_1374_Adiciona estrat√©gia de cache SWR a todos conte√∫dos p√∫blicos (API e Web)>
Adota a mesma estrat√©gia de cache para todo conte√∫do p√∫blico do sistema.
Toda requisi√ß√£o que possuir cache ser√° atendida por esse cache, mesmo que obsoleto. E essa requisi√ß√£o dispara a revalida√ß√£o do cache em segundo plano caso ele esteja obsoleto.
No lado do client web foram criadas estrat√©gias para sempre obter os dados mais recentes poss√≠veis. N√£o ser√° mais necess√°rio usar a tecla F5 para garantir dados mais atualizados, pois tudo √© feito de forma autom√°tica em segundo plano.

## API

Para os endpoints da API a mudan√ßa √© bem simples e s√£o s√≥ duas altera√ß√µes nas requisi√ß√µes GET p√∫blicas:

1. Foram substitu√≠dos os dados do usu√°rio por dados an√¥nimos (para n√£o armazenar dados privados em cache);
2. Foi adicionado o cabe√ßalho de controle de cache `stale-while-revalidate` .
   Endpoints com cache:

```
/api/v1/contents
/api/v1/contents/[username]
/api/v1/contents/[username]/[slug]
/api/v1/contents/[username]/[slug]/children
/api/v1/contents/[username]/[slug]/parent
/api/v1/contents/[username]/[slug]/root
/api/v1/contents/[username]/[slug]/thumbnail
/api/v1/users/[username]
```

Sendo que o `/contents` j√° possu√≠a a configura√ß√£o, mas ajustei para gerar logs em mais casos.

## P√°ginas Web

As p√°ginas que possuem conte√∫dos din√¢micos p√∫blicos j√° utilizavam a estrat√©gia SWR. Mas essa estrat√©gia implica em receber dados desatualizados em algumas situa√ß√µes, como ao acessar p√°ginas que n√£o recebem muitas visitas, onde o cache acaba ficando mais antigo.
Para contornar isso, assim que as p√°ginas de conte√∫dos eram carregadas, ocorria uma chamada para a API para buscar os dados mais atualizados.
S√≥ que agora utilizando a mesma estrat√©gia de cache na API, n√£o √© simples garantir que a API sempre esteja mais atualizada que as p√°ginas est√°ticas, ent√£o poderia ocorrer de uma p√°gina ser carregada com dados recentes e logo em seguida ficar com dados um pouco defasados vindos da API.
Uma estrat√©gia para evitar isso seria mantermos um identificador de quando o cache foi gerado para poder comparar entre os dois dados e utilizar o mais atual. Mas isso s√≥ garante o uso de dados mais atualizados entre esses dois, mas n√£o evita dados desatualizados, pois os dois podem j√° estar obsoletos.
A solu√ß√£o adotada foi n√£o utilizar a API para obter dados atualizados, mas sim computar dados de quando o cache foi gerado para estimar tempos de revalida√ß√£o e, quando necess√°rio, fazer uma nova requisi√ß√£o de dados est√°ticos ap√≥s aguardar a revalida√ß√£o em segundo plano.
Para isso foi utilizada a biblioteca `next-swr` que eu criei para facilitar a ado√ß√£o dessa estrat√©gia. Ela possui funcionalidades similares a biblioteca SWR da Vercel, mas sem utilizar a API. No TabNews est√£o habilitadas as seguintes:

- Fun√ß√£o `getStaticProps` customizada que envia dados extras sobre a √∫ltima revalida√ß√£o de cada p√°gina.
- Hook `useRevalidate` que utiliza esses dados para, em segundo plano, fazer novas requisi√ß√µes quando necess√°rio:

1. Caso os dados est√°ticos estejam obsoletos, faz uma requisi√ß√£o para for√ßar a revalida√ß√£o (o Next.js j√° faz isso automaticamente com uma requisi√ß√£o HEAD, mas essa n√£o propaga a revalida√ß√£o na borda da Vercel);
2. Caso essa nova requisi√ß√£o j√° receba dados atualizados, o processo acaba aqui;
3. Com dados sobre a √∫ltima revalida√ß√£o, aguarda o tempo necess√°rio para uma nova revalida√ß√£o e obtem os dados mais atualizados;
4. Caso as lambdas estejam congeladas o tempo para revalida√ß√£o ser√° um pouco maior, ent√£o uma √∫ltima tentativa de revalida√ß√£o √© realizada ap√≥s um novo tempo;
5. O hook tamb√©m revalida os dados quando retornamos para a guia do navegador deixada aberta;
6. Tamb√©m existe a possibilidade de revalida√ß√£o dos dados em intervalo de tempo fixo, mas isso s√≥ foi habilitado na p√°gina de status;
   Sobre a p√°gina de status, ela era uma p√°gina est√°tica com os dados din√¢micos obtidos apenas pelo client. Agora parte dos dados s√£o obtidos coma a fun√ß√£o `getStaticProps` no lado do servidor. Como ela fazia requisi√ß√µes para a API em diferentes intervalos, os dados atualizados com mais frequ√™ncia continuam utilizando a API, j√° os demais dados agora s√£o atualizados com o `refreshInterval` da `next-swr`.
   J√° a estrat√©gia de revalida√ß√£o em segundo plano ao carregar a p√°gina e ao voltar na aba foi aplicada para todos os conte√∫dos p√∫blicos, n√£o apenas os que j√° faziam isso via API, ent√£o agora √© esperado que tenhamos dados mais atualizados em todas as p√°ginas.

## Detalhes extras sobre o PR

Uma vantagem extra da biblioteca ao usar dados sobre as revalida√ß√µes anteriores √© que em momentos de uso mais elevado do bando de dados em que o intervalo de revalida√ß√£o estiver demorando mais, o tempo entre as revalida√ß√µes deve aumentar proporcionalmente, dando um refresco ao banco nesses casos.
Como pode haver uma diferen√ßa de hor√°rio entre cliente e servidor, a biblioteca fornece um middleware que pode ser utilizado para a sincroniza√ß√£o dos rel√≥gios. Como no TabNews n√≥s j√° utilizamos o middleware, ent√£o foi s√≥ um "if" a mais no fluxo para fornecer essa sincroniza√ß√£o e n√£o precisamos da fun√ß√£o fornecida pela biblioteca. Essa requisi√ß√£o de sincroniza√ß√£o s√≥ ocorre uma vez por sess√£o do navegador.
Foi criado o model analytics para reunir o c√≥digo que agora √© utilizado tanto pela API como pela gera√ß√£o da p√°gina est√°tica
O `swr` da Vercel agora s√≥ est√° sendo utilizado para obter os dados do endpoint `/api/v1/status`.
Fiz ajustes na barra de progresso que mostra as navega√ß√µes SPA, pois ela iria ficar mostrando as revalida√ß√µes em segundo plano. Ent√£o ela continua funcionando, mas apenas quando ocorre altera√ß√£o no `router.asPath`. Aproveitei que mexi nesse componente para j√° arrumar o CSS para o mesmo padr√£o do restante do c√≥digo. Ele ficava com um destaque bem esquisito no c√≥digo fonte das p√°ginas.

## Resultados esperados

- Respostas mais r√°pidas da API por utilizar cache;
- Dados sempre atuais na vers√£o Web;

## Observa√ß√£o final

A biblioteca `next-swr` acabou de ser criada e podem existir bugs desconhecidos.
</pull_1374_Adiciona estrat√©gia de cache SWR a todos conte√∫dos p√∫blicos (API e Web)>

<pull_1379_feat(canonical url): add canonical tag to login page>
70% das p√°ginas que o Google nos mostra no Console de Pesquisa como n√£o indexadas s√£o por falta da URL can√¥nica.
S√£o mais de 37 mil p√°ginas nessa condi√ß√£o e eu imagino que a maioria seja de p√°ginas de coment√°rios, que o Google percebe que possuiu partes em comum com a p√°gina do conte√∫do "root".
S√≥ que n√£o temos como ver quais s√£o as 37 mil, pois ele s√≥ mostra as primeiras 1000, e 997 s√£o s√≥ da p√°gina de login com o par√¢metro de redirecionamento para alguma outra p√°gina do TabNews. Isso quer dizer que o rob√¥ n√£o est√° entendendo que √© a mesma p√°gina de login porque cada uma tem um par√¢metro diferente, por exemplo:
https://www.tabnews.com.br/login?redirect=/
Para mostrar para o Google que, independentemente do par√¢metro, ele sempre deve considerar que o endere√ßo da p√°gina √© o mesmo, estou adicionando a tag de URL can√¥nica com o endere√ßo:
https://www.tabnews.com.br/login
Com isso poderemos aguardar os rob√¥s fazerem novas varreduras e lidar com o que ainda estiver sendo acusado.
O pr√≥ximo item que deveremos lidar s√£o os cerca de 20% em que a maioria s√£o endere√ßos dos conte√∫dos, mas acessados via API. Ser√° que √© interessante colocarmos o cabe√ßalho can√¥nico nas respostas da API?
`Link: <https://www.tabnews.com.br/${username}/${slug}>; rel="canonical"`
O que acham?
Refer√™ncia: https://developers.google.com/search/docs/crawling-indexing/consolidate-duplicate-urls
</pull_1379_feat(canonical url): add canonical tag to login page>

<pull_1385_fix(tabcoins cache): use latest API data>
Resolve #1383 ao comparar se o dado que est√° vindo do servidor (via revalida√ß√£o) √© mais novo ou mais antigo do que o recebido pela API na hora da qualifica√ß√£o de um conte√∫do. A interface vai manter vis√≠vel o dado mais recente entre os dois.
Mas ao navegar entre p√°ginas ou dar refresh, como o estado da p√°gina √© perdido, o dado em cache ser√° o √∫nico vis√≠vel, e apenas ap√≥s nova revalida√ß√£o √© que o dado mais atual ser√° mostrado novamente.
A vers√£o do `next-swr` utilizada tamb√©m est√° com uma redu√ß√£o em 25% no tempo que √© aguardado para revalida√ß√£o. Esse tempo deve ser suficiente para a maioria das revalida√ß√µes, mas quando as lambdas estiverem congeladas ele n√£o vai ser suficiente, ent√£o uma nova tentativa de revalidar ir√° ocorrer pouco depois.
</pull_1385_fix(tabcoins cache): use latest API data>

<pull_1387_fix(redirect after login): do not return to registration or login page>
Resolve #1386
Ap√≥s o login o usu√°rio √© redirecionado para a p√°gina em que estava antes, mas isso n√£o vai mais ocorrer se a p√°gina anterior for o pr√≥prio login ou p√°ginas relacionadas ao cadastro de novos usu√°rios. Nesses casos o redirecionamento ser√° para a p√°gina inicial.
</pull_1387_fix(redirect after login): do not return to registration or login page>

<pull_1389_fix(tabcoins state): force reset state on content change>
Usa o saldo de TabCoins mais recente entre cache e API, mas reinicia o estado quando se navega entre diferentes conte√∫dos.
Isso deve resolver boa parte dos problemas reportados pelo @maniero na issue #1383, sobrando apenas o que for caracter√≠stico de cache.
</pull_1389_fix(tabcoins state): force reset state on content change>

<pull_1390_Recentes dentro de relevantes s√≥ mostrar no m√°ximo um conte√∫do por usu√°rio>
Dentre as diferentes classifica√ß√µes de conte√∫dos nas distintas faixas dos relevantes existe uma pequena janela que mostra os √∫ltimos 5 conte√∫dos postados que n√£o possuem votos negativos.
Esse PR adiciona mais uma restri√ß√£o que √© a de n√£o mostrar mais de um conte√∫do do mesmo usu√°rio.
</pull_1390_Recentes dentro de relevantes s√≥ mostrar no m√°ximo um conte√∫do por usu√°rio>

<pull_1391_Atualiza todas as depend√™ncias poss√≠veis>
S√≥ n√£o foram atualizadas as depend√™ncias:

- Next.js: Por causa de um [bug](https://github.com/vercel/next.js/issues/48302) que provavelmente ser√° corrigido no [PR 48723](https://github.com/vercel/next.js/pull/48723).
- kill-port: Por causa de um [bug](https://github.com/tiaanduplessis/kill-port/issues/61) sem previs√£o de solu√ß√£o.
  </pull_1391_Atualiza todas as depend√™ncias poss√≠veis>

<pull_1394_fix(largest contentful paint): fix LCP metric on mobile devices>
Nos √∫ltimos dias o Search Console do Google come√ßou a mostrar uma degrada√ß√£o na m√©trica LCP em dispositivos m√≥veis.
O desempenho em dispositivos reais n√£o est√° ruim, mas a maneira como a ferramenta funciona e como considera o desempenho tamb√©m em dispositivos bem fracos, precisamos corrigir melhorar a m√©trica.
Esse PR otimiza o c√≥digo respons√°vel pela mudan√ßa do tema no primeiro carregamento da p√°gina, onde agora o tema claro √© muito mais perform√°tico sem mudar a performance do tema dark. Daria pra ser o inverso, mas o tema claro √© o default no TabNews, ent√£o √© melhor que ele seja o mais r√°pido, pois a ferramenta utilizada pelo Google para medir o desempenho do site ir√° sempre utilizar o modo padr√£o.
Os resultados melhoraram bastante no ambiente de homologa√ß√£o.

## Antes

## Depois

</pull_1394_fix(largest contentful paint): fix LCP metric on mobile devices>

<pull_1395_feat(session): only renew on `/user`>
Faz a renova√ß√£o da sess√£o do usu√°rio ocorrer apenas no endpoint `/user` conforme a issue #1375.
Outra mudan√ßa √© que a renova√ß√£o vai ocorrer apenas se faltar menos do que 3 semanas para o token expirar.
Por fim, o m√©todo `GET` do endpoint `/sessions` foi removido, mas ele tinha uma certa utilidade nos testes, pois era a √∫nica maneira de obter mais dados sobre o token.
Esses dados realmente n√£o deveriam existir fora do backend, ent√£o estou pensando qual das alternativas usar para confirmar o teste de renova√ß√£o do token.
</pull_1395_feat(session): only renew on `/user`>

<pull_1396_Controlar quando ser√° calculado os saldos ao retornar os dados do usu√°rio>
Essa √© a implementa√ß√£o da issue #1168. Ela foi realizada pelo @filipedeschamps primeiramente no reposit√≥rio do curso.
Estou apenas trazendo o commit dele aqui para o TabNews com os devidos ajustes.
</pull_1396_Controlar quando ser√° calculado os saldos ao retornar os dados do usu√°rio>

<pull_1400_Melhora a performance das consultas de conte√∫dos>
Foram realizadas diversas pequenas otimiza√ß√µes nas consultas dentro do model contents.
A maioria deve ser dif√≠cil de mensurar, pois s√≥ foram eliminados alguns passos desnecess√°rios, mas que devem ter impacto na casa dos micro segundos. Por isso quis fazer essas modifica√ß√µes antes da cria√ß√£o do `root_id` e da cria√ß√£o de √≠ndices, assim temos como tentar medir se houve algum impacto.
A principal mudan√ßa √© na cria√ß√£o das p√°ginas est√°ticas de conte√∫dos root, e essa √© poss√≠vel medir o impacto da mudan√ßa, pois agora s√≥ √© necess√°ria uma √∫nica ida ao banco de dados para obter todos os dados da p√°gina.
Essa consulta √© realizada dentro da fun√ß√£o `findTree()`.
Em homologa√ß√£o a cria√ß√£o de uma p√°gina chegou a levar 128ms, mas no geral est√° ficando abaixo de 1s. üéâ
</pull_1400_Melhora a performance das consultas de conte√∫dos>

<pull_1402_Corrige o username dos coment√°rios>
Al√©m disso, melhora o c√°lculo de score de ranqueamento de coment√°rios para que os mais antigos fiquem classificados por saldo de TabCoins.
</pull_1402_Corrige o username dos coment√°rios>

---

<pull*1403*[Fix] Retorna 404 em caso de erro na valida√ß√£o de username ou slug>
No PR #1400 eu modifiquei a valida√ß√£o para ocorrer por dentro do `findTree` e n√£o mais diretamente em `getStaticProps`.
S√≥ que n√£o estava sendo capturado corretamente o erro de valida√ß√£o e n√£o era retornado o erro 404. Apenas era disparado o erro, o que levava para a p√°gina de erro 500.
Apenas para conte√∫dos realmente n√£o encontrados no banco de dados o erro estava sendo capturado corretamente e direcionando para a p√°gina 404.
Agora o erro de valida√ß√£o est√° sendo capturado corretamente e a valida√ß√£o do `owner_username` ficou igual ao do `username`.
</pull*1403*[Fix] Retorna 404 em caso de erro na valida√ß√£o de username ou slug>

---

<pull_1406_Cria fun√ß√µes para definir configura√ß√µes de cache para endpoints/m√©todos da API>
Agora temos as fun√ß√µes `noCache` e `swrMaxAge(maxAge)` que devem ser chamadas em todos os endpoints da API. Assim definimos explicitamente onde queremos e onde n√£o queremos armazenar cache.
J√° adicionei as fun√ß√µes em quase todos os endpoints e n√£o foi necess√°ria nenhuma modifica√ß√£o em testes. Os √∫nicos endpoints em que n√£o defini o funcionamento do cache foram os que est√£o dentro de `/_responses`, pois, por serem acessados via redirecionamentos tempor√°rios, acho que pode haver algum conflito se enviarmos cabe√ßalhos de controle de cache ali.
As duas fun√ß√µes utilizam uma mesma fun√ß√£o interna, a `setCacheControl` que modifica o funcionamento de `res.setHeader` para que dispare um erro caso os headers de controle de cache sejam definidos mais de uma vez (de maneiras diferentes) em uma mesma requisi√ß√£o.
Com isso ser√° mais f√°cil saber se algum controle de cache for modificado em um endpoint que retorna o set-cookie, pois antes de definir o cabe√ßalho set-cookie, os controles de cache j√° s√£o definidos para n√£o armazenar nenhum cache, e n√£o ser√° poss√≠vel modific√°-los na mesma requisi√ß√£o.
Mas isso n√£o elimina a necessidade de criarmos os testes citados em #1405, pois s√£o coisas complementares.
</pull_1406_Cria fun√ß√µes para definir configura√ß√µes de cache para endpoints/m√©todos da API>

<pull_1410_feat(no-unused-vars): added eslint config>
Continua o trabalho iniciado l√° atr√°s pelo @omariosouto no PR #404. Trabalho esse que recentemente foi continuado pelo @issdomingoss no PR #1337, e que recebeu muita ajuda do @Rafatcb, restando apenas ajustes finais.
O @Rafatcb tamb√©m participou do PR original, junto com uma galera massa! ü§©
Como o √∫ltimo PR ficou parado quase dois meses sem os ajustes finais, e muita coisa j√° tinha mudado de l√° para c√°, resolvi terminar logo essa tarefa que vai deixar o c√≥digo um pouco mais organizado.

> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aqui n√£o tem rela√ß√£o direta com o lint, mas tem rela√ß√£o com organiza√ß√£o do c√≥digo, pois essa revalida√ß√£o do `swr` estava redundante com a do `next-swr`
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Outro ponto de organiza√ß√£o, aqui o usu√°rio era buscado ap√≥s os conte√∫dos, mas dessa nova maneira, buscando o usu√°rio primeiro n√≥s podemos usar o user_id e fazer uma busca mais r√°pida pelos conte√∫dos. Al√©m disso, para p√°ginas de usu√°rios que n√£o est√£o cadastrados a p√°gina 404 ser√° exibida ap√≥s a consulta do usu√°rios, o que √© bem mais r√°pido do que a consulta pelos conte√∫dos
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O validador n√£o muda sem um novo deploy, ent√£o n√£o √© necess√°rio revalidar a p√°gina 404 gerada por erro de valida√ß√£o
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Com o novo algoritmo de ranqueamento esse intervalo n√£o √© mais necess√°rio
> > </pull_1410_feat(no-unused-vars): added eslint config>

<pull_1419_Implementa a estrat√©gia de caminho materializado adicionando a coluna `path` com √≠ndice ao `contents`>
A estrat√©gia de caminho materializado envolve armazenar um array com os IDs de todos os ancestrais do conte√∫do. Isso permite consultar a √°rvore de coment√°rios abaixo de qualquer conte√∫do, filtrando apenas os conte√∫dos que possuem o ID do conte√∫do desejado na coluna `path`.
Essa estrat√©gia elimina as consultas recursivas para obter as √°rvores de coment√°rios dos conte√∫dos, resolvendo a issue #1169. Al√©m disso, o uso do √≠ndice GIN na coluna `path` deve melhorar ainda mais o desempenho dessas consultas.
Esse PR assume que o `parent_id` n√£o pode ser alterado. O bloqueio dessa altera√ß√£o j√° foi realizado anteriormente (d0b8d00ba34af1bdba40e542f88eff08c8f3874b), mas nesse PR foi realizada uma refatora√ß√£o e remo√ß√£o de testes relacionados que n√£o s√£o mais necess√°rios.
No commit 7ca271ed356b33ad9900df961e1a93fda97bb71d foram adicionados alguns logs para monitorarmos a performance das altera√ß√µes.
Ap√≥s rodar a migration, devemos executar a seguinte query para popular a coluna `path`:

````sql
WITH RECURSIVE cte AS (
  SELECT id, parent_id, ARRAY[]::uuid[] AS path
  FROM contents
  WHERE parent_id IS NULL
  UNION ALL
  SELECT c.id, c.parent_id, cte.path || cte.id
  FROM contents c
  JOIN cte ON cte.id = c.parent_id
)
UPDATE contents c
SET path = cte.path
FROM cte
WHERE c.id = cte.id;
>> Review de aprendendofelipe (COMMENTED):
>> Review de filipedeschamps (COMMENTED):
>> Coment√°rio de aprendendofelipe (linha de c√≥digo):
A √∫nica modifica√ß√£o relevante nos testes √© essa. A √°rvore contar√° todos os coment√°rios publicados, mesmo que exista um coment√°rio exclu√≠do no meio.
Eu acho que vale a pena contar esse conte√∫do, e que podemos inclusive mostrar ele na p√°gina dos conte√∫dos, s√≥ mostrando onde ficava o conte√∫do que foi exclu√≠do.
Mas se acharem que ele n√£o deve ser contabilizado, ent√£o acho que devemos excluir todos os filhos quando um pai √© exclu√≠do. Algo que tamb√©m pode ser feito muito facilmente agora com a coluna `path`.
>> Coment√°rio de filipedeschamps (linha de c√≥digo):
Acho que devemos mostrar o n√∫mero total com o coment√°rio deletado, como comentado naquela outra issue ü§ù
</pull_1419_Implementa a estrat√©gia de caminho materializado adicionando a coluna `path` com √≠ndice ao `contents`>

<pull_1421_Continua√ß√£o da implementa√ß√£o do caminho materializado>
Removi do PR anterior (#1419) as modifica√ß√µes que dependiam do campo `path` j√° estar populado e trouxe para esse aqui.
Criei um roteiro do que acredito que deve ser feito para popular `path` sem chances de termos inconsist√™ncias. J√° testei essa sequ√™ncia localmente.
Em homologa√ß√£o j√° podemos executar tudo (Bora?!), mas acho melhor n√£o fazer o √∫ltimo passo por enquanto, por causa dos outros PRs com deploy em homologa√ß√£o, conforme explicado no final.

## Procedimento
1) Rodar a migration que cria a coluna path.
2) Para evitarmos inconsist√™ncias, antes de executar a query que vai popular o path, criar a fun√ß√£o a seguir, pois ela √© uma redund√¢ncia que preenche o `path` ao inserir ou atualizar um registro, assim n√£o vai haver inconsist√™ncia se algum registro for modificado por algum usu√°rio ao mesmo tempo que estamos populando o `path`.
```sql
CREATE OR REPLACE FUNCTION update_path() RETURNS trigger AS $$
BEGIN
  IF NEW.parent_id IS NOT NULL THEN
    WITH RECURSIVE cte AS (
      SELECT parent_id, ARRAY[id] AS path
      FROM contents
      WHERE id = NEW.parent_id
    UNION ALL
      SELECT c.parent_id, c.id || cte.path
      FROM contents c
      JOIN cte ON cte.parent_id = c.id
    )
    SELECT cte.path INTO NEW.path
    FROM cte
    WHERE cte.parent_id IS NULL;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
````

3. Criar o trigger que vai chamar a fun√ß√£o acima.

```sql
CREATE TRIGGER update_path_trigger
BEFORE INSERT OR UPDATE ON contents
FOR EACH ROW EXECUTE PROCEDURE update_path();
```

4. Executar a query que vai popular o `path`.

```sql
WITH RECURSIVE cte AS (
  SELECT id, parent_id, ARRAY[]::uuid[] AS path
  FROM contents
  WHERE parent_id IS NULL
  UNION ALL
  SELECT c.id, c.parent_id, cte.path || cte.id
  FROM contents c
  JOIN cte ON cte.id = c.parent_id
)
UPDATE contents c
SET path = cte.path
FROM cte
WHERE c.id = cte.id;
```

5. Conferir se a query funcionou corretamente (deve retornar 0).

```sql
SELECT COUNT(*) AS count
FROM contents
WHERE parent_id IS NOT NULL
AND path = ARRAY[]::uuid[];
```

6. Talvez fazer essa confer√™ncia mais pesada. Vamos ver primeiro como ela se comporta com o banco de homologa√ß√£o para decidir se rodamos em produ√ß√£o.

```sql
SELECT COUNT(*) AS count
FROM contents
WHERE (
  parent_id IS NOT NULL AND (
    array_length(path, 1) < 1 OR
    path[array_length(path, 1)] <> parent_id
  )
) OR (
  parent_id IS NULL AND path <> ARRAY[]::uuid[]
);
```

7. Modificar a fun√ß√£o chamada pelo trigger para uma mais simples, que s√≥ pode funcionar agora que `path` j√° est√° corretamente preenchido em todos os conte√∫dos. Em produ√ß√£o imagino que todos os passos ser√£o dados em sequ√™ncia, ent√£o podemos pular essa etapa 7, j√° que ela s√≥ √© necess√°ria para melhorar a performance das inser√ß√µes enquanto n√£o fizermos o deploy final da modifica√ß√£o (esse PR aqui).

```sql
CREATE OR REPLACE FUNCTION update_path() RETURNS TRIGGER AS $$
BEGIN
  IF NEW.parent_id IS NOT NULL AND NEW.path = ARRAY[]::uuid[]
  THEN
    NEW.path := (
      SELECT c.path FROM contents c WHERE c.id = NEW.parent_id
    ) || NEW.parent_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

8. Fazer o deploy desse PR, eliminando assim a necessidade do trigger e da fun√ß√£o.
9. Remover o trigger e a fun√ß√£o em produ√ß√£o. Obs. Em homologa√ß√£o considere manter o trigger por enquanto, conforme explica√ß√µes abaixo.

```sql
DROP TRIGGER IF EXISTS update_path_trigger ON contents;
DROP FUNCTION IF EXISTS update_path();
```

FIM üöÄ
Em homologa√ß√£o precisamos manter o trigger como redund√¢ncia por um tempo, pois sen√£o conte√∫dos criados por outras branchs n√£o ter√£o o `path` preenchido corretamente.
Mantendo o trigger no banco de homologa√ß√£o, caso queira garantir e testar o comportamento das inser√ß√µes sem o trigger antes de enviar para produ√ß√£o, podemos usar um outro banco de homologa√ß√£o provis√≥rio, como do Supabase, Neon etc.
Outra op√ß√£o √© removermos todos os deploys ativos em homologa√ß√£o, j√° que de qualquer forma os PRs deles precisar√£o ser atualizados.
Eu n√£o acho que seja essencial testar sem o trigger em homologa√ß√£o, j√° que os testes de integra√ß√£o executados localmente, e tamb√©m no CI do PR #1419 enquanto as modifica√ß√µes daqui ainda estavam l√°, mostraram que o trigger n√£o √© necess√°rio.
</pull_1421_Continua√ß√£o da implementa√ß√£o do caminho materializado>

<pull_1425_Nova lib para gera√ß√£o das thumbnails>
Resolve https://github.com/filipedeschamps/tabnews.com.br/issues/782
Continua implementa√ß√£o do PR https://github.com/filipedeschamps/tabnews.com.br/pull/818

> > Review de aprendendofelipe (COMMENTED):
> > Boa @ErickCReis, obrigado por atualizar o PR! üí™
> > N√£o vamos ter a grande vantagem da biblioteca da Vercel porque n√£o conseguimos acessar nosso banco de dados da Edge, certo? Ent√£o sabe dizer que outras vantagens teremos com essa mudan√ßa? E teremos alguma desvantagem?
> > Os problemas do PR #559 est√£o sendo corrigidos?
> > Fiz tamb√©m alguns coment√°rios no c√≥digo üëç
> > Review de ErickCReis (COMMENTED):
> > Review de ErickCReis (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se n√£o forem muitos pontos problem√°ticos, √© melhor desativar apenas na linha em quest√£o, pois assim ficam mais claras as decis√µes de ignorar o lint.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Provavelmente a maioria dos conte√∫dos compartilhados em redes sociais s√£o "root", ent√£o compensa verificar se existe `parent_id` antes de fazer essa consulta.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se n√£o me engano, existem dimens√µes que funcionam melhor do que outras em algumas redes, mas n√£o sei quais s√£o os valores. A mudan√ßa leva isso em considera√ß√£o? Eu tamb√©m n√£o sei se os valores anteriores consideravam o que era melhor para alguma rede espec√≠fica.
> > Obs. Sei que a Vercel recomenda usar 1200x630, mas ser√° legal se der para saber o motivo.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Fixar a vers√£o
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Desativar apenas na linha foi minha primeira tentativa mas como √© um trecho de jsx a √∫nica solu√ß√£o que encontrei foi:

```jsx
{// eslint-disable-next-line jsx-a11y/alt-text, @next/next/no-img-element
```

Al√©m de ficar muito estranho, se usar a formata√ß√£o do Prettier esse trecho √© alterado e o coment√°rio n√£o funciona:

```jsx
{
  // eslint-disable-next-line jsx-a11y/alt-text, @next/next/no-img-element
}
```

> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Procurei um pouco a respeito disso e n√£o achei muita informa√ß√£o, o √∫nico consenso foi a propor√ß√£o da imagem ser `1.91:1`.
> > Esse novo valor (1200x630) √© aparentemente o m√≠nimo recomendado por todos os sites que busquei, **_acho_** que faz sentido utilizar o valor m√≠nimo porque o conte√∫do ainda √© exibido sem nenhum problema e a imagem √© mais "leve".
> > </pull_1425_Nova lib para gera√ß√£o das thumbnails>

<pull_1426_Ranqueamento de relevantes considerando tamb√©m a contagem de coment√°rios>
Agora com a estrat√©gia de caminho materializado podemos contar os filhos de qualquer conte√∫do de maneira mais perform√°tica. Isso nos possibilita usar essa contagem no ranqueamento de relevantes.
Esse PR faz os seguintes ajustes no ranqueamento:

1. Calcula um score que √© a soma do n√∫mero de coment√°rios de diferentes usu√°rios mais duas vezes o saldo de tabcoins (coment√°rios do pr√≥prio autor ou coment√°rios diferentes de um mesmo usu√°rio s√£o desconsiderados);
2. Usa esse score para o ranqueamento ao inv√©s de somente o saldo de tabcoins;
3. S√≥ mudei o limiar de score do grupo 5 (de 2 para 4). Os demais permanecem iguais, ent√£o essas faixas ser√£o alcan√ßadas mais facilmente pelos conte√∫dos com votos positivos e coment√°rios.
4. Corrige o teste de classifica√ß√£o de relevantes para considerar tamb√©m o n√∫mero de coment√°rios.
5. Corrige a faixa de mais recentes (`group_3`), onde ao classificar por `owner_id` para excluir os duplicados, nem sempre estavam sendo retornados os mais recentes. Agora primeiro s√£o exclu√≠dos os duplicados do mesmo usu√°rios, e s√≥ depois s√£o classificados por data para garantir o retorno dos mais recentes.
   Obs. Conte√∫dos negativados continuam sendo exclu√≠dos dos relevantes, mesmo que tenham muitos coment√°rios.
   No link abaixo est√° uma vers√£o modificada desse PR, onde podemos estressar mais o banco de homologa√ß√£o, pois n√£o est√° limitando os relevantes aos conte√∫dos da √∫ltima semana. Assim para montar cada p√°gina de relevantes estamos calculando o score de todos os conte√∫dos root j√° publicados em homologa√ß√£o para mostrar a viabilidade dessa nova forma de classifica√ß√£o.
   https://tabnews-nsma31o82-tabnews.vercel.app
   J√° o link abaixo √© a vers√£o oficial do PR, onde s√≥ s√£o classificados os conte√∫dos da √∫ltima semana:
   https://tabnews-bfnm0wmgp-tabnews.vercel.app/
   O que acham da ideia de considerar o n√∫mero de coment√°rios na classifica√ß√£o? E o peso que dei, onde uma qualifica√ß√£o positiva vale o dobro do que um coment√°rio?
   > > Review de Diegiwg (APPROVED):
   > > </pull_1426_Ranqueamento de relevantes considerando tamb√©m a contagem de coment√°rios>

<pull_1427_refactor(authorization): use early return on can method>
Uma sugest√£o de refatora√ß√£o para o m√©todo `can` que verifica se o usu√°rio possui determinada feature, em casos de edi√ß√£o de usu√°rio al√©m de validar se o usu√°rio possui essa feature tamb√©m valida se o usu√°rio que est√° editando √© o mesmo que est√° sendo editado, e em casos de edi√ß√£o de conte√∫do valida se o usu√°rio √© o dono do conte√∫do ou se possui a feature de editar conte√∫do de terceiros. Rodei os testes antes e depois das altera√ß√µes, todos os testes continuaram passando.
O objetivo da refatora√ß√£o √© ajudar na legibilidade do c√≥digo, foi umas das primeiras fun√ß√µes que parei para estudar no c√≥digo e levei um tempinho para entender.
Edit: um amigo sugeriu algumas altera√ß√µes que inclui no commit [b203ac3](https://github.com/filipedeschamps/tabnews.com.br/pull/1427/commits/b203ac325f40851919ff636af645bfdcd5f0b69b), melhorei os nomes da vari√°veis, inclui um early return caso a fun√ß√£o `can` n√£o receba o argumento resource, e tamb√©m inclui a valida√ß√£o se o usu√°rio possui a feature de atualizar o conte√∫do

> > Review de aprendendofelipe (COMMENTED):
> > Boa @JoandersonPaiva, obrigado pelo PR! üí™
> > Realmente essa fun√ß√£o n√£o est√° simples de analisar qual ser√° o retorno em qualquer caso.
> > E sua sugest√£o de usar _early return_ parece ser uma √≥tima ideia para facilitar esse entendimento. üëç
> > Nessa linha, acha que a op√ß√£o abaixo fica mais f√°cil de entender?

````js
function can(user, feature, resource) {
  validateUser(user);
  validateFeature(feature);
  if (!user.features.includes(feature)) return false;
  if (!resource) return true;
  if (feature === 'update:user') return user.id === resource.id
  if (feature === 'update:content') {
    return user.id === resource.owner_id || user.features.includes('update:content:others')
  }
  return true;
}
>> Review de aprendendofelipe (CHANGES_REQUESTED):
@JoandersonPaiva, por favor, veja os dois novos coment√°rios.
O padr√£o do retorno ser `true` nessa fun√ß√£o n√£o estava legal, ent√£o fiz outra sugest√£o em que o padr√£o passa a ser `false`.
>> Review de JoandersonPaiva (COMMENTED):
>> Review de JoandersonPaiva (COMMENTED):
>> Review de aprendendofelipe (APPROVED):
>> Coment√°rio de aprendendofelipe (linha de c√≥digo):
```suggestion
  if (!user.features.includes(feature)) return false;
````

N√£o precisa do encadeamento opcional, pois isso j√° √© coberto pela fun√ß√£o `validateUser`

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Esse retorno `true` como padr√£o estava me incomodando, ent√£o criei essa nova vers√£o:

````js
function can(user, feature, resource) {
  validateUser(user);
  validateFeature(feature);
  if (!user.features.includes(feature)) return false;
  if (!resource) return true;
  switch (feature) {
    case 'update:user':
      return user.id === resource.id;
    case 'update:content':
      return user.id === resource.owner_id || user.features.includes('update:content:others');
    case 'create:content:text_root':
    case 'create:content:text_child':
      return true;
  }
  return false;
}
>> Coment√°rio de JoandersonPaiva (linha de c√≥digo):
show, faz sentido! removido üöÄ
>> Coment√°rio de JoandersonPaiva (linha de c√≥digo):
show! apliquei as sugest√µes! fiz uma micro mudan√ßa que comentei na thread üöÄ
</pull_1427_refactor(authorization): use early return on can method>

<pull_1429_fix: fix email suggestion>
Ol√° @aprendendofelipe, esse PR traz algumas corre√ß√µes para a sugest√£o de e-mail.
No componente de cadastro a sugest√£o de e-mail n√£o estava renderizando por que est√°vamos tentando renderizar dois components de valida√ß√£o ao mesmo tempo, impedindo a sugest√£o ser renderizada para o usu√°rio, a solu√ß√£o foi incluir uma valida√ß√£o se o objeto de erro possu√≠a o campo mensagem, assim nessa renderiza√ß√£o condicional s√≥ mostramos quando retornar um erro da `api` n√£o tendo conflito com a outra renderiza√ß√£o que est√° ligada com o que ocorre no frontend.
A segunda corre√ß√£o fiz no componente do perfil, onde est√°vamos tentando manipular o `passwordRef` sendo que n√£o possu√≠amos essa vari√°vel nesse componente.
Aproveitando que j√° estava com a m√£o na massa ataquei aquele `TODO` para a fun√ß√£o `suggestEmail`, como essa fun√ß√£o se repetia nos dois componentes que mexi, trouxe ela para um outro ponto onde pudesse reaproveitar ela para os dois componentes, levei um tempo pensado onde poderia colocar ela, acabei trazendo ela para uma pasta `utils` na raiz do projeto, acha uma boa? ah tamb√©m aproveitei e refatorei a fun√ß√£o de sugest√£o de e-mail mudando  a vari√°vel `domain` de uma matriz para um objeto.
Abra√ßos! ü§ù
>> Review de aprendendofelipe (COMMENTED):
Boa @JoandersonPaiva, obrigado pelo PR! üí™
> levei um tempo pensado onde poderia colocar ela, acabei trazendo ela para uma pasta `utils` na raiz do projeto, acha uma boa?
Como √© uma fun√ß√£o do frontend, e pela estrutura de pastas atual, deve ser melhor colocar dentro de `pages>interface`. Talvez adicionar essa pasta `utils` ali e usar o `index.js` que j√° existe para exportar a fun√ß√£o.
> refatorei a fun√ß√£o de sugest√£o de e-mail mudando a vari√°vel `domain` de uma matriz para um objeto.
Show! Veja o que acha dos coment√°rios que fiz no c√≥digo üëç
>> Coment√°rio de aprendendofelipe (linha de c√≥digo):
```suggestion
````

Como o @Rafatcb apontou nesse coment√°rio (https://github.com/filipedeschamps/tabnews.com.br/pull/1113#discussion_r1044337241), essa linha est√° duplicada.
J√° que criou esse novo objeto, poderia aproveitar para deixar os itens em ordem alfab√©tica, o que facilita as manuten√ß√µes. üëç

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > A defini√ß√£o dessa constante poderia sair de dentro da fun√ß√£o
> > </pull_1429_fix: fix email suggestion>

<pull_1431_Corrige o bug causado por conte√∫do √≥rf√£o assumindo lugar do conte√∫do root>
Resolve #1430
</pull_1431_Corrige o bug causado por conte√∫do √≥rf√£o assumindo lugar do conte√∫do root>

<pull_1436_Facilita os ganhos de TabCoins para conte√∫dos Root e Child>
O limiar de 60% de conte√∫dos com votos positivos foi separado por tipo de conte√∫do e reduzido para:

- 40% para root e
- 20% para child
  Junto est√° uma pequena modifica√ß√£o que bloqueia uma das formas de cria√ß√£o de TabCoins infinitos, e que explicarei melhor ap√≥s o merge.
  </pull_1436_Facilita os ganhos de TabCoins para conte√∫dos Root e Child>

<pull_1439_Faz a ativa√ß√£o do usu√°rio ocorrer dentro de uma transa√ß√£o>
Elimina a possibilidade de uma ativa√ß√£o de usu√°rio ficar incompleta se qualquer erro ocorrer. No passado ocorreram problemas em momentos de muitos acessos ao sistema.
Elimina c√°lculo de saldos de TabCoin e TabCash que ocorriam no momento da ativa√ß√£o do usu√°rio, ao adicionar ou remover `features`. Isso conclui o que faltava na issue #1168.
Busca dados atualizados ap√≥s nuke de usu√°rio, pois saldos de TabCoin e TabCash n√£o s√£o mais retornados no momento de adicionar `features`.
Adequa os testes ao n√£o retorno do saldo de TabCoins e TabCash quando ocorre a ativa√ß√£o pelo orquestrador.
Corrige testes que estavam chamando fun√ß√µes ass√≠ncronas sem `await`.
Corrige alguns erros que s√≥ ocorriam em situa√ß√µes espec√≠ficas de refresh em modo de desenvolvimento devido a falta de contexto no `useUser`.
</pull_1439_Faz a ativa√ß√£o do usu√°rio ocorrer dentro de uma transa√ß√£o>

<pull_1440_Acelera a transi√ß√£o entre n√£o ganhar TabCoins at√© passar a ganhar 2 TabCoins por conte√∫do>
Considerando que afrouxamos as regras recentemente e n√£o tivemos nenhum problema de abuso, ent√£o vamos dar mais uma relaxada nas regras.
Esse PR facilita ainda mais atingir os limiares para ganhar TabCoins j√° no ato de publicar conte√∫dos, e acrescenta um novo patamar bem pr√≥ximo do primeiro, onde j√° se chega no ganho de 2 TabCoins. Acima disso, os ganhos ser√£o iguais ao arredondamento para cima nas m√©dias de saldos das publica√ß√µes, ent√£o os ganhos est√£o subindo em todas as faixas.

### Conte√∫dos "root"

Basta ter saldo de 3 votos positivos, ao somar os votos dos 10 √∫ltimos conte√∫dos, para habilitar a ganhar 1 TabCoin extra no ato da publica√ß√£o. Com 8 j√° passa a ganhar 2 TabCoins extras por publica√ß√£o.

### Coment√°rios

Basta ter pelo menos saldo de 1 voto positivo na soma de todas as √∫ltimas 10 publica√ß√µes para come√ßar a ganhar TabCoins. Se metade dos coment√°rios tiver pelo menos 1 voto, ent√£o j√° passa a ganhar 2 TabCoins por publica√ß√£o.
</pull_1440_Acelera a transi√ß√£o entre n√£o ganhar TabCoins at√© passar a ganhar 2 TabCoins por conte√∫do>

<pull_1441_Aumenta o limite de votos de 1 para 3 a cada 72 horas por IP e conte√∫do>
Continuando a flexibiliza√ß√£o de algumas regras, esse PR aumenta o limite de votos que podem ser dados para um conte√∫do atrav√©s do mesmo endere√ßo IP dentro de 72 horas. O limite passou de 1 para 3 votos.
Dependendo do resultado que obtivermos, poderemos reduzir novamente esse limite ou liberar ainda mais.
</pull_1441_Aumenta o limite de votos de 1 para 3 a cada 72 horas por IP e conte√∫do>

<pull_1443_Aumenta a frequ√™ncia de revalida√ß√£o da p√°gina de conte√∫dos>
Volta o valor de revalida√ß√£o de 10s para 1s, que era a configura√ß√£o de antes do lan√ßamento oficial do TabNews.
Acredito que essa modifica√ß√£o nas p√°ginas de conte√∫dos n√£o deve causar uma aumento significativo no n√∫mero de revalida√ß√µes, ent√£o pode valer a pena se trouxer alguma melhora de UX, j√° que qualquer nova qualifica√ß√£o ou edi√ß√£o de conte√∫do ser√° propagado para o cache da CDN mais rapidamente.
Um momento importante para sabermos se houve algum impacto negativo ser√° na pr√≥xima vez que houver um aumento significativo de acessos simult√¢neos, como ocorre sempre que o TabNews √© citado em algum canal de grande exposi√ß√£o, como em v√≠deos do @filipedeschamps.
Vamos monitorar ü§ù
</pull_1443_Aumenta a frequ√™ncia de revalida√ß√£o da p√°gina de conte√∫dos>

<pull_1444_Acelera um pouco mais o aumento de ganhos, mas sem precisar afrouxar os freios para usu√°rios negativados>
No PR #1440 a equa√ß√£o que calculava os ganhos de TabCoins no ato de publicar foi substitu√≠da por alguns condicionais. Isso permitiu fazer ajustes mais precisos em cada faixa sem precisar adotar uma equa√ß√£o complexa.
Ent√£o nesse PR vamos acelerar ainda mais os ganhos de quem est√° publicando conte√∫dos relevantes, e sem precisar afrouxar os freios para os usu√°rios que est√£o sendo muito negativados.
Os ganhos conforme a m√©dia (m) de saldo das √∫ltimas publica√ß√µes ficar√£o assim:
| root | coment√°rio | ganho ao publicar |
| :------------: | :------------: | :---------------------------: |
| m <= 0,4 | m <= 0,2 | precisa apagar negativados |
| 0,4 < m <= 1,1 | 0,2 < m <= 1,0 | 0 |
| 1,1 < m <= 1,4 | 1,0 < m <= 1,2 | 1 |
| 1,4 < m <= 1,6 | 1,2 < m <= 1,5 | 2 |
| 1,6 < m <= 1,8 | 1,5 < m <= 1,7 | 3 |
| 1,8 < m | 1,7 < m | m + 2 (e arredonda para cima) |
Exemplos:

- Um usu√°rio que possui metade das √∫ltimas publica√ß√µes com 1 voto positivo (saldo de 2 TabCoins), j√° pode ganhar 2 TabCoins ao publicar
- Um usu√°rio com m√©dia de 1 voto positivo por publica√ß√£o ir√° ganhar 4 TabCoins ao publicar.
- Um usu√°rio com 1 voto positivo em qualquer das √∫ltimas publica√ß√µes (e sem negativos) j√° est√° habilitado a ganhar 1 TabCoin ao publicar.
- Um usu√°rio com 8 coment√°rios negativados entre os √∫ltimos 10, precisar√° adequar as publica√ß√µes para poder continuar comentando.
  </pull_1444_Acelera um pouco mais o aumento de ganhos, mas sem precisar afrouxar os freios para usu√°rios negativados>

<pull_1445_Feat reading time on posts>
Esse pr adiciona a feature de tempo de leitura estimado a cada post ao entrar no post.
Como base, segui o que o [medium.com](url) utiliza, 260/270 wpm(words per minute) e arrendondar para cima os segundos restantes.
Artigo base do medium:
https://blog.medium.com/read-time-and-you-bc2048ab620c

> > Review de aprendendofelipe (COMMENTED):
> > Ol√° @ValbertMartins, obrigado pelo PR! üí™
> > Fiz uma sugest√£o e um coment√°rio no c√≥digo. O coment√°rio √© sobre a forma de contar as palavras. Queria saber a opini√£o da turma.
> > Outra coisa que queria saber a opini√£o √© se a gente deveria mostrar o tempo de leitura em todos os coment√°rios ou apenas na publica√ß√£o principal. O que acham?
> > Review de ValbertMartins (COMMENTED):
> > Review de H4ad (CHANGES_REQUESTED):
> > Review de H4ad (COMMENTED):
> > Review de RobertDS07 (APPROVED):
> > Bela iniciativa meu parceiro, parab√©ns.
> > Review de ValbertMartins (COMMENTED):
> > Review de ValbertMartins (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de ValbertMartins (COMMENTED):
> > Review de ValbertMartins (COMMENTED):
> > Review de ValbertMartins (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de ValbertMartins (COMMENTED):
> > Review de ValbertMartins (COMMENTED):
> > Review de ValbertMartins (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  return Math.ceil(wordsQuantity / wpm);
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Estou em d√∫vida se vale a pena fazer algo mais elaborado que remova o markdown e lide corretamente com quebras de linhas, sequ√™ncias de espa√ßos, etc.
> > Considerando que √© apenas uma aproxima√ß√£o do tempo de leitura, provavelmente n√£o vai valer a pena criar algo mais pesado, mas queria saber a opini√£o da turma
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > Ol√° @aprendendofelipe obrigado pelas sugest√µes,
> > Sobre ter tempo estimado nos coment√°rios, tamb√©m fico na d√∫vida, por um lado h√° coment√°rios muito bem elaborados que dariam outro post, j√° para coment√°rios curtos e diretos parece ficar redundante.
> > j√° a respeito de fazer algo mais elaborado para calcular essa m√©dia como no fim √© apenas uma estimativa, tamb√©m n√£o sei vale a pena, j√° que isso pode variar em diversos fatores como complexidade do post, imagens e etc, ent√£o fica bem complexo ter uma estimativa bem precisa.
> > Coment√°rio de H4ad (linha de c√≥digo):
> > N√£o sei quantas vezes isso pode renderizar, mas seria melhor salvar o `getReadTime(text)` em um `useMemo` ou apenas em uma simples vari√°vel.
> > Coment√°rio de H4ad (linha de c√≥digo):
> > Provavelmente performance n√£o seria um problema aqui mas se tu quiser deixar mais r√°pido:

- Usa a lib [alfaaz](https://github.com/thecodrr/alfaaz), 2x mais r√°pido que split
- Ou troca o `.split` por um simples for, isso consumiria menos mem√≥ria j√° que n√£o precisa alocar para dividir o texto inteiro.
  > > Coment√°rio de RobertDS07 (linha de c√≥digo):
  > > Fiquei curioso para saber o porqu√™ da declara√ß√£o da fun√ß√£o fora do escopo do componente.
  > > Seria para evitar a re-cria√ß√£o?
  > > Coment√°rio de RobertDS07 (linha de c√≥digo):
  > > Ser√° que vale deixar o wpm mut√°vel?
  > > Talvez sim, mas tentei pensar aqui no caso de uso que alterar√≠amos e n√£o encontrei, talvez tornar ele uma const, n√£o sei, o que acha?

```suggestion
const WORDS_PER_MINUTE = 260
function getReadTime(text) {
```

> > Coment√°rio de RobertDS07 (linha de c√≥digo):
> > Fiquei um pouco na d√∫vida de em qual unidade de medida iria retornar, talvez explicitar isto facilite a leitura, o que acha?

```suggestion
function getReadTimeInMinutes(text, wpm = 260) {
```

> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > @H4ad feito
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > @RobertDS07 boa, feito!
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    const wordsQuantity = text.split(/[^A-Za-z]+/).length;
```

Uma alternativa um pouco mais precisa quando houver sequ√™ncias de espa√ßos, quebras de linhas e outros caracteres diferentes de letras.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Que tal usar `{' ¬∑ '}` como separador, assim como no `contentList`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > J√° que est√° usando o `useMemo`, pode retornar a string completa j√° formatada.
> > E tamb√©m pode usar a abrevia√ß√£o "min" ao inv√©s de alternar entre "minuto" e "minutos".
> > Veja duas diferentes sugest√µes (a terceira √© a vers√£o atual):
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > feito!
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > @aprendendofelipe implementei a sugest√£o 2!
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > @aprendendofelipe aos espa√ßadores estou com um problema quanto a margem esquerda que j√° existia no componente PublishedSince, j√° que se remover esse ml do PublishedSince, dentro do contentList ele n√£o ficar√° alinhado. tem alguma sugest√£o?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Est√° ficando show de bola, @ValbertMartins! üí™
> > Se n√£o quiser ter que arrumar o `PublishedSince` e o `contentList`, ent√£o basta passar `sx={{ ml: 0}}` para o `PublishedSince` dentro do `Content`:

```js
<PublishedSince
  direction="n"
  date={contentObject.published_at}
  sx={{ ml: 0 }}
/>
```

Agora o ideal mesmo seria inverter. Retirar o `ml` de dentro do componente `PublishedSince` e passar `sx={{ ml: 1}}` ao usar o componente em `contentList`. Mas fica a seu crit√©rio. üëç
Eu s√≥ n√£o colocaria o separador entre no `username` e `ReadTime` , mas apenas entre `ReadTime` e `PublishedSince`.
E pensando mais sobre mostrar o tempo de leitura nos coment√°rios. Acho melhor n√£o mostrar por enquanto, pois vai piorar a quebra de layout que j√° ocorre em repostas em n√≠veis mais profundos, por exemplo aqui:
https://tabnews-git-fork-valbertmartins-feat-reading-tim-1db7eb-tabnews.vercel.app/Gustavo33/teste4593832181797422292334945798549354624941348715825899669
Dependendo da aceita√ß√£o da nova funcionalidade, podemos ver como fazer com os coment√°rios e, mais importante, ver como podemos mostrar o tempo de leitura no `contentList` ü§ù

> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > tive que tamb√©m trazer o position para fora do componente PublishedSince no contentList, j√° que s√≥ aplicar o ml apenas estava sobrescrevendo ficando sem o position, logo causando esse problema no tooltip
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > resolvi deixar o position tamb√©m dentro do componente, j√° que sem ele vi que o tooltip fica com alguns problemas.
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > obrigado @aprendendofelipe !
> > Fiz a remo√ß√£o do tempo de leitura dos coment√°rios e a remo√ß√£o do separador entre o username e o readTime.
> > No caso do `PublishedSince` al√©m de remover o `ml:1` de dentro do componente como sua sugest√£o, tamb√©m tive que trazer o `position:absolute ` dele quando usado no contentList.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Sim @ValbertMartins, esse `position` √© necess√°rio, pois o Tooltip do Primer ainda cont√©m bugs por estar em alpha.
> > </pull_1445_Feat reading time on posts>

<pull_1457_Remove logs tempor√°rios de performance de algumas consultas>

- c8e400d9b38a8d469930090ae4bc8bc68e5897f6 - Reverte o commit tempor√°rio https://github.com/filipedeschamps/tabnews.com.br/commit/7ca271ed356b33ad9900df961e1a93fda97bb71d
- a70b2bf0eddff49906985726d000a5b0c5219a78 - Fixa a vers√£o do `satori` no `package-lock.json`
  </pull_1457_Remove logs tempor√°rios de performance de algumas consultas>

<pull_1460_Quantidade m√≠nima de 5 palavras, cada uma com no m√≠nimo 5 letras, para poder ganhar TabCoins>
Como proposta de solu√ß√£o para a issue #1267, esse PR implementa uma verifica√ß√£o da quantidade de palavras presentes no conte√∫do que est√° sendo publicado. Se a verifica√ß√£o a seguir retornar `true`, nem o usu√°rio e nem o conte√∫do ganhar√£o TabCoins iniciais:

```js
newContent.body.split(/[a-z]{5,}/i).length < 6;
```

Al√©m de novos testes, esse PR exigiu a adequa√ß√£o de diversos dos testes j√° existentes. Seria uma boa ideia criar testes de unidade e diminuir os testes de integra√ß√£o.

---

O PR tamb√©m mostrou algumas inconsist√™ncias que ocorriam ao excluir conte√∫dos que n√£o haviam ganho TabCoins iniciais, onde o valor de primeiro voto poderia ser considerado como se fosse o ganho inicial. Ent√£o o commit 48d220f4e33582ba91ca2ab7bfc8b4deaad4f388 √© s√≥ para corrigir esse problema e criar os testes para evitar uma futura regress√£o.
</pull_1460_Quantidade m√≠nima de 5 palavras, cada uma com no m√≠nimo 5 letras, para poder ganhar TabCoins>

---

<pull*1461*[`coment√°rio` e `tabcoin`]: corrige a formata√ß√£o de `singular` ou `plural`>
Esta PR corrige o detalhe de formata√ß√£o notado pelo @cesarcanoff na issue #1458 :handshake:
Na issue, ele sugere a corre√ß√£o para a label de `coment√°rio` mas ela tamb√©m √© aplic√°vel √† label de `tabcoin` e como as fun√ß√µes que fazem essa formata√ß√£o s√£o vizinhas, aproveitei para ajustar nas duas logo:+1:
https://github.com/filipedeschamps/tabnews.com.br/blob/c0c0c346fe94c11fa2ce6e24029dd87fc7d3c63e/pages/interface/components/ContentList/index.js#L65-L71

## Preview

| `0` coment√°rio  | `1` coment√°rio  | `1` coment√°rio |
| --------------- | --------------- | -------------- |
|                 |                 |                |
| `2` coment√°rios | `2` coment√°rios |
| --------------- | --------------- |
|                 |                 |

> > Review de aprendendofelipe (COMMENTED):
> > Ol√° @kaique-soares, obrigado pela proposta! üí™
> > Veja se n√£o prefere as vers√µes que eu sugeri no c√≥digo.
> > Al√©m de fazerem a mesma coisa com menos recursos, tamb√©m acho que √© mais f√°cil de ler.
> > O que acha?
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      return count > 1 ? `${count} coment√°rios` : `${count} coment√°rio`;
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      return count > 1 || count < -1 ? `${count} tabcoins` : `${count} tabcoin`;
```

> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Acabei de subir a altera√ß√£o :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Acabei de subir a altera√ß√£o :+1:
> > </pull*1461*[`coment√°rio` e `tabcoin`]: corrige a formata√ß√£o de `singular` ou `plural`>

---

<pull*1464*[Analytics] Remover das p√°ginas '/' (home) e '/publicar'>
Mensalmente n√≥s estamos gerando eventos de analytics em quantidade acima do limite do nosso plano (500k), ent√£o esse PR busca nos manter dentro do limite, j√° que vai parar de gerar eventos da p√°gina mais acessada, que √© a "home".
Al√©m disso, tamb√©m removemos da p√°gina `/publicar`, pois ela tamb√©m aparece entre as mais acessadas.
Obs.: N√≥s temos outras formar de medir o volume de acessos √† p√°ginas espec√≠ficas, mas vamos parar de computar, como visitantes √∫nicos, os usu√°rios que visitarem exclusivamente a p√°gina inicial do TabNews sem clicar em nenhuma publica√ß√£o ou demais links internos.
</pull*1464*[Analytics] Remover das p√°ginas '/' (home) e '/publicar'>

---

<pull_1465_Novo coment√°rio pode trazer publica√ß√£o antiga para os relevantes>
Novos coment√°rios em publica√ß√µes bem qualificadas v√£o trazer essa publica√ß√£o de volta para as p√°ginas de relevantes, mesmo que a publica√ß√£o tenha ocorrido a mais de 7 dias, que √© o limite atual.
Essas publica√ß√µes mais antigas dificilmente voltar√£o para a primeira p√°gina (em casos raros podem ir para o final da primeira p√°gina), mas esse retorno pode ser interessante para usu√°rios que acessam o site com menos frequ√™ncia (ou novos usu√°rios), j√° que esses podem encontrar melhores conte√∫dos ao explorar as p√°ginas al√©m da primeira dos relevantes.
Tamb√©m √© um incentivo para continuar debates j√° existentes ao inv√©s de abrir novas publica√ß√µes sobre os mesmos assuntos.
Esse PR tamb√©m diminui um pouco o peso que foi dado aos coment√°rios na √∫ltima mudan√ßa do ranqueamento. Atualmente 2 coment√°rios tem o mesmo peso de 1 voto positivo, mas com esse PR ser√£o necess√°rios 3 coment√°rios para ter o mesmo peso de 1 voto.
</pull_1465_Novo coment√°rio pode trazer publica√ß√£o antiga para os relevantes>

<pull_1469_Continua aumentando os ganhos de Tabcoins para autores bem avaliados>
Acelera um pouco mais o crescimento dos ganhos para autores bem avaliados at√© chegar no patamar de ganhar a m√©dia das avalia√ß√µes anteriores +5 tabcoins (antes estava em m√©dia +2).
A quantidade de qualifica√ß√µes cresceu com as mudan√ßas anteriores, mas parece ter atingido um novo limite. Partimos de 1 qualifica√ß√£o para cada 4 publica√ß√µes e fomos crescendo at√© chegar em 1 para 2, onde se estabilizou.
Acredito que o ideal √© termos mais qualifica√ß√µes do que publica√ß√µes, ent√£o provavelmente ser√£o necess√°rios mais futuros aumentos, mas vamos fazendo aos poucos.
Criei testes de unidade para o model prestige, pois n√£o existe necessidade de testar todos os diferentes n√≠veis dentro dos testes de integra√ß√£o.
Para criar os testes de unidade, eu refatorei o model prestige para separar mais as responsabilidades das fun√ß√µes e poder abstrair o banco de dados. As strings das queries eu movi para a pasta `queries` na raiz do projeto, ent√£o fiz o mesmo com a query de ranqueamento.
</pull_1469_Continua aumentando os ganhos de Tabcoins para autores bem avaliados>

<pull_1470_Feat: adiciona uma descri√ß√£o ao usu√°rio>
Esse PR, adiciona um draft inicial da feature de adicionar descri√ß√£o ao usu√°rios.
Alguns pontos iniciais a se destacar
‚Ä¢ Com a sugest√£o do @filipedeschamps de ser poss√≠vel usar markdown mudei um pouco a ui para um box, por√©m isso ainda √© um esbo√ßo inicial da ui
‚Ä¢ ~~irei fixar os testes, os testes que est√£o quebrando s√£o aqueles que retornam estritamente um usu√°rioüí™~~ ‚úÖ
‚Ä¢ ~~A quantidade inicial est√° como 160 caracteres na migration, mas acredito que agora esse n√∫mero √© pouco.~~ ‚úÖ

- [ ] testes para a feature
- [ ] Mudar a caixa da descri√ß√£o para o Editor do ByteMD
      ‚Ä¢ preview perfil
      ‚Ä¢ preview caixa descri√ß√£o
  > > Review de ValbertMartins (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Fala @ValbertMartins, obrigado pelo PR! üí™
  > > Sei que voc√™ ainda vai fazer modifica√ß√µes, como adicionar testes, mas j√° fiz algumas perguntas no c√≥digo üëç
  > > Review de ValbertMartins (COMMENTED):
  > > Review de ValbertMartins (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de ValbertMartins (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Show @ValbertMartins! üí™
  > > Fiz coment√°rios/sugest√µes no c√≥digo. Por favor, veja se fazem sentido. ü§ù
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Ent√£o bora pra produ√ß√£o pra sentir a rea√ß√£o üöÄüöÄüöÄ
  > > Coment√°rio de ValbertMartins (linha de c√≥digo):
  > > Adendo, no momento se o usu√°rio tiver `description:null` e salvar edi√ß√µes mesmo sem alterar nada no perfil faz com que fa√ßa uma request com `description: ' ' `, pra mitigar esse comportamento e n√£o fazer uma requisi√ß√£o assim, pensei em adicionar alguma forma de verificar se o valor √© nulo.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Mesma coisa aqui. J√° que pode ser vazio, faz sentido essa verifica√ß√£o?

```suggestion

```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

N√£o deveria ter m√≠nimo, j√° que pode ser uma string vazia, certo?

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Por que dentro de chaves?
> > Por que dentro de `Pagehead`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Algum motivo para n√£o usar o Editor do ByteMD?
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > Fala @aprendendofelipe, sobre os outros t√≥picos como o `model description` precisa ser melhor corrigido mesmo, irei fazer as corre√ß√µes e tamb√©m remover as chaves, acho que nem notei elas aiüòÖ, obrigado pelo feedback!
> > Por que dentro de `Pagehead`? Coloquei dentro do Pagehead pra ficar com a `linha embaixo` que o `Pagehead` j√° tem por padr√£o
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > Por mais que a `descri√ß√£o` aceite markdown estou usando nesse momento o `TextArea` ao inv√©s do `Editor` por n√£o ter o cabe√ßalho mesmo e ficar mais 'discreto' na minha opini√£o, por√©m n√£o tenho problemas em mudar para o `Editor`
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que vale a pena usar o ByteMD, principalmente para poder visualizar como ficar√° a descri√ß√£o antes de salvar, e sem precisar recorrer a ferramentas externas
> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > justo!
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Coloquei dentro do Pagehead pra ficar com a `linha embaixo` que o `Pagehead` j√° tem por padr√£o
> > Melhor usar um `Box` e configurar a borda.
> > O `Pagehead` hoje √© s√≥ um `Box` com borda inferior, mas ele pode mudar, j√° que ainda est√° em alpha. Ele √© apropriado para o t√≠tulo da p√°gina, n√£o necessariamente para criar um divisor üòâ
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Textarea n√£o est√° sendo utilizado, n√©?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  const [description, setDescription] = useState(user?.description || '');
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            value={description}
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Foi removida a margem inferior, mas ela era respons√°vel por um espa√ßamento que acredito que deveria permanecer quando n√£o houver descri√ß√£o:
> > | Antes | Depois |
> > | ----- | ------ |
> > | |
> > </pull_1470_Feat: adiciona uma descri√ß√£o ao usu√°rio>

<pull_1472_Adiciona barra de pesquisa do Google ao Header>
Conforme conversado em #927, enquanto o TabNews n√£o possuir um sistema pr√≥prio, foi adicionada ao Header uma barra de pesquisa que busca pelas publica√ß√µes no Google.
A barra √© falsa, e na verdade √© um bot√£o que ir√° carregar a barra de pesquisa do Google apenas quando for clicado. Assim os scripts do Google s√≥ s√£o executados por quem usar a barra de pesquisa, e com isso dificultamos o rastreamento dos usu√°rios pelo Google.
No caso de telas menores, foi adicionado apenas um √≠cone no lugar da barra.
Do jeito que foi configurada, a pesquisa ir√° retornar tamb√©m resultados aqui do reposit√≥rio, quando for o caso. Ent√£o isso pode ser uma melhoria at√© para quem j√° costuma pesquisar diretamente pelo Google, pois poder√° pesquisar em um √∫nico lugar quando n√£o se lembrar se viu algo aqui ou no pr√≥prio TabNews (comigo acontece bastante üòÖ).
Existem diversas extens√µes para navegador (e aplica√ß√µes web) constru√≠das para fazer pesquisas no TabNews, mas est√° fora do nosso controle garantir uma boa experi√™ncia para quem estiver utilizando elas. Eu acredito que a maioria usa o Google, mas algumas s√£o mais como filtros do que sistemas de pesquisas, e filtram apenas em uma pequena parte dos dados que foi coletada do banco de dados.
Por fim, com essa barra n√≥s podemos levantar dados sobre a utiliza√ß√£o para basear decis√µes quando formos implementar um sistema de busca pr√≥prio.

> > Review de github-advanced-security[bot] (COMMENTED):
> > Review de mthmcalixto (COMMENTED):
> > adiciona para abrir links na mesma p√°gina
> > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Incomplete URL substring sanitization

'[google.com/](1)' can be anywhere in the URL, and arbitrary hosts may come before or after it.
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/36)

> > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Incomplete URL substring sanitization

'[google.com/](1)' can be anywhere in the URL, and arbitrary hosts may come before or after it.
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/37)

> > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Incomplete URL substring sanitization

'[google.com/](1)' can be anywhere in the URL, and arbitrary hosts may come before or after it.
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/38)

> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > @aprendendofelipe adicione aqui na linha 143: `data-linktarget="_self"`
> > precisa ser `return <div className="gcse-search" data-linktarget="_self"></div>;`
> > Isso vai fazer o link dos resultados abrir na mesma p√°gina.
> > </pull_1472_Adiciona barra de pesquisa do Google ao Header>

---

<pull*1475*[Barra de pesquisa] Corrige clique nas sugest√µes de pesquisa que fechava o modal>
O CSE adiciona o elemento de sugest√µes fora do `Overlay`, ent√£o o modal fechava ao clicar em qualquer sugest√£o (conforme reportado pelo @eletroswing em #1473)
Agora a refer√™ncia do bloco de sugest√µes √© adicionado na lista `ignoreClickRefs` do `Overlay`, evitando o fechamento do modal ao aceitar qualquer sugest√£o.
Aproveitei para mudar a funcionalidade para o conte√∫do escolhido abrir na mesma aba quando clicar em um dos resultados da busca, conforme sugest√£o do @mthmcalixto em #1472. üí™
</pull*1475*[Barra de pesquisa] Corrige clique nas sugest√µes de pesquisa que fechava o modal>

---

<pull_1477_Continua aumentando os ganhos de TabCoins para bons autores>
Segue aumentando os ganhos de TabCoins com foco em viabilizar o aumento no volume de qualifica√ß√µes por conte√∫do.
Os ganhos m√©dios de TabCoins por publica√ß√£o na √∫ltima semana foram:
| -- | Ao publicar | Votos + | Votos - | Saldo de votos |
| ---------- | ----------- | ------- | ------- | -------------- |
| Raiz | 1,54 | 0,78 | 0,27 | 0,51 |
| Coment√°rio | 1,29 | 0,20 | 0,06 | 0,14 |
No per√≠odo relatado ocorreram:
Publica√ß√µes raiz: 175
Pub raiz apagadas: 32
Coment√°rios: 764
Coment. apagados: 71
Qualifica√ß√µes: 388
Novos usu√°rios: 338
Aumento nos TabCoins parados: 555
</pull_1477_Continua aumentando os ganhos de TabCoins para bons autores>

<pull_1483_Corrige bugs do `useCollapse`>
Corrige o bugs do `useCollapse` que foram encontrados durante o PR #1413, o que inclui o relatado pelo @Rafatcb em https://github.com/filipedeschamps/tabnews.com.br/pull/1476#issuecomment-1645746096
Tamb√©m exclui a fun√ß√£o `flattenTree` que n√£o estava mais tendo utilidade.
</pull_1483_Corrige bugs do `useCollapse`>

<pull_1484_Remove vari√°vel que ainda n√£o √© passada por `useCollapse`>
A vari√°vel `hiddenAvailable` s√≥ ser√° necess√°ria quando for implementada a pagina√ß√£o dos coment√°rios. Por enquanto estou removendo ela para que volte a aparecer a quantidade de coment√°rios que ser√£o expandidos ao clicar no bot√£o de ver mais respostas.
Acabei copiando indevidamente essa vari√°vel ao trazer algumas altera√ß√µes do PR #1413 para o #1483
</pull_1484_Remove vari√°vel que ainda n√£o √© passada por `useCollapse`>

<pull_1489_refactor(icon imports): change icon imports to TabNewsUI/icons>
‚Ä¢ Esse pr refatora a importa√ß√£o dos icones para um s√≥ lugar, `/TabNewsUI/icons`.
‚Ä¢ a subpasta icons √© para n√£o misturar a importa√ß√£o de `componentes` e `icones` tudo dentro de `TabNewsUI`

> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > @ValbertMartins, obrigado pelo PR! üí™
> > Faltou exportar o `CommentIcon`.
> > Tamb√©m fiz algumas sugest√µes no c√≥digo üëç
> > Review de ValbertMartins (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  CommentDiscussionIcon,
  CommentIcon,
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
import { FaUser, KebabHorizontalIcon, TrashIcon } from '@/TabNewsUI/icons';
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
import { CgTab, HomeIcon, PersonFillIcon, SquareFillIcon, PlusIcon } from '@/TabNewsUI/icons';
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

> > Coment√°rio de ValbertMartins (linha de c√≥digo):
> > obrigado @aprendendofelipe üí™.
> > Deslize meu, n√£o notei que tinham componentes que faziam a exporta√ß√£o de ambos
> > fixados ‚úÖ
> > </pull_1489_refactor(icon imports): change icon imports to TabNewsUI/icons>

---

<pull*1494_feat: adiciona indica√ß√£o dos termos de uso na tela de cadastro>
Primeiro passo da implementa√ß√£o da \_issue*: https://github.com/filipedeschamps/tabnews.com.br/issues/1153.

**Antes:**

**Depois:**

> > Review de aprendendofelipe (COMMENTED):
> > Show @luizfelipemacedoc, obrigado pelo PR! üí™
> > Para aprovar, eu preciso que voc√™ edite a mensagem do commit para que ela fique em ingl√™s. Consegue fazer isso? ü§ù
> > Opcionalmente, caso queira incrementar o PR...
> > Que tal adicionar um `Checkbox` que precise ser selecionado antes de submeter o cadastro?
> > D√° para fazer isso desabilitando o bot√£o `Criar Cadastro` e s√≥ habilitando se o `Checkbox` for selecionado, mas acho que seria melhor deixar o bot√£o habilitado, mas mostrar um aviso caso ele seja clicado sem marcar que concorda com os termos.
> > Veja essa parte do c√≥digo se precisar de inspira√ß√£o:
> > https://github.com/filipedeschamps/tabnews.com.br/blob/49aadd347f6619173235c924ba44f64316e86db4/pages/perfil/index.public.js#L261
> > O que acha?
> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > Legal @luizfelipemacedoc! üí™
> > Sobre os commits, o ideal √© unific√°-los (faz um squash), mas se tiver dificuldades, pode deixar que eu fa√ßo antes de mesclar. ü§ù
> > Por favor, veja tamb√©m meus coment√°rios no c√≥digo. üëç
> > Um dos coment√°rios trata da organiza√ß√£o dos imports. @MattFerreira18, ou quem puder, que tal abrir um PR atualizado do que foi feito em #552? üí™
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  const [isTermsAccepted, setIsTermsAccepted] = useState(false);
```

Melhor usar nomes mais explicativos. N√£o necessariamente esses que sugeri.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Melhor usar o [`Checkbox` da biblioteca Primer](https://primer.style/react/Checkbox), pois mesmo ele ainda estando em vers√£o alpha, conforme a biblioteca for evoluindo, vamos ganhando as melhorias, por exemplo, de estiliza√ß√£o e acessibilidade.
> > Se tiver problemas com alinhamento, talvez o que foi feito no PR #1173 possa ajudar.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Essa mensagem precisa ser adequada, pois n√£o √© mais a cria√ß√£o do cadastro que sinaliza estar de acordo, mas sim o checkbox.
> > Deve funcionar melhor o cl√°ssico "Li e estou de acordo com os Termos de Uso".
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  Link,
  PasswordInput,
  Text,
  TextInput,
```

J√° que vai precisar mudar outras coisas no c√≥digo, vamos tentar deixar as importa√ß√µes organizadas para exigir menos mudan√ßas quando adotarmos algum plugin que fa√ßa isso automaticamente.
</pull_1494_feat: adiciona indica√ß√£o dos termos de uso na tela de cadastro>

<pull_1499_Configura√ß√µes do ESLint (importa√ß√µes, exporta√ß√µes e JSX)>
Configura o ESLint para organizar todas as importa√ß√µes do projeto.
N√£o foi necess√°rio adicionar nenhum novo plugin, mas apenas configurar os par√¢metros no `.eslintrc` e corrigir o script `lint:fix` no `package.json`, onde faltava o "ponto" (`.`) em `eslint --fix .`:

#### package.json

```diff
- "lint:fix": "eslint --fix && prettier --write .",
+ "lint:fix": "eslint --fix . && prettier --write .",
```

#### .eslintrc

```json
{
  ...
  "settings": {
    "import/resolver": {
      "node": {
        "paths": ["."]
      }
    }
  },
  "rules": {
    "import/newline-after-import": "error",
    "import/no-duplicates": "error",
    "import/no-useless-path-segments": [
      "error",
      {
        "noUselessIndex": true
      }
    ],
    "import/order": [
      "error",
      {
        "alphabetize": {
          "order": "asc",
          "caseInsensitive": true
        },
        "groups": [["builtin", "external"], "internal", ["parent", "sibling", "index"]],
        "newlines-between": "always",
        "pathGroups": [
          {
            "pattern": "@/**",
            "group": "internal"
          }
        ]
      }
    ],
    "sort-imports": [
      "error",
      {
        "allowSeparatedGroups": true,
        "ignoreCase": true,
        "ignoreDeclarationSort": true
      }
    ],
    "no-unused-vars": [
      "error",
      {
        "vars": "all",
        "args": "after-used"
      }
    ]
  }
}
```

Os crit√©rios de configura√ß√£o tiveram foco em manter a compatibilidade com a organiza√ß√£o autom√°tica feita pelo VS Code, onde apenas dois arquivos (`pages/[username]` e `TabCoinsButtons`) n√£o ficaram 100% compat√≠veis, pois possuem essas duas linhas:

```js
import { ... } from 'next/router';
import { ... } from 'next-swr';
```

Onde o ESLint deixa na ordem acima, j√° que `next` vem antes de `next-swr`, mas o VS Code leva em considera√ß√£o `next/router` com a barra sendo um caractere e n√£o um divisor, o que inverte a ordem de classifica√ß√£o.
Continuando na adequa√ß√£o do ESLint, habilitei duas regras que estavam suprimidas e j√° adequei o c√≥digo:

- (9912ab020ef7392b07245d3d99bf75f4deee7fc8) `react/no-unescaped-entities`
- (c6380b6fd5fb128c9e34fd30abab2f9d75d4c652) `import/no-anonymous-default-export`
  Ao adequar o c√≥digo para a regra `react/no-unescaped-entities`, nos pontos que exigiam mudan√ßas, notei erros n√£o relacionados com a regra, mas por serem pequenos detalhes, j√° aproveitei para corrigir.

#### pages/[username]/[slug]/index.public.js

Removi `...`, pois j√° est√° presente em `parentContent.body` sempre que for necess√°rio (√© inserido pelo `removeMarkdown`):

```diff
- <strong>"{parentContent.body}..."</strong>{' '}
+ <strong>{`"${parentContent.body}"`}</strong>{' '}
```

#### pages/cadastro/recuperar/index.public.js

Corrigi a valida√ß√£o, pois nunca seria mostrada a mensagem de que deve ser inserido um email v√°lido:

```diff
- {['userInput', 'email', 'username'].includes(errorObject?.key) && (
+ {['userInput', 'email'].includes(errorObject?.key) && (
    <FormControl.Validation variant="error">{errorObject.message}</FormControl.Validation>
            )}
-            {errorObject?.type === 'string.alphanum' && (
+            {errorObject?.key === 'username' && (
-              <FormControl.Validation variant="error">"email" deve conter um endere√ßo v√°lido.</FormControl.Validation>
+              <FormControl.Validation variant="error">Insira um endere√ßo de email v√°lido.</FormControl.Validation>
```

### Resumindo

As modifica√ß√µes relevantes est√£o nos arquivos `.eslintrc` e `package.json`.

> > Review de imattferreira (APPROVED):
> > Ficou showw!!
> > </pull_1499_Configura√ß√µes do ESLint (importa√ß√µes, exporta√ß√µes e JSX)>

<pull_1501_Adiciona √≠cone de carregamento no bot√£o de publicar>
Implementa√ß√£o do componente de bot√£o com status de carregamento para os bot√µes de publicar, salvar etc, considerando o que foi sugerido na issue #788.
| Antes | Depois |
| ----- | ------ |
https://github.com/filipedeschamps/tabnews.com.br/assets/32906579/8777d7e7-e014-4f9b-940c-e5538378a829

> > Review de aprendendofelipe (COMMENTED):
> > Show @mihtoa, obrigado pelo PR! üí™
> > Por favor, veja se concorda com meus coment√°rios no c√≥digo. üëç
> > E que tal fazer o mesmo nos bot√µes de outras telas como, por exemplo, no login, cadastro, recuperar senha, alterar senha, editar perfil etc.? Caso prefira, d√° para criar um bot√£o customizado para usar em todos esses locais, algo como:

```js
function ButtonWithStatus({ children, processing, sx, ...props }) {
  return (
    <Button
      leadingIcon={() =>
        processing ? <Spinner size="small" /> : <Box width="16px" />
      }
      trailingIcon={() => <Box width="16px" />}
      sx={{ paddingX: 2, ...sx }}
      disabled={processing}
      {...props}
    >
      {children}
    </Button>
  );
}
```

A vantagem √© que se depois a gente quiser mudar o tipo do feedback, a gente muda em um s√≥ lugar. Note que adicionei a propriedade `processing` , que eu n√£o pensei muito no nome üòÖ, mas s√≥ para o componente ficar mais flex√≠vel e permitir passar o `disabled` separadamente se for necess√°rio.
Mas s√£o s√≥ sugest√µes, veja o que voc√™ acha que faz sentido e que tenha disponibilidade de fazer ü§ù

> > Review de Guiflayrom (APPROVED):
> > Review de aprendendofelipe (CHANGES_REQUESTED):
> > Show @mihtoa, ficou muito legal üòç
> > Fiz sugest√µes no c√≥digo, pois precisamos poder passar a propriedade `disabled` separadamente. Sem isso, o loading fica ativo indevidamente enquanto os termos n√£o forem aceitos na tela de cadastro:
> > https://tabnews-git-fork-mihtoa-add-spinner-in-publish-button-tabnews.vercel.app/cadastro
> > Review de aprendendofelipe (APPROVED):
> > Show! Vamos pro merge! üéâüéâüéâ
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Tamb√©m √© bom adequar o `aria-label` quando for edi√ß√£o do conte√∫do, de acordo com a exist√™ncia do `contentObject?.id`
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O problema de fazer dessa forma √© que o bot√£o vai mudar de tamanho sempre que for clicado.
> > Para usar o spinner, √© melhor deixar o espa√ßo dele reservado, e isso implica usar um bot√£o maior, deixando inclusive o mesmo espa√ßo do lado oposto do bot√£o, para que o texto fique sempre centralizado.
> > Uma forma nada elegante de fazer isso seria:

```suggestion
              leadingIcon={() => (isPosting ? <Spinner size="small" /> : <Box width="16px" />)}
              trailingIcon={() => <Box width="16px" />}
              sx={{ paddingX: 2 }}
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
export default function ButtonWithLoader({ children, disabled, isLoading, ...props }) {
  return (
    <Button {...props} disabled={isLoading || disabled}>
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            disabled={!isTermsAccepted}
            isLoading={isLoading}>
```

</pull_1501_Adiciona √≠cone de carregamento no bot√£o de publicar>

<pull_1508_Adiciona recompensas di√°rias em TabCoins>
Usu√°rios que participam do fluxo completo de colabora√ß√£o no TabNews ir√£o receber TabCoins extras diariamente.

### Objetivos

O foco principal √© aumentar o volume de qualifica√ß√µes, mas essa funcionalidade tamb√©m atende de maneira simples boa parte das sugest√µes da issue ["Brainstorming de TabCoins"](https://github.com/filipedeschamps/tabnews.com.br/issues/1438), al√©m de criar uma nova motiva√ß√£o para os usu√°rios que gostam da gamifica√ß√£o.

### Como ser Recompensado?

Para ganhar os TabCoins, os usu√°rios precisam ter recebido mais qualifica√ß√µes positivas do que negativas em suas publica√ß√µes, e usar boa parte dos TabCoins ganhos para qualificar os conte√∫dos (n√£o acumular TabCoins).
A recompensa ir√° ocorrer no primeiro acesso do usu√°rio a cada 24 horas. O hor√°rio de corte √© 21:00 (de Bras√≠lia), ent√£o ap√≥s esse hor√°rio j√° √© poss√≠vel resgatar a recompensa at√© √†s 21hrs do dia seguinte.

### Quanto irei Receber?

O valor ganho ir√° depender das qualifica√ß√µes recebidas em seus conte√∫dos, da idade do seu conte√∫do mais recente e do seu saldo de TabCoins.
A parte que depende das qualifica√ß√µes usa a mesma [fun√ß√£o que computa os ganhos ao publicar coment√°rios](https://github.com/filipedeschamps/tabnews.com.br/blob/0c50cd743c924ee1e49e53f32b47e7d67e4afceb/models/prestige.js#L28). Para a equa√ß√£o da recompensa (R), vamos chamar esse dado de P (pois aquela fun√ß√£o calcula o prest√≠gio).
A idade do conte√∫do mais recente ir√° considerar qualquer publica√ß√£o, seja root ou coment√°rio. Essa idade √© dividida por um tempo de base, que podemos ajustar futuramente, mas nesse primeiro experimento estamos usando 1 semana como base. Com essa fra√ß√£o obtemos o fator idade, que vamos chamar de I.
J√° o saldo de TabCoins ser√° dividido por uma quantidade de base tamb√©m, que come√ßamos com 20, e ent√£o √© elevado ao quadrado. Esse dado nos d√° uma no√ß√£o se o usu√°rio costuma qualificar os conte√∫dos, ent√£o vamos chamar de Q.
Ent√£o a recompensa di√°ria ser√° calculada como:
R = ( P - Q ) / ( I + 1 )
O que no c√≥digo √©:

```js
const reward = Math.ceil((prestige - tabcoinsFactor) / contentAgeFactor);
```

onde `contentAgeFactor` √© no m√≠nimo 1.
O resultado sempre √© arredondado para cima, ent√£o se o usu√°rio tiver boas qualifica√ß√µes, e n√£o estiver acumulando muitos TabCoins, ele vai receber no m√≠nimo 1 TabCoin por dia que acessar ao TabNews, mesmo que o tempo da √∫ltima publica√ß√£o seja grande.
Mas para quem publica com frequ√™ncia (intervalo menor que 1 semana), e usa os TabCoins para qualificar (acumula no m√°ximo 20), conseguir√° manter tanto o fator Q como o fator I em 0 (zero), ent√£o os ganhos s√≥ ir√£o depender de P, que depende da qualidade dos seus conte√∫dos, e que deve ficar mais realista com o maior volume de qualifica√ß√µes.

### Implementa√ß√£o

Agora temos o evento `reward:user:tabcoins`, ent√£o ele foi adicionado ao validador.
Foi adicionada a coluna `rewarded_at` na tabela `users` para sabermos se o usu√°rio precisa ser recompensado ou se j√° foi. Como essa coluna armazena a data e hor√°rio, n√£o precisamos mexer nela se futuramente quisermos modificar a frequ√™ncia das recompensas.
Para atualizar esse novo campo, foi criada a fun√ß√£o `updateRewardedAt` no `models/user.js`.
Foi criado o `models/reward.js` que aproveita facilmente diversos outros `models` e o `database` para computar e armazenar tudo relacionado:
Ent√£o foi s√≥ usar o `reward` no `getHandler` da `api/user`:

```js
authenticatedUser.tabcoins += await reward(request);
```

O restante das modifica√ß√µes s√£o s√≥ para os testes, ent√£o separei no commit dab9a3cb6cdccc69a813da448be54e459888fbd8.
</pull_1508_Adiciona recompensas di√°rias em TabCoins>

<pull_1509_Corrige a consulta para considerar tamb√©m os coment√°rios no c√°lculo da recompensa>
Na busca dos conte√∫dos para o c√°lculo da m√©dia de TabCoins, `$3 != TRUE` era avaliado como ~`TRUE`~ `FALSE` quando `isRoot` n√£o era fornecido. Com isso a recompensa estava sendo computada usando apenas conte√∫dos "root".
O teste s√≥ n√£o apontou o erro porque durante a cria√ß√£o eu calculei errado o `defaultTestRewardValue` como sendo `3`, o que coincidentemente bateu com o retornado para `isRoot = true`. Mas o valor correto de `defaultTestRewardValue` √© `2`, e ao corrigir isso, acusou o erro na consulta.
O efeito pr√°tico √© que as recompensas ganhas nos √∫ltimos minutos foram calculadas apenas com base na m√©dia de TabCoins dos conte√∫dos "root". Isso deve ter beneficiado a maioria dos usu√°rios, pois geralmente os coment√°rios recebem menos votos, mas isso n√£o √© necessariamente verdade para todos, ent√£o esse PR corrige a recompensa para considerar a m√©dia de qualquer tipo de publica√ß√£o, seja "root" ou "child".
</pull_1509_Corrige a consulta para considerar tamb√©m os coment√°rios no c√°lculo da recompensa>

<pull_1521_Cria o componente `BarChart` para corrigir o background do Tooltip e a altura dos gr√°ficos no mobile>
Cria o componente personalizado `BarChart` para facilitar a manuten√ß√£o e estiliza√ß√£o padronizada.
Corrige a altura dos gr√°ficos na vers√£o mobile da p√°gina de status, pois ficava dif√≠cil distinguir as alturas de cada barra, j√° que todas ficavam muito baixas.
Tamb√©m corrige o que o @Poveii relatou na issue #1520, ou seja, adequa o background do Tooltip ao tema de cores.

### Antes

### Depois

</pull_1521_Cria o componente `BarChart` para corrigir o background do Tooltip e a altura dos gr√°ficos no mobile>

<pull_1525_Commits mais r√°pidos ao rodar o lint apenas nos arquivos preparados>
Com a configura√ß√£o anterior, o script `npm run lint:fix` era chamado uma vez para cada arquivo preparado, mas esse script roda o lint em todos os arquivos. Como resultado, um commit com **5 arquivos** preparados estava rodando o lint em **todos os arquivos do projeto**, mas n√£o s√≥ isso, fazia esse processo **5 vezes** em sequ√™ncia.
Com a mudan√ßa proposta, o `eslint` e o `prettier` rodar√£o apenas nos arquivos preparados, e, como esperado, apenas uma vez em cada. E para as extens√µes `json`, `css`, `scss` e `md` s√≥ ser√° executado o `prettier`.
</pull_1525_Commits mais r√°pidos ao rodar o lint apenas nos arquivos preparados>

<pull_1531_Adiciona o grafo dos votos por usu√°rios e por ips na p√°gina de status (tudo anonimizado)>
PR para facilitar a identifica√ß√£o de abusos envolvendo qualifica√ß√µes de conte√∫dos.
Adiciona o grafo dos votos por usu√°rios e por IPs na p√°gina de status (tudo anonimizado), e tamb√©m adiciona o gr√°fico da quantidade de qualifica√ß√µes di√°rias nos √∫ltimos 60 dias.
Para a primeira vers√£o est√£o sendo mostradas as √∫ltimas 300 qualifica√ß√µes no grafo. Vejam que em homologa√ß√£o, pela quantidade reduzida de usu√°rios, os votos s√£o bem concentrados:
</pull_1531_Adiciona o grafo dos votos por usu√°rios e por ips na p√°gina de status (tudo anonimizado)>

---

<pull*1533*[Modera√ß√£o] Possibilidade de ver `usernames` no grafo de qualifica√ß√µes>
Continuando a funcionalidade de modera√ß√£o implementada no #1531, agora os moderadores v√£o conseguir ver o nome dos usu√°rios com maiores movimenta√ß√µes de TabCoins, os usu√°rios banidos recentemente e tamb√©m os que est√£o compartilhando conex√£o de acesso de dados.
Para isso foi criada a feature `read:votes:others`, que j√° foi adicionada para todos os moderadores, e o endpoint protegido `/status/votes`.
Tamb√©m foi adicionado o √≠cone ‚ùå para usu√°rios banidos (vis√≠vel para todos), facilitando a identifica√ß√£o de casos j√° tratados pela modera√ß√£o.
Al√©m disso, foi adicionada uma legenda para os √≠cones, e uma barra de status, que mostra dados b√°sicos publicamente, mas d√° mais detalhes para os moderadores ao selecionar um n√≥ ou aresta do grafo.
Publicamente est√£o dispon√≠veis as √∫ltimas 300 qualifica√ß√µes no grafo, mas os moderadores podem ver uma quantidade maior.
Est√° √© a vers√£o **p√∫blica no ambiente de homologa√ß√£o**:
E est√° √© a vers√£o da **modera√ß√£o**, onde, dado ao menor volume do ambiente de homologa√ß√£o, est√£o vis√≠veis todas as 734 qualifica√ß√µes desde o in√≠cio do sistema:
E antes de abrir o PR eu j√° vinha testando em homologa√ß√£o, ent√£o mais tarde j√° vou mesclar em produ√ß√£o üéâ
</pull*1533*[Modera√ß√£o] Possibilidade de ver `usernames` no grafo de qualifica√ß√µes>

---

<pull_1541_Ajustes nas ferramentas de modera√ß√£o>

### Banimento de usu√°rios

90040db847e9b6c96c9fb2408939580a838c4055 N√£o diferenciar os usu√°rios banidos de usu√°rios inexistentes
| Antes | Depois |
| ----- | ------ |
| |
| |
327a1b754a8a7eb047df3f2dc2f2f98fbad81df9 Exclui todos conte√∫dos publicados com uma √∫nica ida ao banco de dados.
620233c69a3dfdad57d1c439c29b81e343641329 Como o saldo final do usu√°rio banido n√£o fica mais dispon√≠vel, n√£o h√° necessidade de desfazer todos as transa√ß√µes, ent√£o com esse commit s√≥ s√£o desfeitas as qualifica√ß√µes.
0f59053e6b5d88307093db86dd60abbb272f1b17 Para reduzir impactos nos saldos de usu√°rios sem envolvimento com o usu√°rio banido, agora s√≥ s√£o desfeitas as qualifica√ß√µes que o usu√°rio realizou nas √∫ltimas duas semanas.

---

### Grafo de qualifica√ß√µes

cda3a10f583ce8221cd4f66445b1f28ff5766bcb, d390a3ff99556d6306d06c2db11286c2729f798c e 248ad6cdc9dc440c6c7726c64a77eab2d81a0d83:

- Agora √© poss√≠vel parar e reiniciar a simula√ß√£o f√≠sica.
- A simula√ß√£o n√£o inicia mais automaticamente com o hover, mas apenas ao mover os n√≥s ou redimensionar. Nesses casos, a simula√ß√£o para novamente se o usu√°rio j√° tiver pausado manualmente antes.
- Criado o menu de filtros do grafo, que ir√° aparecer apenas para moderadores, onde √© poss√≠vel selecionar os tipos e quantidades de n√≥s e arestas que ser√£o mostrados:
- Foram melhoradas as mensagens de status que aparecem ao selecionar ou passar o mouse sobre os n√≥s e arestas.

---

### Outros gr√°ficos da p√°gina de status

14f0c674c8b81467e1e299c53db1f51a7f5b8350 Corrige os gr√°ficos para mostrar os dados sempre em ordem crescente de data.
Os gr√°ficos nem sempre mostravam os dados em ordem correta, pois n√£o havia nenhuma classifica√ß√£o dos dados por data. Exemplo fora de ordem:

---

### Apenas aproveitando o PR

- 06473dd5f3ec2cf753a33f204cfc8c69da11344a faz um ajuste de performance adicionando um limite no `split` que estima a quantidade de palavras na publica√ß√£o, pois n√£o √© necess√°rio dividir o texto mais do que 5 vezes.
  </pull_1541_Ajustes nas ferramentas de modera√ß√£o>

<pull_1542_Adiciona o recurso de copiar c√≥digo para a √°rea de transfer√™ncia>
Esta PR adiciona o recurso de copiar c√≥digo para a √°rea de transfer√™ncia, `copy code to clipboard`. Em resumo, foi criado um plugin para o `bytemd`, chamado `copyCodeToClipboardPlugin` e ele foi adicionado no fim da lista de plugins, aqui:
https://github.com/filipedeschamps/tabnews.com.br/blob/ad30e20a3bffc84aadc15c3b3bcecd753627acb3/pages/interface/components/Markdown/index.js#L17

## Issue relacionada

- Segue a issue relacionada que esta PR resolve #1422

## Preview

> > Review de aprendendofelipe (COMMENTED):
> > Show @kaique-soares, obrigado pelo PR! üí™
> > Muito boa essa implementa√ß√£o, mas veja se faz sentido o que comentei no c√≥digo.
> > Fora o que comentei, eu achei que ficou um pouco estranho o efeito que o padding est√° causando quando o c√≥digo ocupa apenas uma linha. Acho que o bot√£o n√£o precisa respeitar o padding. Parece que na sua primeira vers√£o isso estava melhor, e precisava apenas corrigir a posi√ß√£o do bot√£o para ficar sempre na extremidade direita.
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Show @kaique-soares, fiz mais coment√°rios üëç
> > Review de kaique-soares (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        const codeToCopy = pre.querySelector('code')?.innerText;
        if (!codeToCopy) return;
```

Sugest√£o para n√£o quebrar quando for inserido no markdown uma tag `pre` que n√£o contenha a tag `code`

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        .markdown-body pre {
          display: flex;
          justify-content: space-between;
        }
```

Al√©m do `justify-content: space-between`, √© melhor inserir essa estiliza√ß√£o neste ponto do arquivo:
https://github.com/filipedeschamps/tabnews.com.br/blob/ad30e20a3bffc84aadc15c3b3bcecd753627acb3/pages/interface/components/Markdown/styles/index.js#L1799

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        createCopyButton(pre, codeToCopy);
```

O que acha de usar a fun√ß√£o dessa forma, ou seja, passando o elemento onde o bot√£o deve ser inserido e o texto que deve ser copiado?
O restante do c√≥digo talvez fa√ßa mais sentido deixar dentro da `createCopyButton`, que inclusive pode ser passada como par√¢metro para a `copyCodePlugin(createCopyButton)` l√° no `Markdown/index.js`, deixando totalmente separado o que √© a funcionalidade do plugin e o que √© o bot√£o e sua estiliza√ß√£o.
Se o bot√£o for criado de forma separada do plugin, ele pode ser aproveitado em outros lugares que precisarmos de um bot√£o de copiar.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        .copy-code-to-clipboard {
```

Poderia ser apenas como est√° acima.
Um outro ponto relacionado, √© que aqui voc√™ deixou fixo o `copy-code-to-clipboard`, mas logo abaixo usou a vari√°vel `copyCodeToClipboardClassNames.default`.
Isso tamb√©m me faz voltar a pensar que talvez esse bot√£o pudesse ser separado do plugin. Na verdade, o bot√£o e a estiliza√ß√£o dele podem ser totalmente independentes do ByteMD. Nesse caso seria inserido aqui apenas a estiliza√ß√£o da div em que o bot√£o ser√° inserido. O que acha?

> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Faz sentido, vou ajustar :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Show, vou ajustar :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Um outro ponto relacionado, √© que aqui voc√™ deixou fixo o copy-code-to-clipboard, mas logo abaixo usou a vari√°vel copyCodeToClipboardClassNames.default.
> > Eu tinha pensado no caso de mudar a estiliza√ß√£o diretamente do arquivo do plugin sem se preocupar com a parte onde esse estilo est√° sendo integrado ao editor mas esqueci esse `.copy-code-to-clipboard` e tamb√©m no sentido da sua sugest√£o de separar funcionalidade e estiliza√ß√£o vejo que n√£o foi uma abordagem interessante :sweat_smile:
> > Vou trabalhar nos ajustes :+1:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > @aprendendofelipe o que acha?
> > Agora o bot√£o n√£o est√° seguindo o padding do elemento pai e me parece que o texto n√£o est√° centralizado verticalmente, talvez por conta de `line-height`, e gera um efeito de ter mais padding inferior:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Tamb√©m adicionei um `gap` de `4px` entre o bot√£o e o bloco de c√≥digo porque estava ficando muito pr√≥ximo, um detalhe fino:
> > | Antes | Depois |
> > | ----- | ------ |
> > | | |
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Sobre passar a `createCopyButton` por aqui, acho que fazia sentido apenas se aceitasse a sugest√£o de criar o bot√£o como um componente totalmente independente do plugin do ByteMD.
> > Mas isso representa um trabalho extra, ent√£o, se n√£o achar que vale a pena fazer essa separa√ß√£o no momento, n√£o √© necess√°rio passar ela como par√¢metro para a `copyCodeToClipboardPlugin` üëç
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  function createButtonElement() {
```

Acho que ficou um pouco confuso existir a `createCopyToClipboardButton` dentro da `createCopyButton`

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Agora o bot√£o n√£o est√° seguindo o padding do elemento pai e me parece que o texto n√£o est√° centralizado verticalmente, talvez por conta de line-height, e gera um efeito de ter mais padding inferior:
> > Para usar essa abordagem de margem negativa ser√° preciso descontar tamb√©m a margem inferior, mas acho que pode ser melhor outra abordagem.
> > Talvez usar uma `div` externa com `position: relative` e a interna com `position: absolute` pode ser melhor. Algo como nesse exemplo:

```
.copy-button-external-container {
    position: relative;
    min-width: 32px;
    top: -6px;
    right: -6px;
}
.copy-button-internal-container{
    position: absolute;
}
```

Esses dois cont√™ineres acho que est√£o no contexto do plugin para o ByteMD. Da√≠ s√≥ passar a `div` interna para a fun√ß√£o que adiciona o bot√£o. E o bot√£o n√£o vai precisar de nenhuma configura√ß√£o de posicionamento.
Se preferir manter a abordagem de margem negativa, al√©m de definir tamb√©m a margem inferior, eu acho que o valor correto √© `-6px` e n√£o `-8px`, e ajuda deixar o nome da vari√°vel um pouco mais explicativa, algo como `parent-padding-discount`.

> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > @aprendendofelipe o componente de bot√£o independente ficaria separado como mais um item da `TabNewsUI`?
> > Pergunto isso porque o core da `createCopyButton` est√° isolado do plugin, ent√£o, fiquei mais em d√∫vida onde encaixar o componente :sweat_smile:
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Faz sentido, vou ajustar :+1:
> > Em paralelo, o que acha da abordagem de deixar o bot√£o um pouco mais gen√©rico, por exemplo:

```ts
const BUTTON_ATTRIBUTES = {
  beforeCopy: {
    title: "Copiar c√≥digo",
    "aria-label": "Copiar c√≥digo",
  },
  afterCopy: {
    title: "C√≥digo copiado",
    "aria-label": "C√≥digo copiado",
  },
  classNames: {
    default: "copy-code-to-clipboard",
    copied: "copied",
  },
};
```

Est√° bem direcionado para c√≥digo mas com a sua sugest√£o da `createCopyButton` fiquei pensando se deveria ser um bot√£o de c√≥pia gen√©rico, o que acha?

---

Talvez:

```ts
function createCopyButton(element, contentToCopy, options) {}
```

> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Vou tentar a abordagem que voc√™ sugeriu :+1:
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > @aprendendofelipe o componente de bot√£o independente ficaria separado como mais um item da `TabNewsUI`?
>
> Pergunto isso porque o core da `createCopyButton` est√° isolado do plugin, ent√£o, fiquei mais em d√∫vida onde encaixar o componente üòÖ
> Pode adicionar na TabNewsUI se quiser criar uma vers√£o React, mas n√£o √© esse o ponto, ent√£o n√£o se preocupa com isso num primeiro momento.
> Quando falo de ser um componente independente do ByteMD, quero dizer ser um bot√£o de copiar qualquer coisa, de forma que seja √∫til mesmo onde n√£o utilizamos markdown.
> Nesse caso o c√≥digo dele n√£o deveria ficar dentro da pasta `/Markdown` e nem poderia depender de nada dentro dessa pasta, como a estiliza√ß√£o que est√° sendo inserida no arquivo `/Markdown/styles/index.js`. Deixa aqui dentro s√≥ o que √© espec√≠fico do plugin.
> E a forma de utilizar pode ser sim como voc√™ exemplificou no outro coment√°rio, ou seja, passando op√ß√µes para modificar o texto e os √≠cones üëç
>
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > @aprendendofelipe agora a `createCopyButton` est√° assim:

```js
function createCopyButton(parentElement, contentToCopy, options) {}
```

As `options` quando n√£o fornecidas recebem o um valor padr√£o, as `defaultOptions`. Quando fornecidas s√£o mescladas com as `defaultOptions` e este fluxo me levou a adicionar um m√©todo para validar as `options`, o `validateOptions`.
Acha que faz sentido manter essa estrat√©gia de `defaultOptions` ou quando a `createCopyButton` for chamada, deve receber todas as `options` obrigatoriamente?
Por exemplo, quando for executada dentro da `copyCodeToClipboardPlugin` seria assim:

```js
createCopyButton(internalDivElement, codeToCopy, {
  beforeCopy: {
    title: "Copiar c√≥digo",
    ariaLabel: "Copiar c√≥digo",
    icon: copy.toSVG(),
  },
  afterCopy: {
    title: "C√≥digo copiado",
    ariaLabel: "C√≥digo copiado",
    icon: check.toSVG(),
  },
});
```

> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > @aprendendofelipe seguindo sua sugest√£o ficou assim :tada:
> > </pull_1542_Adiciona o recurso de copiar c√≥digo para a √°rea de transfer√™ncia>

<pull_1545_feat(edit profile): providing feedback to the user after editing their profile successfully>
useRef was used for timeoutID and a variable was implemented to store the message value. The notification is triggered if the profile is saved successfully

#1524
</pull_1545_feat(edit profile): providing feedback to the user after editing their profile successfully>

<pull_1548_Feedback ao editar perfil>
Continuando o trabalho do @viniciusamc nos PRs #1543 e #1545, foi adicionado um feedback tamb√©m quando o bot√£o de salvar √© pressionado sem existir nenhuma altera√ß√£o de configura√ß√£o.
A mensagem global foi reposicionada para logo acima do bot√£o e o timer foi retirado para ela permanecer vis√≠vel enquanto n√£o forem realizadas novas altera√ß√µes no formul√°rio.
Foi refatorada a verifica√ß√£o do dom√≠nio do email para ocorrer apenas quando o endere√ßo for alterado.
As fun√ß√µes `fetchUser` e `logout` foram alteradas para `async` no contexto inicial do `useUser`.
</pull_1548_Feedback ao editar perfil>

<pull_1549_fix(tabcoin-buttons): fix tabcoin vertical alignment>
Corrige alinhamento vertical da contagem de tabcoins de um conte√∫do
| Atual | Corre√ß√£o |
| ----- | -------- |

> > Review de aprendendofelipe (COMMENTED):
> > Review de ErickCReis (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > @ErickCReis, por que precisa desse `lineHeight: '18px'`?
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > N√£o precisa, acabei esquecendo de remover.
> > </pull_1549_fix(tabcoin-buttons): fix tabcoin vertical alignment>

<pull_1554_Corrige o d√©bito de TabCoins ao excluir conte√∫do positivado>
A fun√ß√£o `createRate()` do orquestrador n√£o reproduzia fielmente o comportamento de qualifica√ß√µes realizadas por usu√°rios reais, e isso impedia a detec√ß√£o de um bug no momento de debitar as TabCoins pela exclus√£o de um conte√∫do.
Esse PR corrige o orquestrador e o bug, evitando inconsist√™ncia no saldo de TabCoins ao excluir conte√∫dos.
O bug era causado por um erro na query que busca os ganhos dos conte√∫dos.
A consulta olha para os eventos e busca os balan√ßos correspondentes, e o erro ocorria por estar sendo retornado indevidamente o balan√ßo do usu√°rio que realizou a qualifica√ß√£o junto ao balan√ßo do usu√°rio qualificado. Como isso o saldo do conte√∫do ficava menor do que o real, gerando um ganho indevido de TabCoins ao excluir conte√∫dos positivados.
Agora a consulta retorna apenas o balan√ßo do usu√°rio que recebeu os votos, e com isso ocorre o d√©bito correto no momento de exclus√£o do conte√∫do.
O bug n√£o causava preju√≠zos para os usu√°rios, apenas ganhos indevidos.
</pull_1554_Corrige o d√©bito de TabCoins ao excluir conte√∫do positivado>

<pull_1555_Reverte o commit comemorativo ao anivers√°rio de 1 ano do lan√ßamento do TabNews>
Reverte o commit 7c1e03513448eedc86cf0bd203c03651399b26de desativando os confetes que eram jogados apenas no dia de anivers√°rio do TabNews.
</pull_1555_Reverte o commit comemorativo ao anivers√°rio de 1 ano do lan√ßamento do TabNews>

<pull_1558_Mostra mais informa√ß√µes do usu√°rio no perfil>
Implementando o que foi dito no issue https://github.com/filipedeschamps/tabnews.com.br/issues/1557:

- [x] Mostrar TabCoins e TabCash.
- [x] Mostrar data de cadastro.
- [x] Op√ß√£o de Editar Perfil.
      Aproveitei tamb√©m para remover a op√ß√£o de Nuke no pr√≥prio perfil.
      O que fica para outro PR:

- [ ] Op√ß√£o de moderar a descri√ß√£o do perfil (essa e outras coisas sobre a descri√ß√£o est√£o no issue https://github.com/filipedeschamps/tabnews.com.br/issues/1466)
- [ ] Destacar usu√°rios novos, similar o Hacker News (sugest√£o do Filipe https://github.com/filipedeschamps/tabnews.com.br/issues/1557#issuecomment-1828100857, acho que n√£o tem issue para isso)

---

### Detalhes

1. Apesar de muito parecidos, n√£o criei um √∫nico componente para `TabCoinCount` e `TabCashCount` por n√£o conseguir pensar num bom nome.
2. A op√ß√£o de `Editar Perfil` ficou sem √≠cone porque no menu da conta (topo superior direito) est√° sem √≠cone. Como contraponto, o Nuke (no perfil do usu√°rio) e todas as op√ß√µes em um conte√∫do tem √≠cone. Apesar disso, n√£o acho que tenha ficado ruim/feio ou inconsistente.
3. Cogitei criar testes para o `PastTime` em `tests/unit/components`, mas n√£o o fiz porque n√£o tem nenhum teste de UI nem biblioteca nas depend√™ncia (exemplo: [@testing-library/react](https://testing-library.com/docs/react-testing-library/intro/)), mas se for desej√°vel, eu crio.
4. N√£o vi o que precisa editar no banco para ter TabCoins e TabCash e fazer um GIF melhor üòÖ.

### Resultado

[Usu√°rio "admin" no pr√≥prio perfil](https://github.com/filipedeschamps/tabnews.com.br/assets/26308880/bc71b064-a02b-4c61-8a43-381cba6ac8d3)

> > Review de aprendendofelipe (DISMISSED):
> > Boa @Rafatcb, obrigado pelo PR! üí™
> > Aproveitei tamb√©m para remover a op√ß√£o de Nuke no pr√≥prio perfil.
> > Massa!
> > n√£o criei um √∫nico componente para `TabCoinCount` e `TabCashCount` por n√£o conseguir pensar num bom nome.
> > Pensei `CoinDisplay`, ou seja, tamb√©m n√£o consegui pensar um bom nome üòÖ
> > n√£o tem nenhum teste de UI nem biblioteca nas depend√™ncia (exemplo: [@testing-library/react](https://testing-library.com/docs/react-testing-library/intro/)), mas se for desej√°vel, eu crio.
> > √â algo que ainda precisamos adicionar, mas n√£o precisa ser nesse PR. üëç
> > Na verdade eu acredito que a TabNewsUI pode virar uma biblioteca separada, o que ser√° √∫til tamb√©m para o curso.dev (e que mais quiser usar) e pode concentrar os testes dos componentes de interface.
> > Fiz alguns coment√°rios no c√≥digo. Veja se fazem sentido ou se deixa para outro PR ü§ù
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > @Rafatcb, acho que s√≥ falta arrumar a label conforme comentei no c√≥digo.
> > Da√≠ voc√™ quer fazer squash dos commits para organizar e remover as altera√ß√µes que foram revistas?
> > Normalmente eu fa√ßo o squash pelo GitHub na hora do merge, mas al√©m de s√≥ sobrar um commit, como um deles voc√™ me deixou como autor, n√£o quero arriscar do GitHub n√£o colocar voc√™ na lista de contribuidores.
> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > J√° existe a vari√°vel `isAuthenticatedUser` com a mesma informa√ß√£o que `isSameUser`.

```suggestion
    const canNuke = !isAuthenticatedUser && user?.features?.includes('ban:user') && !userFound?.features?.includes('nuked');
    const canUpdate = isAuthenticatedUser && user?.features?.includes('update:user');
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
          <Pagehead sx={{ width: '100%', display: 'flex', alignItems: 'baseline', mt: 0, pt: 0, pb: 3, mb: 3, wordBreak: 'break-word', flexWrap: 'wrap' }}>
```

@Rafatcb, pela diferen√ßa no tamanho das fontes, acho que ficaria visualmente melhor usar `alignItems: 'baseline'`, mas da√≠ precisa mexer tamb√©m nas coins, ent√£o precisa analisar melhor.
@gabrielsozinho, obrigado pela ajuda! üí™

> Uma √∫nica observa√ß√£o que eu tenho √© que est√° com um problema de responsividade em dispositivos mobile
> Voc√™ fala por n√£o quebrar a linha quando o nome de usu√°rio somado aos novos dados n√£o couber na largura do dispositivo, certo? Ou tem outros problemas?
> Se for isso, √© um problema j√° presente, apenas agravado com as novas informa√ß√µes adicionadas, mas acho que pode ser corrigido com `wordBreak: 'break-word'` e `flexWrap: 'wrap'`.
> O que acham?
>
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Sua sugest√£o melhorou bem o resultado. Fiz mais algumas altera√ß√µes para conciliar com a label `nuked`, testando como fica em diferentes telas. Mais para o fim da noite eu subo as altera√ß√µes com prints.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Que susto! T√° todo mundo `nuked` üòÖ
> > Talvez tenha retirado esse peda√ßo para ver o resultado visual com label, mas acabou esquecendo de voltar

```suggestion
        {userFound.features.includes('nuked') && <Label variant="danger">nuked</Label>}
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que as divs adicionais estavam aqui pelo mesmo motivo do que foi comentado abaixo, mas nesse componente n√£o parece ter necessidade.
> > https://github.com/filipedeschamps/tabnews.com.br/blob/84a0936bc242ee5a72b05065005376c653d0e14c/pages/interface/components/Content/index.js#L81-L85
> > S√≥ estou comentando para termos um hist√≥rico se surgir algum problema pela remo√ß√£o üëç
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > √â... Realmente dei mole a√≠ e n√£o me toquei ü§¶. Obrigado, Felipe!
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu percebi que se eu abrir, scrollar at√© o menu sair da tela, e clicar na tela para que ele feche, a tela faz o scroll sozinho para onde ele estava, mas isso tamb√©m acontece nos conte√∫dos. N√£o consegui identificar o _flickering_.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Eu percebi que se eu abrir, scrollar at√© o menu sair da tela, e clicar na tela para que ele feche, a tela faz o scroll sozinho para onde ele estava
> > Que massa! Descobriu um bug que acontece at√© na p√°gina do [ActionMenu no site do Primer](https://primer.style/react/ActionMenu).
> > </pull_1558_Mostra mais informa√ß√µes do usu√°rio no perfil>

---

<pull*1559*[Barra de pesquisa mobile] Mostrar op√ß√µes de classifica√ß√£o dos resultados>
A barra de pesquisa do Google estava omitindo a op√ß√£o de classificar os resultados quando a pesquisa era realizada em dispositivos de tela pequena.
Esse PR faz sempre mostrar as op√ß√µes de classifica√ß√£o dos resultados:
</pull*1559*[Barra de pesquisa mobile] Mostrar op√ß√µes de classifica√ß√£o dos resultados>

---

<pull_1560_Diminui o tamanho limite do slug dos conte√∫dos de 255 para 226 bytes>
Vamos precisar usar um limite menor para o tamanho do slug, pois sen√£o teremos erros durante o deploy sempre que houver algum conte√∫do recente com slug maior do que 226 bytes.
Isso porque descobri que o limite de bytes do √∫ltimo segmento nos caminhos din√¢micos, na pr√°tica, s√£o menores do que o limite de 255 bytes do nome dos arquivos. E que, dependendo do caso, s√£o mais limitados na Vercel do que no Next.js.
O problema n√£o foi notado antes, pois at√© hoje apenas 2 conte√∫dos publicados possuem slug maior do que 226 bytes, e apenas um deles √© recente.
Quando for feito o deploy em produ√ß√£o eu j√° vou atualizar esses dois conte√∫dos para o novo limite, mas o melhor de tudo √© que qualquer eventual link que existir com o caminho antigo continuar√° funcionando, pois o validador ir√° considerar apenas os 226 primeiros bytes.
Vou deixar registrado o hist√≥rico da investiga√ß√£o, pois pode ser √∫til para quem estiver lidando com o erro `ENAMETOOLONG` mesmo com segmentos menores do que 255 bytes.

### Hist√≥rico da investiga√ß√£o do problema

Hoje ocorreu um erro de limite de tamanho do nome de arquivo durante um deploy. E ao investigar, vi que o slug que estava dando problema continha apenas 233 bytes, ou seja, tinha folga com rela√ß√£o ao que definimos como limite, que era 255 bytes (devido √† limita√ß√£o de nome de arquivo).
Ent√£o fiz alguns testes e descobri que o limite para o next √© de 250 bytes (n√£o 255). Imagino que seja por adicionar a extens√£o `.html` aos arquivos est√°ticos, o que usa os 5 bytes adicionais.
Mas isso n√£o explicava o erro durante o deploy, j√° que o slug tinha 233 bytes, ent√£o tive que fazer alguns deploys at√© entender o que estava ocorrendo. O erro original era:
`Error: ENAMETOOLONG: name too long, open '/vercel/output/functions/[username]/[...slug de 233 bytes...].prerender-fallback.html'`
O erro ocorria em um arquivo de nome `[slug].prerender-fallback.html`, ou seja, tinha 24 bytes adicionados pela Vercel aqui nessa linha:
https://github.com/vercel/vercel/blob/f124779b35bce740e61a8797e4a547d4b9ba068b/packages/cli/src/util/build/write-build-result.ts#L158
Ent√£o testei com um slug de 231 bytes e passei a obter erros com arquivos de nome `[slug].json.prerender-fallback.json` (agora 29 bytes adicionais).
Com isso cheguei no limite real de 226 bytes, que somados aos 29 bytes adicionados em uma das etapas do deploy, atinge o limite de 255 bytes.
E tudo indica que esse problema s√≥ ocorre durante o deploy na Vercel. N√£o √© uma limita√ß√£o do Next.js (nele podemos usar 250 bytes). E s√≥ temos o limite de 226 bytes para conte√∫dos que estiverem sendo retornados por `getStaticPaths()` (p√°ginas est√°ticas geradas em momento de build). Mas n√£o s√≥ isso, o problema s√≥ ocorre se `fallback` for definido como `"blocking"` ou `true` em conjunto com `revalidate`.
</pull_1560_Diminui o tamanho limite do slug dos conte√∫dos de 255 para 226 bytes>

<pull_1562_Corrige scroll horizontal indevido>
Corrige os problemas de scroll tratados em #1532, seja pelo username muito longo, seja pela falta de espa√ßo no header.
No caso do header, quando o usu√°rio estiver logado e estando em tela estreita, o √≠cone de busca √© passado para dentro do menu.
Em telas muito pequenas ainda pode faltar espa√ßo no header, mas agora o header ir√° aumentar de tamanho para caber todos os itens, que ser√£o acess√≠veis atrav√©s do scroll.
Como mexi no menu, arrumei um problema antigo que ocorria entre o Primer e o Link do Next. Era um problema que s√≥ gerava mensagens no console em modo de desenvolvimento, mas aproveitei para usar parte do que ganhamos de experi√™ncia no PR #1279 para j√° corrigir isso. Agrade√ßo ao @Ryannnkl, pois ele fez muitos estudos no PR citado. üí™
Uma das coisas que se originou naquele PR foi o componente [`NavItem`](https://github.com/filipedeschamps/tabnews.com.br/blob/4c5593c8ef3d5f9adea1e476a8370e3681d3ba2b/pages/interface/components/Link/index.js#L24), que eu j√° havia criado e deixado dispon√≠vel para ser utilizado se o PR fosse para frente. Esse componente, al√©m de corrigir o erro do link, tamb√©m mostra quando j√° estamos em alguma p√°gina do menu. No primeiro exemplo estava na p√°gina de criar conte√∫do, e nos demais estava na p√°gina de configura√ß√µes do usu√°rio.
E j√° que mexemos no menu, adicionei os √≠cones faltantes e modifiquei outros.
| Antes | Depois |
| ----- | ------ |
| |

### Diferentes larguras de tela

### Menu "Editar perfil"

Como a op√ß√£o "Editar perfil" foi adicionada na p√°gina que lista os conte√∫dos dos usu√°rios, os erros no console tamb√©m estavam l√°. Ent√£o tamb√©m corrigi e j√° adicionei o √≠cone de engrenagem. E aproveitei para trocar o √≠cone de nuke:
| Antes | Depois |
| ----- | ------ |
| |

### Link em homologa√ß√£o

https://tabnews-git-fix-horizontal-scroll-tabnews.vercel.app
O que acham?

> > Review de Rafatcb (APPROVED):
> > Gostei do resultado üëè .
> > Dada as limita√ß√µes do `Tooltip`, n√£o consigo imaginar uma solu√ß√£o melhor para a parte dos conte√∫dos.
> > Eu ainda n√£o tinha visto c√≥digo com array nos valores de `sx`, fui pesquisar melhor e encontrei a explica√ß√£o na [documenta√ß√£o](https://primer.style/react/overriding-styles#responsive-values). Jeito interessante de lidar com a responsividade.
> > </pull_1562_Corrige scroll horizontal indevido>

<pull_1563_Continuando #1542 - Adiciona o recurso de copiar c√≥digo para a √°rea de transfer√™ncia>
Dando continuidade ao trabalho do @kaique-soares no #1542, eu removi a biblioteca `@primer/octicons`, pois estava adicionando mais de 100kB ao load inicial do TabNews.
Deixando fixos no c√≥digo os dois elementos `svg` necess√°rios (`check` e `copy`), o aumento passou a ser de apenas 3kB.
Essa melhoria do @kaique-soares tem grande potencial de virar um plugin do ByteMD, ent√£o movi o restante da estiliza√ß√£o que estava no arquivo `/Markdown/styles/index.js` para dentro do `/Markdown/plugins/copy-code-to-clipboard.js`, restando apenas a defini√ß√£o de cores de acordo com o tema.

**[Edit]** A melhoria j√° √© um plogin do ByteMD, mas quero dizer que tem potencial de virar um PR na biblioteca oficial üòÖ

> > Review de kaique-soares (COMMENTED):
> > Review de kaique-soares (APPROVED):
> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > @aprendendofelipe √≥timo que voc√™ lembrou de separar isso :muscle:
> > </pull_1563_Continuando #1542 - Adiciona o recurso de copiar c√≥digo para a √°rea de transfer√™ncia>

<pull_1565_Atualiza a vers√£o do Node.js para `lts/iron` (`v20`)>
Atualiza o Node.js devido √† proximidade (menos de 2 meses) do t√©rmino da compatibilidade da `v16` pela Vercel:
</pull_1565_Atualiza a vers√£o do Node.js para `lts/iron` (`v20`)>

<pull*1570_Tratar erro de desconex√£o com banco de dados no descongelamento das lambdas>
As lambdas podem ser congeladas logo ap√≥s responderem a requisi√ß√£o, mesmo se ainda existir c√≥digo a ser executado depois do envio da resposta.
Isso n√£o vinha sendo um problema, mas com a atualiza√ß√£o do runtime para a `v20` no PR #1565, come√ßamos a receber erros `ECONNRESET`.
Especulo que otimiza√ß√µes do Node est√£o permitindo congelar a lambda mais rapidamente, enquanto ainda n√£o foi executada a `getConnectionLimits()` ou a `getOpenedConnections()`.
Se as lambdas s√£o descongeladas no meio da execu√ß√£o de uma dessas fun√ß√µes (especificamente no meio da \_query*), onde o banco de dados j√° vai ter fechado a conex√£o por timeout, √© muito prov√°vel que seja o momento em que os erros `ECONNRESET` est√£o sendo produzidos.
Aproveitei para otimizar o processo de libera√ß√£o da conex√£o, onde agora o pool n√£o √© mais destru√≠do, mas apenas a conex√£o com o banco de dados √© liberada atrav√©s do argumento `true` passado para `client.release()` quando for estivermos com muitas conex√µes abertas (`tooManyConnections`).
</pull_1570_Tratar erro de desconex√£o com banco de dados no descongelamento das lambdas>

<pull_1571_Gerando logs para debug do erro `ECONNRESET`>
Gerando logs para tentar identificar a origem do erro abaixo, que ocorre muito esporadicamente e, por enquanto, apenas em produ√ß√£o:
`Invoke Error 	{"errorType":"Error","errorMessage":"read ECONNRESET","code":"ECONNRESET","errno":-104,"syscall":"read","stack":["Error: read ECONNRESET","    at TCP.onStreamRead (node:internal/stream_base_commons:217:20)","    at TCP.callbackTrampoline (node:internal/async_hooks:130:17)"]}`
</pull_1571_Gerando logs para debug do erro `ECONNRESET`>

<pull_1572_Downgrade do Node.js para `lts/hydrogen` (`v18`)>
Altera a vers√£o do Node para `v18`, j√° que no PR #1565 atualizamos o Node da `v16` diretamente para a `v20` e passamos a receber erros espor√°dicos:
`Invoke Error 	{"errorType":"Error","errorMessage":"read ECONNRESET","code":"ECONNRESET","errno":-104,"syscall":"read","stack":["Error: read ECONNRESET","    at TCP.onStreamRead (node:internal/stream_base_commons:217:20)","    at TCP.callbackTrampoline (node:internal/async_hooks:130:17)"]}`
Estou removendo os logs adicionados no PR #1571 para debug, pois nenhum deles foi acionado nos momentos em que os erros acima ocorreram.
Por√©m mantive o `databaseCache` no contexto dos erros gerados dentro do m√≥dulo `database` para melhorar a observabilidade:
https://github.com/filipedeschamps/tabnews.com.br/blob/60b2f300d3d653b9446f1921f7254a52e465e0b4/infra/database.js#L187-L193
</pull_1572_Downgrade do Node.js para `lts/hydrogen` (`v18`)>

---

<pull*1573*[Responsividade e Acessibilidade] Truncar `username` longo na lista de conte√∫dos e mais>
Aplica algumas melhorias de responsividade e acessibilidade.

## Lista de conte√∫dos

Agora ser√° truncado o `username` sempre que faltar espa√ßo.
Usando `display: grid`, consegui eliminar a necessidade dos diversos `overflow: hidden` e do `position: absolute` no `Tooltip`, ent√£o acredito que chegamos em um resultado melhor, pois a solu√ß√£o anterior (#1562) parecia mais um bug do que o bug que ela corrigiu: üòÖ
| Antes | Depois |
| ----- | ------ |
| |
Por estarmos truncando o `username`, adicionei um `Tooltip`:
Em resolu√ß√µes com pouca largura (menores de 360px), achei melhor manter o scroll horizontal como ocorria anteriormente, pois ele j√° vai ser necess√°rio por causa do Header. Exemplo com 160px:
| Antes | Depois |
| ----- | ------ |
| |
Obs. O t√≠tulo continua quebrando a linha para facilitar a leitura sem precisar do scroll horizontal.

## Header

Em telas de 360px de largura, para usu√°rios com grandes saldos de TabCoins e/ou TabCash, ainda podia ser necess√°rio um pequeno scroll horizontal para visualizar todo o Header, ent√£o reduzi alguns espa√ßamentos para telas menores do que o target 544px. O mais percept√≠vel √© o espa√ßamento entre os saldos:
| Antes | Depois |
| ----- | ------ |
| |

## Telas ainda menores

Dois problemas que s√≥ ocorriam em telas muito menores do que 360px, mas que achei que valia a pena melhorar:
| Antes | Depois |
| ----- | ------ |
| |
| |

## HTML sem√¢ntico

Como ajustei o `Tooltip` do `PastTime`, j√° aproveitei para trocar a tag `span` pela `time`.

> > Review de Rafatcb (COMMENTED):
> > Acho que o resultado ficou melhor! Bom, pelo menos a data n√£o est√° mais sozinha em outra linha üòÖ
> > Aproveitando, acho que poderia ajustar o alinhamento do √≠cone de busca quando o usu√°rio est√° deslogado:
> > A primeira impress√£o que tive √© que o √≠cone do tema estava errado, mas na verdade ele est√° alinhada com os textos. O √≠cone de busca est√° centralizado, mas me aprece que alinhado embaixo ficaria melhor.
> > E tamb√©m poderia adicionar um `ml` nele, j√° que nas telas "super pequenas" ele est√° desproporcionalmente mais pr√≥ximo de "Recentes" do que do √≠cone do tema.
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que faz sentido manter o `mr: 2` pela consist√™ncia, n√£o?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > D√∫vida: ainda precisamos desse `<Text>`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o obrigatoriamente, mas se quisermos que o `gap` entre cada parte fique exatamente igual, definido pelo `grid`, ainda precisamos. Com esse PR a gente est√° ignorando os espa√ßos em `{' ¬∑ '}`.
> > Se retirar os `<Text>`, alguns dos espa√ßos v√£o ser definidos pelo `gap` e outros pelos espa√ßos em `{' ¬∑ '}`. Com isso, podem ficar diferentes espa√ßamentos com determinadas configura√ß√µes de acessibilidade.
> > √â fato que essas configura√ß√µes de acessibilidade j√° quebram diversas partes do design, mas aos poucos vamos corrigindo.
> > Outra quest√£o √© a sem√¢ntica do `gridTemplateColumns`, pois sairia da primeira para a segunda imagem abaixo:
> > O que acha melhor?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Boa! Isso foi para melhorar a centraliza√ß√£o do "√≠cone de sele√ß√£o de tema" entre o "√≠cone de busca" e o "Entrar", mas acho que d√° para manter `mr: 1` aqui e mexer no bot√£o "Entrar". A falta de alinhamento parou de incomodar enquanto eu arrumava o Header, ent√£o esqueci de procurar uma alternativa melhor. Mas acho que d√° üëç
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Me parece que √© melhor deixar como est√° mesmo.
> > </pull*1573*[Responsividade e Acessibilidade] Truncar `username` longo na lista de conte√∫dos e mais>

---

<pull_1574_Cria√ß√£o de templates de issue e pull request>
Conforme mencionado no PR https://github.com/filipedeschamps/tabnews.com.br/pull/892 e no issue https://github.com/filipedeschamps/tabnews.com.br/issues/902, fiz o template do issue com `.yml` para fazer uso do recurso beta de formul√°rios do GitHub.
Algumas observa√ß√µes:

- Edit p√≥s-review: Desabilitei issues sem template. Se necess√°rio, o autor pode editar ou criar um coment√°rio no issue.
- Deixei sem `title` padr√£o como `[Bug]` e `[Sugest√£o/Feature]` porque estamos usando label e achei que ficaria repetitivo, tanto vendo (quase) todos issues come√ßando com os mesmos textos, quanto ter essa tag no t√≠tulo e o label.
- N√£o precisava, mas coloquei o n√∫mero da ordem dos templates no nome do arquivo para deixar claro que a ordem √© intencional.
- Criei um template de Pull Request e, como √© um √∫nico template, pode ficar direto em `.github` para ser a op√ß√£o padr√£o, conforme mencionado na [documenta√ß√£o](https://docs.github.com/en/communities/using-templates-to-encourage-useful-issues-and-pull-requests/creating-a-pull-request-template-for-your-repository). Me parece que n√£o √© poss√≠vel ter mais de um template e escolher como no caso dos Issues, apenas usando query parameters na URL ([mais detalhes aqui](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/using-query-parameters-to-create-a-pull-request)).
- N√£o sei se precisamos de tanto controle no template do PR, ent√£o estou aberto √† sugest√µes. Fiz bem baseado no do [react-hook-form](https://github.com/react-hook-form/react-hook-form/blob/master/.github/PULL_REQUEST_TEMPLATE/pull_request_template.md).
  Acredito que a orienta√ß√£o dada na cria√ß√£o dos issues e dos PRs ajudar√° a ter menos conte√∫do no `CONTRIBUTING.md` sobre esse assunto.
  Resolve #902

## Exemplos de como ficou ap√≥s o merge:

### Sele√ß√£o de Issue

### Issue - Reportar bug

### Issue - Sugerir novo recurso

### Issue - Fa√ßa uma pergunta

### Pull Request

> > Review de aprendendofelipe (COMMENTED):
> > Conforme mencionado no PR #892 e no issue #902, fiz o template do issue com `.yml` para fazer uso do recurso beta de formul√°rios do GitHub.
> > Show de bola Rafa!!! ü§©ü§©ü§©
>
> - Deixei os habilitada a possibilidade de criar um issue sem template por causa dos issues de Milestones,
>   O `config.yml` s√≥ √© necess√°rio se for configurar `blank_issues_enabled: false`?
>   Ser√° que n√£o compensa restringir isso? Talvez quem tem permiss√£o de escrita no reposit√≥rio consiga abrir sem o template, mas mesmo se n√£o der, nada impede de abrir com um template e editar logo em seguida removendo o que n√£o for necess√°rio.
>   e tamb√©m para acompanharmos se existem outras necessidades de templates.
>   Acho mais f√°cil descobrirmos isso se algu√©m abrir usando um template e comentar algo como "n√£o sei se usei o template certo, mas..."
> - N√£o sei se precisamos de tanto controle no template do PR, ent√£o estou aberto √† sugest√µes. Fiz bem baseado no do [react-hook-form](https://github.com/react-hook-form/react-hook-form/blob/master/.github/PULL_REQUEST_TEMPLATE/pull_request_template.md).
>   Eu acho que est√° √≥timo! üëç
>   Exemplos de como ficar√°:
>   Sobre pedir para votar nas issues, eu particularmente acho estranho e sem necessidade. Acho melhor s√≥ pedir para a pessoa contribuir com informa√ß√µes adicionais. O que acham?
>   Ser√° que, na dica para pesquisar, n√£o seria bom lembrar de olhar tamb√©m nas issues fechadas?
>   > Review de aprendendofelipe (APPROVED):
>   > </pull_1574_Cria√ß√£o de templates de issue e pull request>

<pull_1577_Filtro de conte√∫dos na p√°gina do usu√°rio>

## Mudan√ßas realizadas

Continua√ß√£o de #1188
Resolve #807
https://github.com/filipedeschamps/tabnews.com.br/assets/30873873/5ba90434-1b38-4252-98b1-66b6a99f14a4

<!-- Por favor, inclua uma descri√ß√£o sobre o que foi modificado nesse PR. Inclua tamb√©m qualquer motiva√ß√£o ou contexto relevante.  -->
<!-- Se o PR cont√©m uma modifica√ß√£o da interface gr√°fica (UI), adicione fotos ou v√≠deos comparando o antes e depois. -->
<!-- Se o PR cont√©m modifica√ß√µes de API, mencione os endpoints afetados. -->
<!-- Caso esse PR resolva algum issue, voc√™ pode descomentar a linha abaixo e substituir (issue) pelo n√∫mero dele. -->
<!-- Resolve #(issue) -->

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->
<!-- - [x] Corre√ß√£o de bug -->

- [x] Nova funcionalidade
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [ ] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [ ] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Show @ErickCReis! üí™üí™üí™
  > > Como ainda √© WIP, eu n√£o revisei tudo, mas fiz alguns coment√°rios alinhados com a ideia de deixar como algo comum a todas as abas apenas o `username`.
  > > E o restante (saldos de TabCoin e TabCash, data de cria√ß√£o do usu√°rio, menu editar e nuke etc.) mostrar apenas no endere√ßo `/[username]`, como j√° ocorre hoje.
  > > Da√≠ tudo isso ficaria abaixo do `UserHeader`, apenas no `pages/[username]/index.public.js`
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Est√° ficando muito legal @ErickCReis! üéâüéâüéâ
  > > Gostei de onde voc√™ colocou o total de cada tipo de conte√∫do üëç
  > > Ainda n√£o revisei tudo, j√° que √© W.I.P., mas j√° deixei alguns novos coment√°rios no c√≥digo.
  > > Por favor, veja o que faz sentido. üí™
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Uma observa√ß√£o para o futuro (n√£o necessariamente para esse PR): creio que fa√ßa sentido retornarmos para o cliente o `count` de publica√ß√µes e coment√°rios para j√° mostrar nas abas sem precisar clicar nelas, como o GitHub faz.
  > > √ìtimo PR! Meus coment√°rios s√£o mais referentes √† nomenclatura do que um problema de implementa√ß√£o.
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Consegui resolver os √∫ltimos detalhes que encontrei.
  > > Deixei alguns coment√°rios com detalhes de implementa√ß√£o e d√∫vidas.

---

Fiz alguns testes mas n√£o soube como deixar a aba de perfil mais interessante, acho j√° √© suficiente para a primeira vers√£o, mas aceito sugest√µes.
Al√©m disso tem alguns detalhes de layout que estou na d√∫vida:

1. A label `nuked` pode ficar ali mesmo?
2. O que fazer com o tooltip `TabCoins`?
3. Nesse cen√°rio de usu√°rio exclu√≠do, faz sentido mostrar as TabCoins, TabCash e o tempo?
   > > Review de aprendendofelipe (COMMENTED):
   > > Review de Rafatcb (COMMENTED):
   > > Agora que o perfil n√£o vai diretamente para "Meus conte√∫dos", acho melhor renomear o texto da op√ß√£o no menu do header para "Meu perfil" ou algo do tipo.

---

> 1. A label nuked pode ficar ali mesmo?
>    Respondi num coment√°rio no c√≥digo.
> 2. O que fazer com o tooltip TabCoins?
>    Dei uma opini√£o num coment√°rio do c√≥digo.
> 3. Nesse cen√°rio de usu√°rio exclu√≠do, faz sentido mostrar as TabCoins, TabCash e o tempo?
>    Como disse num coment√°rio do c√≥digo, hoje o usu√°rio removido retornar√° p√°gina 404, ent√£o n√£o acho que precise se preocupar com isso. Eventualmente, se voltar a mostrar o perfil com o estado de `nuked`, me parece fazer sentido mostrar as informa√ß√µes normalmente.
>    > Review de ErickCReis (COMMENTED):
>    > Review de ErickCReis (COMMENTED):
>    > Review de ErickCReis (COMMENTED):
>    > Review de ErickCReis (COMMENTED):
>    > Review de ErickCReis (COMMENTED):
>    > Review de ErickCReis (COMMENTED):
>    > Review de Rafatcb (COMMENTED):
>    > Review de Rafatcb (COMMENTED):
>    > Review de Rafatcb (COMMENTED):
>    > Massa, Erick! Fiz mais um testes aqui e surgiu outra d√∫vida.
>    > Ser√° que faz sentido permitir acessar a p√°gina `/conteudos/1` tamb√©m como `/conteudos`? E o mesmo racioc√≠nio vale para a p√°gina `/comentarios/1`. Se a resposta for _sim_, precisaria verificar os `reservedUsernames` na cria√ß√£o de um conte√∫do tamb√©m, porque fiz um teste e criei uma publica√ß√£o com o slug `conteudos` e outra `comentarios`.
>    > Um exemplo de onde isso √© permitido √© nas p√°ginas de conte√∫dos:

- Recentes: `/recentes/pagina/1` e `/recentes`
- Relevantes: `/` e `/pagina/1`
  Seria bom ouvir a opini√£o do @aprendendofelipe sobre isso.
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (DISMISSED):
  > > Muito obrigado @ErickCReis, um grande trabalho e excelente contribui√ß√£o! üòçüëèüí™
  > > Obrigado tamb√©m @Rafatcb e @kaique-soares! üí™
  > > Eu fiz mais dois coment√°rios no c√≥digo, mas n√£o √© nada que impe√ßa a aprova√ß√£o do PR.
  > > Ent√£o, se n√£o surgir nada novo, mais tarde vou enviar para produ√ß√£o ü§ù
  > > Review de ErickCReis (COMMENTED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Acredito ser melhor manter `{ withBalance: true }` apenas na aba "perfil"
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > D√∫vidas:

1. Por que precisou adicionar `JSON.parse` e `JSON.stringify` aqui?
2. Por que achou melhor trocar `username` por `userFound`?
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Ser√° que n√£o √© melhor deixar isso aqui, ao inv√©s de no `UserHeader`, e s√≥ ser usado na p√°gina "perfil"?
   > > A d√∫vida vale para algumas das partes exclu√≠das no trecho, como `useSWR`, `handleClickNuke`, `OptionsMenu` etc.
   > > Coment√°rio de ErickCReis (linha de c√≥digo):
   > > Aqui eu segui a implementa√ß√£o da p√°gina `pages/[username]/index.public.js`, mas como n√£o vamos precisar de todas as informa√ß√µes vou voltar a utilizar apenas o `username` aqui.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Como aqui sempre v√£o ser conte√∫dos `root`, ou seja, todos possuem t√≠tulo, pode adicionar o `attributes` abaixo ao objeto passado para `findWithStrategy`:

```js
      attributes: {
        exclude: ['body'],
      },
```

E pode remover o trecho mais abaixo:

```js
for (const content of secureContentListFound) {
  if (content.parent_id) {
    content.body = removeMarkdown(content.body, { maxLength: 255 });
  } else {
    delete content.body;
  }
}
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  for (const content of secureContentListFound) {
    content.body = removeMarkdown(content.body, { maxLength: 255 });
  }
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            mb: 3,
            overflow: 'hidden',
```

Por favor, consegue testar se `overflow: hidden` aqui resolve o problema com texto zalgo?
Exemplo:

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Pra mim, essa mensagem s√≥ faz sentido se estivermos na p√°gina 1.
> > Por exemplo, se eu navego para uma p√°gina alta, digamos a 1000, nenhum conte√∫do ser√° encontrado, mas n√£o faz sentido dizer que eu ainda n√£o fiz publica√ß√µes, sendo que j√° fiz.
> > Talvez isso n√£o precise ser mudado aqui, mas sim no `getStaticProps`. Acho que seria legal fazer um redirect para a √∫ltima p√°gina v√°lida sempre que a p√°gina for maior do que 1 e n√£o for encontrado nenhum conte√∫do.
> > Para esses casos, provavelmente deve funcionar se retornar algo como:

```js
if (
  secureContentListFound.length === 0 &&
  results.pagination.currentPage !== 1
) {
  const lastValidPage = `/${secureUserFound.username}/conteudos/${
    results.pagination.lastPage || 1
  }`;
  const revalidate =
    results.pagination.currentPage > results.pagination.lastPage + 1 ? 60 : 1;
  return {
    redirect: {
      destination: lastValidPage,
    },
    revalidate,
  };
}
```

Obs.: N√£o testei esse c√≥digo e talvez compense refatorar. Talvez usar `context.params.page` no lugar de `results.pagination.currentPage`.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aqui tamb√©m s√≥ faz sentido aparecer a mensagem na p√°gina 1, e podemos redirecionar nas demais quando n√£o houver conte√∫dos.
> > Al√©m disso, para ficar coerente, √© preciso trocar "ainda n√£o fez nenhuma publica√ß√£o." por algo como "ainda n√£o criou nenhuma resposta."
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aqui n√£o faz sentido sugerir publicar novo conte√∫do, j√° que √© a lista de respostas
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ler voc√™ dizendo "resposta" me chamou aten√ß√£o para o uso dessa palavra. Hoje, no e-mail de notifica√ß√£o, recebemos (√™nfase minha):
> > "usuario" _respondeu_ ao seu _coment√°rio_ na publica√ß√£o
> > Na p√°gina de lista de conte√∫dos, aparece "X coment√°rios".
> > Outro lugar que me lembro de existir algo relacionado a "Resposta" √© no bot√£o que est√° escrito "Responder". Me parece que criamos um padr√£o (talvez sem querer) de "responder" ser o verbo, e "coment√°rio" ser o subjetivo.
> > Dito isso, acho que no perfil podemos deixar como Coment√°rios, tanto no texto da aba quanto da mensagem sugerida. Faz sentido?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Dito isso, acho que no perfil podemos deixar como Coment√°rios, tanto no texto da aba quanto da mensagem sugerida. Faz sentido?
> > Sim, faz total sentido! üëç
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > √â melhor trocar o nome dessas vari√°veis para o padr√£o ingl√™s. Seguindo o padr√£o da base de c√≥digo, me parece que o mais adequado seria `rootContentCount` e `childContentCount`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Como mencionado [aqui](https://github.com/filipedeschamps/tabnews.com.br/pull/1577#discussion_r1433901540) com o Felipe, podemos chamar a aba de "Coment√°rios".
> > Coment√°rio de Rafatcb (linha de c√≥digo):

```suggestion
    <DefaultLayout metadata={{ title: `Coment√°rios ¬∑ P√°gina ${pagination.currentPage} ¬∑ ${username}` }}>
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Como estou sugerindo seguir o padr√£o de "responder" para o verbo e "coment√°rio" para o substantivo, acho que podemos mudar na URL tamb√©m.

```suggestion
        paginationBasePath={`/${username}/comentarios`}
```

> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Adicionei e resolveu sim!
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Adicionei esse `textAlign` aqui para centralizar os textos do `title` e `description` em telas menores.
> > Aproveitei para utilizar o `sx` nos componentes.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Utilizei o `forwardRef` para resolver o seguinte warning:
> > Warning: Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use React.forwardRef()?
> > Esse warning acontecia por conta dessa utiliza√ß√£o da tela de perfil:

```jsx
<Button leadingVisual={GearIcon} href="/perfil" as={Link}>
  Editar
</Button>
```

> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > @aprendendofelipe
> > Implementei o redirect que voc√™ tinha comentado e funcionou como o esperado, mas n√£o sei se entendi muito bem esse revalidate, a ideia √© tem um tempo de revalida√ß√£o menor apenas para a pr√≥xima p√°gina depois da √∫ltima?
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Essa condi√ß√£o `|| 0` vai acontecer no caso de usu√°rios "nuked"
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Exatamente isso, a pr√≥xima p√°gina revalida em 1s, mas as demais podem ter um valor maior, j√° que n√£o podem ser criados tantos conte√∫dos de um mesmo usu√°rio e menos de 60 segundos.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho melhor deixar esse Tooltip para `ne` e os outros para `n`. Os √∫nicos casos de Tooltip para `s` que temos no projeto s√£o os que ficam no Header, porque n√£o h√° espa√ßo para cima.
> > Se essa √°rea ficar com pouco conte√∫do mesmo, pode experimentar deixar sem Tooltip, mas com o texto ao lado. Por exemplo: `üü¶ 0 TabCoins üü© 0 TabCash` (talvez em linhas separadas, ou separados por `¬∑`, ou apenas espa√ßados mesmo, precisa testar).
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Esse `leadingVisual` est√° dando erro no console e n√£o est√° funcionando, provavelmente por causa do `as={Link}`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > O `CircleSlashIcon` n√£o est√° aparecendo. N√£o sei qual a forma correta de arrumar isso usando a prop `leadingVisual`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o me parece que precisa desse `as={Link}`, j√° √© renderizado como `<a>` sem ele e com estiliza√ß√£o.
> > Essa prop est√° causando um warning:
> > Warning: React does not recognize the `activeClassName` prop on a DOM element. If you intentionally want it to appear in the DOM as a custom attribute, spell it as lowercase `activeclassname` instead. If you accidentally passed it from a parent component, remove it from the DOM element.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > A sintaxe aqui est√° errada.

```suggestion
    const lastValidPage = `/${secureUserFound.username}/comentarios/${results.pagination.lastPage || 1}`;
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que essa `Label` ficaria melhor ao lado do nome do usu√°rio. Hoje ela s√≥ √© vis√≠vel logo ap√≥s o `nuke`, porque depois o usu√°rio retorna p√°gina 404, mas talvez tenhamos outros `Label`s futuramente e ficar√° melhor ao lado do nome do usu√°rio por causa do [princ√≠pio de proximidade](https://www.nngroup.com/articles/gestalt-proximity/).
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tooltip para cima, como discutido no outro coment√°rio.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu sei que esse c√≥digo j√° estava assim antes, mas voc√™ ou o @aprendendofelipe sabem pra qu√™ precisa do `JSON.parse` e `JSON.stringify`, e n√£o passar diretamente o `secureContentListFound`?
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Ok, vou mudar as dire√ß√µes para n√£o fugir do padr√£o.
> > Vou fazer os esses testes e compartilho os resultados mais tarde.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Aqui n√£o est√° acontecendo esse erro. Pode verificar se atualizou as depend√™ncias? Esse `leadingVisual` faz parte de um breaking change que apareceu na vers√£o 36 do `@primer/react`.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Acho que pode ser o mesmo problema do coment√°rio anterior.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > O `as={Link}` serve para integrar a navega√ß√£o do Next.js, sem ele a navega√ß√£o acontece com um refresh da p√°gina.
> > Esse componente `TabNav` foi atualizado na √∫ltima vers√£o `@primer/react`, depois dessa atualiza√ß√£o j√° n√£o acontecia esse warning aqui no meu ambiente. Se ainda estiver acontecendo mesmo depois de um `npm install` pode me avisar que eu investigo um pouco mais aqui.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Concordo, vou fazer esse ajuste.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Eu n√£o sei, mas vou pesquisar mais tarde para ver se entendo.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ah, tem raz√£o, Erick! Eu lembro do outro PR e estava em d√∫vida porque aqui n√£o estava funcionando em outro local :+1:
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Est√° certo, Erick. Assim como no outro coment√°rio, o erro acontecia tamb√©m por causa da vers√£o que eu tinha instalado localmente. :+1:
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que o bot√£o de Editar fica melhor alinhado "por cima". O que voc√™ acha?
> > | Desktop | Mobile |
> > | ------- | ------ |
> > | | |
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Pensei em deixar mais pr√≥ximo do campo de descri√ß√£o porque as outras informa√ß√µes n√£o pode ser editadas, mas se preferir posso deixar em cima sem problema.
> > Outra possibilidade seria voltar com o dropdown alinhando com o nome do usu√°rio. Optei por mover os bot√µes "Editar" e "Nuke" apenas para ocupar mais espa√ßo na aba "Perfil".
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Utilizei o `forwardRef` para resolver o seguinte warning:
> > Imagino que voc√™ queria usar o `next/link`, ent√£o pode passar `as={NextLink}`.
> > Outra alternativa √© passar o `router.push` no `onClick`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se eles estiverem `undefined` √© melhor n√£o mostrar nada, pois nem sempre os saldos v√£o ser zero ap√≥s o banimento
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Normalmente √© colocado para n√£o dar erro de serializa√ß√£o do JSON se o objeto passado contiver alguma propriedade `undefined`.
> > S√≥ que aparentemente n√£o existe esse risco nesse trecho, ent√£o pode ter ficado esquecido.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Que tal deixar um bot√£o grande com algo como <kbd>Criar descri√ß√£o</kbd> para os casos em que o usu√°rio ainda n√£o preencheu a descri√ß√£o, e deixar apenas o menu para quando ele j√° preencheu?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Que tal criar o componente `TabNavLink` parecido com o que eu fiz abaixo? Pode criar no mesmo arquivo.
> > https://github.com/filipedeschamps/tabnews.com.br/blob/8bc335b5b6820f481572e27157ed9a288eb2a6fc/pages/interface/components/Link/index.js#L24-L32
> > Independentemente disso, voc√™ precisa passar `as={NextLink}` (e n√£o `as={Link}` ) para `TabNav.Link`
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Realmente, deu para resolver com `as={NextLink}`, obrigado!
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Fiz o teste aqui e gostei do resultado:

---

Como bot√£o maior fica assim:

> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Que tal criar o componente `TabNavLink` parecido com o que eu fiz abaixo? Pode criar no mesmo arquivo.
> > Criei o `TabNavLink` e ficou bem melhor!
> > Independentemente disso, voc√™ precisa passar `as={NextLink}` (e n√£o `as={Link}` ) para `TabNav.Link`
> > N√£o tinha notado que existiam essas duas op√ß√µes, com o `NextLink` tudo funcionou como o esperado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > No primeiro item do menu, agora pode retirar o `aria-current={false}`
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Para garantir a coer√™ncia de estiliza√ß√£o, eu resolveria isso com variantes dos `TabCashCount` e `TabCoinCount` > > [Edit] Acabei esquecendo de adicionar o coment√°rio abaixo:
> > Acredito que a maioria da telas menores s√£o celulares, ent√£o acho que o Tooltip n√£o seria uma boa alternativa.
> > Tooltip √© longe do ideal, mas est√° funcionando bem para o Header e para a vers√£o atual da p√°gina `/[username]`, ent√£o acredito que atenderia aqui tamb√©m. Mas o resultado do PR tamb√©m ficou √≥timo. üëç
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Para garantir a coer√™ncia de estiliza√ß√£o, eu resolveria isso com variantes dos `TabCashCount` e `TabCoinCount`
> > Fiz essa refatora√ß√£o, n√£o sei se ficou da melhor forma.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Para garantir a coer√™ncia de estiliza√ß√£o, eu resolveria isso com variantes dos `TabCashCount` e `TabCoinCount`
>
> Fiz essa refatora√ß√£o, n√£o sei se ficou da melhor forma.
> Ficou √≥timo! üëè
> </pull_1577_Filtro de conte√∫dos na p√°gina do usu√°rio>

<pull_1578_feat(primer/react): update version>

## Mudan√ßas realizadas

Atualiza vers√£o da lib `@primer/react`: `35.25.1`-> `36.4.0`
Durante a execu√ß√£o do pr (https://github.com/filipedeschamps/tabnews.com.br/pull/1577) encontrei esse problema (https://github.com/primer/react/issues/3741), nessa nova vers√£o o warning n√£o √© mais exibido.
A vers√£o 36 j√° foi lan√ßada faz alguns meses, e nela tiveram alguns breaking changes que foram descritos aqui: https://github.com/primer/react/discussions/3685
Na pr√°tica apenas 1 breaking change afetou o projeto visualmente, a altera√ß√£o das op√ß√µes de `variant` no componente `FormControl.Validation`, onde a op√ß√£o "warning" foi removida.
O componente `PasswordInput` input foi afetado:
| Antes | Depois |
| ----- | ------ |
E a p√°gina de edi√ß√£o tamb√©m:
| Antes | Depois |
| ----- | ------ |

<!-- Se o PR cont√©m uma modifica√ß√£o da interface gr√°fica (UI), adicione fotos ou v√≠deos comparando o antes e depois. -->
<!-- Se o PR cont√©m modifica√ß√µes de API, mencione os endpoints afetados. -->

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->
<!-- - [x] Corre√ß√£o de bug -->
<!-- - [x] Nova funcionalidade -->
<!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
<!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

- [x] Atualiza√ß√£o de pacote

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (DISMISSED):
  > > Review de Rafatcb (COMMENTED):
  > > Ficou muito legal, Erick :partying_face:. N√£o acho que precisamos mudar o estilo, do jeito que est√° ficou bom.
  > > Deixei uma sugest√£o para melhorar a mensagem do `Flash`.
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Precisamos indicar ao usu√°rio que as informa√ß√µes foram salvas, com exce√ß√£o do e-mail. A verifica√ß√£o `Object.keys(payload).length > 1` √© para verificar se o `email` n√£o foi o √∫nico valor enviado no `payload`.
  > > Se voc√™ pensar numa mensagem melhor, pode trocar. Na condi√ß√£o `false` pensei tamb√©m na mensagem `Altera√ß√£o pendente. Um email de confirma√ß√£o foi enviado para ${email}.`. N√£o sei se ela fica melhor.

```suggestion
          const hasSavedModifications = Object.keys(payload).length > 1;
          const text = hasSavedModifications
            ? `Altera√ß√µes salvas. O email ser√° alterado apenas ap√≥s a confirma√ß√£o pelo link enviado para ${email}.`
            : `Um email de confirma√ß√£o foi enviado para ${email}.`;
          setGlobalMessageObject({ text, type: 'warning' });
```

PS: Se voc√™ for alterar a mensagem, n√£o esque√ßa do ponto final üòÖ

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Boa Rafa!
> > Eu s√≥ evitaria colocar o ponto final ap√≥s o endere√ßo de e-mail. Acho que isso pode causar uma d√∫vida no usu√°rio se foi ele que inseriu esse ponto sem querer.
> > Uma alternativa √© envolver o endere√ßo com aspas, da√≠ n√£o tem problema colocar o ponto final.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Boa!
> > Atualizei as mensagens aqui, o que acham?
> > </pull_1578_feat(primer/react): update version>

<pull_1580_Usando tags mais adequadas para acessibilidade e SEO>

## Mudan√ßas realizadas

Esse PR √© um "sucessor espiritual" do https://github.com/filipedeschamps/tabnews.com.br/pull/992, implementando os coment√°rios que n√£o foram resolvidos. Acabei realizando alguns estudos para usar as tags de forma mais adequada e vou compartilhar aqui o que descobri.
O objetivo do PR √© n√£o ter nenhuma altera√ß√£o visual, mas usar tags semanticamente corretas, o que deve ter um impacto positivo tanto na acessibilidade quanto no SEO.

1. No outro PR havia modifica√ß√µes para associar a `label` ao `input` nos formul√°rios, mas vi na documenta√ß√£o do [FormControl](https://primer.style/components/form-control/react) que ele j√° cuida disso.
2. Agora os campos na cria√ß√£o de conte√∫do tem o `label` vis√≠vel e o marcador de `required`, respeitando a documenta√ß√£o do [Text Input](https://primer.style/components/text-input) e [Forms](https://primer.style/ui-patterns/forms/overview) do Primer. Deixei o `form` da cria√ß√£o de conte√∫do como `noValidate` porque o navegador conseguia realizar a valida√ß√£o do `title` (com estiliza√ß√£o do pr√≥prio navegador), mas n√£o do `body`, ent√£o ficava sem padr√£o.
3. Conforme a documenta√ß√£o de formul√°rios do Primer, o Login e o Coment√°rio n√£o precisam de marca√ß√£o `required` porque j√° √© algo bem esperado. Eu tamb√©m n√£o coloquei no Cadastro, mas talvez fa√ßa sentido por existir um campo ‚Äúemail‚Äù, que a pessoa pode pensar que √© opcional.
4. De acordo com as [especifica√ß√µes](https://html.spec.whatwg.org/multipage/sections.html#the-nav-element), n√£o h√° necessidade em usar `nav` no `footer`.
5. Na [especifica√ß√£o](https://html.spec.whatwg.org/multipage/sections.html#the-article-element) diz que o uso de `article`s aninhados √© para designar conte√∫dos relacionados, e inclusive √© exemplificado que isso serve para coment√°rios num blog.
6. O `address` deve ser usado uma √∫nica vez por `article`. Ou seja, em caso de ter `article`s aninhados, apenas o raiz deve ter `address`. [Refer√™ncia](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/article#usage_notes).
7. Coloquei no c√≥digo `as={viewFrame ? 'article' : undefined}` para que uma nova resposta seja um `article` tamb√©m.
8. Coloquei `list-style` nos itens do header por precau√ß√£o. Testando localmente no Firefox n√£o precisava.

### Corre√ß√£o extra

1. Antes a mensagem de erro ‚Äú_"email" deve conter um email v√°lido._‚Äù n√£o aparecia por causa da condi√ß√£o `!errorObject?.type`.
2. Resolve #941: Como eu estava mexendo no formul√°rio, acabei adicionando o placeholder de exemplo na Fonte. No t√≠tulo eu coloquei com `e.g.` porque acho que ficou meio estranho sem ele, e na fonte achei o contr√°rio hehe.
3. Acho que isso melhora, mas n√£o resolve o problema de https://github.com/filipedeschamps/tabnews.com.br/issues/1397. Como mencionei l√°, parece que existe um c√°lculo do navegador para dar pontua√ß√£o e identificar o conte√∫do para leitura. Apesar de ter feito as melhorias das tags conforme especifica√ß√µes, no ambiente local o resultado do modo leitura n√£o ficou t√£o bom quanto eu esperava.

### Ponto em d√∫vida para melhoria

1. Faz sentido mostrar o label ‚ÄúCorpo‚Äù no caso de resposta? Fiquei em d√∫vida se `Corpo` fica estranho e deveria ser `Resposta` ou `Coment√°rio`. Discutimos no PR https://github.com/filipedeschamps/tabnews.com.br/pull/1577 de usar `Coment√°rio` para o substantivo e `Responder` para a a√ß√£o, mas clicar em `Responder` e ver um campo escrito `Coment√°rio` pode causar confus√£o.

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Trabalho sensacional, @Rafatcb! üëèüëèüëè
  > > E muito importante tamb√©m! üéâüéâüéâ
  > > J√° estou enviando alguns coment√°rios e d√∫vidas para adiantar, mas ainda n√£o revisei tudo üëç
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Testei o Speedreader do Brave [nesse coment√°rio](https://tabnews-oa6ia49df-tabnews.vercel.app/Matrixs0beit/c704cbe1-e37a-4fc7-968f-948183c6ae12) e mesmo usando `article`s corretamente, ele acabou juntando todos os `article`s como se fossem do autor do coment√°rio principal:
  > > Isso est√° me fazendo considerar melhor a ideia de deixar as tags `article` n√£o aninhadas. Talvez no TabNews, dada a import√¢ncia dos coment√°rios, fa√ßa mais sentido deixar cada tag `article` isolada e com sua respectiva tag `address`, data etc.
  > > E seria at√© mais simples fazer isso, pois acho que resolveria tudo no `ViewMode` do `Contents`.
  > > E, nesse caso, pode desconsiderar alguns dos novos coment√°rios, pois s√£o para o caso de continuar aninhando as tags. ü§ù

---

Sobre o box atual dos TabCoins estarem dentro ou fora da tag, acredito que √© indiferente, mas seria bom ter um outro item com o saldo de TabCoins e que ficasse "vis√≠vel" para as ferramentas de acessibilidade.

> > Review de aprendendofelipe (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
>
> 1. Tem algum motivo para a condi√ß√£o do `aria-current` ser diferente da condi√ß√£o para aplicar o `activeLinkStyle`? Fiquei com a impress√£o que deveria ser a mesma condi√ß√£o:
>    O que estamos fazendo com `activeLinkStyle` n√£o est√° totalmente correto, pois a gente est√° identificando visualmente se estamos vendo a lista de "Relevantes" ou de "Recentes", independentemente da pagina√ß√£o, mas isso n√£o est√° coerente com os links ali presentes, pois eles sempre direcionam para a p√°gina 1. Por exemplo, se estou na p√°gina 3 dos "recentes", e clicar em "recentes", que j√° est√° "ativo" pelo `activeLinkStyle`, mesmo assim vai ocorrer uma navega√ß√£o para a primeira p√°gina. Por todas as informa√ß√µes complementares presentes visualmente, n√£o vejo isso como problema para a interface visual, mas acho que n√£o podemos fazer da mesma forma para a acessibilidade.
>    Tamb√©m devemos usar o `aria-current` de forma coerente com o `aria-label`. E a particularidade do TabNews √© que a p√°gina inicial √©, ao mesmo tempo, a primeira p√°gina dos relevantes. Por isso sugeri usar o `aria-label="P√°gina inicial Relevantes"`.
>    Ent√£o ao visitar `/pagina/2` n√£o ficaria coerente o `aria-current={true}` com o `aria-label="P√°gina inicial Relevantes"`. E para ficar ainda mais correto, ao visitar a p√°gina inicial, √© melhor passar `aria-current="page"` no lugar de `true` (diferente da minha sugest√£o inicial).
>    E vale o mesmo para os "recentes", como o link sempre vai para a primeira p√°gina, √© melhor passar `aria-current="page"` na primeira e `false` nas demais.
>    Assim o `aria-current` cuida de identificar corretamente quando j√° estamos na p√°gina daquele link, e a tag `<title>` fica respons√°vel por identificar em qual p√°gina estamos. E por falar na tag `title`, precisa mudar o texto antigo de "Melhores" para "Relevantes" aqui:
>    https://github.com/filipedeschamps/tabnews.com.br/blob/5aa2d497df48d8e70c726f7d604a5a41b0044085/pages/pagina/%5Bpage%5D/index.public.js#L12
> 2. O estilo do `hover` no `TabNews` e `Relevantes` me causou um pouco de estranheza por ficar uma coisa s√≥. O que voc√™ acha?
>    Eu tamb√©m estranhei um pouco, mas acho que foi s√≥ por estar acostumado com um comportamento diferente. Mas agora est√° informando corretamente que o resultado ser√° o mesmo ao clicar em qualquer daqueles itens. Uma informa√ß√£o que parece √≥bvia, mas n√£o √©.
> 3. Tentei usar o Orca do Linux como leitor de tela, mas digamos que n√£o consegui fazer ele funcionar de um jeito que me ajudasse. O `aria-label` √© necess√°rio no `TabCashCount` e `TabCoinCount` porque o `Tooltip` ainda n√£o est√° acess√≠vel? Entrei na [documenta√ß√£o](https://primer.style/components/tooltip/react) e l√° diz _Not reviewed for accessibility_, mas queria confirmar.
>    Isso mesmo! Testei com o JAWS e com o NVDA e n√£o √© lido o `aria-label` do `Tooltip`.
>    > Review de aprendendofelipe (APPROVED):
>    > Coment√°rio de aprendendofelipe (linha de c√≥digo):
>    > Os problemas de deixar fixa a largura reservada para numera√ß√£o ocorrem em telas pequenas, onde nas primeiras p√°ginas n√£o ocupamos todo o espa√ßo dispon√≠vel e nas maiores p√°ginas chega uma hora que falta espa√ßo para o n√∫mero, por exemplo a √∫ltima p√°gina de hoje, a [483](https://www.tabnews.com.br/recentes/pagina/483), fica assim:
>    > | Com gridTemplateColumns | Sem gridTemplateColumns |
>    > | ----------------------- | ----------------------- |
>    > | |
>    > J√° houve debate em torno disso e a conclus√£o foi de que o melhor √© a largura ficar autom√°tica.
>    > Para deixar a largura autom√°tica, e resolver [outros problemas](https://github.com/filipedeschamps/tabnews.com.br/pull/389#issuecomment-1138951784), o @omariosouto usou `display: table` no #403 e, depois, para resolver problemas de _overflow_, eu mudei para `display: grid` com `gridTemplateColumns` no #425.
>    > Se conseguir resolver isso com a lista, acho que faltou colocar `fontWeight: 'semibold'` e `margin: 0` na `ol` e algum espa√ßamento na esquerda dos `li` para n√£o alterar a estiliza√ß√£o atual.
>    > Coment√°rio de aprendendofelipe (linha de c√≥digo):
>    > Se acatar a sugest√£o de alterar o local da tag `article`, pode deixar aqui fixo como `main`
>    > Coment√°rio de aprendendofelipe (linha de c√≥digo):
>    > Que tal assim?

```suggestion
            <BranchName as={isPageRoot ? 'address' : 'div'} sx={{ fontStyle: 'normal' }}>
              <Link href={`/${contentObject.owner_username}`}>{contentObject.owner_username}</Link>
            </BranchName>
```

Dependendo se acatar uma das sugest√µes em outro coment√°rio, trocar o `isPageRoot ? 'address' : 'div'` por `level ? 'div' : 'address' `.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Antes havia a propriedade `level` passada para `RenderChildrenTree`.
> > Talvez seja interessante usar algo parecido ao inv√©s de `isPageRoot`, pois abre possibilidade para outras defini√ß√µes com base na profundidade da √°rvore de coment√°rios.
> > Eu removi a propriedade no a18b8e8cf5e22362206c49b587b59dbe7a9ba103, pois n√£o estava sendo utilizada para nada. O primeiro n√≠vel de coment√°rios come√ßava com 0, mas √© mais interessante come√ßar com 1, pois assim o conte√∫do raiz (ou o coment√°rio principal da p√°gina) fica com level 0 ou indefinido.

```suggestion
            <Content key={contentFound.id} content={contentFound} level={0} mode="view" />
```

ou

```suggestion
            <Content key={contentFound.id} content={contentFound} mode="view" />
```

Mas para n√£o confundir o indexador, talvez seja melhor n√£o colocar a tag `address` nos coment√°rios, mesmo que estejamos na p√°gina deles. Isso tamb√©m se alinha com a ideia de usar a tag can√¥nica direcionando toda p√°gina de coment√°rio para a p√°gina da publica√ß√£o raiz.
Nesse caso, a sugest√£o ficaria:

```suggestion
            <Content key={contentFound.id} content={contentFound} isPageRoot={!rootContentFound} mode="view" />
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Por que criar essa lista?
> > Se ele for mesmo necess√°ria, por que s√≥ para alguns dos itens do header?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      <DefaultLayout metadata={contentMetadata}>
```

Que tal colocar a tag `article` na linha 65 de antes do PR (61 no PR atual)?

```js
<Box as="article" sx={{ width: '100%' }}>
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

S√≥ vi exemplos das tags `article` aninhadas em at√© um n√≠vel, ent√£o estou em d√∫vida se devemos aninhar tudo ou manter todos as tags `article` dos coment√°rios diretamente abaixo da primeira tag `article`.
Provavelmente devemos aninhar tudo, como voc√™ j√° fez, mas acho melhor colocar a tag `article` na linha 258 (nova 255):

```js
<Box as="article" sx={{ width: '100%', pl: '1px', overflow: 'auto' }}>
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho "Corpo" um pouco estranho, n√£o s√≥ para coment√°rio, mas tamb√©m para publica√ß√£o.
> > E se deixarmos "Redija seu texto"?
> > Ou ent√£o deixar algo diferente para cada caso, como "Corpo da publica√ß√£o" e "Seu coment√°rio".
> > Gostaria de ver outras sugest√µes ü§ù
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > √ìtimo exemplo, e eu acredito que isso pode estimular bastante publica√ß√µes do mesmo tipo do exemplo, ent√£o seria legal vermos outras sugest√µes ü§ù
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Obrigado pela observa√ß√£o, Felipe. Eu s√≥ tinha visto at√© a transi√ß√£o de 2 d√≠gitos para 3, e no modo Desktop. Vou revisar o c√≥digo tendo em mente n√∫meros maiores como os das imagens.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Voc√™ pensou em sugest√µes rotativas? Por exemplo, um array com sugest√µes e ao carregar a p√°gina ele pega uma aleat√≥ria e mostra? Isso passou pela minha cabe√ßa, quando estava fazendo. Parece uma ideia legal.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o sei se isso √© intencional, mas essa altera√ß√£o remove o `article` da publica√ß√£o principal, certo? Ficaria assim:
> > Se for intencional, voc√™ sabe me dizer se o `main` cumpre um papel de "`article` principal"? Relendo a [especifica√ß√£o](https://html.spec.whatwg.org/multipage/sections.html#the-article-element), me parece que _sim_:
> > When the main content of the page (i.e. excluding footers, headers, navigation blocks, and sidebars) is all one single self-contained composition, that content may be marked with an [article](https://html.spec.whatwg.org/multipage/sections.html#the-article-element), but it is technically redundant in that case (since it's self-evident that the page is a single composition, as it is a single document).
> > E, levando isso em considera√ß√£o, me parece que n√£o precisariamos do `article` nem mesmo na linha que voc√™ mencionou, ficando assim, tudo dentro do `main` e os coment√°rios dentro de um √∫nico `article`:
> > Por√©m, a remo√ß√£o do `article` que engloba a publica√ß√£o principal traz uma outra consequ√™ncia. Vendo a [especifica√ß√£o](https://html.spec.whatwg.org/multipage/sections.html#the-article-element) do `address`:
> > The [address](https://html.spec.whatwg.org/multipage/sections.html#the-address-element) element [represents](https://html.spec.whatwg.org/multipage/dom.html#represents) the contact information for its nearest [article](https://html.spec.whatwg.org/multipage/sections.html#the-article-element) or [body](https://html.spec.whatwg.org/multipage/sections.html#the-body-element) element ancestor. If that is [the body element](https://html.spec.whatwg.org/multipage/dom.html#the-body-element-2), then the contact information applies to the document as a whole.
> > Esse texto j√° me deixou com um p√© atr√°s de tirarmos o `article` para deixar apenas o `main`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Pelos exemplos da especifica√ß√£o do [`nav`](https://html.spec.whatwg.org/multipage/sections.html#the-nav-element), os itens de um `nav` costumam estar dentro de uma lista. N√£o √© obrigat√≥rio se o conte√∫do n√£o for de fato uma lista. Tem uma parte da especifica√ß√£o que d√° um exemplo de um `nav` que cont√©m texto e diz o seguinte:
> > A [nav](https://html.spec.whatwg.org/multipage/sections.html#the-nav-element) element doesn't have to contain a list, it can contain other kinds of content as well.
> > Revendo o c√≥digo agora, parece que eu deveria ter adicionado um `nav` nessa parte tamb√©m. Criei um `Box` apenas para isso (talvez eu devesse usar a tag diretamente, `<nav>`), depois reveja o c√≥digo para dizer se faz sentido, por favor.
> > Se ele for mesmo necess√°ria, por que s√≥ para alguns dos itens do header?
> > Essa lista engloba a navega√ß√£o principal do site (p√°gina inicial, relevantes e recentes, sendo as duas primeiras a mesma p√°gina). O menu de usu√°rio j√° est√° englobado num `nav`, que cont√©m uma lista.
> > Faz sentido meu racioc√≠nio?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Com a remo√ß√£o do `Text` acabei precisando atualizar o `py: '2px'` para `1px` do `ReadTime` e `PastTime`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Estava com dificuldade na estiliza√ß√£o, mas [essa resposta](https://stackoverflow.com/a/73062690/8839059) ajudou muito e consegui corrigir os problemas.
> > [Screencast da pagina√ß√£o alta](https://github.com/filipedeschamps/tabnews.com.br/assets/26308880/7c7d98f9-ce38-4518-b34d-0281642d39e8)
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Mas para n√£o confundir o indexador, talvez seja melhor n√£o colocar a tag `address` nos coment√°rios, mesmo que estejamos na p√°gina deles. Isso tamb√©m se alinha com a ideia de usar a tag can√¥nica direcionando toda p√°gina de coment√°rio para a p√°gina da publica√ß√£o raiz.
> > Me parece que faz mais sentido. N√£o consegui encontrar muita informa√ß√£o com exemplos, mas se partirmos do ponto que "artigos aninhados n√£o devem ter `address`", e o coment√°rio na sua pr√≥pria p√°gina √© igual ao coment√°rio na p√°gina da publica√ß√£o principal, podemos supor que ele n√£o deve ter `address` ali tamb√©m. Isso fica √† margem da interpreta√ß√£o, mas nada impede de mudarmos no futuro se surgir alguma informa√ß√£o melhor.
> > E nesse caso, acho at√© melhor mudar o nome da vari√°vel de `isPageRoot` para `isRootContent`. Isso simplifica a passagem de props, j√° que posso obter a informa√ß√£o pelo `contentObject.parent_id === null`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Fiz essa mudan√ßa, creio que tenha ficado melhor do que antes. N√£o consegui pensar num label melhor agora.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Revendo os coment√°rios do PR hoje, eu fiz essa altera√ß√£o e coloquei um print com ela no [outro coment√°rio](https://github.com/filipedeschamps/tabnews.com.br/pull/1580#discussion_r1437942293):
> > Percebi que, apesar de agora os TabCoins e setas de voto n√£o estarem dentro do `article`, os referentes ao `article` aninhado est√£o. N√£o sei se isso afetar√° negativamente, mas j√° est√° no PR. O ideal seria essas informa√ß√µes serem desconsideradas (e talvez sejam), considerando apenas o autor, data e conte√∫do.
> > Dito isso, voc√™ acha melhor deixar assim mesmo ou voltar a como estava antes, cada `article` englobando os TabCoins do pr√≥prio coment√°rio?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            <Box as="article" sx={{ width: '100%', pl: '1px', overflow: 'auto' }}>
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que n√£o precisa de uma nova vari√°vel:

```suggestion
            <BranchName as={contentObject.parent_id ? 'div' : 'address'} sx={{ fontStyle: 'normal' }}>
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    <PrimerHeader as="header" id="header" sx={{ minWidth: 'max-content', px: [2, null, null, 3] }}>
```

Necess√°rio para evitar isso:

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Entendi, e como a tag `nav` n√£o exige a lista, melhor manter sem, n√£o √©? Provavelmente a ferramenta j√° busque todos os links dentro da tag.
> > E na mesma linha, ser√° que n√£o √© melhor colocarmos apenas os links para "Relevantes" e "Recentes" dentra da `nav`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Eu n√£o tinha pensado em sugest√µes rotativas, mas adorei a ideia. üéâ
> > Dada a import√¢ncia, talvez isso mere√ßa at√© um PR separado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o foi intencional. A presen√ßa do `Content` em modo compacto me confundiu. üëç
> > Concordo que √© melhor o principal tamb√©m estar dentro da tag `article`.
> > Acho que podemos mover o `Box` da linha 65 e colocar ele antes do `Box` da 35, com a tag `article` nele.
> > Isso vai englobar corretamente o conte√∫do principal sem mudar nada na estiliza√ß√£o atual.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Resposta no https://github.com/filipedeschamps/tabnews.com.br/pull/1580#pullrequestreview-1798846365
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Entendi, e como a tag `nav` n√£o exige a lista, melhor manter sem, n√£o √©? Provavelmente a ferramenta j√° busque todos os links dentro da tag.
> > Acho que semanticamente faz mais sentido ter lista. Os exemplos da especifica√ß√£o que s√£o apenas links, cont√©m lista:

```html
<nav>
  <h1>Navigation</h1>
  <ul>
    <li><a href="articles.html">Index of all articles</a></li>
    <li><a href="today.html">Things sheeple need to wake up for today</a></li>
    <li><a href="successes.html">Sheeple we have managed to wake</a></li>
  </ul>
</nav>
```

A exce√ß√£o (exemplo sem lista) tem essa cara:

```html
<nav>
  <h1>Navigation</h1>
  <p>
    You are on my home page. To the north lies <a href="/blog">my blog</a>, from
    whence the sounds of battle can be heard. To the east you can see a large
    mountain, upon which many <a href="/school">school papers</a> are littered.
    Far up thus mountain you can spy a little figure who appears to be me,
    desperately scribbling a <a href="/school/thesis">thesis</a>.
  </p>
  <p>
    To the west are several exits. One fun-looking exit is labeled
    <a href="https://games.example.com/">"games"</a>. Another more
    boring-looking exit is labeled <a href="https://isp.example.net/">ISP‚Ñ¢</a>.
  </p>
  <p>
    To the south lies a dark and dank <a href="/about">contacts page</a>.
    Cobwebs cover its disused entrance, and at one point you see a rat run
    quickly out of the page.
  </p>
</nav>
```

> E na mesma linha, ser√° que n√£o √© melhor colocarmos apenas os links para "Relevantes" e "Recentes" dentra da `nav`?
> Acho que √© ruim ter o `TabNews` como um link duplicado de `Relevantes`, mas essa altera√ß√£o prejudicaria a funcionalidade de "pular a navega√ß√£o" que leitores de tela possuem. Cita√ß√£o da segunda observa√ß√£o na [especifica√ß√£o](https://html.spec.whatwg.org/multipage/sections.html#the-nav-element):
> User agents (such as screen readers) that are targeted at users who can benefit from navigation information being omitted in the initial rendering, or who can benefit from navigation information being immediately available, can use this element as a way to determine what content on the page to initially skip or provide on request (or both).
> Eu pensei em tornar o `TabNews` um `h1` do `nav`, mas tenho a impress√£o que seria uma experi√™ncia ruim n√£o poder clicar no nome do site para navegar para a p√°gina de Relevantes. O √∫nico site com comportamento similar que consegui pensar foi o [Stack Overflow](https://stackoverflow.com/), que o link do logo e o de `Questions` vai para a mesma p√°gina, mas o `Questions` est√° num `nav` e o logo n√£o est√° em nenhum.
> Se formos usar o Stack Overflow como refer√™ncia, ficaria assim:

- `TabNews` fora do `nav`.
- Cada item de navega√ß√£o sendo um `li`.
- Sem `h1` no `nav`.
  Acho que podemos seguir essa op√ß√£o.
  Edit: Percebi que o GitHub, na [p√°gina inicial](https://github.com/), tem o mesmo padr√£o que o Stack Overflow, e usa lista mesmo tendo um √∫nico item (_Dashboard_).
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > N√£o tinha percebido porque isso n√£o ocorre no Firefox, mas consegui reproduzir no Chromium. Obrigado pelo coment√°rio!
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Melhorando a minha sugest√£o anterior, de acordo com o texto da revis√£o.

```suggestion
          <HeaderLink href="/" aria-label="P√°gina inicial Relevantes" aria-current={asPath === '/' ? 'page' : false}>
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            aria-current={asPath === '/recentes' ? 'page' : false}
```

</pull_1580_Usando tags mais adequadas para acessibilidade e SEO>

<pull_1581_Criar p√°gina para o FAQ>

## Mudan√ßas realizadas

Esse PR √© a continua√ß√£o do https://github.com/filipedeschamps/tabnews.com.br/pull/1210. Continuei em Markdown porque ele j√° estava em Markdown, provavelmente porque viu os Termos de Uso assim. Ser√° que n√£o vale a pena usar componentes/tags HTML ao inv√©s de Markdown? Isso trar√° maior flexibilidade, por exemplo com o uso de √¢ncoras nos t√≠tulos, e menor depend√™ncia sobre o ByteMD. As √¢ncoras como est√£o (com `<div>`) ficam com `user-content` no id.
Abri um PR para o `CONTRIBUTING.md`, ent√£o j√° deixei uma men√ß√£o para esse arquivo na pergunta _Como posso contribuir com o TabNews?_ no FAQ.
Algumas refer√™ncias usadas na cria√ß√£o do FAQ:

- [TabNews - Nova melhoria: TabCoins, TabCash e Melhorias no Layout üéâ](https://www.tabnews.com.br/filipedeschamps/nova-melhoria-tabcoins-tabcash-e-melhorias-no-layout)
- [TabNews - Tentando construir um peda√ßo de internet mais massa](https://www.tabnews.com.br/filipedeschamps/tentando-construir-um-pedaco-de-internet-mais-massa)
- https://github.com/filipedeschamps/tabnews.com.br/issues/1490
  A pergunta _N√£o consigo criar novas publica√ß√µes. O que fazer?_ √© para abordar a d√∫vida do issue https://github.com/filipedeschamps/tabnews.com.br/issues/1540.

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->
<!-- - [x] Corre√ß√£o de bug -->

- [x] Nova funcionalidade
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Show @Rafatcb! üí™üí™üí™
  > > Pensando nessa p√°gina ter mais uma fun√ß√£o did√°tica do que realmente colocar as perguntas de acordo com a frequ√™ncia em que aparecem, eu dividiria o texto em mais perguntas e respostas.
  > > E tamb√©m mudaria um pouco a ordem, pois acho que antes de falar de TabCoins, √© preciso falar de TabCash e, antes disso, falar o que √© o TabNews e sobre os conte√∫dos.
  > > Acho interessante tamb√©m explicar que tanto "Publica√ß√µes" como "Coment√°rios" s√£o tratados como "Conte√∫dos". E poderia utilizar apenas "conte√∫dos" em algumas das repeti√ß√µes de "publica√ß√µes e/ou coment√°rios".
  > > Outras sugest√µes est√£o no c√≥digo, mas vejam com cuidado, pois talvez nem todas fa√ßam sentido. E como n√£o sei se ser√° aceita a proposta de dividir em mais perguntas, acabei n√£o dividindo tanto como eu gostaria. üòÖ
  > > Ser√° que n√£o vale a pena usar componentes/tags HTML ao inv√©s de Markdown? Isso trar√° maior flexibilidade, por exemplo com o uso de √¢ncoras nos t√≠tulos, e menor depend√™ncia sobre o ByteMD. As √¢ncoras como est√£o (com `<div>`) ficam com `user-content` no id.
  > > Para resolver os problemas citados, al√©m de facilitar a manuten√ß√£o, seja nos textos ou em mudan√ßas de estiliza√ß√£o, eu acho melhor criar um array de objetos com as perguntas e respostas, onde apenas as respostas podem ser escritas em markdown.
  > > Analisando aqui, parece que poder√≠amos atualizar a ordem de algumas coisas no rodap√©
  > > Hoje est√° em ordem alfab√©tica para facilitar a adi√ß√£o de itens sem se preocupar em que posi√ß√£o colocar.
  > > N√£o vejo problemas em mudar esse crit√©rio, mas talvez seria bom deixar o novo crit√©rio documentado como coment√°rio no c√≥digo para facilitar aos contribui√ß√µes que venham a adicionar novos itens.
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Ainda precisa ajustar algumas coisas, como o conte√∫do de algumas respostas e talvez a ordem das perguntas.
  > > Adicionei uma tabela de conte√∫do antes das perguntas para facilitar encontrar algo espec√≠fico, j√° que o FAQ ficou mais extenso.
  > > Deixei coment√°rios espec√≠ficos no c√≥digo.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > @Rafatcb, fiz novos coment√°rios no c√≥digo.
  > > Dessa vez n√£o analisei as perguntas e respostas.
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > @Rafatcb, a implementa√ß√£o ficou TOP! üöÄüöÄüöÄ
  > > Sobre as perguntas e respostas, algumas eu acho que merecem debates maiores antes de serem inseridas no FAQ. Principalmente as que podem influenciar os comportamentos, mas tamb√©m as que tentam definir algo que nunca foi bem definido anteriormente.
  > > E acho que um debate assim n√£o vai ocorrer na revis√£o do PR, e talvez nem nas issues, ent√£o estava pensando que seria interessante publicar a pergunta no pr√≥prio TabNews, explicando no corpo que o questionamento est√° sendo feito para basear a resposta do FAQ.
  > > O que acha dessa ideia?
  > > Mas muitas respostas aqui j√° est√£o √≥timas, ent√£o acho que podemos selecionar algumas e j√° enviar o FAQ para produ√ß√£o, pois assim quem for contribuir nos debates ter√° uma vis√£o melhor de onde as respostas criadas v√£o ser expostas. Ou prefere primeiro definir as respostas para as perguntas que j√° est√£o colocadas no PR antes de enviar para produ√ß√£o?
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Criar uma publica√ß√£o do tipo "O que voc√™ acha que deveria estar no FAQ?"
  > > Eu n√£o perguntaria isso enquanto n√£o respondermos as perguntas que j√° temos. Prefiro colocar a pergunta que queremos responder e ver o que a Turma responde. Come√ßaria com a pergunta "O que √© o TabNews?". E esperaria a Turma interagir bastante antes de lan√ßar a pr√≥xima pergunta.
  > > Eu concordo em deixar as que est√£o prontas e fazer o merge, j√° d√° um contexto para as pessoas e evita dispersar muito a discuss√£o. Quais voc√™ acha que dever√≠amos remover?
  > > Eu s√≥ acho que precisa ser removida a pergunta sobre o tipo de conte√∫do. A resposta sobre o que √© o TabNews pode at√© ficar, mas eu mudaria o texto e ID da pergunta.
  > > O resto ficou show! üëèüëèüëè Bora! üöÄüöÄüöÄ
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de filipedeschamps (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > N√£o sei se os _TabCoins s√£o o ponto central do TabNews para estimular a gera√ß√£o de conte√∫do de qualidade_. Acho que n√£o. Pelo menos n√£o diretamente. Independentemente de ser ou n√£o, essa frase n√£o est√° muito esclarecedora pra mim.
  > > O que acha de algo assim?

### O que √© TabCoin?

_TabCoin √© a moeda de troca no sistema de qualifica√ß√£o de conte√∫dos do TabNews. Voc√™ utiliza seus TabCoins para qualificar conte√∫dos dos outros e, por sua vez, recebe ou perde TabCoins com base nas qualifica√ß√µes recebidas em seus pr√≥prios conte√∫dos._
Da√≠ mais detalhes s√£o dados nas respostas para outras perguntas, como:

- Como utilizar meus TabCoins?
- Como ganhar TabCoins?
- √â poss√≠vel perder TabCoins?
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Sem falar de TabCash, essa parte pode causar em algumas pessoas um pensamento do tipo _U√©, por que vou querer gastar meus TabCoins? Ainda mais tendo o "trabalho" de qualificar conte√∫dos?_
  > > O uso da palavra "gastar", assim como "perder" (presente em outro trecho), tamb√©m pode contribuir com uma ideia equivocada.
  > > Talvez essa explica√ß√£o se enquadre melhor em outro trecho do FAQ, para responder a pergunta:

### Como ganhar TabCash?

_Para ganhar TabCash, √© necess√°rio contribuir com a qualifica√ß√£o de conte√∫dos, consumindo 2 TabCoins a cada qualifica√ß√£o realizada e, ao mesmo tempo, ganhando 1 TabCash._

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Colocaria esse trecho como resposta para a pergunta:

```suggestion
  ## Como ganhar TabCoins?
  As formas de ganho de TabCoins s√£o:
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  ## √â poss√≠vel perder TabCoins?
  Sim, voc√™ pode perder TabCoins:
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  ## Como utilizar meus TabCoins?
  Os TabCoins s√£o utilizados para poder qualificar conte√∫dos de outros usu√°rios e ajudar a comunidade a identificar conte√∫dos relevantes.
  Ao avaliar uma publica√ß√£o, ser√£o consumidos 2 TabCoins e creditados 2 TabCash nos seus saldos.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  - **Recebendo votos negativos:** voc√™ perder√° 1 TabCoin a cada avalia√ß√£o negativa recebida de outros usu√°rios em seus conte√∫dos.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  ## O que √© TabCash?
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  ## Como ganhar TabCash?
  Para ganhar TabCash, √© necess√°rio contribuir com a qualifica√ß√£o de conte√∫dos de outras pessoas, consumindo 2 TabCoins a cada qualifica√ß√£o realizada e, ao mesmo tempo, ganhando 1 TabCash.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se n√£o pode ter conte√∫do repetido, √© melhor excluir a parte "para ter mais aten√ß√£o e receber mais TabCoins".
> > Mas fiquei confuso com o trecho abaixo:
> > _Um conte√∫do antigo, de meses ou anos, pode ser publicado como **um novo conte√∫do**, e n√£o uma c√≥pia, porque o contexto √© diferente e novas pessoas poder√£o ler a publica√ß√£o._
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Eu acho que sei o que voc√™ quer dizer com "O TabNews n√£o √© uma rede social", mas acho melhor n√£o colocar isso, pois o TabNews pode ser classificado como um tipo "espec√≠fico" de rede social
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > √â muito comum falarmos apenas o T da TI, mas acho que esse trecho merece a forma completa, para restringir √† "tecnologia da informa√ß√£o". Mas n√£o acho que √© preciso restringir tanto, ao ponto de s√≥ ser aceito o que √© relacionado com "desenvolvimento de software". Acredito que o TabNews √© aberto para assuntos de TI em geral.
> > O que acham?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que √© interessante adicionar aqui que nem toda publica√ß√£o sobre um projeto que estou envolvido ser√° um pitch. √â poss√≠vel (talvez at√© prefer√≠vel) fazer uma publica√ß√£o focada nos aspectos t√©cnicos sem fazer um pitch do projeto/produto.
> > Deixando ainda mais claro que o contr√°rio √© que √© o problema. N√£o √© permitido fazer apenas o pitch, sem trazer conte√∫do t√©cnico de valor, independentemente de ter ou n√£o `Pitch` no t√≠tulo.
> > N√£o sei se √© interessante j√° citar, mas acho que isso ser√° permitido futuramente com o uso de TabCash.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que n√£o √© melhor fazer isso pelo pr√≥prio GitHub?
> > https://github.com/filipedeschamps/tabnews.com.br/security/advisories/new
> > Aqui acho importante o @filipedeschamps opinar.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ser√° que n√£o √© melhor fazer isso pelo pr√≥prio GitHub?
> > Eu pensei nisso, e na minha mem√≥ria eu tinha deixado as duas op√ß√µes, mas isso foi no PR #1583: https://github.com/filipedeschamps/tabnews.com.br/pull/1583/files#diff-eca12c0a30e25b4b46522ebf89465a03ba72a03f540796c979137931d8f92055R30.
> > Conforme o Filipe responder, posso deixar apenas a op√ß√£o do GitHub mesmo e j√° atualizo o outro PR tamb√©m.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Para mim, "tecnologia da informa√ß√£o" √© um termo mais confuso.
> > Por "tecnologia" entendo que posso falar de design (de sistemas/aplicativos/sites), intelig√™ncia artificial, desenvolvimento de software, de jogos, modelagem, edi√ß√£o de v√≠deos, hardware etc. Esse segundo par√°grafo acabou falando _"trabalha em √°reas diretamente ou indiretamente relacionadas ao desenvolvimento de software"_ porque copiei parte dos Termos de Uso.
> > Posso tentar melhorar o texto e colocar uma lista de assuntos como exemplo dentro dessa pergunta, como fiz acima, j√° que a √∫nica lista que existe atualmente √© do tipo de conte√∫do (artigos, not√≠cias...)
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Mas fiquei confuso com o trecho abaixo:
> > Vou explicar o que quis dizer com cada parte da frase abaixo. Se voc√™ ter uma sugest√£o e como deixar mais claro, ser√° √≥timo. O objetivo dessa pergunta √© defender o TabNews dos abusadores, mas deixar claro que o conte√∫do de valor pode ser repetido "sem spam".
> > Um conte√∫do antigo, de meses ou anos, pode ser publicado
> > Hoje, nosso problema √© quando republicam algo que foi publicado h√° pouco tempo, geralmente n√£o dando um m√™s de diferen√ßa.
> > como **um novo conte√∫do**, e n√£o uma c√≥pia
> > A pessoa pode republicar algo, mas n√£o um Ctrl+C e Ctrl+V.
> > porque o contexto √© diferente
> > _Quando_ a publica√ß√£o √© feita √© algo bastante relevante para alguns assuntos. Por exemplo, falar sobre IA gerativa no fim de 2023 √© totalmente diferente de falar sobre IA gerativa no come√ßo de 2022.
> > e novas pessoas poder√£o ler a publica√ß√£o.
> > Se foi uma publica√ß√£o boa (e o ideal √© s√≥ republicarem publica√ß√µes boas, tendo ou n√£o uma boa visibilidade na √©poca), pode ser que eu tenha visto e me lembre, mas depois de um ano ter√£o muitos usu√°rios novos que n√£o viram isso na √©poca, ent√£o esse pode ser um conte√∫do de valor hoje, mesmo sendo "repetido".
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Usei um array de objetos mas acho que n√£o foi exatamente isso que voc√™ quis dizer, @aprendendofelipe. As perguntas ainda s√£o interpretadas como markdown, com o `user-content` no `id`. Fiquei em d√∫vida se voc√™ pensou em usar um `Viewer` para cada resposta.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Enquanto refazia o FAQ, passou pela minha cabe√ßa que seria legal usar os identificadores de TabCoin e TabCash ao falar deles, para o leitor associar as representa√ß√µes, mas isso demandaria deixar de usar markdown nas respostas tamb√©m.
> > Aqui seria um lugar legal de se ter, por exemplo.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Precisa pensar em como tratar links internos. No estado atual, est√° _hard coded_, ent√£o as chances s√£o altas de realizar uma mudan√ßa e esquecer de atualizar o link e a pergunta.
> > Como esse t√≥pico ainda ser√° modificado, talvez acabe ficando sem link para outra pergunta ent√£o podemos "ignorar" esse problema a princ√≠pio.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o consegui pensar agora em como melhorar o texto de forma explicar isso sem dar uma brecha para quem s√≥ quer divulgar. Voc√™ tem alguma sugest√£o?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Com exce√ß√£o dos links externos no final, que n√£o acho necess√°rio, ficou um crit√©rio bastante subjetivo, ent√£o vai voltar a ser algo que cada contribuidor poder√° alterar como achar melhor.
> > No m√≠nimo isso cria uma complica√ß√£o extra em cada adi√ß√£o de links ao footer, ent√£o eu s√≥ trocaria o crit√©rio de ordem alfab√©tica se for para usar outro crit√©rio objetivo.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Minha sugest√£o foi para usar um `Viewer` para cada resposta e n√£o usar o `ByteMD` para os t√≠tulos.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° interessante poder vincular usando s√≥ a √¢ncora da pergunta e o link ser criado automaticamente com o t√≠tulo sempre atualizado, mas isso exige um novo plugin para o visualizador, que talvez seja usado tamb√©m em marca√ß√£o de usu√°rios e outros casos, ent√£o √© para outro PR.
> > Mas j√° poderia deixar nesse PR os IDs das perguntas desvinculado do texto da pergunta. Tentar criar um padr√£o simples que n√£o precise ser alterado quando a pergunta ou a resposta for reformulada. Assim diminui as chances de quebrar links adicionados em publica√ß√µes dentro ou fora do TabNews.
> > Uma op√ß√£o de padr√£o seria focar no conte√∫do principal da resposta, ao inv√©s da pergunta. Por exemplo:
> > | Pergunta | ID |
> > | ---------------------------------- | ---------------------- |
> > | O que √© T? | `#T` |
> > | Posso publicar estando negativado? | `#publicar_negativado` |
> > | √â poss√≠vel perder TabCoins? | `#perda_tabcoins` |
> > | Como funciona U? | `#como_U` |
> > | Como fazer V? | `#como_V` |
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > D√° para aceitarmos outros formatos para a resposta, mas deixaria isso como melhoria futura.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Diminu√≠ para um √∫nico par√°grafo, acho que ficou mais claro e ao mesmo tempo deixou menos margem √† interpreta√ß√£o:
> > N√£o. Se deseja criar uma nova publica√ß√£o sobre o mesmo assunto, leve em considera√ß√£o h√° quanto tempo o conte√∫do foi feito e o qu√£o diferente ser√° a nova publica√ß√£o. Lembre-se que toda publica√ß√£o est√° sujeita √† qualifica√ß√£o por outros usu√°rios atrav√©s do uso de TabCoins, e casos de abuso ser√£o tratados pela modera√ß√£o. Apagar um conte√∫do avaliado negativamente e republic√°-lo para tentar chamar mais aten√ß√£o √© um exemplo de **manipula√ß√£o das qualifica√ß√µes** e poder√° resultar no banimento permanente da sua conta, como dito nos [Termos de Uso](/termos-de-uso).
> > _"leve em considera√ß√£o h√° quanto tempo o conte√∫do foi feito a publica√ß√£o e o qu√£o diferente ser√° a nova publica√ß√£o."_ √© um crit√©rio subjetivo, mas o objetivo √© que a pessoa n√£o republique a mesma coisa, e tamb√©m n√£o publique "mudando um pouco" na mesma semana ou m√™s.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Modifiquei a resposta para dar alguns exemplos e tentar deixar mais claro:
> > O conte√∫do publicado no TabNews deve estar diretamente relacionado √† tecnologia. Podem ser not√≠cias, artigos, tutoriais, indica√ß√µes, curiosidades, sugest√µes de software e ferramentas, perguntas bem formuladas ou qualquer outro tipo de conte√∫do que poder√° fazer alguma diferen√ßa na vida de quem trabalha em √°reas diretamente ou indiretamente relacionadas √† √°rea de tecnologia.
>
> Alguns exemplos de assuntos diretamente relacionados √† tecnologia s√£o: desenvolvimento de software, an√°lise de dados, design, intelig√™ncia artificial, modelagem 3D, edi√ß√£o de v√≠deo, manipula√ß√£o de imagens etc. Exemplos de assuntos indiretamente relacionados √† tecnologia, mas que podem ser abordados do ponto de vista da tecnologia, s√£o: produtividade, empreendedorismo, cria√ß√£o de conte√∫do etc.
>
> Conte√∫dos que se encaixam na defini√ß√£o acima, mas n√£o possuem valor concreto, que s√£o de baixa qualidade ou divulgam informa√ß√µes erradas, ser√£o negativados por outros usu√°rios por meio do uso das TabCoins como forma de desestimular esse tipo de conte√∫do e garantir a qualidade do que est√° presente no TabNews.
>
> Conte√∫dos que n√£o se encaixam nessa defini√ß√£o poder√£o ser removidos pela modera√ß√£o do TabNews, conforme os [Termos de Uso](/termos-de-uso).
> Voc√™ acha que ficou abrangente demais? Tem alguma sugest√£o de melhoria?
>
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Consegui elaborar um pouco mais essa parte, separando a publica√ß√£o que o autor est√° falando sobre um projeto que est√° envolvido, mas o projeto n√£o √© o foco, da publica√ß√£o que √© um pitch, ou seja, uma divulga√ß√£o do projeto:
> > Sim, voc√™ pode criar uma publica√ß√£o sobre um projeto que est√° envolvido desde que agregue valor ao leitor, por exemplo explicando detalhes t√©cnicos do projeto, compartilhando suas experi√™ncias na cria√ß√£o, dificuldades e decis√µes tomadas.
>
> Se voc√™ pretende fazer um pitch, ou seja, uma apresenta√ß√£o curta e direta com o objetivo despertar aten√ß√£o das pessoas para o projeto em si, voc√™ deve colocar `Pitch` no t√≠tulo da publica√ß√£o, por exemplo: `Pitch: TabInvest ‚Äî Um TabNews sobre investimentos`. Mesmo sendo um pitch voc√™ deve contribuir com a comunidade como explicado no par√°grafo anterior.
>
> Uma divulga√ß√£o de um projeto que voc√™ est√° envolvido deve seguir as mesmas regras de qualquer outra publica√ß√£o: leia os [Termos de Uso](/termos-de-uso) e o t√≥pico [Que tipo de conte√∫do eu posso publicar no TabNews?](#publicar-tabnews). Publica√ß√µes com foco exclusivo comercial s√£o expressamente proibidas.
>
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Como mudei no PR do `CONTRIBUTING.md` (#1583), resolvi mudar aqui tamb√©m, j√° direcionando para a documenta√ß√£o do GitHub como tutorial e o link para reportar o problema no reposit√≥rio do TabNews. Acho melhor assim mesmo porque todos mantenedores do reposit√≥rio podem ver o problema, ao inv√©s de precisar repassar o problema pelo e-mail de contato.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
import { Box, DefaultLayout, Heading, Link, Text, Viewer } from '@/TabNewsUI';
import { LinkIcon } from '@/TabNewsUI/icons';
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o s√≥ as negativadas, mas as zeradas tamb√©m podem podem estar bloqueando a nova publica√ß√£o:

```suggestion
      answer: `Se, ao criar uma nova publica√ß√£o ou coment√°rio, voc√™ recebe uma mensagem de erro dizendo que n√£o √© poss√≠vel publicar porque h√° outras publica√ß√µes mal avaliadas que ainda n√£o foram exclu√≠das, revise seus conte√∫dos mais recentes que est√£o zerados ou negativados. Essa √© uma prote√ß√£o para o TabNews e para o usu√°rio, impedindo a cria√ß√£o de muitas publica√ß√µes mal recebidas e permitindo que o usu√°rio analise o que est√° fazendo de errado e corrija seu comportamento.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Apesar da resposta conter informa√ß√µes importantes sobre o TabNews, acho que ela n√£o responde o que √© o TabNews.
> > Acho que est√° sendo respondido o "porqu√™ do TabNews ter sido criado".
> > Acho que compensa manter essa resposta com alguma adapta√ß√£o na pergunta (trocando tamb√©m o ID para deixar o `#tabnews` dispon√≠vel).
> > Ent√£o a pergunta original "O que √© o TabNews?" seria uma √≥tima op√ß√£o de primeira pergunta para se fazer diretamente para a Turma e ver o que coletamos de respostas.
> > O que acha?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que essa √© a mais complexa. A pergunta √© sobre "tipo de conte√∫do", e a resposta fala sobre os "assuntos" e a "qualidade do conte√∫do". Mas "tipo de conte√∫do" tamb√©m pode ser entendido como o "formato dos conte√∫dos". Talvez compense dividir essa pergunta.

### Formato

Pra mim os tipos (formatos) de conte√∫dos aceitos atualmente s√£o: "texto, imagens (hospedadas externamente), trechos de c√≥digos de programa√ß√£o, f√≥rmulas matem√°ticas, diagramas, links para conte√∫dos externos, etc.
Outra forma de classificar os tipos √© como estava numa vers√£o anterior da resposta: not√≠cias, artigos, tutoriais, indica√ß√µes, curiosidades, sugest√µes, perguntas etc. "Agradecimento" tamb√©m entra nessa lista, mas a√≠ como algo que n√£o desejamos. Uma resposta que poderia entrar algum dia, se conseguirmos chegar em uma boa resposta, √© porque mensagens que s√≥ contenham agradecimento n√£o s√£o desejadas.
Essa parte do "tip" √© a mais "f√°cil" de responder, mas n√£o sei se compensa colocar isso no FAQ. Talvez sim, mais para a segunda forma de classificar do que a primeira, mas precisa ter um "etc." para n√£o "proibir" outros "tipos" de conte√∫dos que n√£o pensamos agora.

### Assuntos

Esse ponto eu acredito que nunca foi bem definido. Talvez a falta de defini√ß√£o clara seja intencional e, se for, ser√° que faz sentido colocar uma resposta vaga no FAQ?
A resposta fala em "tecnologia", mas qualquer tecnologia? Pode ser sobre tecnologia de produ√ß√£o de alimentos, de perfura√ß√£o de solo, de constru√ß√£o de barragens ou sobre avia√ß√£o, por exemplo? Talvez mec√¢nica, eletr√¥nica, qu√≠mica, naval ou aeroespacial?
√â normal usar a palavra "tecnologia" solta assim quando o contexto deixa claro de qual tecnologia se est√° falando, mas n√£o √© o caso aqui no FAQ. E citar exemplos n√£o ajuda a restringir de que tecnologias podemos falar no TabNews.
Pela sua resposta (https://github.com/filipedeschamps/tabnews.com.br/pull/1581#discussion_r1437564486), eu interpreto como "assuntos relacionados √† tecnologia da informa√ß√£o (TI)", que j√° √© algo bem abrangente e alinhado com o que acredito que foi o objetivo original (pelo que vemos na Newsletter), mas n√£o posso ter certeza nem sobre o objetivo original, nem sobre o que voc√™ entende como assunto esperado. E dessa forma n√£o podemos esperar que qualquer um que ler vai interpretar de uma forma saud√°vel.
Estou insistindo nesse ponto porque, de verdade, n√£o tenho certeza sobre a resposta para essa pergunta. Eu amo tecnologia, tanto as exemplificadas no PR, como as que eu coloquei mais acima, mas desconfio que nem todas entre as que eu citei seriam bem recebidas.
E falar em ser "bem recebidas" me faz pensar que, na verdade, n√£o podemos tentar restringir muito os assuntos, e quem deve decidir se algo √© bem vindo ou n√£o √© a pr√≥pria comunidade, atrav√©s das qualifica√ß√µes.
Nesse caso, a pergunta a ser respondida seria mais no sentido de "quais assuntos s√£o mais esperados de se encontrar no TabNews", pois isso ajuda a dar um norte para quem est√° em d√∫vida sobre como qualificar algum conte√∫do, mas n√£o limitando algu√©m em d√∫vida sobre poder ou n√£o postar sobre outros assuntos.
Tamb√©m pode fazer sentido responder sobre quais tipos de assuntos n√£o se pode publicar, mas tentaria n√£o exemplificar e limitaria a resposta a quest√µes legais, por exemplo "√© proibido utilizar o TabNews para violar leis ou incitar a viola√ß√£o". Talvez isso tamb√©m n√£o precise estar no FAQ, mas apenas nos termos de uso. N√£o sei bem üòï

### Qualidade

Falar baixa ou alta qualidade sem especificar crit√©rios √© mais ou menos como falar tecnologia sem especificar qual. Cada um vai interpretar como quiser.
Acho melhor s√≥ falar em qualidade (e talvez at√© em valor concreto) no FAQ quando pudermos dizer quais ser√£o os crit√©rios. N√£o sei se isso ser√° poss√≠vel, mas √© algo que tamb√©m podemos perguntar para a Turma e ver se chegamos em algo que possa vir para o FAQ. Tor√ßo para que sim, mas √© poss√≠vel que n√£o se chegue em um consenso e seja melhor deixar os crit√©rios de qualidade para cada um decidir. Talvez cheguemos a alguns crit√©rios, e possamos citar aqui, mas ainda deixando aberto para outros crit√©rios pessoais.

### Conclus√£o

Eu tentaria ir publicando de tempos em tempos algumas perguntas pontuais que, se respondidas com algum alinhamento pela Turma, possam nos ajudar a ir estabelecendo os crit√©rios que colocaremos no FAQ.
Faz sentido?

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Entendo seu ponto. Qual t√≠tulo voc√™ acha que a resposta atual poderia ter? Se ficar dif√≠cil pensar, podemos tirar. Como eu estava cogitando tirar, [resolvi pedir sugest√µes ao ChatGPT](https://chat.openai.com/share/95dcfe44-4f18-421a-8207-20359833674f) antes. Acho que isso pode fazer sentido, mas estou aberto a sugest√µes:

- Qual √© o prop√≥sito do TabNews?
  > Ent√£o a pergunta original "O que √© o TabNews?" seria uma √≥tima op√ß√£o de primeira pergunta para se fazer diretamente para a Turma e ver o que coletamos de respostas.
  > Tudo bem. Pode ser feita depois do merge do PR, e provavelmente no in√≠cio da semana, para receber mais aten√ß√£o. Voc√™ quer criar a publica√ß√£o ou eu crio?
  >
  > > Coment√°rio de Rafatcb (linha de c√≥digo):

### Formato

> Outra forma de classificar os tipos √© como estava numa vers√£o anterior da resposta: not√≠cias, artigos, tutoriais, indica√ß√µes, curiosidades, sugest√µes, perguntas etc
> Essa parte ainda est√° na resposta! Olha:
> O conte√∫do publicado no TabNews deve estar diretamente relacionado √† tecnologia. Podem ser not√≠cias, artigos, tutoriais, indica√ß√µes, curiosidades, sugest√µes de software e ferramentas, perguntas bem formuladas ou qualquer outro tipo de conte√∫do que poder√° fazer alguma diferen√ßa na vida de quem trabalha em √°reas diretamente ou indiretamente relacionadas √† √°rea de tecnologia.
> Acha que essa parte responde o ponto do "tipo"?
> Entendo que acabei misturando coisas diferentes ao longo dos par√°grafos.

### Assunto

> Esse ponto eu acredito que nunca foi bem definido. Talvez a falta de defini√ß√£o clara seja intencional e, se for, ser√° que faz sentido colocar uma resposta vaga no FAQ?
> Acho que o fato de n√£o ter isso bem definido j√° causou bastante "problema". Existem √©pocas que as pessoas reclamam mais sobre isso, ultimamente est√° bem tranquilo. Usu√°rios ativos j√° comentaram sobre verem essa falta de defini√ß√£o como "problema", e eu tendo a concordar.
> Estou insistindo nesse ponto porque, de verdade, n√£o tenho certeza sobre a resposta para essa pergunta. Eu amo tecnologia, tanto as exemplificadas no PR, como as que eu coloquei mais acima, mas desconfio que nem todas entre as que eu citei seriam bem recebidas.
> Sabe o que eu acho? Que todas as que voc√™ sugeriu podem ser aceitas. Sobre o "bem recebidas", se for uma publica√ß√£o bem feita, tenho minhas d√∫vidas se seria negativada. Talvez s√≥ n√£o fosse positivada por n√£o ter um p√∫blico consumidor disso na plataforma.
> Fiz uma publica√ß√£o essa semana sobre o [Street Fighter II](https://www.tabnews.com.br/rafael/curiosidades-sobre-o-street-fighter-ii-e-a-placa-de-arcade-cps-1) e contei algumas curiosidades. O fato de ser um jogo, ter imagens e GIF, ajudou a ser mais bem recebida, al√©m do Filipe ter compartilhado no Twitter. Mas acho que se algu√©m publicasse sobre como funcionam os tratores de planta√ß√£o de semente (n√£o sei nem se o que eu disse faz sentido) de uma forma "curiosa" assim, poderia conseguir bons TabCoins tamb√©m.
> Tamb√©m pode fazer sentido responder sobre quais tipos de assuntos n√£o se pode publicar, mas tentaria n√£o exemplificar e limitaria a resposta a quest√µes legais, por exemplo "√© proibido utilizar o TabNews para violar leis ou incitar a viola√ß√£o". Talvez isso tamb√©m n√£o precise estar no FAQ, mas apenas nos termos de uso. N√£o sei bem üòï
> Penso que os Termos de Uso sejam mais adequados para esse ponto espec√≠fico.

### Qualidade

> Acho melhor s√≥ falar em qualidade (e talvez at√© em valor concreto) no FAQ quando pudermos dizer quais ser√£o os crit√©rios. N√£o sei se isso ser√° poss√≠vel, mas √© algo que tamb√©m podemos perguntar para a Turma e ver se chegamos em algo que possa vir para o FAQ. Tor√ßo para que sim, mas √© poss√≠vel que n√£o se chegue em um consenso e seja melhor deixar os crit√©rios de qualidade para cada um decidir. Talvez cheguemos a alguns crit√©rios, e possamos citar aqui, mas ainda deixando aberto para outros crit√©rios pessoais.
> Bom ponto.

### Conclus√£o

> Faz sentido?
> Vou tentar falar com o Filipe para ver a opini√£o dele sobre a parte do "Assunto". Se algu√©m est√° acompanhando esse issue e est√° vendo esse coment√°rio, j√° deixe a sua opini√£o tamb√©m.
> Tendo uma resposta do Filipe ou n√£o, vou precisar reformular essa parte, talvez separando em duas perguntas e tirando a parte da qualidade. Me responda sobre a parte do "tipo", que coloquei logo no in√≠cio do coment√°rio, que me ajudar√° nas edi√ß√µes :smiley:
>
> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Turma, vim pelo email do Rafa e lendo a discuss√£o, ela foi muito importante, mas a partir daqui acredito que podemos entrar no est√°gio de `diminishing returns`. Ambas linhas de racioc√≠nio s√£o boas, possuem uma certa sobreposi√ß√£o no que faz sentido para mim e o que eu pude experimentar do dia a dia do TabNews.
> > Sugest√£o: faz o merge, faz esse conte√∫do encostar na entropia do jeito que est√° mesmo e volta nesse assunto quando ele nos chamar novamente, seja por necessidade (deu algum problema) ou seja por carinho nosso em querer melhorar o que foi feito ü§ù
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
>
> - Qual √© o prop√≥sito do TabNews?
>   Essa pergunta ficaria melhor para a resposta dada, mas bora adiante nesse assunto! ü§ù
>   > Coment√°rio de Rafatcb (linha de c√≥digo):
>   > Ok, comentei para lembrarmos de mudar isso aqui: https://github.com/filipedeschamps/tabnews.com.br/issues/1380#issuecomment-1888853812
>   > </pull_1581_Criar p√°gina para o FAQ>

<pull_1582_Criar p√°gina sobre a evolu√ß√£o do TabNews (da concep√ß√£o ao lan√ßamento) no museu>

## Mudan√ßas realizadas

Esse PR √© uma continua√ß√£o do PR https://github.com/filipedeschamps/tabnews.com.br/pull/946, realizando modifica√ß√µes conforme coment√°rios. A inten√ß√£o da p√°gina √© mostrar, de forma impessoal, a evolu√ß√£o do TabNews desde o surgimento da ideia at√© o dia do lan√ßamento. Tirei alguns poucos detalhes do outro PR. Talvez mais pudessem ser tirados. Adicionei mais links de refer√™ncia ao longo do texto.
Resolvi criar uma p√°gina no pr√≥prio estilo do site porque, apesar de ser do Museu, n√£o h√° necessidade de ter estiliza√ß√£o pr√≥pria, j√° que ela conta uma hist√≥ria ao inv√©s de ser a pr√≥pria hist√≥ria, como s√£o as sugest√µes de design do TabNews.
Fiz com Markdown pelo mesmo motivo mencionado no FAQ (padr√£o), mas como √© uma p√°gina do Museu, n√£o vejo problema em continuar como Markdown. Ser√° uma p√°gina bem menos acessada e n√£o temos necessidade de √¢ncoras para os t√≠tulos, por exemplo.
As imagens n√£o estarem hospedadas no pr√≥prio TabNews pode ser uma preocupa√ß√£o, mas pensei em colocar no Wayback Machine e outros arquivadores assim que o PR for mergeado, o que possibilitar√° que tenhamos um backup das imagens em caso de necessidade. Tamb√©m coloquei um `alt` descritivo em todas as imagens.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Show @Rafatcb! üí™
  > > Quando eu sugeri (https://github.com/filipedeschamps/tabnews.com.br/pull/946#issuecomment-1860200900) deixar o texto mais impessoal, s√≥ estava falando sobre o estilo do texto, que ficou melhor agora, mas n√£o que o autor deveria ser ocultado.
  > > Ent√£o poderia deixar a informa√ß√£o de que o @gabrielsozinho foi o autor e o @Rafatcb o revisor. Isso pode ficar logo abaixo do t√≠tulo. O que acham?
  > > Uma coisa que me preocupa √© se um dia perdermos imagens t√£o legais que est√£o no artigo, mas hospedadas fora do nosso controle, em `imgur.com` e `user-images.githubusercontent.com`. Acham que teria como recuperar, ou √© melhor j√° garantir e deixar sob nossa responsabilidade?
  > > Review de aprendendofelipe (DISMISSED):
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        <Text as="h2">
          Artigo
```

E se um dia adicionarmos outros, muda o texto para "Artigos".
Eu tamb√©m levaria esse t√≥pico para o topo da p√°gina, por ser algo mais recente e completo. E criaria um outro `h2` para os primeiros layouts.
</pull_1582_Criar p√°gina sobre a evolu√ß√£o do TabNews (da concep√ß√£o ao lan√ßamento) no museu>

<pull_1583_Criar o CONTRIBUTING.md>

## Mudan√ßas realizadas

Neste PR temos:

1. Cria√ß√£o do guia `CONTRIBUTING.md`.
2. Ajustes no `README.md`, movendo informa√ß√µes sobre como executar o projeto para o `CONTRIBUTING.md`, e deixando apenas as informa√ß√µes sobre o projeto e contribuidores.
   Resolve #605

## Tipo de mudan√ßa

<!-- - [x] Corre√ß√£o de bug -->
<!-- - [x] Nova funcionalidade -->
<!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->

- [x] Atualiza√ß√£o de documenta√ß√£o

  > > Review de aprendendofelipe (COMMENTED):
  > > Fora o que dei mais detalhes nos coment√°rios, em alguns pontos eu apenas tentei criar outra reda√ß√£o que transmitisse a mesma informa√ß√£o.
  > > As mudan√ßas podem ter sido para deixar o texto mais claro, sucinto e/ou com menos repeti√ß√µes de palavras.
  > > Tamb√©m tentei evitar palavras do tipo "todo" e "sempre", pois fazem afirma√ß√µes muito fortes, que nem sempre s√£o verdadeiras
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de diegosano (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Acho que pode deixar como voc√™ sugeriu no final: üëç
  > > Quando as revis√µes forem feitas e aceitarem seu c√≥digo, ele poder√° ser mergeado por um mantenedor do reposit√≥rio, e ent√£o as suas modifica√ß√µes estar√£o rodando em produ√ß√£o üéâ.
  > > Como ainda vai fazer esse ajuste, vou comentar outros pontos para voc√™ pensar se compensa mudar:

- Voc√™ est√° usando a palavra "mergeado". Chegou a pensar em usar um termo em portugu√™s, talvez "mesclado"? Eu tento usar mais termos em portugu√™s do que aportuguesados, mas √†s vezes fica estranho mesmo. üòÖ
- O t√≠tulo "Tabela de conte√∫do" n√£o √© de uma tabela (j√° que n√£o h√° a coluna com a numera√ß√£o das p√°ginas), ent√£o √© uma "Lista do conte√∫do", mas tamb√©m n√£o precisamos avisar que √© uma lista, ent√£o pode ser suficiente deixar o t√≠tulo como "Conte√∫do:".

- Por fim, pense sobre o t√≠tulo do t√≥pico sobre o PR, conforme o https://github.com/filipedeschamps/tabnews.com.br/pull/1583#discussion_r1459103362
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Para concordar com a palavra "voc√™" mais adiante

```suggestion
A seguir, temos um guia para lhe ajudar a contribuir com o TabNews atrav√©s de _issues_ e _pull requests_. Se voc√™ ficar com alguma d√∫vida sobre o processo, [fa√ßa uma pergunta](https://github.com/filipedeschamps/tabnews.com.br/issues/new?labels=d√∫vida&projects=&template=3_question.yml) na parte de issues deste reposit√≥rio.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o acha melhor deixar para colocar aqui a resposta para a pergunta "O que √© o TabNews?", quando tivermos essa resposta? Ou ent√£o, por enquanto, deixar apenas a primeira frase desse par√°grafo?
> > √Ä partir de "Queremos ter conte√∫do..." fica algo muito datado, como um texto das origens do projeto. D√° a impress√£o de que foi escrito antes do lan√ßamento e ainda n√£o foi atualizado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
Esse reposit√≥rio cont√©m o c√≥digo-fonte do site e da API do TabNews.
O TabNews disponibiliza APIs p√∫blicas que voc√™ pode utilizar para construir outros projetos relacionados, desde que respeite os [Termos de Uso](https://www.tabnews.com.br/termos-de-uso).
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Essa parte pode ser mais sucinta, j√° que tem o link que leva para os templates e cont√©m as mesmas informa√ß√µes. Fica menos repetitivo e tamb√©m evita o v√≠nculo desse arquivo com as mudan√ßas nos templates.

```suggestion
Sugest√µes e reporte de bugs s√£o feitos atrav√©s de issues. Antes de criar um novo, [pesquise se o assunto j√° est√° sendo abordado](https://github.com/filipedeschamps/tabnews.com.br/issues) e complemente o debate com o seu ponto de vista ou com uma sugest√£o de implementa√ß√£o, se necess√°rio.
Para abrir um issue, utilize os templates dispon√≠veis clicando em [nova issue](https://github.com/filipedeschamps/tabnews.com.br/issues/new/choose).
O t√≠tulo, descri√ß√£o e coment√°rios devem ser feitos em portugu√™s.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
Caso tenha encontrado alguma falha de seguran√ßa, pedimos que [reporte de forma privada pelo GitHub](https://github.com/filipedeschamps/tabnews.com.br/security/advisories/new). Isso permite discutir detalhes da vulnerabilidade de modo privado com os mantenedores do reposit√≥rio sem o vazamento da vulnerabilidade ou de informa√ß√µes confidenciais.
Voc√™ pode seguir [o tutorial do GitHub](https://docs.github.com/pt/code-security/security-advisories/guidance-on-reporting-and-writing-information-about-vulnerabilities/privately-reporting-a-security-vulnerability#privately-reporting-a-security-vulnerability) sobre como fazer esse tipo de relato.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que essa Turma √© a que tinha acesso ao reposit√≥rio ainda privado em 25 de Junho de 2021, tendo efetivamente participado ou n√£o, certo?
> > √â uma turma muito importante, tanto que est√£o eternizados no museu, mas pensando na fun√ß√£o do README, n√£o acho interessante colocar isso aqui, pois ningu√©m que est√° chegando agora ter√° a chance de entrar nessa lista.
> > A lista que j√° temos hoje, que √© criada pelo contrib.rocks com dados do GitHub, faz mais sentido estar no README, pois √© um incentivo extra para as pessoas que est√£o chegando aqui para colaborarem com o c√≥digo.
> > Ser√° legal se um dia o GitHub ajudar criando outras listas din√¢micas que incluam quem colabora de outras formas. Mas seria legal para deixarmos din√¢mico no site. Aqui no README eu focaria nos que contribu√≠ram com o c√≥digo.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Eu n√£o sei exatamente como o [contrib.rocks](https://github.com/lacolaco/contributors-img) puxa os dados da API do GitHub, mas n√£o podemos afirmar que s√£o "todas as pessoas que j√° realizaram algum commit", pois:

- Tem gente que j√° realizou commits no projeto, mas como n√£o foram mesclados na `main`, essas pessoas n√£o est√£o na lista.
- Dependendo de como o contrib.rocks puxa os dados da API, a lista pode ficar limitada aos 100 contribuidores que o GitHub chama de "principais".
- Mesmo antes de chegar no limite de 100, j√° tem pelo menos um dos coautores que n√£o entrou na lista, mesmo com o commit mesclado (pode ser inconsist√™ncia no email do commit).
  Como n√£o temos controle sobre quem entre na lista, eu acho melhor deixar como estava, sem legenda.

  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Alguns dos pr√≥ximos pontos, que v√£o al√©m de um primeiro contato e execu√ß√£o local do projeto, poderiam ir para a parte de contribuir com c√≥digo:

- Lint
- Migrations
- Commits
  J√° o conte√∫do colocado sobre "Frontend" e "Backend", eu acho que n√£o s√£o informa√ß√µes para estarem nem no CONTRIBUTING e nem no README
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > F√°ceis e simples s√£o relativos. üòÖ
  > > E dizer que s√£o "ideais para quem nunca interagiu com o c√≥digo do TabNews" pode dar a entender que quem j√° √© contribuidor n√£o deveria nos ajudar com essas issues.

```suggestion
Se voc√™ est√° procurando algo para desenvolver como sendo a sua primeira intera√ß√£o com o c√≥digo do reposit√≥rio, voc√™ pode procurar por [issues com o label _"good first issue"_](https://github.com/filipedeschamps/tabnews.com.br/contribute), que s√£o tarefas que n√£o exigem conhecimento aprofundado sobre o c√≥digo do TabNews, e que s√£o poss√≠veis at√© para quem nunca fez uma contribui√ß√£o para um projeto de c√≥digo aberto.
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Para concordar com a palavra "voc√™" mais adiante
> > Deixei minha marca de santista aqui sem perceber :laughing: ([Refer√™ncia](http://dx.doi.org/10.21165/el.v49i1.2456))
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > J√° o conte√∫do colocado sobre "Frontend" e "Backend", eu acho que n√£o s√£o informa√ß√µes para estarem nem no CONTRIBUTING e nem no README
> > Pensei que a parte do Primer seria √∫til porque j√° vi pessoas sugerindo (em issues) a adi√ß√£o de componentes de UI que n√£o tem nada a ver com o design system do GitHub, e tamb√©m j√° vi em PR o autor usar uma estiliza√ß√£o "normal" ao inv√©s de usar componentes do Primer com `sx`, por exemplo.
> > Voc√™ acha que essa informa√ß√£o n√£o cabe em nenhum lugar mesmo?
> > Coment√°rio de diegosano (linha de c√≥digo):
> > Deixando meus 2 centavos aqui, seria bom ter nesse trecho instru√ß√µes de como √© feito uma contribui√ß√£o em um projeto open source, fazer o fork do projeto, clonar localmente, etc.
> > Ou ent√£o colocar links que tenham essas instru√ß√µes, por exemplo essas duas documenta√ß√µes do pr√≥prio GitHub, um ensina [como contribuir para um projeto Open Source](https://opensource.guide/pt/how-to-contribute/) e tem as instru√ß√µes de [como abrir um PR](https://opensource.guide/pt/how-to-contribute/#abrindo-um-pull-request) e outro de [como manter o fork sincronizado](https://docs.github.com/pt/pull-requests/collaborating-with-pull-requests/working-with-forks/syncing-a-fork) com as altera√ß√µes do reposit√≥rio original
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > @diegosano, como n√£o √© algo espec√≠fico do TabNews, isso foge do foco do documento.
> > N√≥ m√°ximo colocaria os links recomendados, mas ficaria como uma recomenda√ß√£o pessoal de quem est√° escrevendo o documento.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > j√° vi pessoas sugerindo (em issues) a adi√ß√£o de componentes de UI que n√£o tem nada a ver com o design system do GitHub
> > O problema n√£o √© fugir do design system do GitHub, mas fugir do design system do TabNews. O nosso √© apenas baseado no do GitHub, que √© uma √≥tima refer√™ncia que estamos seguindo.
> > A biblioteca Primer ajuda a criar nossas p√°ginas e componentes com design baseado no do GitHub, mas nem sempre ela √© a melhor op√ß√£o para qualquer componente.
> > e tamb√©m j√° vi em PR o autor usar uma estiliza√ß√£o "normal" ao inv√©s de usar componentes do Primer com `sx`, por exemplo.
> > Est√£o presentes no c√≥digo do TabNews diversas formas de estiliza√ß√£o. O Primer tem suas recomenda√ß√µes (que mudaram para deixar o `sx` como padr√£o, mas n√£o era assim). A gente tem que avaliar cada caso com as nossas particularidades, onde a principal √© ser compat√≠vel com a forma que utilizamos o NextJS.
> > Voc√™ acha que essa informa√ß√£o n√£o cabe em nenhum lugar mesmo?
> > Acho que cabe numa documenta√ß√£o sobre decis√µes que foram tomadas, junto das justificativas, mas o reposit√≥rio j√° √© isso.
> > √â claro que organizar algumas dessas informa√ß√µes na Wiki seria muito √∫til, mas tamb√©m seria um enorme trabalho que s√≥ seria poss√≠vel com muita colabora√ß√£o para manter sempre atualizado. E se isso n√£o for atualizado, pode atrapalhar mais do que ajudar.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Faz sentido. Vou deixar temporariamente a primeira frase.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Entendi seu ponto.
> > Uma d√∫vida sobre seu primeiro coment√°rio:
> > Alguns dos pr√≥ximos pontos, que v√£o al√©m de um primeiro contato e execu√ß√£o local do projeto, poderiam ir para a parte de contribuir com c√≥digo:
> > Voc√™ quis dizer para adicionar os t√≥picos citados como subt√≥pico de `Enviar PRs com solu√ß√µes previamente debatidas`, no `CONTRIBUTING.md`, ap√≥s o texto que existe hoje?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Pensei em adicionar no final da linha 42:

```
Para mais detalhes sobre a cria√ß√£o de um pull request, consulte a [documenta√ß√£o do GitHub](https://docs.github.com/pt/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork).
```

Que tal?
N√£o parece ter um link na documenta√ß√£o com todas as informa√ß√µes, mas a partir desse link o leitor pode ir para os outros citados, conforme ter d√∫vidas sobre o processo. Eu achei o texto em portugu√™s bem confuso por causa dos termos, mas pensei em usar ele pelo reposit√≥rio ser em portugu√™s, e quem quiser pode mudar o texto da documenta√ß√£o para ingl√™s.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Voc√™ quis dizer para adicionar os t√≥picos citados como subt√≥pico de `Enviar PRs com solu√ß√µes previamente debatidas`, no `CONTRIBUTING.md`, ap√≥s o texto que existe hoje?
> > Isso ou, se achar que faz mais sentido, colocar inclusive o PR dentro de um novo t√≥pico como "Desenvolver o c√≥digo-fonte", "Evoluir o c√≥digo-fonte" ao algo assim:

- Lint
- Migrations
- Commits
- **PR**
  Nesse caso, parte do que est√° no t√≥pico PR pode subir para o do c√≥digo-fonte.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Aqui fiz uma pequena altera√ß√£o de _reporte de bugs_ para _reportes de bugs_.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > O fim do `CONTRIBUTING.md` ainda est√° mencionando algo sobre isso:
  > > Quando as revis√µes forem feitas e aceitarem seu c√≥digo, ele poder√° ser mergeado por um mantenedor do reposit√≥rio, e ent√£o as suas modifica√ß√µes estar√£o rodando em produ√ß√£o üéâ. Al√©m disso, voc√™ entrar√° para a [lista de contribuidores](https://github.com/filipedeschamps/tabnews.com.br/graphs/contributors), aparecer√° no [README.md](/README.md#contribuidores) e tamb√©m na p√°gina de [Status](https://www.tabnews.com.br/status) no site do TabNews.
  > > Se quiser que mude algo, pode falar :+1:
  > > Edit: Pelo o que vi, n√£o s√£o todos [contribuidores](https://github.com/filipedeschamps/tabnews.com.br/graphs/contributors) (71) que aparecem na imagem (68) mesmo, e como o GitHub s√≥ mostrar√° 100, talvez seja melhor retirar o final da frase, ficando assim:
  > > Quando as revis√µes forem feitas e aceitarem seu c√≥digo, ele poder√° ser mergeado por um mantenedor do reposit√≥rio, e ent√£o as suas modifica√ß√µes estar√£o rodando em produ√ß√£o üéâ.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Deixei o t√≠tulo do subt√≥pico como `Enviar PRs com solu√ß√µes previamente debatidas` para continuar dando √™nfase ao "solu√ß√µes previamente debatidas".
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Talvez n√£o precise de tanta √™nfase assim. Acho suficiente a indica√ß√£o que j√° existe no documento para se debater primeiro nas issues. Isso deve ser o padr√£o, mas n√£o uma obriga√ß√£o.
  > > At√© porque existem casos em que uma PoC, ou uma corre√ß√£o simples para algum problema que algu√©m tenha encontrado, pode fazer sentido virar diretamente um PR.
  > > Faz sentido?
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Tudo bem. Renomeio para "Enviar pull requests" ent√£o? Vou aproveitar e mudar o in√≠cio da resposta que est√° `... novo Pull Request` para `... novo pull request`. Na outra pergunta (`Participar de revis√µes de Pull Requests (PRs)`) eu deixei as letras em mai√∫sculo para destacar a abrevia√ß√£o.
  > > </pull_1583_Criar o CONTRIBUTING.md>

<pull_1584_Salvar Email no autocomplete ao inv√©s do Nome de Usu√°rio no Cadastro>

## Mudan√ßas realizadas

Ao realizar o cadastro, os gerenciadores de senha dos navegadores sugeriam salvar a combina√ß√£o Nome de Usu√°rio + Senha. Pesquisando, encontrei uma [solu√ß√£o](https://stackoverflow.com/a/57902690/8839059) para salvar Email + Senha sem precisar alterar a ordem dos campos.
O PR cont√©m duas altera√ß√µes:

- Novo atributo `autocomplete="username"` no campo de email para orientar o gerenciador de senha dos navegadores.
- Mudan√ßa do `id` do campo de Nome de Usu√°rio para n√£o confundir o gerenciador de senhas do Bitwarden. O `name` foi modificado apenas para ficar igual ao `id`. Nos testes que realizei, o gerenciador de senha dos navegadores n√£o precisavam dessa altera√ß√£o.
  Nenhuma mudan√ßa foi necess√°ria na tela de Login.

### Teste com o gerenciador do Firefox e Bitwarden:

[Screencast](https://github.com/filipedeschamps/tabnews.com.br/assets/26308880/5536f95f-fa4c-43bb-87af-59f32a3be7ed)

### Teste com o gerenciador do Chromium:

[Screencast](https://github.com/filipedeschamps/tabnews.com.br/assets/26308880/f37d13b7-7c60-48f9-b0b7-8317cb278a04)
Resolve #943

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR.

- [x] Corre√ß√£o de bug
<!-- - [x] Nova funcionalidade -->
<!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
<!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1584_Salvar Email no autocomplete ao inv√©s do Nome de Usu√°rio no Cadastro>

<pull_1588_Cria duas novas p√°ginas de listas de conte√∫dos recentes: Publica√ß√µes+Coment√°rios e S√≥ Coment√°rios>

## Mudan√ßas realizadas

Adiciona as novas p√°ginas em modo beta, por isso ainda n√£o foram adicionados links para os novos endere√ßos:

- [`/recentes/todos/[page]`](https://www.tabnews.com.br/recentes/todos/1)
- [`/recentes/comentarios/[page]`](https://www.tabnews.com.br/recentes/comentarios/1)

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
      </pull_1588_Cria duas novas p√°ginas de listas de conte√∫dos recentes: Publica√ß√µes+Coment√°rios e S√≥ Coment√°rios>

<pull_1589_Identificar o autor da publica√ß√£o principal da p√°gina nos coment√°rios>

## Mudan√ßas realizadas

### Pendente

1. Alguma sugest√£o de nome melhor do que "Autor" para esse label? Experimentei colocar "Autor(a)", achei um pouco estranho mas talvez seja apenas falta de costume. PS: Hoje "Autor" j√° √© usado no Tooltip da lista de conte√∫dos, ent√£o se for alterado aqui, ser√° alterado l√° tamb√©m.
   | Autor | Autor(a) |
   | ----- | -------- |
   | | |
   | |
2. Com o andamento do PR do FAQ para chamar tudo de "conte√∫do", talvez fa√ßa sentido trocar o texto de `Autor da publica√ß√£o principal da p√°gina` para `Autor do conte√∫do principal da p√°gina`.

### Detalhes da implementa√ß√£o

- N√£o consegui pensar num nome melhor para as vari√°veis, ent√£o estou aberto a sugest√µes.
- Talvez remover o `overflow: "auto"` tenha criado algum bug, mas fiz testes com textos longos e com Zalgo, est√° funcionando como esperado. Precisei remover por causa do Tooltip (a √∫nica outra forma que encontrei seria usar `position: "absolute"`, que traria outros problemas). Isso permitiu remover o `position: "absolute"` do `PastTime` tamb√©m.
- O Tooltip n√£o possui detec√ß√£o autom√°tica dos cantos da tela para ter uma exibi√ß√£o melhor, ent√£o do jeito que est√°, o comportamento n√£o fica legal em algumas situa√ß√µes espec√≠ficas, como um coment√°rio muito aninhado em uma tela pequena.
- Tirei as divs que encapsulavam o `ViewModeOptionsMenu` e n√£o percebi o bug do flicker. N√£o sei como ele era antes, ent√£o seria bom revisarem isso com aten√ß√£o, porque ou eu reproduzi errado ou a pr√≥pria biblioteca Primer j√° corrigiu isso.
  Resolve #972

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.

  > > Review de aprendendofelipe (COMMENTED):
  >
  > 1. Alguma sugest√£o de nome melhor do que "Autor" para esse label?
  >    Por acessibilidade, e visual mais limpo, acho melhor deixar apenas "Autor".
  > 2. Com o andamento do PR do FAQ para chamar tudo de "conte√∫do", talvez fa√ßa sentido trocar o texto de `Autor da publica√ß√£o principal da p√°gina` para `Autor do conte√∫do principal da p√°gina`.
  >    Faz sentido. E na mesma linha, acho que no PR #1577 a URL deveria ter ficado como `[username]/publicacoes` no lugar de `[username]/conteudos`.
  >
  > - Talvez remover o `overflow: "auto"` tenha criado algum bug
  >   Voltou [bug conhecido](https://github.com/filipedeschamps/tabnews.com.br/pull/462#issuecomment-1172967129). Comentei no c√≥digo sobre como testar isso.
  >   Precisei remover por causa do Tooltip (a √∫nica outra forma que encontrei seria usar `position: "absolute"`, que traria outros problemas). Isso permitiu remover o `position: "absolute"` do `PastTime` tamb√©m.
  >   Eterno problema do Tooltip. üòï
  > - O Tooltip n√£o possui detec√ß√£o autom√°tica dos cantos da tela para ter uma exibi√ß√£o melhor, ent√£o do jeito que est√°, o comportamento n√£o fica legal em algumas situa√ß√µes espec√≠ficas, como um coment√°rio muito aninhado em uma tela pequena.
  >   Tomara que um dia criem o modo autom√°tico, pois faz muita falta.
  > - Tirei as divs que encapsulavam o `ViewModeOptionsMenu` e n√£o percebi o bug do flicker. N√£o sei como ele era antes, ent√£o seria bom revisarem isso com aten√ß√£o, porque ou eu reproduzi errado ou a pr√≥pria biblioteca Primer j√° corrigiu isso.
  >   N√£o √© problema da biblioteca, mas do layout. Acho que isso deve ser poss√≠vel resolver de outras formas. Deixei coment√°rio no c√≥digo sobre como testar.
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Ser√° que compensa criar um Tooltip customizado, adaptando o do Primer?
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (APPROVED):
  >   > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  >   > Estando logado, d√™ F5 nas p√°gina abaixo e ver√° que na vers√£o desse PR existe um pequeno deslocamento de layout ap√≥s o t√©rmino do loading do usu√°rio que faz renderizar o bot√£o

- https://tabnews-git-identify-author-tabnews.vercel.app/filipedeschamps/tentando-consertar-o-oveflow-do-body
- https://tabnews-git-fork-smrsassa-main-tabnews.vercel.app/filipedeschamps/tentando-consertar-o-oveflow-do-body

  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Veja o scroll horizontal criado por causa do estouro do √∫ltimo coment√°rio na p√°gina abaixo. No Chrome n√£o est√° dando problema, mas no Firefox sim. Compare as duas vers√µes:

- https://tabnews-git-identify-author-tabnews.vercel.app/filipedeschamps/tentando-consertar-o-oveflow-do-body
- https://tabnews-git-fork-smrsassa-main-tabnews.vercel.app/filipedeschamps/tentando-consertar-o-oveflow-do-body
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Entendi. Isso acontece porque o bot√£o est√° na mesma `div` do nome do usu√°rio (e outras informa√ß√µes), mas o bot√£o √© mais alto do que o nome do usu√°rio, e o bot√£o n√£o √© renderizado inicialmente por n√£o ter o `user` definido, ent√£o quando ele √© renderizado, a altura da `div` aumenta.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Fiz alguns testes, os melhores resultados foram definindo uma altura fixa para a linha, mas isso prejudicava a experi√™ncia caso o conte√∫do quebrasse em duas linhas. Resolvi deixar o `position: absolute` mesmo e adicionei mais informa√ß√µes ao coment√°rio, e tamb√©m adicionei um `mr: '28px'` na linha, para considerar que existe um elemento ali.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Por causa do `overflow: hidden` em um elemento antecessor e da `Tooltip` n√£o ser exibida num Portal, precisei usar uma ~gambiarra~ t√©cnica avan√ßada para exibir dois elementos com `position: absolute` lado a lado (`Label` e `PastTime`). Para usar essa t√©cnica no `PastTime` tamb√©m, precisaria de um pouco mais de trabalho (deixar o componente renderizar com ou sem `Tooltip`), ent√£o eu s√≥ diminu√≠ o `margin-right` dele, j√° que adicionei um `margin-right` no pai.
  > > O `opacity: 0` faz com que eu consiga criar um elemento que tome espa√ßo na tela sem ser vis√≠vel, e esse espa√ßo √© visualmente representado pelo elemento com `position: absolute` (o `Label` com `Tooltip`).
  > > Eu realmente tentei v√°rias alternativas, mas nenhuma dava certo. Se algu√©m ter uma solu√ß√£o melhor, pode falar.
  > > Parece que tem um [Tooltip v2](https://primer.style/react/drafts/Tooltip) em Draft que o Primer j√° est√° usando internamente em alguns componentes e (suspeito que) resolve esse problema.
  > > Do jeito que est√° estilizado agora, para adicionar uma nova `Label` ao lado de outra, cada uma precisa de um `Box` com `display: flex`.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > adicionei um `mr: '28px'` na linha, para considerar que existe um elemento ali.
  > > Boa! Mas vi que adicionou s√≥ quando o bot√£o √© renderizado. Ser√° que n√£o √© melhor deixar esse espa√ßo reservado sempre, pois assim elimina o deslocamento de layout que ainda pode ocorrer em alguns casos.
  > > E se for pra j√° deixar o espa√ßo reservado sempre, talvez seja melhor colocar o `ViewModeOptionsMenu` dentro de um `Box` de largura fixa e que sempre est√° presente.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Por causa do `overflow: hidden` em um elemento antecessor e da `Tooltip` n√£o ser exibida num Portal, precisei usar uma ~gambiarra~ t√©cnica avan√ßada para exibir dois elementos com `position: absolute` lado a lado (`Label` e `PastTime`).
  > > Gostei da ideia. E acho que compensa a gente criar um _wrapper_ pro Tooltip do Primer que sempre coloca ele com `position: absolute` e adiciona um elemento invis√≠vel. Assim as adapta√ß√µes do Tooltip ficam centralizadas, e tamb√©m fica f√°cil de remov√™-las quando elas n√£o forem mais necess√°rias.
  > > O `opacity: 0` faz com que eu consiga criar um elemento que tome espa√ßo na tela sem ser vis√≠vel
  > > Para isso, n√£o √© melhor usar `visibility: hidden`? Elimina a necessidade de `aria-hidden` e `userSelect: none`.
  > > Parece que tem um [Tooltip v2](https://primer.style/react/drafts/Tooltip) em Draft que o Primer j√° est√° usando internamente em alguns componentes e (suspeito que) resolve esse problema.
  > > Com o _wrapper_, fica f√°cil trocar quando esse a√≠ funcionar melhor.
  > > Do jeito que est√° estilizado agora, para adicionar uma nova `Label` ao lado de outra, cada uma precisa de um `Box` com `display: flex`.
  > > O _wrapper_ tamb√©m elimina essa necessidade.
  > > Vou fazer uns testes com um _wrapper_. üëç
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > N√£o sei se entendi direito, mas deixar sempre com a margem ter√° implica√ß√µes na quebra do conte√∫do em diferentes linhas em casos de telas menores, com eles quebrando mesmo tendo espa√ßo. Quer que fa√ßa essa altera√ß√£o mesmo?
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Quer que fa√ßa essa altera√ß√£o mesmo?
  > > Quero n√£o! üòÖ Sempre que eu escrevo talvez, √© talvez mesmo. üòÖ Significa que, ou eu n√£o pensei muito, ou pensei e n√£o cheguei em uma conclus√£o.
  > > Nesse caso, eu n√£o cheguei a pensar muito sobre esse _trade-off_ entre quebrar a linha mesmo ainda tendo espa√ßo ou causar um deslocamento de layout, mas, como os dois casos s√≥ devem ocorrer em telas pequenas, pensei agora e deve ser melhor o eventual deslocamento, e n√£o quebrar a linha √† toa.
  > > O que pensei mais quando sugeri √© sobre a `Box` fazer mais sentido do que `mr`, pois deixa mais claro qual √© a fun√ß√£o desses `28px`, mesmo que n√£o fique com o valor fixo.
  > > Mas, como d√° para resolver de diversas formas, talvez compense at√© algo mais pr√≥ximo da sua primeira tentativa, s√≥ que usando uma **altura m√≠nima** no lugar de **fixa**, mas tamb√©m √© uma solu√ß√£o em que perdemos um pouco de espa√ßo.
  > > Resumindo... N√£o precisa mudar se n√£o achar que vale a pena. ü§ù
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Quero n√£o! üòÖ Sempre que eu escrevo talvez, √© talvez mesmo. üòÖ Significa que, ou eu n√£o pensei muito, ou pensei e n√£o cheguei em uma conclus√£o.
  > > Sem problemas üòÅ
  > > Posso fazer alguns testes e ver se consigo algo com o `Box`.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Acho que consegui fazer algo, s√≥ n√£o entendi como eliminaria a necessidade do `Box`. D√° uma olhada:

```js
// pages/interface/components/TooltipAbsolute/index.js
import { cloneElement } from "react";
import { Box, Tooltip } from "@/TabNewsUI";
export default function TooltipAbsolute({ children, ...props }) {
  return (
    <Box sx={{ display: "inline-flex" }}>
      {cloneElement(children, { style: { visibility: "hidden" } })}
      <Tooltip {...props} sx={{ position: "absolute" }}>
        {children}
      </Tooltip>
    </Box>
  );
}
```

Exemplo de uso:

```js
<TooltipAbsolute
  aria-label="Autor do conte√∫do principal da p√°gina"
  direction="n"
>
  <Label>Autor</Label>
</TooltipAbsolute>
```

E entra uma d√∫vida, no caso do `PastTime`, que tem caso com `position: 'absolute'` e caso sem (no `ContentList`), faz sentido ter uma condi√ß√£o para renderizar um `Tooltip` ou `TooltipAbsolute` dependendo do `props.sx?.postion === 'absolute'`? Ou renderizaria o `TooltipAbsolute` em ambos casos?
Se voc√™ achou essa implementa√ß√£o legal, antes de commitar preciso investigar mais para tentar melhorar a quebra com mais de um `Label`. Queria deixar uma em cada linha na primeira quebra que acontece no GIF abaixo:

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Eu criei o Tooltip customizado de uma forma que n√£o precisa mexer no restante do c√≥digo, pois assim tamb√©m fica mais f√°cil de retir√°-lo quando n√£o for mais necess√°rio.
> > Vou commitar pra voc√™ ver o que eu fiz, pois acho que resolveu tudo que comentamos e mais alguns problemas do alinhamento dos textos, mas pode sobrescrever o commit se achar melhor.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu tinha pensado em adicionar esse `minWidth` direto no `Box` que est√° com `position: 'relative'` na linha `91`. Faz sentido? A√≠ n√£o precisa da condicional e nem criar um `Box` novo.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Esse `Box` precisa de `position: 'relative'`?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o acha melhor renderizar o `LabelGroup` s√≥ se ter algum `Label`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o precisa. O que acha desta vers√£o?

```js
export default function Tooltip({ children, ...props }) {
  const { sx: { position, ...sxRest } = {} } = props;
  if (position === "absolute")
    return (
      <Box sx={{ display: "inline-flex" }}>
        <Box sx={{ ...sxRest, visibility: "hidden" }}>{children}</Box>
        <PrimerTooltip {...props}>{children}</PrimerTooltip>
      </Box>
    );
  return <PrimerTooltip {...props}>{children}</PrimerTooltip>;
}
```

Se gostar, faz um rebase aqui pelo GitHub mesmo, que depois eu substituo o √∫ltimo commit e j√° enviamos para produ√ß√£o. ü§ù

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Boa, bem melhor!
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho melhor deixar pronto para funcionar de forma que cada label possa ser um componente independente.
> > Assim a l√≥gica se a label vai aparecer pode ir at√© para dentro dela.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Me parece tudo certo. Fiz o rebase pelo GitHub, se precisar de algo mais, pode avisar. Obrigado pela ajuda no PR.
> > </pull_1589_Identificar o autor da publica√ß√£o principal da p√°gina nos coment√°rios>

<pull_1590_fix: texto TabCoin no singular concatena com valor booleano>

## Mudan√ßas realizadas

No componente TabCoinCount, existe uma condi√ß√£o para retirar ou adicionar o plural, dependendo se o usu√°rio possui uma √∫nica ou mais TabCoins.
O problema ocorre quando o usu√°rio possui apenas uma TabCoin. Nessa condi√ß√£o, a verifica√ß√£o `amount !== 1` faz com que o seu retorno booleano seja concatenado na string "TabCoin", como por exemplo:
Mudei essa condi√ß√£o utilizando o operador tern√°rio para corrigir o problema.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
  > > Review de Rafatcb (COMMENTED):
  > > Bem observado, @smrsassa! Obrigado pelo PR.
  > > Aproveitando que sugeri uma edi√ß√£o, depois voc√™ pode realizar um squash dos commits, deixando a mensagem de commit em ingl√™s, por favor?
  > > Review de smrsassa (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de smrsassa (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Boa @smrsassa, obrigado pelo PR! üí™
  > > Review de aprendendofelipe (CHANGES_REQUESTED):
  > > @smrsassa, n√£o passou no Lint do commit.
  > > Use o comando `npm run commit` para criar a mensagem no padr√£o do projeto, ou use algo j√° no padr√£o, como:
  > > `fix(tabcoin_count): fix the singular TabCoin text`
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Podemos aproveitar para tratar o `-1` tamb√©m.

```suggestion
      text: `${amount?.toLocaleString('pt-BR')} TabCoin${Math.abs(amount) === 1 ? '' : 's'}`,
```

Se `amount` for `undefined`, `Math.abs(amount)` retornar√° `NaN`. Se for `null`, retornar√° `0`, ent√£o continuar√° funcionando nesses cen√°rios.

> > Coment√°rio de smrsassa (linha de c√≥digo):
> > Boa! N√£o tinha considerado o valor negativo.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > @smrsassa acabei de perceber um detalhe sobre sua mensagem de commit e editei meu coment√°rio principal, mas vou colocar aqui tamb√©m porque n√£o sei se voc√™ viu a edi√ß√£o:
> > Aproveitando que sugeri uma edi√ß√£o, depois voc√™ pode realizar um squash dos commits, deixando a mensagem de commit em ingl√™s, por favor?
> > Coment√°rio de smrsassa (linha de c√≥digo):
> > Claro, pode deixar
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Considerem o que foi feito no #1461 como refer√™ncia, ent√£o -1, 0 e 1 ficam no singular. Ficaria algo como:

```suggestion
      text: `${amount?.toLocaleString('pt-BR')} TabCoin${amount > 1 || amount < -1 ? 's' : ''}`,
```

</pull_1590_fix: texto TabCoin no singular concatena com valor booleano>

<pull_1593_Exp√µe novas listas de conte√∫dos recentes (coment√°rios e todos)>

## Mudan√ßas realizadas

Exp√µes as novas listas de conte√∫dos e unifica p√°ginas que mostravam os mesmos itens.
Agora ser√° poss√≠vel ver 3 tipos de listas de recentes:

- **Publica√ß√µes:** √â o padr√£o, e mostra o mesmo que atualmente, ou seja, apenas conte√∫dos raiz.
- **Coment√°rios:** Exibe todos os coment√°rios em ordem de publica√ß√£o.
- **Todos:** Mostra todos os tipos de conte√∫dos (publica√ß√µes e coment√°rios) em ordem de publica√ß√£o.
  O PR tamb√©m unificou p√°ginas duplicadas que mostravam os mesmos conte√∫dos, como `/pagina/1` que agora √© direcionado para `/` (√∫nico caso invertido) e /`recentes` que agora vai para `/recentes/1`, mantendo o padr√£o de `/recentes/comentarios/1` e `/[username]/comentarios/1`.
  Al√©m disso, agora ao navegar para uma p√°gina alta em qualquer das listas de conte√∫dos, haver√° um redirecionamento para a √∫ltima p√°gina v√°lida.
  Por fim, foram removidos c√≥digos desnecess√°rios, como:

- `revalidate` para redirecionamentos 404 em erros de valida√ß√£o que n√£o devem mudar sem um novo deploy;
- parte da valida√ß√£o que ocorria em `/`, j√° que a entrada da valida√ß√£o √© sempre um objeto vazio, o que tamb√©m deixei mais explicito.
- `contentListFound: JSON.parse(JSON.stringify([]))`;

### Oportunidades de melhorias

Como os valores retornados por `getStaticPaths` est√£o fixos, e como `getStaticProps` n√£o pode resultar em redirecionamento durante a pr√©-renderiza√ß√£o em build time, foi adicionada a verifica√ß√£o `!webserver.isBuildTime` nos redirecionamentos.
No futuro devemos criar uma forma simples de buscar as quantidades de conte√∫dos de cada tipo, sem necessariamente buscar os conte√∫dos em si. Isso vai permitir gerar retornos de `getStaticPaths` dinamicamente e tamb√©m mostrar as quantidades totais de cada tipo de conte√∫do em suas respectivas abas. Por exemplo:

## Tipo de mudan√ßa

- [x] Nova funcionalidade
- [x] _**Breaking change**_ (dois endere√ßos causam novos redirecionamentos: `/pagina/1` e /`recentes`)

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de Rafatcb (COMMENTED):
  > > Deixei dois coment√°rios de concord√¢ncia de g√™nero, os erros n√£o foram inseridos nesse PR, mas s√≥ percebi agora.
  > > Fora isso, me parece que est√° tudo certo :+1:
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):

```suggestion
        description: 'Coment√°rios no TabNews ordenados pelos mais recentes.',
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):

```suggestion
        description: 'Conte√∫dos no TabNews ordenados pelos mais recentes.',
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Como n√£o tenho familiaridade com o Next, quero esclarecer algo (para mim mesmo). Qual √© o crit√©rio usado para escolher um valor para o `revalidate`? Reparei que teve caso que era `10` e virou `1` (por exemplo, na linha 70), e tem uma condi√ß√£o sobre o valor de `revalidate` aqui tamb√©m.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > √â o tempo do `stale-while-revalidate`. Quanto menor o valor, mais r√°pido ir√° expirar o cache, ent√£o demora menos para uma nova publica√ß√£o aparecer na lista, mas, em compensa√ß√£o, aumentamos a utiliza√ß√£o do banco de dados para a revalida√ß√£o das p√°ginas.
> > Antes era tudo 1s, mas com os problemas no lan√ßamento n√≥s aumentamos para 10s. Aos poucos estamos diminuindo o que d√°, de acordo com o faz mais sentido atualizar mais r√°pido. Mas se impactar no uso do banco, teremos que reverter.
> > No caso do condicional, n√£o precisamos revalidar a cada segundo uma p√°gina que com certeza n√£o vai existir daqui a 1 segundo, como √© o caso de duas p√°ginas (ou mais) acima da √∫ltima p√°gina v√°lida.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Antes era tudo 1s, mas com os problemas no lan√ßamento n√≥s aumentamos para 10s. Aos poucos estamos diminuindo o que d√°, de acordo com o faz mais sentido atualizar mais r√°pido. Mas se impactar no uso do banco, teremos que reverter.
> > Entendi, ficou mais claro para mim, obrigado. Aproveitando, vou ler os coment√°rios do PR #1374 para entender mais o contexto tamb√©m.
> > </pull_1593_Exp√µe novas listas de conte√∫dos recentes (coment√°rios e todos)>

<pull_1594_Adiciona `key` para o React mostrar numera√ß√£o correta nas listas de conte√∫dos.>

## Mudan√ßas realizadas

Com o PR #1580 as listas de conte√∫dos passaram a usar as tags `ol` e `li`, e o par√¢metro `start` define o n√∫mero do primeiro item. Por exemplo, iniciando em 31 na p√°gina 2.
Acontece que o React nem sempre est√° atualizando os n√∫meros ao mudarmos de p√°gina, mesmo com a mudan√ßa do valor em `start`. No Safari eu n√£o vi o bug, mas no Chrome acontece sempre.
Para for√ßar a renderiza√ß√£o com os n√∫meros corretos, `listNumberStart` tamb√©m foi passado como `key` para a tag `ol`.
Para testar, navegue entre diferentes p√°ginas que tenham o mesmo `pathname` usando os bot√µes `Anterior` e/ou `Pr√≥ximo` no final da lista. Por exemplo, √† partir da `/pagina/3`. Compare as duas vers√µes:

- Com bug: https://tabnews-git-accessibility-fixes-tabnews.vercel.app/recentes/pagina/3
- Corrigido: https://tabnews-git-content-list-numbering-tabnews.vercel.app/recentes/pagina/3

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
      </pull_1594_Adiciona `key` para o React mostrar numera√ß√£o correta nas listas de conte√∫dos.>

<pull_1595_Corrige a navega√ß√£o por teclas no menu do header>

## Problemas

O `SearchBarMenuItem` s√≥ √© vis√≠vel no menu quando estamos em telas pequenas. Nos demais casos esse item recebia a propriedade `display: none`. S√≥ que isso causava um bug na navega√ß√£o pelo menu usando o teclado, onde n√£o era poss√≠vel pular esse item oculto.
Al√©m disso, quando o `SearchBarMenuItem` est√° vis√≠vel, existem dois n√≠veis diferentes de sele√ß√£o, o do bot√£o interno e do item no menu, fazendo a navega√ß√£o pelas teclas parecer travar momentaneamente no item.

## Mudan√ßas realizadas

Agora o `SearchBarMenuItem` √© removido usando a vari√°vel `isScreenSmall`, que usa o hook `useMediaQuery`. E isso permite navegar por todos os itens usando as setas do teclado.
E o `SearchBarMenuItem` n√£o √© mais renderizado como bot√£o, ent√£o n√£o existe mais os dois n√≠veis de navega√ß√£o nele.
Aproveitei para atualizar o hook ao remover o m√©todo obsoleto `addListener`.
E j√° que foi criada a `isScreenSmall`, usei ela para determinar quando os itens aparecem no menu. Na pr√°tica isso vai fazer os items "Cadastrar" e "+" aparecerem em telas ainda menores, mas sem causar problemas no layout.
Por fim, n√£o tem rela√ß√£o com o PR, mas aproveitei para aceitar a [melhoria proposta](https://github.com/filipedeschamps/tabnews.com.br/pull/1594#issuecomment-1879779636) pelo @Rafatcb de usar `content-list-${listNumberStart}` como chave para `contentList`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).

## Melhorias futuras

~Seja antes ou ap√≥s esse PR, o selecionar o tema de dentro do menu n√£o est√° funcionando pelo teclado. √â preciso investigar o motivo.~
**[Edit]** Problemas resolvidos, e agora √© poss√≠vel selecionar o tema utilizando as teclas "Enter" ou "Barra de espa√ßo".

> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Encontrei apenas um problema: o `:hover` do item Pesquisar tira a borda azul do `:focus-visible` porque o `:hover` aplica um `box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px max(1px, 0.0625rem) inset;`. Isso j√° acontecia antes do seu PR. Esse problema n√£o acontece nos outros itens.
> > N√£o encontrei onde essa estiliza√ß√£o do `hover` est√° definida, parece ser do pr√≥prio Primer.
> > Review de Rafatcb (APPROVED):
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Voc√™ n√£o acha que a express√£o fica mais simples convertendo para `||`?

```suggestion
      {!isLoading && (!user || !isScreenSmall) && (
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Considerando que √© um elemento interativo com o `onClick`, n√£o faz mais sentido continuar sendo um bot√£o?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o precisa ser um bot√£o. Na verdade, nem antes deveria ser, pois o `ActionList.Item` j√° √© um elemento interativo. Eu usei o bot√£o do Primer para aproveitar parte da estiliza√ß√£o dele, mas j√° deveria ter alterado o elemento ao inv√©s de adicionar o `onClick`.
> > E agora, como `div`, esse `onClick` n√£o √© mais ser necess√°rio (vou retirar), pois a mesma fun√ß√£o j√° √© passada para o `onSelect` do `ActionList.Item`.
> > Mas gostaria da opini√£o sobre valer a pena mantermos essa "Gambiarra" que fiz para o item de pesquisa se parecer com um _input_ de texto. Digo manter pelo menos enquanto nenhuma atualiza√ß√£o do Primer dificultar mantermos assim, ou se √© melhor j√° adotarmos logo um item padr√£o do menu:
> > | Entrada de texto falsa | Item de menu padr√£o |
> > | ---------------------- | ------------------- |
> > | |
> > √â mais uma d√∫vida sobre o design vs facilidade de manuten√ß√£o. Para o leitor de tela, os dois resultados s√£o id√™nticos. O que acham?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Sobre entender a express√£o, n√£o vejo diferen√ßa, ent√£o posso mudar se acharem mais f√°cil. Mas eu n√£o pensei em deixar claro o que a l√≥gica faz, mas em porque existe essa l√≥gica a√≠.
> > Acho um pouco mais simples de entender a raz√£o do condicional se pensar em "ocultar o item no caso espec√≠fico em que o usu√°rio est√° logado e ao mesmo tempo usando tela pequena", pois √© o caso em que podemos mover o bot√£o de pesquisa para o menu. Pensei que poderia exigir um pouco mais de esfor√ßo para entender a raz√£o dessa l√≥gica ao pensar em "mostrar o item se o usu√°rio n√£o estiver logado ou se n√£o estiver em tela pequena".
> > Pensando por esse lado, o que voc√™ acha mais f√°cil? Ou at√© mesmo invertendo como abaixo:

```suggestion
      {!isLoading && !(isScreenSmall && user) && (
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Mas gostaria da opini√£o sobre valer a pena mantermos essa "Gambiarra" que fiz para o item de pesquisa se parecer com um input de texto. Digo manter pelo menos enquanto nenhuma atualiza√ß√£o do Primer dificultar mantermos assim, ou se √© melhor j√° adotarmos logo um item padr√£o do menu
> > Acho que podemos usar a estiliza√ß√£o padr√£o de um item do menu.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > "ocultar o item no caso espec√≠fico em que o usu√°rio est√° logado e ao mesmo tempo usando tela pequena"
> > Talvez seja falta de costume meu em ler condi√ß√µes assim, mas ficou claro o racioc√≠nio. N√£o vejo problemas em deixar do jeito que est√°, `!(user && isScreenSmall)`.
> > </pull_1595_Corrige a navega√ß√£o por teclas no menu do header>

<pull_1601_feat: adicionar retorno de resultados para coment√°rios>
Adicionar uma query com nome type na API para retornar os coment√°rios de uma postagem, listar todos os coment√°rios por pagina√ß√£o e estrat√©gia.

## Mudan√ßas realizadas

<!-- Por favor, inclua uma descri√ß√£o sobre o que foi modificado nesse PR. Inclua tamb√©m qualquer motiva√ß√£o ou contexto relevante.  -->

Adicionar retorno de resultados para coment√°rios, como recentemente foi adicionado na aba recentes tabs com "todos", "coment√°rios", al√©m das "publica√ß√µes"., n√£o encontrei alguma altera√ß√£o na API em rela√ß√£o ao retorno dos coment√°rios.

<!-- Se o PR cont√©m uma modifica√ß√£o da interface gr√°fica (UI), adicione fotos ou v√≠deos comparando o antes e depois. -->
<!-- Se o PR cont√©m modifica√ß√µes de API, mencione os endpoints afetados. -->

Endpoints afetados:

```
GET {{BaseUrl}}/contents?page={pagina}&per_page={porPagina}&strategy={estrategia}
```

Novo endpoint adicionado:

```
GET {{BaseUrl}}/contents?page={pagina}&per_page={porPagina}&strategy={estrategia}&type={Tipo}
```

O "type" deve possuir um dos seguintes valores: "comments"

<!-- Caso esse PR resolva algum issue, voc√™ pode descomentar a linha abaixo e substituir (issue) pelo n√∫mero dele. -->
<!-- Resolve #(issue) -->

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->
<!-- - [x] Corre√ß√£o de bug -->

- [x] Nova funcionalidade
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.

  > > Review de Rafatcb (COMMENTED):
  > > √ìtima contribui√ß√£o, @mthmcalixto! Eu nem tinha percebido que a API n√£o havia sido atualizada com isso.
  > > O coment√°rio do @kaique-soares √© importante, podemos manter uma padroniza√ß√£o nos endpoints sobre isso usando o mesmo nome de par√¢metro. O PR onde foi implementado para publica√ß√µes do usu√°rio √© o #1188. Acho que voc√™ pode usar uma l√≥gica bem parecida no seu PR. Ser√£o tr√™s cen√°rios poss√≠veis:

- Busca apenas por coment√°rios.
- Busca apenas por publica√ß√µes.
- Busca por ambos.
  Eu n√£o testei, mas vendo o outro arquivo, como tem a op√ß√£o "ambos", acho que vai continuar precisando do loop com o `delete content.body;`, mas ter o `exclude: ['body']` √© interessante para o caso de busca apenas por t√≠tulo, assim j√° obtemos menos dados do banco. Se isso se provar correto, podemos at√© atualizar o outro arquivo tamb√©m.
  E, por favor, crie testes para as novas funcionalidades. Pode ver no outro PR como foi feito e adaptar para o `contents`. Qualquer d√∫vida, pode comentar.
  PS: Depois faz um `squash` dos seus commits e coloca a mensagem em ingl√™s, por favor. Se n√£o souber fazer squash, d√° uma olhada [nessa resposta do Stack Overflow](https://stackoverflow.com/a/5201642/8839059).
  > > Review de aprendendofelipe (COMMENTED):
  > > Show @mthmcalixto!
  > > Fiz coment√°rios no c√≥digo, e tamb√©m gostaria de sugerir encurtar os nomes dos testes.
  > > Eu n√£o revisei o conte√∫do dos testes, s√≥ dei uma passada pelos nomes deles. Pelas descri√ß√µes, acho que est√° testando tudo que √© necess√°rio, mas acho que as descri√ß√µes poderiam se concentrar na parte importante de cada teste.
  > > Caso ache v√°lido, voc√™ pode usar `describe` para agrupar alguns testes.

---

E aproveitando sobre o assunto testes... Eu acho que n√£o estamos adotando uma boa estrat√©gia ao limpar o banco de dados a cada teste. Falo especificamente sobre os testes que s√≥ usam o m√©todo GET.
Testes que podem ser executados com um mesmo conjunto de dados (no banco de dados) poderiam ser agrupados e executados de forma mais r√°pida.
Em alguns casos tamb√©m daria para usar `test.each` ou `describe.each` para testes id√™nticos em que s√≥ mudam os dados de entrada e sa√≠da.
N√£o precisamos fazer isso nesse PR, mas gostaria de saber opini√µes sobre isso.

> > Review de aprendendofelipe (COMMENTED):
> > @mthmcalixto, fiz coment√°rios sobre os nomes dos testes. Veja se faz sentido pra voc√™.
> > E sobre o commit:

- N√£o entendi porque fala em `breaking change` na mensagem, acho que pode retirar;
- O tipo ficou como `revert` ao inv√©s de `feat`;
- √â bom inserir um contexto, algo como `feat(content endpoint):`;
- A mensagem pode ficar mais clara se citar que est√° adicionando os par√¢metros `with_root` e `with_children`;
- O t√≠tulo do PR n√£o precisa ser igual ao do commit, e pode ser em portugu√™s.
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de mthmcalixto (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de mthmcalixto (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de mthmcalixto (COMMENTED):
  > > Review de mthmcalixto (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de mthmcalixto (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Fiz algumas sugest√µes. Acho que os testes est√£o ficando cada vez melhores üöÄ
  > > Talvez tenha mais coisas para ajustar, mas comentei tudo o que enxerguei como poss√≠veis melhorias agora.
  > > Review de mthmcalixto (COMMENTED):
  > > Review de mthmcalixto (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de mthmcalixto (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de mthmcalixto (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > @mthmcalixto, sobre a implementa√ß√£o da funcionalidade, est√° √≥tima. At√© sugiro que na pr√≥xima vez que mexer no c√≥digo, deixar o arquivo dos testes em um commit separado, pois √© s√≥ nele que ainda precisa mexer, e se algu√©m sugerir algo mais interessante, fica f√°cil aproveitar o seu commit da funcionalidade.
  > > Sobre os testes, tem muito condicional dentro deles. Isso √© bem ruim.
  > > At√© mantive os coment√°rios que eu j√° tinha feito mais cedo no c√≥digo, dizendo para remover o `withDraft`, mas a verdade √© que deveria remover todos, ou praticamente todos, os condicionais, pois n√£o fica nada claro o que os testes est√£o fazendo.
  > > Um exemplo √© que existia o teste chamado `get new root, including draft...` que, contrariando o t√≠tulo, corretamente n√£o recuperava o rascunho, mas tem que analisar a l√≥gica do teste para descobrir isso, quando o correto era o `expect` deixar isso claro.
  > > Falando em `expect`, preferencialmente ele deveria estar dentro do array passado para `test.each`.
  > > Outro detalhe sobre a organiza√ß√£o dos testes, √© que n√£o est√° mais testando exclusivamente os par√¢metros de tipo de conte√∫do, ent√£o o `describe` n√£o faz mais sentido como est√°.
  > > Eu n√£o queria submeter esse feedback sem sugerir uma solu√ß√£o, mas como j√° demorei demais, preferi dar esse retorno parcial, pois algu√©m pode dar alguma ideia com base nele.
  > > Review de Rafatcb (APPROVED):
  > > Fiz um commit aproximando um pouco mais do que pensei, ou seja, com o conjunto de testes usando os mesmos dados do banco, o que faz eles serem executados em 1/4 do tempo.
  > > Eu tinha tentado usar o `beforeAll` a princ√≠pio, mas n√£o tinha pensado em fazer a divis√£o como voc√™ fez para funcionar com o `beforeAll`.
  > > Parece tudo certo para mim.
  > > Podemos fazer uma refatora√ß√£o do arquivo de teste em outro PR com as descobertas que tivemos nesse PR, como mencionado nesse coment√°rio https://github.com/filipedeschamps/tabnews.com.br/pull/1601#pullrequestreview-1813937412.
  > > Review de aprendendofelipe (APPROVED):
  > > Podemos fazer uma refatora√ß√£o do arquivo de teste em outro PR com as descobertas que tivemos nesse PR, como mencionado nesse coment√°rio [#1601 (review)](https://github.com/filipedeschamps/tabnews.com.br/pull/1601#pullrequestreview-1813937412).
  > > Combinado, ent√£o bora pro merge! ü§ù
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      parent_id: request.query.with_children ? undefined : null,
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

Pode fazer como no `/contents/[username]`:
https://github.com/filipedeschamps/tabnews.com.br/blob/5b5292de7e4bfcb63208469533aade11793ede5d/pages/api/v1/contents/%5Busername%5D/index.public.js#L54-L60

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    describe('Content type query params', () => {
```

@Rafatcb, esse √© um exemplo de bloco de testes que poderia ser executado com um mesmo conjunto de dados. N√£o digo porque os testes est√£o lentos, mas apenas porque podem ser mais simples, r√°pidos e efetivos.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      test('"with_root undefined" and "with_children undefined"', async () => {
```

O que acham de seguir esse padr√£o? Em conjunto com o `describe: Content type query params`, ser√° que fica mais claro o que est√° sendo testado?
"with_root undefined" and "with_children undefined"
"with_root undefined" and "with_children=false"
"with_root undefined" and "with_children=true"
"with_root undefined" and "with_children invalid"
...
Mesmo se n√£o for seguir esse padr√£o, √© melhor usar `root` e `child` para se referir aos tipos de conte√∫dos, e `with_root` e `with_children` para os par√¢metros.

> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > @aprendendofelipe Dessa forma "with_root undefined" and "with_children undefined" eu n√£o saberia o que estava sendo testado, est√° muito vago.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu acho que do jeito que est√° agora, d√° muita aten√ß√£o √† como o teste foi implementado. Sua sugest√£o d√° aten√ß√£o √† como os par√¢metros da API foram implementados (considero melhor, mas n√£o o ideal). Acho que poder√≠amos adicionar mais contexto ao teste, ficando algo como:

- `test('get root content only with default params'`
- `test('get root content only with "with_children=false"`
- `test('get root and children content with "with_children=true"`
- `test('get children content only with "with_root=false" and "with_children=true"`
  Assim eu j√° sei o que esperar por cada par√¢metro, sem precisar ler o teste.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > O que voc√™s acham de n√£o obter o `body` se n√£o for necess√°rio?

```suggestion
    attributes: {
      exclude: request.query.with_children ? undefined : ['body'],
    },
    page: request.query.page,
```

> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > O que voc√™s acham de n√£o obter o `body` se n√£o for necess√°rio?
> > Eu pensei em fazer isso antes de remover diretamente o body, a√≠ eu me deparei em uma consulta que precisaria dos dois, e o `with_children` iria ficar sem body.
> > Mas agora removendo o body, acho melhor adicionar essa remo√ß√£o caso n√£o precise, assim n√£o faz a consulta no banco de dados.
> > Adicionei essa sugest√£o no c√≥digo.
> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > @Rafatcb com essas descri√ß√µes realmente deu mais sentido.
> > @Rafatcb e @aprendendofelipe Vejam as novas descri√ß√µes que coloquei nos testes. https://github.com/filipedeschamps/tabnews.com.br/compare/04b4f75f3eb546759987a925c9ef139ea5db552f..6d9676c1ab6b285ae0b196aa9b2727e7eb5c0fca
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > S√≥ faltou ignorar o loop para o caso `!request.query.with_children` > > https://github.com/filipedeschamps/tabnews.com.br/blob/6d9676c1ab6b285ae0b196aa9b2727e7eb5c0fca/pages/api/v1/contents/index.public.js#L69-L75
> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > para o caso `!request.query.with_children`
> > @aprendendofelipe Vai falhar no teste `get root and children content with "with_children=true` onde `with_children=true` precisa do body e o root n√£o, como o padr√£o √© retornar o root content sem "with_root", acaba retornando body no root content por que n√£o fez o loop.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O loop s√≥ precisa ser executado justamente quando `with_children=true`:

````js
 if (request.query.with_children) {
   for (const content of secureOutputValues) {
     if (content.parent_id) {
       content.body = removeMarkdown(content.body, { maxLength: 255 });
     } else {
       delete content.body;
     }
   }
 }
>> Coment√°rio de mthmcalixto (linha de c√≥digo):
> O loop s√≥ precisa ser executado justamente quando `with_children=true`:
>
> ```js
>  if (request.query.with_children) {
>    for (const content of secureOutputValues) {
>      if (content.parent_id) {
>        content.body = removeMarkdown(content.body, { maxLength: 255 });
>      } else {
>        delete content.body;
>      }
>    }
>  }
> ```
@aprendendofelipe sim, faz sentindo agora.
>> Coment√°rio de mthmcalixto (linha de c√≥digo):
@aprendendofelipe @Rafatcb eu acabei usando um teste para outro teste, veja
>> Coment√°rio de aprendendofelipe (linha de c√≥digo):
Acho que entendi o que voc√™ fez, mas a forma usual de fazer isso √© usando [`test.each`](https://jestjs.io/docs/api#testeachtablename-fn-timeout).
`test.each(table)(name, fn, timeout)`
A√≠ voc√™ fornece um array de arrays com os valores testados, e que tamb√©m ser√£o usados para a cria√ß√£o dos t√≠tulos de cada teste.
Voc√™ juntou os testes que d√£o sempre os mesmos resultados, mas passando as vari√°veis de `table` tamb√©m para o `expect`, voc√™ pode unificar todos os testes que est√° criando nesse PR.
>> Coment√°rio de Rafatcb (linha de c√≥digo):
@mthmcalixto chegou a testar a sugest√£o do Felipe aqui, de usar `test.each`? Fiz aqui um exemplo para ver se era poss√≠vel continuar com bons nomes nos testes, e √© sim:
```js
test.only.each([
  { params: 'with_children=false', title: 'get default root content only' },
  { params: 'with_children=true', title: 'get default root content only' },
])('$title with "$params"', async ({ params }) => {
  // ...
  const response = await fetch(`${orchestrator.webserverUrl}/api/v1/contents?${params}`);
  const responseBody = await response.json();
  // ...
  if (params.includes('with_children=true')) {
    // ...
  }
  expect(responseBody).toStrictEqual(rootReturn);
});
````

Na lista de testes fica:

```
Content type query params
  ‚úì get default root content only with "with_children=false" (629 ms)
  ‚úì get default root content only with "with_children=true" (615 ms)
 ...
```

Se passar mais par√¢metros para a API:

```js
// Um objeto passado para o .each
{ params: 'with_children=false&with_root=false', title: 'get default root content only' }
// O resultado
‚úì get default root content only with "with_children=false&with_root=false" (743 ms)
```

Acho que n√£o d√° para formatar melhor o t√≠tulo, mas isso pode deixar os testes mais enxutos e continua leg√≠vel o que √© esperado.
Inclusive, nesses exemplos acho que o `title` poderia ser mais descritivo. Ficou um pouco confuso o que √© "default root content". Se for uma refer√™ncia √† estrat√©gia, pode cit√°-la, por exemplo "get relevant root content only".
PS: Aproveita para tentar unificar todos os testes criados com um √∫nico `.each`, como o Felipe comentou.

> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > @Rafatcb estou mexendo agora, realmente fica muito melhor, logo fa√ßo a atualiza√ß√£o.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Pode tirar a fun√ß√£o e deixar o c√≥digo direto aqui mesmo.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tenho uma sugest√£o para deixar mais enxuto:

```js
test.each([
  { content: "relevant root", params: "" },
  { content: "relevant root, including draft,", params: "with_children=false" },
  { content: "relevant children", params: "with_children=true" },
  {
    content: "new root",
    params: "with_children=false&with_root=true&strategy=new",
  },
  { content: "new root", params: "with_children=false&strategy=new" },
  {
    content: "new children",
    params: "with_children=true&with_root=false&strategy=new",
  },
  {
    content: "new root and children",
    params: "with_children=true&strategy=new",
  },
  {
    content: "new root and children",
    params: "with_children=true&with_root=true&strategy=new",
  },
  {
    content: "new root, including draft,",
    params: "with_root=true&strategy=new",
  },
])("get $content with '$params'", async ({ content, params }) => {
  const url = `${orchestrator.webserverUrl}/api/v1/contents?${params}`;
  const withChildren = params.includes("with_children=true");
  const withRoot = !params.includes("with_root=false");
  const withDraft = content.includes("draft");
  const isStrategyNew = params.includes("strategy=new");
  // ...
});
```

O resultado ser√°:

```sh
Content type query params
  ‚àö get relevant root with '' (812 ms)
  ‚àö get relevant root, including draft, with 'with_children=false' (630 ms)
  ‚àö get relevant children with 'with_children=true' (676 ms)
  ‚àö get new root with 'with_children=false&with_root=true&strategy=new' (621 ms)
  ‚àö get new root with 'with_children=false&strategy=new' (596 ms)
  ‚àö get new children with 'with_children=true&with_root=false&strategy=new' (587 ms)
  ‚àö get new root and children with 'with_children=true&strategy=new' (620 ms)
  ‚àö get new root and children with 'with_children=true&with_root=true&strategy=new' (661 ms)
  ‚àö get new root, including draft, with 'with_root=true&strategy=new' (597 ms)
```

O que voc√™ acha?
N√£o esquece de tirar o `.only` do teste.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o precisa verificar `withChildren` porque j√° t√° dentro de um `if `que verificou isso.

```js
// "isStrategyNew" √© uma vari√°vel que criei em outro coment√°rio dessa revis√£o.
if (isStrategyNew) {
  rootReturn.unshift(...comments);
} else {
  rootReturn.push(...comments);
}
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Pode colocar isso dentro do `if (withRoot)` e atualizar a condi√ß√£o para `if (!withDraft)`.
> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > @Rafatcb acho que mais excuto que isso, n√£o tem kkk, bom vou atualizar e acredito que j√° esteja bem melhor que antes.
> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > @Rafatcb N√£o seria melhor colocar os params em uma array?

```js
        { content: 'relevant root', params: [] },
        { content: 'relevant root, including draft,', params: ['with_children=false'] },
        { content: 'relevant children', params: ['with_children=true'] },
        { content: 'new root, including draft,', params: ['with_children=false', 'with_root=true', 'strategy=new'] },
        { content: 'new root', params: ['with_children=false', 'with_root=true', 'strategy=new'] },
        { content: 'new root', params: ['with_children=false', 'strategy=new'] },
        { content: 'new children', params: ['with_children=true', 'with_root=false', 'strategy=new'] },
        { content: 'new root and children', params: ['with_children=true', 'strategy=new'] },
        { content: 'new root and children', params: ['with_children=true', 'with_root=true', 'strategy=new'] },
        { content: 'new root, including draft,', params: ['with_root=true', 'strategy=new'] },
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o tenho prefer√™ncia quanto a isso. Acho sua sugest√£o facilita a cria√ß√£o de novos testes, mas o t√≠tulo dos testes piora um pouco, o que n√£o √© nada grave. Se for fazer essa altera√ß√£o, talvez seja melhor atualizar o t√≠tulo do teste para `get $content with params: $params`, j√° que um array "tira a cara" de par√¢metros de URL. O resultado ficaria assim:

```sh
Content type query params
  ‚úì get relevant root with params: [] (648 ms)
  ‚úì get relevant root, including draft, with params: ["with_children=false"] (504 ms)
  ‚úì get relevant children with params: ["with_children=true"] (618 ms)
  ‚úì get new root, including draft, with params: ["with_children=false", "with_root=true", "strategy=new"] (506 ms)
  ‚úì get new root with params: ["with_children=false", "with_root=true", "strategy=new"] (503 ms)
  ‚úì get new root with params: ["with_children=false", "strategy=new"] (498 ms)
  ‚úì get new children with params: ["with_children=true", "with_root=false", "strategy=new"] (554 ms)
  ‚úì get new root and children with params: ["with_children=true", "strategy=new"] (565 ms)
  ‚úì get new root and children with params: ["with_children=true", "with_root=true", "strategy=new"] (497 ms)
  ‚úì get new root, including draft, with params: ["with_root=true", "strategy=new"] (473 ms)
```

Dessa forma, os t√≠tulos n√£o me parece ruins, apesar de ter um array.
Por mim, se voc√™ quiser, pode fazer a altera√ß√£o :+1:

> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > @Rafatcb √â apenas para ter um visual melhor do que est√£o nos params, do que eles tudo juntos.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ent√£o faz essa altera√ß√£o, faz o rebase (ao inv√©s do merge) e j√° deixa tudo num commit, que o @aprendendofelipe aprovando j√° fica poss√≠vel de realizar o merge do PR. Mas muda o t√≠tulo do teste tamb√©m para continuar fazendo sentido.
> > Coment√°rio de mthmcalixto (linha de c√≥digo):
> > @Rafatcb feito!
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
          status: 'draft',
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
          title: 'Conte√∫do "draft".',
```

</pull_1601_feat: adicionar retorno de resultados para coment√°rios>

<pull_1602_Usar vari√°veis de ambiente no docker-compose.development.yml>

## Mudan√ßas realizadas

Tive um problema ao rodar os servi√ßos j√° tendo a porta do SMTP ocupada, mesmo alterando as vari√°veis de ambiente. Ent√£o percebi que as vari√°veis de ambientes n√£o estavam sendo usadas no `infra/docker-compose.development.yml`.

- Estou usando strings expl√≠citas como valores para as portas, conforme sugerido na [documenta√ß√£o](https://docs.docker.com/compose/compose-file/compose-file-v3/#ports).
- Estou usando o par√¢metro [`--env-file`](https://docs.docker.com/engine/reference/commandline/run/#env) pelo CLI. Tentei usar o [`env_file`](https://docs.docker.com/compose/compose-file/05-services/#env_file) no `.yml`, mas n√£o estava funcionando (_"The \"EMAIL_SMTP_PORT\" variable is not set. Defaulting to a blank string."_). Pelo o que entendi, o `env_file` passa as vari√°veis de ambiente para o container, e n√£o para ser usada no pr√≥prio `yml`.
- Aproveitei para usar o `npm run services:up` no `.github/workflows/ci.yml`, j√° que era o mesmo comando do `package.json`.
  Testei localmente no Linux e Windows, tamb√©m testei no Codespaces e Gitpod. N√£o precisei mudar a configura√ß√£o `.gitpod.yml` para funcionar, mas n√£o sei porqu√™.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
  > > Review de kaique-soares (COMMENTED):
  > > Muito bom @Rafatcb :rocket:
  > > Fiz `2` coment√°rios, veja se faz sentido :handshake:
  > > Al√©m do que comentei, voc√™ acha que compensa usar a `kill-port` para liberar a porta para o `mailcatcher` tamb√©m, assim como fazemos com a porta `3000` ao rodar `npm run dev`?
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Bora pro merge? Ou vai fazer algo mais?
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Coment√°rio de kaique-soares (linha de c√≥digo):
  > > @Rafatcb, voc√™ acha que vale a pena criar um script `services:down` no `package.json`? Desta forma deixamos tudo centralizado.
  > > Coment√°rio de kaique-soares (linha de c√≥digo):
  > > Agora que passamos o `--env-file` pelos scripts no `package.json`, ser√° que ainda precisamos deste `env_file` aqui?
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > N√£o estou acostumado com docker, achei que isso ainda fosse necess√°rio. Fiz uns testes aqui e parece continuar funcionando removendo esse atributo üëç
  > > Edit: localmente estava funcionando ap√≥s remov√™-lo, mas pelo CI do GitHub [estava falhando](https://github.com/filipedeschamps/tabnews.com.br/actions/runs/7514036501/job/20456467224):

```
health check postgres:
Failed to connect to database. A new attempt will be made in 3 seconds ...
```

Ao adicionar novamente, [voltou a passar](https://github.com/filipedeschamps/tabnews.com.br/actions/runs/7514123233/job/20456646110?pr=1602).

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Havia pensado nisso tamb√©m. Como agora somos dois com a mesma ideia, vou colocar üëç .
> > Sabe alguma forma simples de deixar os scripts mais limpos? Fiz alguns experimentos mas n√£o consegui. Queria evitar precisar repetir todo o `--env-file .env -f infra/docker-compose.development.yml`, duas vezes por comando (seis vezes no total).
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Massa Rafa! üí™
> > @kaique-soares, precisa manter o `env_file` para as vari√°veis estarem dispon√≠veis dentro do cont√™iner. Na verdade s√≥ √© necess√°rio na configura√ß√£o inicial do Postgres, ent√£o se remover com o cont√™iner j√° criado, vai parecer que n√£o √© necess√°rio, mas √© sim.
> > @Rafatcb, aproveitando que est√° mexendo aqui, n√£o quer j√° mudar a imagem para bater com a Vers√£o do Postgres na infra real? √â s√≥ mudar a imagem para `postgres:14.7-alpine`.
> > E sobre o `kill-port` para o `mailcatcher`, n√£o vejo necessidade.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > @kaique-soares, precisa manter o env_file para as vari√°veis estarem dispon√≠veis dentro do cont√™iner. Na verdade s√≥ √© necess√°rio na configura√ß√£o inicial do Postgres, ent√£o se remover com o cont√™iner j√° criado, vai parecer que n√£o √© necess√°rio, mas √© sim.
> > Agora entendi porque estava quebrando o CI hehe. Editei meu coment√°rio antes de ver o seu.
> > @Rafatcb, aproveitando que est√° mexendo aqui, n√£o quer j√° mudar a imagem para bater com a Vers√£o do Postgres na infra real? √â s√≥ mudar a imagem para postgres:14.7-alpine.
> > Posso fazer isso sim.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Sabe alguma forma simples de deixar os scripts mais limpos?
> > Voc√™ diz fazer assim?

```json
"services:up": "npm run docker:compose -- up -d",
"services:stop": "npm run docker:compose -- stop",
"services:down": "npm run docker:compose -- down",
"docker:compose": "docker compose --env-file .env -f infra/docker-compose.development.yml",
```

Isso funciona, mas tamb√©m removi a op√ß√£o de usar o _alias_ `docker-compose` (mais detalhes em #1315), o que acredito que j√° podemos fazer, mas ent√£o precisa adequar as depend√™ncias globais no README. N√£o sei quais seriam as novas vers√µes m√≠nimas.
Se acharem que vale a pena a mudan√ßa, s√≥ precisamos ver quais vers√µes colocar l√°. E nem precisa ser a mais antiga compat√≠vel, mas tamb√©m n√£o precisamos recomendar as √∫ltimas vers√µes.

---

Outro trecho que talvez compense unificar, pois se repete 3 vezes, √©:
`kill-port 3000 && npm run services:up && npm run migration:run && npm run migration:seed`
Que nome ser√° que faria sentido para um script com o trecho acima?

---

Tamb√©m seria legal resolver o caso do `&& npm run services:stop` que nunca √© executado ap√≥s for√ßar o encerramento do NextJS.
No Windows at√© resolve se mudar o script `next` para `"next": "next dev || exit 0"`, pois ao usar o Ctrl+C √© perguntado quais processo encerrar, e d√° pra continuar o script. Mas no Linux sempre encerra tudo e n√£o roda o `services:stop`
Alguma ideia do que fazer?

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Voc√™ diz fazer assim?
> > Era isso mesmo, @aprendendofelipe . N√£o lembrava que era s√≥ passar o `--`.
> > Que nome ser√° que faria sentido para um script com o trecho acima?
> > N√£o consegui pensar num bom nome. Talvez por serem usados antes dos comandos `next dev`, `next build` e `next start` pudesse ser algo como `next:prepare`. Ou separar em dois comandos (podem ter outro nome):

```json
"next:prepare": "kill-port 3000 && npm run services:up",
"db:prepare": "npm run migration:run && npm run migration:seed"
```

> Alguma ideia do que fazer?
> Dei uma pesquisada, mas a √∫nica sugest√£o de solu√ß√£o que vi era usando `||` mesmo.
>
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Dei uma pesquisada, mas a √∫nica sugest√£o de solu√ß√£o que vi era usando `||` mesmo.
> > Isso sim, mas a d√∫vida √© mais sobre alguma alternativa ao Ctrl+C no Linux, pois ele encerra tudo e n√£o roda o que tem depois do `||`.
> > Com a altera√ß√£o do commit abaixo j√° est√° rodando o `services:stop` ap√≥s os testes locais (Windows e Linux). üéâ
> > https://github.com/filipedeschamps/tabnews.com.br/commit/a0ccc4b07db36cd2d39c7e126e4f08f3a19bea20
> > Depois vou fazer mais testes antes de abrir o PR, e ver se d√° para organizar mais. Se bem que organiza√ß√£o, nesse caso, √© muito mais uma quest√£o de opini√£o, que ser√£o bem vindas. üí™
> > </pull_1602_Usar vari√°veis de ambiente no docker-compose.development.yml>

<pull_1603_Adicionar rel="nofollow" nos links de conte√∫dos gerados por usu√°rio>

## Mudan√ßas realizadas

Adicionei o plugin [`rehype-external-links`](https://github.com/rehypejs/rehype-external-links) que serve exatamente para adicionar o `rel="nofollow"` em links externos. Essa bibliioteca recomenda usar `rehype-sanitize` para conte√∫dos gerados por usu√°rios, mas o [`bytemd` j√° faz isso](https://github.com/bytedance/bytemd/blob/9f2212203c780f2d9775e3c2243171cdeea2e81d/packages/bytemd/src/utils.ts#L38) antes de adicionar os plugins do rehype.
Coloquei `areLinksTrusted` nas p√°ginas que n√≥s controlamos o conte√∫do. Os links de Fonte continuam sem o `rel="nofollow"` (acho que faz sentido, considerando que a Fonte seja usada da forma adequada, como "origem" do conte√∫do).
Futuramente podemos criar alguma heur√≠stica para n√£o adicionar o plugin em conte√∫dos de usu√°rios confi√°veis, ou usar a propriedade `test` para permitir dom√≠nios confi√°veis (GitHub, por exemplo). Um exemplo de `test` que n√£o colocar√° `rel="nofollow"` no link `https://www.github.com`:

```js
pluginList.push(
  externalLinksPlugin({
    test: (node) => node.properties?.href !== "https://www.github.com",
  })
);
```

Do jeito que est√° no PR, o HTML gerado pelos links em publica√ß√µes ficaram assim (em `localhost`):
Resolve #1236

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Muito bom Rafa!
  > > Adicionei o plugin [`rehype-extenral-links`](https://github.com/rehypejs/rehype-external-links) que serve exatamente para adicionar o `rel="nofollow"` em links externos.
  > > O plugin considera interno todos os links relativos, n√©? S√≥ que est√° adicionando `rel="nofollow"` nos links de conte√∫dos criados pelos usu√°rios com URLs absolutas do pr√≥prio TabNews. Ser√° que isso n√£o pode prejudicar o SEO?
  > > D√° para passar uma fun√ß√£o `createRel` como `rel` nas op√ß√µes do `rehypeExternalLinks`, e devolver o array vazio quando forem links absolutos internos. Ou usar o `test` como voc√™ falou mais abaixo. Pode ser uma boa usar o [`webserver.host`](https://github.com/filipedeschamps/tabnews.com.br/blob/cbcc71c0d94c2182053f099b660005c786e5c3c0/infra/webserver.js#L14) para comparar.
  > > Essa bibliioteca recomenda usar `rehype-sanitize` para conte√∫dos gerados por usu√°rios, mas o [`bytemd` j√° faz isso](https://github.com/bytedance/bytemd/blob/9f2212203c780f2d9775e3c2243171cdeea2e81d/packages/bytemd/src/utils.ts#L38) antes de adicionar os plugins do rehype.
  > > Inclusive n√≥s j√° utilizamos um `sanitize` customizado:
  > > https://github.com/filipedeschamps/tabnews.com.br/blob/cbcc71c0d94c2182053f099b660005c786e5c3c0/pages/interface/components/Markdown/index.js#L91-L98
  > > Coloquei `areLinksTrusted` nas p√°ginas que n√≥s controlamos o conte√∫do.
  > > Legal, e deve valer a pena manter essa possibilidade mesmo se adotar a identifica√ß√£o autom√°tica dos links absolutos internos.
  > > Os links de Fonte continuam sem o `rel="nofollow"` (acho que faz sentido, considerando que a Fonte seja usada da forma adequada, como "origem" do conte√∫do).
  > > N√£o temos como garantir essa "forma adequada", ent√£o acho que devemos seguir a mesma regra dos links no corpo dos conte√∫dos.
  > > Futuramente podemos criar alguma heur√≠stica para n√£o adicionar o plugin em conte√∫dos de usu√°rios confi√°veis
  > > √â uma boa! Outra op√ß√£o √© poder remover por conte√∫do. Usu√°rios confi√°veis poderiam optar por usar TabCash para remover o `nofollow` do conte√∫do. Ideia parecida pode se aplicar a adicionar a tag `canonical`.
  > > ou usar a propriedade `test` para permitir dom√≠nios confi√°veis (GitHub, por exemplo). Um exemplo de `test` que n√£o colocar√° `rel="nofollow"` no link `https://www.github.com/`:
  > > Legal, e acho que j√° podemos colocar o GitHub e o Curso.dev, e tamb√©m o pr√≥prio TabNews, j√° que √© outra forma de resolver o problema que citei sobre os links absolutos internos.
  > > E tamb√©m d√° para adicionar a l√≥gica de verificar os dom√≠nios l√° na `createRel`. Tem que ver o trade-off, pois a ordem de verifica√ß√£o dentro do plugin √© `test && isAbsoluteUrl && rel.length`. Tamb√©m pesa na decis√£o a possibilidade de usar outras fun√ß√µes do `rehype-extenral-links`, pois ao n√£o passar no `test`, nada ser√° feito, enquanto definir `rel=[]` n√£o impede as outras modifica√ß√µes que podem se aplicar aos links externos.

---

Ser√° que a gente deveria permitir o uso de `target="_blank"` nos links criados pelos usu√°rios? Eu acho que n√£o, mas:
Se sim, acho que √© bom adicionar tamb√©m o `noopener`. √â s√≥ passar no `rel` junto com o `nofollow`.
Se n√£o, podemos remover o `target` atrav√©s do sanitize. √â s√≥ mudar isto
https://github.com/filipedeschamps/tabnews.com.br/blob/cbcc71c0d94c2182053f099b660005c786e5c3c0/pages/interface/components/Markdown/index.js#L93
para isto

```js
schema.attributes["*"] = schema.attributes["*"].filter(
  (attr) => !["className", "target"].includes(attr)
);
```

> > Review de aprendendofelipe (COMMENTED):
> > Acabei optando por n√£o usar o `webserver.host` para comparar porque fiz o c√≥digo de forma que possibilita compara√ß√£o desconsiderando o subdom√≠nio do link no `href`. Se for usar o `webserver.host`, precisar√° de um tratamento para remover o subdom√≠nio da string, caso venha a ter um. Acha que faz sentido do jeito que est√°?
> > Sim, faz sentido usar o `TRUSTED_HOSTS`, at√© porque isso pode depois ir para uma vari√°vel de ambiente, se for necess√°rio, e n√£o precisa estar vinculado ao `webserver.host`.
> > Mas fiz uma sugest√£o no c√≥digo que tamb√©m acaba usando o `webserver.host`. Veja se faz sentido.
> > Deixei uma prote√ß√£o para adicionar `rel.push('noopener')` caso voltem a aparecer links com `target="_blank"`, mas se achar desnecess√°rio, eu removo.
> > Compensa deixar. üëç
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > depois me diga se entendi algo errado ou se est√° tudo certo.
> > Do que eu tinha falado, s√≥ faltou testar o protocolo relativo `//`. N√£o acha que compensa?
> > Adicionei o `webserver.host` na lista de dom√≠nios confi√°veis para conseguir testar caminhos relativos com o `localhost`.
> > Show, ent√£o o que acha de usar o `Set` para remover o dom√≠nio duplicado? E tamb√©m sugeri inverti a ordem dos confi√°veis para o que acho que seriam os links mais comuns.
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    const rel = [];
    const url = element.properties.href;
    if (url) {
      if (!isTrustedDomain(url)) {
        rel.push('nofollow');
      }
      if (element.properties.target === '_blank') {
        rel.push('noopener');
      }
    }
    return rel;
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o muda o efeito atual, mas permite sobrescrever o `rel` se for necess√°rio futuramente:

```suggestion
    rehype: (processor) => processor.use(() => rehypeExternalLinks({ rel: createRel, ...options })),
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  it('should trust only specific domains and their subdomains', () => {
```

Para ficar coerente com o conte√∫do do teste, j√° que nem todos retornam `true`

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Na implementa√ß√£o atual, a `url` nunca ir√° chegar aqui sem protocolo. No m√≠nimo vem com o protocolo relativo `//`.
> > Mas realmente √© bom deixar a fun√ß√£o pronta para os outros casos, e ela n√£o iria quebrar com uma `url` com protocolo relativo, como `//tabnews.com.br`, mas a `urlWithProtocol` ficaria bem estranha: `https:////tabnews.com.br`.
> > Ent√£o eu acho que podemos fazer algo como a sugest√£o abaixo, pois onde quer que a fun√ß√£o seja utilizada, ficar√° coerente com o comportamento do ByteMD, que ir√° sempre criar um link relativo se n√£o for fornecido o protocolo.

```suggestion
  const { hostname } = new URL(url, webserver.host);
```

Faz sentido?
Obs. N√£o vejo problemas em ter o `tabnews.com.br` no `TRUSTED_HOSTS`, e usar tamb√©m o `webserver.host`, pois nem sempre ter√£o o mesmo hostname.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O que acha?

```suggestion
  return TRUSTED_HOSTS.some(
    (trustedHostname) => hostname === trustedHostname || hostname.endsWith(`.${trustedHostname}`)
  );
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > A princ√≠pio n√£o h√° nada de errado com o teste, mas ele n√£o bate com o comportamento do ByteMD, que cria o link como relativo se n√£o houver protocolo.
> > Se aceitar a minha sugest√£o de mudan√ßa no `isTrustedDomain`, ent√£o tem que adequar aqui, al√©m de testar tamb√©m os casos de protocolo relativo, que no c√≥digo atual quebrariam, mas que deveriam ser avaliados normalmente.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tudo bem, podemos deixar o mesmo tipo de comportamento do ByteMD e a√≠ deixo isso claro por meio de testes :+1:
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o acha bom testar tamb√©m com protocolo relativo?

```suggestion
    expect(isTrustedDomain('//curso.dev')).toBe(true);
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Pequena otimiza√ß√£o do `trustedHosts.some`:
> > J√° que os itens s√£o analisados pela ordem, √© bom deixar primeiro o que deve ser mais comum.
> > Ent√£o compensa deixar o `webserverHostname` primeiro, tanto para os testes, como para o site em produ√ß√£o.
> > E usar o `Set` para remover o dom√≠nio duplicado para ele n√£o ser avaliado duas vezes em todo link externo.

```suggestion
const DEFAULT_TRUSTED_HOSTS = ['tabnews.com.br', 'github.com', 'curso.dev'];
const webserverHostname = new URL(webserver.host).hostname;
const trustedHosts = [...new Set([webserverHostname, ...DEFAULT_TRUSTED_HOSTS])];
```

</pull_1603_Adicionar rel="nofollow" nos links de conte√∫dos gerados por usu√°rio>

<pull_1604_Exibir sugest√£o rand√¥mica de t√≠tulo no placeholder ao criar conte√∫do>

## Mudan√ßas realizadas

Adicionado l√≥gica para gerar um placeholder rand√¥mico para o campo t√≠tulo do conte√∫do. Para obter o n√∫mero, criei a fun√ß√£o `randomNumberFromInterval` que aceita dois par√¢metros num√©ricos, `min` e `max`, que determinam o range de retorno de um n√∫mero rand√¥mico (sendo o `min` inclusivo, e `max` exclusivo).

```javascript
function randomNumberFromInterval(min, max) {
  return Math.floor(Math.random() * (max - min) + min);
}
```

Criado uma constante `CONTENT_TITLE_PLACEHOLDER_EXAMPLES` e atribu√≠do um array com exemplos de placeholder para o campo t√≠tulo.

```javascript
const CONTENT_TITLE_PLACEHOLDER_EXAMPLES = [
  "e.g. A nova era da computa√ß√£o qu√¢ntica",
  "e.g. Desafios ao empreender como desenvolvedor",
  "e.g. Como funciona o conceito de ownership em Rust",
  "e.g. Top 5 livros fundamentais para desenvolvedores",
  "e.g. Fatos curiosos sobre IA que voc√™ n√£o sabia",
  "e.g. Aplicativos para melhorar sua produtividade",
  "e.g. Como renomear uma branch local no Git?",
];
```

_Observa√ß√£o: a fun√ß√£o `randomNumberFromInterval` e a constante `CONTENT_TITLE_PLACEHOLDER_EXAMPLES` foram adicionadas no mesmo arquivo `Content/index.js`, n√£o encontrei um arquivo que guardem constantes/ fun√ß√µes que s√£o reutilizadas no projeto, e como esses dois s√£o usados apenas nesse mesmo componente/arquivo, acredito que n√£o seja um problema. Quem tiver mais contexto do projeto, por favor dar sugest√µes se n√£o for o correto :smile:._
Utilizei o hook `useRef` do React inicializando j√° com o valor exemplo de placeholder, dessa forma, n√£o temos a altera√ß√£o do placeholder a cada renderiza√ß√£o e/ou renderiza√ß√µes extras (comparei a quantidade de renderiza√ß√µes antes e depois para confirmar).

```javascript
const randomPlaceholderRef = useRef(
  CONTENT_TITLE_PLACEHOLDER_EXAMPLES[
    randomNumberFromInterval(0, CONTENT_TITLE_PLACEHOLDER_EXAMPLES.length)
  ]
);
```

Resolve #1596

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->
<!-- - [x] Corre√ß√£o de bug -->

- [x] Nova funcionalidade
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > @diegosano, muito obrigado pelo PR! üí™
  > > O placeholder n√£o est√° sendo sorteado em produ√ß√£o. Veja:
  > > https://tabnews-git-fork-diegosano-content-random-title-3396bd-tabnews.vercel.app/publicar
  > > Como a p√°gina `/publicar` √© est√°tica, para variar o placeholder ser√° preciso sortear ele com c√≥digo que rode no _client_, provavelmente usando `useEffect` e `useState`.
  > > Review de diegosano (COMMENTED):
  > > Review de diegosano (COMMENTED):
  > > Review de diegosano (COMMENTED):
  > > Review de diegosano (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Agora funcionou legal, @diegosano! üéâ
  > > S√≥ vou esperar um pouco para ver se surgem novas sugest√µes de exemplos.
  > > N√£o gostei muito das que est√£o abaixo, mas se ningu√©m sugerir nada diferente, vamos deixar assim.
  > > Por isso, j√° pode fazer `squash` dos commits para deixar o PR pronto para _merge_. ü§ù

```
'e.g. A nova era da computa√ß√£o qu√¢ntica',
'e.g. Fatos curiosos sobre IA que voc√™ n√£o sabia',
```

Esta eu talvez trocaria o `Aplicativos` por `Ferramentas`. O que acham?
`'e.g. Ferramentas para melhorar sua produtividade',`

> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > troquei para as sugest√µes que voc√™s deram, fiz o squash dos commits üöÄ
> > Show @diegosano! üí™
> > S√≥ uma d√∫vida, mais de curioso mesmo, do porqu√™ do squash ser feito na branch, e n√£o no merge do pr√≥prio GitHub (op√ß√£o de "Squash and Merge")?
> > N√£o √© obrigat√≥rio. √â s√≥ para eu n√£o ficar como coautor do commit. O mesmo vale para o rebase.
> > Mas como eu tive que fazer o rebase, fiquei como coautor. ü§ù
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Que tal deixar essa constante no topo do arquivo, logo abaixo das importa√ß√µes?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se n√£o houver algum JavaScript rodando no _client_ para efetuar o sorteio, ent√£o o placeholder vai ser definido de forma aleat√≥ria em tempo de build, mas a partir da√≠ ele fica fixo.
> > O NextJS em modo de desenvolvimento gera as p√°ginas a cada navega√ß√£o/atualiza√ß√£o, mas em produ√ß√£o isso n√£o ocorre para as p√°ginas est√°ticas.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Sugiro criar a fun√ß√£o que j√° devolve o placeholder:

```suggestion
  return CONTENT_TITLE_PLACEHOLDER_EXAMPLES[Math.floor(Math.random() * CONTENT_TITLE_PLACEHOLDER_EXAMPLES.length);
```

> > Coment√°rio de diegosano (linha de c√≥digo):
> > Boa, vou fazer as altera√ß√µes!
> > Coment√°rio de diegosano (linha de c√≥digo):
> > Feito!
> > Coment√°rio de diegosano (linha de c√≥digo):
> > Feito!
> > Coment√°rio de diegosano (linha de c√≥digo):
> > Feito!
> > Optei por inicializar o useState com uma string vazia ("") ao inv√©s de iniciar com um placeholder, para n√£o gerar um efeito de troca de texto estranho ap√≥s o useEffect rodar, ficando apenas um leve intervalo at√© aparecer. O que acha?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Passou pela minha cabe√ßa agora, acho que essa frase fica melhor sem a palavra `Top` no in√≠cio.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > E se mudarmos para algo como `Como os jogos de Atari eram desenvolvidos`? O tom de pergunta me incomodou um pouco, mas fora isso achei legal.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Meu receio com not√≠cias era mencionar uma marca ou produto espec√≠fico, mas acho que conseguimos simular uma not√≠cia de uma linguagem de programa√ß√£o, como `Nova vers√£o do Python √© anunciada com melhorias de desempenho`.
> > </pull_1604_Exibir sugest√£o rand√¥mica de t√≠tulo no placeholder ao criar conte√∫do>

<pull_1605_Responder "O que √© o TabNews" no FAQ (e outras melhorias)>

## Mudan√ßas realizadas

Realizei algumas altera√ß√µes comentadas em https://github.com/filipedeschamps/tabnews.com.br/issues/1380#issuecomment-1888853812 e https://github.com/filipedeschamps/tabnews.com.br/issues/1380#issuecomment-1893716522.
A resposta para a pergunta "O que √© o TabNews" veio com base no que consegui juntar das [respostas no TabNews](https://www.tabnews.com.br/rafael/o-que-e-o-tabnews). Devido √†s respostas, decidi ler as defini√ß√µes de F√≥rum ([en](https://en.wikipedia.org/wiki/Internet_forum), [pt](https://pt.wikipedia.org/wiki/F%C3%B3rum_de_discuss%C3%A3o)) e do Reddit ([en](https://en.wikipedia.org/wiki/Reddit), [pt](https://pt.wikipedia.org/wiki/Reddit)) para procurar uma intersec√ß√£o com o TabNews. J√° deixei essa resposta tamb√©m no `README.md`, conforme discutido [aqui](https://github.com/filipedeschamps/tabnews.com.br/pull/1583#discussion_r1449797274).
Acredito que as respostas tendem a melhorar conforme h√° intera√ß√µes de outras pessoas para a constru√ß√£o delas, ent√£o interpretem isso como uma "sugest√£o inicial". A revis√£o desse PR √© importante e qualquer membro do TabNews pode colaborar.

> > Review de aprendendofelipe (APPROVED):
> > </pull_1605_Responder "O que √© o TabNews" no FAQ (e outras melhorias)>

<pull_1606_React-email e componentiza√ß√£o de emails>

## Mudan√ßas realizadas

<!-- Por favor, inclua uma descri√ß√£o sobre o que foi modificado nesse PR. Inclua tamb√©m qualquer motiva√ß√£o ou contexto relevante.  -->

Reimplementa√ß√£o do PR #1082
Esse PR adiciona a possibilidade utiliza√ß√£o de HTML para a cria√ß√£o do templates de email.
_\*Ainda preciso corrigir os testes_

---

### React-email

A base dessa feature √© o [react-email](https://react.email/docs/introduction).
Al√©m de facilitar a cria√ß√£o dos templates utilizando a estrutura de componentes, ele tamb√©m lida com as complexidades de layout necess√°rias para garantir a consist√™ncia entre leitores de email.
Outra vantagem do react-email √© seu servidor de desenvolvimento, nele √© poss√≠vel ver instantaneamente as altera√ß√µes no componentes.

---

### Detalhes da implementa√ß√£o

Para facilitar o desenvolvimento e isolar todas as depend√™ncia criei um novo m√≥dulo, o `@tabnews/mail`, que fica respons√°vel por tudo isso, a principio essa estrutura era s√≥ um teste, mas acho que funcionou bem.
Tamb√©m fiz uma adi√ß√£o ao docker-compose para subir automaticamente o servidor do react-email, mas n√£o sei se √© algo necess√°rio.

<!-- Se o PR cont√©m uma modifica√ß√£o da interface gr√°fica (UI), adicione fotos ou v√≠deos comparando o antes e depois. -->

---

### Resultado

https://github.com/filipedeschamps/tabnews.com.br/assets/30873873/eb014bfa-1f7b-4913-8379-6f43998bf5f6

### Cria√ß√£o de novos templates

1. Crie um novo componente em `mail/email/`

```jsx
// mail/email/new-component.js
import { Text } from "@react-email/text";
import { DefaultLayout } from "mail/components/default-layout";
export const NewComponentEmail = ({ username }) => (
  <DefaultLayout username={username} previewText="Novo template de email">
    <Text style={text}>Este √© um novo componente de email</Text>
  </DefaultLayout>
);
NewComponentEmail.PreviewProps = {
  username: "User",
};
export default NewComponentEmail;
const text = {
  color: "#333",
  fontSize: "14px",
  margin: "24px 0",
};
```

2. Exporte o componente no arquivo `mail/index.js`

```js
// mail/email/index.js
export { NewComponentEmail } from "./emails/new-component";
```

3. Utilize o template

```js
import { ActivationEmail } from '@tabnews/mail';
import email from 'infra/email.js';
function sendNewEmail() {
  await email.send({
    from: {
      name: 'TabNews',
      address: 'contato@tabnews.com.br',
    },
    to: 'example@email.com',
    subject: 'Novo template de email',
    component: NewComponentEmail({
      username: 'username',
    }),
  });
}
```

<!-- Se o PR cont√©m modifica√ß√µes de API, mencione os endpoints afetados. -->
<!-- Caso esse PR resolva algum issue, voc√™ pode descomentar a linha abaixo e substituir (issue) pelo n√∫mero dele. -->
<!-- Resolve #(issue) -->

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->
<!-- - [x] Corre√ß√£o de bug -->

- [x] Nova funcionalidade
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [ ] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (COMMENTED):
  > > Parece uma adi√ß√£o legal, o `react-email` traz algumas facilidades se comparado ao desenvolvimento manual, al√©m de estar "levemente" relacionado ao Resend (https://github.com/filipedeschamps/tabnews.com.br/issues/1451).
  > > Vi um teste que quebrou, aparentemente foi porque o `Heading` transforma tudo para caixa alta no modo texto. N√£o sei se tem uma op√ß√£o para ele n√£o fazer isso, assim n√£o precisaria modificar os testes.
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Que massa @ErickCReis! üí™üí™üí™
  > > Ainda n√£o olhei os templates, mas j√° tenho algumas considera√ß√µes para pensarmos.
  > > N√£o estou convencido sobre a necessidade de se criar um m√≥dulo separado. Ainda n√£o consegui ver alguma vantagem, pelo menos n√£o na forma como est√° no PR. Mas tamb√©m n√£o tenho nada contra. üëç
  > > Se for o caso de deixar separado, ent√£o √© interessante que ele foque em algo espec√≠fico, como nos layouts das mensagens, mas sem a logo, endere√ßo ou nada espec√≠fico do TabNews. Tudo que for espec√≠fico pode ser recebido via propriedades. Faz sentido?
  > > Sobre os templates, se vai ser criado um arquivo separado para cada modelo de mensagem de email, ser√° que n√£o faz sentido a vers√£o em texto simples ser gerada por uma fun√ß√£o presente no mesmo arquivo, atrav√©s dos mesmos par√¢metros? Acho melhor do que converter para html e depois converter de volta para texto. E os testes devem verificar as duas vers√µes (html e text), correto?
  > > Deixei mais coment√°rios e d√∫vidas no c√≥digo ü§ù
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Acho que n√£o precisamos disso mesmo. O script no `package.json` j√° resolve e permite a pessoa iniciar o servi√ßo apenas se precisar dele.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Acho que esse comando n√£o funciona no CMD do Windows. Para que voc√™ precisa do `cp`? Eu criei um script no `package.json` principal, tirei o `cp` deste e (aparentemente) funcionou rodando tanto pelo diret√≥rio raiz quando pelo `mail`.

```json
"email": "cd mail && npm run dev",
```

O nome "email" foi s√≥ para testar, pode escolher um nome melhor. Acho √∫til termos o comando no `package.json` principal.
O problema que vi foi que o Logo n√£o apareceu:
Imagino que era para isso que voc√™ precisava do `cp`? Seria interessante pensarmos numa alternativa, principalmente porque no meu Linux o `cp` dava erro de permiss√£o.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > O `alt` fica melhor sendo apenas `TabNews`, pode ver isso pela print que coloquei em outro coment√°rio, e tamb√©m com base no [a11y project](https://www.a11yproject.com/posts/alt-text/):
> > Make sure the description of the image is useful. For example, if the image is of a company's logo, the `alt` should be the company's name. The word "logo" is not necessary or useful as part of the alternative text.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que essa frase pode ter a mesma cor das outras.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Voc√™ chegou a mexer no `package.json` depois de ter instalado? Quando eu instalei aqui localmente algumas coisas do `package-lock.json` mudaram. Por exemplo, embaixo dessa linha ele adicionou:

```json
      "name": "@tabnews/mail",
```

E adicionou alguns pacotes no `mail/package-lock.json`.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ficou interessante ter as depend√™ncias separadas, √© uma boa organiza√ß√£o, mas um ponto negativo disso √© que ele duplica algumas depend√™ncias (e.g. `react`).
> > Eu nunca usei [workspaces](https://docs.npmjs.com/cli/v8/using-npm/workspaces), sabe se essa funcionalidade resolve esse problema?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que essa frase pode ter a mesma cor das outras.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Essa era um d√∫vida mesmo, mas como esse servi√ßo vai ser utilizado poucas vezes tamb√©m concordo em n√£o deixar no docker-compose.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Acabei esquecendo do windows mesmo, mas de qualquer forma essa era uma solu√ß√£o tempor√°ria, essa parte s√≥ serve para pegar a porta correta do localhost do projeto principal que √© a fonte das imagens. Vou procurar uma maneira melhor de resolver isso.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > N√£o lembro, mas provavelmente mexi mesmo kkk, vou atualiza isso no pr√≥ximo commit.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Para conseguir rodar o `@tabnews/mail` de forma independente acho que n√£o vamos conseguir fugir disso.
> > Eu nunca usei [workspaces](https://docs.npmjs.com/cli/v8/using-npm/workspaces), sabe se essa funcionalidade resolve esse problema?
> > Eu s√≥ mexi com workspaces no pnpm e acho que ele lida com isso, mas vou verificar como funciona no npm.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Chegou a testar usando apenas as depend√™ncias `react-email` e `@react-email/components`? Tem alguma diferen√ßa pr√°tica em usar cada componente separadamente.
> > Sobre workspaces, tem na [documenta√ß√£o do react email](https://react.email/docs/getting-started/monorepo-setup/npm).
> > Eu gostei da sugest√£o de nome da pasta que consta na documenta√ß√£o. `/transactional/emails` caberia tanto na pasta `/packages` como na `/models`, dependendo se for ou n√£o criar o m√≥dulo separado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que faz sentido o `infra/email` depender do `@tabnews/mail`?
> > N√£o √© melhor ele receber o `html` pronto de quem for enviar o email:

```suggestion
async function send({ from, to, subject, html, text}) {
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Esse `import webserver from '../../infra/webserver'` contradiz a ideia de isolar as depend√™ncias.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que n√£o faz sentido cada template j√° devolver as duas vers√µes (html e text)?
> > Tamb√©m d√° para o `reactRender` ser chamado de dentro dos templates. Faz sentido? N√£o me parece ter necessidade de cada local do c√≥digo que for usar o template ter que importar tamb√©m o render.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Chegou a testar usando apenas as depend√™ncias `react-email` e `@react-email/components`? Tem alguma diferen√ßa pr√°tica em usar cada componente separadamente.
> > Testei sim e n√£o tem diferen√ßa nenhuma, o √∫nico detalhe √© que alguns componentes s√£o bem mais pesados (`tailwind` e `code-block` por exemplo) ent√£o n√£o queria deixar eles sempre dispon√≠veis. Mas agora parando para pensar n√£o sei √© uma preocupa√ß√£o necess√°ria j√° que podemos ver isso no code review.
> > Sobre workspaces, tem na [documenta√ß√£o do react email](https://react.email/docs/getting-started/monorepo-setup/npm).
>
> Eu gostei da sugest√£o de nome da pasta que consta na documenta√ß√£o. `/transactional/emails` caberia tanto na pasta `/packages` como na `/models`, dependendo se for ou n√£o criar o m√≥dulo separado.
> Massa, n√£o tinha reparado nesse item da documenta√ß√£o, vou testar essa estrutura, mas a princ√≠pio faz bastante sentido, s√≥ precisamos decidir se vamos seguir com a ideia de m√≥dulos ou n√£o.
>
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Sim, adicionei esse trecho apenas para conseguir a url da logo, vou pensar uma solu√ß√£o melhor.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Acho que faz sim!
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Sim, adicionei esse trecho apenas para conseguir a url da logo, vou pensar uma solu√ß√£o melhor.
> > Se deixar o m√≥dulo respons√°vel apenas pelo design, isso ser√° passado junto com os par√¢metros. Se for um m√≥dulo separado, acredito que seja a melhor forma.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Quando for fazer os pr√≥ximos ajustes, pode desfazer essa modifica√ß√£o para o arquivo n√£o aparecer na lista.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > @ErickCReis depois confirma de novo, por favor. Aqui ainda deu diferen√ßa quando executei `npm install` (as linhas `18286` at√© `18345` foram removidas). S√≥ estou lembrando aqui porque estava marcando as an√°lises como resolvidas.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ser√° que fica melhor se exportar uma fun√ß√£o para `DefaultLayoutText`, que recebe os par√¢metros necess√°rios e retorna o conte√∫do j√° com o cabe√ßalho e rodap√©? Algo como:

```js
`Ol√°, ${username}!
${text}
${footerText}`;
```

Dessa forma, os arquivos em `emails` s√≥ precisam conhecer o texto deles mesmo, sem saber se tem `footer`, se tem nome do usu√°rio no come√ßo etc.

> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > N√£o entendi o que est√° acontecendo, mas quando rodo os testes meu `package-lock` √© alterado, agora deve estar certo, rodei o install antes do commit.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Realmente, ao executar os testes aparece isso no log:

```sh
[jest] warn  - Found lockfile missing swc dependencies, patching...
[jest] warn  - Lockfile was successfully patched, please run "npm install" to ensure @next/swc dependencies are downloaded
```

E s√£o depend√™ncias do SWC:

```json
"node_modules/react-email/node_modules/@next/swc-android-arm-eabi": {
  "version": "13.2.4",
  "resolved": "https://registry.npmjs.org/@next/swc-android-arm-eabi/-/swc-android-arm-eabi-13.2.4.tgz",
  "integrity": "sha512-DWlalTSkLjDU11MY11jg17O1gGQzpRccM9Oes2yTqj2DpHndajrXHGxj9HGtJ+idq2k7ImUdJVWS2h2l/EDJOw==",
  "cpu": [
    "arm"
  ],
  "optional": true,
  "os": [
    "android"
  ],
  "engines": {
    "node": ">= 10"
  }
},
"node_modules/react-email/node_modules/@next/swc-android-arm64": {
  "version": "13.2.4",
  "resolved": "https://registry.npmjs.org/@next/swc-android-arm64/-/swc-android-arm64-13.2.4.tgz",
  "integrity": "sha512-sRavmUImUCf332Gy+PjIfLkMhiRX1Ez4SI+3vFDRs1N5eXp+uNzjFUK/oLMMOzk6KFSkbiK/3Wt8+dHQR/flNg==",
  "cpu": [
    "arm64"
  ],
  "optional": true,
  "os": [
    "android"
  ],
  "engines": {
    "node": ">= 10"
  }
},
"node_modules/react-email/node_modules/@next/swc-freebsd-x64": {
  "version": "13.2.4",
  "resolved": "https://registry.npmjs.org/@next/swc-freebsd-x64/-/swc-freebsd-x64-13.2.4.tgz",
  "integrity": "sha512-kkbzKVZGPaXRBPisoAQkh3xh22r+TD+5HwoC5bOkALraJ0dsOQgSMAvzMXKsN3tMzJUPS0tjtRf1cTzrQ0I5vQ==",
  "cpu": [
    "x64"
  ],
  "optional": true,
  "os": [
    "freebsd"
  ],
  "engines": {
    "node": ">= 10"
  }
},
"node_modules/react-email/node_modules/@next/swc-linux-arm-gnueabihf": {
  "version": "13.2.4",
  "resolved": "https://registry.npmjs.org/@next/swc-linux-arm-gnueabihf/-/swc-linux-arm-gnueabihf-13.2.4.tgz",
  "integrity": "sha512-7qA1++UY0fjprqtjBZaOA6cas/7GekpjVsZn/0uHvquuITFCdKGFCsKNBx3S0Rpxmx6WYo0GcmhNRM9ru08BGg==",
  "cpu": [
    "arm"
  ],
  "optional": true,
  "os": [
    "linux"
  ],
  "engines": {
    "node": ">= 10"
  }
}
```

E ao executar o `npm install` novamente, as depend√™ncias s√£o removidas do `package-lock.json`. Pelos testes que fiz, isso s√≥ acontece com o `react-email` na lista de depend√™ncias. N√£o consegui achar nenhuma refer√™ncia espec√≠fica para o NextJS na documenta√ß√£o do `react-email` em rela√ß√£o √†s depend√™ncias...

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o sei se tem rela√ß√£o, mas o `react-email` foi instalado como depend√™ncia apenas de desenvolvimento. Est√° certo isso?
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Est√° sim, o `react-email` √© apenas o servidor de desenvolvimento/preview dos emails, quem faz a renderiza√ß√£o √© o `@react-email/render`.
> > Estou procurando alguma informa√ß√£o sobre isso, mas n√£o achei nada ainda.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu fiz um teste aqui e parece que atualizar a vers√£o do `next` resolve o warning, mas tamb√©m quebra a aplica√ß√£o, mesmo se eu atualizar apenas para `13.3.0`:

```
error - ./node_modules/next/dist/compiled/@vercel/og/index.node.js:17950:0
Module not found: Can't resolve 'fs'
https://nextjs.org/docs/messages/module-not-found
Import trace for requested module:
./node_modules/next/dist/server/web/spec-extension/image-response.js
./node_modules/next/server.js
./node_modules/next-swr/dist/next-swr.esm.js
./pages/_app.public.js
```

@aprendendofelipe sabe dizer se isso ocorre porque a vers√£o do Next precisa ser a mesma no TabNews e no `next-swr`?
Edit: Ah, acabei de ver no [README do `next-swr`](https://github.com/aprendendofelipe/next-swr?tab=readme-ov-file#incompatibility) que ele n√£o suporta a vers√£o 13.3.0 do `next`, mas acho que o problema de compatibilidade persiste com as vers√µes mais recentes do `next` tamb√©m.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ah, acabei de ver no [README do `next-swr`](https://github.com/aprendendofelipe/next-swr?tab=readme-ov-file#incompatibility) que ele n√£o suporta a vers√£o 13.3.0 do `next`, mas acho que o problema de compatibilidade persiste com as vers√µes mais recentes do `next` tamb√©m.
> > Sim @Rafatcb, uma mudan√ßa no NextJS obrigava a mudar a forma de exportar as partes do `next-swr`. Eu j√° tinha corrigido isso, mas n√£o tinha lan√ßado a nova vers√£o porque queria adicionar testes, o que fiz hoje. Ent√£o a `0.2.0-canary.0` √© compat√≠vel com as novas vers√µes do NextJS.
> > J√° estou testando o que mais d√° pra atualizar no TabNews para abrir um PR, mas o Primer est√° impedindo algumas atualiza√ß√µes.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Fiz alguns testes aqui mas n√£o consegui encontrar a causa desse problema, mas √© algum conflito entre nextjs e jest mesmo, mudei do jest para vitest aqui e o package-lock n√£o foi mais alterado.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > O PR #1622 do @aprendendofelipe com a atualiza√ß√£o das depend√™ncias j√° foi integrado na `main`. Pode fazer o `rebase` e testar se resolveu esse problema.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Problema resolvido!
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Problema resolvido!
> > Ap√≥s a mensagem de problema resolvido, teve mais um push com [uma modifica√ß√£o significativa](https://github.com/filipedeschamps/tabnews.com.br/compare/eab48c6917a04dde7c8a0abc607ffeb1963f6aa5..0d892ddd42be68a070e74f9fe74fccb2eac4cc87) no `package-lock.json`, tanto que n√£o d√° para ver o diff aqui no GitHub. O que seriam as novas 15k linhas?
> > Por que adicionou o arquivo `.tool-versions`?
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Ap√≥s a mensagem de problema resolvido, teve mais um push com [uma modifica√ß√£o significativa](https://github.com/filipedeschamps/tabnews.com.br/compare/eab48c6917a04dde7c8a0abc607ffeb1963f6aa5..0d892ddd42be68a070e74f9fe74fccb2eac4cc87) no `package-lock.json`, tanto que n√£o d√° para ver o diff aqui no GitHub. O que seriam as novas 15k linhas?
> > Esse √∫ltimo commit foi justamente para atualizar o `package-lock` que tinha ficado errado ap√≥s o rebase, tamb√©m achei estranho a quantidade de novas depend√™ncias, mas refiz a instala√ß√£o aqui e o resultado foi o mesmo.
> > Vou dar mais uma analisada aqui, mas acredito que a maioria dessas novas depend√™ncias venham do `react-email` e s√£o utilizadas apenas em dev.
> > Por que adicionou o arquivo `.tool-versions`?
> > Vou remover aqui, acabei subindo sem querer. Esse arquivo que gerencia minhas vers√µes do node atrav√©s do `asdf`.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > @aprendendofelipe fiz alguns testes na `main`:

- Instalando as novas depend√™ncias desse pr:

```bash
$ git diff --stat main package-lock.json
 package-lock.json | 22963 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------
 1 file changed, 14724 insertions(+), 8239 deletions(-)
```

- Instalando apenas as depend√™ncias obrigat√≥rias: `@react-email/components` e `@react-email/render`

```bash
$ git diff --stat main package-lock.json
 package-lock.json | 1209 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------
 1 file changed, 1072 insertions(+), 137 deletions(-)
```

- Instalando apenas o react-email

```bash
$ git diff --stat main package-lock.json
 package-lock.json | 11089 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------
 1 file changed, 8865 insertions(+), 2224 deletions(-)
```

---

N√£o sei se isso √© um problema de fato, j√° que o react-email √© uma depend√™ncia de desenvolvimento, mas realmente n√£o √© algo muito legal, o primeiro `npm install` deve demorar alguns segundos a mais, o que deve atrapalhar o CI tamb√©m.
A princ√≠pio vejo 3 op√ß√µes:

1. Deixamos como est√°;
2. Removemos o react-email das depend√™ncias e colocamos algumas instru√ß√µes extras no `CONTRIBUTING.md` explicando esse processo de instala√ß√£o apenas para testes;
3. Removemos totalmente o react-email, com isso os testes e altera√ß√µes nos templates poder√£o ser testados apenas atrav√©s do `mailcatcher`.
   N√£o sei qual √© a melhor op√ß√£o, se tiverem alguma outra ideia posso testar/implementar aqui.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Acho que n√£o tem problema deixar como est√°. N√£o teve diferen√ßa no CI üëç
   > > Eu s√≥ n√£o vi como ficaram os templates, mas vou tentar fazer isso ainda hoje ü§ù
   > > </pull_1606_React-email e componentiza√ß√£o de emails>

<pull_1607_Exibir (e retornar via API) a quantidade de qualifica√ß√µes positivas e negativas do conte√∫do>

## Mudan√ßas realizadas

### Backend

Agora, duas novas propriedades s√£o retornadas junto do conte√∫do: `tabcoins_credit` e `tabcoins_debit`. Em consultas que retornavam `tabcoins` de um conte√∫do, essas novas propriedades tamb√©m s√£o retornadas (exemplo: ao qualificar um conte√∫do).
Endpoints afetados:

- `GET /api/v1/contents`
- `POST /api/v1/contents`
- `GET /api/v1/contents/[username]`
- `GET /api/v1/contents/[username]/[slug]`
- `PATCH /api/v1/contents/[username]/[slug]`
- `GET /api/v1/contents/[username]/[slug]/children`
- `GET /api/v1/contents/[username]/[slug]/parent`
- `GET /api/v1/contents/[username]/[slug]/root`
- `POST /api/v1/contents/tabcoins`

### Frontend

A apresenta√ß√£o na UI √© feita por meio de um Tooltip, tanto na lista de conte√∫dos quanto na p√°gina do conte√∫do, para a publica√ß√£o e para os coment√°rios.
| Lista de conte√∫dos | Conte√∫do |
| ------------------ | -------- |
| | |
Resolve #1370

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  >
  > 1. Faz sentido mandarmos `tabcoins_debit` como um valor <= 0 ou deveria ser um valor positivo (>= 0)?
  >    Acho um pouco estranho retornar o valor negativo j√° que possui d√©bito no nome, mas parece que facilitou a implementa√ß√£o, ent√£o n√£o vejo problemas.
  > 2. Usei o `EXPLAIN ANALYZE` e a fun√ß√£o `get_current_balance_credit_debit` trouxe um custo (aparentemente) relevante nas queries. Pode ser algo espec√≠fico do `EXPLAIN ANALYZE`, que na pr√°tica n√£o fa√ßa diferen√ßa. Precisa avaliar o tempo de execu√ß√£o com mais dados (homologa√ß√£o/produ√ß√£o). Enxergam alguma melhoria para as queries alteradas?
  >    Precisamos pensar em como melhorar isso. Talvez at√© mudar algo na modelagem.
  >    Uma op√ß√£o para "contornar" esse custo seria calcular os votos sob demanda, realizando uma requisi√ß√£o separada. Na UI atual, essa requisi√ß√£o seria disparada ao realizar o `hover` nos votos.
  >    Principalmente por ser custoso, precisa ter cache, e como seria um cache diferente dos dados da p√°gina est√°tica, ficaria inconsistente com muita frequ√™ncia.
  >
  > - [`b434a45`](https://github.com/filipedeschamps/tabnews.com.br/commit/b434a45b82b13deffb5a2224e4f2425c5f4dda33): retorno ao buscar um conte√∫do espec√≠fico (`GET /contents/[username]/[slug]`, `GET /contents/[username]/[slug]/parent` e `GET /contents/[username]/[slug]/root`) com teste espec√≠fico. Defini se deve retornar com base no `values.limit === 1`, se ter uma sugest√£o melhor, pode falar.
  >   Se conseguirmos melhorar o desempenho, acho que compensaria sempre retornar o cr√©dito e d√©bito e mostrar isso tamb√©m na lista de conte√∫dos.
  >   Acham melhor criar um novo teste espec√≠fico nos arquivos para testar esses valores de `tabcoins_credit` e `tabcoins_debit`?
  >   Acho que compensa um teste espec√≠fico.
  >   Est√° quebrado em homologa√ß√£o, imagino que por causa da migra√ß√£o que n√£o foi executada.
  >   Quando estiver tudo definido, vamos precisar quebrar o PR em dois, e a migration fica no primeiro PR. Assim n√£o quebra nada, principalmente em produ√ß√£o.
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Show, concordo com todas as √∫ltimas melhorias! üëçüëçüëç
  >   > S√≥ veja se faz sentido minha sugest√£o no c√≥digo ou se mantemos assim. N√£o √© nada demais.

---

Testando esse PR em homologa√ß√£o eu percebi que alguns conte√∫dos estavam com dados estranhos, e pareciam ter 2 TabCoins iniciais (veja este [exemplo](https://tabnews-git-return-content-tabcoins-credits-and-debits-tabnews.vercel.app/api/v1/contents/Esdras14j/hummmmmmmmmm-teste-ne)).
Investigando isso, descobri que, em homologa√ß√£o, 111 conte√∫dos criados entre 01 e 03/07/2022 realmente ficaram com dois TabCoins iniciais, pois o script que o Filipe rodou para creditar os conte√∫dos antigos acabou duplicando os cr√©ditos nesse conte√∫dos. Isso deve ter ocorrido, provavelmente, porque nesse per√≠odo existiam vers√µes em homologa√ß√£o rodando em paralelo, algumas que creditavam e outras que ainda n√£o creditavam TabCoins, ent√£o deve ter sido uma decis√£o entre duplicar alguns ao inv√©s de deixar outros sem nenhum cr√©dito inicial.
Ent√£o √© isso, 111 conte√∫dos em homologa√ß√£o tem 2 TabCoins iniciais, mas em produ√ß√£o est√° tudo certo. üëç

---

S√≥ que essa verifica√ß√£o acima me fez perceber que faltou um detalhe no `UPDATE` de `balance_operations`, pois as transa√ß√µes desfeitas devido ao banimento de usu√°rios ficaram como `content:tabcoin:initial`, quando o correto era ser `content:tabcoin:credit` ou `content:tabcoin:debit`, e com sinais trocados, ou seja, para desfazer um cr√©dito indevido, √© criado um novo cr√©dito com o valor negativo.
J√° vou atualizar meu [coment√°rio](https://github.com/filipedeschamps/tabnews.com.br/pull/1624#issuecomment-1950231245) no #1624 que descreve os scripts que devem ser executados para o `UPDATE` de `balance_operations`. Eu j√° rodei os scripts e fiz tamb√©m o `REINDEX`. üëç

> > Review de aprendendofelipe (DISMISSED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que n√£o compensa retornar os cr√©ditos e d√©bitos mesmo quando est√° devolvendo a lista de conte√∫dos?
> > O Tooltip com a mesma informa√ß√£o pode aparecer na lista de conte√∫dos e no conte√∫do em si.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu havia removido tanto pela quest√£o do custo maior quanto pela falta de espa√ßo para exibir essa informa√ß√£o. Um Tooltip resolveria o segundo ponto.
> > Se descobrirmos como resolver o primeiro, podemos devolver tamb√©m nas listas de conte√∫dos.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Apenas para diminuir a emiss√£o de carbono processando o que n√£o ser√° utilizado üòÖ

```suggestion
    if (total === 0) {
      return `Nenhum voto`;
    }
    const creditPercentage = Math.round((credit / total) * 100);
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Estava em d√∫vida entre deixar como voc√™ sugeriu ou deixar todas as constantes agrupadas. Vou alterar conforme sua sugest√£o.
> > </pull_1607_Exibir (e retornar via API) a quantidade de qualifica√ß√µes positivas e negativas do conte√∫do>

<pull_1613_Adiciona Turnstile para executar os desafios da Cloudflare sempre que for necess√°rio>
Resolve o problema que ocorre quando estamos com medidas de seguran√ßa ativadas na Cloudflare e que acabam bloqueando requisi√ß√µes leg√≠timas, principalmente as que ocorrem em segundo plano (requisi√ß√µes para API ou prefetch de dados para navega√ß√£o SPA).
Quando medidas de seguran√ßa est√£o ativadas, a Cloudflare desafia os navegadores para detectar ferramentas automatizadas. Em alguns casos o desafio pode exigir alguma intera√ß√£o do usu√°rio, mas geralmente ocorre de forma autom√°tica.
No modo normal, esses desafios s√£o enviados como uma p√°gina HTML, ent√£o requisi√ß√µes em segundo plano n√£o s√£o capazes de executar o desafio, e acabam sendo bloqueadas.

## Mudan√ßas realizadas

Esse PR adiciona a ferramenta [Turnstile da Cloudflare](https://developers.cloudflare.com/turnstile/), que nos permite disparar a execu√ß√£o dos desafios via JS, seja em segundo plano, ou em um iframe.
Ent√£o agora verificamos todas as requisi√ß√µes com falha para saber se o bloqueio ocorreu por falta do desafio da Cloudflare (caso em que √© retornado o cabe√ßalho `cf-mitigated: challenge`). Sempre que o bloqueio for pela falta do desafio, ele ser√° executado automaticamente (pode ser em segundo plano ou interativo, quem decide √© a Cloudflare).
Ap√≥s a resolu√ß√£o do desafio, todas as requisi√ß√µes que tinham sido bloqueadas ser√£o disparadas mais uma vez, j√° que foi criada uma fila espec√≠fica para isso. Se o desafio n√£o for interativo, isso ir√° ocorrer de forma totalmente transparente, parecendo apenas que a conex√£o ficou um pouco mais lenta at√© que o desafio seja conclu√≠do.
J√° se o desafio for interativo, ser√° aberto um modal com o iframe da Cloudflare solicitando a confirma√ß√£o:
Como esse modal bloqueia a utiliza√ß√£o do site, implementei uma sa√≠da alternativa para quem n√£o quiser resolver o desafio. Basta tocar em qualquer lugar fora do iframe e ser√° dada a op√ß√£o de ignorar a verifica√ß√£o.
Implementei essa possibilidade de ignorar, principalmente, para o caso de ocorrer algum problema moment√¢neo com a verifica√ß√£o Cloudflare que atrapalhe a navega√ß√£o normal.
Caso a verifica√ß√£o seja ignorada, ela n√£o tentar√° novamente durante a mesma sess√£o, o que implicar√° em um uso limitado do site. Ap√≥s atualizar a p√°gina (ou qualquer navega√ß√£o que n√£o seja SPA), a verifica√ß√£o ser√° tentada novamente.
As requisi√ß√µes bloqueadas definitivamente pela Cloudflare, seja pelo usu√°rio ter ignorado o desafio ou por algo suspeito que seja enviado nos dados da requisi√ß√£o, v√£o devolver uma mensagem que deixa claro que houve o bloqueio, n√£o sendo mais exibida a mensagem que pedia para verificar se o servi√ßo estava dispon√≠vel. Como a requisi√ß√£o n√£o chega at√© o TabNews, essa substitui√ß√£o da mensagem ocorre no _client_.
Com essa modifica√ß√£o foi poss√≠vel remover o m√©todo alternativo que existia no `useUser` e que fazia um refresh autom√°tico na p√°gina de login se ocorresse um bloqueio na requisi√ß√£o que busca dados do usu√°rio. Essa nova vers√£o √© melhor porque se aplica para qualquer requisi√ß√£o, n√£o exige mais que a p√°gina seja recarregada para executar o desafio e volta a estrat√©gia do `useUser` de n√£o enviar requisi√ß√£o para `/api/v1/user` se n√£o for necess√°rio.

- Resolve #1344
- Resolve #1609
- Resolve #1516
- Resolve #1170

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de github-advanced-security[bot] (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Que bom que deu para resolver os issues sobre diferenciar o retorno da Cloudflare :tada:
  > > A implementa√ß√£o parece OK, mas fiquei com duas d√∫vidas que deixei na revis√£o.
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Client-side URL redirect

Untrusted URL redirection depends on a [user-provided value](1).
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/39)

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o entendi bem esta parte. O `check` acabou de ser invocado, mas se tem algo na fila, ele ser√° invocado novamente? Por que isso √© necess√°rio e em que tipo de situa√ß√£o isso acontece?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Essa mensagem √© para o bloqueio da Cloudflare certo? (fiquei em d√∫vida por causa do `Firewall` mencionado acima).
> > Se minha requisi√ß√£o √© bloqueada pela Cloudflare, existe algo mais espec√≠fico que eu possa fazer para resolver? Imaginando que eu recebesse a mensagem _"Verifique seu equipamento e os dados enviados"_, eu ficaria sem saber o que fazer.
> > Tamb√©m n√£o sei se o Cloudflare acaba barrando humanos, acho que isso nunca ocorreu comigo.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Essa mensagem √© para o bloqueio da Cloudflare certo? (fiquei em d√∫vida por causa do `Firewall` mencionado acima).
> > Isso, para o bloqueio por qualquer regra de Firewall da Cloudflare.
> > Se minha requisi√ß√£o √© bloqueada pela Cloudflare, existe algo mais espec√≠fico que eu possa fazer para resolver? Imaginando que eu recebesse a mensagem _"Verifique seu equipamento e os dados enviados"_, eu ficaria sem saber o que fazer.
> > Algo espec√≠fico s√≥ se o motivo do bloqueio tiver sido por ignorar o desafio, ent√£o a solu√ß√£o √© dar refresh e n√£o ignorar o desafio quando ele surgir, mas isso deve ser a exce√ß√£o dos bloqueios.
> > Qualquer outro caso ir√° depender de qual das incont√°veis regras de seguran√ßa da Cloudflare est√° bloqueando a requisi√ß√£o, mas essa informa√ß√£o n√£o existe para o _client_.
> > Tamb√©m n√£o sei se o Cloudflare acaba barrando humanos, acho que isso nunca ocorreu comigo.
> > Humanos s√£o barrados se estiverem usando equipamentos ou softwares fora de padr√£o (por exemplo bloqueando cookies ou JS), ou enviando (no corpo ou cabe√ßalho) dados que est√£o relacionados com vulnerabilidades conhecidas.
> > Tente criar uma publica√ß√£o no TabNews com `${env:` no t√≠tulo ou no corpo. Para garantir que deveria receber um erro de valida√ß√£o, preencha apenas um dos campos. O resultado ser√° o erro: `N√£o foi poss√≠vel se conectar ao TabNews. Por favor, verifique sua conex√£o.`, j√° que a requisi√ß√£o ir√° falhar e cair no trecho abaixo:
> > https://github.com/filipedeschamps/tabnews.com.br/blob/61a06f88525d2053ab3c6960cde5c25b80d67fc0/pages/interface/components/Content/index.js#L419-L422
> > Esse PR cria um `Response` falso apenas quando ocorre o bloquei pela Cloudflare, ent√£o n√£o cai mais no fallback de erro que existe em cada parte do TabNews que usa a API. Na p√°gina de `/publicar` a mensagem apresentada ser√° `Requisi√ß√£o bloqueada pelo Firewall. Verifique seu equipamento e os dados enviados.`. Em outros locais do site o erro tamb√©m mostra o conte√∫do do `error_id`, que optei por mostrar o que estiver no cabe√ßalho `CF-ray`, que codifica dados da requisi√ß√£o.
> > Tem algo melhor em mente? A √∫nica coisa que podemos ter certeza no _client_ √© se foi um bloqueio pelo firewall ou n√£o.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O `check` acabou de ser invocado, mas se tem algo na fila, ele ser√° invocado novamente?
> > Ser√° que voc√™ quis dizer que o "`check` acabou de ser **definido**"?
> > O `check` s√≥ ser√° chamado se for necess√°rio, ou seja, se o usu√°rio estiver sendo bloqueado por algo que configuramos com alguma regra mais restrita na Cloudflare, mas normalmente o `check` n√£o ser√° executado.
> > Por que isso √© necess√°rio e em que tipo de situa√ß√£o isso acontece?
> > Por exemplo, se a gente precisar proteger o endpoint `/api/v1/user`, a requisi√ß√£o que busca os dados do usu√°rio logo que a p√°gina √© carregada ser√° bloqueada e entrar√° na fila aguardando o desafio. Ent√£o quando o script da Cloudflare estiver pronto para ser executado, j√° ser√° chamado por existir requisi√ß√µes na fila.
> > Se o bloqueio √© por exemplo no `/api/v1/contents`, o desafio s√≥ vai ser chamado se um usu√°rio tentar publicar algo. Ent√£o n√£o ser√° por dentro do `onloadTurnstileCallback`, mas sim pelo `window.fetch` que foi customizado.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ser√° que voc√™ quis dizer que o "check acabou de ser definido"?
> > Ahhhhh. Depois de ler sua resposta algumas vezes e tentar criar um coment√°rio para explicar o que eu entendi, eu percebi que o `turnstile.queue.length && turnstile.check();` est√° dentro do `onloadTurnstileCallback`. Eu estava lendo a fun√ß√£o como se ele estivesse ao fim do pr√≥prio `.check`.
> > De toda forma, sua resposta me ajudou a entender melhor os diferentes cen√°rios. Obrigado!
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Entendi. Agora que voc√™ mencionou um exemplo de contexto (publicar conte√∫do onde a Cloudflare bloqueou o `${env:`), ficou mais claro o que _"os dados enviados"_ pode significar.
> > Acho que tudo bem continuar assim, quando algu√©m mencionar que teve esse problema e em qual situa√ß√£o, podemos melhorar com base num caso real.
> > </pull_1613_Adiciona Turnstile para executar os desafios da Cloudflare sempre que for necess√°rio>

<pull_1615_Editar o perfil de outro usu√°rio>

## Mudan√ßas realizadas

1. Uso da permiss√£o `update:user:others` para editar o nome de usu√°rio e descri√ß√£o de outro usu√°rio.
2. Cria√ß√£o de evento ao editar o perfil, similar ao que ocorre na edi√ß√£o de um conte√∫do.
3. Corre√ß√£o de bug na edi√ß√£o de perfil onde, ao realizar um `blur` e `focus` na p√°gina `/perfil`, o nome de usu√°rio e e-mail voltavam aos valores iniciais. Isso ocorre devido ao c√≥digo do `onFocus` no hook `useUser` e foi evitado pela condi√ß√£o `!usernameRef.current.value` no `useEffect` em `EditProfileForm`.
4. Corre√ß√£o de bug de descri√ß√£o vazia ao recarregar a p√°gina (F5). Isso foi corrigido com o `setDescription` no `useEffect` em `EditProfileForm`.
   Endpoint afetado: `PATCH /api/v1/users/[username]`
   UI:
   [V√≠deo editando o perfil de outro usu√°rio, mostrando o resultado e depois atualizando para mostrar que ir√° editar o pr√≥prio perfil](https://github.com/filipedeschamps/tabnews.com.br/assets/26308880/9557918b-cc08-4cc2-8a1f-5db92ee4cca9)

### Permiss√£o (_feature_)

Apesar de eu ter dito (https://github.com/filipedeschamps/tabnews.com.br/issues/1466#issuecomment-1891147726) que poder√≠amos usar a permiss√£o `update:content:others`, vi que precisaria modificar a valida√ß√£o em `can` para comparar n√£o s√≥ o `resource.owner_id`, como tamb√©m `resource.id`, e isso s√≥ seria validado se estivesse atualizando a descri√ß√£o. Se outros campos estivessem sendo atualizados, precisaria validar `update:user:others` (mencionado em `ForbiddenError.action`). Ent√£o deixei a valida√ß√£o com a permiss√£o que j√° estava no c√≥digo (mas que ningu√©m possui hoje, e nem era validada em `can`).
Se acharem que ainda faz sentido ter toda a modifica√ß√£o mencionada acima para granular as permiss√µes em dois tipos diferentes (modificar qualquer valor do outro usu√°rio e modificar apenas a descri√ß√£o), posso implementar.

### Evento

O evento √© para ficar assim mesmo, por enquanto? S√≥ coloquei o b√°sico, como √© hoje ao atualizar um conte√∫do.

### Campos edit√°veis de outro usu√°rio (UI e API)

Tirei a op√ß√£o de recuperar a senha da UI (j√° que esse √© outro fluxo), a op√ß√£o de receber notifica√ß√µes por e-mail e o e-mail em si. Faz sentido?
N√£o vejo o motivo para um moderador precisar editar as notifica√ß√µes de outro usu√°rio, e o e-mail foi removido porque n√£o √© poss√≠vel ver o e-mail de outro usu√°rio. N√£o sei se deveria adicionar o `password` nessa lista de valida√ß√£o no backend tamb√©m.
Resolve #1466

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Boa @Rafatcb! üí™üí™üí™
  > > Eu n√£o revisei tudo da implementa√ß√£o, pois algumas coisas podem mudar dependendo da sua opini√£o sobre os meus coment√°rios no c√≥digo e aqui abaixo, al√©m do PR #1618.

### Permiss√µes

Algo me diz que a feature `update:user:others` deveria dar todas as permiss√µes de `update:user`, mas parece que voc√™ tomou o melhor caminho ao come√ßar apenas dando as funcionalidades necess√°rias. Dito isso, qual cen√°rio voc√™ pensou sobre a edi√ß√£o do `username` de outros usu√°rios?
Mantendo essa forma, onde as permiss√µes n√£o ser√£o as mesmas, ent√£o acho que n√£o pode ser feita a unifica√ß√£o em `authorization.can`. Cada verifica√ß√£o precisa ser feita isoladamente, assim como o `filterInput` que tamb√©m ser√° espec√≠fico para cada caso.
Relacionado a isso, tem uma "falha" no `can` que √© verificar `resource` apenas se ele for enviado. Isso sempre foi assim, mas apenas quando o m√©todo foi refatorado no PR #1427 √© que esse comportamento ficou expl√≠cito. Ele s√≥ deveria retornar `true` se realmente todos os requisitos para cada feature fossem satisfeitos.
E essa mudan√ßa no `can` exige uma melhoria tamb√©m no `filterInput`, que tamb√©m precisar√° receber o `target` em alguns casos.
Eu ia sugerir essa mudan√ßas aqui, mas ia complicar mais do que necess√°rio esse PR, ent√£o j√° fiz no #1618.
E com isso o `patchHandler` pode chamar uma das duas features diferentes, o que exige primeiro verificar as permiss√µes e depois filtrar o input, como sugeri no coment√°rio no c√≥digo.

### Telas

Acho melhor a tela de edi√ß√£o de outros usu√°rios n√£o ser no mesmo endere√ßo de edi√ß√£o do pr√≥prio perfil. Mesmo que seja um formul√°rio muito parecido, e at√© por ser um formul√°rio muito parecido. Isso aumenta o risco de bugs perigosos pela facilidade de confus√£o dos desenvolvedores no futuro e tamb√©m existe a UX ruim para os moderadores, que pode causar uma edi√ß√£o de usu√°rios errados ou do pr√≥prio usu√°rio sem querer.
Como o caso principal √© de edi√ß√£o da descri√ß√£o, acho que pode ser na pr√≥pria p√°gina `/[username]`, bastando trocar o visualizador pelo editor de markdown.
Se achar que compensa manter no mesmo endere√ßo, ent√£o n√£o acha melhor usar um par√¢metro `?username=` na URL e buscar os dados atualizados via API ao inv√©s de salvar um cache no `localStorage`? Tamb√©m seria bom adicionar um campo mostrando qual √© o usu√°rio que est√° sendo editado. Al√©m de separar a fun√ß√£o `handleSubmit` para cada caso.

> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > @Rafatcb, para testarmos em homologa√ß√£o, j√° adicionei a `update:user:others` aos nossos usu√°rios e ao do @filipedeschamps.
>
> ### Evento
>
> Al√©m disso, do jeito que est√°, salvar√° o novo e-mail em `data` mesmo que ele n√£o tenha sido alterado no banco de dados (porque ainda precisa da confirma√ß√£o). Faz sentido?
> Estou achando melhor nesse PR criar apenas o `updatedFields` e debater em uma issue como podemos fazer algo mais elaborado para salvas os dados editados nos eventos.
> Acho que √© um debate importante e que pode ser dif√≠cil de ser revisto no futuro se ficar apenas nesse PR, j√° que ele tem rela√ß√£o apenas indireta com o assunto.
>
> ### UI
>
> Optei por n√£o exibir o bot√£o `Criar descri√ß√£o` para o moderador no perfil de outro usu√°rio porque n√£o faz sentido criar uma descri√ß√£o, a menos que tenha apagado a descri√ß√£o sem querer (o que considero pouco prov√°vel). Se necess√°rio, posso adicionar uma confirma√ß√£o no cen√°rio em que o moderador est√° atualizando a descri√ß√£o de outro usu√°rio para vazio.
> Por precau√ß√£o, acho que compensa manter o bot√£o `Criar descri√ß√£o` para o moderador, mas tamb√©m √© importante a confirma√ß√£o ao salvar, mesmo que n√£o seja uma descri√ß√£o vazia. Acho que √© importante confirmar que est√° editando a descri√ß√£o do usu√°rio "fulanoDeTal".
> Tentei seguir o padr√£o que encontrei em outras telas, mas n√£o encontrei a forma ideal de usar o `Flash` para feedback nessa tela. Se deixar na mesma posi√ß√£o que est√° o do nuke, ao aparecer ele empurrar√° o campo de descri√ß√£o para baixo, e dependendo da rolagem, n√£o √© percept√≠vel que ele apareceu. Se deixar embaixo do campo de descri√ß√£o, em cima do bot√£o de salvar, no caso de sucesso e uma descri√ß√£o muito grande, ele n√£o aparecer√° na √°rea vis√≠vel da tela (o usu√°rio precisar√° realizar a rolagem).
>
> Eu deixei conforme o segundo caso pois acho o melhor, dentre os dois citados.
> Acho que pode ficar assim por enquanto, mas acredito que `toasts` seriam uma boa adi√ß√£o em outro PR.
>
> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (DISMISSED):
> > Realizei as modifica√ß√µes comentadas.
> > Bora pra produ√ß√£o?
> > Voc√™ acha melhor criar um issue para isso ou discutir em #461?
> > Por enquanto acho que pode ficar na #461, mas se surgir necessidade de separar, a gente cria outro. ü§ù
> > Review de aprendendofelipe (COMMENTED):
> > Um problema que percebi que existe √© que, se voc√™ est√° num perfil de outro usu√°rio e est√° com um `Flash` vis√≠vel, ao acessar o seu perfil pelo menu, o `Flash` continua vis√≠vel. Resolvi isso com um `useEffect`.
> > Tamb√©m permanece em modo de edi√ß√£o e com a descri√ß√£o do usu√°rio anterior, ent√£o fiz novas sugest√µes para corre√ß√£o desse comportamento.
> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Seria interessante guardar mais informa√ß√µes sobre o que foi alterado, como um diff simplificado.
> > Obviamente que no caso da senha √© suficiente armazenar apenas a informa√ß√£o de que ela foi alterada.
> > Sobre o diff da descri√ß√£o, acho que pode ser resolvido em outro PR, pois isso √© interessante tamb√©m ao editar conte√∫dos. Ent√£o por enquanto poderia s√≥ salvar a informa√ß√£o de que a descri√ß√£o foi alterada.
> > O que acha?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Essa altera√ß√£o s√≥ faz sentido se `update:user:others` tiver todas as permiss√µes de `update:user`.
> > Essa igualdade de permiss√µes √© uma possibilidade, mas n√£o foi a escolha da implementa√ß√£o, ent√£o acho melhor n√£o mudar aqui
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Caso o PR #1618 seja aceito, isso tudo √© resolvido pelo `authorization`. Se o moderador fosse ter as mesmas possibilidades do pr√≥prio usu√°rio, ent√£o bastaria mudar a `can`, mas como optou por deixar diferente, ent√£o basta adicionar isso no `filterInput`:

```js
if (feature === "update:user:others" && can(user, feature)) {
  filteredInputValues = {
    username: input.username, // Talvez n√£o seja necess√°rio
    description: input.description,
  };
}
```

E aqui s√≥ precisa disso:

```js
let updateAnotherUser = false;
if (!authorization.can(userTryingToPatch, "update:user", targetUser)) {
  if (!authorization.can(userTryingToPatch, "update:user:others")) {
    throw new ForbiddenError({
      message: "Voc√™ n√£o possui permiss√£o para atualizar outro usu√°rio.",
      action: 'Verifique se voc√™ possui a feature "update:user:others".',
      errorLocationCode:
        "CONTROLLER:USERS:USERNAME:PATCH:USER_CANT_UPDATE_OTHER_USER",
    });
  }
  updateAnotherUser = true;
}
const secureInputValues = authorization.filterInput(
  userTryingToPatch,
  updateAnotherUser ? "update:user:others" : "update:user",
  insecureInputValues,
  targetUser
);
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu concordo. Como voc√™ acha o melhor formato para armazenar esse dado? Adicionando um `updatedFields: ['description']`, por exemplo?
> > E tamb√©m armazenaria os campos alterados caso o usu√°rio esteja atualizando o pr√≥prio perfil, certo? Ent√£o poderia ter os outros valores (`'notifications'`, `'username'` e `'email'`).
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Havia me inspirado pela valida√ß√£o do `'update:content'`. Vou alterar conforme suas sugest√µes (preciso ver o outro PR ainda).
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > `updatedFields` √© legal.
> > N√£o pensei em como guardar qual era o email e username antes da modifica√ß√£o, mas acho importante guardar.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > S√≥ o "antigo" ou acha importante o "novo" tamb√©m? Voc√™ enxerga esse modo de salvamento como tempor√°rio, no sentido de que depois poderemos mudar para seguir o mesmo padr√£o da descri√ß√£o, ou acha melhor j√° ter algo bem definido e que n√£o v√° mudar quando tratarmos o diff da descri√ß√£o?
> > Estava refletindo aqui se j√° valeria a pena manter um campo `diff`.

---

Edit: Andei pesquisando sobre o assunto e n√£o sei se o diff ser√° tratado pela tabela de `events`. Talvez nessa tabela valha a pena s√≥ armazenar os campos que foram modificados (`updatedFields`)? Ou, por enquanto, podemos armazenar tamb√©m os valores antigos e novos para o `username` e `email`, j√° que s√£o campos pequenos, para depois passar para uma tabela de hist√≥rico? O evento podendo ser algo na linha de:

```js
event = {
  id: "...",
  diff: {
    username: { previous: "rafael", current: "rafael-2" },
    email: {
      previous: "rafael@example.com",
      current: "rafael-tabnews@example.com",
    },
  },
  updatedFields: ["username", "email"],
};
```

Algumas refer√™ncias que li, por enquanto:

1. [Stack Overflow - How to keep updates (diffs) of some entity in the database](https://stackoverflow.com/q/29218546/8839059)
2. [DBA Stack Exchange - How to keep updates (diffs) of some entity in the database](https://dba.stackexchange.com/q/96254/227063)
3. [DBA Stack Exchange - How does Wikipedia store article diffs (or any site which contains lots of text diffs per record)?](https://dba.stackexchange.com/q/313980/227063)
4. [Stack Overflow - How does one store history of edits effectively?](https://stackoverflow.com/q/1219608/8839059)
5. [Stack Overflow PT - Existe alguma estrat√©gia para um banco de dados "desfaz√≠vel"?](https://pt.stackoverflow.com/q/11960/100416)
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Eu acho que o mais correto seria o `user.update` decidir o que √© salvo em `metadata`, mas para n√£o revolucionar muito as decis√µes anteriores, que tal mudar a `getEventMetadata` para comparar os dados antes e ap√≥s a modifica√ß√£o, ao inv√©s de supor que tudo que veio em `secureInputValues` foi de fato alterado?

```suggestion
        metadata: getEventMetadata(targetUser, updatedUser),
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > S√≥ o "antigo" ou acha importante o "novo" tamb√©m?
> > S√≥ o "antigo".
> > Como o dado novo sempre estar√° na tabela principal, para recuperar todo o hist√≥rico de modifica√ß√µes n√≥s s√≥ precisamos buscar o estado "antigo" em cada evento (ou o patch/diff para os textos maiores).
> > Mas voc√™ bem lembrou do caso espec√≠fico do email, em que existe um estado intermedi√°rio na altera√ß√£o, e isso me lembrou que o token que armazena esse estado intermedi√°rio j√° √© suficiente para recuperar o hist√≥rico de altera√ß√£o de emails, s√≥ ficando faltando alguma forma de armazenar o primeiro email utilizado no cadastro, pois a ativa√ß√£o √© diferente do processo de altera√ß√£o, mas isso tamb√©m seria algo para se resolver em outro PR. Ent√£o √© algo bom n√£o precisar salvar os endere√ßos de email nos eventos.
> > Voc√™ enxerga esse modo de salvamento como tempor√°rio, no sentido de que depois poderemos mudar para seguir o mesmo padr√£o da descri√ß√£o, ou acha melhor j√° ter algo bem definido e que n√£o v√° mudar quando tratarmos o diff da descri√ß√£o?
> > De qualquer forma eu acho que seria tempor√°rio, pois deveria haver uma normaliza√ß√£o desses dados, talvez criar diferentes tabelas para diferentes tipos de metadados dos eventos. Mas no sentido que voc√™ perguntou, acho que n√£o seria tempor√°rio, j√° que n√£o vale a pena armazenar diff/patch para esses campos que n√£o comportam muitos caracteres.
> > S√≥ que eu acho que essa discuss√£o sobre os eventos pode estar fugindo do foco do PR (culpa minha), e que talvez o √∫nico dado √∫til que a gente iria conseguir salvar o hist√≥rico j√° nesse PR seria o `username`, mas que n√£o poder√° ser modificado com `update:user:others`, ent√£o n√£o tem muita rela√ß√£o com o PR. Fora que √© uma discuss√£o que pode ser dif√≠cil de se recuperar no futuro se for mantida apenas aqui nesse PR.
> > Ent√£o pode ser suficiente lidarmos apenas com o `updatedFields` nesse PR. Eu s√≥ tentaria n√£o incluir em `updatedFields` campos que n√£o foram realmente modificados, ent√£o mudaria a `getEventMetadata` para que ela verificasse o que mudou entre `targetUser` e `updatedUser`, ao inv√©s de assumir que tudo que veio em `secureInputValues` foi alterado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    userFoundMutate(newUser,  { revalidate: false });
```

E precisa fazer a mesma coisa no outro `userFoundMutate`, pois assim vai valer o retornado pela requisi√ß√£o `PATCH`, que ser√° sempre a mais atualizada, pois n√£o possui cache.
Sem isso ocorre que os dados s√£o atualizados, mas logo em seguida o `SWR` revalida e busca dados que podem estar desatualizados. Por exemplo a imagem abaixo, onde criei um descri√ß√£o, mas aparece o bot√£o como se n√£o houvesse:

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  const secureOutputValues = authorization.filterOutput(
    userTryingToPatch,
    updateAnotherUser ? 'read:user' : 'read:user:self',
    updatedUser
  );
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Faz sentido subir as constantes por organiza√ß√£o, pois √© o mais comum para os componentes React, mas fiquei curioso se foi s√≥ por isso ou se tem algum outro motivo. Se for s√≥ organiza√ß√£o, melhor manter o `useEffect` do `fetchUser` onde ele estava (ou remover, dependendo do que comentei mais abaixo).
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > 3\. Corre√ß√£o de bug na edi√ß√£o de perfil onde, ao realizar um `blur` e `focus` na p√°gina `/perfil`, o nome de usu√°rio e e-mail voltavam aos valores iniciais. Isso ocorre devido ao c√≥digo do `onFocus` no hook `useUser` e foi evitado pela condi√ß√£o `!usernameRef.current.value` no `useEffect` em `EditProfileForm`.
> > Acho que faz sentido ignorar os valores atualizados vindos do `useUser` apenas se o usu√°rio j√° estiver editado algo no formul√°rio, mas pensando em ter uma solu√ß√£o simples, tudo bem manter assim. S√≥ que ent√£o devemos remover o `useEffect` do `fetchUser`, pois ele perde o sentido com o `!usernameRef.current.value` aqui.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu desci o `useEffect` para usar o `setDescription` despois dele ter sido definido, e continuei deixando todos os `useState` juntos. Na pr√°tica, n√£o fez diferen√ßa deixar o `useEffect` antes ou depois, mas na teoria eu achei que faria. N√£o encontrei nenhuma informa√ß√£o sobre isso, voc√™ sabe algo?
> > Como funcionou, posso deixar o `useEffect` acima, meu receio era apenas estar funcionando por acaso.
> > Provavelmente vou tirar o `useEffect` do `fetchUser`, como voc√™ mencionou em outro coment√°rio. Apenas vou realizar alguns testes para confirmar os impactos.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vou mexer nisso sim. Ainda √© necess√°rio manter um array com os campos de interesse dentro do `getEventMetadata` ou existe uma forma mais simples de obt√™-los?
> > Por exemplo:

```js
function getEventMetadata(originalUser, updatedUser) {
  const metadata = {
    id: originalUser.id,
    updatedFields: [],
  };
  const updatableFields = ["description", "notifications", "username"];
  for (const field of updatableFields) {
    if (originalUser[field] !== updatedUser[field]) {
      metadata.updatedFields.push(field);
    }
  }
  return metadata;
}
```

PS: No exemplo acima, deixei intencionalmente sem o `email` porque ele sempre √© igual no `targetUser` e `updatedUser`, como j√° comentamos, assim como `password`, pois a senha √© atualizada por outro fluxo.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > A fun√ß√£o passada para `useEffect` s√≥ √© chamada ap√≥s a renderiza√ß√£o, ent√£o as constantes j√° estar√£o definidas.
> > Mas por organiza√ß√£o eu acho que compensa deixar essas constantes no topo da fun√ß√£o, antes dos `useEffect`s.
> > Pode aproveitar que est√° organizando o componente e remover as `strings` que est√£o sendo passadas indevidamente para `useRef`:
> > https://github.com/filipedeschamps/tabnews.com.br/blob/76dfea94663aa89314923e6faf9b27efe4ea6f08/pages/perfil/index.public.js#L38-L40
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que pode manter o array para n√£o comparar o que n√£o precisa. üëç
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Estou terminando as modifica√ß√µes para realizar o `push`. Adianto que, com essas altera√ß√µes, caso o usu√°rio altere apenas o e-mail, no evento ficar√° `"updatedFields": []`. N√£o est√° totalmente errado, √© uma quest√£o de interpreta√ß√£o.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  useEffect(() => {
    setGlobalMessageObject(null);
    setIsEditingDescription(false);
  }, [userFound.id]);
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > A outra sugest√£o elimina esta necessidade, mas eu manteria apenas por precau√ß√£o.

```suggestion
  const confirm = useConfirm();
  useEffect(() => {
    setDescription(user.description);
  }, [user]);
  async function handleSubmit(event) {
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ainda n√£o testei, mas acho que ao inv√©s disso, podemos passar `` key={`description-form-${userFound.id}`} `` para o `DescriptionForm`. O que acha? Assim evita outros poss√≠veis problemas.
> > Quando coloquei o `useEffect`, pensava que a melhor solu√ß√£o era passar uma `key` para o componente, s√≥ que o componente era a pr√≥pria p√°gina (`Page`) ent√£o imaginei n√£o ser poss√≠vel, porque n√£o sei como funciona exatamente essa parte da intera√ß√£o Next-React. Olhando melhor agora, poderia experimentar passar na linha `490`. Se funcionar, n√£o precisaria de `key` no `DescriptionForm`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Fiz a [altera√ß√£o](https://github.com/filipedeschamps/tabnews.com.br/compare/8d3dcade538d98ab2bc0bfe336d5bb23cddbe64b..29e4bae75849ba18e714010838b06c1b8e5d3f2f) que comentei. Se achar que ficou bom, pode realizar o merge.
> > </pull_1615_Editar o perfil de outro usu√°rio>

<pull_1617_refactor: improve confirmation message when username is changed>

## Mudan√ßas realizadas

Nesse PR realizei a troca da mensagem "**Isto ir√° quebrar todas as URLs das suas publica√ß√µes.**" por "**Isso ir√° quebrar todas as URLs das suas publica√ß√µes e coment√°rios.**" afim de deixar claro ao usu√°rio que caso ele fa√ßa a mudan√ßa do seu _username_ tanto as URLs de suas publica√ß√µes como as de coment√°rios tamb√©m ser√£o quebradas.

<!-- Por favor, inclua uma descri√ß√£o sobre o que foi modificado nesse PR. Inclua tamb√©m qualquer motiva√ß√£o ou contexto relevante.  -->
<!-- Se o PR cont√©m uma modifica√ß√£o da interface gr√°fica (UI), adicione fotos ou v√≠deos comparando o antes e depois. -->

Antes
Depois

<!-- Se o PR cont√©m modifica√ß√µes de API, mencione os endpoints afetados. -->
<!-- Caso esse PR resolva algum issue, voc√™ pode descomentar a linha abaixo e substituir (issue) pelo n√∫mero dele. -->

Resolve #895

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Refactor
  <!-- - [x] Corre√ß√£o de bug -->
  <!-- - [x] Nova funcionalidade -->
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > Review de Rafatcb (APPROVED):
  > > </pull_1617_refactor: improve confirmation message when username is changed>

<pull_1618_Ajustes nas fun√ß√µes do `authorization` para deix√°-las mais seguras e f√°ceis de entender o que fazem>
Ao revisar o PR #1615 eu notei que a implementa√ß√£o poderia ser mais simples, mas que a complexidade do `authorization` n√£o deixava isso muito vis√≠vel.
Eu at√© estava sugerindo as mudan√ßas no pr√≥prio PR, mas acabou ficando mais f√°cil trazer em um PR separado as partes que n√£o mudam nada no comportamento atual (garantido pelos mesmos testes).

## Mudan√ßas realizadas

Agora a fun√ß√£o `can` exige que seja passado o `resource` quando ele for importante para a verifica√ß√£o. Antes a fun√ß√£o verificava apenas a `feature` caso n√£o fosse passado o `resource`, mesmo para os casos em que a autoriza√ß√£o dependia de alguma verifica√ß√£o no `resource`, que √© o caso de edi√ß√£o de usu√°rios ou conte√∫dos.
Pela mudan√ßa na `can`, agora `filterInput` tamb√©m exige o `target` quando isso for importante.
E a `canRequest` abstraia algo que n√£o era necess√°rio, ao utilizar a `can`, quando na verdade ela s√≥ est√° interessada em verificar se o usu√°rio possui a `feature`.

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os antigos testes est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1618_Ajustes nas fun√ß√µes do `authorization` para deix√°-las mais seguras e f√°ceis de entender o que fazem>

<pull_1620_Torna vis√≠vel o Tooltip do √≠cone de exibir/ocultar a senha>

## O problema

Na tela de login ou cadastro, deixe o cursor sobre o √≠cone do olho no campo de senha.
O Tooltip deveria estar vis√≠vel com o texto `Ocultar a senha` ou `Visualizar a senha`.
| Antes | Depois |
| ----- | ------ |
| |
N√£o √© algo espec√≠fico do TabNews, mas um [problema conhecido da vers√£o atual do Primer](https://github.com/primer/react/issues/4091). O problema ocorre at√© no componente de exemplo na p√°gina deles.

## Mudan√ßas realizadas

Substitu√≠ o `TextInput.Action` pelo nosso `Tooltip` customizado junto de um `IconButton`.
Tamb√©m aproveitei o PR para remover outros "ajustes" que o `TextInput.Action` exigia no passado, mas que j√° n√£o eram mais necess√°rios na vers√£o atual do Primer. Um determinava a altura m√≠nima de todos os campos de texto dos formul√°rios para ficar no mesmo padr√£o do campo de senha, e o outro ajuste era na posi√ß√£o padr√£o do Tooltip do `TextInput.Action`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de Rafatcb (APPROVED):
  > > Bem observado :+1:
  > > Eu tinha visto esse issue no reposit√≥rio do Primer quando est√°vamos mexendo no PR #1589, achei que a essa altura j√° teriam mergeado. Na hora n√£o me toquei que t√≠nhamos algum `Tooltip` em um `TextInput`.
  > > </pull_1620_Torna vis√≠vel o Tooltip do √≠cone de exibir/ocultar a senha>

<pull_1621_Simplifica a leitura dos scripts do `package.json` ao unificar comandos repetidos>

## Mudan√ßas realizadas

- 8021f23c34229ba3e4054cd9c81c5f2ead31ed26: Faz a constante `isBuildTime=true` tamb√©m no _build_ local. Antes s√≥ era `true` no `ci`.
- 46317017cf1d70445854e61c8e9cda2ce52c2ae6: Apenas corrige um teste que faltava um `await`, o que poderia causar erros intermitentes.
- 09a6ce46a446345c2cb3d30246bcf56ee601051b: Organiza os scripts.
  A organiza√ß√£o dos scripts envolve:

- Cria√ß√£o de novos scripts que unificam comandos repetidos;
- Substitui√ß√£o de `&&` por `||` nos casos onde isso √© necess√°rio para chamar corretamente o `services:stop`;
- Troca do comando obsoleto `husky install` por apenas `husky`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de testes
- [x] Corre√ß√£o do build local
- [x] Refatora√ß√£o dos scripts

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Ficou show! Testei no Linux e Windows aqui.
  > > </pull_1621_Simplifica a leitura dos scripts do `package.json` ao unificar comandos repetidos>

<pull_1622_Atualiza todas as depend√™ncias poss√≠veis>
Foram atualizadas todas as depend√™ncias poss√≠veis. Algumas exigiram adapta√ß√µes no c√≥digo.

### N√£o atualizadas

- `next-connect`: mantive na `0.13.0` de 2 anos atr√°s, pois a vers√£o `1.0.0` exige mudan√ßas significativas no c√≥digo, e n√£o sei se est√° compat√≠vel com o Next.js 14, pois a √∫ltima atualiza√ß√£o j√° tem 9 meses e existem issues abertas. Como isso vai exigir uma mudan√ßa maior no c√≥digo, acho que n√£o faria sentido fazer nesse PR de simples atualiza√ß√µes, at√© porque pode ser necess√°rio investigar outras alternativas.
- `kill-port`: por causa do [bug antigo ainda presente](https://github.com/tiaanduplessis/kill-port/issues/61).

- `styled-components`: por causa do `@primer/react` s√≥ deu para ir at√© a `5.3.11`. A vers√£o mais atual √© a `6.1.8`, mas ainda n√£o √© compat√≠vel com o Primer.

### Atualizados, mas exigindo altera√ß√µes no c√≥digo

- `@faker-js/faker`: Na nova vers√£o o `username` pode vir com o caractere `-`, ent√£o foi adicionado `.replace('-', '')`.
- `cross-fetch`: Passou a exibir diferentes cabe√ßalhos em desenvolvimento local ou remoto. No gitpod passou a retornar `connection: 'keep-alive'` e `'keep-alive': 'timeout=5'`. Ent√£o precisei ajustar o teste `GET /api/v1/contents > With CORS and Security Headers enabled`, mudando de `toStrictEqual` para `toEqual`. Removi a `cross-fetch` dos poucos lugares que estava sendo utilizada na API, j√° que podemos usar o `fetch` do Node.js. Com isso pude passar ela para depend√™ncia de desenvolvimento. N√£o removi totalmente porque exigiria ajustes em muitos testes.

- `eslint-plugin-primer-react`: Removeram o `eslint-plugin-github` da lista de depend√™ncias (mudaram para depend√™ncia de desenvolvimento da biblioteca), mas ele continua sendo necess√°rio para o `plugin:primer-react/recommended`, ent√£o para poder atualizar, tive que adicionar a `eslint-plugin-github` como nossa depend√™ncia de desenvolvimento.
- `next`: Exigiu ajustes no `models/ip`, pois agora o Next.js insere o _header_ `x-forwarded-for` mesmo em desenvolvimento local.

- `prettier`: Mudou o comportamento de adicionar v√≠rgula, ent√£o exigiu ajuste em diversos arquivos.
- `satori` e `@resvg/resvg-js`: Precisei atualizar as imagens utilizadas para testar as thumbnails.

### Atualizados, mas com observa√ß√µes

- `@primer/react` foi atualizado, mas est√° gerando alertas do Next.js 14 em modo de desenvolvimento. S√≥ que os alertas tamb√©m ocorrem na vers√£o do Primer que a gente estava usando antes, ent√£o n√£o h√° raz√£o para n√£o ser atualizado. E tamb√©m acho que esses alertas n√£o seriam motivo para deixar de atualizar o Next.js. Os alertas s√£o:
  `<w> [webpack.cache.PackFileCacheStrategy] Caching failed for pack: Error: ENOENT: no such file or directory, lstat '...\[tabnews.com.br](http://tabnews.com.br/)\node_modules\@primer\react\lib\node_modules\@oddbird\popover-polyfill\package.json'`
  `<w> [webpack.cache.PackFileCacheStrategy] Caching failed for pack: Error: ENOENT: no such file or directory, lstat '...\[tabnews.com.br](http://tabnews.com.br/)\node_modules\@primer\react\lib\node_modules\@github\relative-time-element\package.json'`

### Atualizados sem problemas

```json
  "dependencies": {
    "@upstash/ratelimit": "1.0.1",
    "@upstash/redis": "1.28.3",
    "@vercel/analytics": "1.1.3",
    "cookie": "0.6.0",
    "date-fns": "3.3.1",
    "joi": "17.12.1",
    "next-swr": "0.2.0-canary.0",
    "nodemailer": "6.9.9",
    "pg": "8.11.3",
    "pino": "8.18.0",
    "react-icons": "5.0.1",
    "recharts": "2.12.0",
    "slug": "8.2.3",
    "swr": "2.2.4",
    "uuid": "9.0.1",
    "vis-network": "9.1.9"
  },
  "devDependencies": {
    "@commitlint/cli": "18.6.0",
    "@commitlint/config-conventional": "18.6.0",
    "autoprefixer": "10.4.17",
    "concurrently": "8.2.2",
    "dotenv": "16.4.1",
    "eslint": "8.56.0",
    "eslint-config-next": "14.1.0",
    "eslint-config-prettier": "9.1.0",
    "eslint-plugin-jsx-a11y": "6.8.0",
    "husky": "9.0.10",
    "jest": "29.7.0",
    "lint-staged": "15.2.2"
  }
```

### N√£o liberaram novas atualiza√ß√µes

```json
  "dependencies": {
    "@bytemd/plugin-breaks": "1.21.0",
    "@bytemd/plugin-gemoji": "1.21.0",
    "@bytemd/plugin-gfm": "1.21.0",
    "@bytemd/plugin-highlight-ssr": "1.21.0",
    "@bytemd/plugin-math": "1.21.0",
    "@bytemd/plugin-mermaid": "1.21.0",
    "@bytemd/react": "1.21.0",
    "@primer/octicons-react": "19.8.0",
    "async-retry": "1.3.3",
    "bcryptjs": "2.4.3",
    "feed": "4.2.2",
    "is-in-subnet": "4.0.1",
    "node-pg-migrate": "6.2.2",
    "nprogress": "0.2.0",
    "parse-link-header": "2.0.0",
    "react": "18.2.0",
    "react-confetti": "6.1.0",
    "react-dom": "18.2.0",
    "react-rewards": "2.0.4",
    "rehype-external-links": "3.0.0",
    "set-cookie-parser": "2.6.0",
    "snakeize": "0.1.0"
  },
  "devDependencies": {
    "kill-port": "1.6.1",
    "cz-conventional-changelog": "3.3.0",
    "dotenv-expand": "10.0.0",
    "retry-cli": "0.7.0"
  }
```

### ~Alterada a vers√£o do `package-lock.json`~

~Como foram muitas atualiza√ß√µes, exclu√≠ o `package-lock.json` para que fosse criada uma nova vers√£o, o que resultou em um arquivo de cerca de 14k linhas ao inv√©s do antigo com 25k.~

**[Edit]** A altera√ß√£o da vers√£o do `package-lock.json` foi revertida porque causou erros na gera√ß√£o de thumbnails.

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Atualiza√ß√£o das depend√™ncias

## Checklist:

- [ ] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Dava para mudar a configura√ß√£o do `.prettierrc` para n√£o precisar de tantas modifica√ß√µes por causa da v√≠rgula, mas n√£o vejo problemas em deixar assim :+1:
  > > </pull_1622_Atualiza todas as depend√™ncias poss√≠veis>

<pull_1624_Altera os tipos de transa√ß√µes de conte√∫dos na tabela `balance_operations`>

## Mudan√ßas realizadas

Alterada a modelagem da tabela `balance_operations` para facilitar a consulta dos saldos de TabCoins dos conte√∫dos pela fun√ß√£o `get_content_balance_credit_debit` criada no PR #1607.
Foi removido `content:tabcoin` das op√ß√µes para `balance_operations.balance_type` e substitu√≠do por `content:tabcoin:initial`, `content:tabcoin:credit` e `content:tabcoin:debit`.
J√° foi adicionado no PR atual a vers√£o da fun√ß√£o `get_content_balance_credit_debit` que aproveita a mudan√ßa em `balance_operations`. Agora ela s√≥ recebe um par√¢metro, que √© o ID do conte√∫do.
As mudan√ßas que envolvem o banco de dados j√° foram aplicadas em homologa√ß√£o, o que n√£o afeta o funcionando das vers√µes existentes de antes do PR #1607.

## Tipo de mudan√ßa

- [x] Altera modelagem de dados

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1624_Altera os tipos de transa√ß√µes de conte√∫dos na tabela `balance_operations`>

<pull_1625_Orienta√ß√µes sobre um conte√∫do de mais qualidade no FAQ>

## Mudan√ßas realizadas

Na minha publica√ß√£o para levantar opini√µes sobre o tema de qualidade, [o clacerda trouxe um ponto interessante](https://www.tabnews.com.br/rafael/complementando-o-faq-o-que-e-um-conteudo-de-qualidade). Ao inv√©s de responder diretamente sobre qualidade, pensei em citar alguns pontos em comum que um conte√∫do de qualidade tem, de forma que ajude a pessoa a melhorar o conte√∫do dela.
Isso √© menos subjetivo. Por exemplo, uma publica√ß√£o escrita corretamente em portugu√™s ser√° melhor do que a mesma publica√ß√£o com erros de digita√ß√£o. Uma publica√ß√£o explicando um assunto com refer√™ncias ser√° melhor do que a mesma sem refer√™ncias. Enfim, procurei esse tipo de caracter√≠stica para mencionar no FAQ.
Abri o PR porque creio que assim seja mais f√°cil ajustar os detalhes de forma mais precisa antes do merge. Assim como nos outros PRs, toda opini√£o √© bem vinda.
Deixei o `id` da pergunta como `qualidade-tabnews`, mas talvez algu√©m tenha uma sugest√£o melhor tamb√©m.
Resolve #1380 (finalmente üòÑ)

> > Review de aprendendofelipe (COMMENTED):
> > Ao inv√©s de responder diretamente sobre qualidade, pensei em citar alguns pontos em comum que um conte√∫do de qualidade tem, de forma que ajude a pessoa a melhorar o conte√∫do dela.
> > Ficou show, @Rafatcb! üéâüéâüéâ
> > Isso √© menos subjetivo. Por exemplo, uma publica√ß√£o escrita corretamente em portugu√™s ser√° melhor do que a mesma publica√ß√£o com erros de digita√ß√£o. Uma publica√ß√£o explicando um assunto com refer√™ncias ser√° melhor do que a mesma sem refer√™ncias. Enfim, procurei esse tipo de caracter√≠stica para mencionar no FAQ.
> > S√≥ fiz um coment√°rio sobre a quest√£o da subjetividade, ent√£o veja se faz sentido. Mas as dicas est√£o √≥timas! üëçüëçüëç
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Bora pro merge?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que qualidade √© mesmo um "conceito subjetivo"? Acho que os crit√©rios de qualidade de qualquer coisa podem ou n√£o ser subjetivos, mas n√£o o conceito de qualidade em si. √â verdade que existem diferentes defini√ß√µes para qualidade, mas nenhuma me parece subjetiva.
> > Posso estar enganado quanto a isso, mas talvez seja melhor come√ßar com algo como:

```suggestion
      answer: `A forma como cada pessoa avalia a qualidade de um conte√∫do √© subjetiva, mas temos algumas recomenda√ß√µes que podem ajudar a criar uma publica√ß√£o mais relevante:
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu acredito que ficou melhor sim.
> > Minha primeira impress√£o foi que n√£o √© correto dizer que uma publica√ß√£o X, quando seguindo as recomenda√ß√µes abaixo, seria _mais relevante_. Mas, decidi refletir a fundo sobre isso para conseguir dar um exemplo para ilustrar essa minha opini√£o. No fim, cheguei num pensamento de que tudo que pode ser publicado no TabNews tem o potencial de ser relevante, basta a pessoa ter cuidado o suficiente com o conte√∫do.
> > Por exemplo, a publica√ß√£o [Problema de efici√™ncia energetica Linux VS Windows \[Mist√©rio da Bateria\]](https://www.tabnews.com.br/Hanufu/problema-de-eficiencia-energetica-linux-vs-windows-misterio-da-bateria). Se o autor apenas criasse uma publica√ß√£o dizendo que o computador dele gasta muita bateria no Window e pouca no Linux, provavelmente seria uma publica√ß√£o ruim. Mas o autor foi al√©m: adicionou bastante pesquisa, formatou bem a publica√ß√£o, escreveu corretamente. Ou seja, virou um conte√∫do bem melhor e acabou recebendo bastante aten√ß√£o no dia, ficando entre os conte√∫dos mais relevantes.
> > Ent√£o, acho que faz sentido dizermos que essas caracter√≠sticas ajudam o conte√∫do a ser mais relevante.
> > </pull_1625_Orienta√ß√µes sobre um conte√∫do de mais qualidade no FAQ>

<pull_1628_Fixa os nomes dos erros customizados para termos dados corretos nos logs.>

## Mudan√ßas realizadas

Com a minifica√ß√£o do c√≥digo que est√° ocorrendo ap√≥s a atualiza√ß√£o do Next, nosso servi√ßo de logs passou a registrar os tipos de erros como simples letras, pois o nome era obtido atrav√©s de `this.constructor.name`, ou seja, o nome da classe do erro (por exemplo `ValidationError`), mas que agora, em produ√ß√£o, √© um nome minificado.
Os testes n√£o acusavam problemas porque, por padr√£o, s√£o executados em modo de desenvolvimento, ou seja, sem minifica√ß√£o do c√≥digo. Mas √© poss√≠vel reproduzir o problema ao rodar o `build:local` e `start:local`, e testar com `test:watch`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
      </pull_1628_Fixa os nomes dos erros customizados para termos dados corretos nos logs.>

<pull_1629_Atualizar regras de lint e corrigir problemas apontados pelo DeepScan>

## Mudan√ßas realizadas

O principal motivo para eu ter adicionado o [`eslint-plugin-jest`](https://github.com/jest-community/eslint-plugin-jest) ao projeto √© que j√° vi fazerem um commit contendo um teste com `.only`, e eu tamb√©m quase fiz isso sem querer. Aproveitei para adicionar outras regras que fazem sentido, como erros em `console.log`, alertas em condicionais em testes (que foi algo debatido no PR #1601), o `no-dupe-keys` mencionado no issue #1338 etc.
Adicionei duas novas configura√ß√µes em `extends` (`eslint:recommended` e `plugin:jest/recommended`), e isso √© um _trade-off_: por um lado, perdemos controle sobre mudan√ßas de regras habilitadas/desabilitadas ao mudar a vers√£o; por outro, ganhamos praticidade em n√£o precisar manter uma lista longa de regras no `.eslintrc` e estamos usando "padr√µes recomendados".
Um exemplo de erro que essa modifica√ß√£o de configura√ß√£o j√° pegou foi o `throw error` que estava fora do `catch` na fun√ß√£o `findUserByUsernameOrEmail`, no arquivo `/models/recovery.js`.
Precisei modificar algumas express√µes regulares por causa do escape desnecess√°rio ([`no-useless-escape`](https://eslint.org/docs/latest/rules/no-useless-escape)), e tem [essa resposta do Stack Overflow](https://stackoverflow.com/a/400316/8839059) como material de apoio para entender as altera√ß√µes. Se, mesmo assim, n√£o se sentirem confort√°veis com essas mudan√ßas, posso desabilitar a regra no arquivo `remove-markdown.js`, que √© o arquivo que mais foi impactado, ou desabilitar de forma global (n√£o acho recomend√°vel).
Aproveitei para atualizar depend√™ncias relacionadas ao processo de lint.
Resolve #1338 ‚Äî ao mexer nas regras do ESLint eu acabei resolvendo algumas coisas desse issue, ent√£o resolvi cuidar dele por completo.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
- [x] Novas regras de lint

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (DISMISSED):
  > > Show @Rafatcb! üí™üí™üí™
  > > Review de aprendendofelipe (APPROVED):
  > > Bora pro merge?
  > > </pull_1629_Atualizar regras de lint e corrigir problemas apontados pelo DeepScan>

<pull_1632_Melhorias envolvendo envio de emails>

## Mudan√ßas realizadas

Baseado na conversa em #1630...

### Conting√™ncia de servi√ßo de envio de email

- Permite adicionar mais de um servi√ßo de email para utiliza√ß√£o autom√°tica em caso de erro no principal.
- Para adicionar mais servi√ßos, basta adicionar 2, 3, 4... ao final das vari√°veis de ambiente de email.
- Adiciona uma retentativa de envio de email para cada diferente servi√ßo configurado. Em caso de erro, ser√£o efetuadas duas tentativas para cada servi√ßo.
- Registra logs internos de `ServiceError` se houver problema em qualquer tentativa de envio de email, mesmo que alguma das tentativas tenha sucesso.
- Com isso podemos testar mais uma vez o Resend sem os riscos dos problemas que enfrentamos em #1614 e #1616.

### Respostas via _stream_

- Adiciona a possibilidade de respostas via stream na API.
- Adequa tamb√©m as respostas de erro via stream.
- Implementa respostas via stream para as requisi√ß√µes de cria√ß√£o de coment√°rios, o que permite devolver a informa√ß√£o de que a publica√ß√£o foi realizada com sucesso enquanto o processamento do envio de email de notifica√ß√£o ainda est√° ocorrendo.
- Para n√£o haver _breaking change_ , a resposta continua sendo enviada como JSON √∫nico por padr√£o, mas para publica√ß√µes de coment√°rios em que for enviado o _header_ `Accept: 'application/x-ndjson'`, a resposta poder√° vir como um conjunto de JSON separados por quebras de linhas.
- Adapta o front-end para enviar o cabe√ßalho e processar a resposta via stream. Em caso de sucesso na cria√ß√£o da publica√ß√£o, mas em que ocorrer qualquer outro erro interno, o erro s√≥ ser√° impresso no console do navegador.
- N√£o podemos devolver muitas informa√ß√µes em caso de erros de servi√ßos internos, ent√£o deixar o erro apenas no console parece suficiente para usu√°rios que estiverem ativamente realizando testes.
- Para quem utilizar a API sem enviar o cabe√ßalho `application/x-ndjson`, em caso de sucesso na publica√ß√£o do coment√°rio, mas com erro no envio da notifica√ß√£o, a requisi√ß√£o retornar√° com sucesso e o erro s√≥ estar√° presente nos logs internos.
  As melhorias para conting√™ncia do servi√ßo de email se aplicam a todos os emails, mas a resposta via _stream_, por enquanto, foi implementada apenas para a cria√ß√£o de coment√°rios.
  Resolve:

- #1451
- #1630

### Poss√≠veis melhorias relacionadas (para outro momento)

- Processar em paralelo tudo que for poss√≠vel dentro de cada requisi√ß√£o.
- Estudar as possibilidades de utilizar um servi√ßo externo de filas.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
      </pull_1632_Melhorias envolvendo envio de emails>

<pull_1633_Aumenta o espa√ßamento entre o saldo e os bot√µes de TabCoins>
Como o PR #1607 adicionou um Tooltip para mostrar mais dados sobre os votos, ficaram elementos interativos muito pr√≥ximos, o que aumenta o risco de votos acidentais, principalmente em intera√ß√µes por toque na tela.
Ontem eu acabei votando negativamente sem querer em um conte√∫do do @Rafatcb ao tentar ver mais dados sobre as qualifica√ß√µes.
Isso √© um problema maior enquanto n√£o for implementada a possibilidade de desfazer votos acidentais:

- #1183 .

## Mudan√ßas realizadas

Aumenta o espa√ßamento entre os 4 elementos interativos ali presentes:

- Achei relevante
- Dados sobre qualifica√ß√µes
- N√£o achei relevante
- Ocultar coment√°rios
  | Antes | Depois |
  | ----- | ------ |
  | |

## Tipo de mudan√ßa

- [x] UX

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > No conte√∫do raiz a barra vertical tracejada n√£o √© interativa, mas achei melhor garantir que ela sempre apare√ßa, mesmo em conte√∫dos de 1 s√≥ linha, pois mant√©m a coer√™ncia do design
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Garante que a barra vertical sempre tenha no m√≠nimo o tamanho do √≠cone de ocultar coment√°rios.
  > > Isso evita deslocamento de layout ao interagir com a barra
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Com a barra tendo um tamanho m√≠nimo, isso faz com que o bot√£o `Responder` sempre permane√ßa alinhado com o final da barra.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Existia um ajuste no `TabCoinButtons` para adequar a posi√ß√£o dele conforme o conte√∫do possu√≠a t√≠tulo ou n√£o.
  > > Apenas migrei o ajuste para dentro do componente `Content`
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Esse √© o ajuste que migrei para dentro do ~componente `Content`~ `/[username]/[slug]`.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > A dist√¢ncia acabou ficando desproporcional no modo `compact` (logo ap√≥s criar o coment√°rio).
  > > Esses 9px s√£o para deixar o que alinhado? Tenho a impress√£o que 4px fica melhor (apesar de n√£o ficar perfeito), mas posso estar comparando com algo diferente.
  > > | `9px` | `4px` (ou `1`) |
  > > | ----- | -------------- |
  > > | | |
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > A dist√¢ncia acabou ficando desproporcional no modo `compact` (logo ap√≥s criar o coment√°rio).
  > > Boa! Isso deixa claro que o `Content` n√£o √© o melhor lugar para fazer esse ajuste. E, pensando bem, o √∫nico local que tem varia√ß√µes (se existe t√≠tulo ou n√£o) √© no conte√∫do principal da p√°gina. Nos demais nunca haver√° t√≠tulo. Ent√£o mudei isso para o come√ßo do `/[username]/[slug]`.
  > > Esses 9px s√£o para deixar o que alinhado? Tenho a impress√£o que 4px fica melhor (apesar de n√£o ficar perfeito), mas posso estar comparando com algo diferente.
  > > O requisito original √© deixar o saldo de TabCoins o mais alinhado poss√≠vel com a primeira linha do conte√∫do (ou com o t√≠tulo).
  > > Isso √© bem dif√≠cil, pois muda um pouco em cada navegador, e a fonte do saldo √© menor, ent√£o na primeira vers√£o eu n√£o mexi nisso. S√≥ subi o bot√£o de cima e abaixei o de baixo, mantendo o saldo na mesma posi√ß√£o.
  > > Mas sua imagem me lembrou que uma altera√ß√£o recente (acho que no #1549) abaixou o saldo em `1px`, o que j√° fez ficar estranho no Chrome, e como ele √© de longe o navegador mais utilizado pelos usu√°rios do TabNews, ent√£o resolvi voltar para a posi√ß√£o de antes.
  > > </pull_1633_Aumenta o espa√ßamento entre o saldo e os bot√µes de TabCoins>

<pull_1635_Adiciona `id` em t√≠tulos de conte√∫dos e nos conte√∫dos>

## Mudan√ßas realizadas

Agora, cada n√≠vel de t√≠tulo possui um `id`, assim as pessoas podem compartilhar um conte√∫do com redirecionamento direto para a parte relevante.

### Defini√ß√£o do `id`

Eu usei o plugin [`rehype-slug`](https://www.npmjs.com/package/rehype-slug), que adiciona um `id` nos t√≠tulos que n√£o possuem `id`. Exemplos:

- `# Oi` ser√° `<h1 id="user-content-oi">Oi</hi>`;
- `<h1 id="meu-id">Oi</hi>` ser√° `<h1 id="user-content-meu-id">Oi</h1>`.
  Nas p√°ginas do FAQ, Termos de Uso e Museu, onde n√≥s controlamos o conte√∫do, o `id` n√£o possui o prefixo `user-content`.
  O `id` dos conte√∫dos √© `${username}-${slug}`.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Testes em diferentes navegadores (Chromium e Firefox).

  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Massa @Rafatcb! üí™
  > > Agora, cada n√≠vel de t√≠tulo ser√° tamb√©m uma √¢ncora para ele mesmo, assim as pessoas podem compartilhar um conte√∫do com redirecionamento direto para a parte relevante.
  > > Para tentar deixar mais claro o que vou explicar, vou falar separadamente do item interativo, que √© o link, e o `id`, que √© o que permite a √¢ncora. Ent√£o no PR est√£o sendo disponibilizados os dois, ou seja, adiciona o `id` em cada t√≠tulo ao mesmo tempo que transforma cada t√≠tulo em um "link para ele mesmo". A primeira √© um requisito para a segunda, mas s√£o duas coisas que podem ser tratadas separadamente.
  > > Eu n√£o acho interessante transformar os t√≠tulos em links, ent√£o deixaria isso de fora desse PR. Esse ponto precisa ser debatido sobre a motiva√ß√£o, pois acredito que a real necessidade √© facilitar copiar os endere√ßos para compartilhamentos, mas n√£o √© preciso transformar o t√≠tulo em um link. Provavelmente um bot√£o de copiar que apare√ßa no hover, ou ao tocar no t√≠tulo, seja algo mais interessante, mas tamb√©m n√£o precisa ser implementado no mesmo PR.
  > > Vou tratar mais sobre a parte do `id`. E incluir a ideia de j√° adicionar o `id` tamb√©m em cada coment√°rio, pois os dois casos precisam ser compat√≠veis entre si. E o link direto para os coment√°rios √© requisito para melhorar as notifica√ß√µes. Para os coment√°rios, eu havia implementado uma PoC usando o pr√≥prio `uuid` dos conte√∫dos, mas pode ser melhor usar a combina√ß√£o do `username` com o `slug`. Mas n√£o precisa fazer nesse PR se n√£o achar que compensa.
  > > Criei as √¢ncoras aproveitando a estiliza√ß√£o que j√° existia, com pequenas adapta√ß√µes. Deixei o √≠cone com `position: absolute`, sen√£o vamos precisar lidar com situa√ß√µes onde, no `:hover`, uma nova linha poder√° ser criada apenas para exibir o √≠cone. Com o `position: absolute`, esse tipo de cen√°rio ir√° exibir o √≠cone parcialmente (j√° que n√£o existe espa√ßo o suficiente para ele), e criar um scrol horizontal. O `position: absolute` tamb√©m evita o aumento da altura da linha em caso de t√≠tulos como `h4`, `h5` e `h6`.
  > > Massa! Isso pode ser adaptado ao bot√£o de copiar o link. N√£o lembro onde, mas j√° vi funcionamento como estou sugerindo, e utilizando o mesmo √≠cone ao inv√©s daquele normalmente utilizado para bot√µes de copiar.
  > > Eu usei a biblioteca [`slug`](<[https://www.npmjs.com/package/slug](https://www.npmjs.com/package/slug)>) no frontend para reaproveitar a l√≥gica do backend, mas poderia ter adicionado o plugin [`rehype-slug`](<[https://www.npmjs.com/package/rehype-slug](https://www.npmjs.com/package/rehype-slug)>), que √© menor do que a biblioteca `slug`. Se quiser que eu mude, pode comentar, s√≥ precisaria instalar a biblioteca e definir `rehype: (processor) => processor.use([rehypeSlug])` no retorno do `anchorHeadersPlugin`.
  > > S√≥ para confirmar, a `rehype-slug` substituiria quase todo o c√≥digo em `plugins/anchor-headers`, al√©m de n√£o precisar de `utils/slug` e da biblioteca `slug`? E ainda por cima √© menor do que a `slug`? S√≥ isso j√° seria um bom motivo para usar a `rehype-slug`, mas acho que o principal motivo para valer a pena mudar √© por ser algo executado no lado do servidor ao inv√©s do client (`rehype` vs `viewerEffect`).
  > > A estiliza√ß√£o `a[href^="#"]` ao inv√©s de `.anchor` foi um truque que encontrei para n√£o piscar "azul" e depois "preto/branco" em casos de links criados pelo pr√≥prio usu√°rio no cabe√ßalho (veja os dois primeiros exemplos no ambiente de homologa√ß√£o, na publica√ß√£o [`rafael/teste-de-ancoras-em-titulos`](<[https://tabnews-k0jzbd5g4-tabnews.vercel.app/rafael/teste-de-ancoras-em-titulos#primeiro-nivel](https://tabnews-k0jzbd5g4-tabnews.vercel.app/rafael/teste-de-ancoras-em-titulos#primeiro-nivel)>)).
  > > Mudando para `rehype-slug` ainda teria o mesmo problema?
  > > Defini `tab-index=-1` e o tratamento do `id` conforme vi a documenta√ß√£o do [`rehype-sanitize`](<[https://github.com/rehypejs/rehype-sanitize?tab=readme-ov-file#example-headings-dom-clobbering](https://github.com/rehypejs/rehype-sanitize?tab=readme-ov-file#example-headings-dom-clobbering)>) e o HTML gerado por `README`s no GitHub, assim o `id` possui o prefixo `user-content-`, mas o `href` n√£o precisa desse prefixo para funcionar. N√£o acho que o uso do `shouldScroll` ficou legal, ent√£o aceito sugest√µes de como melhorar isso.
  > > Mais uma vez a `rehype-slug` parece ser uma boa op√ß√£o, pois o `ByteMD` j√° entrega pra ela ap√≥s passar pelo `rehype-sanitize`.
  > > Esse tratamento possibilitou ter uma URL "bonita"/amig√°vel
  > > Como bonita voc√™ diz sem o `user-content`? A preocupa√ß√£o nesse ponto √© com nossas documenta√ß√µes, em que n√£o faz sentido adicionar `user-content` ao `id`, certo? Para os conte√∫dos dos usu√°rios √© importante manter, pois assim impede um usu√°rio de "roubar" a √¢ncora de outro usu√°rio ou alguma padr√£o do pr√≥prio TabNews.
  > > simplificar o component do FAQ e adicionar √¢ncoras aos t√≠tulos dos Termos de Uso.
  > > Aqui o ponto √© usar apenas uma vez o visualizador de markdown para todo o FAQ ao inv√©s de uma vez para cada resposta, e sem adicionar `user-content` nos `id`s?
  > > Se for isso, tamb√©m pode ser alcan√ßado ao personalizar o `schema` do `sanitize`, seja removendo o `id` de `clobber`, seja editando `clobberPrefix`, ou at√© mesmo zerando o `schema`, j√° que temos controle sobre o conte√∫do do FAQ e dos Termos. Apenas seria necess√°rio exportar uma vers√£o `insecureViewer` no `components/Markdown`, onde essa vers√£o poderia ter at√© menos plugins.
  > > Infelizmente, pode acontecer de dois conte√∫dos na mesma p√°gina terem o mesmo `id`.
  > > E se o `Viewer` receber o `username` do autor do conte√∫do, e personalizarmos o `clobberPrefix` com algo como `${username}-content`?
  > > Ainda poderiam ter dois `id`s repetidos, mas apenas do mesmo usu√°rio, o que j√° evitaria o "roubo" de √¢ncoras.
  > > Acabei de perceber um tipo de publica√ß√£o que "quebraria" com essa atualiza√ß√£o. A publica√ß√£o [O que tem sido debatido no TabNews? (19/02/2024 - 25/02/2024)](https://www.tabnews.com.br/luishjacinto/o-que-tem-sido-debatido-no-tabnews-19-02-2024-25-02-2024) usa links nos headers para direcionar para outra p√°gina do TabNews, mas o c√≥digo desse PR substituiria o link para o pr√≥prio header.
  > > N√£o transformar automaticamente os t√≠tulos em links j√° evita a cria√ß√£o desse problema.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (DISMISSED):
  > > Acabei n√£o adicionando o prefixo customizado do `id` com `{username}-content-` porque, nos testes que fiz, n√£o consegui deixar as notas de rodap√© funcionando de uma forma simples:
  > > Interessante que as notas de rodap√© j√° estavam ficando com o `id` duplicado porque tanto o `sanitize` como o `gfmPlugin` adicionavam o prefixo `user-content-`. S√≥ n√£o dava problema porque os navegadores parecem conseguir ignorar o prefixo `user-content-` quando o restante bate com o link, ent√£o `id="user-content-user-content-alguma-coisa"` batia com `href="#user-content-alguma-coisa"`, mas isso n√£o vale para outros prefixos, por isso deu problema ao customizar.
  > > Resolvi com um plugin que remove o `clobberPrefix` extra se ele estiver duplicado. Isso tamb√©m vai evitar problemas caso o usu√°rio adicione manualmente o `{username}-content-` no `id` de algum elemento do conte√∫do.
  > > No `href` o usu√°rio precisa adicionar manualmente o `{username}-content-` para a √¢ncora funcionar. Precisa ser manual, pois ele pode estar linkando com conte√∫dos de outros usu√°rios.
  > > Veja se o resultado est√° legal üëç
  > > Review de Rafatcb (COMMENTED):
  > > Parece bom! S√≥ apontei dois detalhes pequenos.
  > > Acha que faz sentido buscar pelo banco conte√∫dos que mencionam `user-content` para atualizar os links?
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Para conseguir redirecionar ao acessar um link com o `hash` que cont√©m um `id` ao fim de uma p√°gina com muitos coment√°rios, precisei usar a vari√°vel `shouldScroll`, al√©m de confirmar se o `scrollToHash` havia encontrado o `id`.

- Um exemplo no fim da p√°gina: https://tabnews-k0jzbd5g4-tabnews.vercel.app/rafael/teste-de-ancoras-em-titulos#teste-259

  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > N√£o acho legal usar o `smooth` para isso, pois d√° a impress√£o de que √© um bug, ou que o computador est√° lento, pois se √© um link para uma parte espec√≠fica da p√°gina, o ideal √© chegar l√° o mais r√°pido poss√≠vel.
  > > Obs. 1: Pela forma como eu criei o link para um deploy ainda sem a √¢ncora, √© necess√°rio testar no Chrome:

- [Link com `scroll-behavior: smooth`](https://tabnews-98wzufnpe-tabnews.vercel.app/rafael/teste-de-ancoras-em-titulos#teste-268)
- [Link sem `scroll-behavior: smooth`](https://tabnews-nexpctr7s-tabnews.vercel.app/rafael/teste-de-ancoras-em-titulos#:~:text=eget%20tristique%20vehicula.-,Teste%20268,-Maecenas%20a%20dolor)
  Obs. 2: Em dispositivos lentos, a diferen√ßa entre os dois casos pode ser muito pior.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Eu havi adicionado o `scroll-behavior: smooth` porque sem ele me passava a impress√£o de que a p√°gina renderizava com [reflow](https://developers.google.com/speed/docs/insights/browser-reflow?hl=pt-br) (carregava e depois "piscava" para outro lugar), mas posso remover.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Aqui n√£o precisa do encadeamento opcional, j√° que o `user` estar√° definido. Fiz esse coment√°rio porque √© algo que o DeepScan e ferramentas similares costumam apontar como problema.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Aproveitando que apontei outra coisa, pode juntar toda a string num √∫nico template string. Eu n√£o percebi que tinha deixado assim.
  > > </pull_1635_Adiciona `id` em t√≠tulos de conte√∫dos e nos conte√∫dos>

<pull_1638_Reverter ganhos de TabCoins em conte√∫dos pegos pelo firewall interno e outros ajustes>

## Mudan√ßas realizadas

### Revers√£o de ganhos de TabCoins

A fun√ß√£o `creditOrDebitTabCoins` foi chamada para reverter poss√≠veis ganhos de TabCoins que o usu√°rio teve com os conte√∫dos publicados que foram pegos pelo firewall interno.

### Endpoint

- `POST /api/v1/moderations/review_firewall/[id]`: confirmar ou desfazer um evento espec√≠fico de firewall. A confirma√ß√£o (`confirm`) adiciona a feature `nuked` ao usu√°rio ou o status `deleted` aos conte√∫dos envolvidos. A revers√£o (`undo`) retorna os TabCoins removidos, restaura o `status` dos conte√∫dos e `features` dos usu√°rios, a depender do tipo de firewall. Este endpoint retornar√° os dados atualizados contendo o evento original do firewall, o novo evento criado ao desfazer o firewall, os dados dos conte√∫dos e usu√°rios afetados.
  Resolve #1463

## Tipo de mudan√ßa

- [x] Melhorias no firewall interno
- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Importante contribui√ß√£o, @Rafatcb! üí™üí™üí™
  > > Com a adi√ß√£o de `undoContentsTabcoins`, talvez seja melhor executar tudo dentro de uma transa√ß√£o, mas √© preciso pensar melhor se isso faz sentido, pois, se der algum erro, n√£o seria interessante reverter toda a transa√ß√£o.
  > > Fiz coment√°rios no c√≥digo
  > > Review de aprendendofelipe (COMMENTED):
  > > @Rafatcb, est√° muito bom, mas como ainda n√£o consegui ver tudo, j√° vou deixar alguns coment√°rios.
  > > Sobre a refatora√ß√£o em `models/transacional`, aprovo todas as mudan√ßas. At√© por isso acho que talvez compense separar em um PR pr√©vio a esse e j√° matar essa etapa.
  > > Sobre a parte de email dentro de `models/firewall`, ser√° que n√£o s√£o coisas que deveriam estar no `models/notification`?
  > > Tem mais coment√°rios no c√≥digo üëç
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Enquanto estou criando o endpoint `GET`, percebi algo que acho que est√° errado (`filterOutput` no `model`), ent√£o decidi aproveitar para comentar tamb√©m outros pontos que poderiam ser diferentes.
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Fiz o `GET`. Abaixo est√£o alguns pontos que refleti e fiquei indeciso sobre como proceder. O PR est√° funcional mas acredito que esses pontos (al√©m dos j√° comentados) mere√ßam aten√ß√£o antes de realizar o merge:
  >
  > 1. N√£o sei se a interface de retorno est√° ideal:
  >    ```ts
  >    {
  >      affected: {
  >        contents?,
  >        users?
  >      },
  >      event,
  >      status: 'active' | 'reversed'
  >    }
  >    ```
  >    Eu escolhi adicionar um atributo `affected` (que pode ter outro nome) para n√£o correr o risco de eventualmente retornarmos mais coisas e ficar incompat√≠vel com a interface atual (imagine que vamos retornar um `event` afetado, por exemplo). E a interface do `affected` est√° compat√≠vel com o retorno do endpoint do `undo`.
  >    `affected` est√° legal üëç
  > 2. N√£o consegui entender como modificar o `schemas` no `validator` para conseguir usar no `filteredOutputValues` do `GET`. Comecei experimentando validar apenas o retorno de `event`, mas o `schema` est√° esperando que o objeto seja o `event`, e n√£o que tenha uma tributo `event`, ent√£o j√° n√£o soube como lidar com esses casos de "atributos com o mesmo nome".
  >    Um caminho √© criar um esquema `firewall_report` (n√£o necessariamente com esse nome), e que usa outros esquemas. Pode usar os outros esquemas fazendo algo parecido ao que sugeri na valida√ß√£o de `ids`.
  >    Outro exemplo √© o `status`, que n√£o deveria ter a mesma valida√ß√£o do `status` do `content`.
  >    E se retornar uma lista de eventos relacionados ao inv√©s de retornar um `status`? Se houver um evento `undo`, ent√£o √© porque o evento j√° foi desfeito.
  >    Al√©m disso, precisei modificar o `[schemas.id](http://schemas.id/)` para aceitar um Array para conseguir passar um array no `[where.id](http://where.id/)` do `content.findAll`. N√£o me parece ser a solu√ß√£o ideal.
  >    Fiz uma sugest√£o no c√≥digo
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de aprendendofelipe (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de aprendendofelipe (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de aprendendofelipe (COMMENTED):
  >    > @Rafatcb, respondi suas perguntas e fiz outros coment√°rios no c√≥digo üëç
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de aprendendofelipe (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de Rafatcb (COMMENTED):
  >    > Review de aprendendofelipe (COMMENTED):
  >    > Mas fiquei em d√∫vida se, no caso em que n√£o vamos desfazer o evento de firewall, os conte√∫dos deveriam permanecer com o status de firewall ou o POST deveria aceitar par√¢metros para escolher entre desfazer o firewall ou consolidar e realmente alterar todos conte√∫dos afetados para deleted.
  >
  > Seria algo como "o firewall pegou mas precisa de uma a√ß√£o para confirmar e apagar os conte√∫dos", certo? Me parece que isso aumentaria a complexidade sem trazer um benef√≠cio.
  > N√£o quis dizer que seria necess√°ria uma a√ß√£o para os conte√∫dos deixarem de ser exibidos. Com o status `firewall` j√° n√£o devem ficar dispon√≠veis publicamente. E √© exatamente o que acontece na vers√£o atual. üëç
  > A minha d√∫vida √© sobre os casos que n√£o vamos desfazer o firewall. Nesse casos, vamos deixar os conte√∫dos permanentemente com status `firewall`? Como um moderador vai saber que o caso j√° foi analisado por outro (ou por ele mesmo em outro momento), e que a conclus√£o foi de que o evento n√£o deve ser revertido?

---

Fiz outros coment√°rios no c√≥digo!

> > Review de aprendendofelipe (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > √â preciso retornar tamb√©m o `owner_id`, pois o firewall √© por IP e n√£o por usu√°rio.
> > Isso √© necess√°rio para usar em `undoContentsTabcoins`, e l√° tamb√©m d√° para evitar N novas idas ao banco se j√° retornar aqui o saldo de TabCoins. Onde N √© a quantidade de conte√∫dos exclu√≠dos.
> > Da√≠ tem que fazer as adequa√ß√µes l√° em cima em `RETURNS TABLE`, em `firewall-create-content-text-root` e em `undoContentsTabcoins`.

```suggestion
      RETURNING
        id,
        published_at,
        status,
        owner_id,
        get_current_balance('content:tabcoin', contents_to_update.id::uuid)
      INTO
        content_id,
        content_published_at,
        content_status,
        content_owner_id,
        content_tabcoins;
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Provavelmente essa importa√ß√£o n√£o ser√° necess√°ria, mas seguindo o padr√£o...

```suggestion
import balance from 'models/balance.js';
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O firewall √© por IP, n√£o por usu√°rio, ent√£o aqui √© preciso passar o `owner_id` de cada conte√∫do.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aqui seriam evitadas novas idas ao banco de dados se o saldo j√° for retornado nas fun√ß√µes de firewall.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aqui, e nas outras frases, acho que ficaria melhor usar `ent√£o` no lugar de `e`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Um componente `code` provavelmente ficaria bem melhor usando o `CodeBlock` do `react-email`.
> > O componente aqui √© usado com inten√ß√£o de colocar o texto com certo destaque, correto? Nesse caso, mesmo usando a tag `code`, ser√° que n√£o √© melhor usar outro nome para o componente?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Esses novos eventos n√£o s√£o de firewall, mas de modera√ß√£o. Ser√° que n√£o √© melhor algo assim?

```
'moderation:unblock_users',
'moderation:unblock_contents:text_root',
'moderation:unblock_contents:text_child',
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
>
> 1. Essa √© uma a√ß√£o sobre o "firewall", ent√£o criei o endpoint `DELETE /api/v1/firewall/[event_id]`, mas na verdade a a√ß√£o √© orientada pela tabela `events`, tanto que recebe o `event.id` como par√¢metro. O endpoint deveria ser `DELETE /api/v1/events/[id]`?
>    Ser√° que n√£o √© melhor ser um POST em um endpoint de modera√ß√£o?
> 2. √â mais adequado realizar o `event.findOne` e a valida√ß√£o no controller e passar o objeto `foundEvent` para o model (e nesse caso o model precisaria confiar que o objeto `foundEvent` est√° correto) ou deixar o `findOne` e as valida√ß√µes no model mesmo?
>    Acho prefer√≠vel no model, mesmo que as vezes facilite fazer isso no controller. Se for s√≥ para apresentar um erro mais espec√≠fico, acho que seria melhor capturar no controller o erro vindo do model, e ent√£o adequar o que ser√° retornado, mas acho que n√£o estamos fazendo assim em nenhum lugar üôÉ
> 3. Acha que faz mais sentido o endpoint retornar algo espec√≠fico, retornar `{}` ou `null`?
>    Seria interessante o POST retornar ao moderador os efeitos que acabou de aplicar, como a lista de usu√°rios ou conte√∫dos afetados.
>    Tamb√©m seria bom um GET trazendo os mesmos dados e o status do evento, mas sem aplicar os efeitos, e que funcione tanto antes ou ap√≥s o POST.
>    > Coment√°rio de aprendendofelipe (linha de c√≥digo):
>    > Por causa do `LIMIT 1`, √© melhor n√£o precisar checar tamb√©m o `endsWith(':undo')`.
>    > O nome `foundEvent` aqui pode confundir e dar a entender que aqui teremos dados do evento de firewall.
>    > Coment√°rio de Rafatcb (linha de c√≥digo):
>    > Sim, isso √© sempre para exibir o link do e-mail, eu apenas refatorei para tirar a repeti√ß√£o de estilos. Podemos chamar de algo como `LinkText`.
>    > Coment√°rio de Rafatcb (linha de c√≥digo):
>    > Ser√° que n√£o √© melhor ser um POST em um endpoint de modera√ß√£o?
>    > Ok, tem alguma sugest√£o para o endpoint? Seria um `POST /api/v1/moderation/undo_firewall_effect/[event_id]`?
>    > Acho prefer√≠vel no model, mesmo que as vezes facilite fazer isso no controller. Se for s√≥ para apresentar um erro mais espec√≠fico, acho que seria melhor capturar no controller o erro vindo do model, e ent√£o adequar o que ser√° retornado, mas acho que n√£o estamos fazendo assim em nenhum lugar üôÉ
>    > Tudo bem, n√£o ficou mais complicado no model n√£o.
>    > Seria interessante o POST retornar ao moderador os efeitos que acabou de aplicar, como a lista de usu√°rios ou conte√∫dos afetados.
>
> Tamb√©m seria bom um GET trazendo os mesmos dados e o status do evento, mas sem aplicar os efeitos, e que funcione tanto antes ou ap√≥s o POST.
> N√£o consegui entender muito bem aqui. A parte de retornar os efeitos, acho que ficou claro para mim. Retornaria os usu√°rios e conte√∫dos atualizados, dependendo de qual foi o efeito do firewall (se foi o de criar usu√°rios, n√£o tem conte√∫dos).
> Um `GET` aceitaria tanto o `id` do evento do firewall, quanto do evento de desfazer realizado pela modera√ß√£o? E retornaria uma "fotografia" no tempo, considerando os eventos apenas at√© o momento em que o efeito do firewall ocorreu? Ou retornaria os dados atuais e serviria apenas para o moderador entender quais conte√∫dos e usu√°rios foram afetados?
>
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Por causa do `LIMIT 1`, √© melhor n√£o precisar checar tamb√©m o `endsWith(':undo')`.
> > Eu havia colocado essa valida√ß√£o para n√£o desfazer o mesmo efeito do firewall duas vezes. Acha que isso deveria ser passado como um `where` para o `findOneByOriginalEventId`? E ent√£o passaria algo como:

```js
{
  type: [
    "firewall:block_users",
    "firewall:block_contents:text_root",
    "firewall:block_contents:text_child",
  ];
}
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ok, tem alguma sugest√£o para o endpoint? Seria um `POST /api/v1/moderation/undo_firewall_effect/[event_id]`?
> > Acho que √© por a√≠ üëç
> > Um `GET` aceitaria tanto o `id` do evento do firewall, quanto do evento de desfazer realizado pela modera√ß√£o?
> > Acho que a consulta s√≥ √© necess√°ria pelo ID do evento original de firewall.
> > E retornaria uma "fotografia" no tempo, considerando os eventos apenas at√© o momento em que o efeito do firewall ocorreu? Ou retornaria os dados atuais e serviria apenas para o moderador entender quais conte√∫dos e usu√°rios foram afetados?
> > Penso no GET para o moderador poder consultar o que ir√° ocorrer antes de executar de fato, ou seja, quais conte√∫dos ou usu√°rios seriam ressuscitados. Mas tamb√©m j√° traria a informa√ß√£o de status do evento, ou seja, se √© um evento que j√° foi ou n√£o desfeito, pois tamb√©m pode j√° ter sido desfeito por outro moderador.
> > Ent√£o, se j√° foi desfeito, retorna os dados do evento `undo`, se n√£o, retorna os dados do evento de firewall. Em qualquer dos casos, acompanha a lista de itens afetados com seus dados mais atuais.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Faz sentido modificar o `findOneById` para passar um `where`, parecido com o que fiz em `findOneByOriginalEventId`, para n√£o precisar dessa valida√ß√£o? E a√≠ retorno sempre `NotFoundError`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Essa `key` deveria ser `event_id`, porque √© o par√¢metro recebido no endpoint, ou `id` porque √© o `event.id`?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Olhando agora, fazendo o endpoint `GET`, imagino que fa√ßa mais sentido o `filterOutput` ficar no `controller` do que no `model`, certo?
> > Ainda n√£o avaliei como eu poderia modificar a fun√ß√£o `filterOutput` para receber as features `read:firewall` e `undo:firewall` de modo a tratar o objeto inteiro e seus objetos internos, que considerariam outras `feature`s, mas tenho a impress√£o que √© mais seguro ter essa valida√ß√£o do objeto inteiro na fun√ß√£o `filterOutput`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que seria legal usar o mesmo endpoint (com um m√©todo diferente) para desfazer e para obter o evento.
> > Pensando em `GET /api/v1/moderation/firewall_effect/[event_id]`, faz sentido, mas n√£o acho que `POST /api/v1/moderation/firewall_effect/[event_id]` fica claro que ir√° desfazer o evento. Tem alguma sugest√£o?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vou marcar aqui como resolvido para poder apontar os detalhes na parte espec√≠fica do c√≥digo, caso necess√°rio.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o acha melhor usar a valida√ß√£o j√° existente de `id`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o acho interessante permitir os dois tipos aqui no validador. Adicionaria `.id('uuid')` na valida√ß√£o original do `id` e criaria o `ids` com algo assim:

```js
  ids: function () {
    const idSchema = schemas.id();
    return Joi.object({
      ids: Joi.array()
        .items(Joi.link('#uuid'))
        .messages({
          'array.base': `"ids" deve ser do tipo Array.`,
        })
        .shared(idSchema),
    });
  },
```

Mas note que isso valida um objeto que contenha `ids`, que por sua vez cont√©m uma lista de `id`s. N√£o valida diretamente uma lista.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Por um lado faz sentido usar o mesmo endpoint, mas talvez seja melhor n√£o.
> > Como ainda n√£o precisamos de tabelas espec√≠ficas parar armazenar as a√ß√µes de firewall e da modera√ß√£o, e s√≥ usamos a tabela de eventos, pode fazer mais sentido os `GET`s serem para `/api/v1/events/...`, mas o `POST` em `/api/v1/moderations/...`.
> > O que acha de algo assim?

- `GET /api/v1/events/firewall/[id]`
- `POST /api/v1/moderations/undo_firewall/[id]`
  E poss√≠veis melhorias futuras incluem:

- `GET /api/v1/events/firewall` com a feature `read:firewall:list`.
- `GET /api/v1/events/moderations` com dados que podem ser p√∫blicos sobre as atua√ß√µes da modera√ß√£o.
- `GET /api/v1/events/moderations/[id]` com dados restritos aos moderadores sobre cada uma das atua√ß√µes da modera√ß√£o.
  E j√° abre o caminho para expormos outros tipos de eventos quando se tornar necess√°rio.
  Faz sentido?
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Pelo que entendi, aqui voc√™ est√° buscando o `reversingEvent`, e n√£o o `reversed`, correto?
  > > N√£o era essa verifica√ß√£o que voc√™ ia passar para o model? N√£o estou cobrando, s√≥ perguntando pra saber se eu tinha entendido direito
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Acho que esqueceu de apagar esse arquivo
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Aqui acho que √© melhor manter como est√° feito üëç
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Esse PR envolveu v√°rias cria√ß√µes de "where". Eu estava fazendo outra tarefa e passei por uma situa√ß√£o assim novamente, mas enxerguei algo a mais.
  > > Para a fun√ß√£o ter uma interface mais consistente, acha que faz sentido colocar dentro do `buildWhereClause` um mapeamento do nome do atributo do objeto para o nome da coluna do banco de dados? Por exemplo:

```suggestion
  function buildWhereClause() {
    const columnMap = {
      balanceType: 'balance_type',
      contentId: 'content_id',
      originatorType: 'originator_type',
      originatorId: 'originator_id',
    }
    const conditions = Object.entries(where).map(([key, value]) => {
      const column = columnMap[key] ?? key;
      return Array.isArray(value) ? `${column} = ANY ($${globalIndex++})` : `${column} = $${globalIndex++}`;
    });
    return `WHERE ${conditions.join(' AND ')}`;
  }
```

Dessa forma, a fun√ß√£o pode ser chamada sem que quem chamou precise saber o nome das tabelas no banco.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Faz sentido!
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho a ideia bem legal. Podemos criar um issue depois de fechar este para n√£o esquecermos essas poss√≠veis melhorias.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o passou pela minha cabe√ßa a possibilidade de usar valida√ß√µes existentes. Mas, vou remover este trecho por causa das orienta√ß√µes em https://github.com/filipedeschamps/tabnews.com.br/pull/1638#discussion_r1527492197, onde vou simplificar o par√¢metro de `event_id` para `id`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Naquele coment√°rio eu estava falando especificamente sobre deixar a valida√ß√£o do `NotFound` no model ou no controller (junto de todas valida√ß√µes. Se tirar ela daqui, o controller ficar√° "vazio", sendo apenas uma ponte para o model. √â esse o efeito desejado mesmo?
> > Posso fazer, sem problemas. S√≥ n√£o est√° muito claro para mim o papel exato do que fica no controller e o que fica no model, por isso a confus√£o.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tem alguma forma de reaproveitar o schema do `id` sem que o `ids` seja um array de objetos? Me parece que seria um trabalho desnecess√°rio converter tudo para `[{ id: "..." }]` ao passar para o `content.findAll`, para depois fazer o processo contr√°rio e transformar de volta em `["..."]`.
> > Tentei modificar sua sugest√£o mas n√£o consegui fazer funcionar reaproveitando o schema `id`.
> > Edit: parece que [`extract`](https://joi.dev/api/?v=17.12.2#anyextractpath) server para isso:

```js
ids: function () {
  const idSchema = schemas.id();
  return Joi.object({
    ids: Joi.array()
      .items(idSchema.extract('id'))
      .messages({
        'array.base': `"ids" deve ser do tipo Array.`,
      }),
  });
},
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > parece que [`extract`](https://joi.dev/api/?v=17.12.2#anyextractpath) server para isso:
> > Boa Rafa, ficou legal assim! üëç Mas tamb√©m n√£o teria problema em repetir parte do c√≥digo original de valida√ß√£o do `id`. Minha preocupa√ß√£o era em n√£o validar `id` e `ids` com o mesmo esquema.
> > J√° no `events`, talvez seja melhor usar o `concat` ao inv√©s do `extract`, ou at√© melhor se alterar o `event` para ter o `id` e `created_at` como opcionais e remover o `originatorIp` no `filterOutput`.
> > E falando em `events`, ficou complexo criar um esquema mais completo para ser usado no `filterOutput`?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > J√° no `events`, talvez seja melhor usar o `concat` ao inv√©s do `extract`, ou at√© melhor se alterar o `event` para ter o `id` e `created_at` como opcionais e remover o `originatorIp` no `filterOutput`.
> > O `event` √© usado para tratar os dados na cria√ß√£o do evento, e o `events` para tratar a sa√≠da; isso faz com que o padr√£o do primeiro seja `camelCase` e o padr√£o do segundo seja `snake_case`. Voc√™ tem alguma sugest√£o de como poderia unir ambos sem que acab√°ssemos deixando algo errado passar sem querer? Por exemplo, acabar fazendo a "sa√≠da" com `camelCase`. Ou isso n√£o √© uma preocupa√ß√£o para o `schemas`, e poder√≠amos ter as propriedades duplicadas (tanto em `camelCase` quanto `snake_case`)?
> > E sobre remover o `originatorIp` no `filterOutput`, seria usar o `delete`? Se sim, parece fazer sentido para mim.
> > E falando em `events`, ficou complexo criar um esquema mais completo para ser usado no `filterOutput`?
> > Imagino que voc√™ esteja falando sobre validar tamb√©m o objeto `affected`, certo? N√£o tentei fazer isso, mas posso verificar.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O `event` √© usado para tratar os dados na cria√ß√£o do evento, e o `events` para tratar a sa√≠da; isso faz com que o padr√£o do primeiro seja `camelCase` e o padr√£o do segundo seja `snake_case`. Voc√™ tem alguma sugest√£o de como poderia unir ambos sem que acab√°ssemos deixando algo errado passar sem querer? Por exemplo, acabar fazendo a "sa√≠da" com `camelCase`.
> > Parece que o `event` √© a √∫nica valida√ß√£o que n√£o est√° em snake_case, mas poderia estar. O que acha de usar a `snakeize` antes de validar `object` no `models/event`?

```js
const cleanObject = validator(snakeize(object), {
  event: "required",
});
```

Da√≠ √© s√≥ ajustar os `values` nas queries.

> E sobre remover o `originatorIp` no `filterOutput`, seria usar o `delete`? Se sim, parece fazer sentido para mim.
> Isso!
>
> > E falando em `events`, ficou complexo criar um esquema mais completo para ser usado no `filterOutput`?
>
> Imagino que voc√™ esteja falando sobre validar tamb√©m o objeto `affected`, certo? N√£o tentei fazer isso, mas posso verificar.
> Tamb√©m, mas falo em criar o esquema √∫nico com tudo que √© retornado pelo GET. E poderia ser usado tamb√©m para o POST. Acha que vale a pena o retorno do POST ser igual ao do GET?
>
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o sei se o mais correto seria remover o `&& can` daqui e apagar o teste no `undo_firewall` onde o usu√°rio n√£o possui a feature e o retorno √© `{}`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tentei usar o c√≥digo abaixo para validar o `user`, mas n√£o deu certo. N√£o sei o que est√° errado, mas mudando para o `extract` funcionou.

```js
user: function () {
  return Joi.object({}).concat(
    schemas.id(),
    schemas.created_at(),
    schemas.updated_at(),
    schemas.username(),
    schemas.description(),
    schemas.features(),
    schemas.tabcoins(),
    schemas.tabcash(),
  );
},
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que n√£o deve remover.
> > Voc√™ diz isso porque no GET j√° est√° verificando se o usu√°rio tem a feature, e no POST o usu√°rio j√° tem uma outra feature mais forte (a `undo:firewall`)?
> > Pelo motivo 1, n√£o acho deve retirar a `can` daqui, mesmo sendo redundante.
> > Pelo motivo 2, tamb√©m acho que n√£o, mas se acha que deve ser suficiente o usu√°rio possuir a feature `undo:firewall` (acho melhor n√£o), ent√£o √© melhor adicionar essa verifica√ß√£o aqui (se tem uma ou a outra feature), ao inv√©s de remover a verifica√ß√£o.
> > Ou tem outra raz√£o para remover?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se esse esquema vai conter `events` e `affected`, acho melhor usar outro nome.

```suggestion
  firewall_event: function () {
```

N√£o acha que vale a pena adicionar mais restri√ß√µes nos arrays, como `.min(1)` no `contents` e `.min(1).required()` aos `users` e `events`?
Perdi algo, ou realmente, na vers√£o atual do PR, `affected` n√£o est√° sendo usado em nenhuma verifica√ß√£o?

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o foi na vers√£o atual do PR que deu problema, certo? Pois aparentemente esse esquema n√£o est√° sendo utilizado na pr√°tica, j√° que o esquema `affected` n√£o est√° sendo utilizado.
> > Mas o problema que voc√™ deve ter encontrado √© porque `concat` s√≥ aceita um par√¢metro, ent√£o esse esquema ficaria apenas com `id`.
> > Isto deve funcionar:

```js
  user: function () {
    return Joi.object({})
      .concat(schemas.id())
      .concat(schemas.created_at())
      .concat(schemas.updated_at())
      .concat(schemas.username())
      .concat(schemas.description())
      .concat(schemas.features())
      .concat(schemas.tabcoins())
      .concat(schemas.tabcash());
  },
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que n√£o precisa desse `isDeleted`, j√° que a modera√ß√£o precisa ver o conte√∫do original afetado pelo firewall.
> > Isso tamb√©m n√£o ser√° necess√°rio se passar a usar o esquema `firewall_event.affected` na valida√ß√£o.

```suggestion
  function mapContentData(content) {
    return {
      body: content.body,
      children_deep_count: +content.children_deep_count,
      created_at: content.created_at.toISOString(),
      deleted_at: content.deleted_at?.toISOString() ?? null,
      id: content.id,
      owner_id: content.owner_id,
      owner_username: content.owner_username,
      parent_id: content.parent_id,
      published_at: content.published_at.toISOString(),
      slug: content.slug,
      source_url: content.source_url,
      status: content.status,
      tabcoins: +content.tabcoins,
      tabcoins_credit: +content.tabcoins_credit,
      tabcoins_debit: +content.tabcoins_debit,
      title: content.title,
      updated_at: content.updated_at.toISOString(),
    };
  }
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Utilize o esquema que voc√™ criou. Aqui mantive o nome do esquema como `envents`, mas recomendo mudar para deixar claro que vem mais coisa junto.

```suggestion
    filteredOutputValues = validator(output, {
      events: 'required',
    });
    filteredOutputValues.events.forEach((event) => delete event.originator_ip);
  }
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Foi pelos motivos que voc√™ mencionou mesmo. Vou deixar assim, ent√£o :+1:
> > No fim, ser√° bem improv√°vel algu√©m ter `undo:firewall` sem ter `read:firewall`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Mas o problema que voc√™ deve ter encontrado √© porque `concat` s√≥ aceita um par√¢metro
> > Ah, acabei me confundindo com a API do array. Obrigado pela aten√ß√£o :smile:
> > N√£o foi na vers√£o atual do PR que deu problema, certo? Pois aparentemente esse esquema n√£o est√° sendo utilizado na pr√°tica, j√° que o esquema `affected` n√£o est√° sendo utilizado.
> > Foi sim, eu estava enviando dados inv√°lidos para confirmar que as valida√ß√µes e as mensagens estavam funcionando da forma correta. No `filterOutput` eu filtrava o `affected.contents` e `affected.users` apenas para garantir que estavam de acordo com as permiss√µes que o usu√°rio tinha, e o `filteredOutputValues = validator(...` garantia que os valores dos arrays eram v√°lidos.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o acha que vale a pena adicionar mais restri√ß√µes nos arrays, como `.min(1)` no `contents` e `.min(1).required()` aos `users` e `events`?
> > O `contents` e `users` podem ficar vazios se acontecer um cen√°rio onde o usu√°rio cria dois conte√∫dos, apaga os dois e depois cria um terceiro e o firewall √© ativado. Ok deixar sem a valida√ß√£o `.min(1)` para esses atributos? Posso criar o teste tanto no `GET`, para deixar claro que retorna um array vazio, quanto no `POST` para garantir que nada quebra.
> > Especificamente no `POST`, nada seria desfeito, ent√£o n√£o sei se √© prefer√≠vel retornar um erro.
> > Inclusive, percebi que, mesmo sem `.min(1)`, h√° erro de valida√ß√£o nessa situa√ß√£o porque o `schemas.content()` √© considerado obrigat√≥rio, mas basta mudar para `schemas.content().optional()` para corrigir.
> > Tamb√©m posso adicionar `.max(2)` para o `events`.
> > Perdi algo, ou realmente, na vers√£o atual do PR, `affected` n√£o est√° sendo usado em nenhuma verifica√ß√£o?
> > Comentei isso em https://github.com/filipedeschamps/tabnews.com.br/pull/1638#discussion_r1543943706.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o acha que vale a pena adicionar mais restri√ß√µes nos arrays, como `.min(1)` no `contents` e `.min(1).required()` aos `users` e `events`?
>
> O `contents` e `users` podem ficar vazios se acontecer um cen√°rio onde o usu√°rio cria dois conte√∫dos, apaga os dois e depois cria um terceiro e o firewall √© ativado.
> Nesse caso, para a modera√ß√£o ter clareza do ocorrido, eu acho que os conte√∫dos que o usu√°rio apagou tamb√©m deveriam ser retornados. E isso √© uma boa raz√£o para o firewall n√£o alterar o `updated_at` e `deleted_at`, al√©m de ser um bom ind√≠cio de que dever√≠amos criar um novo status para conte√∫dos pegos pelo firewall.
> Ok deixar sem a valida√ß√£o `.min(1)` para esses atributos? Posso criar o teste tanto no `GET`, para deixar claro que retorna um array vazio, quanto no `POST` para garantir que nada quebra.
> Nesse caso √© Ok sim garantir nos testes, pois a valida√ß√£o s√≥ √© usada como filtro de output. Provavelmente esse esquema nunca ser√° utilizado como filtro de input. üëç
> Especificamente no `POST`, nada seria desfeito, ent√£o n√£o sei se √© prefer√≠vel retornar um erro.
> Se criarmos um status diferente de `deleted`, ent√£o o POST voltaria os j√° deletados para `deleted` (olhando para `deleted_at`). Mas fiquei em d√∫vida se, no caso em que n√£o vamos desfazer o evento de firewall, os conte√∫dos deveriam permanecer com o status de firewall ou o POST deveria aceitar par√¢metros para escolher entre desfazer o firewall ou consolidar e realmente alterar todos conte√∫dos afetados para `deleted`.
> Inclusive, percebi que, mesmo sem `.min(1)`, h√° erro de valida√ß√£o nessa situa√ß√£o porque o `schemas.content()` √© considerado obrigat√≥rio, mas basta mudar para `schemas.content().optional()` para corrigir.
> N√£o precisa mexer no `schemas.content()`, basta usar o esquema que voc√™ criou, pois nele j√° est√° opcional.
> Tamb√©m posso adicionar `.max(2)` para o `events`.
> Acho que isso n√£o √© necess√°rio.
>
> > Perdi algo, ou realmente, na vers√£o atual do PR, `affected` n√£o est√° sendo usado em nenhuma verifica√ß√£o?
>
> Comentei isso em [#1638 (comment)](https://github.com/filipedeschamps/tabnews.com.br/pull/1638#discussion_r1543943706).
> Entendi, mas acho que verificar apenas a feature `read:firewall` e validar tudo usando o novo esquema √© suficiente. üëç

---

Aproveito para sugerir usar `toStrictEqual` nos `expect`s de `responseBody` üëç

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Fiz o `push` agora, antes de ver o coment√°rio.
> > al√©m de ser um bom ind√≠cio de que dever√≠amos criar um novo status para conte√∫dos pegos pelo firewall.
> > Alguma sugest√£o de qual status dar para essa situa√ß√£o?
> > Nesse caso √© Ok sim garantir nos testes
> > O `push` j√° foi feito com os testes :+1:
> > Mas fiquei em d√∫vida se, no caso em que n√£o vamos desfazer o evento de firewall, os conte√∫dos deveriam permanecer com o status de firewall ou o POST deveria aceitar par√¢metros para escolher entre desfazer o firewall ou consolidar e realmente alterar todos conte√∫dos afetados para deleted.
> > Seria algo como "o firewall pegou mas precisa de uma a√ß√£o para confirmar e apagar os conte√∫dos", certo?
> > Me parece que isso aumentaria a complexidade sem trazer um benef√≠cio.
> > N√£o precisa mexer no `schemas.content()`, basta usar o esquema que voc√™ criou, pois nele j√° est√° opcional.
> > N√£o estava opcional no `.items()`, similar ao que foi comentado em https://github.com/hapijs/joi/issues/1178, ent√£o precisei mudar a parte que mencionei.
> > Acho que isso n√£o √© necess√°rio.
> > Bom, quando subir novas altera√ß√µes por causa do `status`, removo o `.max(2)`.
> > Entendi, mas acho que verificar apenas a feature read:firewall e validar tudo usando o novo esquema √© suficiente. üëç
> > Feito :+1:
> > Aproveito para sugerir usar `toStrictEqual` nos expects de `responseBody` üëç
> > Ok.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acabei de subir as altera√ß√µes com o status `firewall`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > D√° para criar a mensagem de erro com as op√ß√µes v√°lidas automaticamente (`{#valids}`), mas nesse caso √© melhor n√£o listar as op√ß√µes, pois o erro ficaria muito longo.
> > Pode deixar algo como:

- `"features" possui valores inv√°lidos.`
- `"features" n√£o aceita o valor "{#value}".`
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Melhor usar outro nome para n√£o confundir com a `createContent` do `orchestrator`.
  > > Que tal `fetchContents`?
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
      message: `N√£o √© poss√≠vel criar um novo conte√∫do diretamente com status "${cleanValues.status}".`,
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Nesse ponto `statusToIgnoreTabcoins` n√£o est√° sem√¢ntico.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > E se a gente n√£o mudar o `updated_at`, deixando isso apenas para a√ß√µes do usu√°rio?
> > O que acha?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o parece ser necess√°rio filtrar pelo `status`
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Precisa adicionar outras features aqui, ou n√£o?

```js
[
  "create:session",
  "read:session",
  "create:content",
  "create:content:text_root",
  "create:content:text_child",
  "update:content",
  "update:user",
];
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Poderia verificar aqui se foi fornecido `id` ou `ids`, pra da√≠ retornar `results.rows[0]` ou `results.rows`.
> > Assim n√£o muda o retorno esperado em partes do c√≥digo que n√£o precisariam ser mexidas nesse PR.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Por que ao inv√©s de todas as manipula√ß√µes para remover `content_` em diversas partes do c√≥digo, j√° n√£o faz a fun√ß√£o retornar aqui sem `content_`?
> > O mesmo vale para as outras fun√ß√µes de firewall.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que `fetchContents` carrega mais o sentido de "buscar conte√∫dos" do que "criar". Posso mudar para `createContentViaApi`, o que acha?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Podemos n√£o mudar o `updated_at`. Considerando que o `status` `firewall` poder√° ser confirmado e alterar o `status` dos conte√∫dos para `deleted`, ou revertido, essa a√ß√£o alteraria o `updated_at` ou n√£o?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > A fun√ß√£o do firewall s√≥ remove `['read:activation_token', 'read:recovery_token', 'create:session', 'read:session']`. Dessas, a √∫nica que n√£o est√° sendo adicionada novamente √© a `read:recovery_token`, porque pelo o que vi, nenhum usu√°rio consegue ter essa feature.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que nem mesmo ao confirmar a exclus√£o.
> > Isso porque acredito que nunca dever√≠amos atualizar o `updated_at` ao deletar o conte√∫do, mesmo quando √© o pr√≥prio usu√°rio que deletou. Faz sentido?
> > Mesmo se achar que minha ideia faz sentido, em outro momento a gente muda esse comportamento na exclus√£o dos conte√∫dos. √â melhor n√£o fazer isso nesse PR.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Isso porque acredito que nunca dever√≠amos atualizar o updated_at ao deletar o conte√∫do, mesmo quando √© o pr√≥prio usu√°rio que deletou. Faz sentido?
> > N√£o sei dizer se "faz sentido", acho que √© mais uma quest√£o de estabelecer um "acordo" onde, por exemplo, o `updated_at` n√£o representa quando o registro foi atualizado no banco de dados, mas sim quando o t√≠tulo/descri√ß√£o/fonte foi alterado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o √© mais necess√°rio adicionar as `messages` aqui.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acha que faria sentido mover essa l√≥gica para o model firewall? Aqui ficaria algo assim:

```suggestion
  const firewallData = await firewall.reviewEvent({ ...request.context, eventId, action });
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o precisa redefinir a fun√ß√£o a cada chamada de `findAll`. Pode passar `where` como par√¢metro e definir a fun√ß√£o no escopo superior. O que acha?

```suggestion
  function buildWhereClause(where) {
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o podemos ter cache da resposta desse endpoint, j√° que precisamos verificar se o requisitante tem a feature `read:firewall`

```suggestion
  .get(cacheControl.noCache, getValidationHandler, authorization.canRequest('read:firewall'), getHandler);
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O que acham de "desativada" no lugar de "desabilitada"?
> > N√£o sei se o texto "Identificamos que voc√™ est√° tentando..." √© adequado, se deveria mencionar "Identificamos muitas novas publica√ß√µes no seu IP" ou algo parecido.
> > De fato pode acontecer de cair no firewall por diferentes pessoas criarem a conta ao mesmo tempo usando a mesma rede, ent√£o √© melhor n√£o afirmar que "Identificamos que **voc√™** est√° tentando criar muitas contas".
> > Acredito ser melhor algo mais aberto, talvez "Identificamos a cria√ß√£o de muitos usu√°rios em um curto per√≠odo, ent√£o a sua conta foi desativada".
> > Acho que a mudan√ßa √© importante e necess√°ria em diversos trechos.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o acho essa frase a ideal por ser muito vaga, mas considero melhor do que a op√ß√£o que estava, por isso mudei. Obviamente, nada impede melhorarmos caso algu√©m proponha uma alternativa futuramente.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Antes eu estava verificando com `.endsWith('block_users')`. Resolvi mudar a verifica√ß√£o para ficar mais f√°cil de encontrar refer√™ncias ao buscar pelo editor de texto.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Faltou mudar aqui para "desativados".
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que `usersEvents` tamb√©m n√£o faz sentido ficar em `event-types.js`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > `context` √© um objeto que varia bastante dependendo da parte do c√≥digo (tem mais de 30 diferentes par√¢metros), ent√£o acho que fica mais claro se colocar aqui o que realmente precisamos do `context`:

```suggestion
async function reviewEvent({ action, eventId, originatorIp, originatorUserId }) {
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Tem um par√¢metro a mais aqui, ent√£o a `transaction` seria ignorada, o que daria problema nos ambientes de homologa√ß√£o e produ√ß√£o. Em desenvolvimento n√£o d√° problema porque podemos abrir mais de uma conex√£o com o banco.
> > Para facilitar a visualiza√ß√£o desses problemas, vou enviar um commit como sugest√£o de simplifica√ß√£o do c√≥digo desse arquivo.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Vamos mover essas stored procedures para uma migration para facilitar a atualiza√ß√£o das fun√ß√µes assim que fizermos o deploy.
> > Lembrando que essas fun√ß√µes podem ter os par√¢metros alterados manualmente para aumentar ou diminuir a prote√ß√£o conforme as necessidades de cada momento.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu n√£o havia colocado porque s√≥ era usado nessa fun√ß√£o, mas faz sentido sim.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o temos um padr√£o para isso, e acho que fui eu quem come√ßou a adicionar o nome da propriedade no plural nos models para permitir buscar passando um array, mas como tanto aqui quanto no `models/user` eu fa√ßo a verifica√ß√£o `Array.isArray(value)`, pensei em tirar a possibilidade de passar o nome da propriedade no plural nesses dois models. Faz sentido?
> > Se sim, posso realizar essa modifica√ß√£o junto de outras (se surgirem na revis√£o).
> > Isso tamb√©m pode ser tratado posteriormente no `contents`, j√° que ele n√£o est√° relacionado √† este PR.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Do jeito que est√° testando, tamb√©m passaria se fizesse a compara√ß√£o simplesmente com `=`:

```sql
WHERE
  events.metadata = searched_event.metadata
```

Mas acredito que a inten√ß√£o seja lidar com os casos em que nem todos os afetados ser√£o os mesmos, por exemplo quando um conte√∫do (ou usu√°rio) for pego no primeiro evento, mas, por j√° ser mais antigo, n√£o for pego pelo segundo. Nesse caso, para obter o mesmo resultado independentemente de qual dos eventos enviar na requisi√ß√£o, a compara√ß√£o precisa ser com algo assim:

```sql
WHERE
  events.metadata @> searched_event.metadata OR
  events.metadata <@ searched_event.metadata
```

Obs.: Tem outras formas de comparar, mas teria que ter algo espec√≠fico para conte√∫dos e outra compara√ß√£o para usu√°rios.
Acho que, para testar isso corretamente, teria que ser poss√≠vel criar os eventos com data retroativa. Uma alternativa √© modificar a query de cria√ß√£o do evento para usar a data e hora da lambda ao inv√©s do banco de dados (como no `published_at`) e usar `vi.useFakeTimers` no teste.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Fiquei em d√∫vida se vale a pena tantas altera√ß√µes para testar isso. Veja o que fui percebendo:

1. Ao passar um `new Date()` no `INSERT` do `models/event`, n√£o ser√° poss√≠vel testar com o `RequestBuilder` porque o Next e o Vitest s√£o processos diferentes, ent√£o mesmo modificando o tempo no teste, o registro usar√° o hor√°rio do computador.
2. Ent√£o eu poderia usar o `orchestrator` para criar os conte√∫dos, j√° que ele cria tamb√©m o evento. Nessa situa√ß√£o, o hor√°rio salvo √© o modificado no teste com `useFakeTimers()`, mas o `canRequest` n√£o √© chamado.
3. Seguindo, eu precisaria modificar o `orchestrator.createContent` para simular a chamada √† regra adequada do firewall.
4. Por fim (imagino), precisaria modificar a fun√ß√£o `firewall_create_content_text_child` e relacionadas para aceitar o `createdAt`, que seria usado para a compara√ß√£o no lugar de `AND created_at > NOW() - INTERVAL '5 seconds'`.
   Faz sentido? Compliquei alguma parte que n√£o precisaria?
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   >
   > 1. Ao passar um `new Date()` no `INSERT` do `models/event`, n√£o ser√° poss√≠vel testar com o `RequestBuilder` porque o Next e o Vitest s√£o processos diferentes, ent√£o mesmo modificando o tempo no teste, o registro usar√° o hor√°rio do computador.
   > 2. Ent√£o eu poderia usar o `orchestrator` para criar os conte√∫dos, j√° que ele cria tamb√©m o evento. Nessa situa√ß√£o, o hor√°rio salvo √© o modificado no teste com `useFakeTimers()`, mas o `canRequest` n√£o √© chamado.
   >    Para usar tempos falsos, de fato precisa criar o conte√∫do pelo `orchestrator.createContent`, mas s√≥ precisa falsificar a hora do primeiro (ou dos primeiros) evento(s). A requisi√ß√£o que vai cair no firewall deve ser direto pela API, onde pode ser usado o `RequestBuilder`.
   > 3. Seguindo, eu precisaria modificar o `orchestrator.createContent` para simular a chamada √† regra adequada do firewall.
   >    Acho que n√£o precisa (nem deveria fazer isso), mas entendo que isso seria para a cria√ß√£o do primeiro evento de firewall do teste. Deve ser suficiente adicionar um `orchestrator.createFirewallEvent` para permitir criar um evento qualquer diretamente por ele. Com isso ser√° poss√≠vel simular um evento de firewall com mais (e com menos) conte√∫dos (ou usu√°rios) do que o evento de firewall que ser√° criado pela API, e da√≠ √© esperado que esse evento criado manualmente seja inclu√≠do nos eventos de firewall relacionados que s√£o retornados. Acho que compensa fazer isso, pois a alternativa seria criar os dois eventos pela API, mas adicionando um intervalo de tempo entre as duas chamadas, o que aos poucos vai atrasando a execu√ß√£o da bateria de testes
   >    Sobre o `orchestrator.createFirewallEvent`, ele pode chamar um `firewall.createEvent`, que pode ser criado para ser usado dentro de `firewall/rules`, o que tamb√©m parece ser uma refatora√ß√£o simples.
   > 4. Por fim (imagino), precisaria modificar a fun√ß√£o `firewall_create_content_text_child` e relacionadas para aceitar o `createdAt`, que seria usado para a compara√ß√£o no lugar de `AND created_at > NOW() - INTERVAL '5 seconds'`.
   >    Pensando rapidamente, acho que n√£o precisa modificar essas fun√ß√µes.
   >    Faz sentido? Compliquei alguma parte que n√£o precisaria?
   >    Talvez tenha complicado ao pensar em usar apenas o `orchestrator.createContent` ou apenas o `RequestBuilder`, mas usando os dois, cada um no momento adequado, acho que √© uma mudan√ßa bem simples. No `Triple A` dos testes (`Arrange`, `Act`, `Assert`), o `orchestrator.createContent` e `orchestrator.createFirewallEvent` seriam usados no `Arrange` e o `RequestBuilder` no `Act`.
   >    No c√≥digo atual em produ√ß√£o seria uma mudan√ßa apenas na `query` de `event.create`, por exemplo adicionando `created_at`, `$5` e `new Date()` assim:

```js
const query = {
  text: `INSERT INTO events (type, originator_user_id, originator_ip, metadata, created_at)
               VALUES($1, $2, $3, $4, $5) RETURNING *;`,
  values: [
    cleanObject.type,
    cleanObject.originator_user_id,
    cleanObject.originator_ip,
    cleanObject.metadata,
    new Date(),
  ],
};
```

N√£o testei o que estou sugerindo, ent√£o posso estar deixando escapar algo. Se preferir, posso implementar para descobrir se √© t√£o simples como pensei. ü§ù

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > @aprendendofelipe Eu estava tentando implementar mas comecei a ficar confuso sobre o que voc√™ realmente prop√¥s, ent√£o se puder implementar, agrade√ßo.
> > A altera√ß√£o que subi agora foi apenas para definir o `status: published` de alguns testes que criavam publica√ß√µes pelo `orchestrator`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Pode deixar que amanh√£ eu implemento ü§ù
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > As altera√ß√µes que subi agora foram apenas um `rebase`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Criei os testes alterando a data de cria√ß√£o do evento, foi a forma mais simples que encontrei. Al√©m disso, fiz alguns ajustes conforme necess√°rio.
> > Acha que o comportamento precisa ser modificado ou faz sentido como est√°?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Boa! Isso acabou sobrando de uma primeira vers√£o que testei.
> > Aproveitando que est√° melhorando esse arquivo, pode melhorar tamb√©m esta parte para ficar como voc√™ fez em `review`:

```diff
- if (event.metadata.users?.length) event.metadata.users.forEach((userId) => usersIds.add(userId));
- if (event.metadata.contents?.length) event.metadata.contents.forEach((contentId) => contentsIds.add(contentId));
+ event.metadata.users?.forEach((userId) => usersIds.add(userId));
+ event.metadata.contents?.forEach((contentId) => contentsIds.add(contentId));
```

Eu comecei fazendo mais coisas em cada `if`, mas depois refatorei e s√≥ sobrou um `forEach` em cada, e nem percebi que dava para simplificar mais.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  const affectedUsers = await user.addFeatures(reviewEvent.metadata.users, ['nuked'], {
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Que tal passar `createdEvent` uma √∫nica vez?

```suggestion
    const affected = await reviewFunctions[eventType]({
      transaction,
      event: createdEvent,
    });
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o precisamos validar tamb√©m os eventos `moderation:block...`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o estou sugerindo alterar isso nesse PR, apenas abrindo um debate para melhorias futuras...
> > Ser√° que n√£o era melhor notificar todos os usu√°rios afetados? Penso em um caso de algu√©m distra√≠do que n√£o se atentou √† mensagem de erro recebida, ou algu√©m usando um sistema desenvolvido pela comunidade, que use a API, mas n√£o apresente os erros corretamente.
> > Uma outra altera√ß√£o no mesmo trecho de c√≥digo pode envolver n√£o notificar mais de uma vez pelo mesmo conte√∫do. Podemos olhar o `status_before_update` para n√£o duplicar as notifica√ß√µes em caso de eventos consecutivos.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Precisa testar o GET aqui? Ou realmente est√° testando algum requisito do POST? Ser√° que a inten√ß√£o n√£o era testar o comportamento ao realizar POST no outro evento?
> > A mesma d√∫vida se aplica ao pr√≥ximo teste.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Est√° certo, n√£o reparei isso quando estava modificando a fun√ß√£o. :+1:
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Estava testando para garantir que os dois eventos retornam os mesmos dados (`review` de um, e `GET` de outro). Isso confirma tanto que est√£o retornando os mesmos campos quanto que o segundo passou a ser considerado como "avaliado" tamb√©m (visto que o `GET` retorna o evento de `review`).
> > Inicialmente os endpoints n√£o estavam retornando as mesmas coisas, foi ent√£o que percebi a necessidade de modificar o `content.confirmFirewallStatus` e `content.undoFirewallStatus` para retornar o nome de usu√°rio, TabCoins e `children_deep_count`. O `validator` n√£o apontou esse problema porque o `firewall_event` apenas valida o `schemas.content` e `schemas.user`, sem especificar quais campos s√£o `required`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Vi que podemos usar o `Joi.string().valid()` para unificar as valida√ß√µes iguais, ent√£o aproveitei para simplificar:

```js
{
  is: Joi.string().valid(
    'moderation:block_contents:text_root',
    'moderation:block_contents:text_child',
    'moderation:unblock_contents:text_root',
    'moderation:unblock_contents:text_child',
  ),
  then: Joi.object({
    related_events: Joi.array().items(Joi.string()).required(),
    contents: Joi.array().required(),
  }),
}
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > A parte que verifica o `GET /firewall` para esse caso deveria ser adicionada no arquivo de testes do endpoint espec√≠fico, mesmo que a etapa de prepara√ß√£o seja id√™ntica, os expects v√£o mudar, pois l√° n√£o precisamos nos preocupar com o que foi retornado no `POST /review`, e aqui n√£o precisamos verificar o `GET /firewall`.
> > Isso deixa os testes mais objetivos, e ajuda a ir direto no ponto do problema em caso de erros.
> > </pull_1638_Reverter ganhos de TabCoins em conte√∫dos pegos pelo firewall interno e outros ajustes>

<pull_1642_Substitui Jest por Vitest>

## Mudan√ßas realizadas

<!-- Por favor, inclua uma descri√ß√£o sobre o que foi modificado nesse PR. Inclua tamb√©m qualquer motiva√ß√£o ou contexto relevante.  -->

Troca ferramenta de teste automatizados.

<!-- Se o PR cont√©m uma modifica√ß√£o da interface gr√°fica (UI), adicione fotos ou v√≠deos comparando o antes e depois. -->
<!-- Se o PR cont√©m modifica√ß√µes de API, mencione os endpoints afetados. -->
<!-- Caso esse PR resolva algum issue, voc√™ pode descomentar a linha abaixo e substituir (issue) pelo n√∫mero dele. -->

Resolve #1631

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Melhoria
  <!-- - [x] Corre√ß√£o de bug -->
  <!-- - [x] Nova funcionalidade -->
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Muito bom @ErickCReis! Obrigado pelo PR! üí™üí™üí™
  > > Fora o que comentei no c√≥digo, vamos precisa adequar o README, pois parece que o Vitest n√£o aceita REGEX para escolhermos quais testes executar. Pelo menos o `.` n√£o funciona em:
  > > `npm run test:watch -- username./patch`
  > > Ent√£o precisa ver alguma forma que funcione em qualquer sistema operacional
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de ErickCReis (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > N√£o cheguei a testar localmente, mas vi o PR e comentei alguns detalhes.
  > > PS: Mais uma √≥tima contribui√ß√£o, @ErickCReis :smile:
  > > Review de aprendendofelipe (COMMENTED):
  > > Sobre a quest√£o do regex citada no README, o Vitest realmente [n√£o √© compat√≠vel](https://vitest.dev/guide/cli#vitest):
  > > This filter only checks inclusion and doesn't support regexp or glob patterns (unless your terminal processes it before Vitest receives the filter).
  > > Mas j√° testei no mac, windows e linux, e podemos substituir tranquilamente os pontos (`.`) por `[` e `]` nos exemplos citados:

```bash
npm run test:watch -- username]/patch
```

```bash
npm run test:watch -- contents/[username]/[slug]/get
```

Ent√£o basta adequar o texto para algo como:

> Caso n√£o queira dar `watch` em todos os testes e queira isolar arquivos de teste espec√≠ficos, voc√™ pode filtrar pelo caminho. N√£o √© necess√°rio digitar o caminho inteiro para o arquivo, veja alguns exemplos abaixo:

---

Que del√≠cia rodar todos os testes em menos de 30s üöÄüöÄüöÄ

> > Review de ErickCReis (COMMENTED):
> > Review de ErickCReis (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > A diferen√ßa de performance n√£o √© t√£o grande para permitir a redu√ß√£o do `timeout` em 6 vezes.
> > A vantagem de diminuir o timeout √© falhar mais r√°pido em alguns casos. Tem outras vantagens? N√£o acho que atualmente iria compensar o trabalho de analisar qual valor a gente poderia configurar sem risco de atrapalhar quem contribui utilizando equipamentos mais fracos, ent√£o eu manteria o valor atual:

```suggestion
    testTimeout: 60_000,
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Essa revis√£o me fez perceber que no #1621 eu acabei deixando o `--verbose` no lugar errado, fazendo os resultados dos testes serem apresentados apenas por arquivos ao inv√©s de por teste individual.
> > Se acharem que compensa manter resumido assim, ent√£o √© s√≥ remover o `--verbose` que n√£o est√° fazendo nada aqui. O `tests/unit` eu imagino que foi algo esquecido durante a revis√£o.
> > Mas se acharem melhor voltar o relat√≥rio mais completo, ent√£o:

```suggestion
    "test": "npm run concurrently -- \"vitest run --reporter verbose\" --hide next || npm run services:stop",
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Dependendo do ambiente em que o teste √© executado, local ou remoto, o cabe√ßalho `keep-alive` pode ou n√£o ser retornado, ent√£o o teste precisa passar nas duas op√ß√µes, e ainda garantir que nenhum cabe√ßalho diferente seja retornado.
> > Acho que voc√™ removeu essa linha porque o Vitest est√° se comportando diferente do Jest, e o teste n√£o estava passando em ambiente local (sem `keep-alive`), ent√£o uma op√ß√£o para voltar o teste mais completo √© substituir o `expect` atual pelo c√≥digo abaixo:

```js
const expectedHeaders = {
  "x-dns-prefetch-control": ["on"],
  "strict-transport-security": ["max-age=63072000; includeSubDomains; preload"],
  "x-xss-protection": ["1; mode=block"],
  "x-frame-options": ["SAMEORIGIN"],
  "permissions-policy": ["camera=(), microphone=(), geolocation=()"],
  "x-content-type-options": ["nosniff"],
  "referrer-policy": ["origin-when-cross-origin"],
  "access-control-allow-credentials": ["true"],
  "access-control-allow-origin": ["*"],
  "cache-control": ["public, s-maxage=10, stale-while-revalidate"],
  "access-control-allow-methods": ["GET,OPTIONS,PATCH,DELETE,POST,PUT"],
  "access-control-allow-headers": [
    "X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version",
  ],
  link: [
    '<http://localhost:3000/api/v1/contents?strategy=relevant&page=1&per_page=30>; rel="first"',
  ],
  "x-pagination-total-rows": ["0"],
  "content-type": ["application/json; charset=utf-8"],
  etag: responseHeaders.etag,
  "content-length": ["2"],
  vary: ["Accept-Encoding"],
  date: responseHeaders.date,
  connection: [expect.stringMatching(/^close$|^keep-alive$/)],
};
const expectedHeadersAlternative = {
  ...expectedHeaders,
  "keep-alive": [expect.stringMatching(/^timeout=/)],
};
expect([expectedHeaders, expectedHeadersAlternative]).toContainEqual(
  responseHeaders
);
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se precisou do `advanceTimersByTime` aqui, ent√£o √© porque a op√ß√£o `advanceTimers: true` n√£o tem efeito no Vitest.
> > Em uma busca r√°pida, n√£o achei nada sobre essa op√ß√£o na documenta√ß√£o do Vitest, ent√£o n√£o deve ter mesmo.
> > J√° dei um revisada nos testes, e o avan√ßo no tempo s√≥ era necess√°rio aqui, ent√£o podemos remover todas as linhas que configuram `advanceTimers: true` üëç
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > No seu ambiente, o Vitest n√£o est√° reconhecendo a importa√ß√£o sem o `.js`?
> > Testei aqui e foi normal. Tamb√©m pude remover em `vi.mock` e no `reward.test.js`.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Adicionei esse valor logo no in√≠cio da implementa√ß√£o e esqueci de revisar essa parte, n√£o vejo motivo para alterar esse valor, vou manter no 60 segundos mesmo.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Se acharem que compensa manter resumido assim, ent√£o √© s√≥ remover o `--verbose` que n√£o est√° fazendo nada aqui.
> > N√£o utilizo os testes com tanta frequ√™ncia ent√£o a remo√ß√£o do `--verbose` n√£o fez diferen√ßa pra mim, inclusive n√£o tinha notado tamb√©m que estava no lugar errado. Vou manter sem o `--verbose`, mas se mudarem de ideia posso voltar ele.
> > O `tests/unit` eu imagino que foi algo esquecido durante a revis√£o.
> > Sim, tinha esquecido ele a√≠.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Esse era mais um dos pontos que era para eu ter revisado antes mas acabei esquecendo.
> > Adicionei o trecho que vc recomendou.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > Acho que o nome dessa op√ß√£o no Vitest √© [shouldadvancetime](https://vitest.dev/config/#faketimers-shouldadvancetime), quando ca√≠ nesse problema n√£o tinha percebido isso e acabei resolvendo com o `advanceTimersByTime`.
> > De qualquer forma tamb√©m acho que √© mais interessante remover o essa op√ß√£o j√° que s√≥ utilizamos para esse trecho.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > N√£o lembro exatamente pq fiz essa altera√ß√£o, mas removi o `.js` e funcionou normalmente. Vou corrigir aqui.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Se acharem que compensa manter resumido assim, ent√£o √© s√≥ remover o `--verbose` que n√£o est√° fazendo nada aqui.
> > Precisei mexer bastante com testes no √∫ltimo PR que fiz e n√£o percebi isso. Fui na [documenta√ß√£o](https://vitest.dev/guide/reporters) ver a diferen√ßa com/sem `--verbose` e acho que podemos continuar sem.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Pode remover o `^` aqui (e rodar o `npm install` de novo, para atualizar o `package-lock.json`).
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > A [√∫ltima vers√£o](https://www.npmjs.com/package/vitest) parece ser a `1.3.1`, tem algum motivo para usar a `1.2.2`?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Imagino que tenha subido esse arquivo sem querer.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que compensa alterar a extens√£o do `vitest.config` para `.mjs` para remover o aviso:
> > `[vitest] The CJS build of Vite's Node API is deprecated. See https://vitejs.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.` > > https://vitejs.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > @ErickCReis, acho que pode adicionar esse arquivo ao `.gitignore`, se isso facilitar pra voc√™ üëç
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > J√° faz um tempo que tinha iniciado essa branch por isso estava com uma vers√£o mais antiga, vou atualizei aqui.
> > Coment√°rio de ErickCReis (linha de c√≥digo):
> > J√° perdi a conta de quantas vezes commitei essa arquivo kkk, vou adicionar no `.gitignore`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o creio que o PR vai ficar pendente por uma falta de quebra de linha no final do arquivo üòÖ
> > </pull_1642_Substitui Jest por Vitest>

<pull_1644_Permitir filtrar testes em qualquer modo de execu√ß√£o>
Atualmente nossos scripts n√£o permitem filtrar os testes que queremos executar a n√£o ser que estejamos executando os testes em modo `watch`.

## Mudan√ßas realizadas

- Adiciona a possibilidade de filtrar os testes passando argumentos para o Jest usando `passthrough-arguments` do `concurrently` (`-P` e `{@}`).
- Sempre executar `services:stop` ao encerrar o processo de testes: Passando `-s first` para o `concurrently`, de forma que ele seja encerrado com c√≥digo 0 dependendo apenas do encerramento do processo do Next.js e n√£o dos testes.
- Organiza o script `concurrently`, separando o `preconcurrently` e o `postconcurrently`, al√©m de trazer o comando do Jest para o script principal.
- Adequa o README √†s novas possibilidades de filtrar n√£o apenas em modo `watch`.

## Tipo de mudan√ßa

- [x] Nova funcionalidade
- [x] Atualiza√ß√£o de documenta√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os antigos testes est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Parece bom para mim :+1:
  > > Testar as altera√ß√µes me fez lembrar que o `npm run test` nunca funcionou para mim quando outro terminal estava com o `npm run dev`. Ele mata o servi√ßo, mas n√£o prossegue para os testes. √â s√≥ aqui que acontece isso?
  > > </pull_1644_Permitir filtrar testes em qualquer modo de execu√ß√£o>

<pull_1645_Refatorar componentes de e-mail>

## Mudan√ßas realizadas

Este PR √© uma refatora√ß√£o dos arquivos em `models/transactional/emails` para criar componentes onde havia muita repeti√ß√£o de estiliza√ß√£o. √â uma continua√ß√£o do que havia sido iniciado em #1638.
Al√©m do que havia sido feito, criei o componente `LinkText`, que cont√©m a estiliza√ß√£o de "c√≥digo" e tamb√©m est√° com o texto que era repetido em todo lugar (_Se voc√™ n√£o conseguir clicar no link, copie e cole o endere√ßo abaixo no seu navegador:_).
Pensei em colocar o `LinkText` dentro do `Link`, mas isso tiraria a flexibilidade de usar um link como parte do par√°grafo, e n√£o como o par√°grafo inteiro.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1645_Refatorar componentes de e-mail>

<pull_1646_For√ßar `clobberPrefix.toLowerCase()`>
Pequeno ajuste na implementa√ß√£o de #1635

> > Review de Rafatcb (APPROVED):
> > </pull_1646_For√ßar `clobberPrefix.toLowerCase()`>

<pull_1656_Migra√ß√£o para criar novas tabelas de saldo>

## Mudan√ßas realizadas

Conforme discutido em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2002538824, separei o `balance_operations` em tr√™s tabelas distintas: uma para as opera√ß√µes de TabCoins de conte√∫dos, outra para as de TabCoins de usu√°rios e outra para as de TabCash.
N√£o adicionei `balance_type` na tabela `user_tabcoin_operations` e `user_tabcash_operations` porque na `balance_operations` os valores eram `user:tabcoin` e `user:tabcash`, ent√£o seria bem redundante.
Esse processo ser√° feito em alguns PRs diferentes:

1. O primeiro PR √© este, e cont√©m a cria√ß√£o das tabelas e das fun√ß√µes.
2. O segundo PR permitir√° colocar os endpoints em manuten√ß√£o de forma din√¢mica (https://github.com/filipedeschamps/tabnews.com.br/pull/1662), conforme discutido em https://github.com/filipedeschamps/tabnews.com.br/pull/1656#issuecomment-2029682625 e nos coment√°rios seguintes.
3. O terceiro PR (https://github.com/filipedeschamps/tabnews.com.br/pull/1661) far√° a leitura e escrita nas tabelas novas.
4. Um quarto PR (#1673 ) far√° uma migra√ß√£o para remover a tabela `balance_operations` e as fun√ß√µes que n√£o s√£o mais utilizadas.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o
  > > Review de aprendendofelipe (COMMENTED):
  > > Conforme discutido em [#1491 (comment)](https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2002538824), separei o `balance_operations` em tr√™s tabelas distintas: uma para as opera√ß√µes de TabCoins de conte√∫dos, outra para as de TabCoins de usu√°rios e outra para as de TabCash.
  > > Show @Rafatcb, mas junto disso voc√™ trouxe outras refatora√ß√µes, que s√£o interessantes, mas que acho melhor fazer separadamente (e avaliando se realmente s√£o necess√°rias).
  > > Pelo que eu tinha sugerido, fora as adequa√ß√µes nas tabelas e fun√ß√µes do PostgreSQL, apenas os c√≥digos relacionados com as queries precisariam de altera√ß√µes. E o ponto principal √© que todos os testes antigos deveriam passar sem nenhuma adequa√ß√£o.
  > > Se estiver tudo certo, posso passar o primeiro commit (com a cria√ß√£o das fun√ß√µes e tabelas) para outro PR.
  > > O primeiro PR acredito que ser√° isso mesmo, mas ser√° necess√°rio pelo menos mais um PR intermedi√°rio que ir√° ler apenas das tabelas antigas, mas gravar de maneira duplicada para garantir a consist√™ncia quando o terceiro PR alterar a leitura para as tabelas novas. Nesse √∫ltimo j√° deve ser poss√≠vel parar de duplicar os dados e apagar as tabelas antigas.
  >
  > - N√£o sei se podemos considerar **breaking change** a mudan√ßa do `error_location_code` de `MODEL:BALANCE:RATE_CONTENT:NOT_ENOUGH` para `MODEL:CONTENT:RATE:NOT_ENOUGH`, j√° que ningu√©m deveria depender disso (√© uma propriedade inst√°vel).
  >   Acho que nesse PR n√£o deveria mexer nisso.
  > - Eu n√£o adicionei `balance_type` na tabela `user_tabcoin_operations` e `user_tabcash_operations` porque na `balance_operations` os valores eram `user:tabcoin` e `user:tabcash`, ent√£o seria bem redundante. Fiquei em d√∫vida se faria sentido usar os tipos `credit` e `debit`, como ocorre com os conte√∫dos.
  >   Isso eu manteria como voc√™ fez mesmo üëç
  > - Faz sentido criar uma migration para apagar a tabela `balance_operations`, `get_content_balance_credit_debit` e `get_current_balance` em um outro PR? Assim essa tabela n√£o existir√° desnecessariamente, e podemos garantir que a migration s√≥ seja executada depois de termos tudo funcionando corretamente.
  >   Faz sentido sim! üëç
  >   Eu optei por copiar o `sequence` para ficar mais f√°cil de identificar qual foi o √∫ltimo copiado, mas isso tamb√©m poderia ser comparado pelo `id`, j√° que estou copiando o `id` de `balance_operations`:
  >   Pela raz√£o de existir do `sequence`, acho que n√£o faz sentido copiar o valor dele para a nova tabela, a n√£o ser que crie uma coluna tempor√°ria como `sequence_old`, mas que n√£o me parece necess√°ria se tomarmos os devidos cuidados.
  >   O que precisamos √© garantir que a tabela antiga tenha todas as entradas com os valores poss√≠veis de `sequence` do primeiro ao √∫ltimo, sem pular nenhum, que as novas tabelas tenham a mesma sequ√™ncia em `sequence` (n√£o o valor em si, mas a mesma ordem da tabela original e sem pular valores) e que exista a correspond√™ncia correta entre as entradas da tabela antiga e as novas.
  >   Ent√£o a migra√ß√£o dos dados vai precisar de etapas extras para garantir tudo isso.
  >   Quando colocado em produ√ß√£o, pode ser que ocorra atualiza√ß√µes em `balance_operations` entre a √∫ltima c√≥pia e o merge do PR. Nessa situa√ß√£o, seria necess√°rio usar a query para copiar novamente a partir de terminado `sequence`, mas sem copiar o valor do `sequence` para n√£o conflitar com intera√ß√µes que ocorreram ap√≥s o merge.
  >   Ent√£o, √© isso que precisa ser melhor pensado para garantir a mesma ordem em `sequence`.
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de aprendendofelipe (APPROVED):
  >   > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  >   > Em modo local podemos abrir mais de uma conex√£o com o PostgreSQL, mas em produ√ß√£o limitamos a uma conex√£o por lambda, ent√£o ser√° preciso executar um por vez.
  >   > Mas, na verdade, acho que √© melhor n√£o refatorar isso nesse PR.
  >   > Coment√°rio de Rafatcb (linha de c√≥digo):
  >   > Eu havia mudado do `findAll` com `WHERE originator_id` seguido de um `for` com `balance.undo` para usar direto o `undoAllByOriginatorId` porque sen√£o ficaria assim (em pseudo-c√≥digo):

```js
const contentBalanceOperations = await getContentBalanceOperationsFromEvent();
const userTabcoinsOperations = await getUserTabcoinsOperationsFromEvent();
const userTabcashOperations = await getUserTabcashOperationsFromEvent();
for (const eventContentBalanceOperations of contentBalanceOperations) {
  await contentTabcoin.undo();
}
for (const eventTabcoinOperations of userTabcoinOperations) {
  await userTabcoin.undo();
}
for (const userTabcashOperations of userTabcashOperations) {
  await userTabcash.undo();
}
```

Ou seja, tr√™s `SELECT`s, um para cada tabela, seguido de tr√™s la√ßos iterando sobre cada retorno dos `SELECT`s.
Se preferir que o PR 3 (leitura das tabelas novas) fique com o c√≥digo mencionado acima, e que abra um quarto PR para a refatora√ß√£o, tudo bem.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Por que o PR 3 n√£o poderia permanecer com o c√≥digo original aqui?

```js
for (const eventBalanceOperation of eventBalanceOperations) {
  await balance.undo(eventBalanceOperation.id, options);
}
```

Minha sugest√£o original (criar novas tabelas no banco) n√£o envolvia a cria√ß√£o de novos _models_. Isso √© mesmo necess√°rio?

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o √© necess√°rio criar novos models se o `models/balance` lidar com o "malabarismo" de usar a tabela adequada dependendo dos argumentos recebidos na fun√ß√£o em quest√£o. Seria um model conhecendo a estrutura de tr√™s tabelas diferentes, similar √† fun√ß√£o `rate` criada em `models/content`, por√©m para todas fun√ß√µes que forem necess√°rias (`create`, `getTotal`, `undo` e `findOne`, que √© usada apenas pelo pr√≥prio `undo`).
> > Pensei que fizesse mais sentido separar a responsabilidade para models diferentes.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Pensei que fizesse mais sentido separar a responsabilidade para models diferentes.
> > Sim Rafa, deve fazer sentido separar os _models_, mas n√£o necessariamente por estamos separando as tabelas. Apenas acredito ser melhor ~separar~(remover desse PR) o que n√£o √© necess√°rio ao processo de separa√ß√£o das tabelas
> > </pull_1656_Migra√ß√£o para criar novas tabelas de saldo>

<pull_1661_Salvar opera√ß√µes de saldo em `balance_operations` e nas novas tabelas e reabilitar endpoints>

## Mudan√ßas realizadas

Criei esta branch a partir da `refactor-table-balance-operations` (PR #1656).

- Salva as opera√ß√µes de saldo em `balance_operations` e tamb√©m nas novas tabelas.
- Habilita novamente os endpoints que modificam `balance_operations`, removendo a resposta de manuten√ß√£o. ~Ainda deixei o arquivo `pages/api/v1/_responses/maintenance.public.js` porque imagino que possa ser √∫til em outras ocasi√µes.~
  Este PR faz parte do processo de migra√ß√£o do registro de saldos da tabela `balance_operations` para tr√™s tabelas espec√≠ficas: `content_tabcoin_operations`, `user_tabcoin_operations` e `user_tabcash_operations`. O PR #1656 deve ser mesclado primeiro, seguido da migra√ß√£o dos dados existentes durante o per√≠odo de manuten√ß√£o (sem novas escritas de saldo pela API), e ent√£o o merge deste PR, voltando ao modo de opera√ß√£o normal.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o.
- [x] Retorna a API ao estado normal.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  >
  > - Salva as opera√ß√µes de saldo em `balance_operations` e tamb√©m nas novas tabelas.
  >   Por optar em colocar o TabNews em "modo leitura", n√£o vejo mais necessidade de salvar os dados na tabela antiga ao mesmo tempo que na nova. No PR 2 j√° pode usar somente as tabelas novas. S√≥ falei em deixar a exclus√£o da `balance_operations` para o PR 3 por uma precau√ß√£o, mas, em princ√≠pio, a migra√ß√£o para as novas tabelas pode acabar j√° no PR 2.
  >   Deixar este PR com as leituras realizadas pela tabela `balance_operations` tem o benef√≠cio de possibilitar reabilitar o site mesclando o PR mesmo caso ocorra algum problema na migra√ß√£o de dados para as tabelas novas.
  >   Se tivermos problemas com a ~migrac√£o~c√≥pia dos dados para as tabelas novas (PR 1), tem algo muito errado que n√£o prevemos, ent√£o n√£o seria prudente fazer o merge desse PR 2, mas sim voltar o site para o "modo normal", com um rollback, e analisar com calma o que aconteceu.
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Show @Rafatcb! üí™
  >   > J√° deixei alguns coment√°rios no c√≥digo, mas ainda vou olhar com mais calma o `models/balance`, pois eu imaginava uma modifica√ß√£o mais simples, e com menos duplica√ß√£o de c√≥digo para cada nova tabela.
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (COMMENTED):
  >   > @Rafatcb, consegui olhar o `models/balance`, e percebi que voc√™ j√° tinha melhorado ele desde quando eu falei que iria ver com calma. üí™üëç
  >   > Cheguei a fazer alguns coment√°rios no c√≥digo, mas achei melhor testar o que eu estava sugerindo, ent√£o j√° subi um [commit](https://github.com/filipedeschamps/tabnews.com.br/pull/1661/commits/0af16f41f1b7dcd60fcb36889b4b59fccafb1bd7) com as sugest√µes.
  >   > Deixei com a mesma mensagem do √∫ltimo commit, pois acredito que faz sentido fazer squash, j√° que o diff final desse arquivo agora pode ter ficado um pouco mais simples.
  >   > Veja se as mudan√ßas fazem sentido. ü§ù
  >   > Review de Rafatcb (COMMENTED):
  >   > Review de aprendendofelipe (APPROVED):
  >   > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  >   > O que se quer garantir com esses novos `expect`s?
  >   > Coment√°rio de Rafatcb (linha de c√≥digo):
  >   > Que o usu√°rio recebeu os TabCoins de volta (e perdeu o TabCash) das avalia√ß√µes desfeitas.
  >   > Hoje, isso n√£o √© relevante, j√° que n√£o d√° para "desbanir" um usu√°rio e nem ver os TabCoins e TabCash dele, mas esse √© o comportamento esperado do sistema. Quando eu havia feito a refatora√ß√£o na primeira implementa√ß√£o do PR #1656, acabei quebrando esse comportamento sem quebrar nenhum teste, ent√£o achei √∫til t√™-lo.
  >   > Coment√°rio de Rafatcb (linha de c√≥digo):
  >   > Acabei desfazendo essa altera√ß√£o sem querer porque estava desfazendo todas modifica√ß√µes que tinha feito em testes.
  >   > Ainda acho v√°lido testar isso, mas como voc√™ n√£o respondeu meu coment√°rio, n√£o vou colocar de volta para talvez ter que tirar depois. Se voc√™ concordar que isso deve ser testado, ent√£o eu subo essa altera√ß√£o no PR.
  >   > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  >   > Acho `user_tabcoin_operations.recipient_id` mais claro do que `user_tabcoin_operations.user_id`, ent√£o eu n√£o mudaria o nome dessa coluna nas novas tabelas.
  >   > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
    'get_content_balance_credit_debit',
```

Usando o mesmo nome para a fun√ß√£o, que j√° era espec√≠fica para conte√∫dos, e mantendo o retorno como `total_balance`, evitamos todas as modifica√ß√µes em `models/content` e `queries/rankingQueries`.
Enquanto conte√∫dos s√≥ tiverem um tipo de moeda, acho que `content_balance` permanece adequado.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Realizar essa altera√ß√£o modificando a fun√ß√£o existente far√° os testes quebrarem no PR da migra√ß√£o. De todo modo, vou subir as altera√ß√µes para voc√™ revisar.
> > √â vi√°vel realizar o merge com tudo em um √∫nico PR, considerando que a vari√°vel de ambiente pode ser definida para desabilitar as rotas (https://github.com/filipedeschamps/tabnews.com.br/pull/1662).
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Realizar essa altera√ß√£o modificando a fun√ß√£o existente far√° os testes quebrarem no PR da migra√ß√£o. De todo modo, vou subir as altera√ß√µes para voc√™ revisar.
> > Certo, acho que √© porque as mudan√ßas nas fun√ß√µes do Postgres precisam ser feitas em conjunto com o restante das modifica√ß√µes, ou seja, nesse PR aqui, e n√£o no PR de cria√ß√£o das novas tabelas.
> > Podemos mesclar esse aqui ainda em "modo leitura" at√© rodarmos as migrations desse aqui tamb√©m, ent√£o fazemos o redeploy voltando ao "modo normal".
> > Al√©m disso, pode ser interessante criar uma nova migration para j√° fazer a c√≥pia dos dados no mesmo PR da cria√ß√£o da novas tabelas. Deixando para o processo manual, apenas as queries de valida√ß√µes se tudo deu certo. O que acha?
> > √â vi√°vel realizar o merge com tudo em um √∫nico PR, considerando que a vari√°vel de ambiente pode ser definida para desabilitar as rotas (#1662).
> > Tudo no mesmo PR n√£o √© poss√≠vel porque entramos em um paradoxo. O build resultar√° em erro, pois n√£o foram executadas as migrations, e as migrations n√£o poder√£o ser executadas, porque o erro no build impedir√° o deploy.
> > Isso porque, em homologa√ß√£o e produ√ß√£o, adotamos o processo de rodar as migrations sempre de forma manual. Existe outra abordagem de CI que roda as migrations no build, mas isso exigiria uma mudan√ßa na forma como testamos em homologa√ß√£o, exigindo um banco diferente (ou uma branch do banco, em servi√ßos que permitem isso) para cada deploy em homologa√ß√£o.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Podemos mesclar esse aqui ainda em "modo leitura" at√© rodarmos as migrations desse aqui tamb√©m, ent√£o fazemos o redeploy voltando ao "modo normal".
> > Sim, pensei nisso.
> > Al√©m disso, pode ser interessante criar uma nova migration para j√° fazer a c√≥pia dos dados no mesmo PR da cria√ß√£o da novas tabelas. Deixando para o processo manual, apenas as queries de valida√ß√µes se tudo deu certo. O que acha?
> > Voc√™ est√° falando sobre as queries mencionadas em https://github.com/filipedeschamps/tabnews.com.br/pull/1656#issuecomment-2028481797, certo? Posso fazer isso. Crio um arquivo de migration novo apenas para isso, neste mesmo PR?
> > Outra pergunta, n√£o tenho certeza como as queries ir√£o se comportar se fizer tudo de uma vez ("sem `WHERE`"), principalmente considerando o tempo limite de execu√ß√£o da lambda. Faz sentido executar em blocos? Por exemplo, da `sequence = 1` em `balance_operations` at√© a `sequence = 100000`, e depois da `100001` at√© `200000` etc. (n√£o sei se o ideal √© de 100 mil em 100 mil).
> > Tudo no mesmo PR n√£o √© poss√≠vel porque entramos em um paradoxo. O build resultar√° em erro, pois n√£o foram executadas as migrations, e as migrations n√£o poder√£o ser executadas, porque o erro no build impedir√° o deploy.
> > N√£o entendi. Quando eu disse "tudo em um √∫nico PR" quis dizer para "esquecermos" o PR #1656 (que est√° quebrando os testes), n√£o sei se foi nesse ponto que me expressei mal. O ambiente de homologa√ß√£o est√° no ar, apenas sem funcionar algumas coisas (como o login) porque as migra√ß√µes n√£o foram executadas. Ent√£o o processo que imaginei era:

1. Mesclar os PRs #1663 e #1662.
2. Definir a vari√°vel de ambiente `UNDER_MAINTENANCE` para bloquear os endpoints `POST /api/v1/contents/*` e `GET /api/v1/user`.
3. Mesclar este PR.
4. Executar as migra√ß√µes (de tabelas e dados).
5. Remover a vari√°vel de ambiente `UNDER_MAINTENANCE`.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Al√©m disso, pode ser interessante criar uma nova migration para j√° fazer a c√≥pia dos dados no mesmo PR da cria√ß√£o da novas tabelas. Deixando para o processo manual, apenas as queries de valida√ß√µes se tudo deu certo. O que acha?
   >
   > Voc√™ est√° falando sobre as queries mencionadas em [#1656 (comment)](https://github.com/filipedeschamps/tabnews.com.br/pull/1656#issuecomment-2028481797), certo?
   > Falava dessas mesmo!
   > Posso fazer isso. Crio um arquivo de migration novo apenas para isso, neste mesmo PR?
   > Se der certo juntar tudo no mesmo PR, ent√£o poderia criar nesse aqui, mas eu falava sobre incluir no outro PR. S√≥ que, pelo ponto que voc√™ comentou a seguir, √© melhor deixar essa ideia de lado.
   > Outra pergunta, n√£o tenho certeza como as queries ir√£o se comportar se fizer tudo de uma vez ("sem `WHERE`"), principalmente considerando o tempo limite de execu√ß√£o da lambda. Faz sentido executar em blocos? Por exemplo, da `sequence = 1` em `balance_operations` at√© a `sequence = 100000`, e depois da `100001` at√© `200000` etc. (n√£o sei se o ideal √© de 100 mil em 100 mil).
   > Acho que n√£o adiantaria executar em blocos. N√£o tenho certeza, pois depende de como funciona por baixo a `node-pg-migrate`. J√° s√£o mais de 600 mil linhas em `balance_operations`, ent√£o deve ser melhor fazer a c√≥pia manualmente mesmo. Nesse ponto s√≥ falta criar algumas consultas para checar se a c√≥pia deu certo, n√©?
   >
   > > Tudo no mesmo PR n√£o √© poss√≠vel porque entramos em um paradoxo. O build resultar√° em erro, pois n√£o foram executadas as migrations, e as migrations n√£o poder√£o ser executadas, porque o erro no build impedir√° o deploy.
   >
   > N√£o entendi. Quando eu disse "tudo em um √∫nico PR" quis dizer para "esquecermos" o PR #1656 (que est√° quebrando os testes), n√£o sei se foi nesse ponto que me expressei mal. O ambiente de homologa√ß√£o est√° no ar, apenas sem funcionar algumas coisas (como o login) porque as migra√ß√µes n√£o foram executadas. Ent√£o o processo que imaginei era:
   >
   > 1. Mesclar os PRs [feat(error message text): add `createErrorMessage` function¬†#1663](https://github.com/filipedeschamps/tabnews.com.br/pull/1663) e [Permitir desabilitar rotas temporariamente pela vari√°vel de ambiente `UNDER_MAINTENANCE`¬†#1662](https://github.com/filipedeschamps/tabnews.com.br/pull/1662).
   > 2. Definir a vari√°vel de ambiente `UNDER_MAINTENANCE` para bloquear os endpoints `POST /api/v1/contents/*` e `GET /api/v1/user`.
   > 3. Mesclar este PR.
   > 4. Executar as migra√ß√µes (de tabelas e dados).
   > 5. Remover a vari√°vel de ambiente `UNDER_MAINTENANCE`.
   >    N√£o tinha reparado que esse √∫ltimo commit permitiu o deploy em homologa√ß√£o. Como os anteriores estavam dando erro no build, ent√£o n√£o daria pra fazer em um √∫nico PR.
   >    Dessa forma, e com o "modo leitura", parece que podemos sim pular o PR #1656 üëç
   >    Da√≠ n√£o faz a c√≥pia das tabelas pelas migrations, mas sim manualmente (ideia original), e depois fazemos as verifica√ß√µes.
   >    S√≥ ent√£o adequar a `UNDER_MAINTENANCE` (n√£o pode ser removida, pois valer√° a do `.env`), e fazer o redeploy.
   >    > Coment√°rio de Rafatcb (linha de c√≥digo):
   >    > ent√£o deve ser melhor fazer a c√≥pia manualmente mesmo
   >    > Ok.
   >    > Nesse ponto s√≥ falta criar algumas consultas para checar se a c√≥pia deu certo, n√©?
   >    > Tem algo em mente para isso? O que eu fazia enquanto testava manualmente (com bem menos registros) era comparar os `id`s "no olho" e somar as linhas de cada tabela para ver se dava a mesma quantidade do `balance_operations`.
   >    > Vou ver o que consigo elaborar para isso, e a√≠ crio um coment√°rio separado (neste PR) com as queries para copiar os registros e as queries para validar que deu certo.
   >    > S√≥ ent√£o adequar a UNDER_MAINTENANCE (n√£o pode ser removida, pois valer√° a do .env), e fazer o redeploy.
   >    > :+1:
   >    > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   >    > Acho que esse coment√°rio n√£o √© necess√°rio na outra migration, mas aqui tenho certeza que n√£o √© necess√°rio üòÖ
   >    > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  balance.balance_type = balance.balance_type ? `content:tabcoin:${balance.balance_type}` : balanceType;
```

Acho que assim √© mais f√°cil de entender o que est√° sendo feito, e elimina a necessidade de usar coalesc√™ncia nula ao chamar a `mapBalanceOut`.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o √© necess√°rio recriar a `findAll` a cada chamada de `findAllByOriginatorId`, certo?
> > A `findAll` pode ser definida fora do escopo de `findAllByOriginatorId` e receber `options` como segundo par√¢metro.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Essa linha `'content:tabcoin': data.amount > 0 ? 'credit' : 'debit',` me fez entender o que voc√™ tinha comentado sobre alterar o `orchestrator`.
> > Isso s√≥ era necess√°rio porque no #1624 eu acabei esquecendo de ajustar os testes que chamavam `orchestrator.createBalance` passando `balanceType: 'content:tabcoin'`.
> > Na vers√£o que eu sugeri agora, essa linha n√£o √© necess√°ria, e na vers√£o anterior, podia passar qualquer coisa, como neste exemplo:

```suggestion
      'content:tabcoin': 'qualquer_coisa_aqui_fazia_os_testes_passarem',
```

Pois os testes citados s√≥ est√£o usando o saldo total de TabCoins, ent√£o o valor de `balanceType` n√£o importa.
Vou corrigir isso em outro PR, pois s√£o coisas independentes.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o √© necess√°rio. Havia feito isso apenas seguindo a l√≥gica de que isso ocorre em outros lugares quando a fun√ß√£o √© usada apenas internamente (por exemplo, nos casos de `buildWhere`).
> > </pull_1661_Salvar opera√ß√µes de saldo em `balance_operations` e nas novas tabelas e reabilitar endpoints>

<pull_1662_Permitir desabilitar rotas temporariamente pela vari√°vel de ambiente `UNDER_MAINTENANCE`>

## Mudan√ßas realizadas

Permite criar respostas padr√£o (diretamente pelo middleware) para as requisi√ß√µes com m√©todos e rotas definidos na vari√°vel de ambiente `UNDER_MAINTENANCE`.
O exemplo abaixo envia a resposta padr√£o para requisi√ß√µes `POST` para o caminho exato `/api/v1/under-maintenance-test`:
`UNDER_MAINTENANCE={"methodsAndPaths":["POST /api/v1/under-maintenance-test$"]}`
A resposta padr√£o √©:

```js
{
  status: 503,
  body: {
    message: 'Funcionalidade em manuten√ß√£o.',
    action: 'Tente novamente mais tarde.',
    error_location_code: 'INFRA:UNDER_MAINTENANCE:CHECK:IS_UNDER_MAINTENANCE',
  }
}
```

`status`, `message` e `action` podem ser personalizados, caso o tipo de manuten√ß√£o exigir algo diferente. Por exemplo:
`UNDER_MAINTENANCE={"methodsAndPaths":["GET /api/v1/user$"],"message":"N√£o √© poss√≠vel obter os dados do usu√°rio no momento","action":"Tente novamente ap√≥s √†s 19hrs","statusCode":503}`
Os endoints afetados ser√£o os que retornarem `true` para `` new RegExp(methodAndPath).test(`${method} ${path}`) ``.

## Testes

A maioria dos testes criados s√£o de unidade, mas tamb√©m criei alguns testes de integra√ß√£o.
Adicionei a vari√°vel de ambiente no `.env` para poder rodar testes de integra√ß√£o, mas n√£o sei se essa √© a melhor alternativa.
Para o teste em homologa√ß√£o, deixei travado o m√©todo `POST` para qualquer rota iniciada por `/api/v1/contents`, ou seja, neste deploy n√£o √© poss√≠vel criar ou qualificar conte√∫dos, mas √© poss√≠vel editar o que foi criado anteriormente:
https://tabnews-git-feature-under-maintenance-tabnews.vercel.app

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (COMMENTED):
  > > Adicionei a vari√°vel de ambiente no `.env` para poder rodar testes de integra√ß√£o, mas n√£o sei se essa √© a melhor alternativa.
  > > Como n√≥s compartilhamos o `.env`, acho que faz sentido do jeito que ficou, tanto no teste de integra√ß√£o quanto no de unidade.

---

Agora, um pouco off-topic. Vendo o seu PR, fiquei com uma d√∫vida sobre meu commit (https://github.com/filipedeschamps/tabnews.com.br/commit/d97e82603302ab062f21eeecfdcab24f67316c33) no outro PR. Ele n√£o estava usando a Edge por causa do arquivo `pages/api/v1/_responses/maintenance.public.js`?

> > Review de aprendendofelipe (COMMENTED):
> > Review de Rafatcb (APPROVED):
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tem um problema na cria√ß√£o de conte√∫do, mostrando `undefined` no texto:
> > N√£o sei se voc√™ acha melhor j√° corrigir no frontend ou passar um `error_id` como uma string vazia (ou mesmo um identificador v√°lido, mas que n√£o ter√° utilidade pr√°tica).
> > O certo, claro, √© o frontend estar preparado para essa situa√ß√£o, principalmente em situa√ß√µes como `Informe ao suporte este valor: ${responseBody.error_id}`, mas √© poss√≠vel que tenha este problema em outros lugares al√©m deste, ent√£o teria que dar uma olhada nos outros lugares tamb√©m.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Nem sempre h√° um `error_id` nas respostas, ent√£o acho que a melhoria precisa ser no front para lidar corretamente com isso.
> > √â mais um caso que, pela "simplicidade", pode compensar mais criar diretamente um PR resolvendo, do que abrir uma issue que detalhe o problema.
> > </pull_1662_Permitir desabilitar rotas temporariamente pela vari√°vel de ambiente `UNDER_MAINTENANCE`>

<pull_1663_feat(error message text): add `createErrorMessage` function>

## Mudan√ßas realizadas

Conforme [conversa no PR #1662](https://github.com/filipedeschamps/tabnews.com.br/pull/1662#discussion_r1548758497), padroniza a cria√ß√£o do texto das mensagens de erro no _client_ de forma a lidar com os casos de aus√™ncia (ou omiss√£o proposital) do `error_id`.
[Edit] ~Tamb√©m adiciona a palavra "Erro" no in√≠cio das mensagens~ Desfiz isso, pois algumas mensagens n√£o ficaram boas come√ßando com "Erro".

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (DISMISSED):
  > > Parece ter cuidado de todos os casos :+1:
  > > Review de Rafatcb (APPROVED):
  > > </pull_1663_feat(error message text): add `createErrorMessage` function>

<pull_1668_Cria componente de pagina√ß√£o e teste de unidade no frontend>

## Mudan√ßas realizadas

1. Agora √© poss√≠vel realizar testes de unidade que envolvem componentes React com a biblioteca [`@testing-library/react`](https://github.com/testing-library/react-testing-library) ([documenta√ß√£o](https://testing-library.com/docs/react-testing-library/intro/)).
2. Refatorei a pagina√ß√£o para um componente separado, assim podemos utiliz√°-lo em outras telas futuramente, mantendo o mesmo comportamento.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Massa @Rafatcb! üí™üí™üí™
  > > `React Testing Library` √© uma excelente adi√ß√£o! üéâüéâüéâ
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > N√£o vamos executar a mesma bateria de testes do Primer, ent√£o √© melhor configurar apenas o necess√°rio para nossos testes.
  > > Sem o `setup.js` s√≥ d√° erro no `CSS.supports`, ent√£o isto parece suficiente:

```suggestion
// Mock only in jsdom environment.
if (typeof document !== 'undefined') {
  global.CSS = {
    supports: vi.fn().mockImplementation(() => {
      return false;
    }),
  };
}
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Talvez essa refatora√ß√£o tenha sido s√≥ um pretexto para adicionar os testes do front, mas que tal aproveitar para deixar a `Pagination` mais ou menos assim:

```suggestion
export default function Pagination({ previousPage, nextPage, basePath }) {
```

E pode ser usada assim:

```js
<Pagination {...pagination} basePath={paginationBasePath} />
```

Considerando que n√£o existe p√°gina 0, ent√£o a altera√ß√£o √© simples, pois n√£o h√° problema em verificar, por exemplo, `previousPage ?` no lugar de `pagination.previousPage ?`.
</pull_1668_Cria componente de pagina√ß√£o e teste de unidade no frontend>

<pull_1671_Corrige os valores de `balanceType` passados para `tests/orchestrator.createBalance()`>

## Mudan√ßas realizadas

Alguns testes que criavam entradas na tabela `balance_operators`, diretamente pelo `orchestrator`, usavam um valor incorreto para `balanceType`. Estava sendo utilizado o valor antigo `content:tabcoin`, mas os valores atuais s√£o `content:tabcoin:credit`, `content:tabcoin:debit` e `content:tabcoin:initial`.
Isso n√£o estava produzindo erros, pois as entradas eram inclu√≠das normalmente no saldo de TabCoins dos conte√∫dos, que √© computado somando todas as linhas relacionadas ao `id` do conte√∫do, independentemente do valor de `balanceType`, mas essa corre√ß√£o √© v√°lidas para deixar os testes com valores utilizados realmente no sistema, e evitar problemas futuros.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug nos testes

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1671_Corrige os valores de `balanceType` passados para `tests/orchestrator.createBalance()`>

<pull_1673_Remove a tabela `balance_operations`>

## Mudan√ßas realizadas

A migra√ß√£o de `balance_operations` para as tr√™s novas tabelas (`content_tabcoin_operations`, `user_tabcoin_operations` e `user_tabcash_operations`) foi conclu√≠da, vide https://github.com/filipedeschamps/tabnews.com.br/pull/1661#issuecomment-2046659596. Este PR remove a tabela `balance_operations`, que n√£o √© mais utilizada, e a fun√ß√£o `get_current_balance`, que acessava a tabela.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] Os testes antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1673_Remove a tabela `balance_operations`>

<pull_1676_Adiciona pagina√ß√£o ao endpoint GET /users>

## Mudan√ßas realizadas

Resolve a parte do backend do issue #1675.
Passei o `getPagination` para um outro arquivo para poder ser reutilizado e tamb√©m aproveitei para refatorar algumas coisas simples, como substituir `http://localhost:3000` por `orchestrator.webserverUrl` em alguns testes.

- Pagina√ß√£o em `GET /api/v1/users` com `per_page` e `page`, ordenado pela data de atualiza√ß√£o (`updated_at`, mais recentes primeiro).

## Tipo de mudan√ßa

- [x] Nova funcionalidade.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Show @Rafatcb! üí™
  > > Pensando em simplificar a implementa√ß√£o/manuten√ß√£o, estou em d√∫vida se precisamos de todas essas diferentes estrat√©gias. A que voc√™ chamou de `recently_updated` j√° n√£o seria suficiente para a necessidade da modera√ß√£o?
  > > Fiz coment√°rios no c√≥digo.
  > > Review de Rafatcb (COMMENTED):
  > > Pensando em simplificar a implementa√ß√£o/manuten√ß√£o, estou em d√∫vida se precisamos de todas essas diferentes estrat√©gias. A que voc√™ chamou de `recently_updated` j√° n√£o seria suficiente para a necessidade da modera√ß√£o?
  > > Seria sim. Pensei nas outras apenas para ficar num padr√£o parecido com o `/contents`, que possui as estrat√©gias `old` e `new`, por exemplo, mas posso deixar apenas com uma ordena√ß√£o.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (DISMISSED):
  > > J√° aprovei, mas vejam, por favor, se faz sentido mexer nos pontos que comentei no c√≥digo ü§ù
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > A `getPagination` recebendo `findAll` est√° um pouco estranho.
  > > Que tal j√° passar o `total_rows`? D√° pra ver onde realmente precisa da `findAll` e usar ela antes de chamar a `getPagination({ ...values, total_rows })`.

```suggestion
async function getPagination({ total_rows, page, per_page, strategy }) {
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > E se apenas substituir a `findAll` pela nova `findWithStrategy` j√° apropriada para `/api/v1/users`?
> > A tentativa de deixar a `findAll` flex√≠vel acaba tornando ela mais complexa do que o necess√°rio, e dificultando seu entendimento, como acontece em `content.findAll()`. Em `models/content` isso at√© se justifica, mas aqui n√£o estou vendo necessidade.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Precisa mesmo de `firstUser` e `secondUser`? Deve ser suficiente criar aqui apenas as vari√°veis `privilegedUser` e `defaultUser`, j√° que s√£o duplicadas com as outras duas.
> > `unprivilegedUser` me parece menos adequada do que `defaultUser`, que j√° √© o padr√£o adotado em todos os testes.
> > E deve compensar tamb√©m declarar aqui a `privilegedUserSession`, que pode ser atribu√≠da em `beforeAll()`. O que acha?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        const numberOfUsers = 60;
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Voc√™ diz para retornar a contagem de usu√°rios, os resultados de forma ordenada e com pagina√ß√£o sempre? Se for isso, o `findAll` √© utilizado no PR #1638, ent√£o teria alguns pontos negativos pela contagem n√£o ser necess√°ria naquela situa√ß√£o e pela pagina√ß√£o poder, eventualmente, causar um bug dif√≠cil de identificar (se futuramente termos um evento que envolva mais contas do que o tamanho padr√£o da pagina√ß√£o).
> > Hoje o `findAll` est√° ordenado por `created_at ASC`, o que j√° prejudicaria o desempenho no outro PR, mas n√£o precisaria dessa ordena√ß√£o por padr√£o.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Precisa mesmo de firstUser e secondUser?
> > N√£o √© necess√°rio, mas facilita o entendimento dos testes nas compara√ß√µes `expect(responseBody).toStrictEqual`, onde pelo nome da vari√°vel o leitor consegue saber que um foi criado antes do outro.
> > unprivilegedUser me parece menos adequada do que defaultUser, que j√° √© o padr√£o adotado em todos os testes.
> > Ok.
> > E deve compensar tamb√©m declarar aqui a privilegedUserSession, que pode ser atribu√≠da em beforeAll(). O que acha?
> > Isso pode ser feito sim :+1:
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu deixei as fun√ß√µes `findAll` e `findAllWithPagination` separadas para deix√°-las menos flex√≠veis. Se voc√™ ter uma sugest√£o melhor de usar uma √∫nica fun√ß√£o tendo em vista os pontos que levantei no meu coment√°rio anterior, diga que eu modifico.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Apenas uma sugest√£o para que a `pagination.getPagination()` n√£o precise receber par√¢metros em diferentes padr√µes (camelCase e snake_case) ao mesmo tempo:

```suggestion
  values.total_rows = values.totalRows ?? (await findAll(values, options))[0]?.total_rows ?? 0;
```

E escrever esse coment√°rio me fez pensar se n√£o seria suficiente a fun√ß√£o se chamar `get`, o que faria o seu uso ser `pagination.get()`

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Em qual situa√ß√£o a `countTotalRows()` √© necess√°ria?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Quando a consulta n√£o retorna resultados. Um exemplo √© no teste `With a "page" out of bounds`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acredito que as duas sugest√µes fa√ßam sentido sim, o c√≥digo fica mais consistente.
> > </pull_1676_Adiciona pagina√ß√£o ao endpoint GET /users>

<pull_1678_Corrige o c√≥digo de status da resposta da API para o m√©todo `OPTIONS` de `404` para `200`>

## Mudan√ßas realizadas

Al√©m de corrigir o c√≥digo de status da resposta para o m√©todo HTTP OPTIONS de `404` para `200`, o que resolve #1125, foi criado o erro espec√≠fico `MethodNotAllowedError` que retorna `405` ao inv√©s do `404` que era retornado nesses casos.
Tamb√©m rodei um `npm audit fix` para remover vulnerabilidades conhecidas.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Show! N√£o tinha percebido que o `OPTIONS` n√£o estava funcionando corretamente.
  > > </pull_1678_Corrige o c√≥digo de status da resposta da API para o m√©todo `OPTIONS` de `404` para `200`>

<pull_1680_Diminui a quantidade de campos enviados para o Axiom para ficarmos dentro do limite de 256 diferentes campos>

## Mudan√ßas realizadas

Remove campos desnecess√°rios dos dados enviados para o Axiom, pois atingimos o limite de 256 diferentes campos, e isso impede a grava√ß√£o de qualquer novo registro que contenha campos diferentes dos 256 j√° existentes.
Removi os 2 campos que notei que estavam impedindo a grava√ß√£o de alguns registros:

- `headers["x-vercel-ip-continent"]`
- `headers["x-vercel-ip-as-number"]`
  E como j√° estamos no limite, mudei a configura√ß√£o para remover os campos sens√≠veis ao inv√©s de apenas deixar eles como `redacted`.
  Isso vai abrir a possibilidade de novos campos serem inseridos daqui a 30 dias, quando n√£o houverem mais logs antigos com campos `redacted`.
  Essa √© uma solu√ß√£o emergencial por estarmos perdendo parte dos nossos logs, j√° que o Axiom passou a ignorar completamente os envios com campos extras, ao inv√©s de salvar apenas os campos j√° existentes.
  Ap√≥s essa solu√ß√£o emergencial, sugiro fazermos uma revis√£o dos campos que est√£o sendo armazenados, j√° que mais da metade s√£o `headers` das requisi√ß√µes, e alguns podem trazer informa√ß√µes redundantes ou desnecess√°rias.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
      </pull_1680_Diminui a quantidade de campos enviados para o Axiom para ficarmos dentro do limite de 256 diferentes campos>

<pull_1682_Altera `onClick` para `onSelect` para itens de menu serem acess√≠veis via teclado>

## Mudan√ßas realizadas

Resolve #1681

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de Rafatcb (APPROVED):
  > > </pull_1682_Altera `onClick` para `onSelect` para itens de menu serem acess√≠veis via teclado>

<pull_1685_Refatora `validator` e corrige valida√ß√£o de `null` caso o campo seja obrigat√≥rio>

## Mudan√ßas realizadas

Fiz algumas refatora√ß√µes no `validator` e separei cada etapa da refatora√ß√£o em um commit, assim fica mais f√°cil entender o motivo de cada uma delas, revisar individualmente e desfazer, se necess√°rio.

- [`b01421f`](https://github.com/filipedeschamps/tabnews.com.br/commit/b01421f1edd26507541582af7171e69fed844968): Permite `null` apenas se o campo n√£o for obrigat√≥rio. Notei isso ao usar a valida√ß√£o de `title` em outra tarefa, onde o `validator` considerava v√°lido um `title` obrigat√≥rio receber `null` (basta ver o teste que precisei atualizar em `contents/post.test.js`). Hoje isso n√£o √© um problema porque o √∫nico caso que poderia seria percebido √© no `title`, onde a condi√ß√£o √© tratada no model.
- [`e2bde04`](https://github.com/filipedeschamps/tabnews.com.br/commit/e2bde044ccf1b1607f3aab97775a24788eb68a72): Uso de templates nas mensagens de erro: `{#label}` para permitir o reuso de uma valida√ß√£o em uma propriedade de nome diferente, mantendo uma mensagem de erro consistente; `{#limit}` e `{#value}` para garantir que o valor correto √© exibido nas mensagens de erro.
  Nesse ponto tamb√©m corrigi as mensagens de `number.unsafe` conforme a valida√ß√£o do Joi ([veja aqui](https://github.com/hapijs/joi/blob/5b96852fe07a742a8733f2bff1303d50853ca65c/lib/types/number.js#L104-L108)), que verifica tanto o limite negativo quanto positivo. Como n√£o √© poss√≠vel acessar os valores das valida√ß√µes de `min` e `max` pelo template do Joi, usei vari√°veis em JavaScript mesmo.
- [`0376e24`](https://github.com/filipedeschamps/tabnews.com.br/commit/0376e24d98601cd8646c472eee6e3dd3afc94278): Criei um objeto com as mensagens de erro padr√£o, assim n√£o √© necess√°rio tanto Ctrl+C e Ctrl+V, ou pequenas varia√ß√µes em mensagens de erro.
- [`f89fc7d`](https://github.com/filipedeschamps/tabnews.com.br/commit/f89fc7de572ca52d132a685731004b62c2f82fe8): Remove valida√ß√µes desnecess√°rias: `.invalid(null)` onde j√° h√° outra valida√ß√£o que garante isso (como `.string()` ou `.boolean()`); `.allow(false)` que j√° √© permitido por `.boolean()`.
  Tamb√©m tentei deixar o nome da propriedade din√¢mico em `when('$required.<NOME>, ...` mas n√£o consegui descobrir se √© poss√≠vel pelo Joi.
  Quem quiser entender melhor sobre a sintaxe de template do Joi: [documenta√ß√£o](https://joi.dev/api/?v=17.13.0#template-syntax). Como complemento para saber os argumentos dispon√≠veis, vi o [c√≥digo fonte](https://github.com/hapijs/joi/tree/5b96852fe07a742a8733f2bff1303d50853ca65c/lib/types).

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (DISMISSED):
  > > Massa @Rafatcb! üí™
  > > Tinha uma mudan√ßa que eu queria fazer no `validator`, que era usar um cache dos esquemas, j√° que o processo de montar o esquema √© um pouco custoso e era sempre repetido para cada valida√ß√£o. Ent√£o aproveitei o seu PR que era bastante relacionado. Se acharem que o que eu adicionei n√£o faz sentido, ou que √© melhor criar outro PR, √© s√≥ avisar que eu removo os dois √∫ltimos commits.
  > > Agora cada inst√¢ncia lambda que subir s√≥ precisar√° criar cada esquema uma √∫nica vez, na primeira vez que ele for necess√°rio. E nas pr√≥ximas valida√ß√µes ser√° utilizado o esquema em cache. Tamb√©m passei todas as mensagens de erro poss√≠veis para o `defaultSchema`.
  > > Isso j√° deu uma boa diferen√ßa no tempo de execu√ß√£o da bateria de testes, ent√£o deve representar um ganho nos tempos de respostas de algumas requisi√ß√µes. Vou tentar medir esse impacto. ü§ù
  > > O fbcde4ea357c113ff00cdc879633561d60197100 faz o mencionado acima, al√©m de corrigir a configura√ß√£o `escapeHtml`, j√° o 7bceba067fc1033031bfe2f0ebcd4b74f4cffde3 padroniza as mensagens para os erros `any.only` usando `#valids`. Isso muda algumas mensagens de erro j√° que n√£o ser√° adicionado `e` entre os dois √∫ltimos itens (todos s√£o separados por `,`), mas acredito que isso n√£o prejudica o entendimento das mensagens, e que o ganho na manuten√ß√£o do validador compense. Concordam?
  > > Review de Rafatcb (COMMENTED):
  > > Gostei das altera√ß√µes propostas. N√£o vejo problemas em manter no mesmo PR.
  > > </pull_1685_Refatora `validator` e corrige valida√ß√£o de `null` caso o campo seja obrigat√≥rio>

<pull_1689_Refatora√ß√£o dos testes para diminuir boilerplate (cria√ß√£o, ativa√ß√£o e features de usu√°rio, e fetch)>

## Mudan√ßas realizadas

Estava desenvolvendo uma outra funcionalidade do TabNews e nos testes me deparei com uma repeti√ß√£o que j√° havia me incomodado em #1638, onde criei fun√ß√µes como `createContentViaApi`, `reviewFirewallViaApi` etc., e nos novos testes eu estava fazendo as mesmas coisas.
Experimentei, ent√£o, criar uma abstra√ß√£o inspirada na proposta do PR #1409. O objetivo √©:

1. Facilitar a escrita dos testes, diminuindo a repeti√ß√£o da cria√ß√£o do usu√°rio, ativa√ß√£o, obten√ß√£o do token, inser√ß√£o ou remo√ß√£o de `feature`, e por fim o `fetch` (que √© verboso por natureza).
2. Deixar claro o que est√° sendo feito, para continuar claro como o teste funciona ao l√™-lo.
   Isso deve facilitar tanto para os mantenedores desenvolverem os testes como para novos contribuidores.
   Optei por iniciar modificando os testes de `/contents`, pois envolvem diferentes cen√°rios (com token, sem token, com usu√°rio autorizado, sem usu√°rio, sem `feature`, com header diferente etc.).
   Quero saber a opini√£o de outras pessoas, se assim est√° melhor ou se eu abstra√≠ demais.
   Se a altera√ß√£o for aprovada como est√°, podemos realizar o merge modificando apenas os testes do `/contents` e passar a usar o `RequestBuilder` nos novos testes e refatorar os outros depois, conforme mexermos nos arquivos.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o de testes.
  > > Review de aprendendofelipe (COMMENTED):
  > > Massa @Rafatcb! üí™üí™üí™
  > > Deixei alguns coment√°rios no c√≥digo para verem se faz sentido. üëç
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

Pode aproveitar para remover essa depend√™ncia. S√≥ precisa adequar o teste `With CORS and Security Headers enabled`:

```js
const responseHeaders = {};
response.headers.forEach((value, key) => {
  responseHeaders[key] = [value];
});
```

e aqui nesse arquivo

```js
    if (response.headers['Content-Type'] === 'application/x-ndjson') {
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que √© bom verificar se `response.ok === true` antes de chamar `response.json()`, ou tratar o erro.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Talvez n√£o seja interessante adicionar automaticamente o `/api/v1`.
> > Um exemplo de problema √© quando disponibilizarmos uma `v2`, pois precisaremos continuar testando a `v1`.
> > E n√£o poderemos usar o `RequestBuilder` com alguns endpoints, por exemplo o `/rss`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > J√° modifiquei isso e criei os testes do RSS para testar a mudan√ßa.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Precisei mudar tamb√©m a forma da leitura do stream. N√£o sei se daria para ser mais simples. O `get('Content-Type')` continuou funcionando, n√£o sei se seu segundo trecho de c√≥digo era sugerindo mud√°-lo ou se era referente √† parte da leitura do stream, como mencionei.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tenho feito as implementa√ß√µes do `RequestBuilder` conforme descubro uma nova necessidade em algum teste. Por exemplo, com os testes de RSS vi que era necess√°rio tratar respostas `text/xml`.
> > Existe algum teste que o erro que voc√™ mencionou ocorre, para eu conseguir testar? Simulei um `throw`, mas nossa aplica√ß√£o retorna um objeto quando um erro √© lan√ßado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que o √∫nico caso em que n√£o retornamos um corpo na resposta √© com o m√©todo `OPTIONS`, mas o `RequestBuilder` ainda n√£o serve para testar esse m√©todo, e nem deve valer a pena modificar ele para usar neste √∫nico teste:
> > https://github.com/filipedeschamps/tabnews.com.br/blob/36ddabc399431f43db289c723e3273d5591725be/tests/integration/api/v1/contents/options.test.js#L9-L12
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O `response.json()` j√° lida com o stream, ent√£o esse condicional n√£o me parece necess√°rio.
> > S√≥ se fosse para alguma otimiza√ß√£o, o que n√£o √© o caso. Ou estou deixando escapar algo?

```suggestion
    const responseBody = await response.json();
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tem raz√£o. Simplifiquei e j√° fiz o `rebase`.
> > </pull_1689_Refatora√ß√£o dos testes para diminuir boilerplate (cria√ß√£o, ativa√ß√£o e features de usu√°rio, e fetch)>

<pull_1691_Melhorando experi√™ncia do usu√°rio nos formul√°rios>

## Mudan√ßas realizadas

<!-- Por favor, inclua uma descri√ß√£o sobre o que foi modificado nesse PR. Inclua tamb√©m qualquer motiva√ß√£o ou contexto relevante.  -->

Essa PR conta com algumas modifica√ß√µes na interface para melhorar o entendimento do usu√°rio nos formul√°rios de `cadastro` e de `perfil`.
Para evitar o excesso de componentes que tirariam o foco do usu√°rio, o @Rafatcb sugeriu a utiliza√ß√£o de um componente que j√° est√° presente no `primer/react`, sendo ele o Caption (mais especificamente o FormControl.Caption).

### Altera√ß√µes

`/cadastro`
Antes
Depois
`/perfil`
Antes
Depois

### Observa√ß√£o

Decidi manter o "e coment√°rios" na confirma√ß√£o e na caption da p√°gina de perfil, pois como um usu√°rio eu n√£o estava conseguindo visualizar os coment√°rios lendo apenas "conte√∫dos". Mas, claro, essa √© minha vis√£o de usu√°rio e gostaria que discut√≠ssemos sobre caso haja alguma opini√£o diferente.
Resolve #1529

## Tipo de mudan√ßa

- [x] Refactor

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.

  > > Review de aprendendofelipe (COMMENTED):
  > > Show @lwfe, obrigado pelo PR! üí™üí™üí™
  > > Por favor, analisem os coment√°rios que fiz no c√≥digo ü§ù
  > > Review de lwfe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > @lwfe obrigado pela contribui√ß√£o!
  > > Deixei umas sugest√µes para as legendas.
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de lwfe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de lwfe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Modifiquei o campo de "Nome de usu√°rio" em `/perfil` para mostrar a mensagem "Alterar o nome de usu√°rio ir√° quebrar todas as URLs das suas publica√ß√µes e coment√°rios." somente se o nome de usu√°rio digitado √© diferente do usu√°rio atual.
  > > Se o usu√°rio digitar qualquer coisa, o `username` j√° ser√° diferente da original, ent√£o n√£o tem necessidade dessa verifica√ß√£o de igualdade. Fiz novas sugest√µes no c√≥digo para deixar conforme sugerido antes, ou seja, se digitar qualquer coisa, j√° aparece o Caption e ele n√£o some mais.
  > > E tamb√©m adicionei as mensagens de erro customizadas, para que n√£o haja a necessidade ser utilizada um Caption e um Validation, a mensagem comprimida "Nome de usu√°rio deve conter apenas letras e n√∫meros. (ex: nomeSobrenome4)" est√° somente em um Validation.
  > > Show, s√≥ precisa ajustar um pouco a mensagem, pois o ponto (`.`) precisa estar ap√≥s os par√™nteses, e a abrevia√ß√£o da palavra "exemplo" tamb√©m exige um ponto (`ex.:`), ent√£o ficaria algo assim:

- `Nome de usu√°rio deve conter apenas letras e n√∫meros (ex.: nomeSobrenome4).`
  Mas tamb√©m pode deixar mais parecido com a dica original:

- `Nome de usu√°rio deve conter apenas letras e n√∫meros, por exemplo: "nomeSobrenome4"`
  > > Review de lwfe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Review de Rafatcb (APPROVED):
  > > Parab√©ns por essa primeira contribui√ß√£o, @lwfe! Pode fazer um squash dos commits antes do merge? Se n√£o sabe como o squash funciona, pode ler [essa resposta](https://stackoverflow.com/a/5201642/88390590) do Stack Overflow.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
          {errorObject?.key !== 'username' && (
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que essa frase n√£o ficou legal.
> > N√£o consegui pensar em nada muito melhor agora, mas gostaria de aguardar para ver se surgem outras sugest√µes ü§ù
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o precisa modificar aqui, pois isso j√° foi resolvido no PR #1617 ap√≥s o debate em #895.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Coment√°rios tamb√©m s√£o conte√∫dos no TabNews, ent√£o devemos escolher entre usar apenas "conte√∫dos", ou "publica√ß√µes e coment√°rios".
> > Me parece que ficou muito chamativo. Ser√° que n√£o √© melhor mostrar o aviso apenas se o usu√°rio clicar no campo, ou se iniciar a digita√ß√£o dentro dele?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Esse `Box` n√£o deve ser mais necess√°rio
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Para adequar ao que temos na documenta√ß√£o:

```suggestion
            <Checkbox checked={isTermsAccepted} onChange={() => setIsTermsAccepted(!isTermsAccepted)} />
```

> > Coment√°rio de lwfe (linha de c√≥digo):
> > Show, ent√£o ficaremos no aguardo de mais sugest√µes.
> > Coment√°rio de Rafatcb (linha de c√≥digo):

1. Este nome ser√° exibido publicamente.
2. Este ser√° o seu identificador p√∫blico.
3. Este nome ser√° vis√≠vel para outras pessoas.
   Gostaram de algum da lista?
   Outra pergunta, tem algum motivo para esconder essa mensagem quando existe um erro? No [exemplo do Primer](https://primer.style/components/text-input#anatomy), parece que os dois podem ficar vis√≠veis simultaneamente:
   > O texto da legenda pode ser exibido ao mesmo tempo que uma mensagem de valida√ß√£o ou pode ficar oculto se fornecer apenas informa√ß√µes redundantes.
   > N√£o precisamos seguir as mesmas regras que o GitHub ao usar o Primer, mas considerando que eles tem uma equipe que pensou nesses detalhes, acho melhor seguirmos as orienta√ß√µes caso n√£o tenhamos um motivo contra.
   >
   > > Coment√°rio de Rafatcb (linha de c√≥digo):
   > > Voc√™s acham que faz sentido exibir essa mensagem? Eu achei que o di√°logo de confirma√ß√£o ficou uma "duplica√ß√£o" dessa mensagem, e ao mesmo tempo que ficou uma "duplica√ß√£o", essa mensagem n√£o √© um substituto a ponto de removermos a confirma√ß√£o.
   > > O efeito ben√©fico que vejo em ter essa mensagem √© que a pessoa n√£o perderia o tempo pensando num novo nome de usu√°rio para depois descobrir, ao clicar em "Salvar", que isso quebrar√° os links, mas n√£o sei se √© relevante o suficiente para mantermos a mensagem.
   > > E, se for para exibir a mensagem, eu n√£o esconderia no `blur` caso o nome de usu√°rio preenchido seja diferente do nome de usu√°rio atual.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   >
   > 1. Este nome ser√° exibido publicamente.
   > 2. Este ser√° o seu identificador p√∫blico.
   > 3. Este nome ser√° vis√≠vel para outras pessoas.
   >    √ìtimas sugest√µes! üëç
   >    ...tem algum motivo para esconder essa mensagem quando existe um erro? No [exemplo do Primer](https://primer.style/components/text-input#anatomy), parece que os dois podem ficar vis√≠veis simultaneamente
   >    N√£o √© para qualquer erro, mas apenas quando for exibida a dica que j√° usa o Caption:
   >    O melhor seria personalizar a mensagem de erro para n√£o precisar da dica, e n√£o usar o retornado pelo backend, pois √© uma mensagem apropriada para a API.
   >    > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   >    > Eu acho interessante mostrar a mensagem justamente pelo ponto ben√©fico que o @Rafatcb citou.
   >    > ...que a pessoa n√£o perderia o tempo pensando num novo nome de usu√°rio para depois descobrir, ao clicar em "Salvar", que isso quebrar√° os links
   >    > J√° a mensagem de confirma√ß√£o poderia ser pulada caso a mudan√ßa n√£o quebre os links, ent√£o pode mudar a `confirmChangeUsername` para:

```js
      const confirmChangeUsername =
        user.username.toLowerCase() === username.toLowerCase() ||
        (await confirm({...}));
```

---

> E, se for para exibir a mensagem, eu n√£o esconderia no `blur` caso o nome de usu√°rio preenchido seja diferente do nome de usu√°rio atual.
> Concordo sobre n√£o esconder no `blur`. Como n√£o √© uma mensagem de valida√ß√£o, na verdade s√≥ precisa esconder se for mostrar a "dica". Se remover a "dica", eu n√£o voltaria a ocultar a mensagem ap√≥s ela ter sido exibida.
>
> > Coment√°rio de lwfe (linha de c√≥digo):
>
> 1. Este nome ser√° exibido publicamente.
> 2. Este ser√° o seu identificador p√∫blico.
> 3. Este nome ser√° vis√≠vel para outras pessoas.
>    √ìtimas sugest√µes, particularmente eu gostei mais da primeira e acho que irei utilizar ela.
>    O melhor seria personalizar a mensagem de erro para n√£o precisar da dica, e n√£o usar o retornado pelo backend, pois √© uma mensagem apropriada para a API.
>    Para nossa vis√£o de dev, fica subentendido que alfanum√©rico j√° se trata de apenas letras e n√∫meros, e realmente, √© indispens√°vel que essa informa√ß√£o esteja na API (visto que a API ser√° utilizada por devs).
>    Mas para o usu√°rio final, √© incomum o uso desse termo e para evitar o uso desses "termos t√©cnicos" (que na verdade n√£o √© t√£o t√©cnico assim), acabei pensando na sugest√£o abaixo, de√™m uma olhada e me digam o que acham:
>    'username' deve conter apenas letras e n√∫meros (ex: nomeSobrenome4).
>    > Coment√°rio de aprendendofelipe (linha de c√≥digo):
>    > `username` √© que √© o ponto mais espec√≠fico da API. Aqui fica melhor dizer algo como "Nome de usu√°rio deve conter apenas..."
>    > Coment√°rio de lwfe (linha de c√≥digo):
>    > Ok!
>    > Essa altera√ß√£o vai para a tela de perfil tamb√©m, correto?
>    > Coment√°rio de aprendendofelipe (linha de c√≥digo):
>    > Isso, s√£o essas duas telas que podem apresentar esse erro. üëç
>    > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion

```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
            onChange={() => setShowUsernameCaption(true)}
```

> > Coment√°rio de lwfe (linha de c√≥digo):
> > Entendi!
> > Mas a minha preocupa√ß√£o com essa verifica√ß√£o foi para o caso de o usu√°rio digitar qualquer coisa, e voltar ao nome de usu√°rio que j√° estava. Pensei que mostrar a caption dizendo que ir√° quebrar os links e publica√ß√µes mesmo com o nome digitado estando igual ao nome do usu√°rio atual seria um erro üòÖ
> > Quanto √† mensagem, irei coloc√°-la mais parecida com a original.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Para a mensagem ficar mais correta:

```suggestion
              Alterar o nome de usu√°rio pode quebrar todas as URLs das suas publica√ß√µes e coment√°rios.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acredito que o correto aqui seja "esse" no lugar de "este", j√° que o campo citado est√° acima da frase

```suggestion
          <FormControl.Caption>Esse nome ser√° exibido publicamente.</FormControl.Caption>
```

</pull_1691_Melhorando experi√™ncia do usu√°rio nos formul√°rios>

<pull_1696_Diminui a quantidade de campos e o tamanho total dos logs enviados para o Axiom>

## Mudan√ßas realizadas

Continuando o ajuste nos logs realizado em #1680, agora os dados que n√£o est√£o totalmente no nosso controle, como os presentes nos cabe√ßalhos e no corpo das requisi√ß√µes, n√£o ir√£o mais ser salvos em campos individuais no Axiom.
Para conseguir isso, agora os headers e body s√£o enviados para o Axiom dentro de um array. Pensando somente na limita√ß√£o de campos, tamb√©m funcionaria enviar os objetos como strings, mas isso adicionaria muitos caracteres de escape (mais de 500 s√≥ nos headers), o que aumentaria as perdas de registros por ultrapassar o [limite de 4KB dos logs da Vercel](https://vercel.com/docs/observability/runtime-logs#limits), algo que j√° ocorre eventualmente.
Ainda pensando no limite de 4KB, agora s√£o registrados menos dados dos usu√°rios e dos conte√∫dos, j√° que podemos buscar diretamente no PostgreSQL os dados completos. Dados redundantes tamb√©m foram removidos, pois a Vercel j√° insere o m√©todo e a URL das requisi√ß√µes em todos os logs.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de github-advanced-security[bot] (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Hard-coded credentials

The hard-coded value "sensitive" is used as [authorization header](1).
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/40)

> > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Hard-coded credentials

The hard-coded value "sensitive" is used as [authorization header](1).
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/41)
</pull_1696_Diminui a quantidade de campos e o tamanho total dos logs enviados para o Axiom>

<pull_1704_Corrige os testes de limite de tamanho do `slug`>

## Mudan√ßas realizadas

Corrige os dois testes que deveriam verificar se o `slug` era corretamente truncado para o limite de 226 bytes, mas que n√£o estavam verificando nada, j√° que o input j√° possu√≠a exatamente o limite de 226 bytes. Agora os inputs dos testes possuem 227 bytes e podemos verificar que o `slug` √© corretamente criado com os primeiros 226 bytes.
A funcionalidade j√° estava correta, e inclusive estava sendo garantida por testes com t√≠tulos longos, mas esses dois testes espec√≠ficos n√£o garantiam nada.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de testes
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Para diminuir as chances desse problema ocorrer novamente, acha que faz sentido usar algo como `'this-slug-must-be-changed-from-227-to-226-bytes'.padEnd(227, 's')` (e `226` no `expect`)?
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > √ìtima ideia! Vou alterar!
  > > </pull_1704_Corrige os testes de limite de tamanho do `slug`>

<pull_1705_Refatora√ß√£o da valida√ß√£o da presen√ßa do t√≠tulo nos conte√∫dos>

## Mudan√ßas realizadas

Na cria√ß√£o de conte√∫dos, dependendo da presen√ßa ou n√£o de `parent_id`, a verifica√ß√£o da presen√ßa do t√≠tulo ocorria no `models/validator` ou no `models/contents`, e isso era decidido em:
https://github.com/filipedeschamps/tabnews.com.br/blob/884181d5f5f2cb3e18e13770002f2b6d0912da67/pages/api/v1/contents/index.public.js#L88-L88
J√° no `patch` dos conte√∫dos, a verifica√ß√£o sempre ocorria em `models/contents`, ent√£o a mudan√ßa proposta √© para a valida√ß√£o ocorrer sempre em `models/contents`, o que padroniza a mensagem de erro e o `error_location_code`:

- `"title" √© um campo obrigat√≥rio.`
- `MODEL:CONTENT:CHECK_ROOT_CONTENT_TITLE:MISSING_TITLE`

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1705_Refatora√ß√£o da valida√ß√£o da presen√ßa do t√≠tulo nos conte√∫dos>

<pull_1706_Corrige typo em `content` (`contend`)>

## Mudan√ßas realizadas

Corrige o erro de digita√ß√£o na palavra `content` escrita como `contend`.
O problema foi notado no PR #1692, e sugeri l√° a cria√ß√£o de um PR corrigindo, mas como estou fazendo corre√ß√µes parecidas no curso.dev, ent√£o j√° abri aqui.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1706_Corrige typo em `content` (`contend`)>

<pull_1707_Remove `async` desnecess√°rio de `pagination.get`>

## Mudan√ßas realizadas

Remove marca√ß√£o `async` desnecess√°ria, j√° que a fun√ß√£o √© s√≠ncrona, conforme mencionado [nesse coment√°rio](https://github.com/filipedeschamps/tabnews.com.br/pull/1698#discussion_r1610839266).

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug / refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de kaique-soares (APPROVED):
  > > Review de aprendendofelipe (DISMISSED):
  > > Boa @Rafatcb! üí™
  > > Sugeri aproveitarmos para fazer outro ajuste na pagina√ß√£o.
  > > Por favor, vejam se faz sentido pra voc√™s ü§ù
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Que tal aproveitarmos para corrigir `lastPage`?
  > > Hoje retorna `0` quando n√£o h√° resultados, mas acredito que deveria retornar `1`:

```suggestion
  const lastPage = Math.ceil(total_rows / per_page) || 1;
```

</pull_1707_Remove `async` desnecess√°rio de `pagination.get`>

<pull_1708_Usar `RequestBuilder` em mais testes de conte√∫dos>

## Mudan√ßas realizadas

Estava modificando esses arquivos em outra branch e resolvi separar para facilitar a revis√£o dessa refatora√ß√£o, que √© uma continua√ß√£o do que foi iniciado no PR #1689.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > @Rafatcb, obrigado por mais esse PR! üí™
  > > Eu acho interessante o `RequestBuilder`, mas apenas para uso onde ele for realmente necess√°rio.
  > > Nesse PR, parece que apenas no arquivo abaixo ele ajuda a deixar o c√≥digo mais leg√≠vel (mas n√£o necessariamente entend√≠vel):
  > > [tests/integration/api/v1/contents/[username]/[slug]/tabcoins/post.test.js](https://github.com/filipedeschamps/tabnews.com.br/pull/1708/files#diff-1600547ab104ac4c6c6077e89de7387c7df4fdc290ee156994291b873cc1c50b)
  > > Nos demais arquivos, n√£o vejo como uma melhoria a troca de algo trivial como isto:

```js
const response = await fetch(`${orchestrator.webserverUrl}/api/v1/...);
const responseBody = await response.json();
```

pela abstra√ß√£o:

```js
const contentsRootRequestBuilder = new RequestBuilder(`/api/v1/...`);
const { response, responseBody } = await contentsRootRequestBuilder.get();
```

O que acham?

> > Review de Rafatcb (COMMENTED):
> > Eu acho interessante o RequestBuilder, mas apenas para uso onde ele for realmente necess√°rio.
> > Tamb√©m pensei se era interessante a troca nos locais onde um simples `fetch` era utilizado, sem autentica√ß√£o e sem especificar o m√©todo. Cogitei a troca pelo motivo de padroniza√ß√£o e tamb√©m pela facilita√ß√£o na troca do `fetch`, por exemplo, onde hoje h√° `cross-fetch` em v√°rios lugares e √© poss√≠vel trocar por `fetch`.
> > Al√©m disso, o `RequestBuilder` abstrai qual √© o endere√ßo exato da requisi√ß√£o para que o teste defina apenas o endpoint que est√° sendo testado, que √© a parte relevante (ou seja, sem precisar definir a URL como sendo `orchestrator.webserverURL`, e percebi que esqueci de remover isso no teste de Thumbnail). E tamb√©m, caso o endpoint n√£o tenha um recurso din√¢mico e nem precise de autoriza√ß√£o, √© poss√≠vel declar√°-lo uma √∫nica vez no arquivo de teste (instanciando o `RequestBuilder` uma √∫nica vez). Um exemplo disso √© o arquivo `tests/integration/api/v1/contents/get.test.js`.
> > Esses s√£o os benef√≠cios que eu enxergo, mas se acharem melhor deixar com `fetch`, n√£o vejo problema em n√£o usar o `RequestBuilder` onde a mudan√ßa √© pouca (geralmente, os `GET`s sem autentica√ß√£o).
> > Review de aprendendofelipe (COMMENTED):
> > Eu acho interessante o `RequestBuilder`, mas apenas para uso onde ele for realmente necess√°rio.
>
> Tamb√©m pensei se era interessante a troca nos locais onde um simples `fetch` era utilizado, sem autentica√ß√£o e sem especificar o m√©todo. Cogitei a troca pelo motivo de padroniza√ß√£o e tamb√©m pela facilita√ß√£o na troca do `fetch`, por exemplo, onde hoje h√° `cross-fetch` em v√°rios lugares e √© poss√≠vel trocar por `fetch`.
> Sobre a padroniza√ß√£o, s√≥ quando ela ajuda, mas nem sempre √© o caso. Por exemplo, em um arquivo em que o `RequestBuilder` ajuda bastante, pode fazer sentido padronizar e usar ele no arquivo inteiro, incluindo os pontos que seriam mais simples com o `fetch`.
> Para estender isso para diferentes arquivos, ent√£o a an√°lise deveria ser em outro n√≠vel. Isso est√° melhorando a legibilidade e entendimento da grande maioria dos testes, ent√£o vale a pena padronizar. Mas como ele s√≥ ajuda em alguns casos espec√≠ficos, essa padroniza√ß√£o n√£o √© interessante.
> Sobre trocar o `fetch`, acho pouco prov√°vel de acontecer outra mudan√ßa ap√≥s a remo√ß√£o da `cross-fetch`, mas se a interface da fun√ß√£o for mantida, seria bem tranquilo mudar para todos os testes mexendo apenas na configura√ß√£o do Vitest.
> Al√©m disso, o `RequestBuilder` abstrai qual √© o endere√ßo exato da requisi√ß√£o para que o teste defina apenas o endpoint que est√° sendo testado, que √© a parte relevante (ou seja, sem precisar definir a URL como sendo `orchestrator.webserverURL`, e percebi que esqueci de remover isso no teste de Thumbnail).
> Vou editar [meu coment√°rio anterior](https://github.com/filipedeschamps/tabnews.com.br/pull/1708#pullrequestreview-2089522566) para o compara√ß√£o ficar correta com o `orchestrator.webserverURL`, que tamb√©m √© uma abstra√ß√£o, mas em outro n√≠vel. üëç

```js
const response = await fetch(`${orchestrator.webserverUrl}/api/v1/...);
```

> E tamb√©m, caso o endpoint n√£o tenha um recurso din√¢mico e nem precise de autoriza√ß√£o, √© poss√≠vel declar√°-lo uma √∫nica vez no arquivo de teste (instanciando o `RequestBuilder` uma √∫nica vez). Um exemplo disso √© o arquivo `tests/integration/api/v1/contents/get.test.js`.
> Isso, esse √© um exemplo de onde o `RequestBuilder` faz sentido, mas n√£o uma justificativa para usar ele como padr√£o em todos os testes.
> Esses s√£o os benef√≠cios que eu enxergo, mas se acharem melhor deixar com `fetch`, n√£o vejo problema em n√£o usar o `RequestBuilder` onde a mudan√ßa √© pouca (geralmente, os `GET`s sem autentica√ß√£o).
> Acho melhor usar s√≥ nesses casos em que a melhora na legibilidade compense o impacto no entendimento do que est√° realmente acontecendo por tr√°s.
>
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Pronto. Veja se a altera√ß√£o da interface do `get` faz sentido ou se tem uma sugest√£o melhor.
> > Quando for necess√°rio passar um `bodyParser`, acho que faz mais sentido passar para o construtor do que para o `get`. O construtor pode receber um objeto `options` como segundo par√¢metro.
> > Na linha do que voc√™ j√° fez, `options.bodyParser` recebe uma `string`. Em uma melhoria futura, d√° para aceitar tamb√©m uma fun√ß√£o que pode ajudar na cria√ß√£o e simplifica√ß√£o de outros testes.

---

> Aproveitei para simplificar a constru√ß√£o da URL no `get` e `patch`.
> Pelos valores aceitos no primeiro par√¢metro do construtor, talvez `endpointPath` n√£o deixe t√£o expl√≠cita as possibilidades. Mas n√£o sei se `urlSegments` fica melhor:

```diff
- constructor(endpointPath)
+ constructor(urlSegments = '', options = {})
```

Al√©m disso, talvez o que voc√™ chamou de `url` fique melhor como `baseUrl`, pois a `url` mesmo √© constru√≠da depois:

```diff
- this.url = endpointPath.startsWith('http') ? endpointPath : `${orchestrator.webserverUrl}${endpointPath}`
+ this.baseUrl = urlSegments.startsWith('http') ? urlSegments : `${orchestrator.webserverUrl}${urlSegments}`
```

E deixando menos r√≠gida a parte da URL recebida no construtor e a parte recebida depois, que pode conter tamb√©m parte de `path`, al√©m da `query string`, ser√° que `route` fica melhor?

```diff
- fetch(`${this.url}${urlParams}`...
+ fetch(`${this.baseUrl}${route}`...
```

Tamb√©m acho melhor tornar a interface de `get`, `post` e `patch` mais parecidas entre si. Por enquanto est√° assim:

```js
get((urlParams = ""), (bodyParser = "json"));
post(requestBody);
patch((urlParams = ""), requestBody);
```

mas poderia ficar:

```js
get((route = ""));
post((route = ""), requestBody);
patch((route = ""), requestBody);
```

Um opcional (at√© para n√£o precisar mudar testes que j√° est√£o usando o `RequestBuilder`) pode ser olhar se existe o segundo par√¢metro em `post` (ou `patch`), caso contr√°rio, analisa se o primeiro √© uma `string` ou um `objeto` para saber se trata como `route` ou `requestBody`.
Seguindo essas sugest√µes, ficam abertas possibilidades como (s√≥ um exemplo aleat√≥rio):

```js
const requestBuilder = new RequestBuilder("/api/v1");
const { responseBody: user } = requestBuilder.get("/user");
const { responseBody: session } = requestBuilder.get("/sessions");
```

---

> Edit: Acha necess√°rio voltar a usar o `fetch` no `rss/get`?
> Sim, no caso do `rss/get`, acho que o `fetch` fica melhor üëç
> E parece que ao remover o `RequestBuilder` de `rss/get`, toda a quest√£o do `bodyParser` passa a ser _overengineering_, ent√£o pode ser deixada para quando/se for necess√°rio, ou n√£o?
>
> > Review de aprendendofelipe (APPROVED):
> > Show!!!
> > Bora pro merge?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Esse e outros condicionais no `RequestBuilder` acabam desaconselhando o uso dele na etapa `Act` dos testes.
> > Ser√° que faz sentido usar ele apenas para a `Arrange` nos casos que o `orchestrator` n√£o ajudar?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > A parte relevante do teste costuma ser o `assert` das respostas, e n√£o dos cabe√ßalhos, mas pode sim ser √∫til assegurar os cabe√ßalhos em um teste espec√≠fico (desnecess√°rio verificar em todos).
> > Se precisar passar um par√¢metro com a convers√£o esperada (`text`, `arrayBuffer` ou `json`) em todos os testes, ou mesmo o pr√≥prio teste obter o `responseBody`, e n√£o o `RequestBuilder`, voltamos a ter testes mais verbosos, o que fica cansativo em endpoints que precisamos testar muitos comportamentos diferentes da aplica√ß√£o (por exemplo, `POST /api/v1/contets`).
> > Acham que fica melhor remover essas condicionais para obter o `requestBody` e receber um par√¢metro que indique a fun√ß√£o que deve ser usada? Ou, ainda, acham isso desnecess√°rio e o `RequestBuilder` deveria retornar apenas o `response`, e n√£o `responseBody`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que n√£o precisa remover os condicionais, mas fazer eles s√≥ dependerem do que foi passado para o `RequestBuilder` e n√£o de algo que veio na resposta (no que est√° sendo testado). Os demais condicionais desse arquivo j√° est√£o OK nesse ponto. üëç
> > Uma op√ß√£o aqui no `responseBody` √© manter o padr√£o `await response.json()`, mas s√≥ usar os outros casos se for enviado algum par√¢metro com a convers√£o esperada, que pode at√© ter a op√ß√£o de n√£o fazer nada, e deixar para o restante do teste obter o `body`.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Pronto. Veja se a altera√ß√£o da interface do `get` faz sentido ou se tem uma sugest√£o melhor.
> > Aproveitei para simplificar a constru√ß√£o da URL no `get` e `patch`.
> > Edit: Acha necess√°rio voltar a usar o `fetch` no `rss/get`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o precisa necessariamente mudar isso, mas para manter o mesmo `responseBody`, deixar mais contida a mudan√ßa necess√°ria pela remo√ß√£o da `cross-fetch`, e evitar mudar o `expect`, eu usaria algo como:

```suggestion
      const responseBody = Buffer.from(await response.arrayBuffer());
```

</pull_1708_Usar `RequestBuilder` em mais testes de conte√∫dos>

<pull_1715_Remove a biblioteca `cross-fetch` e muda a `set-cookie-parser` para `devDependencies`>
Com o PR #1708, fiquei curioso se j√° poder√≠amos remover completamente a `cross-fetch` e usar apenas o `fetch` nativo. Na busca por c√≥digo que usava o padr√£o dessa biblioteca, que s√≥ deveria estar presente nos testes, acabei descobrindo a fun√ß√£o `parseSetCookies` no model `authentication`.

## Mudan√ßas realizadas

Como, de fato, a fun√ß√£o s√≥ era chamada nos testes, movi ela para `/tests/orchestrator`, e isso abriu a possibilidade de tornar a `set-cookie-parser` uma depend√™ncia apenas de desenvolvimento. E isso foi feito no commit 2941d89d46474e0dc2cb88a2cfc5b690fe45163c.
Obs.: Hoje o `/tests/orchestrator` cont√©m fun√ß√µes que talvez ficassem melhor em uma `/tests/utils`, mas, para n√£o iniciar essa refatora√ß√£o nesse PR, optei por deixar a `parseSetCookies()` tamb√©m no `orchestrator`.
Ap√≥s isso, o commit 4bb2ba2e7564b88da9c5272cfd9c362146b9aa26 remove completamente a `cross-fetch` e faz as adequa√ß√µes necess√°rias.
Obs. 2: Com o `fetch` nativo, apenas o m√©todo `PATCH` n√£o funcionou com letras min√∫sculas (`method: 'patch'`), mas como n√£o havia padr√£o nos testes, resolvi alterar para mai√∫sculo tamb√©m onde tinha `get` ou `post`.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos foram adequados e est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > √ìtimo!
  > > </pull_1715_Remove a biblioteca `cross-fetch` e muda a `set-cookie-parser` para `devDependencies`>

<pull_1720_Estabiliza testes que falham eventualmente>
Inspirado pelo assunto que vem sendo abordado nas √∫ltimas aulas do curso.dev, sobre a estabiliza√ß√£o dos testes, resolvi corrigir alguns testes que falhavam muito raramente, ou por diferen√ßas de rel√≥gio, ou pela falta de aleatoriedade na gera√ß√£o de usu√°rios falsos.

## Diferen√ßas de hor√°rio

Eventual diferen√ßa no rel√≥gio do PostgreSQL e do Vitest causa alguns comportamentos indesejados.

### RSS

O campo `lastBuildDate` do feed RSS √© preenchido com o valor do `updated_at` do conte√∫do mais atual, mas o teste verificava se o valor batia com o `published_at` desse conte√∫do. Quase sempre batia, mas em alguns poucos casos existia alguma pequena diferen√ßa que acusava erro no teste.
Agora a compara√ß√£o ocorre corretamente entre `lastBuildDate` e o `updated_at`.

### Expira√ß√£o e revalida√ß√£o do token de sess√£o

Os testes verificavam a expira√ß√£o simulando a passagem de tempos exatos, mas eventualmente o teste falhava pelo token ainda n√£o ter expirado.
Agora √© simulada a passagem de um tempo extra, al√©m do tempo normal.

## Cria√ß√£o de usu√°rios

Utilizamos a biblioteca [@faker-js/faker](https://www.npmjs.com/package/@faker-js/faker) para preencher campos com dados aleat√≥rios, mas de vez em quando a aleatoriedade falha, e isso causa erros de duplicidade.

### `username` ou `email` duplicados

Era raro, mas de vez em quando ocorria algum erro porque a biblioteca gerava duas vezes o mesmo nome de usu√°rio, ou endere√ßo de email, na mesma bateria de testes.
Agora s√£o armazenados todos os nomes e emails j√° utilizados durante a bateria de testes, e assim podemos garantir que n√£o haver√° tentativa de criar usu√°rios duplicados, a menos que estejamos propositalmente testando essa condi√ß√£o.

### `username` muito longo

A biblioteca n√£o permite limitar o tamanho do `username` criado, ent√£o eventualmente o `username` gerado passava dos 30 caracteres permitidos.
Agora temos `substring(0, 30)` para garantir que os nomes aleat√≥rios n√£o passem de 30 caracteres.

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Corre√ß√£o de bug nos testes

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Belas observa√ß√µes!
  > > </pull_1720_Estabiliza testes que falham eventualmente>

<pull_1722_Corrige a valida√ß√£o do `slug` truncado terminando com h√≠fen>

## Mudan√ßas realizadas

Cria uma valida√ß√£o customizada para remover o h√≠fen final do `slug` quando necess√°rio.

```js
const noTrailingHyphen = (value) => {
  while (value.endsWith("-")) {
    value = value.slice(0, -1);
  }
  return value;
};
```

Apenas essa mudan√ßa no validador j√° √© suficiente para corrigir o bug, independentemente do `slug` ser fornecido pelo criador do conte√∫do ou gerado automaticamente, mas aproveitei o PR para otimizar o modo que utilizamos a biblioteca [`slug`](https://www.npmjs.com/package/slug) para gera√ß√£o baseada no `title`:

- Tirei a configura√ß√£o `slug.extend` de dentro da fun√ß√£o `getSlug` para que a configura√ß√£o da biblioteca ocorra apenas uma vez.
- Trunquei o t√≠tulo antes de passar para a biblioteca, pois assim diminu√≠mos o trabalho realizado em grandes t√≠tulos, e garantimos que o `slug` gerado nunca ser√° barrado pelo validador.
  Resolve #1721

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (DISMISSED):
  > > Excelente estudo sobre a situa√ß√£o do `slug`. Concordo que o tamanho atual √© exageradamente grande, e `160` continua grande, mas me parece um bom tamanho para mudarmos agora com a menor fric√ß√£o poss√≠vel ‚Äî afinal, est√°vamos convivendo com um tamanho bem maior at√© ent√£o.
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Para facilitar a manuten√ß√£o, acha que faz sentido ter um arquivo para constantes? Assim, se esse valor mudar algum dia (como j√° aconteceu), s√≥ precisaria mudar no arquivo, n√£o precisaria mexer nos testes e nem buscar onde esse valor √© usado.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Respondi em https://github.com/filipedeschamps/tabnews.com.br/pull/1722#issuecomment-2161457422
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > J√° aprovei o PR, mas levando em considera√ß√£o que um coment√°rio pode ter `title` (se criado pela API), n√£o acha melhor validar com base no `secureContentFound.parent_id`?
  > > </pull_1722_Corrige a valida√ß√£o do `slug` truncado terminando com h√≠fen>

<pull_1723_Habilita mais regras do ESLint>

## Mudan√ßas realizadas

Estou habilitando algumas regras √∫teis do ESLint para facilitar revis√µes de PR e tamb√©m para evitar erros ao criar um commit.

- [`prefer-const`](https://eslint.org/docs/latest/rules/prefer-const): percebi a necessidade no PR #1716, onde algumas vari√°veis eram declaradas com `let`, apesar de serem constantes.
- [`vitest/no-focused-tests`](https://github.com/veritem/eslint-plugin-vitest/blob/main/docs/rules/no-focused-tests.md): essa eu habilitei no PR #1638 (ainda n√£o mesclado) h√° alguns meses porque j√° quase esqueci de remover o `.only` em alguns testes.
- [`vitest/require-to-throw-message`](https://github.com/veritem/eslint-plugin-vitest/blob/main/docs/rules/require-to-throw-message.md): pequena melhoria que ajuda a garantir que o `expect` realmente testa o que √© esperado. Resultou em uma modifica√ß√£o no teste `Spamming valid users` em `/api/v1/users/firewall.post.test.js`.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1723_Habilita mais regras do ESLint>

<pull_1725_Usa o m√≥dulo `crypto` para gerar UUIDs e move o `uuid` para `devDependencies`>

## Mudan√ßas realizadas

Esbarrei com o PR https://github.com/filipedeschamps/tabnews.com.br/pull/1018 e decidi reimplementar. N√£o foi poss√≠vel remover a biblioteca `uuid`, porque usamos uma fun√ß√£o dela para verificar a vers√£o do UUID em testes, mas foi poss√≠vel passar a biblioteca `uuid` para ser uma depend√™ncia de desenvolvimento e utilizar o m√≥dulo `crypto` para gerar os UUIDs com [`.randomUUID()`](https://nodejs.org/api/crypto.html#cryptorandomuuidoptions).
O m√≥dulo deve ser importado como `crypto` ao inv√©s de `node:crypto` nos arquivos que s√£o executados em Middlewares Edge da Vercel, conforme documenta√ß√£o ([aqui](https://vercel.com/docs/functions/runtimes/edge-runtime#compatible-node.js-modules) e [aqui](https://vercel.com/docs/functions/runtimes/edge-runtime#crypto-apis)).

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de kaique-soares (APPROVED):
  > > Legal @Rafatcb :+1:
  > > Deixei sugest√µes em arquivos que faltou adicionar o prefixo `node:` caso ache que compense padronizar :+1:
  > > Review de Rafatcb (COMMENTED):
  > > Review de kaique-soares (COMMENTED):
  > > Review de kaique-soares (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Coment√°rio de kaique-soares (linha de c√≥digo):

```suggestion
import { randomUUID as uuid } from 'node:crypto';
```

> > Coment√°rio de kaique-soares (linha de c√≥digo):

```suggestion
import { randomUUID as uuidV4 } from 'node:crypto';
```

> > Coment√°rio de kaique-soares (linha de c√≥digo):

```suggestion
import { randomUUID as uuidV4 } from 'node:crypto';
```

> > Coment√°rio de kaique-soares (linha de c√≥digo):

```suggestion
import { randomUUID as uuidV4 } from 'node:crypto';
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Quando estava desenvolvendo, colocar `node:crypto` neste arquivo dava um erro:

```bash
 ‚®Ø node:crypto
Module build failed: UnhandledSchemeError: Reading from "node:crypto" is not handled by plugins (Unhandled scheme).
Webpack supports "data:" and "file:" URIs by default.
You may need an additional plugin to handle "node:" URIs.
Import trace for requested module:
node:crypto
./errors/index.js
```

Procurando no Google, encontrei [essa documenta√ß√£o](https://github.com/vercel/next.js/discussions/34790) sobre middlewares que diz:

> Native Node.js APIs are not supported. For example, you can't read or write to the filesystem.
> Ent√£o imaginei que fosse esse o problema. Pesquisei e vi que o `crypto` [funciona na Edge](https://vercel.com/templates/next.js/edge-functions-crypto), por isso deixei como `crypto` e testei pelo deploy deste PR (criei um coment√°rio, criei uma conta e dei um voto, com sucesso e sem sucesso).
> Apesar de apenas ter dado erro no arquivo `errors/index.js` durante o desenvolvimento, n√£o tenho certeza se os models s√£o executados na Edge tamb√©m em alguma ocasi√£o, ent√£o deixei com `crypto` por precau√ß√£o. Talvez algu√©m que entenda melhor possa responder aqui e os meus palpites n√£o tenham nada a ver e funcionaram por sorte :sweat_smile:
> Vi uma sugest√£o para colocar a seguinte configura√ß√£o no `next.config.js`:

```js
  webpack: (config) => {
    config.externals.push({
      'node:crypto': 'commonjs crypto',
    });
    return config;
  },
```

Mas n√£o resolveu, o erro mudou para:

```bash
 ‚®Ø Error [TypeError]: Native module not found: crypto
    at <unknown> (.../tabnews.com.br/node_modules/next/dist/server/web/sandbox/context.js:220)
    at value (.../tabnews.com.br/node_modules/next/dist/server/web/sandbox/context.js:220:31)
    at node:crypto (.../tabnews.com.br/.next/server/middleware.js:18:18)
    at __webpack_require__ (.../tabnews.com.br/.next/server/edge-runtime-webpack.js:37:33)
    at fn (.../tabnews.com.br/.next/server/edge-runtime-webpack.js:268:21)
    at eval (webpack-internal:///(middleware)/./errors/index.js:13:69)
    at (middleware)/./errors/index.js (.../tabnews.com.br/.next/server/middleware.js:72:1)
    at __webpack_require__ (.../tabnews.com.br/.next/server/edge-runtime-webpack.js:37:33)
    at fn (.../tabnews.com.br/.next/server/edge-runtime-webpack.js:268:21)
    at eval (webpack-internal:///(middleware)/./middleware.public.js:9:64)
    at (middleware)/./middleware.public.js (.../tabnews.com.br/.next/server/middleware.js:127:1)
    at __webpack_require__ (.../tabnews.com.br/.next/server/edge-runtime-webpack.js:37:33)
    at fn (.../tabnews.com.br/.next/server/edge-runtime-webpack.js:268:21)
    at eval (webpack-internal:///(middleware)/./node_modules/next/dist/build/webpack/loaders/next-middleware-loader.js?absolutePagePath=%2Fhome%2Frafael%2FDocuments%2FRepositorios%2Ftabnews.com.br%2Fmiddleware.public.js&page=%2Fmiddleware&rootDir=%2Fhome%2Frafael%2FDocuments%2FRepositorios%2Ftabnews.com.br&matchers=&preferredRegion=&middlewareConfig=e30%3D!:7:79)
    at (middleware)/./node_modules/next/dist/build/webpack/loaders/next-middleware-loader.js?absolutePagePath=%2Fhome%2Frafael%2FDocuments%2FRepositorios%2Ftabnews.com.br%2Fmiddleware.public.js&page=%2Fmiddleware&rootDir=%2Fhome%2Frafael%2FDocuments%2FRepositorios%2Ftabnews.com.br&matchers=&preferredRegion=&middlewareConfig=e30%3D! (.../tabnews.com.br/.next/server/middleware.js:61:1)
    at __webpack_require__ (.../tabnews.com.br/.next/server/edge-runtime-webpack.js:37:33)
    at __webpack_exec__ (.../tabnews.com.br/.next/server/middleware.js:826:48)
    at <unknown> (.../tabnews.com.br/.next/server/middleware.js:827:37)
    at webpackJsonpCallback (.../tabnews.com.br/.next/server/edge-runtime-webpack.js:1128:39)
    at <unknown> (.../tabnews.com.br/.next/server/middleware.js:9:61)
    at Script.runInContext (node:vm:133:12)
    at runInContext (node:vm:281:6)
    at evaluateInContext (.../tabnews.com.br/node_modules/next/dist/server/web/sandbox/context.js:377:38)
    at getRuntimeContext (.../tabnews.com.br/node_modules/next/dist/server/web/sandbox/sandbox.js:70:9)
    at async runWithTaggedErrors (.../tabnews.com.br/node_modules/next/dist/server/web/sandbox/sandbox.js:76:21)
    at async DevServer.runMiddleware (.../tabnews.com.br/node_modules/next/dist/server/next-server.js:1039:24)
    at async DevServer.runMiddleware (.../tabnews.com.br/node_modules/next/dist/server/dev/next-dev-server.js:261:28)
    at async NextNodeServer.handleCatchallMiddlewareRequest (.../tabnews.com.br/node_modules/next/dist/server/next-server.js:323:26)
    at async DevServer.handleRequestImpl (.../tabnews.com.br/node_modules/next/dist/server/base-server.js:813:28)
    at async (.../tabnews.com.br/node_modules/next/dist/server/dev/next-dev-server.js:331:20)
    at async Span.traceAsyncFn (.../tabnews.com.br/node_modules/next/dist/trace/trace.js:151:20)
    at async DevServer.handleRequest (.../tabnews.com.br/node_modules/next/dist/server/dev/next-dev-server.js:328:24)
    at async handleRoute (.../tabnews.com.br/node_modules/next/dist/server/lib/router-utils/resolve-routes.js:319:33)
    at async resolveRoutes (.../tabnews.com.br/node_modules/next/dist/server/lib/router-utils/resolve-routes.js:539:28)
    at async handleRequest (.../tabnews.com.br/node_modules/next/dist/server/lib/router-server.js:200:96)
    at async requestHandlerImpl (.../tabnews.com.br/node_modules/next/dist/server/lib/router-server.js:366:13)
    at async Server.requestListener (.../tabnews.com.br/node_modules/next/dist/server/lib/start-server.js:140:13) {
  middleware: true
}
```

> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Ah sim! Este arquivo de fato n√£o vai poder utilizar o prefixo `node:` pelo erro que voc√™ apontou e com isso o `crypto` utilizado ser√° o [`Web Crypto`](https://w3c.github.io/webcrypto/#Crypto-method-randomUUID) :+1:
> > Ele √© chamado na `edge` aqui:
> > https://github.com/filipedeschamps/tabnews.com.br/blob/b7f063f98ec0980f15fe7987252843d2d5c1b854/middleware.public.js#L17

---

Sobre os `models`, estou com voc√™ :sweat_smile:

> > Coment√°rio de kaique-soares (linha de c√≥digo):
> > Especulo que esse aqui tamb√©m √© chamado na `edge` :+1:
> > https://github.com/filipedeschamps/tabnews.com.br/blob/b7f063f98ec0980f15fe7987252843d2d5c1b854/middleware.public.js#L55-L56
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aqui pode ser `node:crypto`, assim como nos _models_ e nos testes. üëç
> > Apenas no `errors` precisa deixar s√≥ `crypto` para ser compat√≠vel com Node e Edge.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Alterado. Obrigado pelas respostas de ambos :handshake:
> > </pull_1725_Usa o m√≥dulo `crypto` para gerar UUIDs e move o `uuid` para `devDependencies`>

<pull_1726_Remove propriedade obsoleta `version` do Docker Compose>

## Mudan√ßas realizadas

Ter `version` definido causa um warning nas [actions do GitHub](https://github.com/filipedeschamps/tabnews.com.br/actions/runs/9555328572/job/26338346349#step:3:13):

```bash
time="2024-06-17T21:57:29Z" level=warning msg="/home/runner/work/tabnews.com.br/tabnews.com.br/infra/docker-compose.development.yml: `version` is obsolete"
```

Detalhes sobre `version` estar obsoleta podem ser encontrados [aqui](https://github.com/compose-spec/compose-spec/blob/master/spec.md#version-and-name-top-level-elements). Como n√£o √© uma propriedade utilizada, a remo√ß√£o n√£o causar√° nenhuma mudan√ßa, apenas remover√° o aviso.

> Compose doesn't use `version` to select an exact schema to validate the Compose file, but prefers the most recent schema when it's implemented.
> Essa altera√ß√£o foi realizada na **vers√£o [1.27.0](https://docs.docker.com/compose/release-notes/#1270) do Docker Compose**, lan√ßada em 07/09/2020 (3 anos e 9 meses atr√°s), ent√£o atualizei o README. Talvez fa√ßa sentido sugerir o uso da vers√£o 1.27.4, que cont√©m patches de algumas corre√ß√µes, ou mesmo uma vers√£o mais recente. **Edit:** O README foi atualizado para uma vers√£o pr√≥xima que foi testada, 1.29.2, conforme comentado [aqui](https://github.com/filipedeschamps/tabnews.com.br/pull/1726#discussion_r1643535087).

## Tipo de mudan√ßa

- [x] Corre√ß√£o de warning (CI)
- [x] Atualiza√ß√£o de documenta√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (DISMISSED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Aproveitando que est√° atualizando essa configura√ß√£o, o que acha de adicionar o nome `tabnews`?
  > > Sem definir `name`, o docker agrupa os cont√™ineres pelo nome da pasta, que √© `infra`, mas seria mais organizado agrupar como `tabnews`.
  > > Ele pega o nome da pasta porque o `docker-compose.yml` costuma ficar na raiz do projeto.

```suggestion
name: 'tabnews'
services:
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Talvez fa√ßa sentido sugerir o uso da vers√£o 1.27.4, que cont√©m patches de algumas corre√ß√µes, ou mesmo uma vers√£o mais recente.
> > N√£o sei se alguma vers√£o tem algum bug que nos afete. √â quase certo que n√£o, mas √© bom sugerir uma vers√£o que foi testada. Eu j√° estou usando a `2.27.0`, mas n√£o precisamos sugerir essa mais atual.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu estou usando a vers√£o `1.29.2` sem problemas, ent√£o imagino que a 1.27.0 funcione bem, mas prefere que eu atualize para 1.29.2?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Melhor a `1.29.2`
> > </pull_1726_Remove propriedade obsoleta `version` do Docker Compose>

<pull_1727_Salvar nos eventos o hist√≥rico de altera√ß√µes de `username`>
Estudando as possibilidades para revalidar as p√°ginas est√°ticas sob demanda para diminuir a utiliza√ß√£o do cache da Vercel (https://github.com/filipedeschamps/tabnews.com.br/issues/1724#issuecomment-2168729755), optei por usar os eventos para analisar o que precisa ser revalidado. Usar os eventos facilita se um dia quisermos criar uma fila ou levar o processo de revalida√ß√£o para outro servidor que monitora e reage de acordo com os eventos.
Para revalidar as p√°ginas antigas e retornar 404 quando um usu√°rio alterar seu `username`, precisamos guardar o antigo `username` no evento. Precisamos atualizar os antigos para 404, pois se deixar os dados antigos em cache, eles n√£o v√£o ser consistentes com as novas mudan√ßas nos conte√∫dos, como votos, coment√°rios e qualquer outra modifica√ß√£o que s√≥ vai afetar o endere√ßo novo.

## Mudan√ßas realizadas

Com isso em mente, adicionei os metadados nos eventos de altera√ß√£o do `username`:

```js
metadata.username = {
  old: originalUser.username,
  new: updatedUser.username,
};
```

Ao adicionar testes para a modifica√ß√£o, notei que nem todos os tipos de eventos possu√≠am testes, ent√£o j√° criei para todos.
Movi os poucos que existiam em `tests/integration/api/v1/events/get.test.js` para junto dos novos que criei em `tests/integration/models/event.test.js`.
E os testes mostraram que o evento do tipo `update:content:text_child` nunca era criado, mas apenas o `update:content:text_root` no seu lugar. Ent√£o j√° corrigi isso.
Adicionei o m√©todo `delete` ao `requestBuilder` para os testes de evento de banimento.
Outra mudan√ßa foi alterar `events.findAll()` para `orchestrator.getLastEvent()`, pois `findAll` era utilizado apenas nos testes, e com as modifica√ß√£o atuais, apenas o √∫ltimo evento precisa ser buscado.
Por fim, adicionei [`.soft`](https://vitest.dev/api/expect.html#soft) nos `expect(responde.status)` para o teste poder continuar mesmo se receber um status incorreto. Assim aumenta as chances de termos uma mensagem de erro com mais detalhes do porque o teste falhou, j√° que olhar para o `responseBody` normalmente ajuda mais.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (DISMISSED):
  > > Boa ideia em criar um arquivo separado para os testes de evento :+1:
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Aproveitando que mudou aqui, o que acha de atualizar tamb√©m a linha `118` para verificar `contentToBeUpdated.parent_id` ao inv√©s de `unfilteredBodyValues.parent_id`?
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Feito, e adicionado testes para isso tamb√©m üëç
  > > </pull_1727_Salvar nos eventos o hist√≥rico de altera√ß√µes de `username`>

<pull_1728_Remove valida√ß√£o de exist√™ncia do `parent_id` ao modificar um conte√∫do>

## Mudan√ßas realizadas

Sempre que o `parent_id` √© enviado na atualiza√ß√£o de um conte√∫do, h√° uma chamada ao banco de dados para validar que ele existe. Por√©m, n√£o √© poss√≠vel atualizar o `parent_id` desde o PR #1419, ent√£o podemos remover essa valida√ß√£o.
Como consequ√™ncia, modifiquei a mensagem de erro, visto que agora a valida√ß√£o √© utilizada apenas na cria√ß√£o, e aproveitei para atualizar o teste para utilizar `.toStrictEqual` e testar a propriedade `key` da resposta.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1728_Remove valida√ß√£o de exist√™ncia do `parent_id` ao modificar um conte√∫do>

<pull_1729_Diminui idas ao banco de dados na cria√ß√£o e edi√ß√£o de conte√∫dos, e na edi√ß√£o de usu√°rios>

## Mudan√ßas realizadas

Realizei algumas altera√ß√µes como tentativa de melhoria de desempenho na cria√ß√£o e edi√ß√£o de um conte√∫do.

1. Na cria√ß√£o de conte√∫do, busquei o `parent` na query de cria√ß√£o ao inv√©s de buscar separadamente.
2. No `creditOrDebitTabCoins`, mudar a ordem dos `if`s evita uma consulta no banco de dados quando o conte√∫do n√£o √© relevante. Al√©m disso, buscar o conte√∫do pai diretamente com SQL permite obter apenas o campo desejado (`owner_id`), ao inv√©s de trazer todos os campos da tabela e ainda calcular os TabCoins do conte√∫do.
3. Tamb√©m em `creditOrDebitTabCoins`, buscar o pai no banco de dados apenas caso `newContent.parent_owner_id` seja `undefined` permite evitar buscar o pai duas vezes no `create`.
4. No `PATCH`, √© poss√≠vel definir `metadata.id` ao criar o `event`, removendo a necessidade do uso do `event.updateMetadata`. Al√©m disso, ao aceitar receber um `options.oldContent` no `content.update`, evitamos buscar duas vezes o mesmo conte√∫do durante o `PATCH`.
   Talvez alguma mudan√ßa seja desnecess√°ria, possa ter uma interface melhor, ou ainda exista alguma melhoria que n√£o percebi. Estou aberto a sugest√µes.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (DISMISSED):
  > > Boa @Rafatcb! üí™
  > > Fiz alguns coment√°rios, e subi commits com algumas das sugest√µes (n√£o todas), mas pode remover o que voc√™ achar que n√£o faz sentido.
  > > E ao remover a `updateMetadata` na cria√ß√£o de conte√∫do, eu percebi que dava para eliminar totalmente essa fun√ß√£o do sistema, ent√£o j√° removi tamb√©m do patch de usu√°rios. Se achar que isso faz sentido, talvez compense editar o nome do PR, ou criamos outro, se achar melhor separar.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Uma sugest√£o que acredito facilitar a leitura.
  > > Na pr√°tica faz a mesma coisa, mas j√° retorna na primeira CTE o que ser√° utilizado posteriormente, que √© `parent.owner_id` e `parent.child_path`:

```suggestion
          SELECT
            owner_id,
            CASE
              WHEN id IS NULL THEN ARRAY[]::uuid[]
              ELSE ARRAY_APPEND(path, id)
            END AS child_path
          FROM (SELECT 1) AS dummy
          LEFT JOIN contents
          ON id = $2
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aceitando minha outra sugest√£o, precisa ajustar aqui o trecho:

```diff
- SELECT path FROM path_value
+ SELECT child_path FROM parent
```

Mas eu acredito ser mais interessante isto:

```suggestion
            SELECT $1, $2, $3, $4, $5, $6, $7, $8, $9, parent.child_path
            FROM parent
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Como otimiza√ß√£o est√° √≥timo, pois assim j√° est√° validando a consist√™ncia do `parent_id` fornecido.
> > S√≥ que o nome da fun√ß√£o n√£o deixa claro que est√° validando o `parent_id` em si, pois d√° a entender que est√° validando apenas a presen√ßa dele no `path`.
> > N√£o consegui pensar em um nome melhor, ent√£o pode ser o caso de deixar um coment√°rio
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Melhor remover esse coment√°rio por n√£o ser totalmente coerente com o que realmente √© verificado abaixo

```suggestion

```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se popular o id no `postHandler` ao inv√©s daqui, tamb√©m d√° para evitar o `event.updateMetadata` na cria√ß√£o do conte√∫do.
> > Da√≠ precisa fazer o mesmo no `orchestrator.createContent`, e acho que vale a pena.

```suggestion

```

Para poder passar isso para o controller, acho que s√≥ precisamos adicionar `id: 'required'` em `validateCreateSchema`

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Fiz um commit com uma alternativa. Agora o `INSERT` retorna realmente o `parent_id` que foi criado e verificamos a exist√™ncia com base numa compara√ß√£o do `postedContent.parent_id` com o `newContent.parent_id`, sem envolver o `path`.
> > O que acha?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O novo nome da fun√ß√£o (`throwIfSpecifiedParentDoesNotExist`) deixa mais claro o que realmente est√° sendo validado, ent√£o gosto dele. üëç
> > Mas eu n√£o manteria a nova implementa√ß√£o, pois `postedContent.parent_id !== newContent.parent_id` d√° a impress√£o de que a compara√ß√£o n√£o est√° garantindo o que queremos garantir. Ela garante, mas s√≥ est√° garantindo porque tem outra coisa "estranha" em outro lugar, que √© a mudan√ßa na inser√ß√£o do novo coment√°rio, j√° que ela n√£o est√° devolvendo o `parent_id` de verdade da nova linha que foi criada no banco, mas sim o `id` do conte√∫do pai que foi buscado. E nesse trecho do c√≥digo da query n√£o est√° claro porque isso √© feito dessa maneira.
> > Ent√£o acabamos com dois trechos de c√≥digo "estranhos" quando analisados isoladamente.
> > Que tal algo assim?

```js
function throwIfSpecifiedParentDoesNotExist(postedContent, newContent) {
  const existingParentId = newContent.path.pop();
  if (postedContent.parent_id && postedContent.parent_id !== existingParentId) {
```

Assim n√£o √© preciso nenhuma adapta√ß√£o na inser√ß√£o, e aqui tamb√©m fica bem explicado o que, e de que forma, est√° sendo verificada a exist√™ncia do conte√∫do pai.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Fiz conforme sugeriu, apenas mudei a verifica√ß√£o de `.pop()` para `.at(-1)`, assim n√£o modificamos o array `path`.
> > </pull_1729_Diminui idas ao banco de dados na cria√ß√£o e edi√ß√£o de conte√∫dos, e na edi√ß√£o de usu√°rios>

<pull_1730_Altera comportamento e mensagem de erro quando o e-mail j√° est√° cadastrado>

## Mudan√ßas realizadas

As mensagens de erro nos casos onde o e-mail j√° est√° cadastrado foram modificadas conforme discutido em #1695 e nos coment√°rios deste PR.
Al√©m disso, o uso da palavra `e-mail` foi padronizada, com h√≠fen.

### Recupera√ß√£o de senha (`POST /api/v1/recovery`)

Ao recuperar a senha, o backend retornar√° sucesso mesmo se n√£o existir um usu√°rio com o e-mail informado. A exce√ß√£o √© quando a recupera√ß√£o ocorre por meio do `username`, ent√£o o backend pode retornar erro caso o usu√°rio n√£o exista.
No frontend, a p√°gina que exibia a mensagem "Confira seu e-mail. Voc√™ receber√° um link para definir uma nova senha." n√£o existe. Agora √© usado o `Flash` na pr√≥pria p√°gina de recupera√ß√£o para exibir a mensagem.
| Cen√°rio | Resultado |
| :-----: | --------- |
| Antes | |
| Agora | |

### Cadastro (`POST /api/v1/users`)

Ao criar uma conta com um e-mail que j√° est√° cadastrado, o backend retorna sucesso, mas n√£o envia um e-mail. O frontend fica respons√°vel por informar que o link de confirma√ß√£o s√≥ ser√° enviado caso o e-mail esteja dispon√≠vel.
| Cen√°rio | Resultado |
| :-----: | --------- |
| Antes | |
| Agora | |

### Atualiza√ß√£o de e-mail (`PATCH /api/v1/users/[username]`)

Ao atualizar o e-mail para um e-mail que j√° est√° cadastrado, o backend retorna sucesso, mas n√£o envia um e-mail de confirma√ß√£o. O frontend fica respons√°vel por informar que o link de confirma√ß√£o s√≥ ser√° enviado caso o e-mail esteja dispon√≠vel.
Caso ocorra um novo cadastro para o mesmo e-mail entre o recebimento do e-mail de confirma√ß√£o da altera√ß√£o e a confirma√ß√£o em si, o backend retornar√° um erro informando que o e-mail j√° est√° ocupado. Essa situa√ß√£o √© uma exce√ß√£o, e o teste para isso √© `With an already used email (after creating the token)` em `email-confirmation/patch`.
| Cen√°rio | Resultado |
| :-----------------------------------------------------------------------: | --------- |
| Antes | |
| Agora, alterando apenas o e-mail | |
| Agora, alterando mais dados | |
| N√£o modificado: caso ocorra um cadastro antes da confirma√ß√£o de altera√ß√£o | |
Resolve #1695

## Tipo de mudan√ßa

- [x] Melhoria de seguran√ßa.
- [x] _**Breaking change**_ (em situa√ß√µes espec√≠ficas, agora a API retorna sucesso onde retornava erro, e o frontend deve informar o usu√°rio que a a√ß√£o ser√° realizada apenas caso o e-mail esteja dispon√≠vel ou caso esteja cadastrado, de acordo com os endpoints modificados)

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Conforme discutido em #1695.
  > > J√° que est√° com essa parte do c√≥digo fresca na mem√≥ria, sabe dizer se aumenta muito a complexidade fazer o proposto em #186 (incluindo padronizar as mensagens) ao inv√©s de #1695?
  > > Outro ponto relacionado √© que acho bom continuar informando que o usu√°rio n√£o existe quando a tentativa de recupera√ß√£o da senha for atrav√©s do `username`, que √© uma funcionalidade da modera√ß√£o. A padroniza√ß√£o das mensagens precisa ser apenas na recupera√ß√£o via `email`.
  > > No frontend, modifiquei o `title` da p√°gina porque o anterior n√£o parecia fazer sentido (`Confirme seu email`).
  > > Para ser coerente com a tag `h1`, o t√≠tulo deveria ser `Confira seu e-mail`, mas o que eu acho melhor mesmo √© remover essa p√°gina, pois s√≥ √© preciso mostrar um aviso na p√°gina anterior.
  > > Aqui apenas mudei a mensagem de `O email informado j√° est√° sendo usado` para `N√£o √© poss√≠vel utilizar este email`.
  > > N√£o vale a pena essa mudan√ßa apenas na mensagem se ela for continuar sendo exibida apenas quando o email j√° estiver em uso, pois isso n√£o atende nem #1695 e nem #186.
  > > Review de aprendendofelipe (COMMENTED):
  > > O teste `With an already used email (after creating the token)` em `email-confirmation/patch` continua retornando a mensagem de erro de que o e-mail j√° est√° sendo usado. Acredito que fa√ßa sentido, visto que...
  > > Acredito que fa√ßa sentido porque apenas o dono do email poder√° saber que ele j√° est√° em uso. N√£o √©? O endpoint e model `email-confirmation` n√£o precisa sofrer nenhuma modifica√ß√£o, pois apenas o dono do email tem acesso ao token.
  > > Eu aproveitei esse PR para adicionar o uso do `RequestBuilder` nos arquivos de teste que modifiquei, mas se preferir, passo isso para um PR separado.
  > > Nesse caso espec√≠fico, eu acho que √© melhor facilitar a visualiza√ß√£o dos testes que precisaram mudar exclusivamente por causa do novo comportamento, ent√£o evitaria refatorar os testes no mesmo commit. De prefer√™ncia, nem no mesmo PR, pois a refatora√ß√£o est√° maior do que o objetivo principal do PR.
  > > Por exemplo, se nada mudou no endpoint `/email-confirmation`, nada mudaria no teste dele, mas voc√™ afirma que adicionou o `RequestBuilder` nos arquivos de teste que modificou, ent√£o d√° a entender que precisou modificar esse teste, mas eu n√£o consegui identificar o que mudou nele al√©m da refatora√ß√£o. ‚òπÔ∏è
  > > O mesmo vale para o √∫ltimo commit, que padroniza o uso da palavra `e-mail`...
  > > Pelo mesmo motivo anterior, eu n√£o mexeria nisso nesse PR. Mas, na verdade, acho interessante padronizar, mas como as duas grafias s√£o aceitas, eu usaria o que a Turma j√° optou, que foi `email`, e n√£o `e-mail`. S√£o mais de 1000 ocorr√™ncias de `email` e menos de 10 de `e-mail` no c√≥digo atual. Se achar que esse placar n√£o √© suficiente, ent√£o seria melhor debater em uma issue, mas n√£o acho que seria produtivo.
  > > Review de aprendendofelipe (COMMENTED):
  > > Fiz alguns novos coment√°rios, sendo a maioria apenas sugest√µes.
  > > Mas tem um ponto que acho muito importante ser corrigido antes do merge, que √© a ordem dos par√¢metros falsos devolvidos em `/api/v1/recovery`, pois se der para identificar facilmente que s√£o dados falsos, a estrat√©gia n√£o faz sentido.
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Do que foi mexido aqui, ainda ficou uma brecha aberta para descobrir emails j√° cadastrados, que √© fazer a atualiza√ß√£o do email junto de outro dado do usu√°rio.
  > > Se a atualiza√ß√£o do outro dado n√£o ocorrer, ent√£o √© porque o email j√° est√° em uso.
  > > Mas acho que n√£o faz sentido manter esse PR ainda aberto por esse motivo, sendo que est√° mexendo nesse mesmo ponto no PR #1737, e a otimiza√ß√£o dessa parte l√° j√° deve remover a brecha.
  > > Ent√£o bora pro merge! üöÄ
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        description: secureInputValues.description || '',
```

N√£o estou sugerindo que devemos aceitar `description` j√° na cria√ß√£o do usu√°rio. Acho que aceitar isso antes de ativar a conta criaria outros problemas.
Mas n√£o custa nada deixar essa brecha aqui j√° fechada.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Para evitar a f√°cil identifica√ß√£o de uma resposta falsa, nada pode mudar no padr√£o da resposta em caso de email encontrado ou n√£o, nem a ordem das propriedades:

```suggestion
        expires_at: expiresAt,
        created_at: now,
        updated_at: now,
```

Acho que s√≥ nesse retorno falso tem esse problema, ent√£o uma alternativa melhor pode ser garantir aqui da mesma maneira que os outros, pelo `filterOutput`. L√° podemos passar para o validador um objeto com as propriedades sempre na mesma ordem:

```diff
  if (feature === 'read:recovery_token') {
-    filteredOutputValues = validator(output, {
+   filteredOutputValues = validator({
+      used: output.used,
+      expires_at: output.expires_at,
+      created_at: output.created_at,
+      updated_at: output.updated_at,
+    }, {
      used: 'required',
      expires_at: 'required',
      created_at: 'required',
      updated_at: 'required',
    });
  }
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Que tal j√° criar o `expiresAt` diretamente com o valor correto? Por exemplo:

```suggestion
      const expiresAt = new Date(now.getTime() + 1000 * 60 * 15);
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Para manter a coer√™ncia com os outros itens dessa tela, √© melhor n√£o mudar `email` para `e-mail`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que √© necess√°rio testar tamb√©m o `responseBody`
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que a vers√£o antiga era mais garantida:

```suggestion
      expect(userInDatabaseCheck1.email).toBe('validation.error@before.com');
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aqui poderia ser `toBe` no lugar de `toEqual`, mas existe algo ainda melhor, que √©:

```suggestion
      expect(Date.parse(responseBody.expires_at)).not.toBeNaN();
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Outra melhoria que venho fazendo nos testes que crio ou altero √© adicionar `.soft` nos `expect(response.status)`, pois assim, em caso de erro, podemos ver tamb√©m qual √© a diferen√ßa em `expect(responseBody)`:

```suggestion
      expect.soft(response.status).toBe(201);
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Na verdade, nessa tela s√≥ est√° escrito `email` em
> > Insira um endere√ßo de email v√°lido _(mensagem de erro)_
> > Os outros lugares est√£o `e-mail`:
> > Digite seu e-mail ou o nome de usu√°rio da pessoa que deseja ajudar _(`label`)_
> > Digite seu e-mail ou o nome de usu√°rio de outra pessoa _(`aria-label`, poderia ser removido porque j√° tem `label`)_
> > Digite seu e-mail _(`label`)_
> > Seu e-mail _(`aria-label`, poderia ser removido porque j√° tem `label`)_
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Quando fiz o coment√°rio anterior, estava vendo outra p√°gina, desconsidere.
> > </pull_1730_Altera comportamento e mensagem de erro quando o e-mail j√° est√° cadastrado>

<pull_1733_Atualiza todas as depend√™ncias poss√≠veis>
Foram atualizadas todas as depend√™ncias poss√≠veis.

### N√£o atualizadas

- `eslint`: s√≥ at√© `v8.57.0` por compatibilidade com `eslint-config-next`;
- `eslint-plugin-vitest`: s√≥ at√© `v0.4.1` por compatibilidade com `.eslintrc` (alguns plugins ainda n√£o s√£o compat√≠veis com `eslint.config.js`);
- `kill-port`: por causa do [bug](https://github.com/tiaanduplessis/kill-port/issues/61);
- `next-connect`: por exigir mudan√ßas profundas no c√≥digo e n√£o estar claro se √© compat√≠vel com o Next 14;
- `styled-components`: por compatibilidade com `@primer/react`;
- `uuid`: por compatibilidade com `vis-network`;

### Atualizadas com adequa√ß√µes

- `@react-email/components`: precisou de atualiza√ß√µes dos snapshots por causa da nova meta tag `x-apple-disable-message-reformatting`;

### `@primer/react`

Havia um bug no `TextInput.Action` que nos impedia de utiliz√°-lo no `PasswordInput`, mas agora o bug foi corrigido e n√£o precisamos mais contornar isso, ent√£o reverti a adequa√ß√£o provis√≥ria.
Houve uma mudan√ßa est√©tica no Tooltip do GitHub, que passou a ter um formato um pouco mais arredondado e n√£o possui mais a seta.
| Antes | Depois |
| ----- | ------ |
| |

## Tipo de mudan√ßa

- [x] Atualiza√ß√£o de depend√™ncias

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (COMMENTED):
  > > Curiosamente, eu estava vendo as depend√™ncias do projeto ontem de noite, ent√£o deixei alguns coment√°rios sobre depend√™ncias que n√£o s√£o utilizadas.
  > > Edit:
  > > Percebi que na [documenta√ß√£o](https://primer.style/components/tooltip), o Tooltip do Primer ficou bem mais pr√≥ximo do gatilho do que o nosso, que √© posicionado como se houvesse uma seta invis√≠vel. Tem algum estilo que precisamos modificar para corrigir isso?
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > O `parse-link-header` √© utilizado apenas em testes, ent√£o pode ser movido para `devDependencies`.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > O `autoprefixer` era utilizado com o `postcss` l√° no come√ßo do projeto, ent√£o n√£o √© mais utilizado agora. Pode ser removido.

```suggestion

```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o cheguei a testar isso, mas o `eslint-plugin-github` n√£o deve ser mais necess√°rio, porque o `eslint-plugin-primer-react` o moveu de `devDependencies` para `dependencies` na vers√£o [4.2.0](https://github.com/primer/eslint-plugin-primer-react/blob/main/CHANGELOG.md#420)

```suggestion

```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > O `retry-cli` era usado no script `migration:run`, mas foi removido por causa do script que usamos atualmente `infra/scripts/wait-for-db-connection-ready.js`. Pode ser removido.

```suggestion

```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Na vers√£o 16 a [breaking change](https://github.com/testing-library/react-testing-library/releases) √© que precisa adicionar a depend√™ncia `@testing-library/dom` (agora, ela √© uma peer-dependency da biblioteca).

```suggestion
    "@testing-library/dom": "10.2.0",
    "@testing-library/react": "16.0.0",
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Mas n√≥s n√£o estamos utilizando a `@testing-library/dom`, ou estamos?
> > N√£o √© melhor adicionar apenas quando precisar?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√≥s realmente n√£o usamos. Pelo o que vi da base de c√≥digo da `@testing-library/react`, o [`render`](https://github.com/testing-library/react-testing-library/blob/a4744fa904bf11812c92093226c3805450472636/src/pure.js#L199) n√£o utiliza a `@testing-library/dom`. Podemos adicionar quando formos criar novos testes que precisem disso.
> > O √∫nico inc√¥modo seria caso houvesse necessidade de usar o [`debug`](https://github.com/testing-library/react-testing-library/blob/a4744fa904bf11812c92093226c3805450472636/src/pure.js#L162) (que utiliza o [`prettyDOM`](https://github.com/testing-library/react-testing-library/blob/a4744fa904bf11812c92093226c3805450472636/src/pure.js#L6)), e apenas ele, sem outra fun√ß√£o que dependesse da `@testing-library/dom`. Ent√£o, precisar√≠amos adicion√°-la como depend√™ncia para criar o teste, e depois remover (visto que o `debug` n√£o ir√° para o `commit`).
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Como √© praticamente certo que logo iremos precisar, e tem essa quest√£o do `debug`, ent√£o j√° adicionei. üëç
> > </pull_1733_Atualiza todas as depend√™ncias poss√≠veis>

<pull_1734_Corrige o CSS gerado ap√≥s atualiza√ß√£o para o Next.js 14.2>
A nova otimiza√ß√£o na gera√ß√£o de CSS do Next.js 14.2 estava reconhecendo a dupla barra (`//`) presente no `xmlns` de um `svg` como sendo o in√≠cio de um coment√°rio, o que resultava em um CSS inv√°lido, afetando a estiliza√ß√£o do visualizador de markdown.
O problema foi notado pelo @Rafatcb logo ap√≥s o merge do PR #1733 que atualizou diversas depend√™ncias.

## Mudan√ßas realizadas

Apenas removi o `xmlns` (namespaces XML) do `svg`, pois ele continha o valor padr√£o `http://www.w3.org/2000/svg`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Isso tem cara de ter sido causado por um Regex :confounded:
  > > √ìtima descoberta, Felipe!
  > > </pull_1734_Corrige o CSS gerado ap√≥s atualiza√ß√£o para o Next.js 14.2>

<pull_1735_Corrige par√¢metros de pagina√ß√£o para serem din√¢micos e incluir `with_root` e `with_children` em `GET /contents`>

## Mudan√ßas realizadas

Conforme discutido [nesse coment√°rio](https://github.com/filipedeschamps/tabnews.com.br/pull/1698#discussion_r1621260895), a altera√ß√£o visa permitir a inclus√£o de diferentes par√¢metros a serem considerados na pagina√ß√£o em diferentes endpoints. Um exemplo √© que agora o `strategy` n√£o √© verificado na pagina√ß√£o de `users`, apenas de `contents`.
Al√©m disso, agora os par√¢metros `with_root` e `with_child` s√£o retornados nos links de pagina√ß√£o.
A implementa√ß√£o n√£o ficou t√£o simples quanto eu gostaria, ent√£o caso algu√©m enxergue uma simplifica√ß√£o, ser√° de grande valia.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > A implementa√ß√£o n√£o ficou t√£o simples quanto eu gostaria, ent√£o caso algu√©m enxergue uma simplifica√ß√£o, ser√° de grande valia.
  > > Acredito que essas manipula√ß√µes deveriam ocorrer exclusivamente no `injectPaginationHeaders`, ent√£o adicionei um commit que reorganiza dessa forma, e acredito que tamb√©m ficou mais simples.
  > > Vejam se faz sentido... üí™
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Adicionei o array `acceptedParams` apenas para gerar os par√¢metros sempre na mesma ordem, j√° que isso √© importante, tanto para os testes, como para o cache.
  > > Mudar a ordem dos par√¢metros implica em uma URL diferente e, consequentemente, um novo cache, ent√£o tamb√©m seria interessante lidar com essa ordem no middleware, mas considero melhor trabalhar nisso em outro PR. ü§ù
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > N√£o sei se a diferen√ßa de desempenho compensa a corre√ß√£o disso em todos os testes existentes, mas, pelo menos nos novos testes, e nos que eu mexi por algum motivo, eu venho usando `toBe` para as compara√ß√µes de primitivos.
  > > Ent√£o eu substituiria estes `toStrictEqual` daqui, e `toEqual` do outro teste, por `toBe`:

```suggestion
      expect(responseLinkHeader.first.url).toBe(
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Em outros projetos, eu costumo usar `.toBe()` e `toEqual()` conforme o que √© mais adequado, ent√£o n√£o tenho nada contra essa altera√ß√£o.
> > </pull_1735_Corrige par√¢metros de pagina√ß√£o para serem din√¢micos e incluir `with_root` e `with_children` em `GET /contents`>

<pull_1736_Permite acessar a URL usando `http://ip:porta` durante o desenvolvimento>

## Mudan√ßas realizadas

O problema foi introduzido em #1110. Como utilizamos HTTP durante o desenvolvimento, e n√£o HTTPS, n√£o √© poss√≠vel fazer o upgrade no protocolo. Para resolver, agora a metatag CSP `upgrade-insecure-requests` est√° presente apenas quando o `webserver.host` utiliza o protocolo `https`.
Resolve #1263

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
  > > Review de aprendendofelipe (APPROVED):
  > > Maravilha! üí™
  > > </pull_1736_Permite acessar a URL usando `http://ip:porta` durante o desenvolvimento>

<pull_1737_Diminui idas ao banco de dados na edi√ß√£o de usu√°rios e na valida√ß√£o do token de confirma√ß√£o do e-mail>

## Mudan√ßas realizadas

Fiz algumas melhorias para diminuir as idas ao banco de dados e isso tamb√©m acabou simplificando algumas coisas. Similar ao processo que fizemos em #1729. Assim como no outro PR, fiz as altera√ß√µes em commits pequenos para facilitar a identifica√ß√£o (e poss√≠vel revers√£o) de cada etapa.

1. A atualiza√ß√£o do usu√°rio ocorria apenas pelo `username`, e em alguns lugares ocorria um `user.findOneById` apenas para poder passar o `username` para `user.update`. Como em todos os lugares que `user.update` √© chamado o `id` √© conhecido, agora o `user.update` utiliza `id` ao inv√©s de `username`.
2. No `user.update`, recebe `options.oldUser` para evitar uma nova busca pelo usu√°rio sem necessidade. Interface similar ao `content.update`, que recebe `options.oldContent`.
3. No `user.update`, ao inv√©s de chamar `balance.getTotal` duas vezes, faz como em `findOneById` e outras fun√ß√µes, buscando na mesma query que est√° sendo executada. Tamb√©m criei um teste onde o usu√°rio tem `tabcoins` e `tabcash` para garantir que o retorno estava correto.
4. N√£o valida o e-mail enviado caso seja o e-mail atual do usu√°rio.
5. Valida o `username` e `email` com uma √∫nica query.
6. N√£o busca o token de confirma√ß√£o de e-mail novamente apenas para validar se est√° expirado.
   Tamb√©m corrigi a fun√ß√£o `validatePatchSchema`, que estava marcada como ass√≠ncrona desnecessariamente.
   Houve a mudan√ßa no valor de `error_location_code` de um erro lan√ßado em `models/email-confirmation.js` e outro em `models/user.js`, n√£o sei se isso √© considerado breaking change. Se for, posso renomear o commit e marcar no PR que houve breaking change, ou ent√£o manter o `error_location_code` antigo (n√£o sei se isso faz sentido).

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Fiz algumas melhorias para diminuir as idas ao banco de dados e isso tamb√©m acabou simplificando algumas coisas. Similar ao processo que fizemos em #1729.
  > > Show de bola, @Rafatcb! üí™
  > > Aproveito para dar a not√≠cia de que ap√≥s o #1729 eu n√£o consegui encontrar nenhuma diferen√ßa pr√°tica nos usos de recursos. As mudan√ßas provavelmente s√≥ ser√£o um refresco ao sistema em momentos de picos de acessos, mas j√° ajuda. üëç
  > > Assim como no outro PR, fiz as altera√ß√µes em commits pequenos para facilitar a identifica√ß√£o (e poss√≠vel revers√£o) de cada etapa.
  > > A separa√ß√£o ajudou bastante na revis√£o. Uma pena que revisando por commits separadamente n√£o tem a funcionalidade do GitHub de marcar os arquivos que j√° foram analisados. Isso ajudaria bastante em PRs maiores. 2. No `user.update`, recebe `options.oldUser` para evitar uma nova busca pelo usu√°rio sem necessidade. Interface similar ao `content.update`, que recebe `options.oldContent`.
  > > Fiz uma sugest√£o alternativa ao `options.oldUser` e d√° para eliminar mais uma busca do usu√°rio.
  > > Deixei outros coment√°rios sobre a breaking change.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Vai deixar para outro PR a quest√£o que comentei em [#1730 (review)](https://github.com/filipedeschamps/tabnews.com.br/pull/1730#pullrequestreview-2173199925) ?
  >
  > N√£o mexi aqui porque n√£o tinha a ver com a proposta do PR, de diminuir as consultas ao BD, mas posso investigar.
  > N√£o tinha problema deixar para outro PR. O importante era aproveitar o contexto fresco na mem√≥ria para j√° implementar algo ainda mais importante. üëç
  > Ficou √≥timo! üéâ
  >
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Ao inv√©s de remover a `findOneValidTokenById`, pode remover tranquilamente a `findOneTokenById`.
  > > Com isso evita a breaking change em caso de token n√£o encontrado, e passa a devolver uma reposta mais correta em caso de token j√° utilizado.
  > > De qualquer forma vai precisar adequar um teste, mas acho que a mudan√ßa em `With an already used, but valid token` faz sentido e n√£o √© breaking change.
  > > Da√≠ a `findOneTokenById` s√≥ seria usada na `emailConfirmation.update`, mas que s√≥ √© utilizada nos testes, ent√£o pode ser ser passada para o `orchestrator` de forma mais simplificada para apenas atualizar a expira√ß√£o. E nem vai precisar de `findOneTokenById`.
  > > Caso n√£o ache essa proposta interessante, e queira manter a breaking change, ent√£o acho melhor dar uma nova reformulada porque `CHECK_IF_TOKEN_IS_EXPIRED` n√£o est√° muito legal com `NotFoundError`.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Ao inv√©s aceitar o `id` ou `username`, que tal aceitar um `targetUser`? Assim n√£o precisa de `options.oldUser`, mas mant√©m as otimiza√ß√µes feitas em `user.update`.
  > > E deve ser poss√≠vel fazer uma outra otimiza√ß√£o, que √© s√≥ buscar o `targetUser` no banco se o `targetUsername` for diferente de `userTryingToPatch.username`.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Para a API, eu manteria o padr√£o de usar "username" ao inv√©s de nome de usu√°rio.
  > > E acho que `VALIDATE_UNIQUE_EMAIL` e `VALIDATE_UNIQUE_USERNAME` continuam fazendo sentido mesmo com a nova fun√ß√£o `validateUniqueUser`, ent√£o podemos evitar a mudan√ßa no retorno da API nesse ponto e nos testes relacionados.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Para a API, eu manteria o padr√£o de usar "username" ao inv√©s de nome de usu√°rio.
  > > Durante a altera√ß√£o, pensei que a mensagem ficaria melhor assim, "em portugu√™s", por dois motivos distintos:

1. Essa mensagem √© exibida diretamente na interface do TabNews caso ocorra um erro, e outras interfaces podem fazer a mesma coisa, ao inv√©s de tentar tratar o erro e exibir uma mensagem personalizada. Logo, para usu√°rios faz mais sentido ler `nome de usu√°rio` (ou algo do tipo) do que `username`;
2. Mesmo com essa mudan√ßa, √© poss√≠vel identificar o nome do campo (`username`) pelo `key` no erro retornado.
   Com essas informa√ß√µes, ainda acha que dever√≠amos manter o uso do nome dos campos nas mensagens de erro? Se achar que sim, eu deixo `username`.
   > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
   > > Na API eu acho melhor `username` e na UI acho que a gente precisa adaptar as mensagens de erro recebidas da API. üòÖ
   > > Esse mapeamento das mensagens √© algo pendente, mas tamb√©m pouco priorit√°rio, dado ao tipo de p√∫blico do TabNews.
   > > S√≥ que isso que est√° pendente na vers√£o web, pode j√° ter sido feito por algum desenvolvedor que usa nossa API, ent√£o podemos quebrar algo deles.
   > > Mas foi s√≥ uma sugest√£o. N√£o √© algo que impediria o merge do PR ü§ù
   > > Coment√°rio de Rafatcb (linha de c√≥digo):
   > > Acho que as duas sugest√µes juntas ficaram confusas.
   > > Voc√™ diz para a interface da fun√ß√£o ser assim?

```js
async function update(targetUser, postedUserData, options = {})
```

E o `user.update` precisaria tomar o cuidado do objeto estar incompleto? Por exemplo, algo como:

```diff
-  const currentUser = options.oldUser ?? (await findOneById(userId, { transaction: options.transaction }));
+  const currentUser = 'username' in targetUser ? targetUser : (await findOneById(targetUser.id, { transaction: options.transaction }));
```

(ou alguma verifica√ß√£o melhor)

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Rafa, perd√£o pela falta de clareza. Tudo que voc√™ escreveu se refere √† sugest√£o 1, que √© apenas uma refatora√ß√£o para evitar passar `targetUser.id` e `targetUser` para a mesma fun√ß√£o. Inclusive concordo que **talvez** d√™ para fazer uma verifica√ß√£o melhor.

---

J√° a sugest√£o 2, essa sim √© uma otimiza√ß√£o extra, que √© neste trecho abaixo, onde voc√™ n√£o mexeu:
https://github.com/filipedeschamps/tabnews.com.br/blob/114679cfe8e1dc7dfcb5c6fc5390c8f877115847/pages/api/v1/users/%5Busername%5D/index.public.js#L79-L81
A n√£o ser quando √© um moderador editando outro usu√°rio, essa busca pelo `targetUser` n√£o √© necess√°ria, j√° que √© o mesmo que `userTryingToPatch`. Por isso falei em comparar os dois `usernames`.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Essas duas fun√ß√µes (`findOneValidTokenById` e `markTokenAsUsed`) tamb√©m podem ser unificadas em algo assim:

```js
async function markTokenAsUsedById(tokenId) {
  const query = {
    text: `
      UPDATE
        email_confirmation_tokens
      SET
        used = true,
        updated_at = (now() at time zone 'utc')
      WHERE
        id = $1
        AND used = false
        AND expires_at >= now()
      RETURNING
        *
    ;`,
    values: [tokenId],
  };
  const results = await database.query(query);
  if (results.rowCount === 0) {
    throw new NotFoundError({
      message: `O token de confirma√ß√£o de email utilizado n√£o foi encontrado no sistema ou expirou.`,
      action: "Solicite uma nova altera√ß√£o de email.",
      stack: new Error().stack,
      errorLocationCode:
        "MODEL:EMAIL_CONFIRMATION:FIND_ONE_VALID_TOKEN_BY_ID:NOT_FOUND",
      key: "token_id",
    });
  }
  return results.rows[0];
}
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Deixei essa altera√ß√£o no √∫ltimo commit (https://github.com/filipedeschamps/tabnews.com.br/pull/1737/commits/389fc3e09a1a01cd8506e63052880f3ce52e5f98), para ficar mais claro o que foi modificado.
> > Simplifiquei o m√°ximo que consegui.
> > </pull_1737_Diminui idas ao banco de dados na edi√ß√£o de usu√°rios e na valida√ß√£o do token de confirma√ß√£o do e-mail>

<pull_1738_Reserva `usernames` que podem ser usados para URLs da Revenue Share ou de outras funcionalidades>

## Mudan√ßas realizadas

Adiciona palavras aos `usernames` reservados para uso do sistema.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
      </pull_1738_Reserva `usernames` que podem ser usados para URLs da Revenue Share ou de outras funcionalidades>

<pull_1740_feat: add content type enum and column to contents table>
Baseado em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2220490103

## Mudan√ßas realizadas

Cria o `content_types_enum` que aceita os valores `content`, `pitch` e `ad`.
Adiciona a coluna `type` na tabela `contents` usando `content_types_enum` com o valor padr√£o `content`.
Obs. Vou deixar como draft porque a migration do PR #1638 j√° foi executada em homologa√ß√£o. Ent√£o vou criar uma vers√£o simplificada daquele PR para poder rodar a migration em produ√ß√£o antes desse aqui.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1740_feat: add content type enum and column to contents table>

<pull_1741_feat(firewall emails): send emails to users affected by firewall>
Traz a parte do PR #1638 que permite o envio de emails de aviso aos usu√°rios pegos pelo Firewall.
Isso √© importante porque pode acontecer de um usu√°rio n√£o se atentar √† mensagem de erro, e n√£o descobrir que outras publica√ß√µes podem ter sido apagadas. Al√©m de que pode acontecer de um usu√°rio ser impactado devido a outro usu√°rio na mesma rede, ent√£o agora todos os usu√°rios afetados s√£o notificados.
O principal do PR original, que √© a revers√£o dos ganhos, n√£o foi trazido para c√° porque ainda existem ajustes necess√°rios na funcionalidade de modera√ß√£o que permite reverter os efeitos do firewall.

## Mudan√ßas realizadas

- Permite o envio de emails para os usu√°rio pegos pelo firewall.
- Muda para `firewall` o status dos conte√∫dos pegos.
- Melhora as mensagens retornadas pela API em caso de eventos de firewall.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Foram adicionados testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1741_feat(firewall emails): send emails to users affected by firewall>

<pull_1742_Permite a cria√ß√£o de conte√∫dos do tipo `ad`>
O primeiro commit (a825ee610929cca58b266fba1c1be8cf85f37663) √© a parte principal de acordo com o que foi solicitado em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2222818707.
Os demais commits s√£o requisitos extras que podem ou n√£o fazer sentido, dependendo de qual √© o resultado final esperado, ent√£o deixei separado para ser f√°cil de reverter.

## Mudan√ßas realizadas

- a825ee610929cca58b266fba1c1be8cf85f37663: aceita o par√¢metro `type` na cria√ß√£o de conte√∫dos, cria a movimenta√ß√£o de TabCash na cria√ß√£o de an√∫ncios e impede a cria√ß√£o de an√∫ncios se n√£o houver saldo de TabCash suficiente.
- 5f8db02079a43cf17d5eb16e6b6c7a62b028a55b: garante com um teste que n√£o ser√° poss√≠vel criar coment√°rio com o tipo `ad`.
- ee3bd8ceade39028bcc7b822373e413b526c5cf9: impede que o usu√°rio ganhe TabCoins ao criar an√∫ncios (impede apenas o inicial).
- 3d159a9eb4a8d1f8c292ef2dec6bf19db2490ce3: retorna o tipo de conte√∫do publicamente na API.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Deixei um coment√°rio, mas j√° aprovei.
  > > Review de aprendendofelipe (COMMENTED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Esqueceu de remover o `oldContent`?
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Foi over engineering mesmo üòÖ
  > > Tem diversos casos que precisamos lidar, mas que eu n√£o implementei porque preciso entender melhor a ideia do Filipe. S√≥ que √© praticamente certo que iremos chamar essa fun√ß√£o no PATCH, ent√£o j√° deixei padronizada com a mesma interface de `creditOrDebitTabCoins`.
  > > Bora pro merge!
  > > </pull_1742_Permite a cria√ß√£o de conte√∫dos do tipo `ad`>

<pull_1743_feat(validator): add `classificados` to reserved usernames>
Para atender https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2225881693
</pull_1743_feat(validator): add `classificados` to reserved usernames>

<pull_1744_Identifica uma publica√ß√£o patrocinada na p√°gina dela (URL `/[username]/[slug]`)>

## Mudan√ßas realizadas

Conforme comentado em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2226440549 e discutido no issue em quest√£o, adicionei um `Label` para identificar uma publica√ß√£o patrocinada com a `variant="success"`. Eu havia experimentado usar a cor do TabCash, mas n√£o passa no teste de acessibilidade no modo claro.
| Cen√°rio | Resultado |
| -------------------------------- | --------- |
| Modo claro, cor do TabCash | |
| Modo escuro, cor do TabCash | |
| Modo claro, `variant="success"` | |
| Modo escuro, `variant="success"` | |
O teste de acessibilidade com a cor do TabCash:
| Modo claro | Modo escuro |
| ---------- | ----------- |
| | |
[Teste no WebAIM](https://webaim.org/resources/contrastchecker/?fcolor=2DA44E&bcolor=FFFFFF)
Apenas para mencionar, o Primer utiliza cores diferentes para a borda e a cor do texto (duas cores diferentes no modo claro, mais duas cores diferentes no modo escuro).

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1744_Identifica uma publica√ß√£o patrocinada na p√°gina dela (URL `/[username]/[slug]`)>

<pull_1745_feat(advertisement): adds `getRandom` function to retrieve random ads>
Essa √© uma parte da etapa 3a citada em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2226440549.

## Mudan√ßas realizadas

Cria o model `advertisement` com uma fun√ß√£o `getRandom` respons√°vel por devolver uma quantidade escolhida de publicidades aleat√≥rias.
Cada publicidade devolvida cont√©m apenas as propriedades b√°sicas necess√°rias para a UI: id, title, slug, owner_username, source_url e type. Sendo que `type` aqui √© o `ad_type` e n√£o o `content_type`, ent√£o por enquanto √© s√≥ `markdown`.
Foi criado o `/sponsored-beta` provisoriamente para facilitar os testes do novo model.
S√≥ n√£o estamos testando realmente a aleatoriedade, que foi deixada como responsabilidade para `ORDER BY RANDOM()` do PostgreSQL.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam **parcialmente** que o recurso funciona conforme esperado (menos a aleatoriedade).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (COMMENTED):
  > > Show! Deixei alguns coment√°rios, talvez o √∫nico importante seja o sobre `$required.content_type`.
  > > Vou trabalhar na UI da etapa 3a com base nessa branch (me avise caso j√° tenha come√ßado a trabalhar nela).
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Pronto para mesclar :+1:
  > > N√£o cheguei a fazer nada sobre a UI dessa etapa. Precisa de alguma ajuda?
  > > J√° est√° quase pronta, falta dar uma conferida final. Abrirei o PR em breve. Obrigado :handshake:
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Acho que esse nome n√£o ficou adequado. 4 an√∫ncios foram criados e 4 foram retornados. O que acha de `should return all ads`? Ou ent√£o, manter o t√≠tulo, por√©m criar mais de 30 an√∫ncios e verificar que 30 foram retornados (que √© o limite `per_page` padr√£o).
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Imagino que faltou mudar isso:

```suggestion
        .when('$required.ad_type', { is: 'required', then: Joi.required(), otherwise: Joi.optional() }),
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu ainda me atrapalho com o Joi, ent√£o n√£o sei ao certo, mas aqui n√£o deveria ser um link com `#ad` ao inv√©s de `#content`?

```suggestion
      children: Joi.array().optional().items(Joi.link('#ad')),
    })
      .required()
      .min(1)
      .id('ad');
```

Eu clonei a branch para testar eu mesmo, mas ou testei errado, ou n√£o teve diferen√ßa.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Aproveitando que provavelmente ter√° altera√ß√µes no c√≥digo, pode usar `toBe` aqui e nos outros testes:

```suggestion
      expect.soft(response.status).toBe(200);
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Boa! Eu n√£o tinha gostado do nome do √∫ltimo teste, ent√£o pensei em algo diferente, s√≥ que renomeei o teste errado... hahaha
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Os coment√°rios seguem como `content`.
> > Como o model por enquanto s√≥ tem o `getRandom`, que n√£o precisa devolver os coment√°rios, ent√£o nem todos os campos desse esquema est√£o sendo utilizados por enquanto.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ah, entendi. O `children` me confundiu; pensei que tinha algo a ver com a lista de conte√∫dos, e n√£o com a propriedade `children` presente no conte√∫do :sweat_smile:
> > </pull_1745_feat(advertisement): adds `getRandom` function to retrieve random ads>

<pull_1746_Exibe publica√ß√£o patrocinada (an√∫ncio) no topo da lista de conte√∫dos>

## Mudan√ßas realizadas

1. O primeiro commit corrige o _overflow_ no nome do autor nos itens da lista.
2. O segundo commit exibe um an√∫ncio no topo da lista de conte√∫dos (relevantes e recentes).
   P√°ginas alteradas:

- Relevantes (em todas p√°ginas).
- Recentes (em todas as abas e todas as p√°ginas).
  A UI foi implementada conforme sugerido em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2225881693, mas com a cor verde `success.fg` do Primer, porque a cor verde do TabCash n√£o passa no teste de acessibilidade no modo claro, conforme mencionado em https://github.com/filipedeschamps/tabnews.com.br/pull/1744.
  Tamb√©m precisei ver algumas possibilidades de cores no modo escuro, essas foram as op√ß√µes que levantei:
  | Op√ß√£o | Link normal | Link visitado |
  | ------------------------------------------------------ | ----------- | ------------- |
  | 1. Link `success.fg`, visitado `success.fg` | | |
  | 2. Link `success.fg`, visitado `fg.subtle` | | |
  | 3. Link `success.fg`, visitado `#568062` | | |
  | 3. (Modo escuro) Link `success.fg`, visitado `#59a263` | | |
  Achei o modo 3 mais adequado, por isso coloquei tanto o modo claro quanto o escuro. Como podem ver, a cor do link visitado √© diferente para cada modo para passar no teste de acessibilidade. A cor do link visitado foi escolhida visando lembrar um link normal visitado do TabNews (cinza) ao mesmo tempo que demonstra que o link √© um an√∫ncio (verde), ent√£o s√£o tons de verde acinzentado.
  Dessa forma, as cores s√£o:
  | Link | Modo claro | Modo escuro |
  | -------- | ---------- | ----------- |
  | Normal | `#1a7f37` | `#3fb950` |
  | Visitado | `#568062` | `#59a263` |
  Agora, uma imagem de um an√∫ncio com link externo e com o maior t√≠tulo poss√≠vel (p√°gina 2 de Recentes):
  Na p√°gina Relevantes, mobile (375 pixels de largura):
  O conte√∫do aparece duas vezes porque a lista de conte√∫dos ainda retorna an√∫ncios
  Sobre a implementa√ß√£o do tema personalizado, o Primer [recomenda](https://primer.style/react/theming#customizing-the-theme) usar a biblioteca [`deepmerge`](https://www.npmjs.com/package/deepmerge), o que simplificaria o c√≥digo, ent√£o se acharem mellhor, posso adicion√°-la.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Show Rafa! üí™

### Link Visitado

Tamb√©m acho que os links dos an√∫ncios n√£o deveriam ser marcados como visitados.
Imagino o caso de um novo an√∫ncio, que leva para uma nova vers√£o de uma landing page, mas que est√° dispon√≠vel no mesmo endere√ßo de uma landing page antiga, e poderia ficar marcada como j√° visitada, justamente para o p√∫blico que se interessou na primeira vers√£o, ent√£o atrapalha o remarketing.
Mas n√£o √© algo que impediria o merge, pois do jeito que est√° acho que ficou bem dif√≠cil de diferenciar.

### Tamanho do T√≠tulo

Por enquanto que estamos experimentando, podemos s√≥ cortar o t√≠tulo, mas quando entendermos o tamanho adequado, acho melhor limitar pelo validador.
Concordo que 70 √© um bom n√∫mero para testar. üëç

### Mensagem Abaixo do An√∫ncio

Acho que tem muito texto ali, o que compete com o pr√≥prio an√∫ncio. O que acham de apenas "Promovido por fulano". E depois mostrar mais detalhes ao clicar no √≠cone de info.

> > Review de aprendendofelipe (COMMENTED):
> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que n√£o √© bom adicionar um `nofollow`?

```js
rel={isTrustedDomain(link) ? undefined : 'nofollow'}
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se for mudar mais alguma coisa no c√≥digo. Tenta isto:

```suggestion
  const title = ad.title.length > 70
      ? ad.title.substring(0, 67).trim().concat('...')
      : ad.title;
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > √â sim. Eu tinha pensado nisso antes de iniciar o desenvolvimento, mas depois que comecei, n√£o lembrei :sweat_smile:
> > </pull_1746_Exibe publica√ß√£o patrocinada (an√∫ncio) no topo da lista de conte√∫dos>

<pull_1747_Ajusta UI para criar uma publica√ß√£o patrocinada>

## Mudan√ßas realizadas

Esse PR implementa a etapa 3d mencionada em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2226440549.

1. Adiciona um `Checkbox` na tela `/publicar` para criar uma publica√ß√£o patrocinada.
2. Atualiza√ß√£o no FAQ para facilitar a orienta√ß√£o dos usu√°rios. O link para o FAQ foi adicionado na `Checkbox` em `/publicar`.
   Acredito que seja importante informar o usu√°rio o que for relevante para ele se sentir seguro em criar a publica√ß√£o patrocinada. Por ora, coloquei como "per√≠odo de dura√ß√£o" o que foi exemplificado em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2226912945, ou seja, um consumo de 10 TabCash por dia. Apesar disso n√£o estar implementado, imagino que implementaremos a tempo, ou lidaremos de forma manual para remover as publica√ß√µes antigas (>10 dias).
   Al√©m disso, tamb√©m falei sobre o tamanho recomendado para o t√≠tulo (< 70 caracteres, veja o PR #1746), sobre onde a publica√ß√£o √© exibida e como funciona o link (fonte) dela.
   Na pergunta _"Como funciona uma publica√ß√£o patrocinada?"_, coloquei o aviso it√°lico de que esse tipo de an√∫ncio est√° em desenvolvimento para que as pessoas n√£o fiquem surpresas com mudan√ßas e possam entender melhor o que est√° por vir, caso tenham interesse.
   Tela `/publicar`:
   Dispositivo m√≥vel (326 pixels de largura):
   O valor do `Checkbox` est√° sendo salvo no `localStorage` assim como o dos outros campos. Al√©m disso, ele √© exibido apenas na cria√ß√£o de publica√ß√£o, e n√£o na cria√ß√£o de coment√°rio ou edi√ß√£o. O `Checkbox` est√° sempre habilitado, mas caso o usu√°rio n√£o tenha TabCash o suficiente, uma mensagem de erro √© exibida no `Flash`.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (DISMISSED):
  > > Show de bola @Rafatcb! üéâ
  > > Desse jeito nem vai dar tempo de ter o beta s√≥ pela API. üòÖ
  > > Na verdade, como o #1746 j√° est√° em produ√ß√£o, j√° estamos com o beta valendo, mas ainda ningu√©m aproveitou.
  > > Fiz um coment√°rio, mas j√° est√° aprovado.

---

E o 3c vai ficar para depois, pois est√° dando mais trabalho do que eu esperava.
Remover os an√∫ncios da listagem foi tranquilo, mas fazer eles aparecerem s√≥ na p√°gina do usu√°rio est√° mais complexo do que deveria. N√£o consegui fazer o validador funcionar ao mesmo tempo com `$or: [{ type: 'content' }, { type: 'ad' }]` e `$or: [{ status: 'draft' }, { status: 'published' }]`. Parece ter um bug no `Joi.items` com mais de um `Joi.link`, pois s√≥ funciona o que eu inserir primeiro.

> > Review de Rafatcb (COMMENTED):
> > Review de aprendendofelipe (APPROVED):
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O que acham de `consumidos` no lugar de `utilizados`?

```suggestion
                Ser√£o consumidos 100 TabCash para criar a publica√ß√£o patrocinada.
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Por mim, tudo bem. Vou esperar o @filipedeschamps dar uma olhada, assim ajusto tudo o que for sugerido de uma vez :+1:
> > </pull_1747_Ajusta UI para criar uma publica√ß√£o patrocinada>

<pull_1748_N√£o listar an√∫ncios em relevantes, RSS e `/contents`>
Parte da etapa 3c citada em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2226440549.

## Mudan√ßas realizadas

Altera o validador e o model content para permitir passar um array como filtro para os campos `id`, `status` e `type`, eliminando assim a necessidade do filtro `$or`.
J√° remove os an√∫ncios das listas de relevantes, RSS e `/contents`, mas ainda mant√©m em `/username` e `/recentes` por ainda depender de alguns detalhes citados em #1749.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Substituir o `$or` por um array me parece fazer sentido, visto que s√£o condi√ß√µes na mesma coluna. √â uma simplifica√ß√£o que eu j√° sugeri em outros PRs tamb√©m, s√≥ n√£o me lembro se chegou a ser mesclada ou se foram apenas no PR #1638, que ainda est√° aberto.
  > > A altera√ß√£o no `validator` para permitir array em `type` √© um adiantamento para permitir filtrar `content OR pitch` num PR futuro? E em `id` √© para facilitar o rebase no PR #1638? Ou voc√™ j√° est√° implementando algo que precisou dessas valida√ß√µes?
  > > </pull_1748_N√£o listar an√∫ncios em relevantes, RSS e `/contents`>

<pull_1749_Adiciona p√°gina `/classificados` em recentes e no perfil dos usu√°rios>
Draft da tapa 3e citada em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2226440549.

## Mudan√ßas realizadas

Por enquanto adicionei as abas de classificados junto com as abas de recentes e dos usu√°rios. Assim n√£o temos problemas com o Header:
Da√≠ na aba "Todos", at√© pelo nome dela, acho que faz sentido continuar mostrando tudo, inclusive os `ads`, mas a√≠ preciso de opini√µes sobre alguns pontos, e por isso vou deixar o PR como _draft_.
N√£o sei se faz sentido mostrar um an√∫ncio destacado nessa p√°gina que j√° pode conter an√∫ncios na listagem. Vejam:
E, se os an√∫ncios v√£o aparecer listados junto com os outros conte√∫dos, acham que vale a pena diferenciar eles de alguma forma? Por exemplo como no estudo anterior:
Outra quest√£o que j√° trouxe para c√° √© sobre os c√°lculos de ganhos de TabCoins (di√°rios e ao publicar). Os ganhos se baseiam em qualifica√ß√µes recebidas anteriormente. Eu acredito que s√≥ devemos considerar as qualifica√ß√µes passadas para os tipos `content`. Sem considerar as qualifica√ß√µes dos an√∫ncios. Concordam?

## Tipo de mudan√ßa

- [x] Nova funcionalidade
  > > Review de Rafatcb (COMMENTED):
  > > N√£o sei se faz sentido mostrar um an√∫ncio destacado nessa p√°gina que j√° pode conter an√∫ncios na listagem.
  > > Acho que faz sentido sim, visto que √© o an√∫ncio que est√° recebendo o destaque.
  > > E, se os an√∫ncios v√£o aparecer listados junto com os outros conte√∫dos, acham que vale a pena diferenciar eles de alguma forma?
  > > Assim como o Filipe, tamb√©m acho que faz sentido. Isso ajuda o usu√°rio a entender o que est√° vendo sem precisar lembrar do contexto maior, isto √©, identificar que as publica√ß√µes s√£o patrocinadas sem precisar ver que est√° na p√°gina "Classificados".
  > > Outra quest√£o que j√° trouxe para c√° √© sobre os c√°lculos de ganhos de TabCoins (di√°rios e ao publicar). Os ganhos se baseiam em qualifica√ß√µes recebidas anteriormente. Eu acredito que s√≥ devemos considerar as qualifica√ß√µes passadas para os tipos `content`. Sem considerar as qualifica√ß√µes dos an√∫ncios. Concordam?
  > > Tamb√©m concordo. Pode criar testes para garantir isso (_imagino que voc√™ estava aguardando se n√≥s concordar√≠amos ou n√£o, antes de criar os testes_).

---

> Agora, fico na d√∫vida entre `Patrocinado` (sponsored) e `An√∫ncio` (ad).
> Considero "Patrocinado" melhor por ser f√°cil de associar que o an√∫ncio criado atrav√©s da p√°gina `/publicar` (PR #1747), que tem um `Checkbox` _"Criar como publica√ß√£o patrocinada"_, √© justamente o que o usu√°rio est√° vendo no momento.
> Se n√£o existirem outros tipos de an√∫ncio, isto √©, todos serem criados pelo mesmo lugar e terem o mesmo tipo de comportamento (como estamos fazendo agora), ent√£o n√£o tem problema chamar de "An√∫ncio" (e talvez seja at√© melhor, por ser mais claro para quem n√£o conhece). Nesse caso, acredito que seria necess√°rio mudar o PR #1747 tamb√©m para usarmos apenas a palavra "An√∫ncio" ao inv√©s do termo "Publica√ß√£o patrocinada".
>
> > Review de Rafatcb (APPROVED):
> > Meu √∫nico coment√°rio sobre este PR era sobre os testes mesmo (eu j√° havia revisado tudo).
> > Ainda preciso revisar o #1751. Sua sugest√£o faz sentido para mim, e mesclando o #1751 j√° n√£o teria nenhum impeditivo para mesclar os outros dois tamb√©m.
> > </pull_1749_Adiciona p√°gina `/classificados` em recentes e no perfil dos usu√°rios>

<pull_1751_Armazenar dados de TabCash dos an√∫ncios>
Implementa a parte 3f citada em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2226440549

## Mudan√ßas realizadas

Cria a tabela `ad_tabcash_operations` seguindo praticamente a mesma l√≥gica das outras tabelas `operations`, mas com uma pequena melhoria que facilita alguns tipos de consultas que hoje s√£o complexas nas outras tabelas. Por exemplo buscar se um usu√°rio j√° votou em um conte√∫do, desfazer votos (seja no banimento ou arrependimento), buscar quais conte√∫dos um usu√°rio interegiu, etc.
A utiliza√ß√£o de ENUM n√£o √© a diferen√ßa relevante, mas sim usar `user` ao inv√©s de `event` em `originator_type` e, consequentemente, o `id` do usu√°rio em `originator_id`. Com essa pequena mudan√ßa n√≥s n√£o perdemos nada, mas facilitamos muito a cria√ß√£o de outras funcionalidades.
Apenas para demonstrar que n√£o perdemos nada com essa mudan√ßa (s√≥ ganhamos), adicionei o segundo commit aplicando a mesma l√≥gica na tabela `content_tabcoin_operations`. Todos os testes continuam passando, e s√≥ foi preciso adequar o trecho de c√≥digo que desfaz as transa√ß√µes no momento de banimento. A mudan√ßa √© para algo mais simples, sem precisar iterar em `userEvents` ao buscar as transa√ß√µes pelo id do usu√°rio:

```js
for (const userEvent of userEvents) {
  const eventBalanceOperations = await balance.findAllByOriginatorId(
    userEvent.id,
    options
  );
  for (const eventBalanceOperation of eventBalanceOperations) {
    await balance.undo(eventBalanceOperation, options);
  }
}
```

vs

```js
const userBalanceOperations = await balance.findAllByOriginatorId(
  userId,
  options
);
for (const userBalanceOperation of userBalanceOperations) {
  await balance.undo(userBalanceOperation, options);
}
```

Obs. O trecho com o loop extra ainda √© necess√°rio para as tabelas `user_tabcoin_operations` e `user_tabcash_operations`, que ainda usam o `originatorType: 'event'`.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > √ìtima melhoria :+1:
  > > </pull_1751_Armazenar dados de TabCash dos an√∫ncios>

<pull_1752_Identifica publica√ß√µes patrocinadas na lista de conte√∫dos>

## Mudan√ßas realizadas

As publica√ß√µes patrocinadas s√£o exibidas em listas nas p√°ginas `/recentes/todos`, `/recentes/classificados` e `/[username]/classificados/1`. Nesses casos, podemos identific√°-las como "Patrocinado", conforme j√° foi sugerido em #1491.
Acham que faz sentido adicionar um Tooltip com alguma informa√ß√£o? A princ√≠pio, n√£o me pareceu necess√°rio. Em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-1987356263, foi levantada a possibilidade de exibir os TabCoins.

### Todos recentes (modo claro, desktop, 1070px de largura)

### Classificados (modo escuro, mobile, 336px de largura)

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1752_Identifica publica√ß√µes patrocinadas na lista de conte√∫dos>

<pull_1753_Corrige espa√ßo em branco na lateral da p√°gina de conte√∫do causado pelo banner de an√∫ncio>

## Mudan√ßas realizadas

Corrige o espa√ßo em branco na lateral da p√°gina de conte√∫do causado pelo banner, apontado em https://github.com/filipedeschamps/tabnews.com.br/pull/1747#issuecomment-2234986931.
O `width` deixou de ser necess√°rio conforme foram feitas altera√ß√µes no PR original, e esse problema n√£o havia sido percebido. Fiz testes locais com textos de an√∫ncio longos e curtos, e o `width` n√£o pareceu mais necess√°rio, ent√£o remov√™-lo resolveu o problema.
Como fica dif√≠cil mostrar que o scroll horizontal n√£o existe por GIF ou v√≠deo, vou deixar prints com t√≠tulos longos e curtos para mostrar que eles continuam exibidos corretamente:

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > Pode ser que ainda d√™ algum problema, mas amanh√£ eu testo melhor ü§ù
  > > Bora pro merge!
  > > </pull_1753_Corrige espa√ßo em branco na lateral da p√°gina de conte√∫do causado pelo banner de an√∫ncio>

<pull_1754_fix(ad banner): limits overflow of Tooltip's mirrored invisible div>

## Mudan√ßas realizadas

Em conjunto com o PR #1753, corrige o espa√ßo em branco na lateral da p√°gina de conte√∫do causado pelo banner, apontado em https://github.com/filipedeschamps/tabnews.com.br/pull/1747#issuecomment-2234986931.
Dependendo do tamanho da tela e das personaliza√ß√µes de tamanho de fontes, o problema ainda poderia ocorrer, pois a `div` invis√≠vel do nosso Tooltip customizado n√£o respeitava o `overflow: hidden` do `Link`, mas agora respeita o do `Text` superior.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
  > > Review de Rafatcb (APPROVED):
  > > </pull_1754_fix(ad banner): limits overflow of Tooltip's mirrored invisible div>

---

<pull*1755*[C.I.] Remove o cache da pasta `/.next/cache` e atualiza as outras `actions`>
Remove a action `cache@v2` que armazenava um cache da pasta `/.next/cache` que n√£o trazia nenhum ganho.
Aproveitei para atualizar as demais `actions`, menos a `wagoid/commitlint-github-action` que n√£o deu para ir para a `v6` por causa da [breaking change com `commitlint.config.js`](https://github.com/wagoid/commitlint-github-action/blob/master/CHANGELOG.md#600-2024-03-28).

> > Review de Rafatcb (APPROVED):
> > </pull*1755*[C.I.] Remove o cache da pasta `/.next/cache` e atualiza as outras `actions`>

---

<pull_1757_Filtrar an√∫ncios nas p√°ginas de conte√∫dos>

## Mudan√ßas realizadas

Adiciona filtros na fun√ß√£o `getRandom` para permitir:

- Preferir mostrar an√∫ncios do pr√≥prio usu√°rio em seus conte√∫dos
- N√£o mostrar an√∫ncios de outros usu√°rios nas p√°ginas de an√∫ncios
- Nunca mostrar no banner o mesmo an√∫ncio que est√° sendo visitado
  Com isso atende ao sugerido em https://github.com/filipedeschamps/tabnews.com.br/pull/1747#issuecomment-2234325715 e resolve #1756 .

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1757_Filtrar an√∫ncios nas p√°ginas de conte√∫dos>

<pull_1759_Clarifica no FAQ o que acontece quando o or√ßamento do an√∫ncio acaba>

## Mudan√ßas realizadas

Surgiu uma [d√∫vida no TabNews](https://www.tabnews.com.br/kht/65d8ac80-a237-4e55-bc45-118d51264b9e) sobre o que acontece quando o or√ßamento da publica√ß√£o patrocinada acaba. Essa altera√ß√£o no FAQ √© para deixar isso mais claro.
Aproveitei para introduzir o termo _banner_ porque facilita a explica√ß√£o de que, sem or√ßamento, o an√∫ncio n√£o aparecer√° como um banner.
Caso tenham sugest√µes para melhorar essa parte de publica√ß√µes patrocinadas no FAQ, sintam-se √† vontade.

## Tipo de mudan√ßa

- [x] Atualiza√ß√£o do FAQ

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Review de filipedeschamps (COMMENTED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > N√£o apenas pelos questionamentos que tivemos hoje, mas eu j√° estava querendo fazer a sugest√£o abaixo. Da√≠ acabo de assistir a [aula de hoje do curso.dev](https://curso.dev/web/git-commit-escopo), e vejo o PR aberto, tudo relacionado... haha... Ent√£o l√° vai...
  > > Acredito que devemos adicionar aqui no FAQ apenas o que j√° estiver implementado. Ou ent√£o deixar bem claro que √© s√≥ um plano futuro e que pode mudar. Por isso, eu removeria a maior parte desse trecho.

```suggestion
Para criar uma publica√ß√£o patrocinada, voc√™ investir√° **100 TabCash** no or√ßamento dela. Ainda n√£o est√° definido como o or√ßamento ser√° consumido e ainda n√£o √© poss√≠vel alterar o valor do or√ßamento.
```

---

Ao inv√©s de fazer a atividade proposta na aula de hoje l√° dentro da plataforma do curso, vou fazer aqui mesmo. üòÖ
√â para dar a opini√£o sobre a mudan√ßa na documenta√ß√£o entrar no mesmo commit da altera√ß√£o no c√≥digo. Eu acredito que depende se a mudan√ßa na documenta√ß√£o √© obrigat√≥ria ou opcional. Se a mudan√ßa no c√≥digo torna a documenta√ß√£o obsoleta, ent√£o ela deve obrigatoriamente ser atualizada junto. J√° se a mudan√ßa no c√≥digo apenas abre novas possibilidades, sem modificar as anteriores, ent√£o acredito que a atualiza√ß√£o da documenta√ß√£o √© uma etapa seguinte na evolu√ß√£o natural do projeto, ent√£o pode vir em um commit posterior.

> > Coment√°rio de filipedeschamps (linha de c√≥digo):
> > Da√≠ acabo de assistir a [aula de hoje do curso.dev](https://curso.dev/web/git-commit-escopo), e vejo o PR aberto, tudo relacionado... haha...
> > N√£o to conseguindo acreditar at√© agora o timing disso tudo üòÇ üòÇ üòÇ ü§ù
> > </pull_1759_Clarifica no FAQ o que acontece quando o or√ßamento do an√∫ncio acaba>

<pull_1760_N√£o trocar o an√∫ncio vis√≠vel a cada revalida√ß√£o da p√°gina>
Como os an√∫ncios variam aleatoriamente a cada gera√ß√£o das p√°ginas est√°ticas no lado do servidor, n√£o √© interessante trocar o an√∫ncio vis√≠vel no client apenas porque a p√°gina foi revalidada em segundo plano.
Por exemplo, os an√∫ncios ficam se alternando quando o usu√°rio alterna entre abas abertas ou quando a p√°gina √© automaticamente revalidada instantes ap√≥s o carregamento, quando o cache dela est√° obsoleto. Isso ficou mais claro agora que temos uma variedade maior de an√∫ncios publicados.

## Mudan√ßas realizadas

Agora, o an√∫ncio vis√≠vel s√≥ vai mudar quando ocorrer uma navega√ß√£o entre diferentes p√°ginas.
Uma melhoria futura pode ser permitir trocar o an√∫ncio na p√°gina deixada aberta, mas somente ap√≥s algum tempo.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
  > > Review de Rafatcb (APPROVED):
  > > </pull_1760_N√£o trocar o an√∫ncio vis√≠vel a cada revalida√ß√£o da p√°gina>

<pull_1765_Cria endpoint para obter dados relacionados √† um evento do firewall interno>

## Mudan√ßas realizadas

Estava organizando o PR #1638 e consegui separar uma funcionalidade que j√° pode ser mesclada hoje, o que ir√° facilitar a revis√£o do outro PR.
O endpoint `GET /api/v1/events/firewall/[id]` foi criado para obter os dados relacionados √† um evento do nosso firewall interno, que hoje s√£o apenas os eventos: `firewall:block_contents:text_child`, `firewall:block_contents:text_root` e `firewall:block_users`.
Para um usu√°rio conseguir utilizar este endpoint, precisar√° da feature `read:firewall`.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Show @Rafatcb! üí™
  > > Tudo que der para separar do #1638 j√° ajuda. üëç
  > > N√£o revisei tudo, mas fui direto no ponto que acho que era a principal pend√™ncia no #1638, que √© nos eventos consecutivos que nem sempre ter√£o metadados iguais.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (DISMISSED):
  > > Removi `users` de `firewall/event-types` porque n√£o √© mais utilizado.
  > > Removi a `snakeize` de `event` e mudei `originatorUserId` e `originatorIp` para `snake_case` em todos os locais que criavam o evento.
  > > Ent√£o j√° fiz squash dos commits, deixando um espec√≠fico para a mudan√ßa para `snake_case` e o restante no segundo commit.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > No coment√°rio https://github.com/filipedeschamps/tabnews.com.br/pull/1638#discussion_r1607331459 do outro PR eu digo que os testes passariam se usasse `=` no lugar de `@>` para apontar que a implementa√ß√£o e os testes n√£o est√£o considerando os casos reais que nem sempre ser√£o simult√¢neos.
  > > At√© cito que talvez seja necess√°rio usar algo como abaixo:

```sql
  events.metadata @> searched_event.metadata OR
  events.metadata <@ searched_event.metadata
```

Ser√° que estou enxergando problema onde n√£o existe?

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu havia criado um commit separado, na √©poca, que criava testes para isso e corrigia o comportamento em alguns locais que n√£o estavam funcionando de forma adequada, mas fiquei sem resposta (https://github.com/filipedeschamps/tabnews.com.br/pull/1638#discussion_r1650198193).
> > No momento, o link para o commit em quest√£o √© https://github.com/filipedeschamps/tabnews.com.br/pull/1638/commits/037521257e1685afa9ec2dd7bead7973ecef93f9. No `GET` existe o teste `With two consecutive "firewall:block_users" events from the same IP`, por exemplo, que mostra como √© a resposta no caso de quatro tentativas de a√ß√£o consecutivas (`sucesso, sucesso, erro, erro`). No outro PR, existe o `describe` `Different firewall events containing an element in common` no endpoint de `review_firewall`, que mostra um outro cen√°rio, com cinco tentativas de a√ß√£o, mas com um intervalo de tempo, ent√£o o resultado √© `sucesso, sucesso, erro, sucesso, erro`.
> > Se esses testes n√£o est√£o considerando os casos que voc√™ imaginou, n√£o entendi quais seriam os testes esperados. E se esses testes n√£o est√£o com o comportamento esperado, preciso entender qual seria o esperado.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Isso, os testes consideram exatamente o caso que estou falando, mas os `expect`s est√£o apenas confirmando o resultado estranho, n√£o o requisito que era desfazer ou confirmar todos os eventos relacionados passando o `id` de qualquer dos eventos.
> > Ser√° que estamos interpretando de maneiras diferentes o que s√£o "eventos relacionados" e a raz√£o de ter sido criada a `findAllRelatedEvents`?
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Ser√° que estamos interpretando de maneiras diferentes o que s√£o "eventos relacionados" e a raz√£o de ter sido criada a `findAllRelatedEvents`?
> > A resposta para isso √© f√°cil de descobrir: o array `events` retornado est√° sempre como voc√™ espera? Se sim, ent√£o estamos falando sobre as mesmas coisas e os eventos relacionados s√£o esses mesmos.
> > Se os eventos retornados no `GET` n√£o s√£o os esperados, ent√£o te pe√ßo para me dizer um cen√°rio de exemplo, assim eu consigo visualizar o mesmo problema que voc√™, e ent√£o eu crio um teste que ir√° quebrar para poder corrigir esse comportamento.
> > os `expect`s est√£o apenas confirmando o resultado estranho, n√£o o requisito que era desfazer ou confirmar todos os eventos relacionados passando o `id` de qualquer dos eventos.
> > Se o √∫nico problema √© na confirma√ß√£o ou anula√ß√£o dos eventos relacionados ao firewall, e o `GET` est√° correto, ent√£o o mais adequado √© discutir isso no outro PR.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Ser√° que estamos interpretando de maneiras diferentes o que s√£o "eventos relacionados" e a raz√£o de ter sido criada a `findAllRelatedEvents`?
>
> A resposta para isso √© f√°cil de descobrir: o array `events` retornado est√° sempre como voc√™ espera? Se sim, ent√£o estamos falando sobre as mesmas coisas e os eventos relacionados s√£o esses mesmos.
> N√£o tem nenhum teste cobrindo isso para o `GET`, mas, pelo c√≥digo, acho que n√£o est√° retornando de acordo com o que foi conversado no #1638 e que originou a necessidade da `findAllRelatedEvents`.
> A primeira implementa√ß√£o de `findAllRelatedEvents` parece que estava mais alinhada com a motiva√ß√£o original, pois usou o `@>`, e s√≥ faltou considerar o caso `<@`. Mas depois mudou para s√≥ retornar eventos com metadados iguais (`=`), se afastando da motiva√ß√£o original.
> Seria √≥timo testar o `GET` com um caso igual ao do teste `Different firewall events containing an element in common`. L√° temos dois eventos relacionados, mas que a implementa√ß√£o atual n√£o trata como relacionados. O teste em quest√£o n√£o usa o GET, nem precisa, mas s√≥ por permitir confirmar um evento e desfazer o outro, d√° para ver que foram tratados como eventos independentes. S√≥ que n√£o s√£o independentes, tanto que precisou justificar o resultado do teste com o coment√°rio `User 2 is nuked because of the previous confirmed firewall event`. L√°, no primeiro POST j√° deveria agir em todos os relacionados, e ao tentar confirmar ou desfazer pela segunda vez, deveria cair na condi√ß√£o `MODEL:FIREWALL:VALIDATE_AND_GET_FIREWALL_EVENT_TO_REVIEW:EVENT_ALREADY_REVIEWED`.
> Se n√£o foi esse o comportamento que foi debatido no #1638, ent√£o √© melhor retomarmos esse ponto, mas acho que aqui √© melhor, pois tem mais afinidade com o `GET`.
>
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Certo, vou criar o teste para o cen√°rio `sucesso, sucesso, erro, sucesso, erro`, com a "passagem de tempo" para os conte√∫dos/usu√°rios do primeiro evento n√£o estarem todos contidos no segundo.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Para buscar dois eventos onde `metadata.contents` ou `metadata.users` s√£o parcialmente contidos no evento que est√° sendo buscado, e que tenha a mesma `metadata.from_rule`, a compara√ß√£o sugerida n√£o parece funcionar. O SQL simplificado abaixo retorna apenas o evento buscado:

```sql
WITH searched_event AS (
  SELECT
    id,
    metadata
  FROM
    events
  WHERE
    id = $1
  LIMIT
    1
)
SELECT
  *
FROM
  events
INNER JOIN
  searched_event ON events.id = searched_event.id
WHERE
  events.metadata @> searched_event.metadata OR
  events.metadata <@ searched_event.metadata
```

O mais pr√≥ximo que cheguei foi com uma compara√ß√£o bem espec√≠fica, do `metadata.contents` e `metadata.users`:

```sql
WITH searched_event AS (
  SELECT
    *
  FROM
    events
  WHERE
    id = $1
  LIMIT
    1
),
searched_event_users AS (
  SELECT
    jsonb_array_elements_text(metadata->'users') AS user_id
  FROM
    searched_event
),
searched_event_contents AS (
  SELECT
    jsonb_array_elements_text(metadata->'contents') AS content_id
  FROM
    searched_event
),
matching_events AS (
  SELECT
    events.*
  FROM
    events
LEFT JOIN searched_event ON true
  LEFT JOIN LATERAL (
    SELECT
      jsonb_array_elements_text(events.metadata->'users') AS user_id
  ) event_users ON TRUE
  LEFT JOIN LATERAL (
    SELECT
      jsonb_array_elements_text(events.metadata->'contents') AS content_id
  ) event_contents ON TRUE
  WHERE
  events.id <> searched_event.id AND (
    EXISTS (
      SELECT 1
      FROM searched_event_users
      WHERE searched_event_users.user_id = event_users.user_id
    )
    OR EXISTS (
      SELECT 1
      FROM searched_event_contents
      WHERE searched_event_contents.content_id = event_contents.content_id
    )
  )
)
SELECT * FROM searched_event
UNION ALL
SELECT * FROM matching_events
;
```

N√£o ficou uma query simples, e n√£o √© de f√°cil manuten√ß√£o. Quando surgir mais um evento que n√£o use `metadata.users` ou `metadata.contents`, a query precisar√° ser modificada adicionando um novo cursor, mais um `LEFT JOIN LATERAL` e mais um `OR EXISTS...`.
N√£o terminei as altera√ß√µes no c√≥digo e por isso n√£o subi para o PR, mas decidi compartilhar a query para caso algu√©m saiba uma forma mais simples. Esse `SELECT` n√£o verifica o `metadata.from_rule`, ent√£o seria mais uma condi√ß√£o para adicionar nele.

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > O SQL simplificado abaixo retorna apenas o evento buscado:
> > Na verdade, `@>` junto de `<@` busca apenas os eventos em que todos os afetados de um est√£o contidos no outro, e s√≥ um deles poderia ter itens a mais. Isso realmente n√£o ia atender a todos os casos de teste que precisamos, pois tamb√©m precisamos buscar casos de intersec√ß√£o de afetados.
> > N√£o terminei as altera√ß√µes no c√≥digo e por isso n√£o subi para o PR, mas decidi compartilhar a query para caso algu√©m saiba uma forma mais simples.
> > Abaixo tem uma forma que acredito ser mais simples. E considerando os testes atuais, aparentemente s√≥ precisa ajustar um deles para n√£o depender da ordem dos itens no array, pois a consulta n√£o garante a ordem dos itens afetados. O teste `With two consecutive "firewall:block_users" events from the same IP`.
> > Mas como precisa criar os diversos casos de teste dos eventos relacionados, eu comecei a ver isso, mas percebi que √© preciso modificar tamb√©m a fun√ß√£o `findByEventId` e as que ela chama, pois ali tamb√©m n√£o considera que os metadados de diferentes eventos podem n√£o ser iguais, j√° que usa apenas os dados do √∫ltimo evento:

```js
const affectedData = await getAffectedData(relatedEvents.at(-1));
```

N√£o tive tempo de ajustar a `findByEventId`, mas deixo o exemplo de consulta que retorna todos os eventos de firewall relacionados:

```sql
    WITH RECURSIVE related_events AS (
      SELECT
        id,
        metadata->>'original_event_id' AS original_event_id,
        jsonb_array_elements_text(metadata->'contents') AS content_id,
        jsonb_array_elements_text(metadata->'users') AS user_id
      FROM
        events
      WHERE
        id = $1
    UNION
      SELECT
        e.id,
        e.metadata->>'original_event_id' AS original_event_id,
        jsonb_array_elements_text(e.metadata->'contents') AS content_id,
        jsonb_array_elements_text(e.metadata->'users') AS user_id
      FROM
        events e
      INNER JOIN related_events ON
        e.metadata->'contents' ? related_events.content_id OR
        e.metadata->'users' ? related_events.user_id
    )
    SELECT DISTINCT
      events.*
    FROM
      events
    INNER JOIN related_events ON
      events.id = related_events.id
```

Acredito que est√° f√°cil de adicionar outros campos de compara√ß√£o, como `from_rule`, mas n√£o parece ser necess√°rio, e deve ser tranquilo lidar com isso na `findByEventId`.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Obrigado, Felipe. Vou ler com aten√ß√£o sua sugest√£o e corrijo o resto do c√≥digo :+1:
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Aqui deveria ser na ordem contr√°ria, certo? Da forma que est√°, o `metadata` n√£o √© testado, visto que √© utilizado o valor retornado por `orchestrator.getLastEvent` (com exce√ß√£o dos casos onde o `metadata` √© um `expect.arrayContaining`)..
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Acho que ao inv√©s de usar `expect.arrayContaining`, √© mais garantido comparar o array ordenado, porque, por exemplo, `expect([1, 2]).toEqual(expect.arrayContaining([1]))` √© `true`.
> > Para deixar o teste mais simples do que precisar ordenar em cada teste, √© poss√≠vel [estender o `match`](https://vitest.dev/guide/extending-matchers) ou usar uma biblioteca que faz isso. No Jest existe a biblioteca [jest-extended](https://github.com/jest-community/jest-extended), que parece ser compat√≠vel com o Vitest, e ela tem o [`.toIncludeSameMembers`](https://jest-extended.jestcommunity.dev/docs/matchers/array/#toincludesamemembersmembers) que serve exatamente para esse caso.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Quando n√£o faz diferen√ßa, acho melhor usar:

```suggestion
          users: expectedUsers,
```

Principalmente pelo motivo de que num `expect` abaixo √© feito desse jeito, e ent√£o d√° a impress√£o que os `users` s√£o diferentes (como √© o caso dos `events`), mas n√£o s√£o.
Isso vale para os outros lugares que for poss√≠vel alterar.

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > A query funciona e os testes asseguram isso. Realizei um teste inicial com 4 eventos no banco de dados e a consulta demorou 1 segundo; depois realizei mais alguns testes entre 1 mil e 25 mil eventos no banco de dados e o tempo n√£o aumentou. Talvez precisemos adaptar algo para quando formos criar o endpoint que lista todos eventos (paginado), mas por ora acredito que est√° adequado :+1:
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Por isso que est√° sendo feita a compara√ß√£o nos dois sentidos, pois se n√£o forem iguais, pelo menos uma das duas ir√° falhar.
> > `expect(A).toEqual(expect.arrayContaining(B))` e `expect(B).toEqual(expect.arrayContaining(A))`
> > Pensei agora que aqui n√£o √© necess√°rio usar o `.soft`, pois a falha em qualquer um dos dois `expect`s j√° traz todos os dados necess√°rio para entender o erro.

---

O `.toIncludeSameMembers` pode ser uma alternativa se melhorarem a forma como o erro √© apresentado. E bem que isso poderia j√° ser nativo!

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Se eu n√£o comi bola, usei `expect.arrayContaining` onde nada garante que o Postgres retorne os itens na mesma ordem (j√° que n√£o precisamos garantir isso). E nesses pontos deveria estar sendo feita a compara√ß√£o sempre nos dois sentidos, conforme https://github.com/filipedeschamps/tabnews.com.br/pull/1765#discussion_r1691452371
> > Aqui s√≥ temos um item, ent√£o n√£o h√° preocupa√ß√£o com a ordem.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Opa, ficou ao contr√°rio! Bem notado! üëç
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Por isso que est√° sendo feita a compara√ß√£o nos dois sentidos
> > Est√° certo, n√£o havia percebido isso.
> > E bem que isso poderia j√° ser nativo!
> > Certamente. Na maior parte das vezes que precisei, considerei uma compara√ß√£o mais √∫til do que a `arrayContaining` üòÖ
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que nessa linha 689 n√£o podemos fazer essa mudan√ßa, mas na linha 391 sim üëç
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Tem raz√£o, comentei na linha errada üôÉ
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Precisa criar √≠ndices para melhorar essa consulta, mas, por enquanto, por ser exclusivo da modera√ß√£o, n√£o vejo necessidade.
> > Sobre listar todos os eventos, da√≠ acho que n√£o precisa trazer os relacionados, ent√£o a consulta ser√° mais simples.
> > </pull_1765_Cria endpoint para obter dados relacionados √† um evento do firewall interno>

<pull_1766_Adiciona testes que garantem que os an√∫ncios n√£o influenciam no prest√≠gio dos usu√°rios>

## Mudan√ßas realizadas

### Principais

Adiciona testes para evitar a regress√£o do comportamento dos an√∫ncios em rela√ß√£o aos ganhos de TabCoins. Os votos recebidos nos an√∫ncios n√£o devem influenciar os ganhos de TabCoins:

- a479c2f8642c40fe02284d6b70f5fc39ab0e698b: Ao publicar outros conte√∫dos.
- 8c9dc4b85637261624b83506668170ed8db0c18e: Nas recompensas di√°rias.

### Rafatora√ß√µes

Criei os testes acima j√° nos novos padr√µes que adotamos recentemente, ent√£o aproveitei para ajustar os demais testes aos novos padr√µes:

- 49ffafc75aff0665826c97984ca4149eb040ed89: Usa a constante `relevantBody` para n√£o impedir o ganho inicial ao publicar conte√∫dos nos testes.
- 65bb0b0dc94374b3e916a14c040f37d64d0c0d14: Usa `toBe` para comparar primitivos (ao inv√©s de `toEqual` ou `toStrictEqual`).
- 7d5c8887d7db8563d3fa6c9d226f66b5b3d44f0e: Adota o `requestBuilder` nos demais testes do endpoint `/user`
- 5729cce0517ae3344481b2f5821cd77b7bfb6647: Habilita a regra `require-await` e adequa adicionando `await` e removendo `async`.
- 4c232ddec38558a71519b04909368f288a349e46: Habilita a regra `vitest/prefer-to-be` e adequa `toBe(NaN)` para `toBeNaN()`.
- ae027253647cad17173fff39b33601966e952957: Habilita a regra `vitest/prefer-strict-equal` e adequa `toEqual` para `toStrictEqual`.

## Tipo de mudan√ßa

- [x] Novos testes
- [x] Refatora√ß√£o de testes

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (COMMENTED):
  > > Show :+1:
  > > Aproveitando que usou o `.toBe` em todos os tests, pode adicionar a regra [`vitest/prefer-to-be`](https://github.com/veritem/eslint-plugin-vitest/blob/main/docs/rules/prefer-to-be.md) no `overrides` dos arquivos de testes. Al√©m do `.toBe` para compara√ß√µes de primitivos, a regra tamb√©m ir√° sugerir o uso de `.toBeNaN`, `.toBeUndefined` e `.toBeNull`.
  > > E tem a regra [`vitest/prefer-strict-equal`](https://github.com/veritem/eslint-plugin-vitest/blob/main/docs/rules/prefer-strict-equal.md), que parece fazer sentido adicionar tamb√©m.
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > No `tests/integration/api/v1/contents/[username]/get.test.js` tem dois `orchestrator.createContent` sem `await`. Quer aproveitar para arrumar tamb√©m? Linhas `139` e `211`.
  > > Fora isso, tudo certo üëç
  > > Review de Rafatcb (DISMISSED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Faltou o `await`.

```suggestion
        await orchestrator.createBalance({
```

Vou marcar os outros locais tamb√©m para facilitar de identificar que foi resolvido na revis√£o, mas existe c√≥digo antigo sem o `await` que poderia ser corrigido junto (√© s√≥ pesquisar por ` orchestrator.`, com dois espa√ßos na frente).

> > Coment√°rio de Rafatcb (linha de c√≥digo):

```suggestion
        await orchestrator.createBalance({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):

```suggestion
        await orchestrator.createBalance({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):

```suggestion
        await orchestrator.createBalance({
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Essa fun√ß√£o n√£o precisa do marcador `async`.

```suggestion
        simultaneousResults.forEach((result) => {
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):

```suggestion
        simultaneousResults.forEach((result) => {
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):

```suggestion
        simultaneousResults.forEach((result) => {
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Boa, removi o `await result.json()` e esqueci de remover o `async`.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Interessante isso n√£o ter deixado os testes inst√°veis
> > </pull_1766_Adiciona testes que garantem que os an√∫ncios n√£o influenciam no prest√≠gio dos usu√°rios>

<pull_1768_Atualiza Node.js para v20 e usa o `crypto` de maneira compat√≠vel com a Edge>
Recentemente come√ßamos a receber alertas espor√°dicos do erro `EDGE_FUNCTION_INVOCATION_FAILED`.
Coincidentemente (ou n√£o) os problemas come√ßaram a ocorrer ao mesmo tempo que a Vercel estava com um incidente aberto que causava o mesmo erro, ent√£o n√£o investiguei melhor, pensando ser algo que eles iriam resolver.
Mas agora resolvi investigar e vi que nos logs da Vercel temos uma mensagem que n√£o est√° indo para o Axiom, que √© `The edge runtime does not support Node.js 'crypto' module.`

## Mudan√ßas realizadas

Usa o `crypto` nativo sem `import` em `errors/index.js` para ser compat√≠vel com a Edge da Vercel.
Para isso n√£o causar problemas no CI, precisamos atualizar para o Node.js v20. Anteriormente tivemos problemas ao usar a v20 na Vercel, mas agora n√£o √© para termos problemas, pois √© a vers√£o que recomendam.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (COMMENTED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Precisa executar um `npm install` para atualizar o `package-lock.json` tamb√©m.
  > > </pull_1768_Atualiza Node.js para v20 e usa o `crypto` de maneira compat√≠vel com a Edge>

<pull_1771_Exibe link para o FAQ na mensagem de erro sobre n√£o conseguir criar conte√∫dos por causa das avalia√ß√µes>

## Mudan√ßas realizadas

Na mensagem de erro, adicionei o link ao [FAQ](https://www.tabnews.com.br/faq#erro-nova-publicacao) e tamb√©m removi o identificador do erro, pois √© algo que o usu√°rio deve conseguir resolver sozinho. Vale lembrar que a mensagem √© igual para publica√ß√µes e coment√°rios.
| Cen√°rio | Resultado |
| :-----: | --------- |
| Antes | |
| Agora | |
Resolve #1540

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Show!
  > > Ser√° que n√£o √© interessante deixar isso dentro de `createErrorMessage`?
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Massa!
  > > Testando o erro eu percebi outra melhoria para fazermos depois nessa tela. A mensagem de erro pode (quase sempre) aparecer fora do campo de vis√£o do usu√°rio.
  > > Ela podia aparecer perto do bot√£o de publicar.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Ser√° que n√£o √© interessante deixar isso dentro de `createErrorMessage`?
  >
  > Transferir esse `if` para l√°? N√£o acho que faz sentido porque o `createErrorMessage` √© gen√©rico, enquanto que esse erro √© uma resposta espec√≠fica para essa a√ß√£o.
  > Acho que faz sentido manter centralizado onde traduzimos as mensagens de erro recebidas da API para algo mais adequado √† UI, mas ainda falta criar um componente respons√°vel pela renderiza√ß√£o, ent√£o tudo bem deixar isso para depois.
  > Mas d√° para continuar usando o `createErrorMessage` para retornar o texto:

```suggestion
                    {createErrorMessage(responseBody, { omitErrorId: true })}
```

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Me parece que colocar `omitErrorId` aqui n√£o √© o melhor, porque omitiria o ID de outros erros. Veja se minha proposta faz sentido.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Me parece que colocar `omitErrorId` aqui n√£o √© o melhor, porque omitiria o ID de outros erros.
> > N√£o entendi porqu√™ omitiria o ID de outros erros se `{createErrorMessage(responseBody, { omitErrorId: true })}` estava dentro da condi√ß√£o `responseBody.error_location_code === 'MODEL:CONTENT:CREDIT_OR_DEBIT_TABCOINS:NEGATIVE_USER_EARNINGS'`.
> > Mas seguir essa sugest√£o ao p√© da letra tamb√©m n√£o resolve o que est√° mais estranho, que √© salvar um componente React usando `useState`. Ou n√£o v√™ problema nisso?
> > Veja se minha proposta faz sentido.
> > Na √∫ltima proposta me parece ser ao p√© da letra o que eu sugeri primeiro, pois est√° lidando totalmente dentro de `createErrorMessage`, mas isso transforma a fun√ß√£o em um componente React, ent√£o precisaria mudar ela para outra pasta e deixar a fun√ß√£o em `PascalCase`, o que talvez implicaria mudar todos os locais que usam a `createErrorMessage`. Pode n√£o valer a pena.
> > Para n√£o precisa revolucionar, d√° para deixar a `createErrorMessage` da forma que est√°, lidando apenas com o texto, e criar um componente de UI. Esse componente pode at√© ser criado dentro de `Content` e n√£o precisa ser algo muito flex√≠vel por enquanto. E deve compensar usar a `createErrorMessage` nesse componente, mas veja o que acha melhor, evitando fugir das conven√ß√µes do React.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Entendi errado a sua sugest√£o; agora deve estar mais pr√≥ximo do esperado.
> > Modifiquei os `setGlobalErrorMessage` para permitir passar tamb√©m o `omitErrorId`. Outra op√ß√£o seria aceitar a resposta "flat" (`setGlobalErrorMessage(responseBody)`) e modificar apenas onde o `omitErrorId` fosse definido, por exemplo:

```jsx
setGlobalErrorMessage({ ...responseBody, omitErrorId: true });
```

</pull_1771_Exibe link para o FAQ na mensagem de erro sobre n√£o conseguir criar conte√∫dos por causa das avalia√ß√µes>

<pull_1772_Sempre validar se `username` √© √∫nico antes de validar o mesmo para o `email`>
Ap√≥s o coment√°rio do @luanmz (https://github.com/filipedeschamps/tabnews.com.br/issues/186#issuecomment-2261675933) sobre ainda ser poss√≠vel descobrir se um endere√ßo de email est√° cadastrado no sistema atrav√©s do `PATCH /users/[username]`, verifiquei que ainda n√£o havia cobertura de testes para o caso que ele citou.

## Mudan√ßas realizadas

Criei o teste e adequei o model `user` para sempre validar primeiro o `username`, o que elimina a vulnerabilidade citada.
A principal mudan√ßa √© verificar `results.rows.some` ao inv√©s de `results.rows[0]` para n√£o depender da ordem dos usu√°rios retornado na consulta. O restante √© apenas uma refatora√ß√£o adotando _early return_.
O ponto original da issue #186 ainda permanece aguardando contribui√ß√£o. üëç

## Tipo de mudan√ßa

- [x] Corre√ß√£o de vulnerabilidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1772_Sempre validar se `username` √© √∫nico antes de validar o mesmo para o `email`>

<pull_1778_Cria p√°gina para listar usu√°rios>

## Mudan√ßas realizadas

Essa √© uma implementa√ß√£o parcial do frontend do issue #1675.

- Em telas grandes, o link `Usu√°rios` fica ao lado de `Recentes`. Em telas menores, fica no menu hamb√∫rguer.
- Links no formato `/moderacao/usuarios/1`.
- Lista exibindo um resumo da descri√ß√£o para facilitar a identifica√ß√£o de perfis de spam.
- Exibindo `Label` para usu√°rios `nuked`.
  Fica faltando a contagem de publica√ß√µes e coment√°rios, visualiza√ß√£o de `id` e `features` do usu√°rio, e tamb√©m a possibilidade de ver a data de cria√ß√£o e descri√ß√£o completa de um usu√°rio `nuked` (para um usu√°rio n√£o-`nuked`, basta visitar o perfil).

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Massa @Rafatcb! üí™
  > > Deixei dois coment√°rios no c√≥digo ü§ù
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Senti falta de um feedback de carregamento na UI.
  > > Mesmo sendo algo exclusivo da modera√ß√£o, seria interessante adicionar um feedback sim. Acho que o acionamento pode usar o `isLoading` do `swr` em conjunto com o `isLoading` do `useUser`.
  > > Caso pense em algo simples como um spinner, deve dar para criar algo baseado no `SpinnerWrapper` do `ButtonWithLoader` para manter a consist√™ncia do design. Mas ficaria mais interessante algo com [react-content-loader](https://www.npmjs.com/package/react-content-loader).
  > > N√£o √© algo impeditivo para a mesclagem do PR, ent√£o tamb√©m d√° para deixar isso como [good first issue](https://github.com/filipedeschamps/tabnews.com.br/contribute) se n√£o achar que a cria√ß√£o da issue vai dar o mesmo trabalho de j√° implementar.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > O c√≥digo est√° cheio de "n√∫meros m√°gicos" porque foram os que percebi que se encaixavam melhor com a UI para quase n√£o mudar as posi√ß√µes ap√≥s o carregamento. Talvez tenha uma forma mais simples. Se um usu√°rio ter descri√ß√£o, j√° ir√° mudar, por exemplo, mas isso n√£o me parece um problema, e sim algo natural.
  > > Nos meus testes em homologa√ß√£o, tem hora que tem deslocamento (horizontal e vertical mesmo sem nenhum usu√°rio com descri√ß√£o preenchida) e tem hora que n√£o tem. N√£o parece valer a pena tentar fazer o `Skeleton` com os mesmos espa√ßamentos, mas apenas indicar que a lista est√° sendo carregada.
  > > Achei que o resultado ficou bom. Precisei ter alguns cuidados extras com os n√∫meros de p√°ginas mais altos e com diferen√ßas na quantidade de d√≠gitos da lista (por exemplo, quando muda do usu√°rio 99 para o 100 na mesma p√°gina).
  > > Se n√£o for mostrar a numera√ß√£o enquanto a lista est√° sendo buscada, d√° para evitar muita complexidade.
  > > Existe um pequeno problema que √© a renderiza√ß√£o inicial a partir do item `1`, porque `page` est√° `undefined`.
  > > S√≥ deveria mostrar a numera√ß√£o ap√≥s router estar definido, mas, de novo, se n√£o mostrar a numera√ß√£o enquanto n√£o obteve a lista, j√° elimina essa complexidade.
  > > Um teste falhou no CI uma vez:
  > > N√£o √© por esse que falhou, mas apontei um problema na altera√ß√£o dos testes `users/get` que √© a √∫nica coisa que realmente impede a aprova√ß√£o do PR.
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > N√£o acho interessante esse scroll horizontal no header. N√£o √© intuitivo e acaba parecendo mais um bug do que algo intencional.
  > > Dependendo do tamanho da tela, o link estar√° totalmente escondido, mesmo ainda n√£o estando dispon√≠vel pelo menu. √â o caso abaixo, em que s√≥ fiz aparecer parte do `U` porque sabia previamente que existia um scroll ali, mas nada indicava isso:
  > > Por isso, acho melhor deixar o novo link apenas no menu, ou adicionar ao header apenas quando houver bastante espa√ßo. Digo bastante espa√ßo de verdade, n√£o usando a `isScreenSmall` que considera exatamente o que j√° temos no header antes desse PR, e n√£o vale a pena modificar esse limiar por um item que n√£o vai aparecer para todo mundo.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Considerou criar uma p√°gina est√°tica e buscar os dados pela API?
  > > Tudo que consegui pensar me leva a crer que seja o melhor caminho.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > N√£o tenho experi√™ncia nessa parte do Next.js, acho que foi a primeira p√°gina que criei. Vou verificar isso üëç
  > > Voc√™ diz para realizar o `fetch` no `getStaticProps` e tamb√©m em um `useEffect`? Ou apenas no `useEffect`?
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Voc√™ diz para realizar o `fetch` no `getStaticProps` e tamb√©m em um `useEffect`? Ou apenas no `useEffect`?
  > > Ao inv√©s de buscar dentro de um `useEffect`, pode usar a biblioteca `swr`, por exemplo como na p√°gina de status. Para usar a `swr` nesse caso, s√≥ precisamos fazer uma adequa√ß√£o que est√° pendente na `SRWFetcher` para poder obter os headers, j√° que ser√° necess√°rio para a pagina√ß√£o. Posso fazer essa adequa√ß√£o, e acho que podemos mudar nesse PR mesmo, apenas mantendo um commit separado. Ou prefere que eu abra outro PR e voc√™ faz um rebase?
  > > N√£o vai ter nenhum dado p√∫blico, ent√£o n√£o precisa de `getStaticProps`. Dessa forma, independentemente da pagina√ß√£o, sempre estaremos na mesma p√°gina est√°tica, e com `useRouter` d√° para obter a pagina atual antes de buscar os dados. Tamb√©m d√° para fazer um redirecionamento para a Home (pelo client mesmo) quando o usu√°rio n√£o estiver logado ou n√£o possuir a feature.
  > > Depois vou tentar subir alguma sugest√£o em c√≥digo ü§ù
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Pode fazer a adequa√ß√£o nesse PR. Obrigado.
  > > N√£o vai ter nenhum dado p√∫blico, ent√£o n√£o precisa de `getStaticProps`.
  > > Voc√™ acabou de me lembrar o porqu√™ de eu ter usado o `getServerSideProps` hehe.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Deixei todos os commits separados pois √© uma sugest√£o, para facilitar a revis√£o e tamb√©m porque v√£o haver mais mudan√ßas, mas no final eu acho que compensa deixar o commit que muda o swr como primeiro e fazer o squash dos demais em seguida.
  > > Agora acho que compensa usar o removeMarkdown na API para encurtar as descri√ß√µes. O que acham?
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Deixei todos os commits separados pois √© uma sugest√£o, para facilitar a revis√£o e tamb√©m porque v√£o haver mais mudan√ßas, mas no final eu acho que compensa deixar o commit que muda o swr como primeiro e fazer o squash dos demais em seguida.
  > > Ok!
  > > Agora acho que compensa usar o removeMarkdown na API para encurtar as descri√ß√µes. O que acham?
  > > Acredito que fa√ßa sentido, porque √© o comportamento que tempos em `GET /api/v1/contents`.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Lembra o [motivo](https://github.com/filipedeschamps/tabnews.com.br/pull/1615#pullrequestreview-1871423774) de ter feito o hack com essa `key`? Sem ela, o bug voltou.
  > > Veja se resolve se passar a `key` para `DefaultLayout`.
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Obrigado por me lembrar disso!
  > > Colocar no `DefaultLayout` n√£o resolve porque o estado est√° no `Page`. Uma forma "boba" de resolver, que foi a mais simples que pensei:

```jsx
export default function Page({ userFound }) {
  return <PageContent key={userFound.id} userFound={userFound} />;
}
function PageContent({ userFound: userFoundFallback }) {
// O resto continua como est√°
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > S√£o tr√™s bugs relacionados.
> > Um √© o fato de n√£o mudar o texto da descri√ß√£o ao trocar de usu√°rio, e esse pode ser resolvido com a `key={userFound.id}` em `DefaultLayout`
> > Os outros sim s√£o estados em `Page`, que podem ser restaurados com:

```js
useEffect(() => {
  setGlobalMessageObject(null);
  setIsEditingDescription(false);
}, [userFoundFallback.id]);
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Testei aqui localmente com `npm run build:local && npm run start:local` e a `key` s√≥ precisa ser adicionada no `Viewer`.
> > O `useEffect` √© o que coloquei na mensagem acima mesmo üëç
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > N√£o acha melhor dividir o componente (`Page` e `PageContent`) e usar `key`? A [documenta√ß√£o do React](https://react.dev/learn/you-might-not-need-an-effect#resetting-all-state-when-a-prop-changes) recomenda evitar o `useEffect` para limpar estados em cen√°rios como esse.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que √© melhor dividir o componente sim, mas n√£o simplesmente colocando algo por fora, e sim isolando a parte que depende desse estado. N√£o avaliei o que pode separar, mas, no pior caso, seria tudo que √© filho de `DefaultLayout`.
> > Aproveitando seu exemplo, se tudo abaixo de `DefaultLayout` precisa dos estados, ent√£o passa o `PageContent` como filho de `DefaultLayout` em `Page`. Com a `key` em `PageContent` mesmo. üëç
> > Algo assim:

```js
export default function Page({ userFound }) {
  return (
    <DefaultLayout metadata={{ title: `${userFound.username}` }}>
      <PageContent key={userFound.id} userFound={userFound} />
    </DefaultLayout>
  );
}
function PageContent({ userFound: userFoundFallback }) {
...
  return (
    <>
      {globalMessageObject?.position === 'main' && (
...
```

Por causa do fragment `<>` no lugar de `<DefaultLayout ...>`, o diff ser√° pequeno.
E √© melhor deixa as mudan√ßas relacionadas √† `key` no mesmo commit e separado do restante, ou seja, dividr o febdd42e527f4db0319b628ff86ed077190d1f77, onde uma parte se junta ao 9fa7b42f288f502d1445dbe1f0267d528cc59ff2 e outra fica no novo commit ü§ù

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Deixei o `useSWR` separado no componente pai, o resto me pareceu fazer sentido ficar no filho. Estou marcando como resolvido, mas se notarem algo que possa ficar melhor, podem avisar.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o entendi a raz√£o de `pageLoading`. Se for mesmo necess√°rio, n√£o acha melhor deixar l√° no in√≠cio de `UsersPage`?
> > O objeto `pagination` est√° sendo criado nesse mesmo PR, e apenas para ser passado para `UserList`, portando, se precisa de um comportamento inicial diferente, pode alterar diretamente a forma que `pagination` √© criado.
> > Mas parece que a forma como `pagination` √© criado j√° √© o necess√°rio, pois na pr√°tica est√° usando o valor original. Penso isso, pois est√° fazendo algo assim: `page || page || 1`, que d√° no mesmo que o original, que √© `page || 1`.
> > Outra coisa, que talvez esteja relacionado, √© que n√£o precisa mostrar a numera√ß√£o dos itens enquanto a lista estiver sendo buscada. Me parece que isso est√° trazendo complica√ß√µes em `UserListItemLoading` com renderiza√ß√µes extras, deslocamento de layout e valores inconsistentes.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > `dropAllTables()` e `runPendingMigrations()` n√£o pode ser removido daqui, sen√£o o resultado do bloco `Default user` fica dependente de ter rodado as migrations manualmente ou em algum outro teste anterior.
> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Eu removi (vou subir as altera√ß√µes logo). N√£o √© grande coisa, mas se voc√™ estiver numa p√°gina que n√£o seja a primeira, ocorre uma renderiza√ß√£o com os n√∫meros 1-30 e depois com os n√∫meros corretos (e.g. 31-60 na p√°gina 2). Isso era mais not√°vel ao exibir a numera√ß√£o no carregamento.
> > </pull_1778_Cria p√°gina para listar usu√°rios>

<pull_1781_Refatora/corrige alguns testes>

## Mudan√ßas realizadas

Usa o padr√£o recomendado pelo Vitest para criar o mock de `database` nos testes de `reward`.
Nos testes de unidade do componente `Pagination`, deixa de usar a vari√°vel `webserver.host` e utiliza sempre `localhost:3000`. Os componentes isoladamente n√£o l√™em as vari√°veis de ambientes, mas `webserver.host` muda se usarmos valores diferentes em `NEXT_PUBLIC_WEBSERVER_HOST` e/ou `NEXT_PUBLIC_WEBSERVER_PORT`, o que faria os testes falharem.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o e corre√ß√£o de bug nos testes

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > √ìtima observa√ß√£o sobre os testes de `Pagination` e tamb√©m na melhoria do `reward`!
  > > Tem alguns casos que o `.soft` n√£o ir√° ajudar, porque √© seguido por uma asser√ß√£o simples `.toBe` de algum campo da resposta, que provavelmente ser√° `undefined` caso o status seja diferente do esperado, mas imagino que essa altera√ß√£o foi feita com "Find and Replace", e mudar as asser√ß√µes para `.toStrictEqual` consumir√° tempo demais, ent√£o tudo bem.
  > > </pull_1781_Refatora/corrige alguns testes>

<pull_1782_Configura√ß√µes do ESLint e Prettier>

## Mudan√ßas realizadas

Atualiza configura√ß√µes do ESLint e Prettier e faz as adequa√ß√µes no c√≥digo.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Boas mudan√ßas nos logs.
  > > N√£o ter `async` nas fun√ß√µes que retornam promises me parece estranho, mas provavelmente √© ≈õo costume meu. O editor continua identificando que as fun√ß√µes retornam promise :+1:
  > > </pull_1782_Configura√ß√µes do ESLint e Prettier>

<pull_1783_Exibe erro de descri√ß√£o ao atualizar pelo perfil do usu√°rio>

## Mudan√ßas realizadas

Quando ocorre um erro na atualiza√ß√£o da descri√ß√£o por causa de alguma valida√ß√£o do campo, esse erro n√£o era exibido para o usu√°rio. Percebi isso ao tentar atualizar para uma descri√ß√£o com mais de 5.000 caracteres.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1783_Exibe erro de descri√ß√£o ao atualizar pelo perfil do usu√°rio>

<pull_1786_Carrega an√∫ncio ap√≥s carregar a p√°gina do conte√∫do para n√£o index√°-lo>

## Mudan√ßas realizadas

Busca publica√ß√£o patrocinada pela API ao inv√©s de `getStaticProps`, conforme comentado em https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2226440549 e https://github.com/filipedeschamps/tabnews.com.br/issues/1491#issuecomment-2293638640, para n√£o indexar o t√≠tulo e fonte da publica√ß√£o patrocinada em mecanismos de busca. N√£o tenho certeza se isso ir√° funcionar porque quase n√£o encontrei conte√∫dos sobre como n√£o indexar an√∫ncios ou textos de uma pa«µina.
Optei por fazer essa altera√ß√£o inicialmente apenas nas p√°ginas de conte√∫dos, porque isso j√° diminuir√° bastante a indexa√ß√£o de t√≠tulos de publica√ß√µes patrocinadas, e tamb√©m para acompanharmos os efeitos colaterais dessa altera√ß√£o, seja em SEO, seja na Vercel.
Um problema √© que em telas pequenas a barra de carregamento fica cortada, sem o arredondamento. Quando implementarmos esse carregamento nas outras p√°ginas, pensei em exibir duas linhas para o t√≠tulo em telas pequenas (e.g. < 470px), porque dentre as publica√ß√µes patrocinadas que temos hoje, est√° mais comum ocuparem 2 ou 3 linhas do que apenas 1, ent√£o o deslocamento do layout seria menor. Por ora, deixei mais simples, j√° que nos conte√∫dos o an√∫ncio n√£o √© exibido logo no topo da tela.
Se acharem que faz sentido, posso adicionar o `<meta name="robots" content="noindex">` num outro commit em p√°ginas de publica√ß√µes patrocinadas, e talvez nas p√°ginas "Classificados".

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > Massa @Rafatcb! üí™
  > > Acredito que as outras melhorias que voc√™ citou podem ajudar, mas tamb√©m podem ser em pr√≥ximos PRs, ent√£o bora colocar isso em produ√ß√£o!
  > > </pull_1786_Carrega an√∫ncio ap√≥s carregar a p√°gina do conte√∫do para n√£o index√°-lo>

<pull_1787_Atualiza as propriedades do componente `Tooltip` para serem compat√≠veis com a nova vers√£o (`Tooltip v2`)>
Hoje utilizamos a v1 do Tooltip do Primer, que j√° est√° obsoleta e pode ser removida no futuro. Ent√£o esse PR j√° adequa as propriedades de maneira compat√≠vel com a v2 para cumprir com uma nova regra de lint do plugin `eslint-plugin-primer-react`. Para o nosso caso, a v1 funciona perfeitamente com as mesmas propriedades da v2.
Ainda n√£o podemos simplesmente mudar para a v2, pois ela n√£o √© compat√≠vel com a maneira que usamos o Tooltip na barra de ocultar coment√°rios (e talvez em outros locais... √© preciso testar e adequar cada um).

## Mudan√ßas realizadas

- Usa a propriedade `text` ao inv√©s de `aria-label`. No HTML gerado continua como `aria-label`.
- Deixa de usar a propriedade `noDelay`, o que n√£o gera mudan√ßa visual significativa.
- Deixa de usar a propriedade `wrap`, que n√£o tinha efeito pr√°tico onde estava sendo usada.
- Atualiza as vers√µes do `@primer/octicons-react`, `@primer/react` e `eslint-plugin-primer-react`, sendo esse √∫ltimo o respons√°vel pelas adequa√ß√µes acima de forma autom√°tica.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
      Obs.: Infelizmente permanecem os alertas antigos do Primer (https://github.com/primer/react/issues/4836)
  > > Review de Rafatcb (APPROVED):
  > > Review de eliasamaral (APPROVED):
  > > </pull_1787_Atualiza as propriedades do componente `Tooltip` para serem compat√≠veis com a nova vers√£o (`Tooltip v2`)>

<pull_1788_Deixa mais claro qual √© o nome da tabela em que s√£o armazenadas as `migrations`>
Antes era criada a `defaultConfigurations` passando `migrationsTable: 'migrations'` e depois isso era sobrescrito por `pgmigrations` na hora de utilizar as configura√ß√µes.

## Mudan√ßas realizadas

- Agora j√° √© definida corretamente `migrationsTable: 'pgmigrations'` em `defaultConfigurations`.
- Aproveitei o PR para fazer uma simples mudan√ßa na importa√ß√£o de `logger` seguindo o padr√£o `infra/logger` ao inv√©s de `./logger`.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de kaique-soares (APPROVED):
  > > Review de Rafatcb (APPROVED):
  > > </pull_1788_Deixa mais claro qual √© o nome da tabela em que s√£o armazenadas as `migrations`>

<pull_1789_Adiciona `noindex` √†s p√°ginas de an√∫ncios e Classificados>

## Mudan√ßas realizadas

Seguindo o que foi comentado em https://github.com/filipedeschamps/tabnews.com.br/pull/1786, adicionei `noindex` √†s p√°ginas de publica√ß√µes patrocinadas e tamb√©m √†s de Classificados.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1789_Adiciona `noindex` √†s p√°ginas de an√∫ncios e Classificados>

<pull_1790_Libera o nome de usu√°rio e email caso o token de ativa√ß√£o da conta expire>

## Mudan√ßas realizadas

Conforme mencionado em https://github.com/filipedeschamps/tabnews.com.br/issues/957#issuecomment-2190125424, agora ao realizar um cadastro, caso o `username` ou `email` do usu√°rio j√° esteja cadastrado, mas o token de ativa√ß√£o n√£o tenha sido utilizado e j√° expirou, ent√£o √© poss√≠vel realizar um novo cadastro com esse `username` ou `email`.
Resolve #957

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (DISMISSED):
  > > Massa @Rafatcb! üí™
  > > Mas tenho algumas de preocupa√ß√µes...

### Capitaliza√ß√£o de `username`

A cria√ß√£o de um novo usu√°rio com diferente capitaliza√ß√£o (mudando entre mai√∫sculas e min√∫sculas) com rela√ß√£o a outro usu√°rio **n√£o ativo** vai acabar inserindo uma nova linha ao inv√©s de atualizar a existente, duplicando o `username` na tabela `users`, com varia√ß√£o apenas na capitaliza√ß√£o.
Isso porque a diferen√ßa de capitaliza√ß√£o n√£o vai fazer entrar na cl√°usula `ON CONFLICT` adicionada nesse PR, j√° que ainda n√£o temos uma restri√ß√£o do tipo:

```sql
CREATE UNIQUE INDEX unique_username_ci ON users (LOWER(username));
```

Independentemente da funcionalidade desse PR, acho importante adicionar no banco de dados uma restri√ß√£o alinhada como essa acima. Isso porque hoje a restri√ß√£o s√≥ existe na fun√ß√£o `validateUniqueUser`, mas esse PR acaba removendo parcialmente a restri√ß√£o em casos bem espec√≠ficos (token expirado ou usu√°rio banido), o que n√£o permitiu pegar a regress√£o com os testes atuais.

### Risco de sobrescrever usu√°rio existente

Na nova inser√ß√£o estamos sobrescrevendo os dados de usu√°rios existentes quando h√° conflito de `username` ou `email`, sem nenhuma outra verifica√ß√£o, apenas confiando que essa verifica√ß√£o ocorreu anteriormente em `validateUniqueUser`.
Como visto no t√≥pico anterior, isso deixa margem para a cria√ß√£o de problemas graves que podem passar despercebidos pelos testes. Por isso, acredito que seja preciso adicionar na cl√°usula `ON CONFLICT` as mesmas restri√ß√µes presentes em `validateUniqueUser`. Algo assim:

```diff
      INSERT INTO
        users (username, email, password, features)
      VALUES
        ($1, $2, $3, $4)
      ON CONFLICT (${conflictField}) DO UPDATE SET
        username = $1,
        email = $2,
        password = $3,
        features = $4,
        created_at = NOW(),
        updated_at = NOW(),
        rewarded_at = NOW()
+      WHERE
+      (
+        SELECT
+          COUNT(*)
+        FROM
+          users u
+        LEFT JOIN
+          activate_account_tokens aat ON u.id = aat.user_id
+        WHERE
+          (
+            LOWER(u.username) = LOWER($1) OR
+            LOWER(u.email) = LOWER($2)
+          )
+            AND
+          (
+            COALESCE(aat.used, true) OR
+            aat.expires_at > NOW() OR
+            'nuked' = ANY(u.features)
+          )
+      ) = 0
      RETURNING
        *
      ;
```

### Caso de `username` e `email` j√° existentes

Esse caso em que os dois campos j√° est√£o presentes em usu√°rios n√£o ativos n√£o est√° sendo tratado pelos testes. Parece que o comportamento atual est√° adequado, mas, sem testes, n√£o d√° para garantir. Acho que precisamos testar tanto para `username` e `email` repetidos em um √∫nico usu√°rio, assim como se for o `username` de um e o `email` de outro usu√°rio, os dois j√° existentes e ainda n√£o ativados (ou banidos).

## Concluindo

Acho que √© uma √≥tima melhoria. S√≥ que √© preciso resolver os pontos acima. üëç

> > Review de aprendendofelipe (COMMENTED):
> > Acredito ter resolvido os pontos levantados, seguindo suas sugest√µes.
> > O teste de `email` e `username` coincidindo com dois usu√°rios diferentes precisa ser do caso em que nenhum dos usu√°rios j√° existentes ser√° retornado na query de `validateUniqueUser`, ou seja, os dois precisam estar com tokens expirados, sem nenhum estar banido ou com token utilizado.
> > Num primeiro momento, eu achei que s√≥ faltava o teste, mas, olhando melhor, esse caso n√£o est√° sendo tratado, e vai retornar um erro do `database`, j√° que as duas varia√ß√µes da inser√ß√£o (variando a `constraint`) n√£o ser√£o poss√≠veis.
> > Como o objetivo √© lidar com os expirados da mesma maneira que um `username` ou `email` nunca utilizados, acho que n√£o vai ter como fugir de excluir entradas do banco de dados (ou editar para algum dado aleat√≥rio, o que n√£o vejo vantagem). Ent√£o uma op√ß√£o seria excluir uma das entradas duplicadas e atualizar a outra.
> > Mas acredito que seja melhor adicionar uma etapa ap√≥s a `validateUniqueUser`, que pode ser algo como `deleteExpiredUsers`. Se `validateUniqueUser` n√£o retornar erro, ent√£o chamamos `deleteExpiredUsers` que pode excluir quaisquer entradas que coincidirem com os novos dados que est√£o sendo inseridos. O bom √© que desvincula totalmente do usu√°rio anterior, pois ser√° criado um novo ID. Isso de chamar a `deleteExpiredUsers` pode valer tamb√©m no `patch` dos usu√°rios, apenas tomando o cuidado de excluir apenas os novos dados, e n√£o excluir o pr√≥prio usu√°rio que est√° sendo editado. Com isso, nem precisaria alterar query de inser√ß√£o, podendo permanecer como j√° √© antes desse PR.
> > A `deleteExpiredUsers` at√© pode ser melhorada futuramente, pegando outros casos que possam ser exclu√≠dos, como usu√°rios criados e ativados, mas nunca utilizados de fato, por exemplo.
> > N√£o sei se consegui explicar direito o que pensei como solu√ß√£o, mas o mais importante √© ficar claro qual √© o problema a ser resolvido, que √© permitir a cria√ß√£o (ou edi√ß√£o) de um usu√°rio utilizando um `username` e um `email` que ambos foram utilizados em dois outros usu√°rios, mas que nunca chegaram a ser ativados.
> > Tirando esse teste espec√≠fico, os demais do m√©todo `POST` permaneceriam do mesmo jeito. Bom, na verdade, tenho uma d√∫vida sobre os testes. Foi de prop√≥sito colocar eles fora do `describe` `Anonymous user`, diretamente em `POST /api/v1/users`? Talvez compense colocar em um `describe` espec√≠fico dos duplicados, ou mover para dentro de `Anonymous user`.
> > Se preferir o primeiro commit num PR separado para realizar as migra√ß√µes antes de mesclar a verifica√ß√£o, pode avisar que eu passo o commit para outro PR üëç
> > Acho que separar a migration √© uma boa ideia, at√© porque √© uma melhoria por si s√≥, e evita preocupa√ß√µes como em mesclar esse PR em hor√°rio tranquilo e/ou rodar a migration na correria assim que concluir o deploy.
> > Review de aprendendofelipe (APPROVED):
> > Teve algum motivo para usar `COALESCE(aat.used, true)`?
> > Como `aat.used` √© `NOT NULL`, acredito que poderia usar `aat.used = true` (ou apenas `aat.used OR ...`), mas como estava assim em uma vers√£o do PR e depois voltou a usar `COALESCE`, fiquei curioso... Teve algum problema sem `COALESCE`?
> > Qualquer coisa removemos isso depois ü§ù
> > </pull_1790_Libera o nome de usu√°rio e email caso o token de ativa√ß√£o da conta expire>

<pull_1791_Considera `username` √∫nico no banco de dados ignorando capitaliza√ß√£o>

## Mudan√ßas realizadas

Conforme discutido no PR #1790, essa altera√ß√£o √© uma garantia extra de que usu√°rios duplicados n√£o ser√£o inseridos no banco de dados.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > Tudo certo em homologa√ß√£o! üéâ
  > > Bora para produ√ß√£o! üöÄ
  > > </pull_1791_Considera `username` √∫nico no banco de dados ignorando capitaliza√ß√£o>

<pull_1801_Adiciona a biblioteca `@tabnews/ui`>

## Mudan√ßas realizadas

Introduz no projeto a biblioteca de UI do TabNews ([@tabnews/ui](https://www.npmjs.com/package/@tabnews/ui)), onde poderemos manter nossos componentes React customizados e compartilhar com diferentes projetos.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de billyfranklim1 (APPROVED):
  > > Review de Rafatcb (COMMENTED):
  > > Esse pode ser um passo bem legal para o projeto. Tenho receio quanto √† burocracia adicionada em criar e modificar componentes, mas acho dif√≠cil prever algo quanto √† isso.
  > > Usar o `@tabnews/ui` influencia algo no _tree shaking_?
  > > Faz sentido mover os √≠cones para o outro pacote tamb√©m?
  > > Review de aprendendofelipe (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Estamos tirando essas depend√™ncias daqui e colocando elas em `@tabnews/ui`, mas l√° est√£o como

```json
  "dependencies": {
    "@primer/react": "^36.27.0",
    "styled-components": "^5.3.11"
  },
```

Faz sentido ter o `^`?

> > Coment√°rio de Rafatcb (linha de c√≥digo):
> > Essa configura√ß√£o tem algo ver com a adi√ß√£o do `@tabnews/ui`?
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Acho que faz sentido sim. üëç
> > Se algu√©m que use a `@tabnews/ui` precisar atualizar a `@primer/react` antes da gente, ter√° como fazer isso, por sua conta e risco, mas poder√°.
> > Se deixarmos a vers√£o fixa, quem tentar usar uma vers√£o mais nova vai acabar com duas inst√¢ncias separadas do Primer, o que vai causar problemas com a estiliza√ß√£o.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Essa √© a forma de fazer essa configura√ß√£o no Next. A gente havia [sa√≠do do padr√£o](https://github.com/filipedeschamps/tabnews.com.br/pull/794) para contornar um [problema](https://github.com/filipedeschamps/tabnews.com.br/pull/792#issuecomment-1295477268) que tivemos com Analytics, mas que [foi resolvido](https://github.com/vercel/analytics/issues/1#issuecomment-1301166929) pouco tempo depois.
> > Esse PR remove todo o c√≥digo ao redor da solu√ß√£o alternativa, pois √© c√≥digo que s√≥ precisamos por causa do `styled-components`, e faz sentido esse c√≥digo ir para a biblioteca de UI, mas ainda n√£o precisamos lidar com i18n nela, ent√£o n√£o tem porque criar outra alternativa fora do padr√£o.
> > </pull_1801_Adiciona a biblioteca `@tabnews/ui`>

<pull_1807_feat(GoToTopButton): add tooltip direction to button component>

## Mudan√ßas realizadas

<!-- Por favor, inclua uma descri√ß√£o sobre o que foi modificado nesse PR. Inclua tamb√©m qualquer motiva√ß√£o ou contexto relevante.  -->

Altera√ß√£o da posi√ß√£o do `Tooltip` para sempre ficar vis√≠vel.

<!-- Se o PR cont√©m uma modifica√ß√£o da interface gr√°fica (UI), adicione fotos ou v√≠deos comparando o antes e depois. -->

**Antes:**

**Depois:**

<!-- Se o PR cont√©m modifica√ß√µes de API, mencione os endpoints afetados. -->
<!-- Caso esse PR resolva algum issue, voc√™ pode descomentar a linha abaixo e substituir (issue) pelo n√∫mero dele. -->
<!-- Resolve #(issue) -->

Resolve #1802

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Corre√ß√£o de bug
  <!-- - [x] Nova funcionalidade -->
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (DISMISSED):
  > > Show! Obrigado por investigar o problema :+1:
  > > Review de aprendendofelipe (CHANGES_REQUESTED):
  > > Review de aprendendofelipe (APPROVED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
        tooltipDirection="nw"
```

</pull_1807_feat(GoToTopButton): add tooltip direction to button component>

<pull_1812_Atualiza `@tabnews/ui` para `v0.3.1` e refatora alguns formul√°rios para usar o componente `FormField`>

## Mudan√ßas realizadas

Usa o componente `FormField` da `@tabnews/ui`, juntamente com a `@tabnews/forms` que gerencia o estado dos formul√°rios. Com isso ganhamos uma maneira mais organizada de criar formul√°rios.
A nova vers√£o da `@tabnews/ui` j√° √© compat√≠vel com ESM, mas exige adicionar configura√ß√£o no `next.config.js` e no `vitest.config.mjs` enquanto n√£o forem corrigidos problemas na `@primer/react`.
A configura√ß√£o do `jsconfig.json` ajuda o editor a resolver os m√≥dulos corretamente.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
      </pull_1812_Atualiza `@tabnews/ui` para `v0.3.1` e refatora alguns formul√°rios para usar o componente `FormField`>

<pull_1817_docs: fix missing author in LICENSE>

## Mudan√ßas realizadas

Enquanto tentava entender a motiva√ß√£o ao escolher a licen√ßa **GPL** ao inv√©s de **AGPL** ‚Äî _apenas por curiosidade_ ‚Äî (#66), percebi que o template utilizado nunca foi adaptado para o autor do projeto, incluindo o ano, nome e descri√ß√£o do projeto.
Apenas adicionei as devidas autorias na licen√ßa para garantir a integridade da mesma.
O ano foi baseado na data de ado√ß√£o da licen√ßa:
Quanto √† descri√ß√£o, apenas traduzi a descri√ß√£o do reposit√≥rio de forma literal, para manter a consist√™ncia de idioma na licen√ßa:
O nome "TabNews" ao inv√©s de "tabnews.com.br" foi motivado pela forma como o projeto √© descrito e chamado no `README.md` e tamb√©m para evitar ambiguidade com o link:

> https://github.com/filipedeschamps/tabnews.com.br/blob/c747083cea3380c538dcf570e256a16693da3a96/README.md#L3

## Tipo de mudan√ßa

- [x] Atualiza√ß√£o de documenta√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (COMMENTED):
  > > Show @wellwelwel, muito obrigado pela contribui√ß√£o! üí™
  > > Comentei no arquivo algumas d√∫vidas que tenho, e pe√ßo ajuda para a Turma pra gente tentar sanar.
  > > E tamb√©m pode ser a oportunidade de reavaliar, agora com o projeto muito mais maduro, se adotamos a licen√ßa correta ou se dever√≠amos migrar para outra.
  > > @filipedeschamps, a sua opini√£o aqui ser√° muito importante, assim como deve ser a com maior peso na decis√£o final ü§ù
  > > Review de wellwelwel (COMMENTED):
  > > Review de wellwelwel (COMMENTED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Ser√° que n√£o √© melhor deixar o nome do programa como `tabnews.com.br`, assim como √© o nome do reposit√≥rio? Isso porque aqui temos exatamente o c√≥digo da aplica√ß√£o web do TabNews, que se diferencia de outras bibliotecas que lan√ßamos/lan√ßaremos, e que s√£o/ser√£o mais interessantes para quem quiser criar projetos com partes similares ao TabNews.
  > > Sobre o ano, acho que aqui entra a faixa, n√£o √©? Da√≠ ficaria `2020-2024`, ou `2021-2024`, se for contar quando essa licen√ßa foi adotada, o que me parece mais correto.
  > > Por fim, como autor, aqui sim talvez se encaixe o nome TabNews como sendo a institui√ß√£o autora do c√≥digo.
  > > Estou deixando a sugest√£o abaixo, mas n√£o sei se deveria ficar assim. Tenho d√∫vidas mesmo nos tr√™s pontos.

```suggestion
    tabnews.com.br  Copyright (C) 2021-2024  TabNews
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Aqui talvez tamb√©m entre na descri√ß√£o que o c√≥digo √© do site tabnews.com.br ao inv√©s de apenas descrever o que √© o site. E tamb√©m cabe analisar os outros pontos do outro coment√°rio.
> > Coment√°rio de wellwelwel (linha de c√≥digo):
> > Minha motiva√ß√£o para o autor foi baseada no fato do reposit√≥rio estar sob o perfil do @filipedeschamps:
> > Quanto √† escolha de usar o `TabNews` como autor ao inv√©s do @filipedeschamps, prefiro deixar para voc√™s (ambos fazem sentido, isso fica mais a crit√©rio dos mantenedores ao meu ver) üôãüèª‚Äç‚ôÇÔ∏è
> > Sobre a quest√£o do `2021-2024`, vou deixar aqui uma ideia que uso nos meus projetos a fim de evitar todo ano ter que voltar na licen√ßa manualmente: `2021-current` (ou tamb√©m `2021-present`).
> > Coment√°rio de wellwelwel (linha de c√≥digo):
> > Aqui talvez tamb√©m entre na descri√ß√£o que o c√≥digo √© do site tabnews.com.br ao inv√©s de apenas descrever o que √© o site.
> > √â comum que a licen√ßa do reposit√≥rio compartilhe das informa√ß√µes que est√£o dentro do reposit√≥rio (especialmente por transpar√™ncia), mas isso n√£o √© nenhuma regra ou sugest√£o. Estou bem com ambos, ent√£o, novamente deixo essa escolha para os mantenedores üôãüèª‚Äç‚ôÇÔ∏è

- A ideia da licen√ßa compartilhar informa√ß√µes do reposit√≥rio tamb√©m vale para o autor, por exemplo.
  </pull_1817_docs: fix missing author in LICENSE>

<pull_1822_Melhora o desempenho da RegEx que evita a cria√ß√£o de conte√∫dos invis√≠veis>

## Mudan√ßas realizadas

Substitu√≠do o agrupamento com operador `|` entre par√™nteses `(\s|\p{C}|...)` por colchetes `[\s\p{C}...]` para representar o conjunto de caracteres que devem ser removidos do in√≠cio e final das strings.
Obs. Troquei a ordem de alguns caracteres porque, com a remo√ß√£o do operador `|`, algumas sequ√™ncias de caracteres entravam na regra ESLint [no-misleading-character-class](https://eslint.org/docs/latest/rules/no-misleading-character-class).
Resolve https://github.com/filipedeschamps/tabnews.com.br/issues/1141#issuecomment-2507407551

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Show! Est√° bem melhor.
  > > Como esses padr√µes se repetem algumas vezes (at√© em arquivos diferentes), acha interessante ter um arquivo exportando-os como constantes?
  > > Edit: Acha v√°lido criar um teste que n√£o passaria por timeout (ou demoraria muito), mas agora passa normalmente? Isso poderia chamar a aten√ß√£o de um eventual regresso do comportamento no futuro.
  > > </pull_1822_Melhora o desempenho da RegEx que evita a cria√ß√£o de conte√∫dos invis√≠veis>

<pull_1826_Feat/umami analytics>

## Mudan√ßas realizadas

Adiciona o servi√ßo Umami para coletar dados de maneira experimental nas seguintes p√°ginas:

- `/publicar`
- `/login`
- `/cadastro`
  Assim podemos comparar os dados do Umami com o Analytics da Vercel.
  Nos ambientes de produ√ß√£o e de homologa√ß√£o os dados s√£o enviados para a Umami Cloud. No ambiente de desenvolvimento local usamos um servidor do Umami via Docker e os dados s√£o salvos em um novo banco de dados na mesma inst√¢ncia do PostgreSQL atual (tamb√©m via Docker).

## Tipo de mudan√ßa

- [x] Nova funcionalidade experimental
  > > Review de Rafatcb (COMMENTED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Isso aqui funcionaria, certo?

```suggestion
const connectionString = process.env.DATABASE_URL;
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o, pois n√£o tem o mesmo valor. S√£o bancos diferentes no mesmo servidor.
> > </pull_1826_Feat/umami analytics>

<pull_1827_Executa o script de configura√ß√£o do Umami ao subir os servi√ßos localmente>
Executa o script de configura√ß√£o do Umami ao subir os servi√ßos localmente. Com isso, caso a configura√ß√£o ainda n√£o tenha sido realizada no ambiente local, ela ser√° criada de maneira padronizada para permitir executar testes localmente (por enquanto apenas testes manuais).
O servidor subir√° na porta `3001`, com usu√°rio `admin`, senha `umami` e com estat√≠sticas para o website `TabNews Dev`.

> > Review de Rafatcb (COMMENTED):
> > ~√â a primeira vez que estou rodando o TabNews desde o merge do Umami, mas aqui nesta branch n√£o subiu. Precisa configurar algo ou executar outro comando, ou s√≥ executar `npm run dev`?~

**Edit:** Quando rodei, deu o erro abaixo. Consegui arrumar criando o banco com `CREATE DATABASE umami;`. N√£o acha que faz sentido executar o arquivo `01-create-umami-database.sql` no arquivo `config-umami.js`, caso o banco n√£o exista?

```sh
‚ûú  tabnews.com.br git:(feat/umami-dev-config) npm run dev
> tabnews.com.br@1.0.0 dev
> npm run services:seed && npm run next && npm run services:stop
> tabnews.com.br@1.0.0 services:seed
> kill-port 3000 && npm run services:up && npm run migration:run && npm run migration:seed && npm run umami:config
Process on port 3000 killed
> tabnews.com.br@1.0.0 services:up
> npm run docker:compose -- up -d
> tabnews.com.br@1.0.0 docker:compose
> docker compose --env-file .env -f infra/docker-compose.development.yml up -d
[+] Running 16/1
 ‚úî umami Pulled                                                                                                                             25.0s
[+] Running 3/3
 ‚úî Container mailcatcher      Started                                                                                                        2.6s
 ‚úî Container postgres-dev     Healthy                                                                                                        7.9s
 ‚úî Container tabnews-umami-1  Started                                                                                                        6.2s
> tabnews.com.br@1.0.0 migration:run
> node -r dotenv-expand/config infra/scripts/wait-for-db-connection-ready.js && node-pg-migrate up --envPath ./.env -m infra/migrations/ 2>migrations.log
health check postgres:  /var/run/postgresql:5432 - accepting connections
No migrations to run!
Migrations complete!
> tabnews.com.br@1.0.0 migration:seed
> node -r dotenv-expand/config infra/scripts/seed-database.js
> Seeding database...
------------------------------
> You can now Login to TabNews using the following credentials:
> "admin@admin.com" + "password"
> "user@user.com" + "password"
------------------------------
> Creating Firewall functions...
> Firewall functions created!
> Database seeded!
> tabnews.com.br@1.0.0 umami:config
> node -r dotenv-expand/config infra/scripts/config-umami.js
> Waiting for Umami Server to start...
> Endpoint: http://localhost:3001
> Umami is not ready, waiting...
> Umami is not ready, waiting...
> Umami is not ready, waiting...
> Umami is not ready, waiting...
üî¥ Umami is not ready, exiting...
```

> > Review de Rafatcb (APPROVED):
> > </pull_1827_Executa o script de configura√ß√£o do Umami ao subir os servi√ßos localmente>

<pull_1828_Usa a biblioteca `resend` quando a vari√°vel `EMAIL_USER` tem valor `resend`>
O TabNews realiza os envios de email transacionais atrav√©s dos servi√ßos Resend (principal) e Mailgun (conting√™ncia).
Infelizmente o Resend vem apresentando alguns problemas bem espor√°dicos de lentid√£o ou perda de envios.
Apesar de ser uma parcela bem pequena dos envios que apresentam algum problema, queremos descobrir se √© poss√≠vel eliminar ou reduzir ainda mais essa ocorr√™ncia.

## Mudan√ßas realizadas

At√© agora a gente enviava os email usando apenas a biblioteca `nodemailer` (via `SMTP`), independentemente do servi√ßo.
Agora adicionamos a biblioteca pr√≥pria do Resend para quando os envios forem com esse servi√ßo. Com isso, os envios com o Resend passam a ser via `HTTP`, e poderemos analisar se existe alguma altera√ß√£o no comportamento pela mudan√ßa no protocolo.
A biblioteca `resend` n√£o aceita os endere√ßos em formato de objeto, ent√£o isso exigiu converter o remetente para ser compat√≠vel com as duas bibliotecas:

### Antes

```
{
  name: 'TabNews',
  address: 'contato@tabnews.com.br',
}
```

### Depois

`'TabNews <contato@tabnews.com.br>'`
</pull_1828_Usa a biblioteca `resend` quando a vari√°vel `EMAIL_USER` tem valor `resend`>

<pull_1829_Define o remetente de email sempre no formato string>
No PR #1828, o formato do remetente foi alterado de objeto para string para ser compat√≠vel com o SDK do Resend. Mas faltou realizar a mudan√ßa dentro da fun√ß√£o `sendReplyEmailToParentUser`, e por isso as notifica√ß√µes sobre novos coment√°rios estavam sendo enviados apenas na segunda tentativa, pela conting√™ncia (Mailgun).

## Mudan√ßas realizadas

Define o `from` como `string` na `sendReplyEmailToParentUser`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
      </pull_1829_Define o remetente de email sempre no formato string>

---

<pull*1832*[Umami] Testa compartilhamento de dados estat√≠sticos junto dos conte√∫dos>

## Mudan√ßas realizadas

O primeiro commit habilita a Umami para coletar dados de todas as p√°ginas do TabNews. No teste inicial est√°vamos coletando dados apenas de algumas p√°ginas. Agora vamos verificar o comportamento com nossa demanda total, e assim poder decidir sobre a substitui√ß√£o completa do Analytics da Vercel pela Umami Cloud.
O segundo commit trata do primeiro teste sobre a capacidade de compartilhar os dados estat√≠sticos dos conte√∫dos. As estat√≠sticas de cada conte√∫do s√£o buscadas no `getStaticProps` e j√° est√£o sendo enviadas para o client, mas o objetivo inicialmente √© testar a integra√ß√£o com a API da Umami, ent√£o a interface ainda n√£o foi preparada para apresentar esses dados.
As principais perguntas que precisamos responder s√£o se os limites da API d√£o conta da nossa demanda e se a performance da API n√£o ir√° prejudicar a performance da gera√ß√£o das p√°ginas de conte√∫dos.

## Tipo de mudan√ßa

- [x] Nova funcionalidade experimental
      </pull*1832*[Umami] Testa compartilhamento de dados estat√≠sticos junto dos conte√∫dos>

---

<pull*1834*[Umami] Remove a busca de dados estat√≠sticos de cada conte√∫do durante a gera√ß√£o das p√°ginas est√°ticas>
Com isso, encerra o experimento sobre a Umami Cloud iniciado no PR #1832.
Considero que obtivemos sucesso ao conseguir as seguintes respostas:

1. Podemos substituir a Vercel Analytics, pois a Umami nos traz mais dados e funcionalidades com um menor custo. ‚úÖ
2. Os limites da API deram conta da nossa demanda normal. Tivemos raros erros com visitas de Bots. ‚úÖ
3. A performance da API impede que os dados sejam buscados durante a gera√ß√£o das p√°ginas est√°ticas ‚ùå
   Sobre a performance, vejam o impacto na dura√ß√£o da gera√ß√£o das p√°ginas de conte√∫dos ap√≥s o merge do #1832. O tempo m√©dio subiu da casa dos 250 ms para cerca de 2 000 ms:

## Conclus√£o

Por causa da performance, n√£o √© vi√°vel buscar as estat√≠sticas na `getStaticProps`, mas podemos perfeitamente fazer a busca pelo _client_ usando um endpoint com cache. E a busca pelo _client_ deve reduzir ainda mais os rar√≠ssimos erros que tivemos com a API.
Esse PR ainda n√£o implementa isso, pois precisamos de uma decis√£o final sobre a mudan√ßa da Vercel para a Umami, mas acredito que essa seja uma mudan√ßa bem vinda.
</pull*1834*[Umami] Remove a busca de dados estat√≠sticos de cada conte√∫do durante a gera√ß√£o das p√°ginas est√°ticas>

---

<pull*1835*[Analytics] Remove Vercel Analytics>
A Umami j√° est√° habilitada para coleta de dados de todas as p√°ginas, ent√£o esse PR remove a Vercel Analytics que estava coletando dados de quase todas (menos `/`e `/publicar`).
Nossa fatura com a Vercel fechou ontem e em um dia j√° usamos quase metade da cota gr√°tis de Analytics (25k eventos). Se mesclarmos esse PR hoje, teremos uma economia estimada em $70 com a Vercel, ou $56 se deixar para depois, desde que dentro dos primeiros 125k eventos.
Considerando que para isso precisamos assinar o plano Pro da Umami, isso representa um custo de $20 mensais, ent√£o o l√≠quido ser√° uma economia de $50 mensais, mas com as vantagens de poder rastrear tamb√©m a Home (`/`), j√° que teremos 1M de eventos inclusos, fora diversas outras vantagens da Umami.
Esse PR remove a integra√ß√£o com a Vercel Analytics do c√≥digo, mas acredito que vale a pena deixar habilitada a configura√ß√£o na Vercel, pois assim mantemos o acesso aos dados antigos, e sem custo, j√° que n√£o estar√£o entrando mais nenhum evento.
</pull*1835*[Analytics] Remove Vercel Analytics>

---

<pull_1836_Melhorias no envio de emails (timeout, vari√°veis de ambiente e testes)>

## Mudan√ßas realizadas

### Timeout de envio

A principal mudan√ßa √© a adi√ß√£o de um tempo limite de 40 segundos para cada tentativa de envio de emails.
Isso √© necess√°rio porque j√° ocorreu de o servi√ßo n√£o responder dentro do limite de tempo das lambdas. Nesses casos, a gente nem tentava usar a conting√™ncia, j√° que nenhum erro era recebido.
Como atualmente as nossas lambdas tem limite de 60 segundos, foi adicionado um timeout de 40 segundos, o que deixa tempo mais do que suficiente para tentar o envio pela conting√™ncia.

### Vari√°veis de ambiente

Como agora utilizamos o SDK do Resend, ent√£o para esse servi√ßo s√≥ s√£o utilizadas as vari√°veis `EMAIL_USER` e `EMAIL_PASSWORD` (ou `EMAIL_USERn` e `EMAIL_PASSWORDn`, com `n` = `1`, `2`...), mas ainda estava sendo necess√°rio adicionar a `EMAIL_SMTP_HOST`, o que foi corrigido. Para outros servi√ßos de email, as demais vari√°veis ainda s√£o necess√°rias: `EMAIL_SMTP_HOST` e `EMAIL_SMTP_PORT`.
Agora √© poss√≠vel alterar a quantidade de retentativas de envio por cada servi√ßo atrav√©s da vari√°vel `RETRIES_PER_EMAIL_SERVICE`. O valor padr√£o continua sendo 1, ou seja, uma tentativa extra para cada servi√ßo configurado.
Tamb√©m √© poss√≠vel alterar o timeout de `40` segundos atrav√©s da vari√°vel `EMAIL_ATTEMPT_TIMEOUT_IN_SECONDS`.

### Testes

Foram adicionados testes para as novas funcionalidades, e tamb√©m os testes que estavam pendentes, que verificam se o envio ocorre via SDK do Resend nas situa√ß√µes espec√≠ficas que isso deve ocorrer.

## Tipo de mudan√ßa

- [x] Novas funcionalidades

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1836_Melhorias no envio de emails (timeout, vari√°veis de ambiente e testes)>

---

<pull*1837*[Analytics] Acessar a Umami Cloud diretamente, sem reescrita da URL>
Estamos enfrentando uma discrep√¢ncia significativa nos n√∫meros de visitantes registrados pela Umami Cloud em compara√ß√£o com a Vercel Analytics. Embora o n√∫mero de visualiza√ß√µes de p√°ginas esteja pr√≥ximo entre as duas ferramentas, o n√∫mero de visitantes √∫nicos registrados pela Umami √© consideravelmente menor ‚Äì mais de 10 vezes menor.
A diferen√ßa pode ser parcialmente explicada pelas metodologias distintas:

- A Vercel utiliza um cookie v√°lido por 1 dia.
- A Umami utiliza um hash do IP combinado com o agente do usu√°rio, com validade de 1 m√™s.
  Ainda assim, a discrep√¢ncia √© maior do que o esperado. Al√©m disso, os logs da Cloudflare indicam que o n√∫mero de visitantes √∫nicos com IPs diferentes acessando o TabNews supera o total de visitantes registrados pela Umami, o que refor√ßa a hip√≥tese de um problema.

## Poss√≠vel causa: Reescrita de URL

Para evitar problemas com bloqueadores de an√∫ncios, configuramos um endpoint no dom√≠nio do TabNews para redirecionar as requisi√ß√µes √† Umami. Esse redirecionamento passa pela Cloudflare e pela Vercel antes de alcan√ßar a Umami. De acordo com o c√≥digo p√∫blico da Umami dispon√≠vel no [reposit√≥rio oficial](https://github.com/umami-software/umami/blob/bce70c1034c6668255261c26093a35900b869566/src/lib/detect.ts#L19C1-L32C2), essa configura√ß√£o n√£o deveria causar problemas, j√° que a Umami utiliza prioritariamente o cabe√ßalho `cf-connecting-ip` da Cloudflare para obter o IP do visitante.

## Tentativas de esclarecimento

Questionei o Suporte da Umami sobre a possibilidade de o c√≥digo da Umami Cloud ser diferente do c√≥digo p√∫blico e se a configura√ß√£o de reescrita poderia estar interferindo. Infelizmente, n√£o houve uma confirma√ß√£o ou negativa clara. O Suporte tamb√©m n√£o garantiu se valeria a pena testar o envio direto para a Umami, sem passar pela Cloudflare e Vercel.

## Mudan√ßas realizadas

Dado que a d√∫vida permanece, decidimos testar o envio de dados diretamente para a Umami, removendo o redirecionamento pela Cloudflare e pela Vercel. Caso essa altera√ß√£o resolva o problema, manteremos a configura√ß√£o direta, mesmo que isso possa resultar em alguma perda de dados devido a bloqueios de requisi√ß√µes feitas para o dom√≠nio da Umami.

- A vari√°vel `UMAMI_ENDPOINT` foi renomeada para `NEXT_PUBLIC_UMAMI_ENDPOINT`, j√° que a Umami Cloud ser√° acessada diretamente pelo client.
- O script de rastreamento agora ser√° obtido diretamente da Umami Cloud.
- O redirecionamento de `/api/v1/analytics` para a Umami foi mantido provisoriamente. Ele atender√° apenas visitantes que j√° estiverem navegando no TabNews durante o deploy desta modifica√ß√£o, e poder√° ser removido futuramente.
  > > Review de Rafatcb (APPROVED):
  > > </pull*1837*[Analytics] Acessar a Umami Cloud diretamente, sem reescrita da URL>

---

<pull_1838_Envia parte dos logs para o Axiom via API, reduzindo o uso do dreno de logs da Vercel>
Os logs gerados pela integra√ß√£o embutida entre a Vercel e o Axiom continuam sendo encaminhados via dreno de logs da Vercel. No entanto, os logs que criamos diretamente com `logger.info` ou `logger.error` agora ser√£o enviados atrav√©s da API do Axiom. Essa mudan√ßa visa reduzir os custos associados ao uso do dreno (alinhado com #1724).
Dependendo dos resultados obtidos, podemos considerar a substitui√ß√£o completa da integra√ß√£o atual pela API do Axiom no futuro.

## Mudan√ßas realizadas

- Foi criada a biblioteca `@tabnews/infra` que, por enquanto, cont√©m apenas o logger. Esse logger integra o `pino` com o Axiom e a Vercel, permitindo que os logs sejam enviados sem atrasar as respostas das requisi√ß√µes e sem correr o risco de as lambdas serem encerradas antes do envio completo dos logs.
- A maneira de definir o ID da requisi√ß√£o foi ajustada para priorizar o cabe√ßalho `x-vercel-id`, facilitando o cruzamento de dados entre os logs enviados pelos diferentes m√©todos.
- Foram adicionadas as vari√°veis de ambiente `AXIOM_DATASET` e `AXIOM_TOKEN`, que s√£o necess√°rias nos ambientes onde a API deve ser utilizada. Sem essas vari√°veis:

  - Em produ√ß√£o e homologa√ß√£o, os logs continuam sendo enviados via integra√ß√£o com a Vercel.
  - Em desenvolvimento, os logs ser√£o direcionados para o `console`.

- Se, localmente, apenas a vari√°vel `AXIOM_DATASET` for definida, os logs ser√£o processados pelo pino antes de ir para o `stdout`. Isso permite analisar o formato e os dados que seriam enviados ao Axiom.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes na `@tabnews/infra` que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Uma melhoria importante!
  > > O motivo para n√£o usar a [integra√ß√£o b√°sica com o Pino](https://axiom.co/docs/guides/pino) no @tabnews/infra ([axiom-transport.js](https://github.com/aprendendofelipe/tabnews/blob/main/packages/infra/src/logger/axiom-transport.js)) √© por causa do `waitUntil`?
  > > </pull_1838_Envia parte dos logs para o Axiom via API, reduzindo o uso do dreno de logs da Vercel>

<pull_1839_Adiciona contador de caracteres onde o Editor √© usado>

## Mudan√ßas realizadas

Foi adicionado um contador de caracteres onde o `Editor` √© usado. Esse comportamento n√£o foi adicionado diretamente no `Editor` para conseguir estilizar o conte√∫do na mesma linha da mensagem de erro.
Implementa√ß√£o baseada no que foi feito e discutido em https://github.com/filipedeschamps/tabnews.com.br/pull/1813, resolvendo os coment√°rios pendentes.
Tamb√©m corrigi o nome da propriedade que era chamada de `isValid`, mas na verdade serve para indicar o erro do `Editor`.
Resolve #1806
https://github.com/user-attachments/assets/5cf17de6-c15f-4bda-8ab4-5a90fe96c553
Resultado numa tela super estreita:

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > Boa @Rafatcb! üí™
  > > Bora pra produ√ß√£o! üöÄ
  > > </pull_1839_Adiciona contador de caracteres onde o Editor √© usado>

<pull_1843_Volta a usar a biblioteca `remove-markdown`>

## Mudan√ßas realizadas

A biblioteca `remove-markdown` passou por um bom per√≠odo sem manuten√ß√£o, por isso fizemos melhorias no c√≥digo dela e trouxemos para dentro do nosso reposit√≥rio.
S√≥ que agora a biblioteca voltou a ser mantida e j√° possui as melhorias que fizemos localmente, al√©m de outras melhorias, ent√£o podemos voltar a us√°-la.
Aproveitei para melhorar a performance do nosso `trim` customizado, adicionando testes que n√£o passariam com a vers√£o anterior.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > Review de aprendendofelipe (COMMENTED):
  > > Coment√°rio de Rafatcb (linha de c√≥digo):
  > > Estamos usando `logError` em algum lugar? N√£o entendi essa linha.
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):
  > > Foi s√≥ uma forma de passar a `throwError` como `true` para a `remove-markdown` pra gente registrar via API do Axiom se algum erro ocorrer. Como hoje queremos isso sempre, poderia muito bem ser s√≥ `options.throwError = true`.
  > > Mas j√° deixei de uma maneira que, se quisermos usar a `customRemoveMarkdown` em algum lugar que n√£o fa√ßa sentido usar a API do Axiom, a gente pode simplesmente desativar esse log passando `logError = false`. E se, no futuro, algum caso exigir algo mais elaborado (talvez logar o erro, mas sem passar pelo `pino`), essa linha pode ajudar a entender por onde come√ßar a mudar o comportamento desse log. Certamente d√° pra fazer isso de uma maneira melhor, mas ficar pensando nisso seria ainda mais _overengineering_ do que j√° √© o que eu fiz. üòÖ
  > > </pull_1843_Volta a usar a biblioteca `remove-markdown`>

<pull_1846_Corrige remo√ß√£o indevida de emojis no `trim` da `removeMarkdown`>
Minha √∫ltima publica√ß√£o no TabNews continha emojis no final do t√≠tulo e do corpo. Depois de um tempo, notei que esses emojis foram removidos na vers√£o publicada.
O `trim` usado na `removeMarkdown`, aprimorado no #1843 para mitigar ReDoS (corrigindo uma vulnerabilidade reportada pelo @pabloemanuelpbl üí™), acabou introduzindo um bug que removia certos emojis. O problema ocorre porque o `trim` analisava os caracteres individualmente em **Unicode UTF-16**, e alguns emojis s√£o representados por **pares de surrogates** nesse formato. Como resultado, esses emojis eram tratados incorretamente e removidos.

## Mudan√ßas realizadas

Foi ajustada a fun√ß√£o para que o `trim` opere corretamente em **Unicode completo**, garantindo que emojis n√£o sejam mais removidos indevidamente.
Aproveitei para inverter a ordem entre a execu√ß√£o do `trim` e do limitador de caracteres, de forma que o limitador atue apenas ap√≥s o `trim`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
      </pull_1846_Corrige remo√ß√£o indevida de emojis no `trim` da `removeMarkdown`>

<pull_1852_Adequa√ß√µes no pool de conex√µes para compatibilidade com Fluid Compute da Vercel>

## Mudan√ßas realizadas

Aumenta o limite do Pool de conex√µes do Postgres para permitir testar a funcionalidade [Fluid Compute](https://vercel.com/blog/introducing-fluid-compute) da Vercel. Como primeiro teste, o limite foi alterado de 1 para 2.
Agora o pool n√£o vai mais descartar todas as conex√µes se ele tiver clientes na fila aguardando para realizar consultas.
Tamb√©m foi aprimorado o tratamento de erro em caso de falha na obten√ß√£o de uma conex√£o do pool. Agora teremos logs se isso ocorrer, mesmo que uma conex√£o ocorra com sucesso em uma segunda tentativa. Com isso, conseguiremos analisar melhor a viabilidade de habilitar a Fluid Compute, al√©m de saber se √© preciso ajustar novamente o limite de conex√µes.

---

Aproveitei para corrigir um teste que n√£o est√° mais habilitado, mas que eu costumo habilitar localmente quando altero configura√ß√µes do banco de dados.
Obs. Para esse teste funcionar, √© preciso desabilitar o limite de 3 votos por IP.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (DISMISSED):
  > > </pull_1852_Adequa√ß√µes no pool de conex√µes para compatibilidade com Fluid Compute da Vercel>

---

<pull*1853*[Continua√ß√£o] Adequa√ß√µes no pool de conex√µes para compatibilidade com Fluid Compute da Vercel>
Continua√ß√£o dos testes iniciados no PR #1852.
Habilitar [Fluid Compute](https://vercel.com/blog/introducing-fluid-compute) √© recomendado para economizar recursos na Vercel (GB-hrs), pois ela tenta processar mais requisi√ß√µes com menos lambdas, aproveitando o tempo ocioso das que j√° est√£o atendendo outras requisi√ß√µes.
Mas ela n√£o consegue evitar que uma requisi√ß√£o tenha que aguardar o processamento de outra (ou a libera√ß√£o de uma conex√£o com o banco de dados), ent√£o essa mudan√ßa, por si s√≥, pode acarretar alguma perda de performance em contrapartida √† economia de recursos.
A perda pode ser percept√≠vel ou n√£o, dependendo do caso. Isso foi confirmado em um teste em que comparei o tempo m√©dio das requisi√ß√µes com e sem Fluid Compute, mantendo as outras configura√ß√µes id√™nticas. Em algumas rotas a performance √© visivelmente pior com Fluid Compute habilitado. Mas pode ser que nesses casos seja mais por competi√ß√£o de conex√µes com o banco de dados do que de recursos da pr√≥pria inst√¢ncia.

## Mas ent√£o por que habilitar Fluid Compute?

### Usar inst√¢ncias melhores

J√° que a Fluid Compute economiza GB-hrs, somado ao fato de que atualmente utilizamos cerca de 1/4 da cota mensal de 1.000 GB-Hrs, podemos aumentar a capacidade de cada inst√¢ncia e talvez ainda permanecer dentro da cota. Pelos nossos testes, aumentar a capacidade da inst√¢ncia de _basic_ para _standard_ (a pr√≥pria Vercel muda isso quando habilitamos a Fluid Compute) proporciona uma melhora significativa nos tempos m√©dios de processamento das requisi√ß√µes.

### Reduzir inicializa√ß√µes a frio

Outra raz√£o para habilitar Fluid Compute √© que usar mais as lambdas pr√© aquecidas pode melhorar o tempo de resposta das requisi√ß√µes em alguns casos. Eu at√© acredito que isso eventualmente ocorra, mas n√£o considero isso por si s√≥ como um bom motivo. Inclusive seria bastante dif√≠cil medir esse impacto isolado.

## Pr√≥ximo teste

Apesar da melhora geral no tempo de processamento da maioria das requisi√ß√µes devido ao aumento da capacidade da inst√¢ncia, algumas rotas que est√£o entre as mais utilizadas tiveram piora com a Fluid Compute habilitada, mesmo subindo ainda mais a inst√¢ncia, de _standard_ para _performance_.
Na verdade, a mudan√ßa na inst√¢ncia praticamente n√£o fez diferen√ßa para essas rotas, o que me faz acreditar que pode estar ocorrendo concorr√™ncia nas conex√µes com o banco de dados. Por isso que esse PR aumenta o limite do _pool_ de 2 para 3 conex√µes simult√¢neas. Vamos analisar se essa mudan√ßa afeta esses casos. Se afetar, podemos analisar se √© o caso de aumentar ainda mais as conex√µes.
Falando em conex√µes... Com a Fluid Compute habilitada estou observando uma oscila√ß√£o bem maior na quantidade de conex√µes simult√¢neas com o Postgres. O patamar inferior permanece igual, mas os picos aumentaram, tanto em frequ√™ncia, como em amplitude.
Esse aumento no n√∫mero de conex√µes abertas em momentos de maior necessidade deve contribuir tamb√©m para manter a performance mais equilibrada entre momentos com fluxos diferentes.

## Mudan√ßas realizadas

Aumenta de 2 para 3 o limite do Pool de conex√µes de cada lambda com o Postgres.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
      </pull*1853*[Continua√ß√£o] Adequa√ß√µes no pool de conex√µes para compatibilidade com Fluid Compute da Vercel>

---

<pull_1854_Atualiza o `next-connect` para `v1.0.0`>

## Mudan√ßas realizadas

Atualiza o `next-connect` para [`v1.0.0`](https://www.npmjs.com/package/next-connect/v/1.0.0) e aplica os ajustes necess√°rios para compatibilidade:

- Substitui `nextConnect()` por `createRouter()` e `.handler()`;
- Garante que cada _middleware_ retorne `next()` ao inv√©s de apenas executar `next()`;
- Remove a op√ß√£o `attachParams`.

## Tipo de mudan√ßa

- [x] Atualiza√ß√£o de depend√™ncias

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1854_Atualiza o `next-connect` para `v1.0.0`>

<pull_1855_Remove a l√≥gica de redirecionamento p√≥s-login de dentro do hook `useUser`>
O redirecionamento p√≥s-login depende do router do Next.js, cuja configura√ß√£o varia entre a App Router e a Pages Router.
Como essa l√≥gica s√≥ √© necess√°ria na pr√≥pria p√°gina de login, mov√™-la para l√° permite que o `useUser` funcione de forma independente do roteamento do Next.js. Com isso, o `useUser` agora pode ser utilizado tamb√©m com a App Router.

## Mudan√ßas realizadas

Move essa l√≥gica do arquivo `hooks/useUser/index.js` para o arquivo `pages/login.public.js`.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes est√£o passando localmente.
  > > Review de github-advanced-security[bot] (COMMENTED):
  > > Review de Rafatcb (APPROVED):
  > > Coment√°rio de github-advanced-security[bot] (linha de c√≥digo):

## Client-side URL redirect

Untrusted URL redirection depends on a [user-provided value](1).
[Show more details](https://github.com/filipedeschamps/tabnews.com.br/security/code-scanning/43)
</pull_1855_Remove a l√≥gica de redirecionamento p√≥s-login de dentro do hook `useUser`>

<pull_1859_Limita a aloca√ß√£o de mem√≥ria em 1GB no `vercel.json`>
Com a ativa√ß√£o do Fluid Compute da Vercel, aumentamos a capacidade das inst√¢ncias para o n√≠vel `Performance`, que oferece 1.7 vCPUs e 3 GB de mem√≥ria. No entanto, mesmo com o compartilhamento de recursos, o consumo de mem√≥ria raramente ultrapassa 500 MB. Com base nisso, podemos limitar a aloca√ß√£o de mem√≥ria das fun√ß√µes para otimizar o uso de recursos da Vercel, que s√£o medidos em GB-Hrs.

## Mudan√ßas realizadas

Configuramos o `vercel.json` para restringir a aloca√ß√£o de mem√≥ria das fun√ß√µes a, no m√°ximo, 1024 MB. Esse j√° era o nosso valor padr√£o antes da ativa√ß√£o do Fluid Compute.
</pull_1859_Limita a aloca√ß√£o de mem√≥ria em 1GB no `vercel.json`>

<pull_1860_Aumenta o limite de aloca√ß√£o de mem√≥ria para 1769MB no `vercel.json`>
Ap√≥s o PR #1859, que limitou a aloca√ß√£o de mem√≥ria a 1GB, observamos um impacto negativo na performance. O tempo m√©dio de resposta das requisi√ß√µes piorou em rela√ß√£o ao per√≠odo anterior ao PR e tamb√©m ficou pior do que antes da ativa√ß√£o do Fluid Compute.
Curiosamente, nos √∫ltimos 30 dias, o uso de mem√≥ria nunca passou de 680MB, ficando geralmente na faixa dos 400MB. Al√©m disso, antes do Fluid Compute, o limite era de 0.6 vCPU e 1GB de mem√≥ria, enquanto com o PR #1859 passamos a ter 1.7 vCPU, mas mantendo o limite de 1GB.
Isso levanta a quest√£o: ser√° que, com o Fluid Compute ativado, os valores de utiliza√ß√£o de mem√≥ria que a Vercel exibe n√£o refletem mais o uso real de cada inst√¢ncia quando ela atende m√∫ltiplas requisi√ß√µes simultaneamente?
Outro ponto a registrar √© que, ap√≥s o PR #1859, houve algumas falhas de timeout ao conectar com o banco de dados. Mas isso pode ter sido apenas coincid√™ncia.

## Mudan√ßas realizadas

Dado o impacto observado, estou aumentando o limite de aloca√ß√£o de mem√≥ria para 1769MB, que √© o padr√£o das inst√¢ncias com Fluid Compute ativado.
</pull_1860_Aumenta o limite de aloca√ß√£o de mem√≥ria para 1769MB no `vercel.json`>

<pull_1862_Cria `event` ao atualizar a senha do usu√°rio>

## Mudan√ßas realizadas

Hoje j√° √© criado um evento ao atualizar algum dado do usu√°rio, implementado no PR #1615 e #1727, mas a senha √© atualizada por um fluxo diferente, ent√£o o evento n√£o era criado nessa situa√ß√£o.
Tamb√©m aproveitei para validar o campo `metadata` do `event` para o tipo `update:user`.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > Boa @Rafatcb! üí™
  > > S√≥ alterei o uso do `RequestBuilder` no lugar do `fetch` para manter o padr√£o nos testes de eventos. ü§ù
  > > </pull_1862_Cria `event` ao atualizar a senha do usu√°rio>

<pull_1864_fix: Corre√ß√£o ortografica nativa!>
fix: Corre√ß√£o ortografica nativa!

> > Review de Rafatcb (COMMENTED):
> > Como estamos habilitando o `spellcheck` no `Editor`, me parece uma boa ideia tamb√©m habilitar no campo `T√≠tulo`. Al√©m de habilitarmos `autocapitalize` em ambos.
> > Em navegadores no computador parece que est√° funcionando bem, de acordo com o dicion√°rio dispon√≠vel no navegador, mas no celular testei no Safari e no Chrome e n√£o funcionou. Testei o `autocapitalize` no `TextInput` e tamb√©m n√£o funcionou 100% do tempo. N√£o sei se √© alguma configura√ß√£o ou se os navegadores de celular n√£o tem isso bem implementado.
> > Ent√£o, se concordarem com essa mudan√ßa, podemos aproveitar para declarar as propriedades direto em `editorConfig`, sem criar uma vari√°vel, remover os coment√°rios e corrigir os commits. Como o autor do PR teve dificuldade com o Git (vide [publica√ß√£o no TabNews](https://www.tabnews.com.br/diversalizando/correcao-ortografica-tabnews)), um mantenedor do reposit√≥rio pode fazer isso e deixar o commit com co-autoria.
> > </pull_1864_fix: Corre√ß√£o ortografica nativa!>

<pull_1865_docs: Corre√ß√µes Gramaticais na P√°gina `Termos de Uso`>

## Mudan√ßas realizadas

Foram feitas algumas mudan√ßas gramaticais na p√°gina de `Termos de Uso` sugeridas pelo usu√°rio `LucasGoncSilva`
Resolve #1840

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Atualiza√ß√£o de documenta√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Garccosta (APPROVED):
  > > Review de aprendendofelipe (COMMENTED):
  > > @OLuizFernando, muito obrigado pela contribui√ß√£o! üí™
  > > Veja, por favor, se concorda com as minhas sugest√µes. ü§ù
  > > Review de Jeiel0rbit (COMMENTED):
  > > Review de Jeiel0rbit (APPROVED):
  > > Com exce√ß√£o [deste](https://github.com/filipedeschamps/tabnews.com.br/pull/1865/files), restante est√° bem estruturado e corrigido, de algumas palavras, para concordar com contexto.
  > > Review de aprendendofelipe (COMMENTED):
  > > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  1. O usu√°rio possui os direitos autorais sobre os conte√∫dos que publicou na plataforma e se responsabiliza integralmente por eles, declarando possuir os direitos de uso do que for publicado ou que o conte√∫do est√° enquadrado dentro do "Fair Use" ("Limita√ß√£o aos direitos de Autor" encontrado na \`LDA\`).
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  3. Daremos prefer√™ncia √† **qualidade** sobre **quantidade**; neste ponto, especificamente, nosso objetivo √© atingir um est√°gio onde **tudo o que voc√™ ler dentro do TabNews ter√° valido a pena**, de alguma forma.
```

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

```suggestion
  4. Da mesma forma, est√£o **estritamente proibidos** atos discriminat√≥rios de qualquer tipo, como homofobia, transfobia, xenofobia, capacitismo, discrimina√ß√£o pelo sexo, idade, ra√ßa, cor, classe social ou qualquer outra forma de segrega√ß√£o.
```

> > Coment√°rio de Jeiel0rbit (linha de c√≥digo):
> > N√£o sou ele, mas se me permite... "valido a pena", est√° muito estranho. Eu deixaria "valor agregado", algo mais t√©cnico e profissional. Leitura flui melhor.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Concordo que "valor agregado" soa mais t√©cnico e profissional, ou seja, mudar isso n√£o √© uma corre√ß√£o gramatical, mas sim uma escolha de estilo.
> > Mudar para "valor agregado" seria uma altera√ß√£o no tom e na conota√ß√£o do texto, o que foge da motiva√ß√£o de um PR focado em corre√ß√µes gramaticais.
> > </pull_1865_docs: Corre√ß√µes Gramaticais na P√°gina `Termos de Uso`>

<pull_1866_Migra√ß√£o: adiciona coluna `email` em `activate_account_tokens`>

## Mudan√ßas realizadas

Adiciona coluna email em `activate_account_tokens` para ser preenchida no cadastro, assim teremos uma forma de identificar qual √© o email inicial do usu√°rio.
Este PR cont√©m apenas a migra√ß√£o, para que o c√≥digo possa ser mesclado e a migra√ß√£o executada sem o risco de ocorrer algum cadastro tentando salvar um valor numa coluna inexistente antes de rodar a migra√ß√£o.

## Tipo de mudan√ßa

- [x] Migra√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1866_Migra√ß√£o: adiciona coluna `email` em `activate_account_tokens`>

<pull_1868_Salva e-mail do usu√°rio ao criar o `activate_account_tokens`>

## Mudan√ßas realizadas

A migra√ß√£o para cria√ß√£o do campo `email` na tabela `activate_account_tokens` foi feita no PR #1866, e com este PR passamos a preencher o campo no cadastro, o que torna poss√≠vel identificar o primeiro e-mail usado no cadastro.
Antes deste PR, era poss√≠vel identificar apenas o email atual do usu√°rio pela tabela `users` e emails alterados por meio da tabela `email_confirmation_tokens`.
Para preencher a coluna `email` em `activate_account_tokens` dos usu√°rios que nunca alteraram seu email, podemos rodar este SQL manualmente:

```sql
UPDATE activate_account_tokens AS a
SET email = u.email, updated_at = NOW()
FROM users AS u
WHERE a.user_id = u.id
  AND a.email IS NULL
  AND NOT EXISTS (
    SELECT 1
    FROM email_confirmation_tokens AS ect
    WHERE ect.user_id = u.id AND ect.used = true
  );
```

N√£o √© poss√≠vel preencher o `email` dos usu√°rios que j√° alteraram ele alguma vez.

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > Boa @Rafatcb! üí™
  > > Vamos para o Merge, mas fica pendente adicionar testes para esse novo comportamento. ü§ù
  > > </pull_1868_Salva e-mail do usu√°rio ao criar o `activate_account_tokens`>

<pull_1870_fix: prevent search dialog from breaking on rapid clicks (#1841)>

## Mudan√ßas realizadas

This pull request fixes issue #1841, where repeatedly clicking multiple times would prevent the styles from loading.

<!-- Por favor, inclua uma descri√ß√£o sobre o que foi modificado nesse PR. Inclua tamb√©m qualquer motiva√ß√£o ou contexto relevante.  -->
<!-- Se o PR cont√©m uma modifica√ß√£o da interface gr√°fica (UI), adicione fotos ou v√≠deos comparando o antes e depois. -->
<!-- Se o PR cont√©m modifica√ß√µes de API, mencione os endpoints afetados. -->

### Before

https://github.com/user-attachments/assets/f53b5ef3-a4a2-4e25-b0da-60c6b8f9f9d7

### After

https://github.com/user-attachments/assets/a3dc180b-9d36-4ffd-84fa-2f1ee06fd045

## Tipo de mudan√ßa

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

- [x] Corre√ß√£o de bug
  <!-- - [x] Nova funcionalidade -->
  <!-- - [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [x] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de copilot-pull-request-reviewer[bot] (COMMENTED):

## Pull Request Overview

This PR fixes an issue where repeated clicks on the search dialog caused styling problems by modifying the search box close behavior.

- Removed the timeout that conditionally cleared the Google Box.
- Immediately call clearGoogleBox() when closing the search box.
<details>
<summary>Comments suppressed due to low confidence (1)</summary>

**pages/interface/components/SearchBox/index.js:96**

- Eliminating the conditional delay previously used to clear the Google Box may lead to unintended side effects if the input element is still visible. Verify that this change does not disrupt other behaviors that relied on the timeout check.

```
clearGoogleBox();
```

</details>
> > Review de aprendendofelipe (APPROVED):
> > Boa @Caixetadev, obrigado por mais essa contribui√ß√£o! üí™
Isso corrige o bug reportado em #1841 e n√£o consegui perceber nenhum problema pela remo√ß√£o do `setTimeout`, ent√£o vamos mesclar. ü§ù
</pull_1870_fix: prevent search dialog from breaking on rapid clicks (#1841)>

<pull_1873_Atualiza Next.js, `@tabnews/ui` e outras bibliotecas>

## Mudan√ßas realizadas

- 664b079f8d504db1fbe65b7f61464ea68d0fa28e: Atualiza o Next.js, e faz as adequa√ß√µes necess√°rias devido a um [bug](https://github.com/vercel/next.js/issues/51478#issuecomment-2095745187):
- 98f6c8b33329770a664599082a798f9b1dbecb1d: Atualiza a `@tabnews/ui` e faz as adequa√ß√µes necess√°rias pela [mudan√ßa](https://github.com/primer/react/discussions/5165) da `@primer/react` para CSS Modules.
- 6fdbc46d490bf1a873c2f4afab16bbb839f7ef27: Atualiza as demais depend√™ncias de produ√ß√£o que n√£o exigem adequa√ß√µes no c√≥digo.
- a0ce1c99f07ce0f6475ec751fb0f918a2e54f4d3: Atualiza as depend√™ncias de desenvolvimento que n√£o exigem adequa√ß√µes no c√≥digo.
- 81a11c98da1dac7a9da851a2e51d445d40e9c67c: Atualiza o Prettier e faz adequa√ß√µes de estilo.
- 39cbf7d446ce559895b56090833846838a8c9368: Atualiza a `@faker-js/faker` e atualiza o m√©todo de gera√ß√£o de usernames.

## Tipo de mudan√ßa

- [x] Atualiza√ß√£o de depend√™ncias

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.

  > > Review de copilot-pull-request-reviewer[bot] (COMMENTED):
  > > Copilot reviewed 7 out of 8 changed files in this pull request and generated no comments.

  <details>
  <summary>Files not reviewed (1)</summary>

- **package.json**: Language not supported
</details>
<details>
<summary>Comments suppressed due to low confidence (1)</summary>

**tests/orchestrator.js:152**

- Ensure that the new faker.internet.username() method returns a username format consistent with previous expectations. If the output format has changed, corresponding tests or expectations might need updating.

```
username = faker.internet.username().replace(/[_.-]/g, '').substring(0, 30);
```

</details>
> > Review de Rafatcb (APPROVED):
> > Fiz alguns testes no ambiente de preview: naveguei pelo site, realizei buscas, criei um coment√°rio, apaguei, editei, dei upvote, usei o modo claro e escuro, alterei a senha, e tamb√©m testei no celular.
N√£o encontrei nada quebrado :+1:
</pull_1873_Atualiza Next.js, `@tabnews/ui` e outras bibliotecas>

<pull_1874_Altera extens√£o dos templates de email de `.js` para `.jsx`>
Para compatibilidade com o servidor de desenvolvimento do React Email:

## Mudan√ßas realizadas

Apenas alteradas as extens√µes dos arquivos de templates de email de `.js` para `.jsx`, eliminando o erro `The JSX syntax extension is not currently enabled`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1874_Altera extens√£o dos templates de email de `.js` para `.jsx`>

<pull_1875_Atualiza o Vitest para a vers√£o 3>

## Mudan√ßas realizadas

Atualiza o Vitest para a vers√£o 3 e faz os ajustes necess√°rios:

- Substitui a op√ß√£o `environmentMatchGlobs` ([deprecada](https://vitest.dev/config/#environmentmatchglobs)) pela `workspace`.
- Ajusta os testes de `infra/email` para a nova compara√ß√£o [mais profunda](https://github.com/vitest-dev/vitest/pull/5876) de erros customizados.

## Tipo de mudan√ßa

- [x] Atualiza√ß√£o de depend√™ncias

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1875_Atualiza o Vitest para a vers√£o 3>

<pull_1876_Fix/invisible button text color>
A atualiza√ß√£o da `@tabnews/ui` trouxe uma vers√£o mais recente da `@primer/react` e, com ela, uma mudan√ßa na estiliza√ß√£o dos bot√µes "invis√≠veis".

## Mudan√ßas realizadas

Esse PR aplica o estilo anterior definindo a cor do texto para `accent.fg`, que era a cor padr√£o para a variante `invisible` do bot√£o.
Tamb√©m foram atualizadas algumas depend√™ncias, o que inclui a `@tabnews/ui` com a mesma corre√ß√£o.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de Rafatcb (APPROVED):
  > > </pull_1876_Fix/invisible button text color>

<pull_1878_Adiciona a biblioteca `@tabnews/config`>

## Mudan√ßas realizadas

Padroniza parte da configura√ß√£o do ambiente de desenvolvimento com rela√ß√£o aos outros projetos relacionados ao TabNews.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de Rafatcb (APPROVED):
  > > </pull_1878_Adiciona a biblioteca `@tabnews/config`>

<pull_1879_Corrige quebra de caracteres multibyte no truncamento>
Alguns conte√∫dos raros causam problemas durante a renderiza√ß√£o e/ou durante o envio de notifica√ß√µes quando:

- O t√≠tulo ou o corpo √© truncado de maneira que um caractere multibyte, como um emoji, acaba sendo cortado.
- Ocorre erro de valida√ß√£o do `body` quando a string de sa√≠da da `removeMarkdown` come√ßa com caracteres invis√≠veis.

## Mudan√ßas realizadas

- Utiliza a fun√ß√£o `truncate` da `@tabnews/helpers` que garante que caracteres multibyte n√£o sejam quebrados.
- Passa a usar as fun√ß√µes `trimEnd` e `trimStart` diretamente da `@tabnews/helpers`.
- Torna padr√£o o `trim` na `removeMarkdown`.
- Adiciona alguns testes b√°sicos para a `removeMarkdown`.
- Separa os testes de unidade e de integra√ß√£o para evitar conflitos com os mocks.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > √ìtimo teste com o emoji.
  > > </pull_1879_Corrige quebra de caracteres multibyte no truncamento>

<pull_1880_Elimina tr√°fego de dados desnecess√°rios nas p√°ginas de coment√°rios>
Nas p√°ginas de coment√°rios que s√£o filhos diretos de conte√∫dos root, n√£o precisamos duplicar os dados de `parent` e `root`, que s√£o os mesmos, e tamb√©m n√£o precisamos do `body` do `parent`/`root`, pois apenas o t√≠tulo √© renderizado.

## Mudan√ßas realizadas

- Remove o `body` que n√£o √© necess√°rio para renderizar a p√°gina de um coment√°rio. Na verdade ele j√° n√£o era enviado para o client, mas era enviado do banco de dados para a lambda.
- Quando o `parent` e o `root` s√£o o mesmo, envia apenas o `id` do `root` que √© o √∫nico dado utilizado nesses casos.

## Tipo de mudan√ßa

- [x] Otimiza√ß√£o/Performance

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1880_Elimina tr√°fego de dados desnecess√°rios nas p√°ginas de coment√°rios>

<pull_1881_Adicionar espa√ßo entre `[N√£o dispon√≠vel]` e `dentro da publica√ß√£o` no componente `InReplyToLinks`>

## Mudan√ßas realizadas

Corrige o problema pr√© existente notado ao testar o PR #1880.

-- | --

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug
  > > Review de Rafatcb (APPROVED):
  > > </pull_1881_Adicionar espa√ßo entre `[N√£o dispon√≠vel]` e `dentro da publica√ß√£o` no componente `InReplyToLinks`>

---

<pull*1882*[Breaking Change] Remove dados an√¥nimos de conte√∫dos apagados>

## Mudan√ßas realizadas

### **Breaking change** na API

Os endpoints abaixo passam a n√£o retornar mais os dados an√¥nimos de conte√∫dos exclu√≠dos:

- `/api/v1/contents/[username]/[slug]/parent`
- `/api/v1/contents/[username]/[slug]/root`
  Era poss√≠vel recuperar dados do autor e saldos de TabCoins de conte√∫dos j√° apagados que possu√≠am coment√°rios ainda p√∫blicos. Agora esses campos an√¥nimos n√£o s√£o mais retornados na API.
  Como j√° ia ser uma breaking change, aproveitei para remover tamb√©m os campos que j√° eram retornados de maneira "anonimizada", mas que n√£o s√£o confi√°veis para dizer se um conte√∫do foi exclu√≠do. O campo `status` √© o √∫nico que deve ser considerado para isso.

### Notifica√ß√µes

Durante o ajuste do model `notification`, notei que a gente notificava um autor do conte√∫do pai mesmo quando era criado um coment√°rio com status diferente de p√∫blico. Ent√£o aproveitei para mudar esse comportamento e adicionar cobertura de teste.

## Tipo de mudan√ßa

- [x] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API)

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull*1882*[Breaking Change] Remove dados an√¥nimos de conte√∫dos apagados>

---

<pull_1884_Migra√ß√£o para o `Markdown` da biblioteca `@tabnews/ui`>

## Mudan√ßas realizadas

Utiliza as novas vers√µes do `MarkdownEditor`, `MarkdownViewer` e `GoToTopButton` diretamente da biblioteca `@tabnews/ui`.
[**Edit**] √â poss√≠vel notar alguns ganhos na estiliza√ß√£o do editor seguindo o padr√£o da Primer, como na borda mais arredondada e a estiliza√ß√£o correta em caso de campo inv√°lido. E agora √© poss√≠vel redimensionar o editor no Safari do macOS.

## Tipo de mudan√ßa

- [x] Melhorias na estiliza√ß√£o do editor de markdown

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de Rafatcb (DISMISSED):
  > > Notei uma regress√£o visual na borda do editor de **coment√°rio** quando focado, no Linux (Wayland), nos navegadores Zen e Firefox. Parece que eles tem um certo problema em renderizar a borda de `1px` com o `outline-offset: -1px;`. N√£o vi exatamente quais estilos mudaram para entender a causa do problema.
  > > | Antes | Depois |
  > > | ----- | ------ |
  > > | | |
  > > O resultado acima √© no Zen, mas no Firefox est√° igual. Ao abrir o inspetor, as coisas j√° mudam: as bordas laterais ficaram "grossas" no Zen:
  > > J√° no Firefox, √© a borda inferior que fica grossa.
  > > O editor de nova publica√ß√£o est√° normal nos navegadores citados (Zen, Firefox e Chrome).
  > > N√£o acho que seja um impeditivo para mesclar, porque pode ser um problema do Gecko, do Wayland ou da mistura de ambos.
  > > Review de Rafatcb (COMMENTED):
  > > O problema na borda foi resolvida üéâ
  > > Mas, agora, a cor de fundo da √°rea com "texto" no Visualizador (do Editor) est√° diferente do resto üòì
  > > Talvez fique ruim de ver na print, mas onde h√° texto, est√° um fundo com ret√¢ngulo branco, e no resto, cinza.
  > > O problema tamb√©m acontece na visualiza√ß√£o lado-a-lado, mas ao focar, √© resolvido (todo o fundo fica branco).
  > > Testado no Zen, Brave e Edge no Windows.
  > > Review de Rafatcb (APPROVED):
  > > Parece tudo certo agora üí™
  > > </pull_1884_Migra√ß√£o para o `Markdown` da biblioteca `@tabnews/ui`>

<pull_1885_Corrige warning do `husky` sobre configura√ß√£o obsoleta>

## Mudan√ßas realizadas

Devido √† atualiza√ß√£o da biblioteca `husky`, cada commit est√° gerando o warning abaixo:

```sh
husky - DEPRECATED
Please remove the following two lines from .husky/pre-commit:

#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"
They WILL FAIL in v10.0.0
```

Para resolver, basta remover as linhas indicadas na mensagem. Ao remover de `.husky/pre-commit`, o mesmo erro ocorre para `.husky/commit-msg`, por isso ambos arquivos foram modificados.
Refer√™ncia complementar: [Changelog da vers√£o 9.0.1](https://github.com/typicode/husky/releases/tag/v9.0.1), se√ß√£o "How to migrate".

## Tipo de mudan√ßa

- [x] Corre√ß√£o de warning

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1885_Corrige warning do `husky` sobre configura√ß√£o obsoleta>

<pull_1886_Atualiza o cache local do usu√°rio ap√≥s confirmar a altera√ß√£o do email cadastrado>
O cache dos dados do usu√°rio no client n√£o era for√ßado a ser atualizado ap√≥s uma confirma√ß√£o de altera√ß√£o do email. Com isso, retornar para a p√°gina de edi√ß√£o do perfil logo ap√≥s alterar o email poderia confundir o usu√°rio ao mostrar ainda o endere√ßo anterior.

## Mudan√ßas realizadas

Atualiza o cache dos dados do usu√°rio no client ap√≥s uma confirma√ß√£o de altera√ß√£o do email.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de Rafatcb (APPROVED):
  > > </pull_1886_Atualiza o cache local do usu√°rio ap√≥s confirmar a altera√ß√£o do email cadastrado>

<pull_1887_Move responsabilidade de chamar `clearSessionIdCookie` do model `controller` para o `session`>

## Mudan√ßas realizadas

- Separa as responsabilidades e remove a depend√™ncia que o model `controller` tinha com o model `session`.
- Permite retornar um `UnauthorizedError` mesmo em situa√ß√µes em que n√£o √© necess√°rio remover a sess√£o do usu√°rio.

## Tipo de mudan√ßa

- [x] Refatora√ß√£o

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1887_Move responsabilidade de chamar `clearSessionIdCookie` do model `controller` para o `session`>

<pull_1890_Responde requisi√ß√µes sem aguardar envio de emails>

## Mudan√ßas realizadas

Passa a utilizar a fun√ß√£o `waitUntil` da Vercel para os envios de emails. Com isso, as fun√ß√µes lambdas respondem √†s requisi√ß√µes sem aguardar o envio, que continua mesmo ap√≥s a resposta.
A maior parte das mudan√ßas est√° nos testes. Como as requisi√ß√µes agora s√£o respondidas antes do envio dos e-mails, a responsabilidade de aguardar os envios passou para o orquestrador (nos testes em que os emails s√£o verificados).
Al√©m da melhoria de performance em algumas requisi√ß√µes, essa mudan√ßa tamb√©m dificulta a varredura de endere√ßos cadastrados atrav√©s de alguns endpoints.

## Tipo de mudan√ßa

- [x] Nova funcionalidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos foram ajustados e est√£o passando localmente.
  > > Review de copilot-pull-request-reviewer[bot] (COMMENTED):

## Pull Request Overview

This PR improves performance and security by sending emails asynchronously using Vercel‚Äôs waitUntil function rather than blocking responses, and adjusts the tests to handle the new asynchronous email sending behavior.

- Refactored email waiting functions in the test orchestrator (introducing waitForFirstEmail, waitForNthEmail, and hasEmailsAfterDelay)
- Updated tests to check for asynchronous email behavior and revised email sending calls in the models to use triggerSend
- Minor adjustments to related test flows and orchestration functions to maintain consistency

### Reviewed Changes

Copilot reviewed 13 out of 13 changed files in this pull request and generated 1 comment.

<details>
<summary>Show a summary per file</summary>
| File                                                      | Description                                                                                                      |
| --------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| tests/orchestrator.js                                     | Replaced getLastEmail with waitForFirstEmail, waitForNthEmail, and hasEmailsAfterDelay; updated email wait logic |
| tests/integration/api/v1/users/firewall.post.test.js      | Updated usage of email functions to reflect asynchronous email sending                                           |
| tests/integration/api/v1/users/[username]/patch.test.js   | Replaced getLastEmail with waitForFirstEmail/hasEmailsAfterDelay in tests                                        |
| tests/integration/api/v1/recovery/post.test.js            | Adjusted tests to wait for email events asynchronously                                                           |
| tests/integration/api/v1/email-confirmation/patch.test.js | Updated to use waitForFirstEmail and hasEmailsAfterDelay accordingly                                             |
| tests/integration/api/v1/contents/\*.test.js              | Updated various tests to check email sending behavior asynchronously                                             |
| models/\*                                                 | Changed email.send to email.triggerSend for asynchronous processing                                              |
| infra/email.js                                            | Introduced triggerSend to use waitUntil for non-blocking email sending                                           |
</details>
> > Coment√°rio de Copilot (linha de c√≥digo):
> > [nitpick] Consider returning null instead of undefined when no email is received to maintain consistency with previous implementations that returned null.
```suggestion
  return null;
```
</pull_1890_Responde requisi√ß√µes sem aguardar envio de emails>

<pull_1891_Melhorias no processo de recupera√ß√£o de senha>
Atualmente usu√°rios banidos conseguem solicitar um token de recupera√ß√£o de senha. Esse token n√£o tem utilidade para esses usu√°rios, mas mesmo assim o token √© enviado para o email deles.

## Mudan√ßas realizadas

O principal √© corrigir o bug que deixava enviar o token de recupera√ß√£o mesmo para usu√°rios banidos, mas tamb√©m:

- Retorna erro 404 no lugar do 400 quando modera√ß√£o tenta recuperar a senha de usu√°rio inexistente (ou banido).
- Transfere regra de neg√≥cio do _controller_ para o model _recovery_.
- Pequena refatora√ß√£o nos testes, onde agora o usu√°rio moderador √© criado apenas uma vez.
- Melhoria nos testes confirmando o n√£o envio de emails em alguns cen√°rios do que antes.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
      </pull_1891_Melhorias no processo de recupera√ß√£o de senha>

<pull_1892_Limita cria√ß√£o de tokens de recupera√ß√£o de senha para evitar abuso>
Hoje n√£o h√° limite para a cria√ß√£o de tokens de recupera√ß√£o de senha, o que permite m√∫ltiplos envios de e-mails e abre espa√ßo para abuso do sistema.

## Mudan√ßas realizadas

- Define um limite de **dois tokens v√°lidos simult√¢neos** por usu√°rio.
- Tokens expirados ou j√° utilizados n√£o **contam para esse limite**.
- Quando o limite √© atingido, o endpoint retorna uma resposta falsa (token simulado), sem disparo de novo e-mail (comportamento importante por ser uma rota p√∫blica, sem autentica√ß√£o).
- Adiciona testes para garantir o novo comportamento.
- Restringe o uso de fun√ß√µes sens√≠veis do model _recovery_ apenas ao ambiente de testes, como medida adicional de seguran√ßa.
- Removido c√≥digo morto da fun√ß√£o `resetUserPassword`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de vulnerabilidade

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
      </pull_1892_Limita cria√ß√£o de tokens de recupera√ß√£o de senha para evitar abuso>

<pull_1893_Atualiza `@tabnews/config` para `0.6.0`>

## Mudan√ßas realizadas

A atualiza√ß√£o habilita duas regras do ESLint que resultaram nas altera√ß√µes feitas: [react/jsx-no-useless-fragment](https://github.com/jsx-eslint/eslint-plugin-react/blob/master/docs/rules/jsx-no-useless-fragment.md) e [react/no-unstable-nested-components](https://github.com/jsx-eslint/eslint-plugin-react/blob/master/docs/rules/no-unstable-nested-components.md).
Assim, simplificamos o c√≥digo removendo fragmentos desnecess√°rios, e evitamos poss√≠veis bugs que surgem com componentes aninhados. Veja as regras linkadas para mais detalhes.

## Tipo de mudan√ßa

- [x] Atualiza√ß√£o de depend√™ncias

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1893_Atualiza `@tabnews/config` para `0.6.0`>

<pull_1894_Agrupa testes para `username` e `email` duplicados>

## Mudan√ßas realizadas

Melhora organiza√ß√£o dos testes e facilita a revis√£o do PR #1790, visto que o commit foi extra√≠do de l√° (resolvendo conflitos).
Os testes n√£o foram modificados.

## Tipo de mudan√ßa

- [x] Testes

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de aprendendofelipe (APPROVED):
  > > </pull_1894_Agrupa testes para `username` e `email` duplicados>

<pull_1896_Corrige o estado inicial do seletor de temas (dark/light)>
Em dispositivos em que o tema preferencial do usu√°rio ainda n√£o foi selecionado, o padr√£o √© o tema claro, mas o √≠cone permanece como se estivesse selecionado o tema escuro, e s√≥ ap√≥s clicar duas vezes √© que o tema realmente muda.

## Mudan√ßas realizadas

Corrige esse comportamento, fazendo o estado inicial corresponder ao tema atual correto.
Salva o estado de prefer√™ncia do usu√°rio como `light`, `dark` ou `auto` (antes era `day`, `night` e `auto`).

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de Rafatcb (APPROVED):
  > > Est√° funcionando :handshake:
  > > O problema surgiu com a implementa√ß√£o https://github.com/filipedeschamps/tabnews.com.br/pull/1801, porque o `AutoThemeProvider` usa `light` e `dark` , certo?
  > > </pull_1896_Corrige o estado inicial do seletor de temas (dark/light)>

<pull_1897_Altera a maneira de definir o atributo HTML `lang`>
Atualmente o Next.js cont√©m um bug onde rotas din√¢micas podem apresentar erro `500` quando a internacionaliza√ß√£o est√° configurada via `next.config.js`.
Os dois links abaixo levam para a mesma p√°gina inexistente `/[username]`, mas a vers√£o anterior apresenta erro `500`, enquanto a vers√£o desse PR retorna corretamente `404`:
| **Antes** | [**https://tabnews-3jnyq7jmb-tabnews.vercel.app/[username]**](https://tabnews-3jnyq7jmb-tabnews.vercel.app/[username]) |
| ---------- | ---------------------------------------------------------------------------------------------------------------------- |
| **Depois** | [**https://tabnews-1h5k6kj6j-tabnews.vercel.app/[username]**](https://tabnews-1h5k6kj6j-tabnews.vercel.app/[username]) |

## Mudan√ßas realizadas

Atualiza diversas bibliotecas, entre elas a `@tabnews/ui`, o que permite configurar o atributo `lang` via `_document`.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
      </pull_1897_Altera a maneira de definir o atributo HTML `lang`>

<pull_1900_feat: bot√£o de compartilhar adicionado>

## Mudan√ßas realizadas

Adicionei um bot√£o de compartilhar ao lado do bot√£o de _responder_ em `pages/interface/components/Content/index.js`.

<!-- Descomente a linha abaixo que corresponde ao tipo de mudan√ßa realizada no PR. -->

## Tipo de mudan√ßa

<!-- - [ ] Corre√ß√£o de bug -->

- [x] Nova funcionalidade
  <!-- - [ ] _**Breaking change**_ (a altera√ß√£o causa uma quebra de compatibilidade na API ou em links p√∫blicos do site) -->
  <!-- - [ ] Atualiza√ß√£o de documenta√ß√£o -->

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [ ] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.

## Imagens

| Imagem 1 | Imagem 2 |
| :------: | :------: |
|          |          |

> Modo PWA.

## Motivo

Atualmente, para compartilhar um post √© necess√°rio copiar manualmente a URL completa da barra de endere√ßos, o que n√£o √© pr√°tico nem acess√≠vel. Esta PR prop√µe a adi√ß√£o de um bot√£o que copia automaticamente o link do post para a √°rea de transfer√™ncia, facilitando o compartilhamento.
Al√©m disso, ao utilizar o aplicativo como PWA, a aus√™ncia de uma op√ß√£o de compartilhamento integrada dificulta ainda mais essa a√ß√£o. Com essa melhoria, o compartilhamento se torna mais simples, intuitivo e acess√≠vel para todos os usu√°rios.
ü§ù

> > Review de aprendendofelipe (COMMENTED):
> > Boa @Jeiel0rbit, obrigado pelo PR! üí™
> > Por favor, veja o que acha do que comentei no c√≥digo. ü§ù
> > Review de Jeiel0rbit (COMMENTED):
> > Review de aprendendofelipe (COMMENTED):
> > Review de Jeiel0rbit (COMMENTED):
> > Review de Jeiel0rbit (COMMENTED):
> > @aprendendofelipe Ficou sensacional üòÉüëè Usando o ShareIcon e outras melhorias de acessibilidade ü¶æ.
> > | | |
> > | :-: | :-: |
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):

- **URL**: Ao inv√©s de `location.href`, que tal usar `` `${webserver.host}/${contentObject.owner_username}/${contentObject.slug}` ``? Assim o bot√£o de cada coment√°rio tem sua pr√≥pria URL.
- **Compartilhamento**: N√£o acha melhor usar [navigator.share](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share)? Poderia usar a √°rea de transfer√™ncia apenas como _fallback_.
  Obs. 1: O `webserver` pode ser importado de `infra/webserver`:

```js
import webserver from "infra/webserver";
```

Obs. 2: O `contentObject` aqui n√£o cont√©m `owner_username` e `slug`, mas basta modificar isso em dois pontos:
https://github.com/filipedeschamps/tabnews.com.br/blob/2859d5bd7d136145de91d16bcc34404747023d92/pages/%5Busername%5D/%5Bslug%5D/index.public.js#L93
https://github.com/filipedeschamps/tabnews.com.br/blob/2859d5bd7d136145de91d16bcc34404747023d92/pages/%5Busername%5D/%5Bslug%5D/index.public.js#L273

> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > N√£o precisa de `aria-label` se for manter o mesmo texto j√° vis√≠vel.
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > Que tal adicionar `flexWrap: 'wrap'` pra demorar mais para quebrar a interface quando houver v√°rios n√≠veis de coment√°rios?
> > Coment√°rio de Jeiel0rbit (linha de c√≥digo):
> > Perfeito. Imaginava ser algo simples, pois o bot√£o aparece √∫nica vez no post. Sua sugest√£o deixa algo mais robusto, na qual, considero melhor por um lado. Ok @aprendendofelipe !
> > Coment√°rio de aprendendofelipe (linha de c√≥digo):
> > ...Imaginava ser algo simples, pois o bot√£o aparece √∫nica vez no post.
> > O componente `Content` √© usado para renderizar n√£o s√≥ o conte√∫do principal, mas tamb√©m cada coment√°rio. Dessa forma, voc√™ j√° est√° adicionando o bot√£o de compartilhar em todos eles, mas estavam todos com a URL do principal.
> > Exemplo:
> > https://tabnews-git-fork-jeiel0rbit-main-tabnews.vercel.app/filipedeschamps/testando-pr-do-darkmode
> > Coment√°rio de Jeiel0rbit (linha de c√≥digo):
> > Wow, √≥tima observa√ß√£o! Estarei corrigindo.
> > </pull_1900_feat: bot√£o de compartilhar adicionado>

---

<pull*1902*[fix] Impedir duplica√ß√£o de `slug` em coment√°rios ao remover t√≠tulo herdado>
Coment√°rios podem ter t√≠tulos, mas eles s√£o ignorados pela UI. Apesar disso, o t√≠tulo pode ser considerado para a gera√ß√£o do `slug` do coment√°rio.
Com a adi√ß√£o do bot√£o de compartilhar conte√∫dos (#1900), o t√≠tulo da publica√ß√£o pai estava sendo passado para o componente respons√°vel por criar um coment√°rio. Isso fazia com que m√∫ltiplos coment√°rios herdassem o mesmo t√≠tulo e gerassem o mesmo `slug`, impedindo o envio de mais de um coment√°rio do mesmo usu√°rio no mesmo conte√∫do em alguns casos, devido ao conflito de URL.
A partir desta corre√ß√£o, apenas a publica√ß√£o raiz ter√° t√≠tulo. Coment√°rios continuar√£o sem t√≠tulo e com `slug` aleat√≥rio (`uuid`), evitando colis√µes.

## Mudan√ßas realizadas

Para de enviar o t√≠tulo da publica√ß√£o pai para o componente de cria√ß√£o de respostas/coment√°rios.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
  > > Review de copilot-pull-request-reviewer[bot] (COMMENTED):

## Pull Request Overview

This PR fixes the duplication of comment slugs by preventing the title inherited from the parent publication from being passed to the comment creation component.

- Updates the logic to determine root content based on the parent ID.
- Refactors the title assignment for sharing actions to ensure comments receive a unique, random slug.
- Adjusts props in the public post page to remove the title property from comment components.

### Reviewed Changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated no comments.
| File | Description |
| ------------------------------------------- | ------------------------------------------------------------------------------- |
| pages/interface/components/Content/index.js | Modified root-content check and refactored title generation in the share logic. |
| pages/[username]/[slug]/index.public.js | Removed passing the title property to the comment component. |

<details>
<summary>Comments suppressed due to low confidence (2)</summary>

**pages/interface/components/Content/index.js:644**

- The nested ternary for computing the title is hard to read and maintain. Consider refactoring into an if/else structure or a well-named helper function to improve clarity.

```
const title = isRootContent && rootContent.title ? rootContent.title : rootContent.title ? `Coment√°rio de "${contentObject.owner_username}" em "${rootContent.title}"` : `Conte√∫do de "${contentObject.owner_username}"`;
```

**pages/[username]/[slug]/index.public.js:97**

- Removing the title property from the component props might lead to unexpected issues if downstream logic expects this field. Confirm that all consuming components correctly handle the absence of title.

```
title: contentFound.title,
```

</details>
</pull_1902_[fix] Impedir duplica√ß√£o de `slug` em coment√°rios ao remover t√≠tulo herdado>

<pull_1903_Corrige vulnerabilidade no redirecionamento p√≥s login>

## Mudan√ßas realizadas

Usa a fun√ß√£o `tryParseUrl` para obter o `pathname` de redirecionamento p√≥s login de forma segura contra _open redirect_, resolvendo vulnerabilidade reportada pelo @refernando. üí™üöÄ

## Tipo de mudan√ßa

- [x] Corre√ß√£o de vulnerabilidade (_open redirect_)

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
      </pull_1903_Corrige vulnerabilidade no redirecionamento p√≥s login>

<pull_1904_Usa a biblioteca `@tabnews/helpers` para lidar com URLs>
As fun√ß√µes auxiliares na `@tabnews/helpers` possuem maior resili√™ncia e cobertura de testes.

## Mudan√ßas realizadas

- 355c9231f727e92f9be3614d1af17c3bbfe75265: Passa a usar as fun√ß√µes `getDomain`, `isExternalLink` e `isTrustedDomain` diretamente da `@tabnews/helpers`, inclusive nos testes das fun√ß√µes antigas para mostrar que o comportamento anterior est√° mantido.
- 2d5d71859c53340c183bce535b9cbf60ee37936a: Remove os testes de unidade que agora est√£o na responsabilidade da `@tabnews/helpers`.

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Os testes antigos est√£o passando localmente.
  > > Review de Rafatcb (APPROVED):
  > > </pull_1904_Usa a biblioteca `@tabnews/helpers` para lidar com URLs>

<pull_1905_Aumenta o timeout de conex√£o com o banco de dados e melhora os logs de erros de conex√£o>
Recentemente estamos recebendo muitos erros de timeout de conex√£o com o banco de dados durante a tentativa de obter uma nova conex√£o do pool.

## Mudan√ßas realizadas

Aumenta o timeout de 2s para 10s para tentar isolar se o problema √© realmente o tempo de 2s n√£o ser suficiente em alguns momentos ou se existe algum outro problema que ocasiona o erro de timeout.
Tamb√©m para facilitar a identifica√ß√£o do problema, se o erro original da biblioteca `pg` contiver a propriedade `cause`, ela tamb√©m estar√° dispon√≠vel nos nossos logs.
Vou mesclar logo o PR para iniciar imediatamente o experimento. ü§ù

> > Review de copilot-pull-request-reviewer[bot] (COMMENTED):

## Pull Request Overview

This PR raises the database connection timeout and enhances error logs by surfacing the original `pg` error cause.

- Extended `connectionTimeoutMillis` from 2 000 ms to 10 000 ms to help diagnose intermittent timeouts.
- Propagated the underlying `pg` error‚Äôs `cause` into our `ServiceError` for richer logging.

### Reviewed Changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated 1 comment.
| File | Description |
| ----------------- | --------------------------------------------------------------------------------------------- |
| infra/database.js | Updated `connectionTimeoutMillis` value and passed `error.cause` into the `ServiceError` body |
| errors/index.js | Added `cause` parameter handling in `BaseError` and `ServiceError` constructors |

<details>
<summary>Comments suppressed due to low confidence (3)</summary>

**infra/database.js:75**

- Add unit tests to ensure that when `pg` errors include a `cause`, it is correctly propagated into the `ServiceError` that this function throws.

```
cause: error.cause,
```

**errors/index.js:20**

- Update the JSDoc (or README) for `BaseError` and `ServiceError` to document the new `cause` property and describe how it should be used.

```
this.cause = cause;
```

**errors/index.js:17**

- [nitpick] Consider calling `super(message, { cause })` instead of manually setting `this.cause`, leveraging the built-in `Error` cause option for proper error chaining.

```
super();
```

</details>
> > Coment√°rio de Copilot (linha de c√≥digo):
> > [nitpick] Consider extracting the `10_000` magic number into a well-named constant (e.g., `DEFAULT_CONNECTION_TIMEOUT_MS`) for better readability and easier future adjustments.
> > </pull_1905_Aumenta o timeout de conex√£o com o banco de dados e melhora os logs de erros de conex√£o>

---

<pull*1906*[Breaking Change] Renderizar √°rvore de coment√°rios incluindo filhos de coment√°rios exclu√≠dos>

## Mudan√ßas realizadas

Este PR adiciona suporte para renderizar a √°rvore completa de coment√°rios, mesmo quando alguns coment√°rios intermedi√°rios foram exclu√≠dos.

- No backend (potencial _breaking change_), modifica a resposta da API para incluir coment√°rios exclu√≠dos com os dados m√≠nimos necess√°rios para montar a √°rvore corretamente.
- No frontend, ajusta a renderiza√ß√£o para exibir os filhos de coment√°rios exclu√≠dos, mostrando placeholders no lugar dos coment√°rios apagados.
  | |
  | ----------------------------------------------------------------------------------------------------------------------------------------------- |
  | Exemplo dispon√≠vel [aqui](https://tabnews-git-feat-render-comment-tree-with-deleted-tabnews.vercel.app/filipedeschamps/testando-pr-do-darkmode) |
  Com isso, melhoramos a navega√ß√£o e a compreens√£o das discuss√µes, sem expor informa√ß√µes sens√≠veis dos conte√∫dos apagados.
  Apesar de relacionado, este PR n√£o aborda a issue #1089, que trata da adequa√ß√£o da interface no momento da exclus√£o.
  O foco principal aqui foi permitir a renderiza√ß√£o completa da √°rvore sem modificar o layout existente, mas acredito que uma evolu√ß√£o futura no layout para facilitar o entendimento da √°rvore seria muito bem-vinda.

## Tipo de mudan√ßa

- [x] Nova funcionalidade (potencial _breaking change_)

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adicionei testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
  > > Review de copilot-pull-request-reviewer[bot] (COMMENTED):

## Pull Request Overview

This PR ensures the full comment tree is returned‚Äîpreserving deleted-parent placeholders‚Äîand updates the frontend to display child comments under deleted ancestors. Tests are extended to cover scenarios where deleted comments with and without children are handled correctly.

- Backend: include `children_deep_count` in API responses, inject placeholder nodes for deleted ancestors, and stop stripping that field in authorization.
- Frontend: adjust rendering logic to show compact or deleted modes based on status and deep child counts.
- Tests: add integration tests for children retrieval under deleted and published parents.

### Reviewed Changes

Copilot reviewed 7 out of 7 changed files in this pull request and generated 3 comments.

<details>
<summary>Show a summary per file</summary>
| File                                                                     | Description                                                     |
| ------------------------------------------------------------------------ | --------------------------------------------------------------- |
| tests/integration/api/v1/contents/[username]/[slug]/root/get.test.js     | Add `children_deep_count` assertions for root GET               |
| tests/integration/api/v1/contents/[username]/[slug]/parent/get.test.js   | Add `children_deep_count` assertions for parent GET             |
| tests/integration/api/v1/contents/[username]/[slug]/children/get.test.js | New tests for deleted-child-with/without-children scenarios     |
| pages/interface/components/Content/index.js                              | Simplify deleted placeholder UI and adjust padding              |
| pages/[username]/[slug]/index.public.js                                  | Refactor `RenderChildrenTree` to skip non-published/no-children |
| models/content.js                                                        | Inject placeholder nodes in `findTree` and update deep count    |
| models/authorization.js                                                  | Stop deleting `children_deep_count` from filtered output        |
</details>
<details>
<summary>Comments suppressed due to low confidence (1)</summary>

**models/content.js:1083**

- [nitpick] The indentation of the subsequent `const tabcoins = ...` line is misaligned. Align it with the `if` block for consistent code style.

```
  if (contentObject.status !== 'published') {
```

</details>
> > Coment√°rio de Copilot (linha de c√≥digo):
> > Placeholder nodes injected for deleted ancestors lack a `type` field. Add `type: 'content'` to match the rest of the tree structure and satisfy API consumers.
```suggestion
            id: parentId,
            type: 'content',
```
> > Coment√°rio de Copilot (linha de c√≥digo):
> > [nitpick] Consider combining this early-exit check with the next (`!isPublished && !children_deep_count`) into a single, well-named boolean to improve readability.
```suggestion
    const shouldRenderChild = (renderIntent || renderShowMore) && (isPublished || children_deep_count);
    if (!shouldRenderChild) return null;
```
> > Coment√°rio de Copilot (linha de c√≥digo):
> > [nitpick] This guard skips deleted nodes without children, which is correct, but embedding it alongside unrelated checks can be confusing‚Äîextracting it into a named helper (e.g. `shouldRenderNode`) could clarify intent.
> > </pull*1906*[Breaking Change] Renderizar √°rvore de coment√°rios incluindo filhos de coment√°rios exclu√≠dos>

---

<pull_1920_Renderizar `TabCoinButtons` desativados em caso de conte√∫do exclu√≠do>
Renderiza as setas de qualifica√ß√µes com aspecto de bot√µes desativados ao lado de conte√∫dos exclu√≠dos. Com isso facilita identificar em que n√≠vel da √°rvore o conte√∫do exclu√≠do est√°.
| Antes | Depois |
| ----- | ------ |

> > Review de copilot-pull-request-reviewer[bot] (COMMENTED):

## Pull Request Overview

This PR changes `TabCoinButtons` so that when a piece of content is not published, it renders a disabled-style button set and always mounts the component in the public page tree.

- Add `DisabledButtons` component and early return in `TabCoinButtons` for non-published content
- Fix rendering logic in the public page to always include `TabCoinButtons`

### Reviewed Changes

Copilot reviewed 2 out of 2 changed files in this pull request and generated 2 comments.
| File | Description |
| -------------------------------------------------- | --------------------------------------------------------------------------- |
| pages/interface/components/TabCoinButtons/index.js | Introduce `DisabledButtons`, guard on `content.status`, and refactor render |
| pages/[username]/[slug]/index.public.js | Remove `isPublished` check so `TabCoinButtons` always renders |

<details>
<summary>Comments suppressed due to low confidence (1)</summary>

**pages/interface/components/TabCoinButtons/index.js:148**

- The new `DisabledButtons` component introduces UI behavior but lacks dedicated tests. Consider adding unit or snapshot tests to cover the disabled state rendering.

```
function DisabledButtons() {
```

</details>
> > Review de Rafatcb (DISMISSED):
> > Considero as mudan√ßas positivas, √© parecido com o que ocorre no Reddit (e considero bom):
Inclusive, acho que podemos deixar o resto mais parecido com o Reddit: um coment√°rio que parece normal, mas com tudo desabilitado, e com a mensagem de que foi removido. O vermelho atual acaba chamando mais aten√ß√£o do que "removendo" a aten√ß√£o. Aproveitei para deixar esse coment√°rio aqui porque n√£o encontrei um issue aberto discutindo isso.
> > Coment√°rio de Copilot (linha de c√≥digo):
> > The check `status !== 'published'` will also disable draft or other states. If the intent is only to gray out deleted content, consider explicitly checking for the deleted/excluded status (e.g., `content.status === 'deleted'`).
```suggestion
  if (content?.status === 'deleted') {
```
> > Coment√°rio de Copilot (linha de c√≥digo):
> > Calling `ActiveButtons` as a function will break React Hooks rules. Instead, render it as a component: `return <ActiveButtons content={content} />;`.
```suggestion
  return <ActiveButtons content={content} />;
```
</pull_1920_Renderizar `TabCoinButtons` desativados em caso de conte√∫do exclu√≠do>

<pull_1924_Corrige resposta falsa na atualiza√ß√£o de email com endere√ßo de outro usu√°rio>
Ao receber uma atualiza√ß√£o de email com um endere√ßo j√° cadastrado, n√≥s enviamos uma resposta falsa para impedir que a funcionalidade seja utilizada indevidamente para descobrir endere√ßos de email de outros usu√°rios.
O problema era que a resposta falsa continha o campo `updated_at` diferente do que existiria em uma resposta real. Como o email s√≥ √© atualizado ap√≥s a confirma√ß√£o do token, o `updated_at` permanece com o valor original at√© essa confirma√ß√£o, mas a resposta falsa estava trazendo um `updated_at` com valor do momento.

## Mudan√ßas realizadas

- d9e3b1a259d889c11d3efe44581c389924b65bae: Corrige o problema citado, retornando o `updated_at` original do usu√°rio na resposta falsa.
- b4945fa8f71c34f1ad23555d9f9d3e67e37b6e3a: Ao fazer a corre√ß√£o j√° citada, foi notado que daria para simplificar a l√≥gica da resposta falsa, ent√£o foi realizado. De b√¥nus essa simplifica√ß√£o garante que a gente n√£o perca o registro do evento de tentativa de atualiza√ß√£o do cadastro.
- 5927e9f73f54f977e853378cfb646f5ab9d105b4: Ainda nessa corre√ß√£o, foi notado que a fun√ß√£o `deleteExpiredUsers` n√£o aceitava a transa√ß√£o como op√ß√£o. Isso exigia a abertura de uma segunda conex√£o com o banco de dados em caso de patch do usu√°rio, o que tamb√©m j√° foi corrigido.

## Tipo de mudan√ßa

- [x] Corre√ß√£o de bug

## Checklist:

- [x] As modifica√ß√µes n√£o geram novos logs de erro ou aviso (_warning_).
- [x] Eu adequei os testes que provam que a corre√ß√£o ou novo recurso funciona conforme esperado.
- [x] Tanto os novos testes quanto os antigos est√£o passando localmente.
      </pull_1924_Corrige resposta falsa na atualiza√ß√£o de email com endere√ßo de outro usu√°rio>
